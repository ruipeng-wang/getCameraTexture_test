"use strict";var t=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.polyfill={}}var e=t.prototype;return e.set=function(t){this.platform=t,this.polyfill=t.polyfill},e.dispose=function(){var t;null===(t=this.platform)||void 0===t||t.dispose(),this.platform=null,this.polyfill=null},t}(),e=new t;Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(t){if(null==this)throw new TypeError("this is null or not defined");for(var e=Object(this),s=e.length>>>0,i=arguments[1],n=i>>0,a=n<0?Math.max(s+n,0):Math.min(n,s),r=arguments[2],o=void 0===r?s:r>>0,h=o<0?Math.max(s+o,0):Math.min(o,s);a<h;)e[a]=t,a++;return e}}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(null==this)throw TypeError('"this" is null or not defined');var e=Object(this),s=e.length>>>0;if("function"!=typeof t)throw TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var a=e[n];if(t.call(i,a,n,e))return a;n++}},configurable:!0,writable:!0}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(t){if(null==this)throw new TypeError('"this" is null or not defined');var e=Object(this),s=e.length>>>0;if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var a=e[n];if(t.call(i,a,n,e))return n;n++}return-1},configurable:!0,writable:!0}),Math.log2=Math.log2||function(t){return Math.log(t)*Math.LOG2E},Math.sign||(Math.sign=function(t){return(t>0)-(t<0)||+t}),void 0===Number.isFinite&&(Number.isFinite=function(t){return"number"==typeof t&&isFinite(t)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var s=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(null!=n)for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(s[a]=n[a])}return s},writable:!0,configurable:!0}),function(){if(void 0!==e.polyfill.navigator&&void 0!==e.polyfill.document){e.polyfill.navigator.pointer=e.polyfill.navigator.pointer||e.polyfill.navigator.webkitPointer||e.polyfill.navigator.mozPointer;var t=function(){var t=e.polyfill.document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",!0,!1,null),e.polyfill.document.dispatchEvent(t)},s=function(){var t=e.polyfill.document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",!0,!1,null),e.polyfill.document.dispatchEvent(t)};e.polyfill.document.addEventListener("webkitpointerlockchange",t,!1),e.polyfill.document.addEventListener("webkitpointerlocklost",t,!1),e.polyfill.document.addEventListener("mozpointerlockchange",t,!1),e.polyfill.document.addEventListener("mozpointerlocklost",t,!1),e.polyfill.document.addEventListener("webkitpointerlockerror",s,!1),e.polyfill.document.addEventListener("mozpointerlockerror",s,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&e.polyfill.navigator.pointer&&(Element.prototype.requestPointerLock=function(){e.polyfill.document.pointerLockElement=this,e.polyfill.navigator.pointer.lock(this,t,s)}),e.polyfill.document.exitPointerLock=e.polyfill.document.exitPointerLock||e.polyfill.document.webkitExitPointerLock||e.polyfill.document.mozExitPointerLock,e.polyfill.document.exitPointerLock||(e.polyfill.document.exitPointerLock=function(){e.polyfill.navigator.pointer&&(e.polyfill.document.pointerLockElement=null,e.polyfill.navigator.pointer.unlock())})}}(),function(){if(void 0!==e.polyfill.window){for(var t=0,s=["ms","moz","webkit","o"],i=0;i<s.length&&!e.polyfill.window.requestAnimationFrame;++i)e.polyfill.window.requestAnimationFrame=e.polyfill.window[s[i]+"RequestAnimationFrame"],e.polyfill.window.cancelAnimationFrame=e.polyfill.window[s[i]+"CancelAnimationFrame"]||e.polyfill.window[s[i]+"CancelRequestAnimationFrame"];e.polyfill.window.requestAnimationFrame||(e.polyfill.window.requestAnimationFrame=function(s,i){var n=(new Date).getTime(),a=Math.max(0,16-(n-t)),r=e.polyfill.window.setTimeout((function(){s(n+a)}),a);return t=n+a,r}),e.polyfill.window.cancelAnimationFrame||(e.polyfill.window.cancelAnimationFrame=function(t){clearTimeout(t)})}}(),String.prototype.endsWith||(String.prototype.endsWith=function(t,e){return(void 0===e||e>this.length)&&(e=this.length),this.substring(e-t.length,e)===t}),String.prototype.includes||(String.prototype.includes=function(t,e){return"number"!=typeof e&&(e=0),!(e+t.length>this.length)&&-1!==this.indexOf(t,e)}),String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return this.substr(!e||e<0?0:+e,t.length)===t}),Int8Array.prototype.fill||(Int8Array.prototype.fill=Array.prototype.fill),Uint8Array.prototype.fill||(Uint8Array.prototype.fill=Array.prototype.fill),Uint8ClampedArray.prototype.fill||(Uint8ClampedArray.prototype.fill=Array.prototype.fill),Int16Array.prototype.fill||(Int16Array.prototype.fill=Array.prototype.fill),Uint16Array.prototype.fill||(Uint16Array.prototype.fill=Array.prototype.fill),Int32Array.prototype.fill||(Int32Array.prototype.fill=Array.prototype.fill),Uint32Array.prototype.fill||(Uint32Array.prototype.fill=Array.prototype.fill),Float32Array.prototype.fill||(Float32Array.prototype.fill=Array.prototype.fill);var s={};function i(t,i){var n;s[t]=!0,void 0!==i&&(n=i,e.polyfill.window.console&&e.polyfill.window.console.error&&e.polyfill.window.console.error(n))}var n=function t(e){var s=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var n=new t.VertexAttrib(s);this.attribs[i]=n}this.maxAttrib=0};(n.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=t.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var a=function(t){var i=this;this.gl=t,function(t){var e=t.getError;t.getError=function(){do{(i=e.apply(t))!=t.NO_ERROR&&(s[i]=!0)}while(i!=t.NO_ERROR);for(var i in s)if(s[i])return delete s[i],parseInt(i);return t.NO_ERROR}}(t);var n=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(t){return t==i.VERTEX_ARRAY_BINDING_OES?i.currentVertexArrayObject==i.defaultVertexArrayObject?null:i.currentVertexArrayObject:n.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(t){var e=i.currentVertexArrayObject;e.maxAttrib=Math.max(e.maxAttrib,t);var s=e.attribs[t];return s.enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(t){var e=i.currentVertexArrayObject;e.maxAttrib=Math.max(e.maxAttrib,t);var s=e.attribs[t];return s.enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,s){switch(e){case t.ARRAY_BUFFER:i.currentArrayBuffer=s;break;case t.ELEMENT_ARRAY_BUFFER:i.currentVertexArrayObject.elementArrayBuffer=s}return n.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,s){var a=i.currentVertexArrayObject,r=a.attribs[e];switch(s){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return r.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return r.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return r.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return r.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return r.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return r.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(t,e,s,a,r,o){var h=i.currentVertexArrayObject;h.maxAttrib=Math.max(h.maxAttrib,t);var l=h.attribs[t];return l.buffer=i.currentArrayBuffer,l.size=e,l.type=s,l.normalized=a,l.stride=r,l.offset=o,l.recache(),n.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",(function(){var t;t="OESVertexArrayObject emulation library context restored",e.polyfill.window.console&&e.polyfill.window.console.log&&e.polyfill.window.console.log(t),i.reset_()}),!0),this.reset_()};a.prototype.VERTEX_ARRAY_BINDING_OES=34229,a.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var t=0;t<this.vertexArrayObjects.length;++t)this.vertexArrayObjects.isAlive=!1;var e=this.gl;this.maxVertexAttribs=e.getParameter(e.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new n(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},a.prototype.createVertexArrayOES=function(){var t=new n(this);return this.vertexArrayObjects.push(t),t},a.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject==t&&this.bindVertexArrayOES(null)},a.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof n&&t.hasBeenBound&&t.ext==this)},a.prototype.bindVertexArrayOES=function(t){var e=this.gl;if(!t||t.isAlive){var s=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var a=this.currentVertexArrayObject;if(n!=a){n&&a.elementArrayBuffer==n.elementArrayBuffer||s.bindBuffer.call(e,e.ELEMENT_ARRAY_BUFFER,a.elementArrayBuffer);for(var r=this.currentArrayBuffer,o=Math.max(n?n.maxAttrib:0,a.maxAttrib),h=0;h<=o;h++){var l=a.attribs[h],c=n?n.attribs[h]:null;if(n&&l.enabled==c.enabled||(l.enabled?s.enableVertexAttribArray.call(e,h):s.disableVertexAttribArray.call(e,h)),l.enabled){var d=!1;n&&l.buffer==c.buffer||(r!=l.buffer&&(s.bindBuffer.call(e,e.ARRAY_BUFFER,l.buffer),r=l.buffer),d=!0),(d||l.cached!=c.cached)&&s.vertexAttribPointer.call(e,h,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!=r&&s.bindBuffer.call(e,e.ARRAY_BUFFER,this.currentArrayBuffer)}}else i(e.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")};const r=function(){const t={},e=["Array","Object","Function","Date","RegExp","Float32Array"];for(let s=0;s<e.length;s++)t["[object "+e[s]+"]"]=e[s].toLowerCase();return t}(),o="1.51.4",h="d29a7391b";function l(t){if(null===t)return"null";const e=typeof t;return"undefined"===e||"number"===e||"string"===e||"boolean"===e?e:r[Object.prototype.toString.call(t)]}function c(t,e){for(const s in e){const i=e[s];"object"===l(i)?t[s]=c({},i):"array"===l(i)?t[s]=c([],i):t[s]=i}return t}function d(t){return undefined!==t}class u{constructor(){this.initEventHandler()}initEventHandler(){this._callbacks={},this._callbackActive={}}_addCallback(t,e,s,i=!1){t&&"string"==typeof t&&e&&(this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:s||this,once:i}))}on(t,e,s){return this._addCallback(t,e,s,!1),this}off(t,e,s){if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(const t in this._callbackActive)this._callbacks[t]&&this._callbacks[t]===this._callbackActive[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());if(t)if(e){const i=this._callbacks[t];if(!i)return this;let n=i.length;for(let t=0;t<n;t++)i[t].callback===e&&(s&&i[t].scope!==s||(i[t--]=i[--n]));i.length=n}else this._callbacks[t]&&(this._callbacks[t]=[]);else this._callbacks={};return this}fire(t,e,s,i,n,a,r,o,h){if(!t||!this._callbacks[t])return this;let l;this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),l=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(let c=0;(l||this._callbackActive[t])&&c<(l||this._callbackActive[t]).length;c++){const d=(l||this._callbackActive[t])[c];if(d.callback.call(d.scope,e,s,i,n,a,r,o,h),d.once){const e=this._callbacks[t],s=e?e.indexOf(d):-1;-1!==s&&(this._callbackActive[t]===e&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(s,1))}}return l||(this._callbackActive[t]=null),this}call(t,e,s,i,n,a,r,o,h){if(!t||!this._callbacks[t])return;let l;var c;this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),l=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(var d=0;(l||this._callbackActive[t])&&d<(l||this._callbackActive[t]).length;d++){var u=(l||this._callbackActive[t])[d];if(c=u.callback.call(u.scope,e,s,i,n,a,r,o,h),u.once){const e=this._callbacks[t],s=e?e.indexOf(u):-1;-1!==s&&(this._callbackActive[t]===e&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(s,1))}}return l||(this._callbackActive[t]=null),c}once(t,e,s){return this._addCallback(t,e,s,!0),this}hasEvent(t){return this._callbacks[t]&&0!==this._callbacks[t].length||!1}}const p={attach:function(t){const e=p;return t._addCallback=e._addCallback,t.on=e.on,t.off=e.off,t.fire=e.fire,t.once=e.once,t.hasEvent=e.hasEvent,t._callbacks={},t._callbackActive={},t},_addCallback:u.prototype._addCallback,on:u.prototype.on,off:u.prototype.off,fire:u.prototype.fire,once:u.prototype.once,hasEvent:u.prototype.hasEvent},m={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}},f={delimiter:"/",join:function(){const t=arguments.length;let e=arguments[0];for(let s=0;s<t-1;++s){const t=arguments[s],i=arguments[s+1];if(!d(t)||!d(i))throw new Error("undefined argument to pc.path.join");i[0]!==f.delimiter?t&&i&&t[t.length-1]!==f.delimiter&&i[0]!==f.delimiter?e+=f.delimiter+i:e+=i:e=i}return e},normalize:function(t){const e=t.startsWith(f.delimiter),s=t.endsWith(f.delimiter),i=t.split("/");let n="",a=[];for(let t=0;t<i.length;t++)""!==i[t]&&"."!==i[t]&&(".."===i[t]&&a.length>0?a=a.slice(0,a.length-2):(t>0&&a.push(f.delimiter),a.push(i[t])));return n=a.join(""),e||n[0]!==f.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==f.delimiter&&(n+=f.delimiter),n},split:function(t){const e=t.split(f.delimiter),s=e.slice(e.length-1)[0];return[e.slice(0,e.length-1).join(f.delimiter),s]},getBasename:function(t){return f.split(t)[1]},getDirectory:function(t){const e=t.split(f.delimiter);return e.slice(0,e.length-1).join(f.delimiter)},getExtension:function(t){var e=t.split("?")[0].split(".");let s=e.pop();return"gz"==s&&(s=e.pop()),s!==t?"."+s:""},isRelativePath:function(t){return"/"!==t.charAt(0)&&null===t.match(/:\/\//)},extractPath:function(t){let e="";const s=t.split("/");let i=0;if(s.length>1)if(f.isRelativePath(t))if("."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];else if(".."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];else for(e=".",i=0;i<s.length-1;++i)e+="/"+s[i];else for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];return e}};let _=!1,g=!1,y=!1,v=!1,x=!1,b=!1,S=!0,w=!1,M=!1,T=!1;if(void 0!==e.polyfill.navigator){const t=e.polyfill.navigator.userAgent;/(windows|mac os|linux|cros)/i.test(t)&&(_=!0),/xbox/i.test(t)&&(v=!0),/(windows phone|iemobile|wpdesktop)/i.test(t)?(_=!1,g=!0,y=!0):/android/i.test(t)?(_=!1,g=!0,x=!0):/ip([ao]d|hone)/i.test(t)&&(_=!1,g=!0,b=!0),void 0!==e.polyfill.window&&(S="ontouchstart"in e.polyfill.window||"maxTouchPoints"in e.polyfill.navigator&&e.polyfill.navigator.maxTouchPoints>0),w="getGamepads"in e.polyfill.navigator,M="undefined"!=typeof Worker;try{const t=Object.defineProperty({},"passive",{get:function(){return T=!0,!1}});e.polyfill.window.addEventListener("testpassive",null,t),e.polyfill.window.removeEventListener("testpassive",null,t)}catch(t){}}const A=void 0!==e.polyfill.window?"browser":"node",C={environment:A,global:"browser"===A?e.polyfill.window:e.polyfill.global,browser:"browser"===A,desktop:_,mobile:g,ios:b,android:x,windows:y,xbox:v,gamepads:w,touch:S,workers:M,passiveEvents:T};function P(t,e=0){const s=t.length;if(e<0||e>=s)return null;const i=t.charCodeAt(e);if(s>1&&i>=55296&&i<=56319){const s=t.charCodeAt(e+1);if(s>=56320&&s<=57343)return{code:1024*(i-55296)+s-56320+65536,long:!0}}return{code:i,long:!1}}function R(t,e,s){if(!t)return!1;const i=P(t);if(i){const t=i.code;return t>=e&&t<=s}return!1}function E(t,e){if(e===t.length-1)return 1;if(R(t[e],55296,56319)){const s=t.substring(e,e+2),i=t.substring(e+2,e+4);return R(i,127995,127999)||R(s,127462,127487)&&R(i,127462,127487)?4:R(i,65024,65039)?3:2}return R(t[e+1],65024,65039)?2:1}const L={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(t){for(let e=1;e<arguments.length;e++)t=t.replace("{"+(e-1)+"}",arguments[e]);return t},toBool:function(t,e=!1){if("true"===t)return!0;if(e){if("false"===t)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(t,e){const s=P(t,e);return s&&s.code},getCodePoints:function(t){if("string"!=typeof t)throw new TypeError("Not a string");let e=0;const s=[];let i;for(;i=P(t,e);)s.push(i.code),e+=i.long?2:1;return s},getSymbols:function(t){if("string"!=typeof t)throw new TypeError("Not a string");let e=0;const s=t.length,i=[];let n,a=0;for(;e<s;){if(a+=E(t,e+a),n=t[e+a],R(n,8400,8447)&&(n=t[e+a++]),R(n,65024,65039)&&(n=t[e+a++]),n&&8205===n.charCodeAt(0)){n=t[e+a++];continue}const s=t.substring(e,e+a);i.push(s),e+=a,a=0}return i},fromCodePoint:function(){const t=[];let e,s,i;for(let n=0;n<arguments.length;++n)e=Number(arguments[n]),s=e-65536,i=e>65535?[55296+(s>>10),s%1024+56320]:[e],t.push(String.fromCharCode.apply(null,i));return t.join("")}};class I{constructor(){this._list=[],this._index={}}push(t,e){if(this._index[t])throw Error("Key already in index "+t);const s=this._list.push(e)-1;this._index[t]=s}has(t){return void 0!==this._index[t]}get(t){const e=this._index[t];return void 0!==e?this._list[e]:null}remove(t){const e=this._index[t];if(void 0!==e){for(t in this._list.splice(e,1),delete this._index[t],this._index){const s=this._index[t];s>e&&(this._index[t]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(const t in this._index)delete this._index[t]}}class D{constructor(t){this.arraybuffer=t,this.dataView=new DataView(t),this.offset=0,this.stack=[]}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(t=0){this.offset=t}skip(t){this.offset+=t}align(t){this.offset=this.offset+t-1&~(t-1)}_inc(t){return this.offset+=t,this.offset-t}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(t){let e="";for(let s=0;s<t;++s)e+=this.readChar();return e}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(t){for(let e=0;e<t.length;++e)t[e]=this.readU8()}readLine(){const t=this.dataView;let e="";for(;!(this.offset>=t.byteLength);){const t=String.fromCharCode(this.readU8());if("\n"===t)break;e+=t}return e}}class F{constructor(t){this._sortBy=t.sortBy,this.items=[],this.length=0,this.loopIndex=-1,this._sortHandler=this._doSort.bind(this)}_binarySearch(t){let e=0,s=this.items.length-1;const i=t[this._sortBy];let n,a;for(;e<=s;)n=Math.floor((e+s)/2),a=this.items[n][this._sortBy],a<=i?e=n+1:a>i&&(s=n-1);return e}_doSort(t,e){const s=this._sortBy;return t[s]-e[s]}insert(t){const e=this._binarySearch(t);this.items.splice(e,0,t),this.length++,this.loopIndex>=e&&this.loopIndex++}append(t){this.items.push(t),this.length++}remove(t){const e=this.items.indexOf(t);e<0||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)}sort(){const t=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==t&&(this.loopIndex=this.items.indexOf(t))}}class O extends u{constructor(t){super(),this._index={},this._list=[],this._parent=t}add(){let t=!1;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]||(t=!0,this._index[e[s]]=!0,this._list.push(e[s]),this.fire("add",e[s],this._parent));return t&&this.fire("change",this._parent),t}remove(){let t=!1;if(!this._list.length)return t;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]&&(t=!0,delete this._index[e[s]],this._list.splice(this._list.indexOf(e[s]),1),this.fire("remove",e[s],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;const t=this._list.slice(0);this._list=[],this._index={};for(let e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}has(){return!!this._list.length&&this._has(this._processArguments(arguments))}_has(t){if(!this._list.length||!t.length)return!1;for(let e=0;e<t.length;e++)if(1===t[e].length){if(this._index[t[e][0]])return!0}else{let s=!0;for(let i=0;i<t[e].length;i++)if(!this._index[t[e][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(t,e){const s=[];let i=[];if(!t||!t.length)return s;for(let n=0;n<t.length;n++)if(t[n]instanceof Array){e||(i=[]);for(let a=0;a<t[n].length;a++)"string"==typeof t[n][a]&&(e?s.push(t[n][a]):i.push(t[n][a]));!e&&i.length&&s.push(i)}else"string"==typeof t[n]&&(e?s.push(t[n]):s.push([t[n]]));return s}get size(){return this._list.length}}const k=void 0!==e.polyfill.window&&e.polyfill.window.performance&&e.polyfill.window.performance.now&&e.polyfill.window.performance.timing?function(){return e.polyfill.window.performance.now()}:Date.now;const B=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class z{constructor(t){const e=t.match(B);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9]}toString(){let t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),t+=this.path,this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t}getQuery(){const t={};if(this.query){const e=decodeURIComponent(this.query).split("&");for(const s of e){const e=s.split("=");t[e[0]]=e[1]}}return t}setQuery(t){let e="";for(const s in t)t.hasOwnProperty(s)&&(""!==e&&(e+="&"),e+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));this.query=e}}function U(){return U=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t},U.apply(this,arguments)}const V={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(t,e,s){return t>=s?s:t<=e?e:t},clamp01:function(t){return this.clamp(t,0,1)},intToBytes24:function(t){return[t>>16&255,t>>8&255,255&t]},intToBytes32:function(t){return[t>>24&255,t>>16&255,t>>8&255,255&t]},bytesToInt24:function(t,e,s){return t.length&&(s=t[2],e=t[1],t=t[0]),t<<16|e<<8|s},bytesToInt32:function(t,e,s,i){return t.length&&(i=t[3],s=t[2],e=t[1],t=t[0]),(t<<24|e<<16|s<<8|i)>>>32},lerp:function(t,e,s){return t+(e-t)*V.clamp(s,0,1)},lerpAngle:function(t,e,s){return e-t>180&&(e-=360),e-t<-180&&(e+=360),V.lerp(t,e,V.clamp(s,0,1))},powerOfTwo:function(t){return 0!==t&&!(t&t-1)},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},random:function(t,e){const s=e-t;return Math.random()*s+t},smoothstep:function(t,e,s){return s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*(3-2*s)},smootherstep:function(t,e,s){return s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*s*(s*(6*s-15)+10)},smootherdamp:function(t,e,s,i,n,a,r){let o=2/(n=Math.max(1e-4,n)),h=o*r,l=1/(1+h+.479999989271164*h*h+.234999999403954*h*h*h),c=t-e,d=e,u=a*n,p=this.clamp(c,-u,u);e=t-p;let m=(s[i]+o*p)*r;s[i]=(s[i]-o*m)*l;let f=e+(p+m)*l;return d-t>0==f>d&&(f=d,s[i]=(f-d)/r),f},roundUp:function(t,e){return 0===e?t:Math.ceil(t/e)*e},float2Half:function(){const t=new Float32Array(1),e=new Int32Array(t.buffer);return function(s){t[0]=s;const i=e[0];let n=i>>16&32768,a=i>>12&2047;const r=i>>23&255;return r<103?n:r>142?(n|=31744,n|=(255===r?0:1)&&8388607&i,n):r<113?(a|=2048,n|=(a>>114-r)+(a>>113-r&1),n):(n|=r-112<<10|a>>1,n+=1&a,n)}}(),combinations:function(t,e){for(var s=function t(e,s,i,n){if(0!=e)for(var a=0;a<s.length;a++)t(e-1,s.slice(a+1),i.concat([s[a]]),n);else i.length>0&&(n[n.length]=i)},i=[],n=e;n<t.length;n++)s(n,t,[],i);return i.push(t.sort()),i},between:function(t,e,s,i){const n=Math.min(e,s),a=Math.max(e,s);return i?t>=n&&t<=a:t>n&&t<a}},N=function t(e,s,i=0){return new Promise(((n,a)=>{0==e.length||i>=e.length?n(s):e[i](s).then((()=>t(e,s,++i).then((()=>{n(s)}))))}))},W=(t,e)=>{if(e.retries=e.retries||0,e.retry&&e.retries<e.maxRetries){e.retries++;const t=V.clamp(Math.pow(2,e.retries)*H.retryDelay,0,e.maxRetryDelay||5e3);return new Promise((e=>{setTimeout((()=>{e()}),t)})).then((()=>j.request(e.url,e)))}return Promise.reject(t)},G=(t,e)=>{const s=t.headers.get("content-type");if(e.responseType)switch(e.responseType){case H.ResponseType.ARRAY_BUFFER:return t.arrayBuffer();case H.ResponseType.BLOB:return t.blob();case H.ResponseType.JSON:return t.json();case H.ResponseType.DOCUMENT:case H.ResponseType.TEXT:return t.text()}const i=e.url;if(s==H.ContentType.JSON||i.split("?")[0].endsWith(".json"))return t.json();if((t=>{var e=[H.ContentType.MP4,H.ContentType.WAV,H.ContentType.OGG,H.ContentType.MP3,H.ContentType.BIN,H.ContentType.DDS,H.ContentType.BASIS,H.ContentType.GLB,H.ContentType.KTX,H.ContentType.KTX2];for(let s=0;s<e.length;s++)if(t.indexOf(e[s])>=0)return!0;return!1})(s))return t.arrayBuffer();if((t=>{if([].indexOf(t)>=0)return!0})(s))return t.blob();if((t=>{var e=[H.ContentType.GIF,H.ContentType.JPEG,H.ContentType.PNG,H.ContentType.SCRIPT];for(let s=0;s<e.length;s++)if(t.indexOf(e[s])>=0)return!0})(s))return new Promise((t=>{t(i)}));if((t=>{var e=[H.ContentType.SCRIPT];for(let s=0;s<e.length;s++)if(t.indexOf(e[s])>=0)return!0})(s))return t.text();const n=f.getExtension(t.url);return H.BinaryExtensions.indexOf(n)?t.arrayBuffer():W(new Error(`Url:'${i}' did not find the Content-Type: ${s}`))};class H{constructor(){this.interceptors=[]}get(t,e={}){return e=e||{},this.request(t,U({method:"GET"},e))}post(t,e,s={}){return s=s||{},this.request(t,U({method:"POST",body:e},s))}put(t,e,s={}){return s=s||{},this.request(t,U({method:"PUT",body:e},s))}del(t,e={}){return e=e||{},this.request(t,U({method:"DELETE"},e))}request(t,s={}){return s.url=t,N(this.interceptors,s).then((()=>e.polyfill.fetch(s.url,s).then((t=>((t,e)=>{switch(t.status){case 0:return"/"!=t.url[0]?G(t,e):W(new Error(`The file ${t.url} is ${t.statusText}`));case 200:case 201:case 206:case 304:return G(t,e);default:return W(new Error(`The file ${t.url} is ${t.statusText}`),e)}})(t,s)))))}}H.retryDelay=100,H.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/vnd.ms-dds",JSON:"application/json",PNG:"image/png",KTX:"image/ktx",KTX2:"image/ktx2",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary",SCRIPT:"application/javascript"},H.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},H.BinaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".hdr"],H.retryDelay=100;const j=new H,q=0,X=1,Y=2,K=3,$=4,Z=5;class J{constructor(t=0,e=0,s=0,i=1){const n=t.length;t&&void 0!==t.r?(this.r=t.r,this.g=t.g,this.b=t.b,this.a=void 0!==t.a?t.a:1):3===n||4===n?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=void 0!==t[3]?t[3]:1):(this.r=t,this.g=e,this.b=s,this.a=i)}clone(){return new J(this.r,this.g,this.b,this.a)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}set(t,e,s,i=1){return this.r=t||0,this.g=e||0,this.b=s||0,this.a=void 0!==i?i:1,this}lerp(t,e,s){return this.r=t.r+s*(e.r-t.r),this.g=t.g+s*(e.g-t.g),this.b=t.b+s*(e.b-t.b),this.a=t.a+s*(e.a-t.a),this}fromString(t){const e=parseInt(t.replace("#","0x"),16);let s;return t.length>7?s=V.intToBytes32(e):(s=V.intToBytes24(e),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(t){let e="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===t){const t=Math.round(255*this.a).toString(16);this.a<16/255?e+="0"+t:e+=t}return e}}J.BLACK=Object.freeze(new J(0,0,0,1)),J.BLUE=Object.freeze(new J(0,0,1,1)),J.CYAN=Object.freeze(new J(0,1,1,1)),J.GRAY=Object.freeze(new J(.5,.5,.5,1)),J.GREEN=Object.freeze(new J(0,1,0,1)),J.MAGENTA=Object.freeze(new J(1,0,1,1)),J.RED=Object.freeze(new J(1,0,0,1)),J.WHITE=Object.freeze(new J(1,1,1,1)),J.YELLOW=Object.freeze(new J(1,1,0,1));class Q{constructor(t,e=0){this._curve=t,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._reset(e)}evaluate(t,e){let s;(e||t<this._left||t>=this._right)&&this._reset(t);const i=this._curve.type;if(i===Z)s=this._p0;else{const e=0===this._recip?0:(t-this._left)*this._recip;s=i===q?V.lerp(this._p0,this._p1,e):i===X?V.lerp(this._p0,this._p1,e*e*(3-2*e)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,e)}return s}_reset(t){const e=this._curve.keys,s=e.length;if(s)if(t<e[0][0])this._left=-1/0,this._right=e[0][0],this._recip=0,this._p0=this._p1=e[0][1],this._m0=this._m1=0;else if(t>=e[s-1][0])this._left=e[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=e[s-1][1],this._m0=this._m1=0;else{let s=0;for(;t>=e[s+1][0];)s++;this._left=e[s][0],this._right=e[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=e[s][1],this._p1=e[s+1][1],this._isHermite()&&this._calcTangents(e,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_isHermite(){return this._curve.type===Y||this._curve.type===K||this._curve.type===$}_calcTangents(t,e){let s;const i=t[e],n=t[e+1];let a;if(s=0===e?[t[0][0]+(t[0][0]-t[1][0]),t[0][1]+(t[0][1]-t[1][1])]:t[e-1],a=e===t.length-2?[t[e+1][0]+(t[e+1][0]-t[e][0]),t[e+1][1]+(t[e+1][1]-t[e][1])]:t[e+2],this._curve.type===$){const t=2*(n[0]-i[0])/(n[0]-s[0]),e=2*(n[0]-i[0])/(a[0]-i[0]);this._m0=this._curve.tension*(isFinite(t)?t:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(e)?e:0)*(a[1]-i[1])}else{const t=(n[0]-i[0])/(i[0]-s[0]),e=(n[0]-i[0])/(a[0]-n[0]),r=i[1]+(s[1]-i[1])*(isFinite(t)?t:0),o=n[1]+(a[1]-n[1])*(isFinite(e)?e:0),h=this._curve.type===Y?.5:this._curve.tension;this._m0=h*(n[1]-r),this._m1=h*(o-i[1])}}_evaluateHermite(t,e,s,i,n){const a=n*n,r=n+n,o=1-n,h=o*o;return t*((1+r)*h)+s*(n*h)+e*(a*(3-r))+i*(a*(n-1))}}class tt{constructor(t){if(this.keys=[],this.type=X,this.tension=.5,this._eval=new Q(this),t)for(let e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()}add(t,e){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>t);n++);const a=[t,e];return this.keys.splice(n,0,a),a}get(t){return this.keys[t]}sort(){this.keys.sort((function(t,e){return t[0]-e[0]}))}value(t){return this._eval.evaluate(t,!0)}closest(t){const e=this.keys,s=e.length;let i=2,n=null;for(let a=0;a<s;a++){const s=Math.abs(t-e[a][0]);if(!(i>=s))break;i=s,n=e[a]}return n}clone(){const t=new tt;return t.keys=c(t.keys,this.keys),t.type=this.type,t.tension=this.tension,t}quantize(t){t=Math.max(t,2);const e=new Float32Array(t),s=1/(t-1);e[0]=this._eval.evaluate(0,!0);for(let i=1;i<t;i++)e[i]=this._eval.evaluate(s*i);return e}quantizeClamped(t,e,s){const i=this.quantize(t);for(let t=0;t<i.length;++t)i[t]=Math.min(s,Math.max(e,i[t]));return i}get length(){return this.keys.length}}class et{constructor(){if(this.curves=[],this._type=X,arguments.length>1)for(let t=0;t<arguments.length;t++)this.curves.push(new tt(arguments[t]));else if(0===arguments.length)this.curves.push(new tt);else{const t=arguments[0];if("number"==typeof t)for(let e=0;e<t;e++)this.curves.push(new tt);else for(let e=0;e<t.length;e++)this.curves.push(new tt(t[e]))}}get(t){return this.curves[t]}value(t,e=[]){const s=this.curves.length;e.length=s;for(let i=0;i<s;i++)e[i]=this.curves[i].value(t);return e}clone(){const t=new et;t.curves=[];for(let e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t}quantize(t){t=Math.max(t,2);const e=this.curves.length,s=new Float32Array(t*e),i=1/(t-1);for(let n=0;n<e;n++){const a=new Q(this.curves[n]);for(let r=0;r<t;r++)s[r*e+n]=a.evaluate(i*r)}return s}quantizeClamped(t,e,s){const i=this.quantize(t);for(let t=0;t<i.length;++t)i[t]=Math.min(s,Math.max(e,i[t]));return i}get length(){return this.curves.length}get type(){return this._type}set type(t){this._type=t;for(let e=0;e<this.curves.length;e++)this.curves[e].type=t}}class st{constructor(t=0,e=0){t&&void 0!==t.x?(this.x=t.x,this.y=t.y):t&&2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t||0,this.y=e||0)}add(t){return this.x+=t.x,this.y+=t.y,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScalar(t){return this.x+=t,this.y+=t,this}clone(){return new st(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}cross(t){return this.x*t.y-this.y*t.x}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}div(t){return this.x/=t.x,this.y/=t.y,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}divScalar(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this}mul(t){return this.x*=t.x,this.y*=t.y,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}mulScalar(t){return this.x*=t,this.y*=t,this}normalize(){const t=this.x*this.x+this.y*this.y;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),this}set(t,e){return this.x=t||0,this.y=e||0,this}sub(t){return this.x-=t.x,this.y-=t.y,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}subScalar(t){return this.x-=t,this.y-=t,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}}st.ZERO=Object.freeze(new st(0,0)),st.ONE=Object.freeze(new st(1,1)),st.UP=Object.freeze(new st(0,1)),st.DOWN=Object.freeze(new st(0,-1)),st.RIGHT=Object.freeze(new st(1,0)),st.LEFT=Object.freeze(new st(-1,0));class it{constructor(t=0,e=0,s=0){t&&void 0!==t.x?(this.x=t.x,this.y=t.y,this.z=t.z):3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t,this.y=e,this.z=s)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}clone(){return new it(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}cross(t,e){const s=t.x,i=t.y,n=t.z,a=e.x,r=e.y,o=e.z;return this.x=i*o-r*n,this.y=n*a-o*s,this.z=s*r-a*i,this}distance(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return Math.sqrt(e*e+s*s+i*i)}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}divide(t){if(!t.equals(it.ZERO))return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divide2(t,e){if(!e.equals(it.ZERO))return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this}project(t){const e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this}set(t,e,s){return this.x=t||0,this.y=e||0,this.z=s||0,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}it.ZERO=Object.freeze(new it(0,0,0)),it.ONE=Object.freeze(new it(1,1,1)),it.UP=Object.freeze(new it(0,1,0)),it.DOWN=Object.freeze(new it(0,-1,0)),it.RIGHT=Object.freeze(new it(1,0,0)),it.LEFT=Object.freeze(new it(-1,0,0)),it.FORWARD=Object.freeze(new it(0,0,-1)),it.BACK=Object.freeze(new it(0,0,1));class nt{constructor(t=0,e=0,s=0,i=0){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}clone(){return new nt(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this.w=t.w/e.w,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this.w=t.w+s*(e.w-t.w),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e,this.w*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}nt.ZERO=Object.freeze(new nt(0,0,0,0)),nt.ONE=Object.freeze(new nt(1,1,1,1));class at{constructor(){const t=new Float32Array(9);t[0]=t[4]=t[8]=1,this.data=t}clone(){return(new at).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}toString(){let t="[";for(let e=0;e<9;e++)t+=this.data[e],t+=8!==e?", ":"";return t+="]",t}transpose(){const t=this.data;let e;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}setFromMat4(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],this}transformVector(t,e=new it){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[3]+a*s[6],e.y=i*s[1]+n*s[4]+a*s[7],e.z=i*s[2]+n*s[5]+a*s[8],e}}at.IDENTITY=Object.freeze(new at),at.ZERO=Object.freeze((new at).set([0,0,0,0,0,0,0,0,0]));const rt=new st,ot=new it,ht=new it,lt=new it,ct=new it;class dt{constructor(){const t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t}static _getPerspectiveHalfSize(t,e,s,i,n){n?(t.x=i*Math.tan(e*Math.PI/360),t.y=t.x/s):(t.y=i*Math.tan(e*Math.PI/360),t.x=t.y*s)}add2(t,e){const s=t.data,i=e.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(t){return this.add2(this,t)}clone(){return(new dt).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]&&e[9]===s[9]&&e[10]===s[10]&&e[11]===s[11]&&e[12]===s[12]&&e[13]===s[13]&&e[14]===s[14]&&e[15]===s[15]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]}mul2(t,e){const s=t.data,i=e.data,n=this.data,a=s[0],r=s[1],o=s[2],h=s[3],l=s[4],c=s[5],d=s[6],u=s[7],p=s[8],m=s[9],f=s[10],_=s[11],g=s[12],y=s[13],v=s[14],x=s[15];let b,S,w,M;return b=i[0],S=i[1],w=i[2],M=i[3],n[0]=a*b+l*S+p*w+g*M,n[1]=r*b+c*S+m*w+y*M,n[2]=o*b+d*S+f*w+v*M,n[3]=h*b+u*S+_*w+x*M,b=i[4],S=i[5],w=i[6],M=i[7],n[4]=a*b+l*S+p*w+g*M,n[5]=r*b+c*S+m*w+y*M,n[6]=o*b+d*S+f*w+v*M,n[7]=h*b+u*S+_*w+x*M,b=i[8],S=i[9],w=i[10],M=i[11],n[8]=a*b+l*S+p*w+g*M,n[9]=r*b+c*S+m*w+y*M,n[10]=o*b+d*S+f*w+v*M,n[11]=h*b+u*S+_*w+x*M,b=i[12],S=i[13],w=i[14],M=i[15],n[12]=a*b+l*S+p*w+g*M,n[13]=r*b+c*S+m*w+y*M,n[14]=o*b+d*S+f*w+v*M,n[15]=h*b+u*S+_*w+x*M,this}mulAffine2(t,e){const s=t.data,i=e.data,n=this.data,a=s[0],r=s[1],o=s[2],h=s[4],l=s[5],c=s[6],d=s[8],u=s[9],p=s[10],m=s[12],f=s[13],_=s[14];let g,y,v;return g=i[0],y=i[1],v=i[2],n[0]=a*g+h*y+d*v,n[1]=r*g+l*y+u*v,n[2]=o*g+c*y+p*v,n[3]=0,g=i[4],y=i[5],v=i[6],n[4]=a*g+h*y+d*v,n[5]=r*g+l*y+u*v,n[6]=o*g+c*y+p*v,n[7]=0,g=i[8],y=i[9],v=i[10],n[8]=a*g+h*y+d*v,n[9]=r*g+l*y+u*v,n[10]=o*g+c*y+p*v,n[11]=0,g=i[12],y=i[13],v=i[14],n[12]=a*g+h*y+d*v+m,n[13]=r*g+l*y+u*v+f,n[14]=o*g+c*y+p*v+_,n[15]=1,this}mul(t){return this.mul2(this,t)}transformPoint(t,e=new it){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[4]+a*s[8]+s[12],e.y=i*s[1]+n*s[5]+a*s[9]+s[13],e.z=i*s[2]+n*s[6]+a*s[10]+s[14],e}transformVector(t,e=new it){const s=this.data,i=t.x,n=t.y,a=t.z;return e.x=i*s[0]+n*s[4]+a*s[8],e.y=i*s[1]+n*s[5]+a*s[9],e.z=i*s[2]+n*s[6]+a*s[10],e}transformVec4(t,e=new nt){const s=this.data,i=t.x,n=t.y,a=t.z,r=t.w;return e.x=i*s[0]+n*s[4]+a*s[8]+r*s[12],e.y=i*s[1]+n*s[5]+a*s[9]+r*s[13],e.z=i*s[2]+n*s[6]+a*s[10]+r*s[14],e.w=i*s[3]+n*s[7]+a*s[11]+r*s[15],e}setLookAt(t,e,s){lt.sub2(t,e).normalize(),ht.copy(s).normalize(),ot.cross(ht,lt).normalize(),ht.cross(lt,ot);const i=this.data;return i[0]=ot.x,i[1]=ot.y,i[2]=ot.z,i[3]=0,i[4]=ht.x,i[5]=ht.y,i[6]=ht.z,i[7]=0,i[8]=lt.x,i[9]=lt.y,i[10]=lt.z,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}setFrustum(t,e,s,i,n,a){const r=2*n,o=e-t,h=i-s,l=a-n,c=this.data;return c[0]=r/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=r/h,c[6]=0,c[7]=0,c[8]=(e+t)/o,c[9]=(i+s)/h,c[10]=(-a-n)/l,c[11]=-1,c[12]=0,c[13]=0,c[14]=-r*a/l,c[15]=0,this}setPerspective(t,e,s,i,n){return dt._getPerspectiveHalfSize(rt,t,e,s,n),this.setFrustum(-rt.x,rt.x,-rt.y,rt.y,s,i)}setOrtho(t,e,s,i,n,a){const r=this.data;return r[0]=2/(e-t),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(i-s),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(a-n),r[11]=0,r[12]=-(e+t)/(e-t),r[13]=-(i+s)/(i-s),r[14]=-(a+n)/(a-n),r[15]=1,this}setFromAxisAngle(t,e){e*=V.DEG_TO_RAD;const s=t.x,i=t.y,n=t.z,a=Math.cos(e),r=Math.sin(e),o=1-a,h=o*s,l=o*i,c=this.data;return c[0]=h*s+a,c[1]=h*i+r*n,c[2]=h*n-r*i,c[3]=0,c[4]=h*i-r*n,c[5]=l*i+a,c[6]=l*n+r*s,c[7]=0,c[8]=h*n+r*i,c[9]=l*n-s*r,c[10]=o*n*n+a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(t,e,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,this}setScale(t,e,s){const i=this.data;return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(t,e,s,i){const n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=t+.5*s,n[13]=e+.5*i,n[14]=.5,n[15]=1,this}invert(){const t=this.data,e=t[0],s=t[1],i=t[2],n=t[3],a=t[4],r=t[5],o=t[6],h=t[7],l=t[8],c=t[9],d=t[10],u=t[11],p=t[12],m=t[13],f=t[14],_=t[15],g=e*r-s*a,y=e*o-i*a,v=e*h-n*a,x=s*o-i*r,b=s*h-n*r,S=i*h-n*o,w=l*m-c*p,M=l*f-d*p,T=l*_-u*p,A=c*f-d*m,C=c*_-u*m,P=d*_-u*f,R=g*P-y*C+v*A+x*T-b*M+S*w;if(0===R)this.setIdentity();else{const E=1/R;t[0]=(r*P-o*C+h*A)*E,t[1]=(-s*P+i*C-n*A)*E,t[2]=(m*S-f*b+_*x)*E,t[3]=(-c*S+d*b-u*x)*E,t[4]=(-a*P+o*T-h*M)*E,t[5]=(e*P-i*T+n*M)*E,t[6]=(-p*S+f*v-_*y)*E,t[7]=(l*S-d*v+u*y)*E,t[8]=(a*C-r*T+h*w)*E,t[9]=(-e*C+s*T-n*w)*E,t[10]=(p*b-m*v+_*g)*E,t[11]=(-l*b+c*v-u*g)*E,t[12]=(-a*A+r*M-o*w)*E,t[13]=(e*A-s*M+i*w)*E,t[14]=(-p*x+m*y-f*g)*E,t[15]=(l*x-c*y+d*g)*E}return this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}setTRS(t,e,s){const i=e.x,n=e.y,a=e.z,r=e.w,o=s.x,h=s.y,l=s.z,c=i+i,d=n+n,u=a+a,p=i*c,m=i*d,f=i*u,_=n*d,g=n*u,y=a*u,v=r*c,x=r*d,b=r*u,S=this.data;return S[0]=(1-(_+y))*o,S[1]=(m+b)*o,S[2]=(f-x)*o,S[3]=0,S[4]=(m-b)*h,S[5]=(1-(p+y))*h,S[6]=(g+v)*h,S[7]=0,S[8]=(f+x)*l,S[9]=(g-v)*l,S[10]=(1-(p+_))*l,S[11]=0,S[12]=t.x,S[13]=t.y,S[14]=t.z,S[15]=1,this}transpose(){let t;const e=this.data;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invertTo3x3(t){const e=this.data,s=t.data,i=e[0],n=e[1],a=e[2],r=e[4],o=e[5],h=e[6],l=e[8],c=e[9],d=e[10],u=d*o-h*c,p=-d*n+a*c,m=h*n-a*o,f=-d*r+h*l,_=d*i-a*l,g=-h*i+a*r,y=c*r-o*l,v=-c*i+n*l,x=o*i-n*r,b=i*u+n*f+a*y;if(0===b)return this;const S=1/b;return s[0]=S*u,s[1]=S*p,s[2]=S*m,s[3]=S*f,s[4]=S*_,s[5]=S*g,s[6]=S*y,s[7]=S*v,s[8]=S*x,this}getTranslation(t=new it){return t.set(this.data[12],this.data[13],this.data[14])}getX(t=new it){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new it){return t.set(this.data[4],this.data[5],this.data[6])}getZ(t=new it){return t.set(this.data[8],this.data[9],this.data[10])}getScale(t=new it){return this.getX(ot),this.getY(ht),this.getZ(lt),t.set(ot.length(),ht.length(),lt.length()),t}setFromEulerAngles(t,e,s){t*=V.DEG_TO_RAD,e*=V.DEG_TO_RAD,s*=V.DEG_TO_RAD;const i=Math.sin(-t),n=Math.cos(-t),a=Math.sin(-e),r=Math.cos(-e),o=Math.sin(-s),h=Math.cos(-s),l=this.data;return l[0]=r*h,l[1]=-r*o,l[2]=a,l[3]=0,l[4]=n*o+h*i*a,l[5]=n*h-i*a*o,l[6]=-r*i,l[7]=0,l[8]=i*o-n*h*a,l[9]=h*i+n*a*o,l[10]=n*r,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,this}getEulerAngles(t=new it){this.getScale(ct);const e=ct.x,s=ct.y,i=ct.z;if(0===e||0===s||0===i)return t.set(0,0,0);const n=this.data,a=Math.asin(-n[2]/e),r=.5*Math.PI;let o,h;return a<r?a>-r?(o=Math.atan2(n[6]/s,n[10]/i),h=Math.atan2(n[1]/e,n[0]/e)):(h=0,o=-Math.atan2(n[4]/s,n[5]/s)):(h=0,o=Math.atan2(n[4]/s,n[5]/s)),t.set(o,a,h).mulScalar(V.RAD_TO_DEG)}toString(){let t="[";for(let e=0;e<16;e+=1)t+=this.data[e],t+=15!==e?", ":"";return t+="]",t}}dt.IDENTITY=Object.freeze(new dt),dt.ZERO=Object.freeze((new dt).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));let ut,pt,mt=new it;class ft{constructor(t=0,e=0,s=0,i=1){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}clone(){return new ft(this.x,this.y,this.z,this.w)}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}getAxisAngle(t){let e=2*Math.acos(this.w);const s=Math.sin(e/2);return 0!==s?(t.x=this.x/s,t.y=this.y/s,t.z=this.z/s,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*V.RAD_TO_DEG}getEulerAngles(t=new it){let e,s,i;const n=this.x,a=this.y,r=this.z,o=this.w,h=2*(o*a-n*r);return h<=-.99999?(e=2*Math.atan2(n,o),s=-Math.PI/2,i=0):h>=.99999?(e=2*Math.atan2(n,o),s=Math.PI/2,i=0):(e=Math.atan2(2*(o*n+a*r),1-2*(n*n+a*a)),s=Math.asin(h),i=Math.atan2(2*(o*r+n*a),1-2*(a*a+r*r))),t.set(e,s,i).mulScalar(V.RAD_TO_DEG)}invert(){return this.conjugate().normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(t){const e=this.x,s=this.y,i=this.z,n=this.w,a=t.x,r=t.y,o=t.z,h=t.w;return this.x=n*a+e*h+s*o-i*r,this.y=n*r+s*h+i*a-e*o,this.z=n*o+i*h+e*r-s*a,this.w=n*h-e*a-s*r-i*o,this}mul2(t,e){const s=t.x,i=t.y,n=t.z,a=t.w,r=e.x,o=e.y,h=e.z,l=e.w;return this.x=a*r+s*l+i*h-n*o,this.y=a*o+i*l+n*r-s*h,this.z=a*h+n*l+s*o-i*r,this.w=a*l-s*r-i*o-n*h,this}normalize(){let t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setFromAxisAngle(t,e){e*=.5*V.DEG_TO_RAD;const s=Math.sin(e),i=Math.cos(e);return this.x=s*t.x,this.y=s*t.y,this.z=s*t.z,this.w=i,this}setFromEulerAngles(t,e,s){const i=.5*V.DEG_TO_RAD;t*=i,e*=i,s*=i;const n=Math.sin(t),a=Math.cos(t),r=Math.sin(e),o=Math.cos(e),h=Math.sin(s),l=Math.cos(s);return this.x=n*o*l-a*r*h,this.y=a*r*l+n*o*h,this.z=a*o*h-n*r*l,this.w=a*o*l+n*r*h,this}setFromMat4(t){let e,s,i,n,a,r,o,h,l,c,d,u,p,m;if(e=(t=t.data)[0],s=t[1],i=t[2],n=t[4],a=t[5],r=t[6],o=t[8],h=t[9],l=t[10],u=e*e+s*s+i*i,0===u)return this;if(u=1/Math.sqrt(u),p=n*n+a*a+r*r,0===p)return this;if(p=1/Math.sqrt(p),m=o*o+h*h+l*l,0===m)return this;m=1/Math.sqrt(m),e*=u,s*=u,i*=u,n*=p,a*=p,r*=p,o*=m,h*=m,l*=m;const f=e+a+l;return f>=0?(c=Math.sqrt(f+1),this.w=.5*c,c=.5/c,this.x=(r-h)*c,this.y=(o-i)*c,this.z=(s-n)*c):e>a?e>l?(d=e-(a+l)+1,d=Math.sqrt(d),this.x=.5*d,d=.5/d,this.w=(r-h)*d,this.y=(s+n)*d,this.z=(i+o)*d):(d=l-(e+a)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(h+r)*d):a>l?(d=a-(l+e)+1,d=Math.sqrt(d),this.y=.5*d,d=.5/d,this.w=(o-i)*d,this.z=(r+h)*d,this.x=(n+s)*d):(d=l-(e+a)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(h+r)*d),this}slerp(t,e,s){const i=t.x,n=t.y,a=t.z,r=t.w;let o=e.x,h=e.y,l=e.z,c=e.w,d=r*c+i*o+n*h+a*l;if(d<0&&(c=-c,o=-o,h=-h,l=-l,d=-d),Math.abs(d)>=1)return this.w=r,this.x=i,this.y=n,this.z=a,this;const u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=.5*r+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*h,this.z=.5*a+.5*l,this;const m=Math.sin((1-s)*u)/p,f=Math.sin(s*u)/p;return this.w=r*m+c*f,this.x=i*m+o*f,this.y=n*m+h*f,this.z=a*m+l*f,this}transformVector(t,e=new it){const s=t.x,i=t.y,n=t.z,a=this.x,r=this.y,o=this.z,h=this.w,l=h*s+r*n-o*i,c=h*i+o*s-a*n,d=h*n+a*i-r*s,u=-a*s-r*i-o*n;return e.x=l*h+u*-a+c*-o-d*-r,e.y=c*h+u*-r+d*-a-l*-o,e.z=d*h+u*-o+l*-r-c*-a,e}getYaw(){return this.transformVector(it.FORWARD,mt),Math.atan2(-mt.x,-mt.z)*V.RAD_TO_DEG}getPitch(t){return ut||(ut=new ft),pt||(pt=new ft),ut.setFromEulerAngles(0,-t,0),pt.mul2(ut,this),pt.transformVector(it.FORWARD,mt),Math.atan2(mt.y,-mt.z)*V.RAD_TO_DEG}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}ft.IDENTITY=Object.freeze(new ft(0,0,0,1)),ft.ZERO=Object.freeze(new ft(0,0,0,0));const _t=new it,gt=new it,yt=new it,vt=new it,xt=new it;class bt{constructor(t=new it,e=new it(.5,.5,.5)){this.center=t,this.halfExtents=e,this._min=new it,this._max=new it}add(t){const e=this.center,s=e.x,i=e.y,n=e.z,a=this.halfExtents,r=a.x,o=a.y,h=a.z;let l=s-r,c=s+r,d=i-o,u=i+o,p=n-h,m=n+h;const f=t.center,_=f.x,g=f.y,y=f.z,v=t.halfExtents,x=v.x,b=v.y,S=v.z,w=_-x,M=_+x,T=g-b,A=g+b,C=y-S,P=y+S;w<l&&(l=w),M>c&&(c=M),T<d&&(d=T),A>u&&(u=A),C<p&&(p=C),P>m&&(m=P),e.x=.5*(l+c),e.y=.5*(d+u),e.z=.5*(p+m),a.x=.5*(c-l),a.y=.5*(u-d),a.z=.5*(m-p)}copy(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents)}clone(){return new bt(this.center.clone(),this.halfExtents.clone())}intersects(t){const e=this.getMax(),s=this.getMin(),i=t.getMax(),n=t.getMin();return s.x<=i.x&&e.x>=n.x&&s.y<=i.y&&e.y>=n.y&&s.z<=i.z&&e.z>=n.z}_intersectsRay(t,e){const s=_t.copy(this.getMin()).sub(t.origin),i=gt.copy(this.getMax()).sub(t.origin),n=t.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const a=yt.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),r=vt.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(r.x,r.y),r.z),h=Math.max(Math.max(a.x,a.y),a.z),l=o>=h&&h>=0;return l&&e.copy(t.direction).mulScalar(h).add(t.origin),l}_fastIntersectsRay(t){const e=_t,s=gt,i=yt,n=vt,a=xt,r=t.direction;return e.sub2(t.origin,this.center),n.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),i.mul2(e,r),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(a.set(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)),s.cross(r,e),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*a.z+this.halfExtents.z*a.y)&&(!(s.y>this.halfExtents.x*a.z+this.halfExtents.z*a.x)&&!(s.z>this.halfExtents.x*a.y+this.halfExtents.y*a.x)))))}intersectsRay(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)}setMinMax(t,e){this.center.add2(e,t).mulScalar(.5),this.halfExtents.sub2(e,t).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(t){const e=this.getMin(),s=this.getMax();return!(t.x<e.x||t.x>s.x||t.y<e.y||t.y>s.y||t.z<e.z||t.z>s.z)}setFromTransformedAabb(t,e){const s=t.center,i=t.halfExtents,n=e.data,a=n[0],r=n[4],o=n[8],h=n[1],l=n[5],c=n[9],d=n[2],u=n[6],p=n[10];this.center.set(n[12]+a*s.x+r*s.y+o*s.z,n[13]+h*s.x+l*s.y+c*s.z,n[14]+d*s.x+u*s.y+p*s.z),this.halfExtents.set(Math.abs(a)*i.x+Math.abs(r)*i.y+Math.abs(o)*i.z,Math.abs(h)*i.x+Math.abs(l)*i.y+Math.abs(c)*i.z,Math.abs(d)*i.x+Math.abs(u)*i.y+Math.abs(p)*i.z)}compute(t,e){if((e=void 0===e?t.length/3:e)>0){const s=_t.set(t[0],t[1],t[2]),i=gt.set(t[0],t[1],t[2]);for(let n=1;n<e;n++){const e=t[3*n+0],a=t[3*n+1],r=t[3*n+2];e<s.x&&(s.x=e),a<s.y&&(s.y=a),r<s.z&&(s.z=r),e>i.x&&(i.x=e),a>i.y&&(i.y=a),r>i.z&&(i.z=r)}this.setMinMax(s,i)}}intersectsBoundingSphere(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius}_distanceToBoundingSphereSq(t){const e=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let a=0;a<3;++a){let r=0;const o=t.center[n[a]],h=e[n[a]],l=s[n[a]];let c=0;o<h&&(c=h-o,r+=c*c),o>l&&(c=o-l,r+=c*c),i+=r}return i}_expand(t,e){_t.add2(this.getMin(),t),gt.add2(this.getMax(),e),this.setMinMax(_t,gt)}}const St=new it,wt=new it;class Mt{constructor(t=new it,e=.5){this.center=t,this.radius=e}containsPoint(t){const e=St.sub2(t,this.center).lengthSq(),s=this.radius;return e<s*s}intersectsRay(t,e){const s=St.copy(t.origin).sub(this.center),i=s.dot(wt.copy(t.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return null;const a=i*i-n;if(a<0)return!1;const r=Math.abs(-i-Math.sqrt(a));return e&&e.copy(t.direction).mulScalar(r).add(t.origin),!0}intersectsBoundingSphere(t){St.sub2(t.center,this.center);const e=t.radius+this.radius;return St.lengthSq()<=e*e}}const Tt=0,At=1,Ct=2,Pt=3,Rt=4,Et=5,Lt=6,It=7,Dt=8,Ft=9,Ot=10,kt="none",Bt="linear",zt=2,Ut=0,Vt=2,Nt=15,Wt=0,Gt=1,Ht=2,jt=3,qt=4,Xt=0,Yt=1,Kt=2,$t=0,Zt=1,Jt=2,Qt=3,te=0,ee=1,se=0,ie=1,ne=2,ae=3,re=4,oe=5,he=6,le={};le[se]="PCF3",le[ie]="VSM8",le[ne]="VSM16",le[ae]="VSM32",le[re]="PCF5",le[oe]="PCF1";const ce=1,de=0,ue=0,pe=0,me=1,fe=0,_e=1,ge=0,ye=1,ve=0,xe=1,be=2,Se=0,we=1,Me=0,Te=1,Ae="mul",Ce=0,Pe=1,Re=2,Ee=3;var Le=1,Ie=2,De=3,Fe=4,Oe=5;const ke=0,Be=1,ze=2,Ue=1,Ve=2,Ne=4,We=8,Ge=16,He=32,je=64,qe=128,Xe=256,Ye=512,Ke=1024,$e=2048,Ze=4096,Je=8192,Qe=1,ts=0,es=1,ss=2,is=0,ns=1,as=1,rs=2,os=4,hs=0,ls=1,cs=2,ds=3,us=18,ps=0,ms=1,fs=2,_s=1,gs=0,ys=1,vs=2,xs=0,bs=1,Ss=2,ws=3,Ms=4,Ts=5,As=1,Cs=2,Ps=4,Rs=8,Es=0,Ls=1,Is=0,Ds=1,Fs=[new it,new it,new it,new it,new it,new it,new it,new it];class Os{constructor(){this.planes=[];for(let t=0;t<6;t++)this.planes[t]=[]}setFromMat4(t){const e=t.data;let s;const i=this.planes;s=i[0],s[0]=e[3]-e[0],s[1]=e[7]-e[4],s[2]=e[11]-e[8],s[3]=e[15]-e[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=e[3]+e[0],s[1]=e[7]+e[4],s[2]=e[11]+e[8],s[3]=e[15]+e[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=e[3]+e[1],s[1]=e[7]+e[5],s[2]=e[11]+e[9],s[3]=e[15]+e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=e[3]-e[1],s[1]=e[7]-e[5],s[2]=e[11]-e[9],s[3]=e[15]-e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=e[3]-e[2],s[1]=e[7]-e[6],s[2]=e[11]-e[10],s[3]=e[15]-e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=e[3]+e[2],s[1]=e[7]+e[6],s[2]=e[11]+e[10],s[3]=e[15]+e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(t){let e,s;for(e=0;e<6;e++)if(s=this.planes[e],s[0]*t.x+s[1]*t.y+s[2]*t.z+s[3]<=0)return!1;return!0}containsSphere(t){let e,s,i=0;const n=t.radius,a=t.center,r=a.x,o=a.y,h=a.z,l=this.planes;let c;for(s=0;s<6;s++){if(c=l[s],e=c[0]*r+c[1]*o+c[2]*h+c[3],e<=-n)return 0;e>n&&i++}return 6===i?2:1}static getPoints(t,e,s){e=e||t._nearClip,s=s||t._farClip;const i=t._fov*Math.PI/180;let n=t._projection===ge?Math.tan(i/2)*e:t._orthoHeight,a=n*t._aspectRatio;const r=Fs;return r[0].x=a,r[0].y=-n,r[0].z=-e,r[1].x=a,r[1].y=n,r[1].z=-e,r[2].x=-a,r[2].y=n,r[2].z=-e,r[3].x=-a,r[3].y=-n,r[3].z=-e,t._projection===ge&&(n=Math.tan(i/2)*s,a=n*t._aspectRatio),r[4].x=a,r[4].y=-n,r[4].z=-s,r[5].x=a,r[5].y=n,r[5].z=-s,r[6].x=-a,r[6].y=n,r[6].z=-s,r[7].x=-a,r[7].y=-n,r[7].z=-s,r}}new it,new it,new it;const ks=new it,Bs=new it,zs=new it,Us=new it;class Vs{constructor(t=new it,e=new it(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}}Vs.prototype.copy=function(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this},Vs.prototype.clone=function(){return(new this.constructor).copy(this)},Vs.prototype.at=function(t,e){return void 0===e&&(e=new it),e.copy(this.direction).scale(t).add(this.origin)},Vs.prototype.intersectTriangle=function(t,e,s,i,n){Bs.sub2(e,t),zs.sub2(s,t),Us.cross(Bs,zs);let a,r=this.direction.dot(Us);if(r>0){if(i)return null;a=1}else{if(!(r<0))return null;a=-1,r=-r}ks.sub2(this.origin,t);const o=a*this.direction.dot(zs.cross(ks,zs));if(o<0)return null;const h=a*this.direction.dot(Bs.cross(Bs,ks));if(h<0)return null;if(o+h>r)return null;const l=-a*ks.dot(Us);return l<0?null:this.at(l/r,n)},Vs.prototype.applyMatrix4=function(t){return t.transformPoint(this.origin,this.origin),t.transformVector(this.direction,this.direction),this};new Vs,new it,new Mt,new dt;new it;const Ns=0,Ws=1,Gs=2,Hs=0,js=1,qs=2,Xs=4,Ys=5,Ks=6,$s=8,Zs=0,Js=3,Qs=4,ti=0,ei=1,si=2,ii=3,ni=1,ai=2,ri=4,oi=0,hi=1,li=2,ci=3,di=0,ui=1,pi=2,mi=3,fi=4,_i=5,gi=1,yi=2,vi=3,xi=7,bi=0,Si=1,wi=2,Mi=0,Ti=1,Ai=2,Ci=3,Pi=4,Ri=5,Ei=6,Li=7,Ii=8,Di=9,Fi=10,Oi=11,ki=12,Bi=13,zi=14,Ui=15,Vi=16,Ni=17,Wi=18,Gi=19,Hi=20,ji=21,qi=22,Xi=23,Yi=24,Ki=25,$i=26,Zi=27,Ji=28,Qi=29,tn=30,en=0,sn=1,nn=2,an=3,rn=4,on=5,hn=6,ln="POSITION",cn="NORMAL",dn="TANGENT",un="BLENDWEIGHT",pn="BLENDINDICES",mn="COLOR",fn="TEXCOORD",_n="TEXCOORD0",gn="TEXCOORD1",yn="TEXCOORD2",vn="TEXCOORD3",xn="TEXCOORD4",bn="TEXCOORD5",Sn="TEXCOORD6",wn="TEXCOORD7",Mn="ATTR",Tn="ATTR0",An="ATTR1",Cn="ATTR2",Pn="ATTR3",Rn="ATTR4",En="ATTR5",Ln="ATTR6",In="ATTR7",Dn="ATTR8",Fn="ATTR9",On="ATTR10",kn="ATTR11",Bn="ATTR12",zn="ATTR13",Un="ATTR14",Vn="ATTR15",Nn=1,Wn=0,Gn=2,Hn=3,jn=5,qn=2,Xn="default",Yn="rgbm",Kn="rgbe",$n="swizzleGGGR",Zn="none",Jn="cube",Qn="equirect",ta="octahedral",ea=0,sa=1,ia=2,na=3,aa=4,ra=5,oa=6,ha=0,la=1,ca=2,da=3,ua=4,pa=5,ma=6,fa=7,_a=8,ga=9,ya=10,va=11,xa=12,ba=13,Sa=14,wa=15,Ma=16,Ta=17,Aa=18,Ca=19,Pa=20,Ra=21,Ea=22,La=23,Ia=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],Da=[1,1,2,2,4,4,4],Fa=[Uint8Array,Uint16Array,Uint32Array],Oa={};Oa[ln]=0,Oa[cn]=1,Oa[un]=2,Oa[pn]=3,Oa[mn]=4,Oa[_n]=5,Oa[gn]=6,Oa[yn]=7,Oa[vn]=8,Oa[xn]=9,Oa[bn]=10,Oa[Sn]=11,Oa[wn]=12,Oa[dn]=13,Oa[Tn]=0,Oa[An]=1,Oa[Cn]=2,Oa[Pn]=3,Oa[Rn]=4,Oa[En]=5,Oa[Ln]=6,Oa[In]=7,Oa[Dn]=8,Oa[Fn]=9,Oa[On]=10,Oa[kn]=11,Oa[Bn]=12,Oa[zn]=13,Oa[Un]=14,Oa[Vn]=15;const ka=new it;new it,new it,new it,new it,new it,new it,new it,new it,new it;class Ba{constructor(t,e,s){this.a=void 0!==t?t:new it,this.b=void 0!==e?e:new it,this.c=void 0!==s?s:new it}static getNormal(t,e,s,i){void 0===i&&(console.warn("THREE.Triangle: .getNormal() target is now required"),i=new it),i.sub2(s,e),ka.sub2(t,e),i.cross(i,ka);const n=i.lengthSq();return n>0?i.scale(1/Math.sqrt(n)):i.set(0,0,0)}set(t,e,s){return this.a.copy(t),this.b.copy(e),this.c.copy(s),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getNormal(t){return Ba.getNormal(this.a,this.b,this.c,t)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}new dt;const za=new Vs,Ua=new it,Va=new it,Na=new it,Wa=new it,Ga=new it,Ha=new it,ja=new it,qa=new dt;class Xa{constructor(t){this.app=t,this.ray=new Vs,this._getSkinnedVertexPos=this._getSkinnedVertexPos(),this._getVertexPos=this._getVertexPos()}setFromCamera(t,e){const s=e._node,i=s.getPosition(),n=this.ray.direction;n.set(t.x,t.y,.5),qa.copy(e.projectionMatrix).invert().transformPoint(n,n),s.getWorldTransform().transformPoint(n,n),n.sub(i).normalize(),this.ray.origin.copy(i)}_getSkinnedVertexPos(){var t=new nt,e=new nt,s=new it,i=new dt,n=new nt;return(a,r,o,h,l,c,d)=>{d=void 0===d?new it:d;const u=3*c,p=4*c;t.set(o[p],o[p+1],o[p+2],o[p+3]).normalize(),e.set(h[p],h[p+1],h[p+2],h[p+3]),s.set(a[u],a[u+1],a[u+2]);for(var m=0;m<16;m++)i.data[m]=l[e.x].data[m]*t.x,i.data[m]+=l[e.y].data[m]*t.y,i.data[m]+=l[e.z].data[m]*t.z,i.data[m]+=l[e.w].data[m]*t.w;n=i.transformPoint(s);return r.getWorldTransform().transformPoint(n,d),d}}_getVertexPos(){const t=new it;return(e,s,i,n)=>{n=void 0===n?new it:n;const a=3*i;t.set(e[a],e[a+1],e[a+2]);return s.getWorldTransform().transformPoint(t,n),n}}raycastAll(t){if(!t)return;var e=t.node;const s=t.mesh;e.getWorldTransform();const i=[],n=[];s.getPositions(i),s.getIndices(n);const a=[],r=[];let o,h,l=!1;t.skinInstance&&(l=!0,s.getVertexStream(un,a),s.getVertexStream(pn,r),o=t.skinInstance.matrices);const c=[];for(let t=0;t<n.length;t+=3)if(l?(this._getSkinnedVertexPos(i,e,a,r,o,n[t],Ua),this._getSkinnedVertexPos(i,e,a,r,o,n[t+1],Va),this._getSkinnedVertexPos(i,e,a,r,o,n[t+2],Na)):(this._getVertexPos(i,e,n[t],Ua),this._getVertexPos(i,e,n[t+1],Va),this._getVertexPos(i,e,n[t+2],Na)),h=this.ray.intersectTriangle(Ua,Va,Na,!1,Wa),h){Ga.copy(Wa),Ha.sub2(this.ray.origin,Wa);const t=Ha.length();Ba.getNormal(Ua,Va,Na,ja);const e=new Ya(t,Wa.clone(),ja.clone(),[Ua.clone(),Va.clone(),Na.clone()],za.clone(),this.ray.clone());c.push(e)}return c.sort(this._ascSort),c}_ascSort(t,e){return t.distance-e.distance}}class Ya{constructor(t,e,s,i,n,a){this.intersection=i,this.ray=n,this.ray2=a,this.distance=void 0!==t?t:0,this.point=void 0!==e?e:new it,this.normal=void 0!==s?s:new it}}let Ka=0;class $a{constructor(t,e,s,i=ti,n){this.device=t,this.format=e,this.numVertices=s,this.usage=i,this.id=Ka++,this._vao=null,this.instancing=!1,this.numBytes=e.verticesByteSize?e.verticesByteSize:e.size*s,t._vram.vb+=this.numBytes,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);if(-1!==e&&t.buffers.splice(e,1),this.bufferId){const e=t.gl;t.boundVao=null,e.bindVertexArray(null),e.deleteBuffer(this.bufferId),t._vram.vb-=this.storage.byteLength,this.bufferId=null}this.storage=null}loseContext(){this.bufferId=void 0,this._vao=null}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){const t=this.device.gl;let e;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case ti:e=t.STATIC_DRAW;break;case ei:e=t.DYNAMIC_DRAW;break;case si:e=t.STREAM_DRAW;break;case ii:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ARRAY_BUFFER,this.bufferId),t.bufferData(t.ARRAY_BUFFER,this.storage,e)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}}function Za(t){let e=0;for(let s=0,i=t.length;s<i;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return e}class Ja{constructor(t,e,s){this.elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.size=e.reduce(((t,e)=>t+4*Math.ceil(e.components*Da[e.type]/4)),0);let i,n=0;for(let t=0,a=e.length;t<a;t++){const a=e[t];i=a.components*Da[a.type],s&&(n=V.roundUp(n,i));const r={name:a.semantic,offset:s?n:a.hasOwnProperty("offset")?a.offset:n,stride:s?i:a.hasOwnProperty("stride")?a.stride:this.size,dataType:a.type,numComponents:a.components,normalize:void 0!==a.normalize&&a.normalize,size:i};this.elements.push(r),n+=s?i*s:4*Math.ceil(i/4),a.semantic===_n?this.hasUv0=!0:a.semantic===gn?this.hasUv1=!0:a.semantic===mn?this.hasColor=!0:a.semantic===dn&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this.update()}static init(t){const e=[{semantic:Bn,components:4,type:oa},{semantic:zn,components:4,type:oa},{semantic:Un,components:4,type:oa},{semantic:Vn,components:4,type:oa}];Ja._defaultInstancingFormat=new Ja(t,e)}static get defaultInstancingFormat(){return Ja._defaultInstancingFormat}update(){this._evaluateHash()}_evaluateHash(){let t;const e=[];let s;const i=[],n=this.elements.length;for(let a=0;a<n;a++){const n=this.elements[a];t=n.name,t+=n.dataType,t+=n.numComponents,t+=n.normalize,e.push(t),s=t,s+=n.offset,s+=n.stride,s+=n.size,i.push(s)}e.sort(),this.batchingHash=Za(e.join()),this.renderingingHash=Za(i.join())}}Ja._defaultInstancingFormat=null;let Qa=null;const tr={type:on,base:0,count:4,indexed:!1};function er(t,e,s,i,n,a=!1){if(null===Qa){const e=new Ja(t,[{semantic:ln,components:2,type:oa}]),s=new Float32Array(8);s.set([-1,-1,1,-1,-1,1,1,1]),Qa=new $a(t,e,4,ti,s)}const r=t.renderTarget;let o,h,l,c,d,u,p,m;t.setRenderTarget(e),t.updateBegin(),i?(o=i.x,h=i.y,l=i.z,c=i.w):(l=e?e.width:t.width,c=e?e.height:t.height,o=0,h=0),n?(d=n.x,u=n.y,p=n.z,m=n.w):(d=o,u=h,p=l,m=c);const f=t.vx,_=t.vy,g=t.vw,y=t.vh;t.setViewport(o,h,l,c);const v=t.sx,x=t.sy,b=t.sw,S=t.sh;t.setScissor(d,u,p,m);const w=t.getDepthTest(),M=t.getDepthWrite(),T=t.getCullMode(),A=t.writeRed,C=t.writeGreen,P=t.writeBlue,R=t.writeAlpha;t.setDepthTest(!1),t.setDepthWrite(!1),t.setCullMode(oi),t.setColorWrite(!0,!0,!0,!0),a||t.setBlending(!1),t.setVertexBuffer(Qa,0),t.setShader(s),t.draw(tr),t.setDepthTest(w),t.setDepthWrite(M),t.setCullMode(T),t.setColorWrite(A,C,P,R),t.updateEnd(),t.setRenderTarget(r),t.updateBegin(),t.setViewport(f,_,g,y),t.setScissor(v,x,b,S)}class sr{constructor(t,e){this.device=t,this.definition=e,this.init(),this.device.createShader(this)}init(){this.attributes=[],this.uniforms=[],this.samplers=[],this.ready=!1,this.failed=!1}destroy(){this.device.destroyShader(this)}loseContext(){this.init()}}const ir={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientEnvPS:"#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nvoid addAmbient() {\n\tvec3 dir = cubeMapRotate(dNormalW) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\tvec4 raw = texture2D(texture_envAtlas, uv);\n\tvec3 linear = $DECODE(raw);\n\tdDiffuseLight += processEnvironment(linear);\n}\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = cubeMapRotate(dNormalW);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\nuniform float material_aoStrength;\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tdAo *= min(1.0,(texture2D(texture_aoMap, $UV).$CH  +  (1.0 - material_aoStrength)));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"uniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",clearCoatPS:"#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2D(texture_clearCoatMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n\t#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\tccNormalW = dTBN * normalMap;\n\t#else\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",clusteredLightCookiesPS:"vec3 _getCookieClustered(sampler2D tex, vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 pixel = mix(vec4(1.0), texture2D(tex, uv), intensity);\n\treturn isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(sampler2D tex, mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\treturn _getCookieClustered(tex, projPos.xy / projPos.w, intensity, isRgb, cookieChannel);\n}\nvec3 getCookieCubeClustered(sampler2D tex, vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(tex, uv, intensity, isRgb, cookieChannel);\n}\n",clusteredLightShadowsPS:"\n#ifdef GL2\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowOmniClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\treturn texture(shadowMap, vec3(uv, shadowZ));\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfloat getShadowOmniClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF3x3(shadowMap, shadowParams.xyz);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowOmniClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF5x5(shadowMap, shadowParams.xyz);\n\t}\n\t#endif\n#else\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat depth = unpackFloat(texture2D(shadowMap, uv));\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\treturn depth > shadowZ ? 1.0 : 0.0;\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3) || defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\t\tdShadowCoord = vec3(uv, shadowZ);\n\t\treturn getShadowPCF3x3(shadowMap, shadowParams.xyz);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {\n\t\treturn getShadowOmniClusteredPCF3(shadowMap, shadowParams, omniAtlasViewport, shadowEdgePixels, dir);\n\t}\n\t#endif\n#endif\n#ifdef GL2\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowSpotClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\treturn texture(shadowMap, dShadowCoord);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfloat getShadowSpotClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\treturn getShadowSpotPCF3x3(shadowMap, shadowParams);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowSpotClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\t\treturn getShadowPCF5x5(shadowMap, shadowParams.xyz);\n\t}\n\t#endif\n#else\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfloat getShadowSpotClusteredPCF1(sampler2D shadowMap, vec4 shadowParams) {\n\t\tfloat depth = unpackFloat(texture2D(shadowMap, dShadowCoord.xy));\n\t\treturn depth > dShadowCoord.z ? 1.0 : 0.0;\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3) || defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowSpotClusteredPCF3(sampler2D shadowMap, vec4 shadowParams) {\n\t\treturn getShadowSpotPCF3x3(shadowMap, shadowParams);\n\t}\n\t#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfloat getShadowSpotClusteredPCF5(sampler2D shadowMap, vec4 shadowParams) {\n\t\treturn getShadowSpotClusteredPCF3(shadowMap, shadowParams);\n\t}\n\t#endif\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\tvec3 vAbs = abs(dir);\n\tfloat ma;\n\tvec2 uv;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\t\ttileOffset.x = 2.0;\n\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\t} else if(vAbs.y >= vAbs.x) {\n\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\t\ttileOffset.x = 1.0;\n\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\t} else {\n\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\t\ttileOffset.x = 0.0;\n\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\t}\n\treturn uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\tfloat faceIndex;\n\tvec2 tileOffset;\n\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\tfloat atlasFaceSize = omniAtlasViewport.z;\n\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\tfloat offset = shadowEdgePixels / tileSize;\n\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\tuv *= atlasFaceSize;\n\tuv += tileOffset * atlasFaceSize;\n\tuv += omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:"uniform sampler2D clusterWorldTexture;\nuniform sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\n#ifdef CLUSTER_SHADOWS\n\t#ifdef GL2\n\t\tuniform sampler2DShadow shadowAtlasTexture;\n\t#else\n\t\tuniform sampler2D shadowAtlasTexture;\n\t#endif\n#endif\n#ifdef CLUSTER_COOKIES\n\tuniform sampler2D cookieAtlasTexture;\n#endif\nuniform float clusterPixelsPerCell;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec4 lightsTextureInvSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nuniform vec2 shadowAtlasParams;\nfloat LTCLightValuesEvaluated = 0.0;\nstruct ClusterLightData {\n\tfloat lightV;\n\tfloat type;\n\tfloat shape;\n\tvec3 halfWidth;\n\tvec3 halfHeight;\n\tfloat falloffMode;\n\tfloat castShadows;\n\tfloat shadowBias;\n\tfloat shadowNormalBias;\n\tvec3 position;\n\tvec3 direction;\n\tfloat range;\n\tfloat innerConeAngleCos;\n\tfloat outerConeAngleCos;\n\tvec3 color;\n\tvec3 omniAtlasViewport;\n\tfloat cookie;\n\tfloat cookieRgb;\n\tfloat cookieIntensity;\n\tvec4 cookieChannelMask;\n};\nmat4 lightProjectionMatrix;\n#define isClusteredLightCastShadow(light) ( light.castShadows > 0.5 )\n#define isClusteredLightCookie(light) (light.cookie > 0.5 )\n#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )\n#define isClusteredLightSpot(light) ( light.type > 0.5 )\n#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )\n#define isClusteredLightArea(light) ( light.shape > 0.1 )\n#define isClusteredLightRect(light) ( light.shape < 0.3 )\n#define isClusteredLightDisk(light) ( light.shape < 0.6 )\nvec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {\n\treturn vec4(\n\t\tbytes2floatRange4(d0, -2.0, 2.0),\n\t\tbytes2floatRange4(d1, -2.0, 2.0),\n\t\tbytes2floatRange4(d2, -2.0, 2.0),\n\t\tbytes2floatRange4(d3, -2.0, 2.0)\n\t);\n}\n#ifdef SUPPORTS_TEXLOD\n\t#define textureData(texture, uv) texture2DLodEXT(texture, uv, 0.0)\n#else\n\t#define textureData(texture, uv) texture2D(texture, uv)\n#endif\nvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {\n\treturn textureData(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV));\n}\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {\n\treturn textureData(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV));\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\tclusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\tvec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);\n\tclusterLightData.type = lightInfo.x;\n\tclusterLightData.shape = lightInfo.y;\n\tclusterLightData.falloffMode = lightInfo.z;\n\tclusterLightData.castShadows = lightInfo.w;\n\tvec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);\n\tvec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);\n\tclusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;\n\tclusterLightData.cookie = colorB.z;\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);\n\t\tclusterLightData.position = lightPosRange.xyz;\n\t\tclusterLightData.range = lightPosRange.w;\n\t\tvec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);\n\t\tclusterLightData.direction = lightDir_Unused.xyz;\n\t#else\n\t\tvec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);\n\t\tvec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);\n\t\tvec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);\n\t\tclusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;\n\t\tvec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);\n\t\tclusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;\n\t\tvec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);\n\t\tvec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);\n\t\tvec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);\n\t\tclusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;\n\t#endif\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\tvec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);\n\tclusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;\n\tclusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;\n\t#else\n\t\tvec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);\n\t\tvec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);\n\t\tclusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));\n\t#endif\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;\n\t\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;\n\t#else\n\t\tvec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);\n\t\tvec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);\n\t\tvec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);\n\t\tclusterLightData.halfWidth = vec3(mantisaExponent2Float(areaWidthX), mantisaExponent2Float(areaWidthY), mantisaExponent2Float(areaWidthZ));\n\t\tvec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);\n\t\tvec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);\n\t\tvec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);\n\t\tclusterLightData.halfHeight = vec3(mantisaExponent2Float(areaHeightX), mantisaExponent2Float(areaHeightY), mantisaExponent2Float(areaHeightZ));\n\t#endif\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);\n\t\tvec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);\n\t\tvec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);\n\t\tvec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);\n\t#else\n\t\tvec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);\n\t\tvec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);\n\t\tvec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);\n\t\tvec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);\n\t\tvec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);\n\t\tvec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);\n\t\tvec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);\n\t\tvec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);\n\t\tvec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);\n\t\tvec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);\n\t\tvec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);\n\t\tvec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);\n\t\tvec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);\n\t\tvec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);\n\t\tvec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);\n\t\tvec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);\n\t\tvec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);\n\t\tvec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);\n\t\tvec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);\n\t\tvec4 m3 = vec4(mantisaExponent2Float(m30), mantisaExponent2Float(m31), mantisaExponent2Float(m32), mantisaExponent2Float(m33));\n\t#endif\n\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\tvec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);\n\tclusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),\n\tclusterLightData.shadowNormalBias = bytes2float2(biases.zw);\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\tvec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);\n\tclusterLightData.cookieIntensity = cookieA.x;\n\tclusterLightData.cookieRgb = cookieA.y;\n\tclusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);\n}\nvoid evaluateLight(ClusterLightData light) {\n\tdAtten3 = vec3(1.0);\n\tgetLightDirPoint(light.position);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (isClusteredLightArea(light)) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (LTCLightValuesEvaluated < 0.5) {\n\t\t\tLTCLightValuesEvaluated = 1.0;\n\t\t\tcalcLTCLightValues();\n\t\t}\n\t\tif (isClusteredLightRect(light)) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tdAtten = getFalloffWindow(light.range);\n\t} else\n\t#endif\n\t{\n\t\tif (isClusteredLightFalloffLinear(light))\n\t\t\tdAtten = getFalloffLinear(light.range);\n\t\telse\n\t\t\tdAtten = getFalloffInvSquared(light.range);\n\t}\n\tif (dAtten > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\tdAttenD = getRectLightDiffuse() * 16.0;\n\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\tdAttenD = getDiskLightDiffuse() * 16.0;\n\t\t\t} else {\n\t\t\t\tdAttenD = getSphereLightDiffuse() * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tdAtten *= getLightDiffuse();\n\t\t}\n\t\tif (isClusteredLightSpot(light)) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tdAtten *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n\t\tif (dAtten > 0.00001) {\n\t\t\tif (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {\n\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (isClusteredLightCookie(light)) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tdAtten3 = getCookie2DClustered(cookieAtlasTexture, lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdAtten3 = getCookieCubeClustered(cookieAtlasTexture, dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (isClusteredLightCastShadow(light)) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tgetShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tdAtten *= getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnormalOffsetPointShadow(shadowParams);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tdAtten *= getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\t{\n\t\t\t\tvec3 areaDiffuse = (dAttenD * dAtten) * light.color * dAtten3;\n\t\t\t\t#if defined(CLUSTER_SPECULAR) && defined(CLUSTER_CONSERVE_ENERGY)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef CLUSTER_SPECULAR\n\t\t\t\tfloat areaLightSpecular;\n\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular();\n\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular();\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular();\n\t\t\t\t}\n\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * dAtten * light.color * dAtten3;\n\t\t\t\t#ifdef CLUSTER_CLEAR_COAT\n\t\t\t\t\tfloat areaLightSpecularCC;\n\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecularCC();\n\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecularCC();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecularCC();\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * dAtten * light.color  * dAtten3;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvec3 punctualDiffuse = dAtten * light.color * dAtten3;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS) && defined(CLUSTER_SPECULAR) && defined(CLUSTER_CONSERVE_ENERGY)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), dSpecularity);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t}\n\t\t\t#ifdef CLUSTER_SPECULAR\n\t\t\t\t{\n\t\t\t\t\tvec3 punctualSpecular = getLightSpecular() * dAtten * light.color * dAtten3;\n\t\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t\t\tpunctualSpecular *= dSpecularity;\n\t\t\t\t\t#endif\n\t\t\t\t\tdSpecularLight += punctualSpecular;\n\t\t\t\t}\n\t\t\t\t#ifdef CLUSTER_CLEAR_COAT\n\t\t\t\t\tvec3 punctualCC = getLightSpecularCC() * dAtten * light.color * dAtten3;\n\t\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t\t\tpunctualCC *= ccSpecularity;\n\t\t\t\t\t#endif\n\t\t\t\t\tccSpecularLight += punctualCC;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n}\nvoid evaluateClusterLight(float lightIndex) {\n\tClusterLightData clusterLightData;\n\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\tevaluateLight(clusterLightData);\n}\nvoid addClusteredLights() {\n\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\tclusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\t\tconst float maxLightCells = 256.0 / 4.0;\n\t\tfor (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\t\t\tvec4 lightIndices = textureData(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV));\n\t\t\tvec4 indices = lightIndices * 255.0;\n\t\t\tfor (int i = 0; i < 4; i++) {\n\t\t\t\tif (indices.x <= 0.0)\n\t\t\t\t\treturn;\n\t\t\t\tevaluateClusterLight(indices.x);\n\t\t\t\tindices = indices.yzwx;\n\t\t\t}\n\t\t\tif (lightCellIndex > clusterPixelsPerCell) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n}\n",combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"#define M_PI 3.1415926535897932384626433832795\nuniform vec3 envBoxMin, envBoxMax;\nvec3 rotateAroundYInDegrees(vec3 vertex,float degrees)\n{\n\tfloat alpha = degrees * M_PI / 180.0;\n\tfloat sina = sin(alpha);\n\tfloat cosa = cos(alpha);\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\n\treturn vec3( m * vertex.xz,vertex.y).xzy;\n}\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = dir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = dir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = dir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + dir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn normalize(posonbox - envBoxPos);\n}\n",cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t#else\n\treturn albedo;\n\t#endif\n}\n",dilatePS:"#define SHADER_NAME Dilate\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",bilateralDeNoisePS:"\n#define SHADER_NAME BilateralDeNoise\nfloat normpdf3(in vec3 v, in float sigma) {\n\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\n#define MSIZE 15\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[MSIZE];\nvoid main(void) {\n\tvec4 pixelRgbm = texture2D(source, vUv0);\n\tif (pixelRgbm.a <= 0.0) {\n\t\tgl_FragColor = pixelRgbm;\n\t\treturn ;\n\t}\n\tfloat sigma = sigmas.x;\n\tfloat bSigma = sigmas.y;\n\tvec3 pixelHdr = decodeRGBM(pixelRgbm);\n\tvec3 accumulatedHdr = vec3(0.0);\n\tfloat accumulatedFactor = 0.0;\n\tconst int kSize = (MSIZE-1)/2;\n\tfor (int i = -kSize; i <= kSize; ++i) {\n\t\tfor (int j = -kSize; j <= kSize; ++j) {\n\t\t\tvec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n\t\t\tvec4 rgbm = texture2D(source, coord);\n\t\t\tif (rgbm.a > 0.0) {\n\t\t\t\tvec3 hdr = decodeRGBM(rgbm);\n\t\t\t\tfloat factor = kernel[kSize + j] * kernel[kSize + i];\n\t\t\t\tfactor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\t\t\t\taccumulatedHdr += factor * hdr;\n\t\t\t\taccumulatedFactor += factor;\n\t\t\t}\n\t\t}\n\t}\n\tgl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);\n}\n",decodePS:"vec3 decodeLinear(vec4 raw) {\n\treturn raw.rgb;\n}\nvec3 decodeGamma(vec4 raw) {\n\treturn pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n\tif (raw.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t}\n}\nconst float PI = 3.141592653589793;\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\treturn vec2(uv.x, 1.0 - uv.y);\n}\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapMip(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",endPS:"\t#ifdef CLEARCOAT\n\tgl_FragColor.rgb = combineColorCC();\n\t#else\n\tgl_FragColor.rgb = combineColor();\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",endVS:"\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffWindow(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\treturn vec3(0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tvec3 avec = abs(vec);\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tvec3 avec = abs(vec);\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(avec.x, avec.y), avec.z);\n\tif (avec.x != M) vec.x *= scale;\n\tif (avec.y != M) vec.y *= scale;\n\tif (avec.z != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat M = max(avec.x, max(avec.y, avec.z));\n\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec * (seam * -scale + vec3(1.0));\n}\n",floatUnpackingPS:"\nfloat bytes2float2(vec2 data) {\n\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\nfloat bytes2float3(vec3 data) {\n\treturn dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\nfloat bytes2float4(vec4 data) {\n\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\nfloat bytes2floatRange2(vec2 data, float min, float max) {\n\treturn mix(min, max, bytes2float2(data));\n}\nfloat bytes2floatRange3(vec3 data, float min, float max) {\n\treturn mix(min, max, bytes2float3(data));\n}\nfloat bytes2floatRange4(vec4 data, float min, float max) {\n\treturn mix(min, max, bytes2float4(data));\n}\nfloat mantisaExponent2Float(vec4 pack)\n{\n\tfloat value = bytes2floatRange3(pack.xyz, -1.0, 1.0);\n\tfloat exponent = floor(pack.w * 255.0 - 127.0);\n\treturn value * exp2(exponent);\n}\n",fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"float dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nuniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n#define SUPPORTS_TEXLOD\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tvec3 dir = texture2D(texture_dirLightMap, $UV).xyz;\n\tif (dot(dir, vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t} else {\n\t\tdLightDirNormW = normalize(dir * 2.0 - vec3(1.0));\n\t\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\t\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += color * nlight * 2.0;\n\t}\n\tdSpecularLight += color * getLightSpecular();\n}\n",lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tlm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",ltc:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\treturn LTC_Uv( tNormalW, dViewDirW, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n\tvec4 t2 = texture2D( areaLightsLutTex2, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt2 *= vec4(0.693103,1,1,1);\n\tt2 += vec4(0.306897,0,0,0);\n\t#endif\n\treturn tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\nvoid calcLTCLightValues()\n{\n\tdLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres);\n#ifdef CLEARCOAT\n\tccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(ccSpecularityNoFres));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = cross(V1, V2);\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2D( areaLightsLutTex2, uv ).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse() {\n\treturn LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse() {\n\treturn LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse() {\n\tfloat falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n\treturn getLightDiffuse()*falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2D( areaLightsLutTex1, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t#endif\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular() {\n\treturn calcRectLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getRectLightSpecularCC() {\n\treturn calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getDiskLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat getSphereLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getSphereLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n",metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\tdAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2D(texture_metalnessMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tprocessMetalness(metalness);\n}\n",msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\tfloat smoothingMax = 0.2;\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\treturn blendNormals(normalMap, normalDetailMap);\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n\tdNormalW = normalize(dTBN * addNormalDetail(normalMap));\n}\n",normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2D(texture_heightMap, $UV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = texture2DSRGB(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n\tlookupVec.x *= -1.0;\n\treturn $DECODE(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionEnvPS:"#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n\tvec2 dx = dFdx(uv);\n\tvec2 dy = dFdy(uv);\n\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\tvec2 dx2 = dFdx(uv2);\n\tvec2 dy2 = dFdy(uv2);\n\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0, 0.0, 6.0);\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 dir = cubeMapProject(tReflDirW) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat ilevel = floor(level);\n\tvec2 uv0, uv1;\n\tfloat weight;\n\tif (ilevel == 0.0) {\n\t\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\t\tfloat ilevel2 = floor(level2);\n\t\tuv0 = mapMip(uv, ilevel2);\n\t\tuv1 = mapMip(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\tweight = 0.0;\n\t}\n\tvec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));\n\tvec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));\n\tvec3 linear0 = mix(linearA, linearB, weight);\n\tvec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",reprojectPS:"\nvarying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\nuniform sampler2D samplesTex;\nuniform vec2 samplesTexInverseSize;\nuniform vec4 params;\nuniform vec2 params2;\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\nfloat targetTotalPixels() { return params2.x; }\nfloat sourceTotalPixels() { return params2.y; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec3 modifySeams(vec3 dir, float scale) {\n\tvec3 adir = abs(dir);\n\tfloat M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3(\n\t\tadir.x == M ? 1.0 : scale,\n\t\tadir.y == M ? 1.0 : scale,\n\t\tadir.z == M ? 1.0 : scale\n\t);\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nvec4 sampleEquirect(vec2 sph) {\n\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n#ifdef SUPPORTS_TEXLOD\n\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n#else\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n#endif\n}\nvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\treturn sampleEquirect(toSpherical(dir), mipLevel);\n}\nvec4 sampleCubemap(vec3 dir, float mipLevel) {\n#ifdef SUPPORTS_TEXLOD\n\treturn textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);\n#else\n\treturn textureCube(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()));\n#endif\n}\nvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\nvec4 sampleOctahedral(vec3 dir) {\n\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n}\nvec4 sampleOctahedral(vec2 sph) {\n\treturn sampleOctahedral(fromSpherical(sph));\n}\nvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n#ifdef SUPPORTS_TEXLOD\n\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n#else\n\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n#endif\n}\nvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\tvec3 x = normalize(cross(up, n));\n\tvec3 y = cross(n, x);\n\treturn mat3(x, y, n);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tconst float NUM_SAMPLES_SQRT = sqrt(float(NUM_SAMPLES));\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphv * (v / NUM_SAMPLES_SQRT - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\nvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\tvec4 raw;\n\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\tL.xyz = raw.xyz * 2.0 - 1.0;\n\tmipLevel = raw.w * 8.0;\n}\nvec4 prefilterSamples() {\n\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\tvec3 L;\n\tfloat mipLevel;\n\tvec3 result = vec3(0.0);\n\tfloat totalWeight = 0.0;\n\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\tunpackSample(i, L, mipLevel);\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;\n\t\ttotalWeight += L.z;\n\t}\n\treturn ENCODE_FUNC(result / totalWeight);\n}\nvec4 prefilterSamplesUnweighted() {\n\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\tvec3 L;\n\tfloat mipLevel;\n\tvec3 result = vec3(0.0);\n\tfloat totalWeight = 0.0;\n\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\tunpackSample(i, L, mipLevel);\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n",rgbmPS:"vec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform highp sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"const float maxCascades = 4.0;\nmat4 cascadeShadowMat;\nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tfloat cascadeIndex = 0.0;\n\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\tcascadeIndex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\t#ifdef GL2\n\t\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n\t#else\n\t\tif (cascadeIndex == 0.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[0];\n\t\t}\n\t\telse if (cascadeIndex == 1.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[1];\n\t\t}\n\t\telse if (cascadeIndex == 2.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[2];\n\t\t}\n\t\telse {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[3];\n\t\t}\n\t#endif\n}\nvoid fadeShadow(float shadowCascadeDistances[4]) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\tdShadowCoord.z = -9999999.0;\n\t}\n}\n",shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxEnvPS:"varying vec3 vViewDir;\nuniform sampler2D texture_envAtlas;\nuniform float mipLevel;\nvoid main(void) {\n\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(normalize(dir));\n\tvec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tvec3 dir=vViewDir;\n\tdir.x *= -1.0;\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxVS:"#define M_PI 3.1415926535897932384626433832795\nattribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\nvec3 rotateAroundYInDegrees(vec3 vertex,float degrees)\n{\n\tfloat alpha = degrees * M_PI / 180.0;\n\tfloat sina = sin(alpha);\n\tfloat cosa = cos(alpha);\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\n\treturn vec3( m * vertex.xz,vertex.y).xzy;\n}\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition * cubeMapRotationMatrix;\n}\n",specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\tnineSlicedUv = vUv0;\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"void getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"uniform float tbnBasis;\nvoid getTBN() {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat denom = max( dot(T,T), dot(B,B) );\n\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\tdTBN = mat3(T * invmax, -B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"void getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"vec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"};function nr(t,e){return e||(e=ir),t===Pe||t===Re?e.gamma2_2PS?e.gamma2_2PS:ir.gamma2_2PS:t===Ee?"#define HDR\n"+(e.gamma2_2PS?e.gamma2_2PS:ir.gamma2_2PS):e.gamma1_0PS?e.gamma1_0PS:ir.gamma1_0PS}function ar(t,e){return e||(e=ir),t===Ie?e.tonemappingFilmicPS?e.tonemappingFilmicPS:ir.tonemappingFilmicPS:t===Le?e.tonemappingLinearPS?e.tonemappingLinearPS:ir.tonemappingLinearPS:t===De?e.tonemappingHejlPS?e.tonemappingHejlPS:ir.tonemappingHejlPS:t===Fe?e.tonemappingAcesPS?e.tonemappingAcesPS:ir.tonemappingAcesPS:t===Oe?e.tonemappingAces2PS?e.tonemappingAces2PS:ir.tonemappingAces2PS:e.tonemapingNonePS?e.tonemapingNonePS:ir.tonemappingNonePS}function rr(t,e){return e||(e=ir),"linear"===t?e.fogLinearPS?e.fogLinearPS:ir.fogLinearPS:"exp"===t?e.fogExpPS?e.fogExpPS:ir.fogExpPS:"exp2"===t?e.fogExp2PS?e.fogExp2PS:ir.fogExp2PS:e.fogNonePS?e.fogNonePS:ir.fogNonePS}function or(t,e){return e||(e=ir),t.supportsBoneTextures?e.skinTexVS:"#define BONE_LIMIT "+t.getBoneLimit()+"\n"+e.skinConstVS}function hr(t){let e="precision "+t.precision+" float;\n";return t.webgl2&&(e+="#ifdef GL2\nprecision "+t.precision+" sampler2DShadow;\n#endif\n"),e}function lr(t){return t.webgl2?"#version 300 es\n":""}function cr(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function dr(){return"void main(void)\n{\n"}function ur(){return"}\n"}const pr={vertex_position:ln,vertex_normal:cn,vertex_tangent:dn,vertex_texCoord0:_n,vertex_texCoord1:gn,vertex_texCoord2:yn,vertex_texCoord3:vn,vertex_texCoord4:xn,vertex_texCoord5:bn,vertex_texCoord6:Sn,vertex_texCoord7:wn,vertex_color:mn,vertex_boneIndices:pn,vertex_boneWeights:un};function mr(t){const e={};let s=0,i=t.indexOf("attribute");for(;i>=0&&!(i>0&&"/"===t[i-1]);){const n=t.indexOf(";",i),a=t.lastIndexOf(" ",n),r=t.substr(a+1,n-(a+1)),o=pr[r];void 0!==o?e[r]=o:(e[r]="ATTR"+s,s++),i=t.indexOf("attribute",i+1)}return e}function fr(t,e,s,i,n,a){const r=t.programLib._cache,o=r[i];if(void 0!==o)return o;s=hr(t)+"\n"+(s||"void main(void) {gl_FragColor = vec4(0.0);}");const h=mr(e);return t.webgl2&&(e=lr(t)+ir.gles3VS+e,s=lr(t)+ir.gles3PS+s),r[i]=new sr(t,{attributes:h,vshader:e,fshader:(a||"")+s,useTransformFeedback:n}),r[i]}ir.collectAttribs=mr,ir.createShader=function(t,e,s,i){let n=ir[e],a=hr(t)+"\n"+ir[s];const r=mr(n);return t.webgl2&&(n=lr(t)+ir.gles3VS+n,a=lr(t)+ir.gles3PS+a),new sr(t,{attributes:r,vshader:n,fshader:a,useTransformFeedback:i})},ir.createShaderFromCode=fr;const _r={generateKey:function(t){let e="basic";return t.fog&&(e+="_fog"),t.alphaTest&&(e+="_atst"),t.vertexColors&&(e+="_vcol"),t.diffuseMap&&(e+="_diff"),t.skin&&(e+="_skin"),t.screenSpace&&(e+="_ss"),t.useInstancing&&(e+="_inst"),t.useMorphPosition&&(e+="_morphp"),t.useMorphNormal&&(e+="_morphn"),t.useMorphTextureBased&&(e+="_morpht"),e+="_"+t.pass,e},createShaderDefinition:function(t,e){const s={vertex_position:ln};e.skin&&(s.vertex_boneWeights=un,s.vertex_boneIndices=pn),e.vertexColors&&(s.vertex_color=mn),e.diffuseMap&&(s.vertex_texCoord0=_n);let i="";i+=ir.transformDeclVS,e.skin?(i+=or(t),i+=ir.transformSkinnedVS):i+=ir.transformVS,e.vertexColors&&(i+="attribute vec4 vertex_color;\n",i+="varying vec4 vColor;\n"),e.diffuseMap&&(i+="attribute vec2 vertex_texCoord0;\n",i+="varying vec2 vUv0;\n"),e.pass===cs&&(i+="varying float vDepth;\n",i+="#ifndef VIEWMATRIX\n",i+="#define VIEWMATRIX\n",i+="uniform mat4 matrix_view;\n",i+="#endif\n",i+="#ifndef CAMERAPLANES\n",i+="#define CAMERAPLANES\n",i+="uniform vec4 camera_params;\n\n",i+="#endif\n"),i+="void main(void)\n{\n",i+="\t gl_Position = getPosition();\n",e.pass===cs&&(i+="\t\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),e.vertexColors&&(i+="\t\tvColor = vertex_color;\n"),e.diffuseMap&&(i+="\t\tvUv0 = vertex_texCoord0;\n"),i+="}\n";const n=i;i=hr(t),e.vertexColors?i+="varying vec4 vColor;\n":i+="uniform vec4 uColor;\n",e.diffuseMap&&(i+="varying vec2 vUv0;\n",i+="uniform sampler2D texture_diffuseMap;\n"),e.fog&&(i+=rr(e.fog)),e.alphatest&&(i+=ir.alphaTestPS),e.pass===cs&&(i+="varying float vDepth;\n",i+=ir.packDepthPS),i+="void main(void)\n{\n",e.vertexColors?i+="\t\tgl_FragColor = vColor;\n":i+="\t\tgl_FragColor = uColor;\n",e.diffuseMap&&(i+="\t\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),e.alphatest&&(i+="\t alphaTest(gl_FragColor.a);\n"),e.pass!==us&&(e.pass===cs?i+="\t\tgl_FragColor = packFloat(vDepth);\n":e.fog&&(i+="\t glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),i+="}\n";return{attributes:s,vshader:n,fshader:i}}},gr={generateKey:function(t){let e="particle";for(const s in t)t.hasOwnProperty(s)&&(e+=t[s]);return e},_animTex:function(t){let e="";return e+=t.animTexLoop?ir.particleAnimFrameLoopVS:ir.particleAnimFrameClampVS,e+=ir.particleAnimTexVS,e},createShaderDefinition:function(t,e){let s="",i=hr(t)+"\n";i+="#define PARTICLE\n",t.webgl2&&(s+="#define GL2\n",i+="#define GL2\n"),s+="#define VERTEXSHADER\n",e.mesh&&(s+="#define USE_MESH\n"),e.localSpace&&(s+="#define LOCAL_SPACE\n"),e.screenSpace&&(s+="#define SCREEN_SPACE\n"),e.animTex&&(s+="\nuniform vec2 animTexTilesParams;\n"),e.animTex&&(s+="\nuniform vec4 animTexParams;\n"),e.animTex&&(s+="\nuniform vec2 animTexIndexParams;\n"),2===e.normal&&(s+="\nvarying mat3 ParticleMat;\n"),1===e.normal&&(s+="\nvarying vec3 Normal;\n"),e.soft&&(s+="\nvarying float vDepth;\n");const n=e.customFace?ir.particle_customFaceVS:ir.particle_billboardVS;e.useCpu?(e.soft>0&&(s+=ir.screenDepthPS),s+=ir.particle_cpuVS,e.localSpace&&(s+=ir.particle_localShiftVS),e.animTex&&(s+=this._animTex(e)),e.alignToMotion&&(s+=ir.particle_pointAlongVS),s+=e.mesh?ir.particle_meshVS:n,1===e.normal&&(s+=ir.particle_normalVS),2===e.normal&&(s+=ir.particle_TBNVS),e.stretch>0&&(s+=ir.particle_stretchVS),s+=ir.particle_cpu_endVS,e.soft>0&&(s+=ir.particle_softVS)):(s+=ir.particle_initVS,s+=e.pack8?ir.particleInputRgba8PS:ir.particleInputFloatPS,e.soft>0&&(s+=ir.screenDepthPS),s+=ir.particleVS,e.localSpace&&(s+=ir.particle_localShiftVS),e.animTex&&(s+=this._animTex(e)),e.wrap&&(s+=ir.particle_wrapVS),e.alignToMotion&&(s+=ir.particle_pointAlongVS),s+=e.mesh?ir.particle_meshVS:n,1===e.normal&&(s+=ir.particle_normalVS),2===e.normal&&(s+=ir.particle_TBNVS),e.stretch>0&&(s+=ir.particle_stretchVS),s+=ir.particle_endVS,e.soft>0&&(s+=ir.particle_softVS)),s+="}\n",e.normal>0&&(1===e.normal?i+="\nvarying vec3 Normal;\n":2===e.normal&&(i+="\nvarying mat3 ParticleMat;\n"),i+="\nuniform vec3 lightCube[6];\n"),e.soft&&(i+="\nvarying float vDepth;\n"),0===e.normal&&"none"===e.fog&&(e.srgb=!1),i+=nr(e.gamma),i+=ar(e.toneMap),"linear"===e.fog?i+=ir.fogLinearPS:"exp"===e.fog?i+=ir.fogExpPS:"exp2"===e.fog?i+=ir.fogExp2PS:i+=ir.fogNonePS,2===e.normal&&(i+="\nuniform sampler2D normalMap;\n"),e.soft>0&&(i+=ir.screenDepthPS),i+=ir.particlePS,e.soft>0&&(i+=ir.particle_softPS),1===e.normal&&(i+="\nvec3 normal = Normal;\n"),2===e.normal&&(i+=ir.particle_normalMapPS),e.normal>0&&(i+=e.halflambert?ir.particle_halflambertPS:ir.particle_lambertPS),e.normal>0&&(i+=ir.particle_lightingPS),e.blend===Ct?i+=ir.particle_blendNormalPS:e.blend===At?i+=ir.particle_blendAddPS:e.blend===Et&&(i+=ir.particle_blendMultiplyPS),i+=ir.particle_endPS;return{attributes:mr(s),vshader:s,fshader:i}}},yr={generateKey:function(t){return"cubemap"===t.type?`skybox-${t.type}-${t.rgbm}-${t.hdr}-${t.fixSeams}-${t.toneMapping}-${t.gamma}-${t.useIntensity}-${t.mip}`:`skybox-${t.type}-${t.encoding}-${t.useIntensity}-${t.gamma}-${t.toneMapping}`},createShaderDefinition:function(t,e){let s;if("cubemap"===e.type){const i=[128,64,16,8,4,2];s=hr(t),s+=e.mip?ir.fixCubemapSeamsStretchPS:ir.fixCubemapSeamsNonePS,s+=e.useIntensity?ir.envMultiplyPS:ir.envConstPS,s+=nr(e.gamma),s+=ar(e.toneMapping),s+=ir.decodePS,s+=ir.rgbmPS,s+=ir.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,e.rgbm?"textureCubeRGBM":e.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/i[e.mip]+"")}else{const i={rgbm:"decodeRGBM",rgbe:"decodeRGBE",linear:"decodeLinear"};s=hr(t),s+=e.useIntensity?ir.envMultiplyPS:ir.envConstPS,s+=nr(e.gamma),s+=ar(e.toneMapping),s+=ir.decodePS,s+=ir.skyboxEnvPS.replace(/\$DECODE/g,i[e.encoding]||"decodeGamma")}return{attributes:{aPosition:ln},vshader:ir.skyboxVS,fshader:s}}},vr=new Float32Array(1),xr=new Int32Array(vr.buffer);class br{static float2Half(t){vr[0]=t;const e=xr[0];let s=e>>16&32768,i=e>>12&2047;const n=e>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&e,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=1&i,s)}static float2Bytes(t,e,s,i){const n=255*t%1;if(e[s+0]=Math.round(255*(t%1-.00392156862745098*n)),i>1){const a=65025*t%1;if(e[s+1]=Math.round(255*(n-.00392156862745098*a)),i>2){const n=16581375*t%1;e[s+2]=Math.round(255*(a-.00392156862745098*n)),i>3&&(e[s+3]=Math.round(255*n))}}}static float2BytesRange(t,e,s,i,n,a){t=V.clamp((t-i)/(n-i),0,1),br.float2Bytes(t,e,s,a)}static float2MantisaExponent(t,e,s,i){const n=Math.floor(Math.log2(Math.abs(t)))+1;t/=Math.pow(2,n),br.float2BytesRange(t,e,s,-1,1,i-1),e[s+i-1]=Math.round(n+127)}}let Sr=null,wr=null;class Mr{constructor(t,e){this.device=t,this.name=null,this._width=4,this._height=4,this._depth=1,this._format=Li,this.type=Xn,this.projection=Zn,this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!1,this._premultiplyAlpha=!1,this._isRenderTarget=!1,this._mipmaps=!0,this._minFilter=_i,this._magFilter=ui,this._anisotropy=1,this._addressU=Ns,this._addressV=Ns,this._addressW=Ns,this._compareOnRead=!1,this._compareFunc=gi,void 0!==e&&(void 0!==e.name&&(this.name=e.name),this._width=void 0!==e.width?e.width:this._width,this._height=void 0!==e.height?e.height:this._height,this._format=void 0!==e.format?e.format:this._format,e.hasOwnProperty("type")?this.type=e.type:e.hasOwnProperty("rgbm")?this.type=e.rgbm?Yn:Xn:e.hasOwnProperty("swizzleGGGR")&&(this.type=e.swizzleGGGR?$n:Xn),void 0!==e.mipmaps?this._mipmaps=e.mipmaps:this._mipmaps=void 0!==e.autoMipmap?e.autoMipmap:this._mipmaps,this._levels=e.levels,this._cubemap=void 0!==e.cubemap?e.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==e.fixCubemapSeams?e.fixCubemapSeams:this.fixCubemapSeams,this._cubemap?this.projection=Jn:e.projection&&e.projection!==Jn&&(this.projection=e.projection),this._minFilter=void 0!==e.minFilter?e.minFilter:this._minFilter,this._magFilter=void 0!==e.magFilter?e.magFilter:this._magFilter,this._anisotropy=void 0!==e.anisotropy?e.anisotropy:this._anisotropy,this._addressU=void 0!==e.addressU?e.addressU:this._addressU,this._addressV=void 0!==e.addressV?e.addressV:this._addressV,this._compareOnRead=void 0!==e.compareOnRead?e.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==e._compareFunc?e._compareFunc:this._compareFunc,this._flipY=void 0!==e.flipY?e.flipY:this._flipY,this._premultiplyAlpha=void 0!==e.premultiplyAlpha?e.premultiplyAlpha:this._premultiplyAlpha,t.webgl2&&(this._depth=void 0!==e.depth?e.depth:this._depth,this._volume=void 0!==e.volume?e.volume:this._volume,this._addressW=void 0!==e.addressW?e.addressW:this._addressW)),this._compressed=this._format===Ii||this._format===Di||this._format===Fi||this._format>=ji,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0}get minFilter(){return this._minFilter}set minFilter(t){this._minFilter!==t&&(this._minFilter=t,this._parameterFlags|=1)}get magFilter(){return this._magFilter}set magFilter(t){this._magFilter!==t&&(this._magFilter=t,this._parameterFlags|=2)}get addressU(){return this._addressU}set addressU(t){this._addressU!==t&&(this._addressU=t,this._parameterFlags|=4)}get addressV(){return this._addressV}set addressV(t){this._addressV!==t&&(this._addressV=t,this._parameterFlags|=8)}get addressW(){return this._addressW}set addressW(t){this.device.webgl2&&this._volume&&t!==this._addressW&&(this._addressW=t,this._parameterFlags|=16)}get compareOnRead(){return this._compareOnRead}set compareOnRead(t){this._compareOnRead!==t&&(this._compareOnRead=t,this._parameterFlags|=32)}get compareFunc(){return this._compareFunc}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this._parameterFlags|=64)}get anisotropy(){return this._anisotropy}set anisotropy(t){this._anisotropy!==t&&(this._anisotropy=t,this._parameterFlags|=128)}get autoMipmap(){return this._mipmaps}set autoMipmap(t){this._mipmaps=t}get mipmaps(){return this._mipmaps}set mipmaps(t){this._mipmaps!==t&&(this._mipmaps=t,t&&(this._needsMipmapsUpload=!0))}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const t=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return Mr.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}get volume(){return this._volume}get flipY(){return this._flipY}set flipY(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}set premultiplyAlpha(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}get pot(){return V.powerOfTwo(this._width)&&V.powerOfTwo(this._height)}static calcGpuSize(t,e,s,i,n,a){Sr||(Sr=[],Sr[Mi]=1,Sr[Ti]=1,Sr[Ai]=2,Sr[Ci]=2,Sr[Pi]=2,Sr[Ri]=2,Sr[Ei]=4,Sr[Li]=4,Sr[Oi]=8,Sr[ki]=8,Sr[Bi]=16,Sr[zi]=16,Sr[Ui]=4,Sr[Vi]=4,Sr[Ni]=4,Sr[Wi]=4,Sr[Gi]=4,Sr[Hi]=4),wr||(wr=[],wr[ji]=8,wr[qi]=8,wr[Yi]=8,wr[Ki]=8,wr[$i]=8,wr[Zi]=8,wr[Ii]=8,wr[Qi]=8,wr[Xi]=16,wr[Di]=16,wr[Fi]=16,wr[Ji]=16,wr[tn]=16);const r=Sr.hasOwnProperty(i)?Sr[i]:0,o=wr.hasOwnProperty(i)?wr[i]:0;let h=0;for(;;){if(r>0)h+=t*e*s*r;else{let n=Math.floor((t+3)/4);const a=Math.floor((e+3)/4),r=Math.floor((s+3)/4);i!==Yi&&i!==Ki||(n=Math.max(Math.floor(n/2),1)),h+=n*a*r*o}if(!n||1===t&&1===e&&1===s)break;t=Math.max(Math.floor(t/2),1),e=Math.max(Math.floor(e/2),1),s=Math.max(Math.floor(s/2),1)}return h*(a?6:1)}destroy(){this.device&&this.device.destroyTexture(this),this.device=null,this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255}lock(t={}){if(void 0===t.level&&(t.level=0),void 0===t.face&&(t.face=0),void 0===t.mode&&(t.mode=qn),this._lockedLevel=t.level,null===this._levels[t.level])switch(this._format){case Mi:case Ti:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case Ai:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case Ci:case Pi:case Ri:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case Ei:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case Li:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case Ii:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case Di:case Fi:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case Oi:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case Bi:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case ki:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case zi:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[t.level]}setSource(t,e=0){let s,i,n=!1;if(this._cubemap){if(t[0]){s=t[0].width||0,i=t[0].height||0;for(let e=0;e<6;e++){const a=t[e];if(!a||a.width!==s||a.height!==i||!this.device._isBrowserInterface(a)){n=!0;break}}}else n=!0;if(!n)for(let s=0;s<6;s++)this._levels[e][s]!==t[s]&&(this._levelsUpdated[e][s]=!0)}else this.device._isBrowserInterface(t)||(n=!0),n||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),s=t.width,i=t.height);if(n)if(this._width=4,this._height=4,this._cubemap)for(let t=0;t<6;t++)this._levels[e][t]=null,this._levelsUpdated[e][t]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else 0===e&&(this._width=s,this._height=i),this._levels[e]=t;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(t=0){return this._levels[t]}unlock(){this._lockedLevel,this.upload(),this._lockedLevel=-1}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps}getDds(){let t=128,e=0;for(;this._levels[e];){if(this.cubemap)for(let s=0;s<6;s++){if(!this._levels[e][s])return;const i=this._levels[e][s].length;if(!i)return;t+=i}else{const s=this._levels[e].length;if(!s)return;t+=s}t+=this._levels[e].length,e++}const s=new ArrayBuffer(t),i=new Uint32Array(s,0,32);let n=528391;this._levels.length>1&&(n|=131072);let a=4096;this._levels.length>1&&(a|=4194304),(this._levels.length>1||this.cubemap)&&(a|=8);const r=this.cubemap?65024:0;i[0]=542327876,i[1]=124,i[2]=n,i[3]=this.height,i[4]=this.width,i[5]=this.width*this.height*4,i[6]=0,i[7]=this._levels.length;for(let t=0;t<11;t++)i[8+t]=0;i[19]=32,i[20]=65,i[21]=0,i[22]=32,i[23]=16711680,i[24]=65280,i[25]=255,i[26]=4278190080,i[27]=a,i[28]=r,i[29]=0,i[30]=0,i[31]=0;let o=128;if(this.cubemap)for(let t=0;t<6;t++)for(let e=0;e<this._levels.length;e++){const i=this._levels[e][t],n=new Uint8Array(s,o,i.length);for(let t=0;t<i.length;t++)n[t]=i[t];o+=i.length}else for(let t=0;t<this._levels.length;t++){const e=this._levels[t],i=new Uint8Array(s,o,e.length);for(let t=0;t<e.length;t++)i[t]=e[t];o+=e.length}return s}get encoding(){return this.type===Yn?"rgbm":this.type===Kn?"rgbe":this.format===ki||this.format===zi?"linear":"srgb"}}const Tr=new it,Ar=new it,Cr=new it,Pr=new dt;class Rr{constructor(){this._aspectRatio=16/9,this._aspectRatioMode=Es,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new J(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[Wt,Gt,Ht,qt,jt],this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=ge,this._rect=new nt(0,0,1,1),this._renderTarget=null,this._scissorRect=new nt(0,0,1,1),this._scissorRectClear=!1,this._vrDisplay=null,this._projMat=new dt,this._projMatDirty=!0,this._projMatSkybox=new dt,this._viewMat=new dt,this._viewMatDirty=!0,this._viewProjMat=new dt,this._viewProjMatDirty=!0,this.frustum=new Os}get aspectRatio(){return this._aspectRatio}set aspectRatio(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set aspectRatioMode(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}get calculateProjection(){return this._calculateProjection}set calculateProjection(t){this._calculateProjection=t,this._projMatDirty=!0}get calculateTransform(){return this._calculateTransform}set calculateTransform(t){this._calculateTransform=t}get clearColor(){return this._clearColor}set clearColor(t){this._clearColor.copy(t)}get clearColorBuffer(){return this._clearColorBuffer}set clearColorBuffer(t){this._clearColorBuffer=t}get clearDepth(){return this._clearDepth}set clearDepth(t){this._clearDepth=t}get clearDepthBuffer(){return this._clearDepthBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t}get clearStencil(){return this._clearStencil}set clearStencil(t){this._clearStencil=t}get clearStencilBuffer(){return this._clearStencilBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t}get cullingMask(){return this._cullingMask}set cullingMask(t){this._cullingMask=t}get cullFaces(){return this._cullFaces}set cullFaces(t){this._cullFaces=t}get farClip(){return this._farClip}set farClip(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}get flipFaces(){return this._flipFaces}set flipFaces(t){this._flipFaces=t}get fov(){return this._fov}set fov(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}get frustumCulling(){return this._frustumCulling}set frustumCulling(t){this._frustumCulling=t}get horizontalFov(){return this._horizontalFov}set horizontalFov(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}get layers(){return this._layers}set layers(t){this._layers=t.slice(0)}get nearClip(){return this._nearClip}set nearClip(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}get node(){return this._node}set node(t){this._node=t}get orthoHeight(){return this._orthoHeight}set orthoHeight(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}get projection(){return this._projection}set projection(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}get rect(){return this._rect}set rect(t){this._rect.copy(t)}get renderTarget(){return this._renderTarget}set renderTarget(t){this._renderTarget=t}get scissorRect(){return this._scissorRect}set scissorRect(t){this._scissorRect.copy(t)}get viewMatrix(){if(this._viewMatDirty){const t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}get vrDisplay(){return this._vrDisplay}set vrDisplay(t){this._vrDisplay=t,t&&(t._camera=this)}clone(){return(new Rr).copy(this)}copy(t){return this.aspectRatio=t.aspectRatio,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.cullingMask=t.cullingMask,this.farClip=t.farClip,this.flipFaces=t.flipFaces,this.fov=t.fov,this.frustumCulling=t.frustumCulling,this.horizontalFov=t.horizontalFov,this.layers=t.layers,this.nearClip=t.nearClip,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.vrDisplay=t.vrDisplay,this}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(t,e,s,i=new it){this._updateViewProjMat(),this._viewProjMat.transformPoint(t,i);const n=this._viewProjMat.data,a=t.x*n[3]+t.y*n[7]+t.z*n[11]+1*n[15];return i.x=.5*(i.x/a+1)*e,i.y=.5*(1-i.y/a)*s,i}screenToWorld(t,e,s,i,n,a=new it){const r=this._farClip-this._nearClip;if(Tr.set(t/i,(n-e)/n,s/r),Tr.mulScalar(2),Tr.sub(it.ONE),this._projection===ge){dt._getPerspectiveHalfSize(Ar,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov),Ar.x*=Tr.x,Ar.y*=Tr.y;const t=this._node.getWorldTransform();Ar.z=-this._nearClip,t.transformPoint(Ar,Cr);const e=this._node.getPosition();a.sub2(Cr,e),a.normalize(),a.mulScalar(s),a.add(e)}else this._updateViewProjMat(),Pr.copy(this._viewProjMat).invert(),Pr.transformPoint(Tr,a);return a}_evaluateProjectionMatrix(){if(this._projMatDirty){if(this._projection===ge)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{const t=this._orthoHeight,e=t*this._aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}}const Er=new dt,Lr=new it,Ir=new ft,Dr=new ft,Fr=new it,Or=new it,kr=new dt,Br=new ft,zr=new it,Ur=new dt,Vr=new ft,Nr=new ft,Wr=new dt,Gr=new it,Hr=new it;class jr extends u{constructor(t){super(),this.name="string"==typeof t?t:"Untitled",this.tags=new O(this),this._labels={},this.localPosition=new it(0,0,0),this.localRotation=new ft(0,0,0,1),this.localScale=new it(1,1,1),this.localEulerAngles=new it(0,0,0),this.position=new it(0,0,0),this.rotation=new ft(0,0,0,1),this.eulerAngles=new it(0,0,0),this._scale=null,this.localTransform=new dt,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new dt,this._dirtyWorld=!1,this.normalMatrix=new at,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1}get right(){return this._right||(this._right=new it),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new it),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new it),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get enabled(){return this._enabled&&this._enabledInHierarchy}set enabled(t){if(this._enabled!==t){let e=this._enabled;this._enabled=t,this.fire("set_enabled","enabled",e,t),this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,t)}}get enabledInHierarchy(){return this._enabledInHierarchy}set enabledInHierarchy(t){let e=this._enabledInHierarchy;this._enabledInHierarchy=t,this.fire("set_enabledInHierarchy","enabledInHierarchy",e,t)}get parent(){return this._parent}get path(){let t=this._parent;if(!t)return"";let e=this.name;for(;t&&t._parent;)e=`${t.name}/${e}`,t=t._parent;return e}get root(){let t=this;for(;t._parent;)t=t._parent;return t}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(t,e){t._onHierarchyStateChanged(e);const s=t._children;for(let t=0,i=s.length;t<i;t++)s[t]._enabled&&this._notifyHierarchyStateChanged(s[t],e)}_onHierarchyStateChanged(t){this.enabledInHierarchy=t,t&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(t){t.name=this.name;const e=this.tags._list;t.tags.clear();for(let s=0;s<e.length;s++)t.tags.add(e[s]);t._labels=Object.assign({},this._labels),t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t.enabledInHierarchy=!1}clone(){const t=new jr;return this._cloneInternal(t),t}copy(t){return t._cloneInternal(this),this}find(t,e){let s,i=[];const n=this._children.length;if(t instanceof Function){const e=t;s=e(this),s&&i.push(this);for(let t=0;t<n;t++){const s=this._children[t].find(e);s.length&&(i=i.concat(s))}}else{let s;this[t]&&(s=this[t]instanceof Function?this[t]():this[t],s===e&&i.push(this));for(let s=0;s<n;++s){const n=this._children[s].find(t,e);n.length&&(i=i.concat(n))}}return i}findOne(t,e){const s=this._children.length;let i=null;if(t instanceof Function){const e=t;if(i=e(this),i)return this;for(let t=0;t<s;t++)if(i=this._children[t].findOne(e),i)return i}else{let n;if(this[t]&&(n=this[t]instanceof Function?this[t]():this[t],n===e))return this;for(let n=0;n<s;n++)if(i=this._children[n].findOne(t,e),null!==i)return i}return null}findByTag(){const t=this.tags._processArguments(arguments);return this._findByTag(t)}_findByTag(t){let e=[];const s=this._children.length;for(let i=0;i<s;i++){this._children[i].tags._has(t)&&e.push(this._children[i]);const s=this._children[i]._findByTag(t);s.length&&(e=e.concat(s))}return e}findByName(t){if(this.name===t)return this;for(let e=0;e<this._children.length;e++){const s=this._children[e].findByName(t);if(null!==s)return s}return null}findByPath(t){const e=Array.isArray(t)?t:t.split("/");let s=this;for(let t=0,i=e.length;t<i;++t)if(s=s.children.find((s=>s.name===e[t])),!s)return null;return s}forEach(t,e){t.call(e,this);const s=this._children;for(let i=0;i<s.length;i++)s[i].forEach(t,e)}isDescendantOf(t){let e=this._parent;for(;e;){if(e===t)return!0;e=e._parent}return!1}isAncestorOf(t){return t.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new it),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}reparent(t,e){const s=this._parent;s&&s.removeChild(this),t&&(e>=0?t.insertChild(this,e):t.addChild(this))}setLocalEulerAngles(t,e,s){t instanceof it?this.localRotation.setFromEulerAngles(t.x,t.y,t.z):this.localRotation.setFromEulerAngles(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(t,e,s){t instanceof it?this.localPosition.copy(t):this.localPosition.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(t,e,s,i){t instanceof ft?this.localRotation.copy(t):this.localRotation.set(t,e,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(t,e,s){t instanceof it?this.localScale.copy(t):this.localScale.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let t=this._parent;for(;t;)t._frozen=!1,t=t._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++}setPosition(t,e,s){t instanceof it?zr.copy(t):zr.set(t,e,s),null===this._parent?this.localPosition.copy(zr):(Ur.copy(this._parent.getWorldTransform()).invert(),Ur.transformPoint(zr,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(t,e,s,i){if(t instanceof ft?Vr.copy(t):Vr.set(t,e,s,i),null===this._parent)this.localRotation.copy(Vr);else{const t=this._parent.getRotation();Nr.copy(t).invert(),this.localRotation.copy(Nr).mul(Vr)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(t,e,s){if(t instanceof it?this.localRotation.setFromEulerAngles(t.x,t.y,t.z):this.localRotation.setFromEulerAngles(t,e,s),null!==this._parent){const t=this._parent.getRotation();Nr.copy(t).invert(),this.localRotation.mul2(Nr,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(t){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.push(t),this._onInsertChild(t)}addChildAndSaveTransform(t){const e=t.getPosition(),s=t.getRotation(),i=t._parent;i&&i.removeChild(t),t.setPosition(kr.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(Br.copy(this.getRotation()).invert().mul(s)),this._children.push(t),this._onInsertChild(t)}insertChild(t,e){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.splice(e,0,t),this._onInsertChild(t)}_fireOnHierarchy(t,e,s){this.fire(t,s);for(let t=0;t<this._children.length;t++)this._children[t]._fireOnHierarchy(e,e,s)}_onInsertChild(t){t._parent=this;const e=t._enabled&&this.enabled;t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",t)}_updateGraphDepth(){this._parent?this._graphDepth=this._parent._graphDepth+1:this._graphDepth=0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()}removeChild(t){const e=this._children.length;for(let s=0;s<e;++s)if(this._children[s]===t)return this._children.splice(s,1),t._parent=null,t._fireOnHierarchy("remove","removehierarchy",this),void(this.fire&&this.fire("childremove",t))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let t;const e=this._parent;let s=this.localScale,i=e;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(t=i.worldTransform.getScale(),Fr.mul2(t,this.localScale),s=Fr))}Dr.setFromMat4(e.worldTransform),Ir.mul2(Dr,this.localRotation);let n=e.worldTransform;e.scaleCompensation&&(Or.mul2(t,e.getLocalScale()),Er.setTRS(e.worldTransform.getTranslation(Lr),Dr,Or),n=Er),n.transformPoint(this.localPosition,Lr),this.worldTransform.setTRS(Lr,Ir,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const t=this._children;for(let e=0,s=t.length;e<s;e++)t[e].syncHierarchy()}lookAt(t,e,s,i=0,n=1,a=0){if(t instanceof it)Gr.copy(t),e instanceof it?Hr.copy(e):Hr.copy(it.UP);else{if(void 0===s)return;Gr.set(t,e,s),Hr.set(i,n,a)}Wr.setLookAt(this.getPosition(),Gr,Hr),Vr.setFromMat4(Wr),this.setRotation(Vr)}translate(t,e,s){t instanceof it?zr.copy(t):zr.set(t,e,s),zr.add(this.getPosition()),this.setPosition(zr)}translateLocal(t,e,s){t instanceof it?zr.copy(t):zr.set(t,e,s),this.localRotation.transformVector(zr,zr),this.localPosition.add(zr),this._dirtyLocal||this._dirtifyLocal()}rotate(t,e,s){if(t instanceof it?Vr.setFromEulerAngles(t.x,t.y,t.z):Vr.setFromEulerAngles(t,e,s),null===this._parent)this.localRotation.mul2(Vr,this.localRotation);else{const t=this.getRotation(),e=this._parent.getRotation();Nr.copy(e).invert(),Vr.mul2(Nr,Vr),this.localRotation.mul2(Vr,t)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(t,e,s){t instanceof it?Vr.setFromEulerAngles(t.x,t.y,t.z):Vr.setFromEulerAngles(t,e,s),this.localRotation.mul(Vr),this._dirtyLocal||this._dirtifyLocal()}}const qr=new dt,Xr=new dt,Yr=new dt;class Kr{static create(t,e,s){const i=new Rr;switch(i.node=new jr(t),i.aspectRatio=1,i.aspectRatioMode=Ls,i._scissorRectClear=!0,e){case Yt:i.node.setRotation(Kr.pointLightRotations[s]),i.fov=90,i.projection=ge;break;case Kt:i.projection=ge;break;case Xt:i.projection=ye}return i}static evalSpotCookieMatrix(t){let e=Kr._spotCookieCamera;e||(e=Kr.create("SpotCookieCamera",Kt),Kr._spotCookieCamera=e),e.fov=2*t._outerConeAngle;const s=e._node;s.setPosition(t._node.getPosition()),s.setRotation(t._node.getRotation()),s.rotateLocal(-90,0,0),qr.setTRS(s.getPosition(),s.getRotation(),it.ONE).invert(),Xr.mul2(e.projectionMatrix,qr);const i=t.cookieMatrix,n=t.atlasViewport;return Yr.setViewport(n.x,n.y,n.z,n.w),i.mul2(Yr,Xr),i}}Kr.pointLightRotations=[(new ft).setFromEulerAngles(0,90,180),(new ft).setFromEulerAngles(0,-90,180),(new ft).setFromEulerAngles(90,0,0),(new ft).setFromEulerAngles(-90,0,0),(new ft).setFromEulerAngles(0,180,180),(new ft).setFromEulerAngles(0,0,180)],Kr._spotCookieCamera=null;const $r=new it,Zr=new Float32Array(6),Jr=new it(-.5,0,0),Qr=new it(0,0,.5),to={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},eo={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8};class so{static initShaderDefines(){const t=so.lightTextureFormat===so.FORMAT_FLOAT?"FLOAT":"8BIT";so.shaderDefines=`\n\t\t\t\t\t\t\n#define CLUSTER_TEXTURE_${t}\n\t\t\t\t\t\t${so.buildShaderDefines(to,"CLUSTER_TEXTURE_8_")}\n\t\t\t\t\t\t${so.buildShaderDefines(eo,"CLUSTER_TEXTURE_F_")}\n\t\t\t\t`}static buildShaderDefines(t,e){let s="";return Object.keys(t).forEach((i=>{s+=`\n#define ${e}${i} ${t[i]}.5`})),s}static init(t){so.lightTextureFormat=t.extTextureFloat&&t.maxTextures>8?so.FORMAT_FLOAT:so.FORMAT_8BIT,so.initShaderDefines()}static createTexture(t,e,s,i){return new Mr(t,{width:e,height:s,mipmaps:!1,format:i,addressU:Ws,addressV:Ws,type:Xn,magFilter:di,minFilter:di,anisotropy:1})}constructor(t){this.device=t,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let e=to.COUNT_ALWAYS,s=0;so.lightTextureFormat===so.FORMAT_FLOAT?s=eo.COUNT:e=to.COUNT,this.lights8=new Uint8ClampedArray(4*e*this.maxLights),this.lightsTexture8=so.createTexture(this.device,e,this.maxLights,Li),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=so.createTexture(this.device,s,this.maxLights,zi),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new it,this.boundsDelta=new it}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}setCompressionRanges(t,e){this.invMaxColorValue=1/e,this.invMaxAttenuation=1/t}setBounds(t,e){this.boundsMin.copy(t),this.boundsDelta.copy(e)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),so.lightTextureFormat===so.FORMAT_FLOAT&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(t,e){e._node.getWorldTransform().getY(t).mulScalar(-1),t.normalize()}getLightAreaSizes(t){const e=t._node.getWorldTransform();return e.transformVector(Jr,$r),Zr[0]=$r.x,Zr[1]=$r.y,Zr[2]=$r.z,e.transformVector(Qr,$r),Zr[3]=$r.x,Zr[4]=$r.y,Zr[5]=$r.z,Zr}addLightDataFlags(t,e,s,i){t[e+0]=i?255:0,t[e+1]=64*s._shape,t[e+2]=255*s._falloffMode,t[e+3]=s.castShadows?255:0}addLightDataColor(t,e,s,i,n){const a=this.invMaxColorValue,r=i?s._linearFinalColor:s._finalColor;br.float2Bytes(r[0]*a,t,e+0,2),br.float2Bytes(r[1]*a,t,e+2,2),br.float2Bytes(r[2]*a,t,e+4,2),t[e+6]=n?255:0}addLightDataSpotAngles(t,e,s){br.float2Bytes(.499999*s._innerConeAngleCos+.5,t,e+0,2),br.float2Bytes(.499999*s._outerConeAngleCos+.5,t,e+2,2)}addLightDataShadowBias(t,e,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);br.float2BytesRange(n.bias,t,e,-1,20,2),br.float2Bytes(n.normalBias,t,e+2,2)}addLightDataPositionRange(t,e,s,i){const n=$r.sub2(i,this.boundsMin).div(this.boundsDelta);br.float2Bytes(n.x,t,e+0,4),br.float2Bytes(n.y,t,e+4,4),br.float2Bytes(n.z,t,e+8,4),br.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,t,e+12,4)}addLightDataSpotDirection(t,e,s){this.getSpotDirection($r,s),br.float2Bytes(.499999*$r.x+.5,t,e+0,4),br.float2Bytes(.499999*$r.y+.5,t,e+4,4),br.float2Bytes(.499999*$r.z+.5,t,e+8,4)}addLightDataLightProjMatrix(t,e,s){const i=s.data;for(let s=0;s<12;s++)br.float2BytesRange(i[s],t,e+4*s,-2,2,4);for(let s=12;s<16;s++)br.float2MantisaExponent(i[s],t,e+4*s,4)}addLightDataCookies(t,e,s){const i="rgb"===s._cookieChannel;if(t[e+0]=Math.floor(255*s.cookieIntensity),t[e+1]=i?255:0,!i){const i=s._cookieChannel;t[e+4]="rrr"===i?255:0,t[e+5]="ggg"===i?255:0,t[e+6]="bbb"===i?255:0,t[e+7]="aaa"===i?255:0}}addLightAtlasViewport(t,e,s){br.float2Bytes(s.x,t,e+0,2),br.float2Bytes(s.y,t,e+2,2),br.float2Bytes(s.z/3,t,e+4,2)}addLightAreaSizes(t,e,s){const i=this.getLightAreaSizes(s);for(let s=0;s<6;s++)br.float2MantisaExponent(i[s],t,e+4*s,4)}addLightData(t,e,s){const i=t._type===Kt,n=this.cookiesEnabled&&!!t._cookie,a=this.areaLightsEnabled&&t.shape!==$t,r=this.shadowsEnabled&&t.castShadows,o=t._node.getPosition();let h=null,l=null;if(i)if(r){h=t.getRenderData(null,0).shadowMatrix}else n&&(h=Kr.evalSpotCookieMatrix(t));else(r||n)&&(l=t.atlasViewport);const c=this.lights8,d=e*this.lightsTexture8.width*4;if(this.addLightDataFlags(c,d+4*to.FLAGS,t,i),this.addLightDataColor(c,d+4*to.COLOR_A,t,s,n),i&&this.addLightDataSpotAngles(c,d+4*to.SPOT_ANGLES,t),t.castShadows&&this.addLightDataShadowBias(c,d+4*to.SHADOW_BIAS,t),n&&this.addLightDataCookies(c,d+4*to.COOKIE_A,t),so.lightTextureFormat===so.FORMAT_FLOAT){const s=this.lightsFloat,n=e*this.lightsTextureFloat.width*4;if(s[n+4*eo.POSITION_RANGE+0]=o.x,s[n+4*eo.POSITION_RANGE+1]=o.y,s[n+4*eo.POSITION_RANGE+2]=o.z,s[n+4*eo.POSITION_RANGE+3]=t.attenuationEnd,i&&(this.getSpotDirection($r,t),s[n+4*eo.SPOT_DIRECTION+0]=$r.x,s[n+4*eo.SPOT_DIRECTION+1]=$r.y,s[n+4*eo.SPOT_DIRECTION+2]=$r.z),h){const t=h.data;for(let e=0;e<16;e++)s[n+4*eo.PROJ_MAT_0+e]=t[e]}if(l&&(s[n+4*eo.ATLAS_VIEWPORT+0]=l.x,s[n+4*eo.ATLAS_VIEWPORT+1]=l.y,s[n+4*eo.ATLAS_VIEWPORT+2]=l.z/3),a){const e=this.getLightAreaSizes(t);s[n+4*eo.AREA_DATA_WIDTH+0]=e[0],s[n+4*eo.AREA_DATA_WIDTH+1]=e[1],s[n+4*eo.AREA_DATA_WIDTH+2]=e[2],s[n+4*eo.AREA_DATA_HEIGHT+0]=e[3],s[n+4*eo.AREA_DATA_HEIGHT+1]=e[4],s[n+4*eo.AREA_DATA_HEIGHT+2]=e[5]}}else this.addLightDataPositionRange(c,d+4*to.POSITION_X,t,o),i&&this.addLightDataSpotDirection(c,d+4*to.SPOT_DIRECTION_X,t),h&&this.addLightDataLightProjMatrix(c,d+4*to.PROJ_MAT_00,h),l&&this.addLightAtlasViewport(c,d+4*to.ATLAS_VIEWPORT_A,l),a&&this.addLightAreaSizes(c,d+4*to.AREA_DATA_WIDTH_X,t)}}so.FORMAT_FLOAT=0,so.FORMAT_8BIT=1,so.lightTextureFormat=so.FORMAT_8BIT,so.shaderDefines="";const io=[],no={rgbm:"decodeRGBM",rgbe:"decodeRGBE",linear:"decodeLinear"},ao={optionsContext:{},optionsContextMin:{},generateKey:function(t){const e=function(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&"chunks"!==s&&"lights"!==s&&e.push(s);return e.sort()};let s;t===this.optionsContextMin?(this.propsMin||(this.propsMin=e(t)),s=this.propsMin):t===this.optionsContext?(this.props||(this.props=e(t)),s=this.props):s=e(t);let i="standard";for(let e=0;e<s.length;e++)t[s[e]]&&(i+=s[e]+t[s[e]]);if(t.chunks){const e=[];for(const s in t.chunks)t.chunks.hasOwnProperty(s)&&e.push(s+t.chunks[s]);e.sort(),i+=e}if(t.lights)for(let e=0;e<t.lights.length;e++)i+=t.lights[e].key;return Za(i)},_correctChannel:function(t,e){if(io[t]>0){if(io[t]<e.length)return e.substring(0,io[t]);if(io[t]>e.length){let s=e;const i=s.charAt(s.length-1),n=io[t]-s.length;for(let t=0;t<n;t++)s+=i;return s}return e}},_setMapTransform:function(t,e,s,i){const n=`texture_${e}MapTransform`,a=s+100*i;return t[0]+=`uniform vec3 ${n}0;\n`,t[0]+=`uniform vec3 ${n}1;\n`,t[3][a]||(t[1]+=`varying vec2 vUV${i}_${s};\n`,t[2]+=`\t vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${n}0), dot(vec3(uv${i}, 1), ${n}1));\n`,t[3][a]=!0),t},_getUvSourceExpression:function(t,e,s){const i=s[t],n=s[e],a=s.pass===hs||s.pass===ls;let r;return a&&s.nineSlicedMode===ms?r="nineSlicedUv":a&&s.nineSlicedMode===fs?r="nineSlicedUv, -1000.0":(r=0===i?"vUv"+n:"vUV"+n+"_"+i,s.heightMap&&"heightMapTransform"!==t&&(r+=" + dUvOffset")),r},_addMapDef:function(t,e){let s="\n#undef "+t+"\n";return e&&(s+=" #define "+t+"\n"),s},_addMapDefs:function(t,e,s,i){let n="";return n+=this._addMapDef("MAPFLOAT",t),n+=this._addMapDef("MAPCOLOR",e),n+=this._addMapDef("MAPVERTEX",s),n+=this._addMapDef("MAPTEXTURE",i),n},_addMap:function(t,e,s,i,n){const a=t+"Map",r=a+"Uv",o=a+"Transform",h=a+"Channel",l=t+"VertexColorChannel",c=t+"VertexColor",d=t+"Mode",u=s[t+"Tint"],p=s[c],m=s[a],f=s[d];let _=i[e];if(m){const t=this._getUvSourceExpression(o,r,s);if(_=_.replace(/\$UV/g,t).replace(/\$CH/g,s[h]),void 0!==n){const t=0===n?"texture2DSRGB":1===n?"texture2DRGBM":"texture2D";_=_.replace(/\$texture2DSAMPLE/g,t)}}p&&(_=_.replace(/\$VC/g,s[l])),f&&(_=_.replace(/\$DETAILMODE/g,f));const g=!!(1&u),y=!!(2&u);return _=this._addMapDefs(g,y,p,m)+_,_.replace(/\$/g,"")},_directionalShadowMapProjection:function(t,e,s,i,n){let a="";return t.numCascades>1&&(a+=`getShadowCascadeMatrix(light${i}_shadowMatrixPalette, light${i}_shadowCascadeDistances, light${i}_shadowCascadeCount);\n`,e=`(cascadeShadowMat, ${s});\n`),a+=n+e,a+=`fadeShadow(light${i}_shadowCascadeDistances);\n`,a},_nonPointShadowMapProjection:function(t,e,s,i,n){const a=`(${s}, ${i});\n`;return!e._normalOffsetBias||e._isVsm?e._type===Kt?e._isPcf&&(t.webgl2||t.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbuffer"+a:"\t\t\t getShadowCoordPersp"+a:this._directionalShadowMapProjection(e,a,i,n,"getShadowCoordOrtho"):e._type===Kt?e._isPcf&&(t.webgl2||t.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbufferNormalOffset"+a:"\t\t\t getShadowCoordPerspNormalOffset"+a:this._directionalShadowMapProjection(e,a,i,n,"getShadowCoordOrthoNormalOffset")},_addVaryingIfNeeded:function(t,e,s){return t.indexOf(s)>=0?"varying "+e+" "+s+";\n":""},_getLightSourceShapeString:function(t){switch(t){case Zt:return"Rect";case Jt:return"Disk";case Qt:return"Sphere";default:return""}},_getPassDefineString:function(t){return t===us?"#define PICK_PASS\n":t===cs?"#define DEPTH_PASS\n":t>=ds&&t<=17?"#define SHADOW_PASS\n":""},_vsAddTransformCode:function(t,e,s,i){return t+=s.transformVS},_vsAddBaseCode:function(t,e,s,i){return t+=s.baseVS,i.nineSlicedMode!==ms&&i.nineSlicedMode!==fs||(t+=s.baseNineSlicedVS),t},_fsAddBaseCode:function(t,e,s,i){return t+=s.basePS,i.nineSlicedMode===ms?t+=s.baseNineSlicedPS:i.nineSlicedMode===fs&&(t+=s.baseNineSlicedTiledPS),t},_decodeFunc:function(t){return no[t]||"decodeGamma"},_fsAddStartCode:function(t,e,s,i){return t+=s.startPS,i.nineSlicedMode===ms?t+=s.startNineSlicedPS:i.nineSlicedMode===fs&&(t+=s.startNineSlicedTiledPS),t},_buildShadowPassFragmentCode:function(t,e,s,i,n){const a=i.pass-ds,r=he,o=Math.floor(a/r),h=a-o*r;e.extStandardDerivatives&&!e.webgl2&&(t+="uniform vec2 polygonOffset;\n"),h===ae?e.textureFloatHighPrecision?t+="#define VSM_EXPONENT 15.0\n\n":t+="#define VSM_EXPONENT 5.54\n\n":h===ne&&(t+="#define VSM_EXPONENT 5.54\n\n"),o!==Xt&&(t+="uniform vec3 view_position;\n",t+="uniform float light_radius;\n"),t+=n,i.alphaTest&&(t+="float dAlpha;\n",t+=this._addMap("opacity","opacityPS",i,s),t+=s.alphaTestPS),h!==se||e.webgl2&&o!==Yt?h===ie&&(t+="vec2 encodeFloatRG( float v ) {\n",t+="\t\tvec2 enc = vec2(1.0, 255.0) * v;\n",t+="\t\tenc = fract(enc);\n",t+="\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",t+="\t\treturn enc;\n",t+="}\n\n"):t+=s.packDepthPS,t+="void main(void)\n{\n",i.alphaTest&&(t+="\t getOpacity();\n",t+="\t alphaTest(dAlpha);\n");return t+=o===Yt||(h===ie||h===ne||h===ae)&&o!==Xt?"\t float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":"\t float depth = gl_FragCoord.z;\n",h!==se||e.webgl2&&(o!==Yt||i.clusteredLightingEnabled)?h===se||h===re?(t+="\t gl_FragColor = vec4(1.0);\n",i.clusteredLightingEnabled&&o===Yt&&e.webgl2&&(t+="\t gl_FragDepth = depth;\n")):t+=h===ie?"\t gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":s.storeEVSMPS:e.extStandardDerivatives&&!e.webgl2?(t+="\t float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",t+="\t depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n",t+="\t gl_FragColor = packFloat(depth);\n"):t+="\t gl_FragColor = packFloat(depth);\n",t+="}\n"},createShaderDefinition:function(t,e){let s=e.lights.length>0;e.dirLightMap&&(s=!0),e.clusteredLightingEnabled&&e.useLighting&&(s=!0),e.shadingModel===Me?(e.fresnelModel=0,e.specularAntialias=!1,e.ambientSH=!1):e.fresnelModel=0===e.fresnelModel?zt:e.fresnelModel;const i=!!e.reflectionSource;e.useSpecular||(e.specularMap=e.glossMap=null);const n=e.pass>=ds&&e.pass<=17,a=s||i||e.ambientSH||e.heightMap||e.enableGGXSpecular||e.clusteredLightingEnabled&&!n||e.clearCoatNormalMap;this.options=e;let r,o,h="",l="",c="",d=ir;const u={vertex_position:ln};if(e.chunks){const t={};for(const s in d)d.hasOwnProperty(s)&&(e.chunks[s]?(o=e.chunks[s],o.indexOf("vertex_normal")>=0&&(u.vertex_normal=cn),o.indexOf("vertex_tangent")>=0&&(u.vertex_tangent=dn),o.indexOf("vertex_texCoord0")>=0&&(u.vertex_texCoord0=_n),o.indexOf("vertex_texCoord1")>=0&&(u.vertex_texCoord1=gn),o.indexOf("vertex_color")>=0&&(u.vertex_color=mn),o.indexOf("vertex_boneWeights")>=0&&(u.vertex_boneWeights=un),o.indexOf("vertex_boneIndices")>=0&&(u.vertex_boneIndices=pn),t[s]=o):t[s]=d[s]);d=t}h+=this._getPassDefineString(e.pass),h=this._vsAddBaseCode(h,t,d,e),l+="\t vPositionW\t\t= getWorldPosition();\n",e.pass===cs&&(h+="varying float vDepth;\n",h+="#ifndef VIEWMATRIX\n",h+="#define VIEWMATRIX\n",h+="uniform mat4 matrix_view;\n",h+="#endif\n",h+="#ifndef CAMERAPLANES\n",h+="#define CAMERAPLANES\n",h+="uniform vec4 camera_params;\n\n",h+="#endif\n",l+="\t\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),e.useInstancing&&(u.instance_line1=Bn,u.instance_line2=zn,u.instance_line3=Un,u.instance_line4=Vn,h+=d.instancingVS),a&&(u.vertex_normal=cn,l+="\t vNormalW = getNormal();\n","sphereMap"===e.reflectionSource&&t.fragmentUniformsCount<=16&&(h+=d.viewNormalVS,l+="\t vNormalV\t\t= getViewNormal();\n"),(e.heightMap||e.normalMap||e.enableGGXSpecular)&&e.hasTangents?(u.vertex_tangent=dn,h+=d.tangentBinormalVS,l+="\t vTangentW\t = getTangent();\n",l+="\t vBinormalW\t= getBinormal();\n"):e.enableGGXSpecular&&(h+=d.tangentBinormalVS,l+="\t vObjectSpaceUpW\t= getObjectSpaceUp();\n"));const p=[],m=[];for(const t in io){const s=t+"Map";if(e[t+"VertexColor"]){const s=t+"VertexColorChannel";e[s]=this._correctChannel(t,e[s])}if(e[s]){const i=s+"Channel",n=s+"Transform",a=s+"Uv";e[a]=Math.min(e[a],1),e[i]=this._correctChannel(t,e[i]);const r=e[a];p[r]=!0,m[r]=m[r]||e[s]&&!e[n]}}e.forceUv1&&(p[1]=!0,m[1]=void 0===m[1]||m[1]);for(let t=0;t<2;t++)p[t]&&(u["vertex_texCoord"+t]="TEXCOORD"+t,h+=d["uv"+t+"VS"],l+="\t vec2 uv"+t+" = getUv"+t+"();\n"),m[t]&&(l+="\t vUv"+t+" = uv"+t+";\n");const f=[h,c,l,[]];for(const t in io){const s=t+"Map";if(e[s]){const i=s+"Transform";if(e[i]){const n=s+"Uv";this._setMapTransform(f,t,e[i],e[n])}}}h=f[0],c=f[1],l=f[2],e.vertexColors&&(u.vertex_color=mn,l+="\t vVertexColor = vertex_color;\n"),(e.useMorphPosition||e.useMorphNormal)&&(e.useMorphTextureBased?(h+="#define MORPHING_TEXTURE_BASED\n",e.useMorphPosition&&(h+="#define MORPHING_TEXTURE_BASED_POSITION\n"),e.useMorphNormal&&(h+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),u.morph_vertex_id=Vn,h+="attribute float morph_vertex_id;\n"):(h+="#define MORPHING\n",e.useMorphPosition?(u.morph_pos0=Dn,u.morph_pos1=Fn,u.morph_pos2=On,u.morph_pos3=kn,h+="#define MORPHING_POS03\n",h+="attribute vec3 morph_pos0;\n",h+="attribute vec3 morph_pos1;\n",h+="attribute vec3 morph_pos2;\n",h+="attribute vec3 morph_pos3;\n"):e.useMorphNormal&&(u.morph_nrm0=Dn,u.morph_nrm1=Fn,u.morph_nrm2=On,u.morph_nrm3=kn,h+="#define MORPHING_NRM03\n",h+="attribute vec3 morph_nrm0;\n",h+="attribute vec3 morph_nrm1;\n",h+="attribute vec3 morph_nrm2;\n",h+="attribute vec3 morph_nrm3;\n"),e.useMorphNormal?(u.morph_nrm4=Bn,u.morph_nrm5=zn,u.morph_nrm6=Un,u.morph_nrm7=Vn,h+="#define MORPHING_NRM47\n",h+="attribute vec3 morph_nrm4;\n",h+="attribute vec3 morph_nrm5;\n",h+="attribute vec3 morph_nrm6;\n",h+="attribute vec3 morph_nrm7;\n"):(u.morph_pos4=Bn,u.morph_pos5=zn,u.morph_pos6=Un,u.morph_pos7=Vn,h+="#define MORPHING_POS47\n",h+="attribute vec3 morph_pos4;\n",h+="attribute vec3 morph_pos5;\n",h+="attribute vec3 morph_pos6;\n",h+="attribute vec3 morph_pos7;\n"))),e.skin?(u.vertex_boneWeights=un,u.vertex_boneIndices=pn,h+=or(t,d),h+="#define SKIN\n"):e.useInstancing&&(h+="#define INSTANCING\n"),e.screenSpace&&(h+="#define SCREENSPACE\n"),e.pixelSnap&&(h+="#define PIXELSNAP\n"),h=this._vsAddTransformCode(h,t,d,e),a&&(h+=d.normalVS),h+="\n",h+=d.startVS,h+=l,h+=d.endVS,h+="}";let _=h;const g=c;c="",c+=this._addVaryingIfNeeded(h,"vec4","vVertexColor"),c+=this._addVaryingIfNeeded(h,"vec3","vPositionW"),c+=this._addVaryingIfNeeded(h,"vec3","vNormalV"),c+=this._addVaryingIfNeeded(h,"vec3","vNormalW"),c+=this._addVaryingIfNeeded(h,"vec3","vTangentW"),c+=this._addVaryingIfNeeded(h,"vec3","vBinormalW"),c+=this._addVaryingIfNeeded(h,"vec3","vObjectSpaceUpW"),c+=this._addVaryingIfNeeded(h,"vec2","vUv0"),c+=this._addVaryingIfNeeded(h,"vec2","vUv1"),c+=g,_=c+_;let y,v="";if(t.webgl2?(v=lr(t),d.extensionVS&&(v+=d.extensionVS+"\n"),_=v+d.gles3VS+_):(d.extensionVS&&(v=d.extensionVS+"\n"),_=v+_),e.forceFragmentPrecision&&"highp"!==e.forceFragmentPrecision&&"mediump"!==e.forceFragmentPrecision&&"lowp"!==e.forceFragmentPrecision&&(e.forceFragmentPrecision=null),e.forceFragmentPrecision&&("highp"===e.forceFragmentPrecision&&"highp"!==t.maxPrecision&&(e.forceFragmentPrecision="mediump"),"mediump"===e.forceFragmentPrecision&&"lowp"===t.maxPrecision&&(e.forceFragmentPrecision="lowp")),h="",t.webgl2&&(h+=lr(t)),t.webgl2||(t.extStandardDerivatives&&(h+="#extension GL_OES_standard_derivatives : enable\n"),t.extTextureLod&&(h+="#extension GL_EXT_shader_texture_lod : enable\n",h+="#define SUPPORTS_TEXLOD\n")),d.extensionPS&&(h+=d.extensionPS+"\n"),t.webgl2&&(h+=d.gles3PS),h+=e.forceFragmentPrecision?"precision "+e.forceFragmentPrecision+" float;\n\n":hr(t),h+=this._getPassDefineString(e.pass),e.pass===us)return h+="uniform vec4 uColor;\n",h+=c,e.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",e,d),h+=d.alphaTestPS),h+="void main(void)\n{\n",e.alphaTest&&(h+="\t getOpacity();\n",h+="\t alphaTest(dAlpha);\n"),h+="\t\tgl_FragColor = uColor;\n",h+="}\n",{attributes:u,vshader:_,fshader:h};if(e.pass===cs)return h+="varying float vDepth;\n",h+=c,h+=d.packDepthPS,e.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",e,d),h+=d.alphaTestPS),h+="void main(void)\n{\n",e.alphaTest&&(h+="\t getOpacity();\n",h+="\t alphaTest(dAlpha);\n"),h+="\t\tgl_FragColor = packFloat(vDepth);\n",h+="}\n",{attributes:u,vshader:_,fshader:h};if(n)return{attributes:u,vshader:_,fshader:this._buildShadowPassFragmentCode(h,t,d,e,c)};if(e.customFragmentShader)return y=h+e.customFragmentShader,{attributes:u,vshader:_,fshader:y,tag:Nn};h+=c,h=this._fsAddBaseCode(h,t,d,e),e.detailModes&&(h+=d.detailModesPS);const x=h;h="",e.clearCoat>0&&(h+="#define CLEARCOAT\n",h+="#define CLUSTER_CLEAR_COAT\n"),!1===e.opacityFadesSpecular&&(h+="uniform float material_alphaFade;\n");let b=0;const S=[];let w=!1,M=!1,T=!1,A=e.lights.some((function(t){return t._shape&&t._shape!==$t}));e.clusteredLightingEnabled&&e.clusteredLightingAreaLightsEnabled&&(A=!0),t.areaLightLutFormat===Li?(h+="#define AREA_R8_G8_B8_A8_LUTS\n",h+="#define AREA_LUTS_PRECISION lowp\n"):h+="#define AREA_LUTS_PRECISION highp\n",(A||e.clusteredLightingEnabled)&&(h+="#define AREA_LIGHTS\n",h+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex1;\n",h+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex2;\n");let C,P=$t;for(let s=0;s<e.lights.length;s++){const i=e.lights[s],n=i._type;e.clusteredLightingEnabled&&n!==Xt||(P=A&&i._shape?i._shape:$t,h+="uniform vec3 light"+s+"_color;\n",n===Xt?h+="uniform vec3 light"+s+"_direction;\n":(h+="uniform vec3 light"+s+"_position;\n",h+="uniform float light"+s+"_radius;\n",n===Kt&&(h+="uniform vec3 light"+s+"_direction;\n",h+="uniform float light"+s+"_innerConeAngle;\n",h+="uniform float light"+s+"_outerConeAngle;\n")),P!==$t&&(n===Xt&&(h+="uniform vec3 light"+s+"_position;\n"),h+="uniform vec3 light"+s+"_halfWidth;\n",h+="uniform vec3 light"+s+"_halfHeight;\n"),i.castShadows&&!e.noShadow&&(h+="uniform mat4 light"+s+"_shadowMatrix;\n",n===Xt&&(h+="uniform mat4 light"+s+"_shadowMatrixPalette[4];\n",h+="uniform float light"+s+"_shadowCascadeDistances[4];\n",h+="uniform float light"+s+"_shadowCascadeCount;\n"),n!==Xt?h+="uniform vec4 light"+s+"_shadowParams;\n":(w=!0,h+="uniform vec3 light"+s+"_shadowParams;\n"),n===Yt?h+="uniform samplerCube light"+s+"_shadowMap;\n":i._isPcf&&t.webgl2?h+="uniform sampler2DShadow light"+s+"_shadowMap;\n":h+="uniform sampler2D light"+s+"_shadowMap;\n",b++,S[i._shadowType]=!0,i._isVsm&&(M=!0),i._isPcf&&(t.webgl2||t.extStandardDerivatives)&&n===Kt&&(T=!0)),i._cookie&&(i._cookie._cubemap?n===Yt&&(h+="uniform samplerCube light"+s+"_cookie;\n",h+="uniform float light"+s+"_cookieIntensity;\n",i.castShadows&&!e.noShadow||(h+="uniform mat4 light"+s+"_shadowMatrix;\n")):n===Kt&&(h+="uniform sampler2D light"+s+"_cookie;\n",h+="uniform float light"+s+"_cookieIntensity;\n",i.castShadows&&!e.noShadow||(h+="uniform mat4 light"+s+"_shadowMatrix;\n"),i._cookieTransform&&(h+="uniform vec4 light"+s+"_cookieMatrix;\n",h+="uniform vec2 light"+s+"_cookieOffset;\n"))))}if(h+="\n",C=!e.hasTangents&&t.extStandardDerivatives?d.TBNderivativePS:e.fastTbn?d.TBNfastPS:d.TBNPS,a)if(e.normalMap||e.clearCoatNormalMap){if(h+=e.packedNormal?d.normalXYPS:d.normalXYZPS,!e.hasTangents){const t=e.normalMap?"normalMap":"clearCoatNormalMap",s=this._getUvSourceExpression(`${t}Transform`,`${t}Uv`,e);C=C.replace(/\$UV/g,s)}h+=C}else e.enableGGXSpecular&&!e.heightMap&&(h+=d.normalVertexPS,h+=d.TBNObjectSpacePS);if(a)if(e.normalMap){e.normalDetail&&(h+=this._addMap("normalDetail","normalDetailMapPS",e,d));const t=this._getUvSourceExpression("normalMapTransform","normalMapUv",e);e.normalizeNormalMap?h+=d.normalMapPS.replace(/\$UV/g,t):h+=d.normalMapFastPS.replace(/\$UV/g,t)}else e.enableGGXSpecular&&!e.heightMap||(h+=d.normalVertexPS);if(h+=nr(e.gamma,d),h+=ar(e.toneMap,d),h+=rr(e.fog,d),h+=d.decodePS,e.useRgbm&&(h+=d.rgbmPS),e.useCubeMapRotation&&(h+="#define CUBEMAP_ROTATION\n"),a&&(h+=d.cubeMapRotatePS,h+=e.cubeMapProjection>0?d.cubeMapProjectBoxPS:d.cubeMapProjectNonePS,h+=e.skyboxIntensity?d.envMultiplyPS:d.envConstPS),e.diffuseDetail&&(h+=this._addMap("diffuseDetail","diffuseDetailMapPS",e,d)),h+=this._addMap("diffuse","diffusePS",e,d),(e.blendType!==Pt||e.alphaTest||e.alphaToCoverage)&&(h+=this._addMap("opacity","opacityPS",e,d)),h+=this._addMap("emissive","emissivePS",e,d,e.emissiveFormat),s&&e.useSpecular||i){e.specularAntialias&&e.normalMap?e.normalizeNormalMap&&a?h+=d.specularAaToksvigPS:h+=d.specularAaToksvigFastPS:h+=d.specularAaNonePS;const t=e.useMetalness?"metalness":"specular";h+=this._addMap(t,t+"PS",e,d),h+=this._addMap("gloss","glossPS",e,d),e.fresnelModel===zt&&(h+=d.fresnelSchlickPS)}if(e.clearCoat>0&&(h+=this._addMap("clearCoat","clearCoatPS",e,d),h+=this._addMap("clearCoatGloss","clearCoatGlossPS",e,d),h+=this._addMap("clearCoatNormal","clearCoatNormalPS",e,d)),e.heightMap){if(!e.normalMap){const t=this._getUvSourceExpression("heightMapTransform","heightMapUv",e);e.hasTangents||(C=C.replace(/\$UV/g,t)),h+=C}h+=this._addMap("height","parallaxPS",e,d)}const R=e.aoMap||e.aoVertexColor;if(R&&(h+=this._addMap("ao","aoPS",e,d),e.occludeSpecular&&(e.occludeSpecular===Be?h+=e.occludeSpecularFloat?d.aoSpecOccSimplePS:d.aoSpecOccConstSimplePS:h+=e.occludeSpecularFloat?d.aoSpecOccPS:d.aoSpecOccConstPS)),"envAtlas"===e.reflectionSource)h+=d.reflectionEnvPS.replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding));else if("cubeMap"===e.reflectionSource)h+=e.fixSeams?d.fixCubemapSeamsStretchPS:d.fixCubemapSeamsNonePS,h+=d.reflectionCubePS.replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding));else if("sphereMap"===e.reflectionSource){h+=(t.fragmentUniformsCount>16?d.reflectionSpherePS:d.reflectionSphereLowPS).replace(/\$DECODE/g,this._decodeFunc(e.reflectionEncoding))}i&&(e.clearCoat>0&&(h+=d.reflectionCCPS),e.refraction&&(h+=d.refractionPS)),e.clusteredLightingEnabled&&(h+=d.clusteredLightUtilsPS,h+=d.clusteredLightCookiesPS,S[se]=!0,S[re]=!0,T=!0),(b>0||e.clusteredLightingEnabled)&&(w&&(h+=d.shadowCascadesPS),S[se]&&(h+=d.shadowStandardPS),S[re]&&t.webgl2&&(h+=d.shadowStandardGL2PS),M&&(h+=d.shadowVSM_commonPS,S[ie]&&(h+=d.shadowVSM8PS),S[ne]&&(h+=t.extTextureHalfFloatLinear?d.shadowEVSMPS.replace(/\$/g,"16"):d.shadowEVSMnPS.replace(/\$/g,"16")),S[ae]&&(h+=t.extTextureFloatLinear?d.shadowEVSMPS.replace(/\$/g,"32"):d.shadowEVSMnPS.replace(/\$/g,"32"))),t.webgl2||t.extStandardDerivatives||(h+=d.biasConstPS),h+=d.shadowCoordPS+d.shadowCommonPS,T&&(h+=d.shadowCoordPerspZbufferPS)),e.enableGGXSpecular&&(h+="uniform float material_anisotropy;\n"),s&&(h+=d.lightDiffuseLambertPS,(A||e.clusteredLightingEnabled)&&(h+=d.ltc)),h+="\n";let E=!1;e.useSpecular?(h+="#define CLUSTER_SPECULAR\n",e.conserveEnergy&&(h+="#define CLUSTER_CONSERVE_ENERGY\n"),s&&(h+=e.shadingModel===Me?d.lightSpecularPhongPS:e.enableGGXSpecular?d.lightSpecularAnisoGGXPS:d.lightSpecularBlinnPS),e.fresnelModel>0?e.conserveEnergy&&!A?h+=d.combineDiffuseSpecularPS:h+=d.combineDiffuseSpecularNoConservePS:i?h+=d.combineDiffuseSpecularOldPS:e.diffuseMap?h+=d.combineDiffuseSpecularNoReflPS:(h+=d.combineDiffuseSpecularNoReflSeparateAmbientPS,E=!0)):h+=d.combineDiffusePS,e.clearCoat>0&&(h+=d.combineClearCoatPS);let L=!0;if(e.lightMap||e.lightVertexColor){const t=e.dirLightMap&&e.useSpecular?"lightmapDirPS":"lightmapSinglePS";h+=this._addMap("light",t,e,d,e.lightMapFormat),L=e.lightMapWithoutAmbient}L&&("ambientSH"===e.ambientSource?h+=d.ambientSHPS:"envAtlas"===e.ambientSource?h+=d.ambientEnvPS.replace(/\$DECODE/g,this._decodeFunc(e.ambientEncoding)):h+=d.ambientConstantPS),e.ambientTint&&!E&&(h+="uniform vec3 material_ambient;\n"),e.alphaTest&&(h+=d.alphaTestPS),e.msdf&&(h+=d.msdfPS),a&&(h+=d.viewDirPS,e.useSpecular&&(h+=e.enableGGXSpecular?d.reflDirAnisoPS:d.reflDirPS));let I,D=!1,F=!1,O=!1,k=!1,B=!1;e.clusteredLightingEnabled&&s&&(k=!0,D=!0,F=!0,B=!0,h+=d.floatUnpackingPS,e.clusteredLightingCookiesEnabled&&(h+="\n#define CLUSTER_COOKIES"),e.clusteredLightingShadowsEnabled&&!e.noShadow&&(h+="\n#define CLUSTER_SHADOWS",h+="\n#define CLUSTER_SHADOW_TYPE_"+le[e.clusteredLightingShadowType]),e.clusteredLightingAreaLightsEnabled&&(h+="\n#define CLUSTER_AREALIGHTS"),h+=so.shaderDefines,h+=d.clusteredLightShadowsPS,h+=d.clusteredLightPS),e.twoSidedLighting&&(h+="uniform float twoSidedLightingNegScaleFactor;\n"),h=this._fsAddStartCode(h,t,d,e),a&&(e.hasTangents||!t.extStandardDerivatives||e.fastTbn?e.twoSidedLighting?h+="\t dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;\n":h+="\t dVertexNormalW = vNormalW;\n":e.twoSidedLighting?h+="\t dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n":h+="\t dVertexNormalW = normalize(vNormalW);\n",(e.heightMap||e.normalMap)&&e.hasTangents&&(e.twoSidedLighting?(h+="\t dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n",h+="\t dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"):(h+="\t dTangentW = vTangentW;\n",h+="\t dBinormalW = vBinormalW;\n")));let z=!1;e.blendType!==Pt||e.alphaTest||e.alphaToCoverage?e.heightMap&&e.opacityMap?z=!0:(h+="\t getOpacity();\n",e.alphaTest&&(h+="\t alphaTest(dAlpha);\n")):h+="\t dAlpha = 1.0;\n";let U=!1;if(a&&(h+="\t getViewDir();\n",(e.heightMap||e.normalMap||e.clearCoatNormalMap||e.enableGGXSpecular)&&(h+="\t getTBN();\n"),e.heightMap&&(h+="\t getParallax();\n"),z&&(h+="\t getOpacity();\n",e.alphaTest&&(h+="\t alphaTest(dAlpha);\n")),h+="\t getNormal();\n",e.useSpecular&&(s&&e.enableGGXSpecular&&(h+="\t getGlossiness();\n",U=!0),h+="\t getReflDir();\n")),h+="\t getAlbedo();\n",e.clearCoat>0&&(h+="\t getClearCoat();\n",h+="\t getClearCoatGlossiness();\n",h+="\t getClearCoatNormal();\n"),(s&&e.useSpecular||i)&&(h+="\t getSpecularity();\n",U||(h+="\t getGlossiness();\n"),A&&(h+="\t #ifdef AREA_LIGHTS\n",h+="\t dSpecularityNoFres = dSpecularity;\n",h+="\t #ifdef CLEARCOAT\n",h+="\t ccSpecularityNoFres = ccSpecularity;\n",h+="\t #endif\n",h+="\t #endif\n"),e.fresnelModel>0&&(h+="\t getFresnel();\n")),L&&(h+="\t addAmbient();\n",e.separateAmbient&&(h+="\n\t\t\t\t\t\t\t\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = vec3(0);\n\t\t\t\t\t\t\t\t")),e.ambientTint&&!E&&(h+="\t dDiffuseLight *= material_ambient;\n"),R&&!e.occludeDirect&&(h+="\t\tapplyAO();\n"),(e.lightMap||e.lightVertexColor)&&(h+="\t addLightMap();\n"),s||i){i&&(e.clearCoat>0&&(h+="\t addReflectionCC();\n"),h+="\t addReflection();\n"),A&&(h+="\t ccReflection.rgb *= ccSpecularity;\n",h+="\t dReflection.rgb *= dSpecularity;\n",h+="\t dSpecularLight *= dSpecularity;\n",h+="\t float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);\n",h+="\t calcLTCLightValues();\n");let n="";for(let s=0;s<e.lights.length;s++){const i=e.lights[s],a=i._type;if(!e.clusteredLightingEnabled||a===Xt){if(I=!1,A&&i._shape?(P=i._shape,n=this._getLightSourceShapeString(P)):(P=$t,n=""),P!==$t&&(h+="\t calc"+n+"LightValues(light"+s+"_position, light"+s+"_halfWidth, light"+s+"_halfHeight);\n"),a===Xt?(h+="\t dLightDirNormW = light"+s+"_direction;\n",h+="\t dAtten = 1.0;\n"):(i._cookie&&(a!==Kt||i._cookie._cubemap?a===Yt&&i._cookie._cubemap&&(B=!0,I=!0):(B=!0,I=!0)),h+="\t getLightDirPoint(light"+s+"_position);\n",D=!0,I&&(h+=a===Kt?"\t dAtten3 = getCookie2D"+(i._cookieFalloff?"":"Clip")+(i._cookieTransform?"Xform":"")+"(light"+s+"_cookie, light"+s+"_shadowMatrix, light"+s+"_cookieIntensity"+(i._cookieTransform?", light"+s+"_cookieMatrix, light"+s+"_cookieOffset":"")+")."+i._cookieChannel+";\n":"\t dAtten3 = getCookieCube(light"+s+"_cookie, light"+s+"_shadowMatrix, light"+s+"_cookieIntensity)."+i._cookieChannel+";\n"),P===$t?i._falloffMode===te?(h+="\t dAtten = getFalloffLinear(light"+s+"_radius);\n",F=!0):(h+="\t dAtten = getFalloffInvSquared(light"+s+"_radius);\n",O=!0):(h+="\t dAtten = getFalloffWindow(light"+s+"_radius);\n",O=!0),h+="\t if (dAtten > 0.00001) {\n",a===Kt&&(I&&!i._cookieFalloff||(h+="\t\t\t dAtten *= getSpotEffect(light"+s+"_direction, light"+s+"_innerConeAngle, light"+s+"_outerConeAngle);\n",k=!0))),h+=P!==$t?a===Xt?"\t\t\t dAttenD = getLightDiffuse();\n":"\t\t\t dAttenD = get"+n+"LightDiffuse() * 16.0;\n":"\t\t\t dAtten *= getLightDiffuse();\n",i.castShadows&&!e.noShadow){let n,o=null;if(i._shadowType===ie?(o="VSM8",n="0.0"):i._shadowType===ne?(o="VSM16",n="5.54"):i._shadowType===ae?(o="VSM32",n=t.textureFloatHighPrecision?"15.0":"5.54"):o=i._shadowType===re?"PCF5x5":"PCF3x3",null!==o)if(a===Yt)r="(light"+s+"_shadowMap, light"+s+"_shadowParams);\n",i._normalOffsetBias&&(h+="\t\t\t normalOffsetPointShadow(light"+s+"_shadowParams);\n"),h+="\t\t\t dAtten *= getShadowPoint"+o+r;else{const r=`light${s}_shadowMatrix`,l=`light${s}_shadowParams`;h+=this._nonPointShadowMapProjection(t,e.lights[s],r,l,s),a===Kt&&(o="Spot"+o),h+="\t\t\t dAtten *= getShadow"+o+"(light"+s+"_shadowMap, light"+s+"_shadowParams"+(i._isVsm?", "+n:"")+");\n"}}P!==$t?e.conserveEnergy&&e.useSpecular?h+="\t\t\t dDiffuseLight += mix((dAttenD * dAtten) * light"+s+"_color"+(I?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n":h+="\t\t\t dDiffuseLight += (dAttenD * dAtten) * light"+s+"_color"+(I?" * dAtten3":"")+";\n":A&&e.conserveEnergy&&e.useSpecular?h+="\t\t\t dDiffuseLight += mix(dAtten * light"+s+"_color"+(I?" * dAtten3":"")+", vec3(0), dSpecularity);\n":h+="\t\t\t dDiffuseLight += dAtten * light"+s+"_color"+(I?" * dAtten3":"")+";\n",P!==$t?(e.clearCoat>0&&(h+="\t\t\t ccSpecularLight += ccLTCSpecFres * get"+n+"LightSpecularCC() * dAtten * light"+s+"_color"+(I?" * dAtten3":"")+";\n"),e.useSpecular&&(h+="\t\t\t dSpecularLight += dLTCSpecFres * get"+n+"LightSpecular() * dAtten * light"+s+"_color"+(I?" * dAtten3":"")+";\n")):A?(e.clearCoat>0&&(h+="\t\t\t ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+s+"_color"+(I?" * dAtten3":"")+";\n"),e.useSpecular&&(h+="\t\t\t dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+s+"_color"+(I?" * dAtten3":"")+";\n")):(e.clearCoat>0&&(h+="\t\t\t ccSpecularLight += getLightSpecularCC() * dAtten * light"+s+"_color"+(I?" * dAtten3":"")+";\n"),e.useSpecular&&(h+="\t\t\t dSpecularLight += getLightSpecular() * dAtten * light"+s+"_color"+(I?" * dAtten3":"")+";\n")),a!==Xt&&(h+="\t }\n"),h+="\n"}}e.clusteredLightingEnabled&&s&&(F=!0,O=!0,D=!0,h+="\t addClusteredLights();\n"),A&&(e.clearCoat>0&&(h+="\t ccSpecularity = 1.0;\n"),e.useSpecular&&(h+="\t dSpecularity = vec3(1);\n")),i&&e.refraction&&(h+="\t addRefraction();\n")}h+="\n",R&&(e.occludeDirect&&(h+="\t\tapplyAO();\n"),e.occludeSpecular&&(h+="\t\toccludeSpecular();\n")),!1===e.opacityFadesSpecular&&(e.blendType!==Ct&&e.blendType!==Rt||(h+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n",h+="#ifdef CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n",h+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n"),h+="dAlpha *= material_alphaFade;\n"),h+=d.endPS,e.blendType===Ct||e.blendType===Lt||e.alphaToCoverage?h+=d.outputAlphaPS:e.blendType===Rt?h+=d.outputAlphaPremulPS:h+=d.outputAlphaOpaquePS,e.msdf&&(h+="\t gl_FragColor = applyMsdf(gl_FragColor);\n"),h+="\n",h+="}\n",D&&(h=d.lightDirPointPS+h),F&&(h=d.falloffLinearPS+h),O&&(h=d.falloffInvSquaredPS+h),k&&(h=d.spotPS+h),B&&(h=d.cookiePS+h);let V="";return h.includes("dReflection")&&(V+="vec4 dReflection;\n"),h.includes("dTBN")&&(V+="mat3 dTBN;\n"),h.includes("dAlbedo")&&(V+="vec3 dAlbedo;\n"),h.includes("dEmission")&&(V+="vec3 dEmission;\n"),h.includes("dNormalW")&&(V+="vec3 dNormalW;\n"),h.includes("dVertexNormalW")&&(V+="vec3 dVertexNormalW;\n"),h.includes("dTangentW")&&(V+="vec3 dTangentW;\n"),h.includes("dBinormalW")&&(V+="vec3 dBinormalW;\n"),h.includes("dViewDirW")&&(V+="vec3 dViewDirW;\n"),h.includes("dReflDirW")&&(V+="vec3 dReflDirW;\n"),h.includes("dDiffuseLight")&&(V+="vec3 dDiffuseLight;\n"),h.includes("dSpecularLight")&&(V+="vec3 dSpecularLight;\n"),h.includes("dLightDirNormW")&&(V+="vec3 dLightDirNormW;\n"),h.includes("dLightDirW")&&(V+="vec3 dLightDirW;\n"),h.includes("dLightPosW")&&(V+="vec3 dLightPosW;\n"),h.includes("dShadowCoord")&&(V+="vec3 dShadowCoord;\n"),h.includes("dNormalMap")&&(V+="vec3 dNormalMap;\n"),h.includes("dSpecularity")&&(V+="vec3 dSpecularity;\n"),h.includes("dSpecularityNoFres")&&(V+="vec3 dSpecularityNoFres;\n"),h.includes("dUvOffset")&&(V+="vec2 dUvOffset;\n"),h.includes("dGlossiness")&&(V+="float dGlossiness;\n"),h.includes("dAlpha")&&(V+="float dAlpha;\n"),h.includes("dAtten")&&(V+="float dAtten;\n"),h.includes("dAttenD")&&(V+="float dAttenD;\n"),h.includes("dAtten3")&&(V+="vec3 dAtten3;\n"),h.includes("dAo")&&(V+="float dAo;\n"),h.includes("dMsdf")&&(V+="vec4 dMsdf;\n"),h.includes("ccReflection")&&(V+="vec4 ccReflection;\n"),h.includes("ccNormalW")&&(V+="vec3 ccNormalW;\n"),h.includes("ccReflDirW")&&(V+="vec3 ccReflDirW;\n"),h.includes("ccSpecularLight")&&(V+="vec3 ccSpecularLight;\n"),h.includes("ccSpecularity")&&(V+="float ccSpecularity;\n"),h.includes("ccSpecularityNoFres")&&(V+="float ccSpecularityNoFres;\n"),h.includes("ccGlossiness")&&(V+="float ccGlossiness;\n"),h=x+V+h,y=h,{attributes:u,vshader:_,fshader:y,tag:Nn}}},ro={begin:dr,dummyFragmentCode:cr,end:ur,fogCode:rr,gammaCode:nr,precisionCode:hr,skinCode:or,tonemapCode:ar,versionCode:lr,basic:_r,particle:gr,skybox:yr,standard:ao},oo=function(t,e,s){const i=2.399963229728653*e,n=Math.sqrt(e)/Math.sqrt(s);t.x=n*Math.cos(i),t.y=n*Math.sin(i)},ho=function(t,e,s,i=0,n=1){i=1-2*i,n=1-2*n;const a=V.lerp(i,n,e/s),r=Math.sqrt(1-a*a),o=2.399963229728653*e;t.x=Math.cos(o)*r,t.y=a,t.z=Math.sin(o)*r},lo=function(t){let e=(t<<16|t>>>16)>>>0;return e=((1431655765&e)<<1|(2863311530&e)>>>1)>>>0,e=((858993459&e)<<2|(3435973836&e)>>>2)>>>0,e=((252645135&e)<<4|(4042322160&e)>>>4)>>>0,e=((16711935&e)<<8|(4278255360&e)>>>8)>>>0,2.3283064365386963e-10*e},co=t=>{switch(t.type){case Yn:return"RGBM";case Kn:return"RGBE";default:switch(t.format){case Oi:case Bi:case ki:case zi:return"Linear";default:return"Gamma"}}},uo=t=>{switch(t===Zn&&(t=Qn),t){case Jn:return"Cubemap";case Qn:return"Equirect";case ta:return"Octahedral"}},po=(t,e,s)=>{if(t<=0)e[s+0]=0,e[s+1]=0,e[s+2]=0,e[s+3]=0;else if(t>=1)e[s+0]=255,e[s+1]=0,e[s+2]=0,e[s+3]=0;else{let i=1*t%1,n=255*t%1,a=65025*t%1;const r=16581375*t%1;i-=n/255,n-=a/255,a-=r/255,e[s+0]=Math.min(255,Math.floor(256*i)),e[s+1]=Math.min(255,Math.floor(256*n)),e[s+2]=Math.min(255,Math.floor(256*a)),e[s+3]=Math.min(255,Math.floor(256*r))}},mo=(t,e,s,i)=>{const n=2*s*Math.PI,a=Math.pow(1-e,1/(i+1)),r=Math.sqrt(1-a*a);t.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},fo=(t,e,s)=>{const i=2*s*Math.PI,n=Math.sqrt(1-e),a=Math.sqrt(e);t.set(Math.cos(i)*a,Math.sin(i)*a,n).normalize()},_o=(t,e,s,i)=>{const n=2*s*Math.PI,a=Math.sqrt((1-e)/(1+(i*i-1)*e)),r=Math.sqrt(1-a*a);t.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},go=(t,e)=>{const s=t*e,i=e/(1-t*t+s*s);return i*i*(1/Math.PI)},yo={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},vo=(t,e,s)=>{const i=s/t,n=1-Math.log2(e)/11,a=n*n,r=new it,o=new it,h=new it(0,0,1),l=[],c=((t,e)=>{const s=yo[t];return s&&s[e]||t})(t,e);for(let t=0;t<c;++t){_o(r,t/c,lo(t),a);const e=r.z;if(o.set(r.x,r.y,r.z).mulScalar(2*e).sub(h),o.z>0){const t=go(Math.min(1,e),a)/4+.001,s=.5*Math.log2(i/t);l.push(o.x,o.y,o.z,s)}}for(;l.length<4*t;)l.push(0,0,0,0);return l},xo=(t,e,s)=>{const i=s.length,n=Math.min(i,512),a=Math.ceil(i/n),r=new Uint8ClampedArray(n*a*4);let o=0;for(let t=0;t<i;++t)po(.5*s[4*t+0]+.5,r,o+0),po(.5*s[4*t+1]+.5,r,o+4),po(.5*s[4*t+2]+.5,r,o+8),po(s[4*t+3]/8,r,o+12),o+=16;return new Mr(t,{name:e,width:n,height:a,mipmaps:!1,minFilter:di,magFilter:di,levels:[r]})},bo={},So=(t,e,s)=>{const i=`lambert-samples-${e}-${s}`;if(bo.hasOwnProperty(i))return bo[i];const n=((t,e)=>{const s=e/t,i=new it,n=[];for(let e=0;e<t;++e){fo(i,e/t,lo(e));const a=i.z/Math.PI,r=.5*Math.log2(s/a);n.push(i.x,i.y,i.z,r)}return n})(e,s),a=xo(t,i,n);return bo[i]=a,a},wo=(t,e,s)=>{const i=`phong-samples-${e}-${s}`;if(bo.hasOwnProperty(i))return bo[i];const n=((t,e)=>{const s=new it,i=[];for(let n=0;n<t;++n)mo(s,n/t,lo(n),e),i.push(s.x,s.y,s.z,0);return i})(e,s),a=xo(t,i,n);return bo[i]=a,a},Mo=(t,e,s,i)=>{const n=`ggx-samples-${e}-${s}-${i}`;if(bo.hasOwnProperty(n))return bo[n];const a=vo(e,s,i),r=xo(t,n,a);return bo[n]=r,r},To="\nattribute vec2 vertex_position;\n\nuniform vec4 uvMod;\n\nvarying vec2 vUv0;\n\nvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = (vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw;\n}\n";function Ao(t,e,s={}){var i;t instanceof ch&&(t=arguments[1],e=arguments[2],s={},void 0!==arguments[3]&&(s.specularPower=arguments[3]),void 0!==arguments[4]&&(s.numSamples=arguments[4]));const n={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},a=s.hasOwnProperty("specularPower")?s.specularPower:1,r=s.hasOwnProperty("face")?s.face:null,o=s.hasOwnProperty("distribution")?s.distribution:1===a?"none":"phong",h=n[o]||"reproject",l=`decode${co(t)}`,c=`encode${co(e)}`,d=`sample${uo(t.projection)}`,u=`getDirection${uo(e.projection)}`,p=s.hasOwnProperty("numSamples")?s.numSamples:1024,m=`${h}_${l}_${c}_${d}_${u}_${p}`,f=t.device;let _=f.programLib._cache[m];if(!_){const t=`#define PROCESS_FUNC ${h}\n#define DECODE_FUNC ${l}\n#define ENCODE_FUNC ${c}\n#define SOURCE_FUNC ${d}\n#define TARGET_FUNC ${u}\n#define NUM_SAMPLES ${p}\n`+(f.extTextureLod?"#define SUPPORTS_TEXLOD\n":""),e=f.webgl2?null:"#extension GL_OES_standard_derivatives: enable\n"+(f.extTextureLod?"#extension GL_EXT_shader_texture_lod: enable\n":"");_=fr(f,To,`${t}\n${ir.reprojectPS}`,m,!1,e)}const g=f.scope.resolve(t.cubemap?"sourceCube":"sourceTex");g.setValue(t);const y=f.scope.resolve("params"),v=f.scope.resolve("params2"),x=f.scope.resolve("uvMod");if(null!=(i=s)&&i.seamPixels){const t=s.seamPixels,i=(s.rect?s.rect.z:e.width)-2*t,n=(s.rect?s.rect.w:e.height)-2*t;x.setValue([(i+2*t)/i,(n+2*t)/n,-t/i,-t/n])}else x.setValue([1,1,0,0]);const b=[0,a,t.fixCubemapSeams?1/t.width:0,e.fixCubemapSeams?1/e.width:0],S=[e.width*e.height*(e.cubemap?6:1),t.width*t.height*(t.cubemap?6:1)];if(h.startsWith("prefilterSamples")){const e=t.width*t.height*(t.cubemap?6:1),s="ggx"===o?Mo(f,p,a,e):"lambert"===o?So(f,p,e):wo(f,p,a);f.scope.resolve("samplesTex").setValue(s),f.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let t=0;t<(e.cubemap?6:1);t++)if(null===r||t===r){var w;const i=new uh({colorBuffer:e,face:t,depth:!1});b[0]=t,y.setValue(b),v.setValue(S),er(f,i,_,null==(w=s)?void 0:w.rect),i.destroy()}}const Co=(t,e)=>1+Math.floor(Math.log2(Math.max(t,e))),Po=t=>Li;class Ro{static generateSkyboxCubemap(t,e){const s=((t,e,s,i)=>new Mr(t,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:s,type:s===Li?Yn:Xn,addressU:Ws,addressV:Ws,fixCubemapSeams:!0,mipmaps:!!i}))(t.device,e||(t.cubemap?t.width:t.width/4),Li,!1);return Ao(t,s,{numSamples:1024}),s}static generateLightingSource(t){const e=t.device,s=(t=>(t=>t.extTextureHalfFloat&&t.textureHalfFloatRenderable)(t)?ki:(t=>t.extTextureFloat&&t.textureFloatRenderable)(t)?zi:Li)(e),i=new Mr(e,{name:"lighting-source",cubemap:!0,width:128,height:128,format:s,type:s===Li?Yn:Xn,addressU:Ws,addressV:Ws,fixCubemapSeams:!1,mipmaps:!0});return Ao(t,i,{numSamples:t.mipmaps?1:1024}),i}static generateAtlas(t,e){const s=t.device,i=Po(),n=(null==e?void 0:e.target)||new Mr(s,{width:512,height:512,format:i,type:Yn,projection:Qn,addressU:Ws,addressV:Ws,mipmaps:!1}),a=new nt(0,0,512,256),r=Co(n.width,n.height);for(let e=0;e<r;++e)Ao(t,n,{numSamples:1,rect:a,seamPixels:1}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256,256,128);for(let s=1;s<7;++s)Ao(t,n,{numSamples:(null==e?void 0:e.numSamples)||1024,distribution:(null==e?void 0:e.distribution)||"ggx",specularPower:Math.max(1,2048>>2*s),rect:a,seamPixels:1}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128,384,64,32),Ao(t,n,{numSamples:(null==e?void 0:e.numSamples)||2048,distribution:"lambert",rect:a,seamPixels:1}),n}static generatePrefilteredAtlas(t,e){const s=t[0].device,i=Po(),n=(null==e?void 0:e.target)||new Mr(s,{width:512,height:512,format:i,type:Yn,projection:Qn,addressU:Ws,addressV:Ws,mipmaps:!1}),a=new nt(0,0,512,256),r=Co(n.width,n.height);for(let e=0;e<r;++e)Ao(t[0],n,{numSamples:1,rect:a,seamPixels:1}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256,256,128);for(let e=1;e<t.length;++e)Ao(t[e],n,{numSamples:1,rect:a,seamPixels:1}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128,384,64,32),null!=e&&e.legacyAmbient?Ao(t[5],n,{numSamples:1,rect:a,seamPixels:1}):Ao(t[0],n,{numSamples:(null==e?void 0:e.numSamples)||2048,distribution:"lambert",rect:a,seamPixels:1}),n}}class Eo{static get(t){return this.cache.get(t)}static add(t,e){this.cache.set(t,e)}static remove(t){this.cache.delete(t)}}Eo.cache=new Map;let Lo=0;class Io{constructor(){this.name="Untitled",this.id=Lo++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this.blend=!1,this.blendSrc=js,this.blendDst=Hs,this.blendEquation=Zs,this.separateAlphaBlend=!1,this.blendSrcAlpha=js,this.blendDstAlpha=Hs,this.blendAlphaEquation=Zs,this.cull=hi,this.depthTest=!0,this.depthWrite=!0,this.stencilFront=null,this.stencilBack=null,this.depthBias=0,this.slopeDepthBias=0,this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}get shader(){return this._shader}set shader(t){this._shader=t}get blendType(){return this.blend||this.blendSrc!==js||this.blendDst!==Hs||this.blendEquation!==Zs?this.blend&&this.blendSrc===Ks&&this.blendDst===$s&&this.blendEquation===Zs?Ct:this.blend&&this.blendSrc===js&&this.blendDst===js&&this.blendEquation===Zs?At:this.blend&&this.blendSrc===Ks&&this.blendDst===js&&this.blendEquation===Zs?Lt:this.blend&&this.blendSrc===Xs&&this.blendDst===qs&&this.blendEquation===Zs?It:this.blend&&this.blendSrc===Ys&&this.blendDst===js&&this.blendEquation===Zs?Dt:this.blend&&this.blendSrc===js&&this.blendDst===js&&this.blendEquation===Js?Ft:this.blend&&this.blendSrc===js&&this.blendDst===js&&this.blendEquation===Qs?Ot:this.blend&&this.blendSrc===Xs&&this.blendDst===Hs&&this.blendEquation===Zs?Et:this.blend&&this.blendSrc===js&&this.blendDst===$s&&this.blendEquation===Zs?Rt:Ct:Pt}set blendType(t){const e=this.blend;switch(t){case Pt:this.blend=!1,this.blendSrc=js,this.blendDst=Hs,this.blendEquation=Zs;break;case Ct:this.blend=!0,this.blendSrc=Ks,this.blendDst=$s,this.blendEquation=Zs;break;case Rt:this.blend=!0,this.blendSrc=js,this.blendDst=$s,this.blendEquation=Zs;break;case At:this.blend=!0,this.blendSrc=js,this.blendDst=js,this.blendEquation=Zs;break;case Lt:this.blend=!0,this.blendSrc=Ks,this.blendDst=js,this.blendEquation=Zs;break;case It:this.blend=!0,this.blendSrc=Xs,this.blendDst=qs,this.blendEquation=Zs;break;case Dt:this.blend=!0,this.blendSrc=Ys,this.blendDst=js,this.blendEquation=Zs;break;case Et:this.blend=!0,this.blendSrc=Xs,this.blendDst=Hs,this.blendEquation=Zs;break;case Ft:this.blend=!0,this.blendSrc=js,this.blendDst=js,this.blendEquation=Js;break;case Ot:this.blend=!0,this.blendSrc=js,this.blendDst=js,this.blendEquation=Qs}e!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}_cloneInternal(t){t.name=this.name,t.shader=this.shader,t.alphaTest=this.alphaTest,t.alphaToCoverage=this.alphaToCoverage,t.blend=this.blend,t.blendSrc=this.blendSrc,t.blendDst=this.blendDst,t.blendEquation=this.blendEquation,t.separateAlphaBlend=this.separateAlphaBlend,t.blendSrcAlpha=this.blendSrcAlpha,t.blendDstAlpha=this.blendDstAlpha,t.blendAlphaEquation=this.blendAlphaEquation,t.cull=this.cull,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.depthBias=this.depthBias,t.slopeDepthBias=this.slopeDepthBias,this.stencilFront&&(t.stencilFront=this.stencilFront.clone()),this.stencilBack&&(this.stencilFront===this.stencilBack?t.stencilBack=t.stencilFront:t.stencilBack=this.stencilBack.clone()),t.redWrite=this.redWrite,t.greenWrite=this.greenWrite,t.blueWrite=this.blueWrite,t.alphaWrite=this.alphaWrite}clone(){const t=new Io;return this._cloneInternal(t),t}_updateMeshInstanceKeys(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].updateKey()}updateUniforms(t,e){}updateShader(t,e,s){}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants={};for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];for(let t=0;t<e._shader.length;t++)e._shader[t]=null}}getParameter(t){return this.parameters[t]}setParameter(t,e){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const s=this.parameters[t];s?s.data=e:this.parameters[t]={scopeId:null,data:e}}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;void 0===e&&(e=s);for(const i in e){const e=s[i];e&&(e.scopeId||(e.scopeId=t.scope.resolve(i)),e.scopeId.setValue(e.data))}}destroy(){this.variants={},this.shader=null;for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];for(let t=0;t<e._shader.length;t++)e._shader[t]=null;e._material=null;const s=Eo.get(e.mesh.device);this!==s&&(e.material=s)}}addMeshInstanceRef(t){this.meshInstances.push(t)}removeMeshInstanceRef(t){const e=this.meshInstances,s=e.indexOf(t);-1!==s&&e.splice(s,1)}}const Do=(t,e)=>{if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0},Fo=t=>1!==t.r||1!==t.g||1!==t.b;class Oo{constructor(){this._mapXForms=null}updateMinRef(t,e,s,i,n,a,r,o){this._updateSharedOptions(t,s,i,n,r),this._updateMinOptions(t,i),this._updateUVOptions(t,i,n,!0)}updateRef(t,e,s,i,n,a,r,o){this._updateSharedOptions(t,s,i,n,r),this._updateEnvOptions(t,e,i,s),this._updateMaterialOptions(t,i),r===ls&&(t.gamma&&(t.gamma=Ee),t.toneMap=Le),t.hasTangents=n&&i.normalMap&&0!=(n&Ye),this._updateLightOptions(t,i,n,o,a),this._updateUVOptions(t,i,n,!1)}_updateSharedOptions(t,e,s,i,n){t.pass=n,t.alphaTest=s.alphaTest>0,t.forceFragmentPrecision=s.forceFragmentPrecision||"",t.chunks=s.chunks||"",t.blendType=s.blendType,t.forceUv1=s.forceUv1,t.separateAmbient=!1,t.screenSpace=i&&0!=(i&Xe),t.skin=i&&0!=(i&Ve),t.useInstancing=i&&0!=(i&He),t.useMorphPosition=i&&0!=(i&Ke),t.useMorphNormal=i&&0!=(i&$e),t.useMorphTextureBased=i&&0!=(i&Ze),t.nineSlicedMode=s.nineSlicedMode||0,e.clusteredLightingEnabled&&(t.clusteredLightingEnabled=!0,t.clusteredLightingCookiesEnabled=e.lighting.cookiesEnabled,t.clusteredLightingShadowsEnabled=e.lighting.shadowsEnabled,t.clusteredLightingShadowType=e.lighting.shadowType,t.clusteredLightingAreaLightsEnabled=e.lighting.areaLightsEnabled)}_updateUVOptions(t,e,s,i){let n=!1,a=!1,r=!1;s&&(n=0!=(s&Ne),a=0!=(s&We),r=0!=(s&Ge)),t.vertexColors=!1,this._mapXForms=[];for(const s in io)this._updateTexOptions(t,e,s,n,a,r,i);this._mapXForms=null}_updateMinOptions(t,e){t.opacityTint=1!==e.opacity&&e.blendType!==Pt,t.lights=[]}_updateMaterialOptions(t,e){const s=(e.diffuseTint||!e.diffuseMap&&!e.diffuseVertexColor)&&Fo(e.diffuse),i=!!(e.useMetalness||e.specularMap||e.sphereMap||e.cubeMap||(n=e.specular,0!==n.r||0!==n.g||0!==n.b)||e.enableGGXSpecular||e.clearCoat>0);var n;const a=i&&!e.useMetalness&&(e.specularTint||!e.specularMap&&!e.specularVertexColor)&&Fo(e.specular),r=!e.emissiveMap||Fo(e.emissive)&&e.emissiveTint,o=1!==e.emissiveIntensity,h=!!e.normalMap&&(e.normalMap.format===Fi||e.normalMap.type===$n);t.opacityTint=1!==e.opacity&&e.blendType!==Pt?1:0,t.blendMapsWithColors=!0,t.ambientTint=e.ambientTint,t.diffuseTint=s?2:0,t.specularTint=a?2:0,t.metalnessTint=e.useMetalness&&e.metalness<1?1:0,t.glossTint=1,t.emissiveTint=(r?2:0)+(o?1:0),t.alphaToCoverage=e.alphaToCoverage,t.normalizeNormalMap=e.normalizeNormalMap,t.ambientSH=!!e.ambientSH,t.useSpecular=i,t.emissiveFormat=e.emissiveMap?e.emissiveMap.type===Yn?1:e.emissiveMap.format===zi?2:0:null,t.lightMapFormat=e.lightMap?e.lightMap.type===Yn?1:e.lightMap.format===zi?2:0:null,t.specularAntialias=e.specularAntialias&&!!e.normalMap&&!!e.normalMap.mipmaps&&!h,t.conserveEnergy=e.conserveEnergy,t.opacityFadesSpecular=e.opacityFadesSpecular,t.alphaFade=e.alphaFade,t.occludeSpecular=e.occludeSpecular,t.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.occludeDirect=e.occludeDirect,t.shadingModel=e.shadingModel,t.fresnelModel=e.fresnelModel,t.packedNormal=h,t.fastTbn=e.fastTbn,t.cubeMapProjection=e.cubeMapProjection,t.customFragmentShader=e.customFragmentShader,t.refraction=!!e.refraction,t.useMetalness=e.useMetalness,t.enableGGXSpecular=e.enableGGXSpecular,t.msdf=!!e.msdfMap,t.twoSidedLighting=e.twoSidedLighting,t.pixelSnap=e.pixelSnap,t.aoMapUv=e.aoUvSet,t.diffuseDetail=!!e.diffuseMap,t.normalDetail=!!e.normalMap,t.diffuseDetailMode=e.diffuseDetailMode,t.detailModes=!!t.diffuseDetail,t.clearCoat=!!e.clearCoat,t.clearCoatTint=1!==e.clearCoat?1:0,t.clearCoatGlossiness=!!e.clearCoatGlossiness,t.clearCoatGlossTint=1!==e.clearCoatGlossiness?1:0}_updateEnvOptions(t,e,s,i){t.fog=s.useFog?i.fog:"none",t.gamma=s.useGammaTonemap?i.gammaCorrection:Ce,t.toneMap=s.useGammaTonemap?i.toneMapping:-1,t.useRgbm=s.emissiveMap&&s.emissiveMap.type===Yn||s.lightMap&&s.lightMap.type===Yn,t.fixSeams=!!s.cubeMap&&s.cubeMap.fixCubemapSeams,t.skyboxIntensity=1!==i.skyboxIntensity,t.useCubeMapRotation=!s.cubeMap&&s.useSkybox&&i&&i.skyboxRotation&&!i.skyboxRotation.equals(ft.IDENTITY);const n=s.shadingModel===Me;if(s.envAtlas&&!n?(t.reflectionSource="envAtlas",t.reflectionEncoding=s.envAtlas.encoding):s.cubeMap?(t.reflectionSource="cubeMap",t.reflectionEncoding=s.cubeMap.encoding):s.sphereMap?(t.reflectionSource="sphereMap",t.reflectionEncoding=s.sphereMap.encoding):s.useSkybox&&i.envAtlas&&!n?(t.reflectionSource="envAtlas",t.reflectionEncoding=i.envAtlas.encoding):(t.reflectionSource=null,t.reflectionEncoding=null),s.ambientSH&&!n)t.ambientSource="ambientSH",t.ambientEncoding=null;else{const e=s.envAtlas||(s.useSkybox&&i.envAtlas?i.envAtlas:null);e&&!n?(t.ambientSource="envAtlas",t.ambientEncoding=e.encoding):(t.ambientSource="constant",t.ambientEncoding=null)}}_updateLightOptions(t,e,s,i,n){if(t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.lightMapWithoutAmbient=!1,t.dirLightMap=!1,s&&(t.noShadow=0!=(s&Ue),0!=(s&je)&&(t.lightMapFormat=1,t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.lightMapWithoutAmbient=!e.lightMap,t.useRgbm=!0,0!=(s&qe)&&(t.dirLightMap=!0),0!=(s&Je)&&(t.lightMapWithoutAmbient=!1))),e.useLighting){const e=[],a=s?s>>16:1;i&&(this._collectLights(Xt,i[Xt],e,a),this._collectLights(Yt,i[Yt],e,a,n),this._collectLights(Kt,i[Kt],e,a,n)),t.lights=e}else t.lights=[];0===t.lights.length&&(t.noShadow=!0)}_updateTexOptions(t,e,s,i,n,a,r){const o=s+"Map",h=s+"VertexColor",l=s+"VertexColorChannel",c=o+"Channel",d=o+"Transform",u=o+"Uv";"light"!==s&&(t[o]=!1,t[c]="",t[d]=0,t[u]=0),t[h]=!1,t[l]="";const p="opacity"===s;if(p&&e.blendType===Pt&&0===e.alphaTest&&!e.alphaToCoverage)return t;if((!r||p)&&("height"!==s&&e[h]&&a&&(t[h]=e[h],t[l]=e[l],t.vertexColors=!0),e[o])){let s=!0;0!==e[u]||i||(s=!1),1!==e[u]||n||(s=!1),s&&(t[o]=!!e[o],t[d]=this._getMapTransformID(e.getUniform(d),e[u]),t[c]=e[c],t[u]=e[u])}}_collectLights(t,e,s,i,n){for(let n=0;n<e.length;n++){const a=e[n];if(a.enabled&&a.mask&i){if(t!==Xt&&a.isStatic)continue;s.push(a)}}if(n)for(let e=0;e<n.length;e++){const i=n[e];i._type===t&&s.push(i)}}_getMapTransformID(t,e){if(!t)return 0;let s=this._mapXForms[e];s||(s=[],this._mapXForms[e]=s);for(let e=0;e<s.length;e++)if(Do(s[e][0].value,t[0].value)&&Do(s[e][1].value,t[1].value))return e+1;return s.push(t)}}const ko={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",aoStrength:"number",aoMapRotation:"number",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseMapRotation:"number",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMapRotation:"number",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularMapRotation:"number",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",netalnessMapRotation:"number",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",glossMapRotation:"number",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatMapRotation:"number",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatGlossMapRotation:"number",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",clearCoatNormalMapRotation:"number",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveMapMapRotation:"number",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapRotation:"number",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapRotation:"number",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapRotation:"number",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityMapRotation:"number",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",lightMapRotation:"number",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture"},Bo=[];for(const t in ko){"texture"===ko[t]&&Bo.push(t)}const zo=[];for(const t in ko){"cubemap"===ko[t]&&zo.push(t)}const Uo={},Vo={};let No=new Set;class Wo extends Io{constructor(){super(),this._dirtyShader=!0,this._assetReferences={},this._validator=null,this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new Oo,this.reset()}reset(){Object.keys(Uo).forEach((t=>{this[`_${t}`]=Uo[t].value()})),this._chunks={},this._uniformCache={}}clone(){const t=new Wo;this._cloneInternal(t),Object.keys(Uo).forEach((e=>{t[e]=this[e]}));for(const e in this._chunks)this._chunks.hasOwnProperty(e)&&(t._chunks[e]=this._chunks[e]);return t}_setParameter(t,e){No.add(t),this.setParameter(t,e)}_setParameters(t){t.forEach((t=>{this._setParameter(t.name,t.value)}))}_processParameters(t){const e=this[t];e.forEach((t=>{No.has(t)||delete this.parameters[t]})),this[t]=No,No=e,No.clear()}_updateMap(t){const e=t+"Map",s=this[e];if(s){this._setParameter("texture_"+e,s);const t=e+"Transform",i=this.getUniform(t);i&&this._setParameters(i)}}_allocUniform(t,e){let s=this._uniformCache[t];return s||(s=e(),this._uniformCache[t]=s),s}getUniform(t,e,s){return Vo[t](this,e,s)}updateUniforms(t,e){const s=s=>this.getUniform(s,t,e);this._setParameter("material_ambient",s("ambient")),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",s("diffuse")),this.useMetalness?(!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness):this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_shininess",s("shininess")),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",s("emissive")),1!==this.emissiveIntensity&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===we&&this._setParameter(s("cubeMapProjectionBox"));for(const t in io)this._updateMap(t);this.aoStrength>0&&this._setParameter("material_aoStrength",this.aoStrength),this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&(this.shader=null,this.clearVariants())}updateEnvUniforms(t,e){const s=this.envAtlas||(this.useSkybox?e.envAtlas:null);s&&(this._setParameter("texture_envAtlas",s),this.useSkybox&&!e.skyboxRotation.equals(ft.IDENTITY)&&e._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",e._skyboxRotationMat3.data)),this._processParameters("_activeLightingParams")}updateShader(t,e,s,i,n,a){this.updateEnvUniforms(t,e);const r=n>ls&&n<=us;let o=r?ao.optionsContextMin:ao.optionsContext;r?this.shaderOptBuilder.updateMinRef(o,t,e,this,s,i,n,a):this.shaderOptBuilder.updateRef(o,t,e,this,s,i,n,a),this.onUpdateShader&&(o=this.onUpdateShader(o));const h=t.getProgramLibrary();this.shader=h.getProgram("standard",o),s||(this.clearVariants(),this.variants[0]=this.shader),this._dirtyShader=!1}destroy(){for(const t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,this._validator=null,super.destroy()}}Wo.TEXTURE_PARAMETERS=Bo,Wo.CUBEMAP_PARAMETERS=zo;const Go=(t,e)=>{Vo[t]=e},Ho=(t,e,s,i)=>{Object.defineProperty(Wo.prototype,t,{get:i||function(){return this[`_${t}`]},set:s}),Uo[t]={value:e}},jo=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);Ho(t.name,(()=>t.defaultValue),(function(t){const i=this[e];i!==t&&(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=t)}),t.getterFunc)},qo=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);Ho(t.name,(()=>t.defaultValue.clone()),(function(t){const i=this[e];i.equals(t)||(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=i.copy(t))}),t.getterFunc)},Xo=t=>t.defaultValue&&t.defaultValue.clone?qo(t):jo(t);function Yo(t,e,s,i,n,a){io[t]=s,Xo({name:`${t}Map`,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t!=!!e||t&&(t.type!==e.type||t.fixCubemapSeams!==e.fixCubemapSeams||t.format!==e.format)}),Xo({name:`${t}MapTiling`,defaultValue:new st(1,1)}),Xo({name:`${t}MapOffset`,defaultValue:new st(0,0)}),Xo({name:`${t}MapRotation`,defaultValue:0}),Xo({name:`${t}MapUv`,defaultValue:e}),s>0&&Xo({name:`${t}MapChannel`,defaultValue:i||(s>1?"rgb":"g")}),n&&(Xo({name:`${t}VertexColor`,defaultValue:!1}),s>0&&Xo({name:`${t}VertexColorChannel`,defaultValue:i||(s>1?"rgb":"g")})),a&&Xo({name:`${t}Mode`,defaultValue:Ae});const r=`${t}MapTiling`,o=`${t}MapOffset`,h=`${t}MapRotation`,l=`${t}MapTransform`;Go(l,((t,e,s)=>{const i=t[r],n=t[o],a=t[h];if(1===i.x&&1===i.y&&0===n.x&&0===n.y&&0===a)return null;const c=t._allocUniform(l,(()=>[{name:`texture_${l}0`,value:new Float32Array(3)},{name:`texture_${l}1`,value:new Float32Array(3)}])),d=Math.cos(a*V.DEG_TO_RAD),u=Math.sin(a*V.DEG_TO_RAD),p=c[0].value;p[0]=d*i.x,p[1]=-u*i.y,p[2]=n.x;const m=c[1].value;return m[0]=u*i.x,m[1]=d*i.y,m[2]=1-i.y-n.y,c}))}function Ko(t,e){Xo({name:t,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${t}`]}}),Go(t,((e,s,i)=>{const n=e._allocUniform(t,(()=>new Float32Array(3))),a=e[t];return e.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(a.r,2.2),n[1]=Math.pow(a.g,2.2),n[2]=Math.pow(a.b,2.2)):(n[0]=a.r,n[1]=a.g,n[2]=a.b),n}))}function $o(t,e,s){Xo({name:t,defaultValue:e,dirtyShaderFunc:(t,e)=>(0===t||1===t)!=(0===e||1===e)}),Go(t,s)}function Zo(t,e){Xo({name:t,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t==!!e}),Go(t,e)}function Jo(t,e){Object.defineProperty(Wo.prototype,e,{get:function(){return this[t]},set:function(e){this[t]=e}})}function Qo(t,e){Xo({name:t,defaultValue:e})}!function(){Ko("ambient",new J(.7,.7,.7)),Ko("diffuse",new J(1,1,1)),Ko("specular",new J(0,0,0)),Ko("emissive",new J(0,0,0)),$o("emissiveIntensity",1),$o("shininess",25,((t,e,s)=>t.shadingModel===Me?Math.pow(2,.01*t.shininess*11):.01*t.shininess)),$o("heightMapFactor",1,((t,e,s)=>.025*t.heightMapFactor)),$o("opacity",1),$o("alphaFade",1),$o("alphaTest",0),$o("bumpiness",1),$o("normalDetailMapBumpiness",1),$o("reflectivity",1),$o("occludeSpecularIntensity",1),$o("refraction",0),$o("refractionIndex",1/1.5),$o("metalness",1),$o("anisotropy",0),$o("clearCoat",0),$o("clearCoatGlossiness",1),$o("clearCoatBumpiness",1),$o("aoUvSet",0,null),Zo("ambientSH"),$o("aoStrength",1),Zo("cubeMapProjectionBox",((t,e,s)=>{const i=t._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=t.cubeMapProjectionBox.getMin(),a=i[0].value;a[0]=n.x,a[1]=n.y,a[2]=n.z;const r=t.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=r.x,o[1]=r.y,o[2]=r.z,i})),Object.defineProperty(Wo.prototype,"chunks",{get:function(){return this._dirtyShader=!0,this._chunks},set:function(t){this._dirtyShader=!0,this._chunks=t}}),Qo("ambientTint",!1),Qo("diffuseTint",!1),Qo("specularTint",!1),Qo("emissiveTint",!1),Qo("fastTbn",!1),Qo("specularAntialias",!1),Qo("useMetalness",!1),Qo("enableGGXSpecular",!1),Qo("occludeDirect",!1),Qo("normalizeNormalMap",!0),Qo("conserveEnergy",!0),Qo("opacityFadesSpecular",!0),Qo("occludeSpecular",Be),Qo("shadingModel",Te),Qo("fresnelModel",zt),Qo("cubeMapProjection",Se),Qo("customFragmentShader",null),Qo("forceFragmentPrecision",null),Qo("useFog",!0),Qo("useLighting",!0),Qo("useGammaTonemap",!0),Qo("useSkybox",!0),Qo("forceUv1",!1),Qo("pixelSnap",!1),Qo("twoSidedLighting",!1),Qo("nineSlicedMode",void 0),Yo("diffuse",0,3,"",!0),Yo("specular",0,3,"",!0),Yo("emissive",0,3,"",!0),Yo("normal",0,-1,"",!1),Yo("metalness",0,1,"",!0),Yo("gloss",0,1,"",!0),Yo("opacity",0,1,"a",!0),Yo("height",0,1,"",!1),Yo("ao",0,1,"",!0),Yo("light",1,3,"",!0),Yo("msdf",0,3,"",!1),Yo("diffuseDetail",0,3,"",!1,!0),Yo("normalDetail",0,-1,"",!1),Yo("clearCoat",0,1,"",!0),Yo("clearCoatGloss",0,1,"",!0),Yo("clearCoatNormal",0,-1,"",!1),Zo("cubeMap"),Zo("sphereMap"),Zo("envAtlas"),Jo("diffuseTint","diffuseMapTint"),Jo("specularTint","specularMapTint"),Jo("emissiveTint","emissiveMapTint"),Jo("aoVertexColor","aoMapVertexColor"),Jo("diffuseVertexColor","diffuseMapVertexColor"),Jo("specularVertexColor","specularMapVertexColor"),Jo("emissiveVertexColor","emissiveMapVertexColor"),Jo("metalnessVertexColor","metalnessMapVertexColor"),Jo("glossVertexColor","glossMapVertexColor"),Jo("opacityVertexColor","opacityMapVertexColor"),Jo("lightVertexColor","lightMapVertexColor");const t=[null,null,null,null,null,null];Ho("prefilteredCubemaps",(()=>t.slice()),(function(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const a=t[n]||null;e[n]!==a&&(e[n]=a,s=!0),i=i&&!!e[n]}s&&(i?this.envAtlas=Ro.generatePrefilteredAtlas(e,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();class th{constructor(t){this._device=t,this._cache={},this._generators={},this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};const e=new Wo;e.shaderOptBuilder.updateRef(this._defaultStdMatOption,t,{},e,null,[],hs,null,null),e.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,t,{},e,null,[],ds,null,null)}register(t,e){this.isRegistered(t)||(this._generators[t]=e)}unregister(t){this.isRegistered(t)&&delete this._generators[t]}isRegistered(t){return void 0!==this._generators[t]}getProgram(t,e){const s=this._generators[t];if(void 0===s)return null;const i=this._device,n=s.generateKey(e);let a=this._cache[n];if(!a){let r;e.lights&&(r=e.lights,e.lights=r.map((function(t){const e=t.clone?t.clone():t;return e.key=t.key,e}))),this.storeNewProgram(t,e),e.lights&&(e.lights=r),this._precached&&console.warn(`ProgramLibrary#getProgram: Cache miss for shader ${t} key ${n} after shaders precaching`);const o=s.createShaderDefinition(i,e);a=this._cache[n]=new sr(i,o)}return a}storeNewProgram(t,e){let s={};if("standard"===t){const t=this._getDefaultStdMatOptions(e.pass);for(const i in e)(e.hasOwnProperty(i)&&t[i]!==e[i]||"pass"===i)&&(s[i]=e[i])}else s=e;this._programsCollection.push(JSON.stringify({name:t,options:s}))}dumpPrograms(){let t="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";t+="let shaders = [",this._programsCollection[0]&&(t+="\n\t"+this._programsCollection[0]);for(let e=1;e<this._programsCollection.length;++e)t+=",\n\t"+this._programsCollection[e];t+="\n];\n",t+="device.programLib.precompile(shaders);\n",t+='if (pc.version != "'+o+'" || pc.revision != "'+h+'")\n',t+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const s=e.polyfill.document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),s.setAttribute("download","precompile-shaders.js"),s.style.display="none",e.polyfill.document.body.appendChild(s),s.click(),e.polyfill.document.body.removeChild(s)}clearCache(){const t=this._cache;this._isClearingCache=!0;for(const e in t)t.hasOwnProperty(e)&&t[e].destroy();this._cache={},this._isClearingCache=!1}removeFromCache(t){if(this._isClearingCache)return;const e=this._cache;for(const s in e)if(e.hasOwnProperty(s)&&e[s]===t){delete e[s];break}}_getDefaultStdMatOptions(t){return t>ls&&t<=us?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(t){if(t){const e=new Array(t.length);for(let s=0;s<t.length;s++){if("standard"===t[s].name){const e=t[s].options,i=this._getDefaultStdMatOptions(e.pass);for(const t in i)i.hasOwnProperty(t)&&void 0===e[t]&&(e[t]=i[t])}e[s]=this.getProgram(t[s].name,t[s].options)}}this._precached=!0}}class eh{constructor(){this.globalId=0,this.revision=0}equals(t){return this.globalId===t.globalId&&this.revision===t.revision}copy(t){this.globalId=t.globalId,this.revision=t.revision}reset(){this.globalId=0,this.revision=0}}let sh=0;class ih{constructor(){sh++,this.version=new eh,this.version.globalId=sh}increment(){this.version.revision++}}class nh{constructor(t){this.name=t,this.value=null,this.versionObject=new ih}setValue(t){this.value=t,this.versionObject.increment()}getValue(){return this.value}}class ah{constructor(t){this.name=t,this.variables=new Map}resolve(t){return this.variables.has(t)||this.variables.set(t,new nh(t)),this.variables.get(t)}removeValue(t){for(const e in this.variables){const s=this.variables[e];s.value===t&&(s.value=null)}}}class rh{constructor(t,e,s,i){if(this.locationId=i,this.scopeId=t.scope.resolve(e),this.version=new eh,"[0]"===e.substr(e.length-3))switch(s){case ca:s=Ta;break;case da:s=Ra;break;case ua:s=Ea;break;case pa:s=La}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}class oh{constructor(t,e){this.device=t,this.useAlpha=e,this.useMipmaps=t.webgl2,this.texture=null,this.renderTarget=null,this.textureId=null}destroy(){this.textureId=null,this.renderTarget&&(this.renderTarget.destroy(),this.renderTarget=null),this.texture&&(this.texture.destroy(),this.texture=null)}create(){if(!this.texture){const t=new Mr(this.device,{format:this.useAlpha?Li:Ei,minFilter:this.useMipmaps?_i:ui,magFilter:ui,addressU:Ws,addressV:Ws,mipmaps:this.useMipmaps});t.name="texture_grabPass",this.texture=t,this.renderTarget=new uh({colorBuffer:t,depth:!1}),this.textureId=this.device.scope.resolve(t.name),this.textureId.setValue(t)}}update(){const t=this.device,e=t.gl;if(!t.grabPassAvailable)return!1;const s=t.renderTarget,i=s&&s._glResolveFrameBuffer,n=this.texture,a=t.width,r=t.height;if(t.webgl2&&!t._tempMacChromeBlitFramebufferWorkaround&&a===n._width&&r===n._height){i&&s.resolve(!0);const n=s?s._glFrameBuffer:null,o=s?s._glResolveFrameBuffer||s._glFrameBuffer:null;t.initRenderTarget(this.renderTarget);const h=this.renderTarget._glFrameBuffer;e.bindFramebuffer(e.READ_FRAMEBUFFER,o),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,h),e.blitFramebuffer(0,0,a,r,0,0,a,r,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,n)}else{i&&(s.resolve(!0),e.bindFramebuffer(e.FRAMEBUFFER,s._glResolveFrameBuffer));const t=n._glFormat;e.copyTexImage2D(e.TEXTURE_2D,0,t,0,0,a,r,0),n._width=a,n._height=r,i&&e.bindFramebuffer(e.FRAMEBUFFER,s._glFrameBuffer)}return!0}generateMipmaps(){this.useMipmaps&&this.device.gl.generateMipmap(this.texture._glTarget)}prepareTexture(){const t=this.update();return t&&this.generateMipmaps(),t}}function hh(t,s){const i=t.width,n=t.height;if(i>s||n>s){const a=s/Math.max(i,n),r=Math.floor(i*a),o=Math.floor(n*a),h=e.polyfill.document.createElement("canvas");h.width=r,h.height=o;return h.getContext("2d").drawImage(t,0,0,i,n,0,0,r,o),h}return t}function lh(t,e){let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null);const n=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(s=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(i),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(n),s}class ch extends u{constructor(t,s={}){super(),this.canvas=t,this._enableAutoInstancing=!1,this.autoInstancingMaxObjects=16384,this.defaultFramebuffer=null,this._maxPixelRatio=1,this._width=0,this._height=0,this.updateClientRect(),this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this.contextLost=!1,this._contextLostHandler=t=>{t.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.contextLost=!1,this.fire("devicerestored")};const i=void 0===s.preferWebGl2||s.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];let n=null;s.stencil=!0;for(let e=0;e<i.length;e++)if(n=t.getContext(i[e],s),n){this.webgl2="webgl2"===i[e];break}if(!n)throw new Error("WebGL not supported");const r=C.browser&&!!e.polyfill.window.chrome,o=C.browser&&-1!==e.polyfill.navigator.appVersion.indexOf("Mac");let h,l,c,d,u;this.gl=n,this._tempEnableSafariTextureUnitWorkaround=C.browser&&!!e.polyfill.window.safari,this._tempMacChromeBlitFramebufferWorkaround=o&&r&&!s.alpha,this.webgl2||function(t){if(t.getSupportedExtensions){if(-1!=t.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(t.getExtension&&t.getExtension("OES_vertex_array_object"))return;if(t.getSupportedExtensions){var e=t.getSupportedExtensions;t.getSupportedExtensions=function(){var t=e.call(this)||[];return t.push("OES_vertex_array_object"),t}}var s=t.getExtension;t.getExtension=function(e){return"OES_vertex_array_object"==e?(t.__OESVertexArrayObject||(t.__OESVertexArrayObject=new a(t)),t.__OESVertexArrayObject):s?s.call(this,e):null}}(n),t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:ni|ai},this.glAddress=[n.REPEAT,n.CLAMP_TO_EDGE,n.MIRRORED_REPEAT],this.glBlendEquation=[n.FUNC_ADD,n.FUNC_SUBTRACT,n.FUNC_REVERSE_SUBTRACT,this.webgl2?n.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:n.FUNC_ADD,this.webgl2?n.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:n.FUNC_ADD],this.glBlendFunction=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA],this.glComparison=[n.NEVER,n.LESS,n.EQUAL,n.LEQUAL,n.GREATER,n.NOTEQUAL,n.GEQUAL,n.ALWAYS],this.glStencilOp=[n.KEEP,n.ZERO,n.REPLACE,n.INCR,n.INCR_WRAP,n.DECR,n.DECR_WRAP,n.INVERT],this.glClearFlag=[0,n.COLOR_BUFFER_BIT,n.DEPTH_BUFFER_BIT,n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT],this.glCull=[0,n.BACK,n.FRONT,n.FRONT_AND_BACK],this.glFilter=[n.NEAREST,n.LINEAR,n.NEAREST_MIPMAP_NEAREST,n.NEAREST_MIPMAP_LINEAR,n.LINEAR_MIPMAP_NEAREST,n.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[n.POINTS,n.LINES,n.LINE_LOOP,n.LINE_STRIP,n.TRIANGLES,n.TRIANGLE_STRIP,n.TRIANGLE_FAN],this.glType=[n.BYTE,n.UNSIGNED_BYTE,n.SHORT,n.UNSIGNED_SHORT,n.INT,n.UNSIGNED_INT,n.FLOAT],this.pcUniformType={},this.pcUniformType[n.BOOL]=ha,this.pcUniformType[n.INT]=la,this.pcUniformType[n.FLOAT]=ca,this.pcUniformType[n.FLOAT_VEC2]=da,this.pcUniformType[n.FLOAT_VEC3]=ua,this.pcUniformType[n.FLOAT_VEC4]=pa,this.pcUniformType[n.INT_VEC2]=ma,this.pcUniformType[n.INT_VEC3]=fa,this.pcUniformType[n.INT_VEC4]=_a,this.pcUniformType[n.BOOL_VEC2]=ga,this.pcUniformType[n.BOOL_VEC3]=ya,this.pcUniformType[n.BOOL_VEC4]=va,this.pcUniformType[n.FLOAT_MAT2]=xa,this.pcUniformType[n.FLOAT_MAT3]=ba,this.pcUniformType[n.FLOAT_MAT4]=Sa,this.pcUniformType[n.SAMPLER_2D]=wa,this.pcUniformType[n.SAMPLER_CUBE]=Ma,this.webgl2&&(this.pcUniformType[n.SAMPLER_2D_SHADOW]=Aa,this.pcUniformType[n.SAMPLER_CUBE_SHADOW]=Ca,this.pcUniformType[n.SAMPLER_3D]=Pa),this.targetToSlot={},this.targetToSlot[n.TEXTURE_2D]=0,this.targetToSlot[n.TEXTURE_CUBE_MAP]=1,this.targetToSlot[n.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[ha]=function(t,e){t.value!==e&&(n.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[la]=this.commitFunction[ha],this.commitFunction[ca]=function(t,e){t.value!==e&&(n.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[da]=function(t,e){u=t.value,h=e[0],l=e[1],u[0]===h&&u[1]===l||(n.uniform2fv(t.locationId,e),u[0]=h,u[1]=l)},this.commitFunction[ua]=function(t,e){u=t.value,h=e[0],l=e[1],c=e[2],u[0]===h&&u[1]===l&&u[2]===c||(n.uniform3fv(t.locationId,e),u[0]=h,u[1]=l,u[2]=c)},this.commitFunction[pa]=function(t,e){u=t.value,h=e[0],l=e[1],c=e[2],d=e[3],u[0]===h&&u[1]===l&&u[2]===c&&u[3]===d||(n.uniform4fv(t.locationId,e),u[0]=h,u[1]=l,u[2]=c,u[3]=d)},this.commitFunction[ma]=function(t,e){u=t.value,h=e[0],l=e[1],u[0]===h&&u[1]===l||(n.uniform2iv(t.locationId,e),u[0]=h,u[1]=l)},this.commitFunction[ga]=this.commitFunction[ma],this.commitFunction[fa]=function(t,e){u=t.value,h=e[0],l=e[1],c=e[2],u[0]===h&&u[1]===l&&u[2]===c||(n.uniform3iv(t.locationId,e),u[0]=h,u[1]=l,u[2]=c)},this.commitFunction[ya]=this.commitFunction[fa],this.commitFunction[_a]=function(t,e){u=t.value,h=e[0],l=e[1],c=e[2],d=e[3],u[0]===h&&u[1]===l&&u[2]===c&&u[3]===d||(n.uniform4iv(t.locationId,e),u[0]=h,u[1]=l,u[2]=c,u[3]=d)},this.commitFunction[va]=this.commitFunction[_a],this.commitFunction[xa]=function(t,e){n.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[ba]=function(t,e){n.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[Sa]=function(t,e){n.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[Ta]=function(t,e){n.uniform1fv(t.locationId,e)},this.commitFunction[Ra]=function(t,e){n.uniform2fv(t.locationId,e)},this.commitFunction[Ea]=function(t,e){n.uniform3fv(t.locationId,e)},this.commitFunction[La]=function(t,e){n.uniform4fv(t.locationId,e)},this.scope=new ah("Device"),this.programLib=new th(this);for(const t in ro)this.programLib.register(t,ro[t]);this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let p=this.vertexUniformsCount;p-=16,p-=8,p-=1,p-=16,this.boneLimit=Math.floor(p/3),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let t=en;t<=hn;t++)this._primsPerFrame[t]=0;this._renderTargetCreationTime=0,this._vram={tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=lh(n,n.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=lh(n,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&this.maxVertexTextures>=2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.grabPassAvailable=!0,this.grabPass=new oh(this,s.alpha),this.grabPass.create(),Ja.init(this),this.areaLightLutFormat=Li,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=ki:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=zi)}destroy(){console.log("gra destroy");const t=this.gl;this.grabPass.destroy(),this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.scope=null,this.canvas=null,this.gl=null}toJSON(t){}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),a=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),r=s.precision>0&&n.precision>0,o=i.precision>0&&a.precision>0;r||(e=o?"mediump":"lowp")}return e}initializeExtensions(){const t=this.gl;let e;const s={};t.getSupportedExtensions().forEach((t=>{s[t]=!0}));const i=function(){for(let e=0;e<arguments.length;e++)if(s.hasOwnProperty(arguments[e]))return t.getExtension(arguments[e]);return null};this.webgl2?(this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=i("EXT_color_buffer_float"),this.extDisjointTimerQuery=i("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")):(this.extBlendMinmax=i("EXT_blend_minmax"),this.extDrawBuffers=i("EXT_draw_buffers"),this.extInstancing=i("ANGLE_instanced_arrays"),this.extInstancing&&(e=this.extInstancing,t.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),t.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),t.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)),this.extStandardDerivatives=i("OES_standard_derivatives"),this.extTextureFloat=i("OES_texture_float"),this.extTextureHalfFloat=i("OES_texture_half_float"),this.extTextureLod=i("EXT_shader_texture_lod"),this.extUintElement=i("OES_element_index_uint"),this.extVertexArrayObject=i("OES_vertex_array_object"),this.extVertexArrayObject&&(e=this.extVertexArrayObject,t.createVertexArray=e.createVertexArrayOES.bind(e),t.deleteVertexArray=e.deleteVertexArrayOES.bind(e),t.isVertexArray=e.isVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)),this.extColorBufferFloat=null,this.extDisjointTimerQuery=null),this.extDebugRendererInfo=i("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=i("OES_texture_float_linear"),this.extTextureHalfFloatLinear=i("OES_texture_half_float_linear"),this.extFloatBlend=i("EXT_float_blend"),this.extTextureFilterAnisotropic=i("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=i("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=i("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=i("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=i("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=i("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=i("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=i("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=i("EXT_color_buffer_half_float"),this.supportsInstancing=!!this.extInstancing}initializeCapabilities(){const t=this.gl;let e;this.maxPrecision=this.precision=this.getPrecision();const s=t.getContextAttributes();this.supportsMsaa=s.antialias,this.supportsStencil=s.stencil,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(e=this.extDrawBuffers,this.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"",e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES),this.maxSamples=this.webgl2?t.getParameter(t.MAX_SAMPLES):1,this.supportsAreaLights=this.webgl2||!C.android,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){const t=this.gl;this.blending=!1,t.disable(t.BLEND),this.blendSrc=js,this.blendDst=Hs,this.blendSrcAlpha=js,this.blendDstAlpha=Hs,this.separateAlphaBlend=!1,this.blendEquation=Zs,this.blendAlphaEquation=Zs,this.separateAlphaEquation=!1,t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,t.colorMask(!0,!0,!0,!0),this.cullMode=hi,t.enable(t.CULL_FACE),t.cullFace(t.BACK),this.depthTest=!0,t.enable(t.DEPTH_TEST),this.depthFunc=vi,t.depthFunc(t.LEQUAL),this.depthWrite=!0,t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=xi,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=Wn,this.stencilZfailFront=this.stencilZfailBack=Wn,this.stencilZpassFront=this.stencilZpassBack=Wn,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearRed=0,this.clearBlue=0,this.clearGreen=0,this.clearAlpha=0,t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initializeContextCaches(){this.vertexShaderCache={},this.fragmentShaderCache={},this._vaoMap=new Map,this.boundVao=null,this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.renderTarget=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(let t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null])}loseContext(){for(const t of this.shaders)t.loseContext();for(this.grabPass.destroy();this.textures.length>0;){const t=this.textures[0];this.destroyTexture(t),t.dirtyAll()}for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)this.compileAndLinkShader(t);for(const t of this.buffers)t.unlock();this.grabPass.create()}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}setViewport(t,e,s,i){this.vx===t&&this.vy===e&&this.vw===s&&this.vh===i||(this.gl.viewport(t,e,s,i),this.vx=t,this.vy=e,this.vw=s,this.vh=i)}setScissor(t,e,s,i){this.sx===t&&this.sy===e&&this.sw===s&&this.sh===i||(this.gl.scissor(t,e,s,i),this.sx=t,this.sy=e,this.sw=s,this.sh=i)}getProgramLibrary(){return this.programLib}setProgramLibrary(t){this.programLib=t}setFramebuffer(t){this.activeFramebuffer!==t&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.activeFramebuffer=t)}_checkFbo(){const t=this.gl;switch(t.checkFramebufferStatus(t.FRAMEBUFFER)){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");case t.FRAMEBUFFER_COMPLETE:}}copyRenderTarget(t,e,s,i){const n=this.gl;if(!this.webgl2&&i)return!1;if(s)if(e){if(!t._colorBuffer||!e._colorBuffer)return!1;if(t._colorBuffer._format!==e._colorBuffer._format)return!1}else if(!t._colorBuffer)return!1;if(i){if(!t._depthBuffer||!e._depthBuffer)return!1;if(t._depthBuffer._format!==e._depthBuffer._format)return!1}if(this.webgl2&&e){const a=this.renderTarget;this.renderTarget=e,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,t?t._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,e._glFrameBuffer);const r=t?t.width:e.width,o=t?t.height:e.height;n.blitFramebuffer(0,0,r,o,0,0,r,o,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=a,n.bindFramebuffer(n.FRAMEBUFFER,a?a._glFrameBuffer:null)}else{const s=this.getCopyShader();this.constantTexSource.setValue(t._colorBuffer),er(this,e,s)}return!0}initRenderTarget(t){if(t._glFrameBuffer)return;t._device=this;const e=this.gl;t._glFrameBuffer=e.createFramebuffer(),this.setFramebuffer(t._glFrameBuffer);const s=t._colorBuffer;s&&(s._glTexture||(s._width=Math.min(s.width,this.maxRenderBufferSize),s._height=Math.min(s.height,this.maxRenderBufferSize),this.setTexture(s,0)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,s._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,s._glTexture,0));const i=t._depthBuffer;if(i&&this.webgl2)i._glTexture||(i._width=Math.min(i.width,this.maxRenderBufferSize),i._height=Math.min(i.height,this.maxRenderBufferSize),this.setTexture(i,0)),t._stencil?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,i._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,t._depthBuffer._glTexture,0):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,i._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,t._depthBuffer._glTexture,0);else if(t._depth){t._samples>1&&this.webgl2||(t._glDepthBuffer||(t._glDepthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glDepthBuffer),t._stencil?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t._glDepthBuffer)):(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t._glDepthBuffer)),e.bindRenderbuffer(e.RENDERBUFFER,null))}this.webgl2&&t._samples>1&&(t._glResolveFrameBuffer=t._glFrameBuffer,t._glFrameBuffer=e.createFramebuffer(),this.setFramebuffer(t._glFrameBuffer),s&&(t._glMsaaColorBuffer||(t._glMsaaColorBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glMsaaColorBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,s._glInternalFormat,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,t._glMsaaColorBuffer)),t._depth&&(t._glMsaaDepthBuffer||(t._glMsaaDepthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glMsaaDepthBuffer),t._stencil?(e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,e.DEPTH24_STENCIL8,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t._glMsaaDepthBuffer)):(e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,e.DEPTH_COMPONENT32F,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t._glMsaaDepthBuffer)))),this.targets.push(t)}getCopyShader(){return this._copyShader||(this._copyShader=fr(this,ir.fullscreenQuadVS,ir.outputTex2DPS,"outputTex2D")),this._copyShader}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let t=0;t<this.textureUnits.length;++t)for(let e=0;e<3;++e)this.textureUnits[t][e]=null;const t=this.renderTarget;t?t._glFrameBuffer?this.setFramebuffer(t._glFrameBuffer):this.initRenderTarget(t):this.setFramebuffer(this.defaultFramebuffer)}updateEnd(){const t=this.gl;this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null));const e=this.renderTarget;if(e){const s=e._colorBuffer;s&&s._glTexture&&s.mipmaps&&(s.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(s),t.generateMipmap(s._glTarget)),this.webgl2&&e._samples>1&&e.autoResolve&&e.resolve()}}initializeTexture(t){const e=this.gl;let s;switch(t._glTexture=e.createTexture(),t._glTarget=t._cubemap?e.TEXTURE_CUBE_MAP:t._volume?e.TEXTURE_3D:e.TEXTURE_2D,t._format){case Mi:t._glFormat=e.ALPHA,t._glInternalFormat=e.ALPHA,t._glPixelType=e.UNSIGNED_BYTE;break;case Ti:t._glFormat=e.LUMINANCE,t._glInternalFormat=e.LUMINANCE,t._glPixelType=e.UNSIGNED_BYTE;break;case Ai:t._glFormat=e.LUMINANCE_ALPHA,t._glInternalFormat=e.LUMINANCE_ALPHA,t._glPixelType=e.UNSIGNED_BYTE;break;case Ci:t._glFormat=e.RGB,t._glInternalFormat=e.RGB,t._glPixelType=e.UNSIGNED_SHORT_5_6_5;break;case Pi:t._glFormat=e.RGBA,t._glInternalFormat=e.RGBA,t._glPixelType=e.UNSIGNED_SHORT_5_5_5_1;break;case Ri:t._glFormat=e.RGBA,t._glInternalFormat=e.RGBA,t._glPixelType=e.UNSIGNED_SHORT_4_4_4_4;break;case Ei:t._glFormat=e.RGB,t._glInternalFormat=this.webgl2?e.RGB8:e.RGB,t._glPixelType=e.UNSIGNED_BYTE;break;case Li:t._glFormat=e.RGBA,t._glInternalFormat=this.webgl2?e.RGBA8:e.RGBA,t._glPixelType=e.UNSIGNED_BYTE;break;case Ii:s=this.extCompressedTextureS3TC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Di:s=this.extCompressedTextureS3TC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Fi:s=this.extCompressedTextureS3TC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case ji:s=this.extCompressedTextureETC1,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_ETC1_WEBGL;break;case Yi:s=this.extCompressedTexturePVRTC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case Ki:s=this.extCompressedTexturePVRTC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case $i:s=this.extCompressedTexturePVRTC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case Zi:s=this.extCompressedTexturePVRTC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case qi:s=this.extCompressedTextureETC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB8_ETC2;break;case Xi:s=this.extCompressedTextureETC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA8_ETC2_EAC;break;case Ji:s=this.extCompressedTextureASTC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case Qi:s=this.extCompressedTextureATC,t._glFormat=e.RGB,t._glInternalFormat=s.COMPRESSED_RGB_ATC_WEBGL;break;case tn:s=this.extCompressedTextureATC,t._glFormat=e.RGBA,t._glInternalFormat=s.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case Oi:s=this.extTextureHalfFloat,t._glFormat=e.RGB,this.webgl2?(t._glInternalFormat=e.RGB16F,t._glPixelType=e.HALF_FLOAT):(t._glInternalFormat=e.RGB,t._glPixelType=s.HALF_FLOAT_OES);break;case ki:s=this.extTextureHalfFloat,t._glFormat=e.RGBA,this.webgl2?(t._glInternalFormat=e.RGBA16F,t._glPixelType=e.HALF_FLOAT):(t._glInternalFormat=e.RGBA,t._glPixelType=s.HALF_FLOAT_OES);break;case Bi:t._glFormat=e.RGB,this.webgl2?t._glInternalFormat=e.RGB32F:t._glInternalFormat=e.RGB,t._glPixelType=e.FLOAT;break;case zi:t._glFormat=e.RGBA,this.webgl2?t._glInternalFormat=e.RGBA32F:t._glInternalFormat=e.RGBA,t._glPixelType=e.FLOAT;break;case Ui:t._glFormat=e.RED,t._glInternalFormat=e.R32F,t._glPixelType=e.FLOAT;break;case Vi:this.webgl2?(t._glFormat=e.DEPTH_COMPONENT,t._glInternalFormat=e.DEPTH_COMPONENT32F,t._glPixelType=e.FLOAT):(t._glFormat=e.DEPTH_COMPONENT,t._glInternalFormat=e.DEPTH_COMPONENT,t._glPixelType=e.UNSIGNED_SHORT);break;case Ni:t._glFormat=e.DEPTH_STENCIL,t._glInternalFormat=e.DEPTH24_STENCIL8,t._glPixelType=e.UNSIGNED_INT_24_8;break;case Wi:t._glFormat=e.RGB,t._glInternalFormat=e.R11F_G11F_B10F,t._glPixelType=e.UNSIGNED_INT_10F_11F_11F_REV;break;case Gi:t._glFormat=e.RGB,t._glInternalFormat=e.SRGB8,t._glPixelType=e.UNSIGNED_BYTE;break;case Hi:t._glFormat=e.RGBA,t._glInternalFormat=e.SRGB8_ALPHA8,t._glPixelType=e.UNSIGNED_BYTE}this.textures.push(t)}destroyTexture(t){if(t._glTexture){const e=this.textures.indexOf(t);-1!==e&&this.textures.splice(e,1),this.scope.removeValue(t);for(let e=0;e<this.textureUnits.length;e++){const s=this.textureUnits[e];for(let e=0;e<s.length;e++)s[e]===t._glTexture&&(s[e]=null)}this.gl.deleteTexture(t._glTexture),delete t._glTexture,delete t._glTarget,delete t._glFormat,delete t._glInternalFormat,delete t._glPixelType,this._vram.tex-=t._gpuSize}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}_isBrowserInterface(t){return t&&void 0!==t.width}uploadTexture(t){const s=this.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let i,n,a=0;const r=Math.log2(Math.max(t._width,t._height))+1;for(;t._levels[a]||0===a;)if(t._needsUpload||0!==a){if(a&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(i=t._levels[a],1===a&&!t._compressed&&t._levels.length<r&&(s.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._cubemap){let r;if(this._isBrowserInterface(i[0]))for(r=0;r<6;r++){if(!t._levelsUpdated[0][r])continue;let n=i[r];n instanceof e.polyfill.HTMLImageElement&&(n.width>this.maxCubeMapSize||n.height>this.maxCubeMapSize)&&(n=hh(n,this.maxCubeMapSize),0===a&&(t._width=n.width,t._height=n.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,t._glInternalFormat,t._glFormat,t._glPixelType,n)}else for(n=1/Math.pow(2,a),r=0;r<6;r++){if(!t._levelsUpdated[0][r])continue;const e=i[r];t._compressed?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,t._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,e):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+r,a,t._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,t._glFormat,t._glPixelType,e))}}else t._volume?(n=1/Math.pow(2,a),t._compressed?s.compressedTexImage3D(s.TEXTURE_3D,a,t._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,a,t._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,t._glFormat,t._glPixelType,i))):(this._isBrowserInterface(i)?(i instanceof e.polyfill.HTMLImageElement&&(i.width>this.maxTextureSize||i.height>this.maxTextureSize)&&(i=hh(i,this.maxTextureSize),0===a&&(t._width=i.width,t._height=i.height)),this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,a,t._glInternalFormat,t._glFormat,t._glPixelType,i)):(n=1/Math.pow(2,a),t._compressed?s.compressedTexImage2D(s.TEXTURE_2D,a,t._glInternalFormat,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,a,t._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,t._glFormat,t._glPixelType,i))),t._mipmapsUploaded=0!==a);a++}else a++;if(t._needsUpload)if(t._cubemap)for(let e=0;e<6;e++)t._levelsUpdated[0][e]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&t._mipmaps&&t._needsMipmapsUpload&&(t.pot||this.webgl2)&&1===t._levels.length&&(s.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&(this._vram.tex-=t._gpuSize),t._gpuSize=t.gpuSize,this._vram.tex+=t._gpuSize}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t._glTarget,s=t._glTexture,i=this.textureUnit,n=this.targetToSlot[e];this.textureUnits[i][n]!==s&&(this.gl.bindTexture(e,s),this.textureUnits[i][n]=s)}bindTextureOnUnit(t,e){const s=t._glTarget,i=t._glTexture,n=this.targetToSlot[s];this.textureUnits[e][n]!==i&&(this.activeTexture(e),this.gl.bindTexture(s,i),this.textureUnits[e][n]=i)}setTextureParameters(t){const e=this.gl,s=t._parameterFlags,i=t._glTarget;if(1&s){let s=t._minFilter;(!t.pot&&!this.webgl2||!t._mipmaps||t._compressed&&1===t._levels.length)&&(s===pi||s===mi?s=di:s!==fi&&s!==_i||(s=ui)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,this.glFilter[s])}if(2&s&&e.texParameteri(i,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&s&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:Ws])),8&s&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:Ws])),16&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&e.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))}}setTexture(t,e){if(t._glTexture||this.initializeTexture(t),t._parameterFlags>0||t._needsUpload||t._needsMipmapsUpload||t===this.grabPass.texture){this.activeTexture(e),this.bindTexture(t),t._parameterFlags&&(this.setTextureParameters(t),t._parameterFlags=0);t===this.grabPass.texture&&this.grabPass.prepareTexture()||!t._needsUpload&&!t._needsMipmapsUpload||(this.uploadTexture(t),t._needsUpload=!1,t._needsMipmapsUpload=!1)}else this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,s;const i=t.length>1;if(i){e="";for(let s=0;s<t.length;s++){const i=t[s];e+=i.id+i.format.renderingingHash}s=this._vaoMap.get(e)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<t.length;e++){const s=t[e];n.bindBuffer(n.ARRAY_BUFFER,s.bufferId);const i=s.format.elements;for(let t=0;t<i.length;t++){const e=i[t],a=Oa[e.name];n.vertexAttribPointer(a,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),n.enableVertexAttribArray(a),s.instancing&&n.vertexAttribDivisor(a,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(e,s)}return s}setBuffers(){const t=this.gl;let e;if(1===this.vertexBuffers.length){const t=this.vertexBuffers[0];t._vao||(t._vao=this.createVertexArray(this.vertexBuffers)),e=t._vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0;const s=this.indexBuffer?this.indexBuffer.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s)}draw(t,e,s){const i=this.gl;let n,a,r,o,h,l,c,d;const u=this.shader;if(!u)return;const p=u.samplers,m=u.uniforms;s||this.setBuffers();let f=0;for(let t=0,e=p.length;t<e;t++)if(n=p[t],a=n.scopeId.value,a)if(a instanceof Mr)r=a,this.setTexture(r,f),n.slot!==f&&(i.uniform1i(n.locationId,f),n.slot=f),f++;else{n.array.length=0,o=a.length;for(let t=0;t<o;t++)r=a[t],this.setTexture(r,f),n.array[t]=f,f++;i.uniform1iv(n.locationId,n.array)}for(let t=0,e=m.length;t<e;t++)h=m[t],l=h.scopeId,c=h.version,d=l.versionObject.version,c.globalId===d.globalId&&c.revision===d.revision||(c.globalId=d.globalId,c.revision=d.revision,null!==l.value&&this.commitFunction[h.dataType](h,l.value));this.webgl2&&this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),i.beginTransformFeedback(i.POINTS));const _=this.glPrimitive[t.type],g=t.count;if(t.indexed){const s=this.indexBuffer,n=s.glFormat,a=t.base*s.bytesPerIndex;e>0?i.drawElementsInstanced(_,g,n,a,e):i.drawElements(_,g,n,a)}else{const s=t.base;e>0?i.drawArraysInstanced(_,s,g,e):i.drawArrays(_,s,g)}this.webgl2&&this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(t){const e=this.defaultClearOptions,s=null==(t=t||e).flags?e.flags:t.flags;if(0!==s){const i=this.gl;if(s&ni){const s=null==t.color?e.color:t.color;this.setClearColor(s[0],s[1],s[2],s[3])}if(s&ai){const s=null==t.depth?e.depth:t.depth;this.setClearDepth(s),this.depthWrite||i.depthMask(!0)}if(s&ri){const s=null==t.stencil?e.stencil:t.stencil;this.setClearStencil(s)}i.clear(this.glClearFlag[s]),s&ai&&(this.depthWrite||i.depthMask(!1))}}readPixels(t,e,s,i,n){const a=this.gl;a.readPixels(t,e,s,i,a.RGBA,a.UNSIGNED_BYTE,n)}setClearDepth(t){t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t)}setClearColor(t,e,s,i){t===this.clearRed&&e===this.clearGreen&&s===this.clearBlue&&i===this.clearAlpha||(this.gl.clearColor(t,e,s,i),this.clearRed=t,this.clearGreen=e,this.clearBlue=s,this.clearAlpha=i)}setClearStencil(t){t!==this.clearStencil&&(this.gl.clearStencil(t),this.clearStencil=t)}setRenderTarget(t){this.renderTarget=t}getRenderTarget(){return this.renderTarget}getDepthTest(){return this.depthTest}setDepthTest(t){if(this.depthTest!==t){const e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.depthTest=t}}setDepthFunc(t){this.depthFunc!==t&&(this.gl.depthFunc(this.glComparison[t]),this.depthFunc=t)}getDepthWrite(){return this.depthWrite}setDepthWrite(t){this.depthWrite!==t&&(this.gl.depthMask(t),this.depthWrite=t)}setColorWrite(t,e,s,i){this.writeRed===t&&this.writeGreen===e&&this.writeBlue===s&&this.writeAlpha===i||(this.gl.colorMask(t,e,s,i),this.writeRed=t,this.writeGreen=e,this.writeBlue=s,this.writeAlpha=i)}setAlphaToCoverage(t){this.webgl2&&this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setDepthBias(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))}setDepthBiasValues(t,e){this.gl.polygonOffset(e,t)}getBlending(){return this.blending}setBlending(t){if(this.blending!==t){const e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.blending=t}}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s||this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){this.gl.stencilFunc(this.glComparison[t],e,s),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=s}}setStencilFuncFront(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[t],e,s),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=s}}setStencilFuncBack(t,e,s){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[t],e,s),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=s}}setStencilOperation(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===i&&this.stencilWriteMaskBack===i||(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(t,e,s,i){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendFunction(t,e){(this.blendSrc!==t||this.blendDst!==e||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[e]),this.blendSrc=t,this.blendDst=e,this.separateAlphaBlend=!1)}setBlendFunctionSeparate(t,e,s,i){this.blendSrc===t&&this.blendDst===e&&this.blendSrcAlpha===s&&this.blendDstAlpha===i&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[e],this.glBlendFunction[s],this.glBlendFunction[i]),this.blendSrc=t,this.blendDst=e,this.blendSrcAlpha=s,this.blendDstAlpha=i,this.separateAlphaBlend=!0)}setBlendEquation(t){(this.blendEquation!==t||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[t]),this.blendEquation=t,this.separateAlphaEquation=!1)}setBlendEquationSeparate(t,e){this.blendEquation===t&&this.blendAlphaEquation===e&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[e]),this.blendEquation=t,this.blendAlphaEquation=e,this.separateAlphaEquation=!0)}setCullMode(t){if(this.cullMode!==t){if(t===oi)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===oi&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}getCullMode(){return this.cullMode}setIndexBuffer(t){this.indexBuffer=t}setVertexBuffer(t){t&&this.vertexBuffers.push(t)}compileShaderSource(t,e){const s=this.gl;let i=e?this.vertexShaderCache[t]:this.fragmentShaderCache[t];return i||(i=s.createShader(e?s.VERTEX_SHADER:s.FRAGMENT_SHADER),s.shaderSource(i,t),s.compileShader(i),e?this.vertexShaderCache[t]=i:this.fragmentShaderCache[t]=i),i}compileAndLinkShader(t){const e=t.definition,s=this.compileShaderSource(e.vshader,!0),i=this.compileShaderSource(e.fshader,!1),n=this.gl,a=n.createProgram();n.attachShader(a,s),n.attachShader(a,i);const r=e.attributes;if(this.webgl2&&e.useTransformFeedback){const t=[];for(const e in r)r.hasOwnProperty(e)&&t.push("out_"+e);n.transformFeedbackVaryings(a,t,n.INTERLEAVED_ATTRIBS)}const o={};for(const t in r)if(r.hasOwnProperty(t)){const e=r[t],s=Oa[e];o[s]=t,n.bindAttribLocation(a,s,t)}n.linkProgram(a),t._glVertexShader=s,t._glFragmentShader=i,t._glProgram=a}createShader(t){this.compileAndLinkShader(t),this.shaders.push(t)}destroyShader(t){const e=this.shaders.indexOf(t);-1!==e&&this.shaders.splice(e,1),t._glProgram&&(this.gl.deleteProgram(t._glProgram),t._glProgram=null,this.removeShaderFromCache(t))}_isShaderCompiled(t,e,s,i){const n=this.gl;if(!n.getShaderParameter(e,n.COMPILE_STATUS)){const t=n.getShaderInfoLog(e),[a,r]=this._processError(s,t),o=`Failed to compile ${i} shader:\n\n${t}\n${a}`;return console.error(o),!1}return!0}_processError(t,e){if(!t)return"";const s=t.split("\n"),i={};let n="",a=0,r=s.length;if(e&&e.startsWith("ERROR:")){const t=e.match(/^ERROR:\s([0-9]+):([0-9]+):\s*(.+)/);t&&(i.message=t[3],i.line=parseInt(t[2],10),a=Math.max(0,i.line-6),r=Math.min(s.length,i.line+5))}for(let t=a;t<r;t++)n+=t+1+":\t"+s[t]+"\n";return i.source=t,[n,i]}postLink(t){const e=this.gl,s=t._glProgram,i=t.definition;if(!this._isShaderCompiled(t,t._glVertexShader,i.vshader,"vertex"))return!1;if(!this._isShaderCompiled(t,t._glFragmentShader,i.fshader,"fragment"))return!1;if(!e.getProgramParameter(s,e.LINK_STATUS)){const t="Failed to link shader program. Error: "+e.getProgramInfoLog(s);return console.error(t),!1}let n,a,r,o;n=0;const h=e.getProgramParameter(s,e.ACTIVE_ATTRIBUTES);for(;n<h;)a=e.getActiveAttrib(s,n++),r=e.getAttribLocation(s,a.name),void 0===i.attributes[a.name]&&console.error(`Vertex shader attribute "${a.name}" is not mapped to a semantic in shader definition.`),o=new rh(this,i.attributes[a.name],this.pcUniformType[a.type],r),t.attributes.push(o);n=0;const l=e.getProgramParameter(s,e.ACTIVE_UNIFORMS);for(;n<l;)a=e.getActiveUniform(s,n++),r=e.getUniformLocation(s,a.name),o=new rh(this,a.name,this.pcUniformType[a.type],r),a.type===e.SAMPLER_2D||a.type===e.SAMPLER_CUBE||this.webgl2&&(a.type===e.SAMPLER_2D_SHADOW||a.type===e.SAMPLER_CUBE_SHADOW||a.type===e.SAMPLER_3D)?t.samplers.push(o):t.uniforms.push(o);return t.ready=!0,!0}setShader(t){if(t!==this.shader){if(!t.ready&&!this.postLink(t))return!1;this.shader=t,this.gl.useProgram(t._glProgram),this.attributesInvalidated=!0}return!0}getHdrFormat(){return this.textureHalfFloatRenderable?ki:this.textureFloatRenderable?zi:Li}getBoneLimit(){return this.boneLimit}setBoneLimit(t){this.boneLimit=t}resizeCanvas(t,s){this._width=t,this._height=s;const i=Math.min(this._maxPixelRatio,e.polyfill.window.devicePixelRatio);t=Math.floor(t*i),s=Math.floor(s*i),this.canvas.width===t&&this.canvas.height===s||(this.canvas.width=t,this.canvas.height=s,this.fire("resizecanvas",t,s))}setResolution(t,e){this._width=t,this._height=e,this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e)}clearShaderCache(){console.log("clearShaderCache");const t=this.gl;for(const e in this.fragmentShaderCache)t.deleteShader(this.fragmentShaderCache[e]),delete this.fragmentShaderCache[e];for(const e in this.vertexShaderCache)t.deleteShader(this.vertexShaderCache[e]),delete this.vertexShaderCache[e];this.programLib.clearCache()}clearVertexArrayObjectCache(){console.log("clearVertexArrayObjectCache");const t=this.gl;this._vaoMap.forEach(((e,s,i)=>{t.deleteVertexArray(e)})),this._vaoMap.clear()}removeShaderFromCache(t){this.programLib.removeFromCache(t)}get width(){return this.gl.drawingBufferWidth||this.canvas.width}get height(){return this.gl.drawingBufferHeight||this.canvas.height}get fullscreen(){return!!e.polyfill.document.fullscreenElement}set fullscreen(t){if(t){this.gl.canvas.requestFullscreen()}else e.polyfill.document.exitFullscreen()}get enableAutoInstancing(){return this._enableAutoInstancing}set enableAutoInstancing(t){this._enableAutoInstancing=t&&this.extInstancing}get maxPixelRatio(){return this._maxPixelRatio}set maxPixelRatio(t){this._maxPixelRatio=t,this.resizeCanvas(this._width,this._height)}get textureFloatHighPrecision(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=function(t){if(!t.textureFloatRenderable)return!1;const e=fr(t,ir.fullscreenQuadVS,ir.precisionTestPS,"ptest1"),s=fr(t,ir.fullscreenQuadVS,ir.precisionTest2PS,"ptest2"),i={format:zi,width:1,height:1,mipmaps:!1,minFilter:di,magFilter:di},n=new Mr(t,i);n.name="testFHP";const a=new uh({colorBuffer:n,depth:!1});er(t,a,e),i.format=Li;const r=new Mr(t,i);r.name="testFHP";const o=new uh({colorBuffer:r,depth:!1});t.constantTexSource.setValue(n),er(t,o,s);const h=t.activeFramebuffer;t.setFramebuffer(o._glFrameBuffer);const l=new Uint8Array(4);t.readPixels(0,0,1,1,l),t.setFramebuffer(h);const c=l[0]/255/16777216+l[1]/255/65536+l[2]/255/256+l[3]/255;return n.destroy(),a.destroy(),r.destroy(),o.destroy(),0===c}(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=function(t,e){let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const n=new Uint16Array(16);return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,n),t.getError()!==t.NO_ERROR&&(s=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(i),s}(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}const dh={depth:!0,face:0};class uh{constructor(t){const e=arguments[1],s=arguments[2];if(t instanceof ch?(this._colorBuffer=e,t=s):this._colorBuffer=t.colorBuffer,this._colorBuffer&&(this._colorBuffer._isRenderTarget=!0),this._device=null,this._glFrameBuffer=null,this._glDepthBuffer=null,t=void 0!==t?t:dh,this._depthBuffer=t.depthBuffer,this._face=void 0!==t.face?t.face:0,this._depthBuffer){const t=this._depthBuffer._format;t===Vi?(this._depth=!0,this._stencil=!1):t===Ni?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else this._depth=void 0===t.depth||t.depth,this._stencil=void 0!==t.stencil&&t.stencil;var i,n;(this._samples=void 0!==t.samples?t.samples:1,this.autoResolve=void 0===t.autoResolve||t.autoResolve,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null,this.name=t.name,this.name)||(this.name=null==(i=this._colorBuffer)?void 0:i.name);this.name||(this.name=null==(n=this._depthBuffer)?void 0:n.name);this.name||(this.name="Untitled"),this.flipY=!!t.flipY}destroy(){const t=this._device;if(t){const e=t.targets.indexOf(this);-1!==e&&t.targets.splice(e,1),this.destroyFrameBuffers()}}destroyFrameBuffers(){const t=this._device;if(t){const e=t.gl;this._glFrameBuffer&&(e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(e.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(e.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(e.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(e.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}}destroyTextureBuffers(){this._depthBuffer&&(this._depthBuffer.destroy(),this._depthBuffer=null),this._colorBuffer&&(this._colorBuffer.destroy(),this._colorBuffer=null)}loseContext(){this._glFrameBuffer=void 0,this._glDepthBuffer=void 0,this._glResolveFrameBuffer=void 0,this._glMsaaColorBuffer=void 0,this._glMsaaDepthBuffer=void 0}resolve(t=!0,e=!!this._depthBuffer){if(!this._device)return;if(!this._device.webgl2)return;const s=this._device.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,this._glFrameBuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),s.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(t?s.COLOR_BUFFER_BIT:0)|(e?s.DEPTH_BUFFER_BIT:0),s.NEAREST),s.bindFramebuffer(s.FRAMEBUFFER,this._glFrameBuffer)}copy(t,e,s){if(!this._device){if(!t._device)return!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,s)}get colorBuffer(){return this._colorBuffer}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}get height(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}class ph{constructor(t,e,s,i=ti,n){this.device=t,this.format=e,this.numIndices=s,this.usage=i;const a=this.device.gl;let r;e===bi?(r=1,this.glFormat=a.UNSIGNED_BYTE):e===Si?(r=2,this.glFormat=a.UNSIGNED_SHORT):e===wi&&(r=4,this.glFormat=a.UNSIGNED_INT),this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),t._vram.ib+=this.numBytes,this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);if(-1!==e&&t.buffers.splice(e,1),this.bufferId){this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null)}this.storage=null}loseContext(){this.bufferId=void 0}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){const t=this.device.gl;let e;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case ti:e=t.STATIC_DRAW;break;case ei:e=t.DYNAMIC_DRAW;break;case si:e=t.STREAM_DRAW;break;case ii:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferId),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.storage,e)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}_lockTypedArray(){const t=this.lock();return this.format===wi?new Uint32Array(t):this.format===Si?new Uint16Array(t):new Uint8Array(t)}writeData(t,e){const s=this._lockTypedArray();if(t.length>e)if(ArrayBuffer.isView(t))t=t.subarray(0,e),s.set(t);else for(let i=0;i<e;i++)s[i]=t[i];else s.set(t);this.unlock()}readData(t){const e=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(t))t.set(e);else{t.length=0;for(let i=0;i<s;i++)t[i]=e[i]}return s}}function mh(t){this.array[this.index]=t}function fh(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function _h(t,e,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s}function gh(t,e,s,i){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s,this.array[this.index+3]=i}function yh(t,e,s){this.array[t]=e[s]}function vh(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1]}function xh(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2]}function bh(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2],this.array[t+3]=e[s+3]}function Sh(t,e,s){e[s]=this.array[t]}function wh(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1]}function Mh(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2]}function Th(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2],e[s+3]=this.array[t+3]}class Ah{constructor(t,e,s){switch(this.index=0,this.numComponents=e.numComponents,s.interleaved?this.array=new Ia[e.dataType](t,e.offset):this.array=new Ia[e.dataType](t,e.offset,s.vertexCount*e.numComponents),this.stride=e.stride/this.array.constructor.BYTES_PER_ELEMENT,e.numComponents){case 1:this.set=mh,this.getToArray=Sh,this.setFromArray=yh;break;case 2:this.set=fh,this.getToArray=wh,this.setFromArray=vh;break;case 3:this.set=_h,this.getToArray=Mh,this.setFromArray=xh;break;case 4:this.set=gh,this.getToArray=Th,this.setFromArray=bh}}get(t){return this.array[this.index+t]}set(t,e,s,i){}getToArray(t,e,s){}setFromArray(t,e,s){}}class Ch{constructor(t){this.vertexBuffer=t,this.vertexFormatSize=t.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const e=this.vertexBuffer.getFormat();for(let t=0;t<e.elements.length;t++){const s=e.elements[t];this.accessors[t]=new Ah(this.buffer,s,e),this.element[s.name]=this.accessors[t]}}next(t=1){let e=0;const s=this.accessors,i=this.accessors.length;for(;e<i;){const i=s[e++];i.index+=t*i.stride}}end(){this.vertexBuffer.unlock()}writeData(t,e,s){const i=this.element[t];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const t=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let a=0;a<s;a++)i.setFromArray(n,e,a*t),n+=i.stride}else if(e.length>s*t){const n=s*t;if(ArrayBuffer.isView(e))e=e.subarray(0,n),i.array.set(e);else for(let t=0;t<n;t++)i.array[t]=e[t]}else i.array.set(e)}}readData(t,e){const s=this.element[t];let i=0;if(s){let t;i=this.vertexBuffer.numVertices;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(e)&&(e.length=0),s.index=0;let a=0;for(t=0;t<i;t++)s.getToArray(a,e,t*n),a+=s.stride}else if(ArrayBuffer.isView(e))e.set(s.array);else{e.length=0;const a=i*n;for(t=0;t<a;t++)e[t]=s.array[t]}}return i}}const Ph={type:on,base:0,count:4,indexed:!1};class Rh{constructor(t){this.device=t,this.shader=null,this.depthMap=null,this.vertexBuffer=Eh(t),this.needsDepthBuffer=!1}render(t,e,s){}}function Eh(t){const e=new Ja(t,[{semantic:ln,components:2,type:oa}]),s=new $a(t,e,4),i=new Ch(s);return i.element[ln].set(-1,-1),i.next(),i.element[ln].set(1,-1),i.next(),i.element[ln].set(-1,1),i.next(),i.element[ln].set(1,1),i.end(),s}function Lh(t,e,s,i,n){const a=t.getRenderTarget();t.setRenderTarget(e),t.updateBegin();let r=e?e.width:t.width,o=e?e.height:t.height,h=0,l=0;n&&(h=n.x*r,l=n.y*o,r*=n.z,o*=n.w);const c=t.vx,d=t.vy,u=t.vw,p=t.vh;t.setViewport(h,l,r,o);const m=t.sx,f=t.sy,_=t.sw,g=t.sh;t.setScissor(h,l,r,o);const y=t.getBlending(),v=t.getDepthTest(),x=t.getDepthWrite(),b=t.getCullMode(),S=t.writeRed,w=t.writeGreen,M=t.writeBlue,T=t.writeAlpha;t.setBlending(!1),t.setDepthTest(!1),t.setDepthWrite(!1),t.setCullMode(oi),t.setColorWrite(!0,!0,!0,!0),t.setVertexBuffer(s,0),t.setShader(i),t.draw(Ph),t.setBlending(y),t.setDepthTest(v),t.setDepthWrite(x),t.setCullMode(b),t.setColorWrite(S,w,M,T),t.updateEnd(),t.setRenderTarget(a),t.updateBegin(),t.setViewport(c,d,u,p),t.setScissor(m,f,_,g)}class Ih{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}getRefCount(){return this._refCount}}let Dh;function Fh(){return Dh}function Oh(t){Dh=t}let kh=0;class Bh{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=ti,this.indicesUsage=ti,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(t,e){this.vertexCount||(this.vertexCount=t)}}Bh.DEFAULT_COMPONENTS_POSITION=3,Bh.DEFAULT_COMPONENTS_NORMAL=3,Bh.DEFAULT_COMPONENTS_UV=2,Bh.DEFAULT_COMPONENTS_COLORS=4;class zh{constructor(t,e,s,i){this.data=t,this.componentCount=e,this.dataType=s,this.dataTypeNormalize=i}}class Uh extends Ih{constructor(t){super(),this.id=kh++,this.device=t||Fh().graphicsDevice,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this.morph=null,this._geometryData=null,this._aabb=new bt,this.boneAabb=null}get aabb(){return this._aabb}set aabb(t){this._aabb=t}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(t){this.indexBuffer[t]&&(this.indexBuffer[t].destroy(),this.indexBuffer[t]=null)}_initBoneAabbs(t){let e,s,i,n,a;this.boneAabb=[],this.boneUsed=[];const r=[],o=[],h=this.boneUsed,l=this.skin.boneNames.length;let c,d,u;for(let t=0;t<l;t++)r[t]=new it(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[t]=new it(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new Ch(this.vertexBuffer),m=p.element[ln],f=p.element[un],_=p.element[pn],g=this.vertexBuffer.numVertices;for(let l=0;l<g;l++){for(let p=0;p<4;p++){if(f.array[f.index+p]>0){const f=_.array[_.index+p];if(h[f]=!0,e=m.array[m.index],s=m.array[m.index+1],i=m.array[m.index+2],n=o[f],a=r[f],!a||!n)continue;if(a.x>e&&(a.x=e),a.y>s&&(a.y=s),a.z>i&&(a.z=i),n.x<e&&(n.x=e),n.y<s&&(n.y=s),n.z<i&&(n.z=i),t){let r=c=e,o=d=s,h=u=i;for(let e=0;e<t.length;e++){const s=t[e],i=s.deltaPositions[3*l],n=s.deltaPositions[3*l+1],a=s.deltaPositions[3*l+2];i<0?r+=i:c+=i,n<0?o+=n:d+=n,a<0?h+=a:u+=a}a.x>r&&(a.x=r),a.y>o&&(a.y=o),a.z>h&&(a.z=h),n.x<c&&(n.x=c),n.y<d&&(n.y=d),n.z<u&&(n.z=u)}}}p.next()}const y=this.vertexBuffer.getFormat().elements.find((t=>t.name===ln));if(y&&y.normalize){const t=(()=>{switch(y.dataType){case ea:return t=>Math.max(t/127,-1);case sa:return t=>t/255;case ia:return t=>Math.max(t/32767,-1);case na:return t=>t/65535;default:return t=>t}})();for(let e=0;e<l;e++)if(h[e]){const s=r[e],i=o[e];s.set(t(s.x),t(s.y),t(s.z)),i.set(t(i.x),t(i.y),t(i.z))}}for(let t=0;t<l;t++){const e=new bt;e.setMinMax(r[t],o[t]),this.boneAabb.push(e)}}_initGeometryData(){this._geometryData||(this._geometryData=new Bh,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(t,e,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=t?ti:ei,this._geometryData.indicesUsage=e?ti:ei}setVertexStream(t,e,s,i,n=oa,a=!1){this._initGeometryData();const r=i||e.length/s;this._geometryData._changeVertexCount(r,t),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[t]=new zh(e,s,n,a)}getVertexStream(t,e){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[t];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(e)?e.set(n.data):(e.length=0,e.push(n.data)))}if(!i&&this.vertexBuffer){s=new Ch(this.vertexBuffer).readData(t,e)}return s}setPositions(t,e=Bh.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(ln,t,e,s,oa,!1)}setNormals(t,e=Bh.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(cn,t,e,s,oa,!1)}setUvs(t,e,s=Bh.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(fn+t,e,s,i,oa,!1)}setColors(t,e=Bh.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(mn,t,e,s,oa,!1)}setColors32(t,e){this.setVertexStream(mn,t,Bh.DEFAULT_COMPONENTS_COLORS,e,sa,!0)}setIndices(t,e){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=t,this._geometryData.indexCount=e||t.length}getPositions(t){return this.getVertexStream(ln,t)}getNormals(t){return this.getVertexStream(cn,t)}getUvs(t,e){return this.getVertexStream(fn+t,e)}getColors(t){return this.getVertexStream(mn,t)}getIndices(t){let e=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;e=this._geometryData.indexCount,ArrayBuffer.isView(t)?t.set(s):(t.length=0,t.push(s))}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){e=this.indexBuffer[0].readData(t)}return e}update(t=rn,e=!0){if(this._geometryData){if(e){const t=this._geometryData.vertexStreamDictionary[ln];t&&3===t.componentCount&&this._aabb.compute(t.data,this._geometryData.vertexCount)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=t,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(t){const e=[];for(const t in this._geometryData.vertexStreamDictionary){const s=this._geometryData.vertexStreamDictionary[t];e.push({semantic:t,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize})}return new Ja(this.device,e,t)}_updateVertexBuffer(){if(!this.vertexBuffer){const t=this._geometryData.maxVertices,e=this._buildVertexFormat(t);this.vertexBuffer=new $a(this.device,e,t,this._geometryData.verticesUsage)}const t=new Ch(this.vertexBuffer),e=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.writeData(s,i.data,e),delete this._geometryData.vertexStreamDictionary[s]}t.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices>65535?wi:Si;this.indexBuffer[0]=new ph(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const t=this._geometryData.indices;if(t){this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(t){t===xe?this.generateWireframe():t===be&&(this.primitive[be]={type:en,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[be]&&this.prepareRenderState(be),this.primitive[xe]&&this.prepareRenderState(xe)}generateWireframe(){this._destroyIndexBuffer(xe);const t=[];let e;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const s=[[0,1],[1,2],[2,0]],i=this.primitive[ve].base,n=this.primitive[ve].count,a=this.indexBuffer[ve],r=new Fa[a.format](a.storage),o={};for(let e=i;e<i+n;e+=3)for(let i=0;i<3;i++){const n=r[e+s[i][0]],a=r[e+s[i][1]],h=n>a?a<<16|n:n<<16|a;void 0===o[h]&&(o[h]=0,t.push(n,a))}e=a.format}else{for(let e=0;e<this.vertexBuffer.numVertices;e+=3)t.push(e,e+1,e+1,e+2,e+2,e);e=t.length>65535?wi:Si}const s=new ph(this.vertexBuffer.device,e,t.length);new Fa[s.format](s.storage).set(t),s.unlock(),this.primitive[xe]={type:sn,base:0,count:t.length,indexed:!0},this.indexBuffer[xe]=s}}const Vh=[];function Nh(t,e){const s=e.length/3,i=t.length/3,n=new it,a=new it,r=new it,o=new it,h=new it,l=new it,c=[];for(let e=0;e<t.length;e++)c[e]=0;for(let i=0;i<s;i++){const s=e[3*i],d=e[3*i+1],u=e[3*i+2];n.set(t[3*s],t[3*s+1],t[3*s+2]),a.set(t[3*d],t[3*d+1],t[3*d+2]),r.set(t[3*u],t[3*u+1],t[3*u+2]),o.sub2(a,n),h.sub2(r,n),l.cross(o,h).normalize(),c[3*s]+=l.x,c[3*s+1]+=l.y,c[3*s+2]+=l.z,c[3*d]+=l.x,c[3*d+1]+=l.y,c[3*d+2]+=l.z,c[3*u]+=l.x,c[3*u+1]+=l.y,c[3*u+2]+=l.z}for(let t=0;t<i;t++){const e=c[3*t],s=c[3*t+1],i=c[3*t+2],n=1/Math.sqrt(e*e+s*s+i*i);c[3*t]*=n,c[3*t+1]*=n,c[3*t+2]*=n}return c}function Wh(t,e,s,i){const n=i.length/3,a=t.length/3,r=new it,o=new it,h=new it,l=new st,c=new st,d=new st,u=new it,p=new it,m=new Float32Array(3*a),f=new Float32Array(3*a),_=[];for(let e=0;e<n;e++){const n=i[3*e],a=i[3*e+1],_=i[3*e+2];r.set(t[3*n],t[3*n+1],t[3*n+2]),o.set(t[3*a],t[3*a+1],t[3*a+2]),h.set(t[3*_],t[3*_+1],t[3*_+2]),l.set(s[2*n],s[2*n+1]),c.set(s[2*a],s[2*a+1]),d.set(s[2*_],s[2*_+1]);const g=o.x-r.x,y=h.x-r.x,v=o.y-r.y,x=h.y-r.y,b=o.z-r.z,S=h.z-r.z,w=c.x-l.x,M=d.x-l.x,T=c.y-l.y,A=d.y-l.y,C=w*A-M*T;if(0===C)u.set(0,1,0),p.set(1,0,0);else{const t=1/C;u.set((A*g-T*y)*t,(A*v-T*x)*t,(A*b-T*S)*t),p.set((w*y-M*g)*t,(w*x-M*v)*t,(w*S-M*b)*t)}m[3*n+0]+=u.x,m[3*n+1]+=u.y,m[3*n+2]+=u.z,m[3*a+0]+=u.x,m[3*a+1]+=u.y,m[3*a+2]+=u.z,m[3*_+0]+=u.x,m[3*_+1]+=u.y,m[3*_+2]+=u.z,f[3*n+0]+=p.x,f[3*n+1]+=p.y,f[3*n+2]+=p.z,f[3*a+0]+=p.x,f[3*a+1]+=p.y,f[3*a+2]+=p.z,f[3*_+0]+=p.x,f[3*_+1]+=p.y,f[3*_+2]+=p.z}const g=new it,y=new it,v=new it,x=new it;for(let t=0;t<a;t++){v.set(e[3*t],e[3*t+1],e[3*t+2]),g.set(m[3*t],m[3*t+1],m[3*t+2]),y.set(f[3*t],f[3*t+1],f[3*t+2]);const s=v.dot(g);x.copy(v).mulScalar(s),x.sub2(g,x).normalize(),_[4*t]=x.x,_[4*t+1]=x.y,_[4*t+2]=x.z,x.cross(v,g),_[4*t+3]=x.dot(y)<0?-1:1}return _}function Gh(t,e,s){const i=new Uh(t);return i.setPositions(e),s&&(s.normals&&i.setNormals(s.normals),s.tangents&&i.setVertexStream(dn,s.tangents,4),s.colors&&i.setColors32(s.colors),s.uvs&&i.setUvs(0,s.uvs),s.uvs1&&i.setUvs(1,s.uvs1),s.blendIndices&&i.setVertexStream(pn,s.blendIndices,4,s.blendIndices.length/4,sa),s.blendWeights&&i.setVertexStream(un,s.blendWeights,4),s.indices&&i.setIndices(s.indices)),i.update(),i}function Hh(t,e,s,i,n,a){const r=new it,o=new it,h=new it,l=new it,c=new it,d=new it,u=[],p=[],m=[],f=[],_=[];let g;if(s>0)for(let a=0;a<=i;a++)for(let g=0;g<=n;g++){const y=g/n*2*Math.PI-Math.PI,v=Math.sin(y),x=Math.cos(y);c.set(v*t,-s/2,x*t),l.set(v*e,s/2,x*e),r.lerp(c,l,a/i),o.sub2(l,c).normalize(),d.set(x,0,-v),h.cross(d,o).normalize(),u.push(r.x,r.y,r.z),p.push(h.x,h.y,h.z);let b=g/n,S=a/i;m.push(b,1-S);const w=S;if(S=b,b=w,b=.875*b+.0625,S=.875*S+.0625,b/=3,f.push(b,1-S),a<i&&g<n){const t=a*(n+1)+g,e=a*(n+1)+(g+1),s=(a+1)*(n+1)+g,i=(a+1)*(n+1)+(g+1);_.push(t,e,s),_.push(e,i,s)}}if(a){const t=Math.floor(n/2),a=n,r=s/2;for(let s=0;s<=t;s++){const i=s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=a;i++){const h=2*i*Math.PI/a-Math.PI/2,l=Math.sin(h),c=Math.cos(h)*n,d=o,_=l*n;let g=1-i/a,y=1-s/t;u.push(c*e,d*e+r,_*e),p.push(c,d,_),m.push(g,1-y),g=.875*g+.0625,y=.875*y+.0625,g/=3,y/=3,g+=1/3,f.push(g,1-y)}}g=(i+1)*(n+1);for(let e=0;e<t;++e)for(let t=0;t<a;++t){const s=e*(a+1)+t,i=s+a+1;_.push(g+s+1,g+i,g+s),_.push(g+s+1,g+i+1,g+i)}for(let s=0;s<=t;s++){const i=.5*Math.PI+s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=a;i++){const h=2*i*Math.PI/a-Math.PI/2,l=Math.sin(h),c=Math.cos(h)*n,d=o,_=l*n;let g=1-i/a,y=1-s/t;u.push(c*e,d*e-r,_*e),p.push(c,d,_),m.push(g,1-y),g=.875*g+.0625,y=.875*y+.0625,g/=3,y/=3,g+=2/3,f.push(g,1-y)}}g=(i+1)*(n+1)+(a+1)*(t+1);for(let e=0;e<t;++e)for(let t=0;t<a;++t){const s=e*(a+1)+t,i=s+a+1;_.push(g+s+1,g+i,g+s),_.push(g+s+1,g+i+1,g+i)}}else{if(g=(i+1)*(n+1),t>0)for(let e=0;e<n;e++){const i=e/n*2*Math.PI,a=Math.sin(i),r=-s/2,o=Math.cos(i);let h=1-(a+1)/2,l=(o+1)/2;u.push(a*t,r,o*t),p.push(0,-1,0),m.push(h,1-l),h=.875*h+.0625,l=.875*l+.0625,h/=3,l/=3,h+=1/3,f.push(h,1-l),e>1&&_.push(g,g+e,g+e-1)}if(g+=n,e>0)for(let t=0;t<n;t++){const i=t/n*2*Math.PI,a=Math.sin(i),r=s/2,o=Math.cos(i);let h=1-(a+1)/2,l=(o+1)/2;u.push(a*e,r,o*e),p.push(0,1,0),m.push(h,1-l),h=.875*h+.0625,l=.875*l+.0625,h/=3,l/=3,h+=2/3,f.push(h,1-l),t>1&&_.push(g,g+t-1,g+t)}}return{positions:u,normals:p,uvs:m,uvs1:f,indices:_}}function jh(t,e){let s=e&&(e.radius||e.baseRadius);s=void 0!==s?s:.5;const i=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:5,a=e&&void 0!==e.capSegments?e.capSegments:20,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=Hh(s,s,i,n,a,!1);return r&&(o.tangents=Wh(o.positions,o.normals,o.uvs,o.indices)),Gh(t,o.positions,o)}function qh(t,e){const s=e&&void 0!==e.radius?e.radius:.3,i=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:1,a=e&&void 0!==e.sides?e.sides:20,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=Hh(s,s,i-2*s,n,a,!0);return r&&(o.tangents=Wh(o.positions,o.normals,o.uvs,o.indices)),Gh(t,o.positions,o)}function Xh(t,e){const s=e&&void 0!==e.baseRadius?e.baseRadius:.5,i=e&&void 0!==e.peakRadius?e.peakRadius:0,n=e&&void 0!==e.height?e.height:1,a=e&&void 0!==e.heightSegments?e.heightSegments:5,r=e&&void 0!==e.capSegments?e.capSegments:18,o=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,h=Hh(s,i,n,a,r,!1);return o&&(h.tangents=Wh(h.positions,h.normals,h.uvs,h.indices)),Gh(t,h.positions,h)}function Yh(t,e){const s=e&&void 0!==e.radius?e.radius:.5,i=e&&void 0!==e.latitudeBands?e.latitudeBands:16,n=e&&void 0!==e.longitudeBands?e.longitudeBands:16,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,r=[],o=[],h=[],l=[];for(let t=0;t<=i;t++){const e=t*Math.PI/i,a=Math.sin(e),l=Math.cos(e);for(let e=0;e<=n;e++){const c=2*e*Math.PI/n-Math.PI/2,d=Math.sin(c),u=Math.cos(c)*a,p=l,m=d*a,f=1-e/n,_=1-t/i;r.push(u*s,p*s,m*s),o.push(u,p,m),h.push(f,1-_)}}for(let t=0;t<i;++t)for(let e=0;e<n;++e){const s=t*(n+1)+e,i=s+n+1;l.push(s+1,i,s),l.push(s+1,i+1,i)}const c={normals:o,uvs:h,uvs1:h,indices:l};return a&&(c.tangents=Wh(r,o,h,l)),Gh(t,r,c)}function Kh(t,e){const s=e&&void 0!==e.halfExtents?e.halfExtents:new st(.5,.5),i=e&&void 0!==e.widthSegments?e.widthSegments:5,n=e&&void 0!==e.lengthSegments?e.lengthSegments:5,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,r=[],o=[],h=[],l=[];let c=0;for(let t=0;t<=i;t++)for(let e=0;e<=n;e++){const a=-s.x+2*s.x*t/i,d=0,u=-(-s.y+2*s.y*e/n),p=t/i,m=e/n;r.push(a,d,u),o.push(0,1,0),h.push(p,1-m),t<i&&e<n&&(l.push(c+n+1,c+1,c),l.push(c+n+1,c+n+2,c+1)),c++}const d={normals:o,uvs:h,uvs1:h,indices:l};return a&&(d.tangents=Wh(r,o,h,l)),Gh(t,r,d)}function $h(t,e){const s=e&&void 0!==e.halfExtents?e.halfExtents:new it(.5,.5,.5),i=e&&void 0!==e.widthSegments?e.widthSegments:1,n=e&&void 0!==e.lengthSegments?e.lengthSegments:1,a=e&&void 0!==e.heightSegments?e.heightSegments:1,r=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=[new it(-s.x,-s.y,s.z),new it(s.x,-s.y,s.z),new it(s.x,s.y,s.z),new it(-s.x,s.y,s.z),new it(s.x,-s.y,-s.z),new it(-s.x,-s.y,-s.z),new it(-s.x,s.y,-s.z),new it(s.x,s.y,-s.z)],h=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],c=1,d=2,u=3,p=4,m=5,f=[],_=[],g=[],y=[],v=[];let x=0;const b=(t,e,s)=>{const i=new it,n=new it,a=new it,r=new it;for(let c=0;c<=e;c++)for(let d=0;d<=s;d++){i.lerp(o[h[t][0]],o[h[t][1]],c/e),n.lerp(o[h[t][0]],o[h[t][2]],d/s),a.sub2(n,o[h[t][0]]),r.add2(i,a);let u=c/e,p=d/s;f.push(r.x,r.y,r.z),_.push(l[t][0],l[t][1],l[t][2]),g.push(u,1-p),u=.875*u+.0625,p=.875*p+.0625,u/=3,p/=3,u+=t%3/3,p+=Math.floor(t/3)/3,y.push(u,1-p),c<e&&d<s&&(v.push(x+s+1,x+1,x),v.push(x+s+1,x+s+2,x+1)),x++}};b(0,i,a),b(c,i,a),b(d,i,n),b(u,i,n),b(p,n,a),b(m,n,a);const S={normals:_,uvs:g,uvs1:y,indices:v};return r&&(S.tangents=Wh(f,_,g,v)),Gh(t,f,S)}function Zh(t,e){let s=null;for(let i=0;i<Vh.length;i++)Vh[i].type===e&&Vh[i].device===t&&(s=Vh[i].primData);if(!s){let i,n;switch(e){case"box":i=$h(t,{halfExtents:new it(.5,.5,.5)}),n={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=qh(t,{radius:.5,height:2}),n={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":i=Xh(t,{baseRadius:.5,peakRadius:0,height:1}),n={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=jh(t,{radius:.5,height:1}),n={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=Kh(t,{halfExtents:new st(.5,.5),widthSegments:1,lengthSegments:1}),n={x:0,y:1,z:0,uv:1};break;case"sphere":i=Yh(t,{radius:.5}),n={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw new Error("Invalid primitive type: "+e)}i.incRefCount(),s={mesh:i,area:n},Vh.push({type:e,device:t,primData:s})}return s}class Jh extends Io{constructor(){super(),this.color=new J(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}clone(){const t=new Jh;return Io.prototype._cloneInternal.call(this,t),t.color.copy(this.color),t.colorMap=this.colorMap,t.vertexColors=this.vertexColors,t}updateUniforms(t,e){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}updateShader(t,e,s,i,n,a){const r={skin:s&&0!=(s&Ve),screenSpace:s&&0!=(s&Xe),useInstancing:s&&0!=(s&He),useMorphPosition:s&&0!=(s&Ke),useMorphNormal:s&&0!=(s&$e),useMorphTextureBased:s&&0!=(s&Ze),vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},o=t.getProgramLibrary();this.shader=o.getProgram("basic",r)}}class Qh{constructor(t,e,s){this.origMeshInstances=t,this._aabb=new bt,this.meshInstance=null,this.dynamic=e,this.batchGroupId=s}destroy(t,e){this.meshInstance&&(this.removeFromLayers(t,e),this.meshInstance.destroy())}addToLayers(t,e){for(let s=0;s<e.length;s++){const i=t.layers.getLayerById(e[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(t,e){for(let s=0;s<e.length;s++){const i=t.layers.getLayerById(e[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let t=1;t<this.origMeshInstances.length;t++)this._aabb.add(this.origMeshInstances[t].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}}class tl{constructor(t,e,s,i,n=[Wt]){this.dynamic=s,this.maxAabbSize=i,this.id=t,this.name=e,this.layers=n,this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]}}}tl.MODEL="model",tl.ELEMENT="element",tl.SPRITE="sprite",tl.RENDER="render";const el=new dt;class sl{constructor(t){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,t&&this.initSkin(t)}init(t,e){if(t.supportsBoneTextures){const s=3*e;let i=Math.ceil(Math.sqrt(s));i=V.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new Mr(t,{width:i,height:n,format:zi,mipmaps:!1,minFilter:di,magFilter:di}),this.boneTexture.name="skin",this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*e)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}get rootBone(){return this._rootBone}set rootBone(t){this._rootBone=t}resolve(t,e){this.rootBone=t;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const a=s.boneNames[n];let r=t.findByName(a);r||(r=e),i.push(r)}this.bones=i}initSkin(t){this.skin=t,this.bones=[];const e=t.inverseBindPose.length;this.init(t.device,e),this.matrices=[];for(let t=0;t<e;t++)this.matrices[t]=new dt}uploadBones(t){t.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(t,e){if(this._skinUpdateIndex!==e){this._skinUpdateIndex=e,el.copy(t.getWorldTransform()).invert();for(let t=this.bones.length-1;t>=0;t--)this.matrices[t].mulAffine2(el,this.bones[t].getWorldTransform()),this.matrices[t].mulAffine2(this.matrices[t],this.skin.inverseBindPose[t])}}updateMatrices(t,e){this._updateBeforeCull&&this._updateMatrices(t,e)}updateMatrixPalette(t,e){this._updateMatrices(t,e);const s=this.matrixPalette,i=this.bones.length;for(let t=0;t<i;t++){const e=this.matrices[t].data,i=12*t;s[i]=e[0],s[i+1]=e[4],s[i+2]=e[8],s[i+3]=e[12],s[i+4]=e[1],s[i+5]=e[5],s[i+6]=e[9],s[i+7]=e[13],s[i+8]=e[2],s[i+9]=e[6],s[i+10]=e[10],s[i+11]=e[14]}this.uploadBones(this.skin.device)}}class il extends sl{constructor(t,e,s){super();const i=e.length;this.init(t,i),this.device=t,this.rootNode=s,this.bones=e}updateMatrices(t,e){}updateMatrixPalette(t,e){const s=this.matrixPalette,i=this.bones.length;for(let t=0;t<i;t++){const e=this.bones[t].getWorldTransform().data,i=12*t;s[i]=e[0],s[i+1]=e[4],s[i+2]=e[8],s[i+3]=e[12],s[i+4]=e[1],s[i+5]=e[5],s[i+6]=e[9],s[i+7]=e[13],s[i+8]=e[2],s[i+9]=e[6],s[i+10]=e[10],s[i+11]=e[14]}this.uploadBones(this.device)}}class nl{static incRef(t){this.cache.incRef(t)}static decRef(t){this.cache.decRef(t)}static destroy(){this.cache.destroy()}}nl.cache=new class{constructor(){this.cache=new Map}destroy(){this.cache.forEach(((t,e)=>{e.destroy()})),this.cache.clear()}incRef(t){const e=(this.cache.get(t)||0)+1;this.cache.set(t,e)}decRef(t){if(t){let e=this.cache.get(t);e&&(e--,0===e?(this.cache.delete(t),t.destroy()):this.cache.set(t,e))}}};const al=new bt,rl=new bt,ol=new Mt,hl=new Set;class ll{constructor(t){this.count=t,this.vertexBuffer=null}}class cl{constructor(t,e,s){this._key=[],this._key[is]=ul(t,e,!0,0),this.command=s}get key(){return this._key[is]}set key(t){this._key[is]=t}}class dl{constructor(t,e,s=null){if(t instanceof jr){const i=t;t=e,e=s,s=i}this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=s,this._mesh=t,t.incRefCount(),this.material=e,this._shaderDefs=as<<16,this._shaderDefs|=t.vertexBuffer.format.hasUv0?Ne:0,this._shaderDefs|=t.vertexBuffer.format.hasUv1?We:0,this._shaderDefs|=t.vertexBuffer.format.hasColor?Ge:0,this._shaderDefs|=t.vertexBuffer.format.hasTangents?Ye:0,this._lightHash=0,this.visible=!0,this.layer=Nt,this._renderStyle=ve,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new bt,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=0,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFaces=!1}destroy(){const t=this.mesh;t&&(this.mesh=null,t.getRefCount()<1&&t.destroy()),this.setRealtimeLightmap(dl.lightmapParamNames[0],null),this.setRealtimeLightmap(dl.lightmapParamNames[1],null),this._skinInstance&&(this._skinInstance.destroy(),this._skinInstance=null),this.morphInstance&&(this.morphInstance.destroy(),this.morphInstance=null),this.material=null}get renderStyle(){return this._renderStyle}set renderStyle(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}static _prepareRenderStyleForArray(t,e){if(t){for(let s=0;s<t.length;s++){t[s]._renderStyle=e;const i=t[s].mesh;hl.has(i)||(hl.add(i),i.prepareRenderState(e))}hl.clear()}}get mesh(){return this._mesh}set mesh(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let t=this._customAabb,e=!!t;if(!t)if(t=al,this.skinInstance){if(!this.mesh.boneAabb){const t=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(t)}const s=this.mesh.boneUsed;let i=!0;for(let e=0;e<this.mesh.boneAabb.length;e++)s[e]&&(rl.setFromTransformedAabb(this.mesh.boneAabb[e],this.skinInstance.matrices[e]),i?(i=!1,t.center.copy(rl.center),t.halfExtents.copy(rl.halfExtents)):t.add(rl));e=!0}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&t._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),e=!0,this._aabbVer=this.node._aabbVer);return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb}set aabb(t){this._aabb=t}get material(){return this._material}set material(t){for(let t=0;t<this._shader.length;t++)this._shader[t]=null;const e=this._material;if(e&&e.removeMeshInstanceRef(this),this._material=t,this._material){this._material.addMeshInstanceRef(this),this.updateKey();if((e&&e.blendType!==Pt)!==(this._material.blendType!==Pt)){let t=this._material._scene;!t&&e&&e._scene&&(t=e._scene),t?t.layers._dirtyBlend=!0:this._material._dirtyBlend=!0}}}get layer(){return this._layer}set layer(t){this._layer=t,this.updateKey()}get calculateSortDistance(){return this._calculateSortDistance}set calculateSortDistance(t){this._calculateSortDistance=t}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._receiveShadow=t,this._shaderDefs=t?this._shaderDefs&~Ue:this._shaderDefs|Ue,this._shader[hs]=null,this._shader[ls]=null}get skinInstance(){return this._skinInstance}set skinInstance(t){this._skinInstance=t,this._shaderDefs=t?this._shaderDefs|Ve:this._shaderDefs&~Ve;for(let t=0;t<this._shader.length;t++)this._shader[t]=null;this._setupSkinUpdate()}get morphInstance(){return this._morphInstance}set morphInstance(t){this._morphInstance=t,this._morphInstance&&(this._morphInstance.meshInstance=this),this._shaderDefs=t&&t.morph.useTextureMorph?this._shaderDefs|Ze:this._shaderDefs&~Ze,this._shaderDefs=t&&t.morph.morphPositions?this._shaderDefs|Ke:this._shaderDefs&~Ke,this._shaderDefs=t&&t.morph.morphNormals?this._shaderDefs|$e:this._shaderDefs&~$e;for(let t=0;t<this._shader.length;t++)this._shader[t]=null}get screenSpace(){return this._screenSpace}set screenSpace(t){this._screenSpace=t,this._shaderDefs=t?this._shaderDefs|Xe:this._shaderDefs&~Xe,this._shader[hs]=null}get key(){return this._key[is]}set key(t){this._key[is]=t}get mask(){return this._shaderDefs>>16}set mask(t){const e=65535&this._shaderDefs;this._shaderDefs=e|t<<16,this._shader[hs]=null,this._shader[ls]=null}get instancingCount(){return this.instancingData?this.instancingData.count:0}set instancingCount(t){this.instancingData&&(this.instancingData.count=t)}_isVisible(t){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(t):(ol.center=this.aabb.center,ol.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(ol)))}updateKey(){const t=this.material;this._key[is]=ul(this.layer,t.alphaToCoverage||t.alphaTest?Ct:t.blendType,!1,t.id)}setInstancing(t){t?(this.instancingData=new ll(t.numVertices),this.instancingData.vertexBuffer=t,t.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(t){return this.parameters[t]}setParameter(t,e,s=-262141){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const i=this.parameters[t];i?(i.data=e,i.passFlags=s):this.parameters[t]={scopeId:null,data:e,passFlags:s}}setRealtimeLightmap(t,e){const s=this.getParameter(t);s!==e&&(s&&nl.decRef(s.data),e?(nl.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&e&&(n.scopeId||(n.scopeId=t.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(t){t?this.mask=(this.mask|rs)&~(as|os):(this.setRealtimeLightmap(dl.lightmapParamNames[0],null),this.setRealtimeLightmap(dl.lightmapParamNames[1],null),this._shaderDefs&=~(je|qe|Je),this.mask=(this.mask|as)&~(rs|os))}setCustomAabb(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}function ul(t,e,s,i){return(15&t)<<27|(e===Pt?1:0)<<26|(s?1:0)<<25|(33554431&i)<<0}function pl(t,e){if(t&&!e)return!1;if(!t&&e)return!1;if((t=t.data)===(e=e.data))return!0;if(t instanceof Float32Array&&e instanceof Float32Array){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}return!1}function ml(t,e){for(const s in t)if(t.hasOwnProperty(s)&&!pl(t[s],e[s]))return!1;for(const s in e)if(e.hasOwnProperty(s)&&!pl(e[s],t[s]))return!1;return!0}function fl(t,e){for(let s=0;s<t.length;s++)if(e.indexOf(t[s])<0)return!1;for(let s=0;s<e.length;s++)if(t.indexOf(e[s])<0)return!1;return!0}dl.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];const _l=new at,gl=new it,yl=new it,vl=new it;function xl(t){const e=t.node.worldTransform;return e.getX(gl),e.getY(yl),e.getZ(vl),gl.cross(gl,yl),gl.dot(vl)>=0?1:-1}class bl{constructor(t,e,s){this.device=t,this.rootNode=e,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(t,e,s,i,n){if(void 0===i&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;const a=new tl(i,t,e,s,n);return this._batchGroups[i]=a,a}removeGroup(t){if(!this._batchGroups[t])return;const e=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===t?this.destroyBatch(this._batchList[s]):e.push(this._batchList[s]);this._batchList=e,this._removeModelsFromBatchGroup(this.rootNode,t),delete this._batchGroups[t]}markGroupDirty(t){this._dirtyGroups.indexOf(t)<0&&this._dirtyGroups.push(t)}getGroupByName(t){const e=this._batchGroups;for(const s in e)if(e.hasOwnProperty(s)&&e[s].name===t)return e[s];return null}getBatches(t){const e=[],s=this._batchList.length;for(let i=0;i<s;i++){const s=this._batchList[i];s.batchGroupId===t&&e.push(s)}return e}_removeModelsFromBatchGroup(t,e){if(t.enabled){t.model&&t.model.batchGroupId===e&&(t.model.batchGroupId=-1),t.render&&t.render.batchGroupId===e&&(t.render.batchGroupId=-1),t.element&&t.element.batchGroupId===e&&(t.element.batchGroupId=-1),t.sprite&&t.sprite.batchGroupId===e&&(t.sprite.batchGroupId=-1);for(let s=0;s<t._children.length;s++)this._removeModelsFromBatchGroup(t._children[s],e)}}insert(t,e,s){const i=this._batchGroups[e];i&&i._obj[t].indexOf(s)<0&&(i._obj[t].push(s),this.markGroupDirty(e))}remove(t,e,s){const i=this._batchGroups[e];if(i){const n=i._obj[t].indexOf(s);n>=0&&(i._obj[t].splice(n,1),this.markGroupDirty(e))}}_extractRender(t,e,s,i){let n=t.getComponent("render");if(n){if(n.isStatic){const s=this.scene.drawCalls,i=t.render.meshInstances;for(let t=0;t<s.length;t++)s[t]._staticSource&&(i.indexOf(s[t]._staticSource)<0||e.push(s[t]));for(let t=0;t<i.length;t++)s.indexOf(i[t])>=0&&e.push(i[t])}else e=i[n.batchGroupId]=e.concat(n.meshInstances);n.removeFromLayers()}return e}_extractModel(t,e,s,i){let n=t.getComponent("model");if(n&&n.model){var a;if(n.isStatic){var r=this.scene.drawCalls,o=n.meshInstances;for(a=0;a<r.length;a++)r[a]._staticSource&&(o.indexOf(r[a]._staticSource)<0||e.push(r[a]));for(let t=0;t<o.length;t++)r.indexOf(o[t])>=0&&e.push(o[t])}else e=i[n.batchGroupId]=e.concat(n.meshInstances);n.removeModelFromLayers()}return e}_extractElement(t,e,s){if(!t.element)return;let i=!1;t.element._text&&t.element._text._model.meshInstances.length>0?(e.push(t.element._text._model.meshInstances[0]),t.element.removeModelFromLayers(t.element._text._model),i=!0):t.element._image&&(e.push(t.element._image._renderable.meshInstance),t.element.removeModelFromLayers(t.element._image._renderable.model),t.element._image._renderable.unmaskMeshInstance&&(e.push(t.element._image._renderable.unmaskMeshInstance),t.element._image._renderable.unmaskMeshInstance.stencilFront&&t.element._image._renderable.unmaskMeshInstance.stencilBack||(t.element._dirtifyMask(),t.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(t,e){for(let s=0;s<e.length;s++){const i=e[s],n=this._batchGroups[i];if(!n)continue;let a=t[i];a||(a=t[i]=[]);for(let e=0;e<n._obj.model.length;e++)a=this._extractModel(n._obj.model[e],a,n,t);for(let e=0;e<n._obj.render.length;e++)a=this._extractRender(n._obj.render[e],a,n,t);for(let t=0;t<n._obj.element.length;t++)this._extractElement(n._obj.element[t],a,n);for(let t=0;t<n._obj.sprite.length;t++){const e=n._obj.sprite[t];e.sprite&&e.sprite._meshInstance&&(n.dynamic||e.sprite.sprite._renderMode===ps)&&(a.push(e.sprite._meshInstance),e.sprite.removeModelFromLayers(),n._sprite=!0,e.sprite._batchGroup=n)}}}generate(t){const e={};t||(t=Object.keys(this._batchGroups));const s=[];for(let e=0;e<this._batchList.length;e++)t.indexOf(this._batchList[e].batchGroupId)<0?s.push(this._batchList[e]):this.destroyBatch(this._batchList[e]);if(this._batchList=s,this._collectAndRemoveMeshInstances(e,t),t===this._dirtyGroups)this._dirtyGroups.length=0;else{const e=[];for(let s=0;s<this._dirtyGroups.length;s++)t.indexOf(this._dirtyGroups[s])<0&&e.push(this._dirtyGroups[s]);this._dirtyGroups=e}let i,n,a,r;for(const t in e)if(e.hasOwnProperty(t)&&(i=e[t],a=this._batchGroups[t],a)){n=this.prepare(i,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(let e=0;e<n.length;e++)r=this.create(n[e],a.dynamic,parseInt(t,10)),r&&r.addToLayers(this.scene,a.layers)}}prepare(t,e,s=Number.POSITIVE_INFINITY,i){if(0===t.length)return[];const n=.5*s,a=this.device.supportsBoneTextures?1024:this.device.boneLimit,r=this.device.extUintElement?4294967295:65535,o=new bt,h=new bt;let l,c=null;const d=[];let u=0;i&&t.sort((function(t,e){return t.drawOrder-e.drawOrder}));let p,m=t;const f=i?function(t){c?c.add(t.aabb):c=t.aabb.clone(),p.push(t)}:function(t){p.push(t)};for(;m.length>0;){d[u]=[m[0]],p=[];const t=m[0].material,s=m[0].layer,_=m[0]._shaderDefs,g=m[0].parameters,y=m[0].stencilFront,v=m[0]._staticLightList;let x=m[0].mesh.vertexBuffer.getNumVertices();const b=m[0].drawOrder;o.copy(m[0].aabb);const S=xl(m[0]),w=m[0].mesh.vertexBuffer.format.batchingHash,M=m[0].mesh.primitive[0].indexed;c=null;for(let T=1;T<m.length;T++){const A=m[T];if(e&&d[u].length>=a){p=p.concat(m.slice(T));break}if(t!==A.material||s!==A.layer||w!==A.mesh.vertexBuffer.format.batchingHash||M!==A.mesh.primitive[0].indexed||_!==A._shaderDefs||x+A.mesh.vertexBuffer.getNumVertices()>r){f(A);continue}if(h.copy(o),h.add(A.aabb),h.halfExtents.x>n||h.halfExtents.y>n||h.halfExtents.z>n){f(A);continue}if(y&&(!(l=A.stencilFront)||y.func!==l.func||y.zpass!==l.zpass)){f(A);continue}if(S!==xl(A)){f(A);continue}if(!ml(g,A.parameters)){f(A);continue}const C=A._staticLightList;if(v&&C){if(!fl(v,C)){f(A);continue}}else if(v||C){f(A);continue}i&&c&&c.intersects(A.aabb)&&A.drawOrder!==b?f(A):(o.add(A.aabb),x+=A.mesh.vertexBuffer.getNumVertices(),d[u].push(A))}u++,m=p}return d}collectBatchedMeshData(t,e){let s=null,i=0,n=0,a=null;for(let r=0;r<t.length;r++)if(t[r].visible){const o=t[r].mesh;if(i+=o.vertexBuffer.numVertices,n+=o.primitive[0].indexed?o.primitive[0].count:o.primitive[0].type===hn&&4===o.primitive[0].count?6:0,!s){a=t[r].material,s={};const i=o.vertexBuffer.format.elements;for(let t=0;t<i.length;t++){s[i[t].name]={numComponents:i[t].numComponents,dataType:i[t].dataType,normalize:i[t].normalize,count:0}}e&&(s[pn]={numComponents:1,dataType:oa,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:n,material:a}}create(t,e,s){if(!this._init){const t="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n";this.transformVS=t+"#define DYNAMICBATCH\n"+ir.transformVS,this.skinTexVS=ir.skinBatchTexVS,this.skinConstVS=ir.skinBatchConstVS,this.vertexFormats={},this._init=!0}let i,n,a,r=null,o=null;const h=this.collectBatchedMeshData(t,e);if(h.streams){const l=h.streams;let c=h.material;const d=h.batchNumVerts,u=h.batchNumIndices;let p,m,f;o=new Qh(t,e,s),this._batchList.push(o);let _,g=0,y=0;const v=new it,x=new(d<=65535?Uint16Array:Uint32Array)(u);for(i in l)r=l[i],r.typeArrayType=Ia[r.dataType],r.elementByteSize=Da[r.dataType],r.buffer=new r.typeArrayType(d*r.numComponents);for(let s=0;s<t.length;s++)if(t[s].visible){for(i in n=t[s].mesh,a=n.vertexBuffer.numVertices,e||(_=t[s].node.getWorldTransform()),l)if(i!==pn){r=l[i];const t=new r.typeArrayType(r.buffer.buffer,r.elementByteSize*r.count),s=n.getVertexStream(i,t)*r.numComponents;if(r.count+=s,!e&&r.numComponents>=3)if(i===ln)for(let e=0;e<s;e+=r.numComponents)v.set(t[e],t[e+1],t[e+2]),_.transformPoint(v,v),t[e]=v.x,t[e+1]=v.y,t[e+2]=v.z;else if(i===cn||i===dn){_.invertTo3x3(_l),_l.transpose();for(let e=0;e<s;e+=r.numComponents)v.set(t[e],t[e+1],t[e+2]),_l.transformVector(v,v),t[e]=v.x,t[e+1]=v.y,t[e+2]=v.z}}if(e){r=l[pn];for(let t=0;t<a;t++)r.buffer[r.count++]=s}if(n.primitive[0].indexed){p=n.primitive[0].base,m=n.primitive[0].count;const t=n.indexBuffer[0].getFormat();f=new Fa[t](n.indexBuffer[0].storage)}else{if(n.primitive[0].type!==hn||4!==n.primitive[0].count){m=0;continue}p=0,m=6,f=[0,1,3,2,3,1]}for(let t=0;t<m;t++)x[t+y]=f[p+t]+g;y+=m,g+=a}for(i in n=new Uh(this.device),l)r=l[i],n.setVertexStream(i,r.buffer,r.numComponents,void 0,r.dataType,r.normalize);x.length>0&&n.setIndices(x),n.update(rn,!1),e&&(c=c.clone(),c.chunks.transformVS=this.transformVS,c.chunks.skinTexVS=this.skinTexVS,c.chunks.skinConstVS=this.skinConstVS,c.update());const b=new dl(n,c,this.rootNode);b.castShadow=o.origMeshInstances[0].castShadow,b.parameters=o.origMeshInstances[0].parameters,b.isStatic=o.origMeshInstances[0].isStatic,b.layer=o.origMeshInstances[0].layer,b._staticLightList=o.origMeshInstances[0]._staticLightList,b._shaderDefs=o.origMeshInstances[0]._shaderDefs,b.cull=o.origMeshInstances[0].cull;const S=this._batchGroups[s];if(S&&S._ui&&(b.cull=!1),e){const t=[];for(let e=0;e<o.origMeshInstances.length;e++)t.push(o.origMeshInstances[e].node);b.skinInstance=new il(this.device,t,this.rootNode)}b._updateAabb=!1,b.drawOrder=o.origMeshInstances[0].drawOrder,b.stencilFront=o.origMeshInstances[0].stencilFront,b.stencilBack=o.origMeshInstances[0].stencilBack,b.flipFaces=xl(o.origMeshInstances[0])<0,b.castShadow=o.origMeshInstances[0].castShadow,o.meshInstance=b,o.updateBoundingBox()}return o}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let t=0;t<this._batchList.length;t++)this._batchList[t].dynamic&&this._batchList[t].updateBoundingBox()}clone(t,e){const s=new Qh(e,t.dynamic,t.batchGroupId);this._batchList.push(s);const i=[];for(let t=0;t<e.length;t++)i.push(e[t].node);return s.meshInstance=new dl(t.meshInstance.mesh,t.meshInstance.material,t.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=e[0].parameters,s.meshInstance.isStatic=e[0].isStatic,s.meshInstance.cull=e[0].cull,s.meshInstance.layer=e[0].layer,s.meshInstance._staticLightList=e[0]._staticLightList,t.dynamic&&(s.meshInstance.skinInstance=new il(this.device,i,this.rootNode)),s.meshInstance.castShadow=t.meshInstance.castShadow,s.meshInstance._shader=t.meshInstance._shader,s.meshInstance.castShadow=t.meshInstance.castShadow,s}destroyBatch(t){t.destroy(this.scene,this._batchGroups[t.batchGroupId].layers)}}const Sl=new it,wl=new it,Ml=new it,Tl=new bt;class Al{constructor(){this.light=null,this.min=new it,this.max=new it}}class Cl{constructor(t){this.device=t,this.name="Untitled",this.reportCount=0,this._bounds=new bt,this.boundsMin=new it,this.boundsMax=new it,this.boundsDelta=new it,this._cells=new it(1,1,1),this._cellsLimit=new it,this.cells=this._cells,this._maxCellLightCount=0,this._pixelsPerCellCount=0,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new Al),this.lightsBuffer=new so(t),this.registerUniforms(t)}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(t){this._clusterWorldTextureId=t.scope.resolve("clusterWorldTexture"),this._clusterPixelsPerCellId=t.scope.resolve("clusterPixelsPerCell"),this._clusterTextureSizeId=t.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=t.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=t.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=t.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=t.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=t.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=t.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}get maxCellLightCount(){return this._maxCellLightCount}set maxCellLightCount(t){const e=V.roundUp(t,4);e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._pixelsPerCellCount=this._maxCellLightCount/4,this._cellsDirty=!0)}get cells(){return this._cells}set cells(t){Sl.copy(t).floor(),this._cells.equals(Sl)||(this._cells.copy(Sl),this._cellsLimit.copy(Sl).sub(it.ONE),this._cellsDirty=!0)}updateParams(t){t&&(this.cells=t.cells,this.maxCellLightCount=t.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=t.cookiesEnabled,this.lightsBuffer.shadowsEnabled=t.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=t.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const t=this._cells.x,e=this._cells.y,s=this._cells.z,i=t*e*s,n=this._pixelsPerCellCount*i;let a=Math.ceil(Math.sqrt(n));a=V.roundUp(a,this._pixelsPerCellCount);const r=Math.ceil(n/a);this._clusterCellsMaxData[0]=t,this._clusterCellsMaxData[1]=e,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this._pixelsPerCellCount,this._clusterCellsDotData[1]=t*s*this._pixelsPerCellCount,this._clusterCellsDotData[2]=t*this._pixelsPerCellCount,this.clusters=new Uint8ClampedArray(4*n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=a,this._clusterTextureSizeData[1]=1/a,this._clusterTextureSizeData[2]=1/r,this.releaseClusterTexture(),this.clusterTexture=so.createTexture(this.device,a,r,Li)}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture);const t=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/t.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/t.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/t.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=t.x,this._clusterBoundsDeltaData[1]=t.y,this._clusterBoundsDeltaData[2]=t.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterPixelsPerCellId.setValue(this._pixelsPerCellCount),this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(t,e,s){e.copy(t.min),e.sub(this.boundsMin),e.div(this.boundsDelta),e.mul2(e,this.cells),e.floor(),s.copy(t.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),e.max(it.ZERO),s.min(this._cellsLimit)}collectLights(t){const e=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;for(let n=0;n<t.length;n++){const a=t[n];if(a.enabled&&a.type!==Xt&&a.visibleThisFrame&&a.intensity>0){if(!(i<e)){console.warn(`Clustered lighting: more than ${e-1} lights in the frame, ignoring some.`);break}{let t;i<s.length?t=s[i]:(t=new Al,s.push(t)),t.light=a,a.getBoundingBox(Tl),t.min.copy(Tl.getMin()),t.max.copy(Tl.getMax()),i++}}}s.length=i}evaluateBounds(){const t=this._usedLights,e=this.boundsMin,s=this.boundsMax;if(t.length>1){e.copy(t[1].min),s.copy(t[1].max);for(let i=2;i<t.length;i++)e.min(t[i].min),s.max(t[i].max)}else e.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,e),this.lightsBuffer.setBounds(e,this.boundsDelta)}evaluateCompressionLimits(t){let e=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const a=i[n].light;e=Math.max(a.attenuationEnd,e);const r=t?a._linearFinalColor:a._finalColor;s=Math.max(r[0],s),s=Math.max(r[1],s),s=Math.max(r[2],s)}this._maxAttenuation=e+1e-6,this._maxColorValue=s+1e-6,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(t){this.counts.fill(0),this.clusters.fill(0);const e=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,a=this.clusters,r=this._pixelsPerCellCount,o=this._usedLights;for(let h=1;h<o.length;h++){const l=o[h],c=l.light;this.lightsBuffer.addLightData(c,h,t),this.evalLightCellMinMax(l,wl,Ml);const d=wl.x,u=Ml.x,p=wl.y,m=Ml.y,f=wl.z,_=Ml.z;for(let t=d;t<=u;t++)for(let o=f;o<=_;o++)for(let l=p;l<=m;l++){const c=t+e*(o+l*s),d=i[c];d<n&&(a[r*c*4+d]=h,i[c]=d+1)}}}update(t,e,s){this.updateParams(s),this.updateCells(),this.collectLights(t),this.evaluateBounds(),this.evaluateCompressionLimits(e),this.updateClusters(e),this.uploadTextures()}activate(){this.updateUniforms()}}const Pl=new nt;class Rl{constructor(t,e){this.device=t,this.lightTextureAtlas=e,this.blitShader2d=null,this.blitShaderCube=null,this.blitTextureId=null,this.invViewProjId=null}destroy(){}getShader(t,e){return this[t]||(this[t]=fr(this.device,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}",e,`cookie_renderer_${t}`)),this.blitTextureId||(this.blitTextureId=this.device.scope.resolve("blitTexture")),this.invViewProjId||(this.invViewProjId=this.device.scope.resolve("invViewProj")),this[t]}get shader2d(){return this.getShader("blitShader2d","\n\t\tvarying vec2 uv0;\n\t\tuniform sampler2D blitTexture;\n\t\tvoid main(void) {\n\t\t\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t\t}")}get shaderCube(){return this.getShader("blitShaderCube","\n\t\tvarying vec2 uv0;\n\t\tuniform samplerCube blitTexture;\n\t\tuniform mat4 invViewProj;\n\t\tvoid main(void) {\n\t\t\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\t\t\tvec4 worldPos = invViewProj * projPos;\n\t\t\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t\t}")}static createTexture(t,e){const s=new Mr(t,{width:e,height:e,format:Li,cubemap:!1,mipmaps:!1,minFilter:di,magFilter:di,addressU:Ws,addressV:Ws});return s.name="CookieAtlas",s}initInvViewProjMatrices(){if(!Rl._invViewProjMatrices){Rl._invViewProjMatrices=[];for(let t=0;t<6;t++){const e=Kr.create(null,Yt,t),s=e.projectionMatrix,i=e.node.getLocalTransform().clone().invert();Rl._invViewProjMatrices[t]=(new dt).mul2(s,i).invert()}}}render(t,e){if(t.enabled&&t.cookie&&t.visibleThisFrame){const s=t.numShadowFaces,i=s>1?this.shaderCube:this.shader2d,n=this.device;s>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(t.cookie);for(let a=0;a<s;a++){if(Pl.copy(t.atlasViewport),s>1){const t=Pl.z/3,e=this.lightTextureAtlas.cubeSlotsOffsets[a];Pl.x+=t*e.x,Pl.y+=t*e.y,Pl.z=t,Pl.w=t,this.invViewProjId.setValue(Rl._invViewProjMatrices[a].data)}Pl.mulScalar(e.colorBuffer.width),er(n,e,i,Pl)}}}}Rl._invViewProjMatrices=null;class El{constructor(t,e){this.texture=t,this.cached=!1,this.renderTargets=e}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const t=this.renderTargets;for(let e=0;e<t.length;e++)t[e].destroy();this.renderTargets.length=0}static getShadowFormat(t,e){return e===ae?zi:e===ne?ki:e===re||e===se&&t.webgl2?Vi:Li}static getShadowFiltering(t,e){return e!==se||t.webgl2?e===ae?t.extTextureFloatLinear?ui:di:e===ne?t.extTextureHalfFloatLinear?ui:di:ui:di}static create(t,e){let s=null;return s=e._type===Yt?this.createCubemap(t,e._shadowResolution):this.create2dMap(t,e._shadowResolution,e._shadowType),s}static createAtlas(t,e,s){const i=this.create2dMap(t,e,s),n=i.renderTargets,a=n[0];for(let t=0;t<5;t++)n.push(a);return i}static create2dMap(t,e,s){const i=this.getShadowFormat(t,s),n=this.getShadowFiltering(t,s),a=new Mr(t,{format:i,width:e,height:e,mipmaps:!1,minFilter:n,magFilter:n,addressU:Ws,addressV:Ws});a.name="ShadowMap2D";let r=null;return s===re||s===se&&t.webgl2?(a.compareOnRead=!0,a.compareFunc=gi,r=new uh({depthBuffer:a})):r=new uh({colorBuffer:a,depth:!0}),new El(a,[r])}static createCubemap(t,e){const s=new Mr(t,{format:Li,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:di,magFilter:di,addressU:Ws,addressV:Ws});s.name="ShadowMapCube";const i=[];for(let t=0;t<6;t++){const e=new uh({colorBuffer:s,face:t,depth:!0});i.push(e)}return new El(s,i)}}const Ll=[],Il=new nt,Dl=new nt;class Fl{constructor(t){this.device=t,this.subdivision=0,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=2048,this.cookieAtlas=null,this.cookieRenderTarget=null,this.slots=[],this.cubeSlotsOffsets=[new st(0,0),new st(0,1),new st(1,0),new st(1,1),new st(2,0),new st(2,1)],this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas&&(this.shadowAtlas.destroy(),this.shadowAtlas=null)}destroyCookieAtlas(){this.cookieAtlas&&(this.cookieAtlas.destroy(),this.cookieAtlas=null),this.cookieRenderTarget&&(this.cookieRenderTarget.destroy(),this.cookieRenderTarget=null)}allocateShadowAtlas(t){this.shadowAtlas&&this.shadowAtlas.texture.width===t||(this.destroyShadowAtlas(),this.shadowAtlas=El.createAtlas(this.device,t,se),this.shadowAtlas.cached=!0)}allocateCookieAtlas(t){this.cookieAtlas&&this.cookieAtlas.width===t||(this.destroyCookieAtlas(),this.cookieAtlas=Rl.createTexture(this.device,t),this.cookieRenderTarget=new uh({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}))}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0],e=this.device.webgl2?t.depthBuffer:t.colorBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(t){const e=Math.ceil(Math.sqrt(t));if(this.subdivision!==e){this.subdivision=e,this.slots.length=0;const t=1/e;for(let s=0;s<e;s++)for(let i=0;i<e;i++)this.slots.push(new nt(s*t,i*t,t,t))}}collectLights(t,e,s){const i=s.cookiesEnabled,n=s.shadowsEnabled;let a=!1,r=!1;const o=Ll;o.length=0;const h=t=>{for(let e=0;e<t.length;e++){const s=t[e];s.visibleThisFrame&&(a||(a=n&&s.castShadows),r||(r=i&&!!s.cookie),(a||r)&&o.push(s))}};return(i||n)&&(h(t),h(e)),a&&this.allocateShadowAtlas(this.shadowAtlasResolution),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(a||r)&&this.subdivide(o.length),o}update(t,e,s){this.shadowAtlasResolution=s.shadowAtlasResolution,this.cookieAtlasResolution=s.cookieAtlasResolution;const i=this.collectLights(t,e,s);if(i.length>0){const t=4/this.shadowAtlasResolution,e=new nt(t,t,-2*t,-2*t);let s=0;for(let t=0;t<i.length;t++){const n=i[t];n.castShadows&&(n._shadowMap=this.shadowAtlas);const a=this.slots[s];s++,n.atlasViewport.copy(a);const r=n.numShadowFaces;for(let t=0;t<r;t++)if(n.castShadows||n._cookie){if(Il.copy(a),Dl.copy(a),n._type===Kt&&Il.add(e),n._type===Yt){const e=Il.z/3,s=this.cubeSlotsOffsets[t];Il.x+=e*s.x,Il.y+=e*s.y,Il.z=e,Il.w=e,Dl.copy(Il)}if(n.castShadows){const e=n.getRenderData(null,t);e.shadowViewport.copy(Il),e.shadowScissor.copy(Dl)}}}}this.updateUniforms()}}class Ol{constructor(){this.shadowMapCache=new Map}destroy(){this.clear(),this.shadowMapCache=null}clear(){this.shadowMapCache.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this.shadowMapCache.clear()}getKey(t){return`${t._type===Yt}-${t._shadowType}-${t._shadowResolution}`}get(t,e){const s=this.getKey(e),i=this.shadowMapCache.get(s);if(i&&i.length)return i.pop();const n=El.create(t,e);return n.cached=!0,n}add(t,e){const s=this.getKey(t),i=this.shadowMapCache.get(s);i?i.push(e):this.shadowMapCache.set(s,[e])}}const kl=[new it,new it,new it,new it,new it,new it,new it,new it],Bl={min:0,max:0};function zl(t,e,s){kl[0].x=kl[1].x=kl[2].x=kl[3].x=e.x,kl[1].y=kl[3].y=kl[7].y=kl[5].y=e.y,kl[2].z=kl[3].z=kl[6].z=kl[7].z=e.z,kl[4].x=kl[5].x=kl[6].x=kl[7].x=s.x,kl[0].y=kl[2].y=kl[4].y=kl[6].y=s.y,kl[0].z=kl[1].z=kl[4].z=kl[5].z=s.z;let i=9999999999,n=-9999999999;for(let e=0;e<8;++e){t.transformPoint(kl[e],kl[e]);const s=kl[e].z;s<i&&(i=s),s>n&&(n=s)}return Bl.min=i,Bl.max=n,Bl}function Ul(t,e){return Math.exp(-t*t/(2*e*e))}const Vl=new bt,Nl=new dt,Wl=new dt,Gl=new Float32Array(2),Hl={x:1,y:1,z:0,w:0},jl={r:1,g:2,b:3,a:4},ql=new it,Xl=new dt;function Yl(t){const e=t.material,s=t.skinInstance?10:0;let i=0;if(e.opacityMap){const t=e.opacityMapChannel;t&&(i=jl[t])}return s+i}class Kl{constructor(t,e){this.device=t.device,this.forwardRenderer=t,this.lightTextureAtlas=e;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[ir.blurVSMPS,"#define GAUSS\n"+ir.blurVSMPS];const i="#define PACKED\n";this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.shadowMapCache=new Ol}destroy(){this.shadowMapCache.destroy(),this.shadowMapCache=null}static createShadowCamera(t,e,s,i){const n=Kr.create("ShadowCamera",s,i);return n.clearColor=e>=ie&&e<=ae?new J(0,0,0,0):new J(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(t,e,s,i,n){let a=s===re||s===se&&e.webgl2;i!==Yt||n||(a=!1),t.clearColorBuffer=!a}cullShadowCasters(t,e,s){let i=0;const n=t.length;for(let a=0;a<n;a++){const n=t[a];n.cull&&!n._isVisible(s)||(n.visibleThisFrame=!0,e[i]=n,i++)}e.length=i,e.sort(this.forwardRenderer.depthSortCompare)}cullLocal(t,e){const s=this.forwardRenderer.scene.clusteredLightingEnabled;t.visibleThisFrame=!0,s||t._shadowMap||(t._shadowMap=El.create(this.device,t));const i=t._type,n=i===Kt?1:6;for(let a=0;a<n;a++){const n=t.getRenderData(null,a),r=n.shadowCamera;r.nearClip=t.attenuationEnd/1e3,r.farClip=t.attenuationEnd;const o=r._node,h=t._node;if(o.setPosition(h.getPosition()),i===Kt)r.fov=2*t._outerConeAngle,o.setRotation(h.getRotation()),o.rotateLocal(-90,0,0);else if(i===Yt)if(s){const e=2/(this.lightTextureAtlas.shadowAtlasResolution*t.atlasViewport.z/3)*this.lightTextureAtlas.shadowEdgePixels;r.fov=Math.atan(1+e)*V.RAD_TO_DEG*2}else r.fov=90;this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(e,n.visibleCasters,r)}}generateSplitDistances(t,e,s){t._shadowCascadeDistances.fill(s);for(let i=1;i<t.numCascades;i++){const n=i/t.numCascades,a=e+(s-e)*n,r=e*(s/e)**n,o=V.lerp(a,r,t.cascadeDistribution);t._shadowCascadeDistances[i-1]=o}}cullDirectional(t,e,s){t.visibleThisFrame=!0,t._shadowMap||(t._shadowMap=El.create(this.device,t));const i=s._nearClip;this.generateSplitDistances(t,i,t.shadowDistance);for(let n=0;n<t.numCascades;n++){const a=t.getRenderData(s,n),r=a.shadowCamera;r.renderTarget=t._shadowMap.renderTargets[0],a.shadowViewport.copy(t.cascades[n]),a.shadowScissor.copy(t.cascades[n]);const o=r._node,h=t._node;o.setPosition(h.getPosition()),o.setRotation(h.getRotation()),o.rotateLocal(-90,0,0);const l=0===n?i:t._shadowCascadeDistances[n-1],c=t._shadowCascadeDistances[n],d=Os.getPoints(s,l,c);ql.set(0,0,0);const u=s.node.getWorldTransform();for(let t=0;t<8;t++)u.transformPoint(d[t],d[t]),ql.add(d[t]);ql.mulScalar(1/8);let p=0;for(let t=0;t<8;t++){const e=d[t].sub(ql).length();e>p&&(p=e)}const m=o.right,f=o.up,_=o.forward,g=.25*t._shadowResolution/p,y=Math.ceil(ql.dot(f)*g)/g,v=Math.ceil(ql.dot(m)*g)/g,x=f.mulScalar(y),b=m.mulScalar(v),S=ql.dot(_),w=_.mulScalar(S);ql.add2(x,b).add(w),o.setPosition(ql),o.translateLocal(0,0,1e6),r.nearClip=0,r.farClip=2e6,r.orthoHeight=p,this.forwardRenderer.updateCameraFrustum(r),this.cullShadowCasters(e,a.visibleCasters,r);let M=!0;const T=a.visibleCasters;for(let t=0;t<T.length;t++){const e=T[t];M?(M=!1,Vl.copy(e.aabb)):Vl.add(e.aabb)}Nl.copy(o.getWorldTransform()).invert();const A=zl(Nl,Vl.getMin(),Vl.getMax());o.translateLocal(0,0,A.max+.1),r.farClip=A.max-A.min+.2}}setupRenderState(t,e){const s=this.forwardRenderer.scene.clusteredLightingEnabled;t.webgl2?e._type!==Yt||s?(t.setDepthBias(!0),t.setDepthBiasValues(-1e3*e.shadowBias,-1e3*e.shadowBias)):t.setDepthBias(!1):t.extStandardDerivatives&&(e._type===Yt?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=-1e3*e.shadowBias,this.polygonOffset[1]=-1e3*e.shadowBias,this.polygonOffsetId.setValue(this.polygonOffset))),t.setBlending(!1),t.setDepthWrite(!0),t.setDepthTest(!0),t.setDepthFunc(vi);(s?e._isPcf&&t.webgl2:e._isPcf&&t.webgl2&&e._type!==Yt)?t.setColorWrite(!1,!1,!1,!1):t.setColorWrite(!0,!0,!0,!0)}restoreRenderState(t){t.webgl2?t.setDepthBias(!1):t.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))}dispatchUniforms(t,e,s,i){const n=e._node;t._type!==Xt&&(this.forwardRenderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(t.attenuationEnd)),Nl.setTRS(n.getPosition(),n.getRotation(),it.ONE).invert(),Wl.mul2(e.projectionMatrix,Nl);const a=s.shadowViewport;e.rect=a,e.scissorRect=s.shadowScissor,Xl.setViewport(a.x,a.y,a.z,a.w),s.shadowMatrix.mul2(Xl,Wl),t._type===Xt&&t._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}submitCasters(t,e){const s=this.device,i=this.forwardRenderer,n=1<<ds,a=e._shadowType+e._type*he,r=t.length;for(let e=0;e<r;e++){const r=t[e],o=r.mesh,h=r.material;i.setBaseConstants(s,h),i.setSkinning(s,r,h),h.dirty&&(h.updateUniforms(s,i.scene),h.dirty=!1),h.chunks&&(i.setCullMode(!0,!1,r),h.setParameters(s),r.setParameters(s,n));let l=r._shader[ds+a];l||(i.updateShader(r,r._shaderDefs,null,ds+a),l=r._shader[ds+a],r._key[ns]=Yl(r)),s.setShader(l),i.setVertexBuffers(s,o),i.setMorphing(s,r.morphInstance);const c=r.renderStyle;s.setIndexBuffer(o.indexBuffer[c]),e+=i.drawInstance(s,r,o,c),i._shadowDrawCalls++}}render(t,e){if(t.enabled&&t.castShadows&&t.shadowUpdateMode!==ts&&t.visibleThisFrame){const s=this.device;t.shadowUpdateMode===es&&(t.shadowUpdateMode=ts);const i=t._type,n=t._shadowType,a=t.numShadowFaces,r=this.forwardRenderer;r._shadowMapUpdates+=a;const o=r.scene.clusteredLightingEnabled;this.setupRenderState(s,t);for(let h=0;h<a;h++){const a=t.getRenderData(i===Xt?e:null,h),l=a.shadowCamera;Kl.setShadowCameraSettings(l,s,n,i,o);const c=i===Xt?0:h;l.renderTarget=t._shadowMap.renderTargets[c],this.dispatchUniforms(t,l,a,h),r.setCamera(l,l.renderTarget,!0),this.submitCasters(a.visibleCasters,t)}t._isVsm&&t._vsmBlurSize>1&&this.applyVsmBlur(t,e),this.restoreRenderState(s)}}getVsmBlurShader(t,e,s){let i=(t?this.blurPackedVsmShader:this.blurVsmShader)[e][s];if(!i){this.blurVsmWeights[s]=function(t){t>25&&(t=25);const e=(t-1)/6,s=.5*(t-1),i=new Array(t);let n=0;for(let a=0;a<t;++a)i[a]=Ul(a-s,e),n+=i[a];for(let e=0;e<t;++e)i[e]/=n;return i}(s);const n=ir.fullscreenQuadVS;let a="#define SAMPLES "+s+"\n";a+=t?this.blurPackedVsmShaderCode[e]:this.blurVsmShaderCode[e];const r="blurVsm"+e+s+t;i=fr(this.device,n,a,r),t?this.blurPackedVsmShader[e][s]=i:this.blurVsmShader[e][s]=i}return i}applyVsmBlur(t,e){const s=this.device,i=t.getRenderData(t._type===Xt?e:null,0).shadowCamera.renderTarget,n=this.shadowMapCache.get(s,t),a=n.renderTargets[0],r=t._shadowType===ie,o=t.vsmBlurMode,h=t._vsmBlurSize,l=this.getVsmBlurShader(r,o,h);Hl.z=t._shadowResolution-2,Hl.w=Hl.z,this.sourceId.setValue(i.colorBuffer),Gl[0]=1/t._shadowResolution,Gl[1]=0,this.pixelOffsetId.setValue(Gl),o===ce&&this.weightId.setValue(this.blurVsmWeights[h]),er(s,a,l,null,Hl),this.sourceId.setValue(a.colorBuffer),Gl[1]=Gl[0],Gl[0]=0,this.pixelOffsetId.setValue(Gl),er(s,i,l,null,Hl),this.shadowMapCache.add(t,n)}}const $l=new Mt;class Zl{static lightCompare(t,e){return t.key-e.key}static prepare(t,e,s,i){let n,a,r,o,h,l;const c=s,d=c.length;let u,p;const m=[];let f,_,g,y,v,x,b,S,w,M,T,A,C,P,R,E,L,I,D;const F=new it,O=new it,k=new bt,B=new dt,z=[];let U,V,N,W,G,H,j;const q=[];let X;const Y=[],K=[];let $,Z;for(n=0;n<d;n++)if(u=c[n],u.isStatic){for(X=u.aabb,K.length=0,j=Yt;j<=Kt;j++)for(a=0;a<i.length;a++)if(p=i[a],p._type===j&&p.enabled&&p.mask&u.mask&&p.isStatic){if(q[a]||(q[a]=new bt,p._node.getWorldTransform(),p.getBoundingSphere($l),q[a].center.copy($l.center),q[a].halfExtents.x=$l.radius,q[a].halfExtents.y=$l.radius,q[a].halfExtents.z=$l.radius),!q[a].intersects(X))continue;K.push(a)}if(0===K.length){m.push(u);continue}for(f=u.mesh,N=f.vertexBuffer,V=f.indexBuffer[u.renderStyle],_=2===V.bytesPerIndex?new Uint16Array(V.lock()):new Uint32Array(V.lock()),y=f.primitive[u.renderStyle].count/3,S=f.primitive[u.renderStyle].base,v=N.format.elements,x=N.format.size/4,g=new Float32Array(N.storage),r=0;r<v.length;r++)v[r].name===ln&&(b=v[r].offset/4);for(z.length=y,r=0;r<y;r++)z[r]=0;for(U=!1,Y.length=6*y,r=0;r<y;r++){for(A=Number.MAX_VALUE,C=Number.MAX_VALUE,P=Number.MAX_VALUE,R=-Number.MAX_VALUE,E=-Number.MAX_VALUE,L=-Number.MAX_VALUE,o=0;o<3;o++)l=_[3*r+o+S],l=l*x+b,w=g[l],M=g[l+1],T=g[l+2],w<A&&(A=w),M<C&&(C=M),T<P&&(P=T),w>R&&(R=w),M>E&&(E=M),T>L&&(L=T);l=6*r,Y[l]=A,Y[l+1]=C,Y[l+2]=P,Y[l+3]=R,Y[l+4]=E,Y[l+5]=L}for(h=0;h<K.length;h++)for(a=K[h],p=i[a],B.copy(u.node.worldTransform).invert(),k.setFromTransformedAabb(q[a],B),I=k.getMin(),D=k.getMax(),$=1<<h,r=0;r<y;r++)l=6*r,Y[l]<=D.x&&Y[l+3]>=I.x&&Y[l+1]<=D.y&&Y[l+4]>=I.y&&Y[l+2]<=D.z&&Y[l+5]>=I.z&&(z[r]|=$,U=!0);if(U){for(W={},r=0;r<y;r++)a=3*r+S,G=z[r],W[G]||(W[G]=[]),H=W[G],H.push(_[a]),H.push(_[a+1]),H.push(_[a+2]);for(G in W){H=W[G];const e=new ph(t,V.format,H.length,V.usage);for((2===e.bytesPerIndex?new Uint16Array(e.lock()):new Uint32Array(e.lock())).set(H),e.unlock(),A=Number.MAX_VALUE,C=Number.MAX_VALUE,P=Number.MAX_VALUE,R=-Number.MAX_VALUE,E=-Number.MAX_VALUE,L=-Number.MAX_VALUE,r=0;r<H.length;r++)l=H[r],w=g[l*x+b],M=g[l*x+b+1],T=g[l*x+b+2],w<A&&(A=w),M<C&&(C=M),T<P&&(P=T),w>R&&(R=w),M>E&&(E=M),T>L&&(L=T);F.set(A,C,P),O.set(R,E,L);const s=new bt;s.setMinMax(F,O);const n=new Uh(t);n.vertexBuffer=N,n.indexBuffer[0]=e,n.primitive[0].type=rn,n.primitive[0].base=0,n.primitive[0].count=H.length,n.primitive[0].indexed=!0,n.aabb=s;const a=new dl(n,u.material,u.node);for(a.isStatic=u.isStatic,a.visible=u.visible,a.layer=u.layer,a.castShadow=u.castShadow,a._receiveShadow=u._receiveShadow,a.cull=u.cull,a.pick=u.pick,a.mask=u.mask,a.parameters=u.parameters,a._shaderDefs=u._shaderDefs,a._staticSource=u,u._staticLightList?a._staticLightList=u._staticLightList:a._staticLightList=[],r=0;r<K.length;r++)$=1<<r,G&$&&(Z=i[K[r]],a._staticLightList.indexOf(Z)<0&&a._staticLightList.push(Z));a._staticLightList.sort(Zl.lightCompare),m.push(a)}}else m.push(u)}else m.push(u);for(s.length=m.length,n=0;n<m.length;n++)s[n]=m[n]}static revert(t){const e=t,s=e.length,i=[];let n;for(let t=0;t<s;t++){const s=e[t];s._staticSource?s._staticSource!==n&&(i.push(s._staticSource),n=s._staticSource):i.push(s)}t.length=i.length;for(let e=0;e<i.length;e++)t[e]=i[e]}}const Jl=new dt,Ql=new dt,tc=new at,ec=new dt;let sc;const ic=(new dt).setScale(1,-1,1),nc=new dt,ac=new dt,rc=new dt,oc=new dt,hc=new dt,lc=new dt,cc=new it,dc=new it;let uc,pc;const mc=new at,fc=new at,_c=new dt,gc=new dt,yc=new it,vc=new it,xc=new it,bc=new Mt,Sc=[0,0,0,0];let wc,Mc,Tc,Ac,Cc,Pc,Rc=null,Ec=0;const Lc={drawCalls:[],isNewMaterial:[],lightMaskChanged:[]},Ic=new Set;class Dc{constructor(t){this.device=t,this.scene=null,this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._numDrawCallsCulled=0,this._instancedDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._instancingTime=0,this._removedByInstancing=0,this._layerCompositionUpdateTime=0,this._lightClustersTime=0,this._lightClusters=0;const e=this.device,s=e.getProgramLibrary();this.library=s,this.lightTextureAtlas=new Fl(e),this._shadowRenderer=new Kl(this,this.lightTextureAtlas),this._cookieRenderer=new Rl(e,this.lightTextureAtlas);const i=e.scope;this.projId=i.resolve("matrix_projection"),this.projSkyboxId=i.resolve("matrix_projectionSkybox"),this.viewId=i.resolve("matrix_view"),this.viewId3=i.resolve("matrix_view3"),this.viewInvId=i.resolve("matrix_viewInverse"),this.viewProjId=i.resolve("matrix_viewProjection"),this.viewPos=new Float32Array(3),this.viewPosId=i.resolve("view_position"),this.nearClipId=i.resolve("camera_near"),this.farClipId=i.resolve("camera_far"),this.cameraParamsId=i.resolve("camera_params"),this.tbnBasis=i.resolve("tbnBasis"),this.fogColorId=i.resolve("fog_color"),this.fogStartId=i.resolve("fog_start"),this.fogEndId=i.resolve("fog_end"),this.fogDensityId=i.resolve("fog_density"),this.modelMatrixId=i.resolve("matrix_model"),this.normalMatrixId=i.resolve("matrix_normal"),this.poseMatrixId=i.resolve("matrix_pose[0]"),this.boneTextureId=i.resolve("texture_poseMap"),this.boneTextureSizeId=i.resolve("texture_poseMapSize"),this.morphWeightsA=i.resolve("morph_weights_a"),this.morphWeightsB=i.resolve("morph_weights_b"),this.morphPositionTex=i.resolve("morphPositionTex"),this.morphNormalTex=i.resolve("morphNormalTex"),this.morphTexParams=i.resolve("morph_tex_params"),this.alphaTestId=i.resolve("alpha_ref"),this.opacityMapId=i.resolve("texture_opacityMap"),this.ambientId=i.resolve("light_globalAmbient"),this.exposureId=i.resolve("exposure"),this.skyboxIntensityId=i.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.depthMapId=i.resolve("uDepthMap"),this.screenSizeId=i.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.twoSidedLightingNegScaleFactorId=i.resolve("twoSidedLightingNegScaleFactor"),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.cameraParams=new Float32Array(4)}destroy(){this._shadowRenderer.destroy(),this._shadowRenderer=null,this._cookieRenderer.destroy(),this._cookieRenderer=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist;if(t.zdist2&&e.zdist2)return t.zdist2-e.zdist2}return e._key[is]-t._key[is]}sortCompareMesh(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist}return Cc=t._key[is],Pc=e._key[is],Cc===Pc&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Pc-Cc}depthSortCompare(t,e){return Cc=t._key[ns],Pc=e._key[ns],Cc===Pc&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Pc-Cc}updateCameraFrustum(t){if(t.vrDisplay&&t.vrDisplay.presenting){sc=t.vrDisplay.combinedProj;const e=t._node.parent;e?Ql.copy(e.getWorldTransform()).mul(t.vrDisplay.combinedViewInv).invert():Ql.copy(t.vrDisplay.combinedView),Jl.copy(Ql).invert(),this.viewInvId.setValue(Jl.data),ec.mul2(sc,Ql),t.frustum.setFromMat4(ec)}else if(t.xr&&t.xr.views.length){const e=t.xr.views[0];return ec.mul2(e.projMat,e.viewOffMat),void t.frustum.setFromMat4(ec)}if(sc=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(sc,gs),t.calculateTransform)t.calculateTransform(Jl,gs);else{const e=t._node.getPosition(),s=t._node.getRotation();Jl.setTRS(e,s,it.ONE),this.viewInvId.setValue(Jl.data)}Ql.copy(Jl).invert(),ec.mul2(sc,Ql),t.frustum.setFromMat4(ec)}setCamera(t,e,s){const i=t.vrDisplay;let n;if(i&&i.presenting){if(uc=i.leftProj,pc=i.rightProj,sc=i.combinedProj,t.calculateProjection&&(t.calculateProjection(uc,ys),t.calculateProjection(pc,vs),t.calculateProjection(sc,gs)),t.calculateTransform)t.calculateTransform(rc,ys),t.calculateTransform(oc,vs),t.calculateTransform(Jl,gs),hc.copy(rc).invert(),lc.copy(oc).invert(),Ql.copy(Jl).invert();else{const e=t._node.parent;e?(n=e.getWorldTransform(),rc.mul2(n,i.leftViewInv),oc.mul2(n,i.rightViewInv),hc.copy(rc).invert(),lc.copy(oc).invert(),Ql.copy(e.getWorldTransform()).mul(i.combinedViewInv).invert()):(rc.copy(i.leftViewInv),oc.copy(i.rightViewInv),hc.copy(i.leftView),lc.copy(i.rightView),Ql.copy(i.combinedView))}mc.setFromMat4(hc),fc.setFromMat4(lc),_c.mul2(uc,hc),gc.mul2(pc,lc),cc.x=rc.data[12],cc.y=rc.data[13],cc.z=rc.data[14],dc.x=oc.data[12],dc.y=oc.data[13],dc.z=oc.data[14],ec.mul2(sc,Ql),t.frustum.setFromMat4(ec)}else if(t.xr&&t.xr.session){const e=t._node.parent;e&&(n=e.getWorldTransform());const s=t.xr.views;for(let i=0;i<s.length;i++){const a=s[i];e?(a.viewInvOffMat.mul2(n,a.viewInvMat),a.viewOffMat.copy(a.viewInvOffMat).invert()):(a.viewInvOffMat.copy(a.viewInvMat),a.viewOffMat.copy(a.viewMat)),a.viewMat3.setFromMat4(a.viewOffMat),a.projViewOffMat.mul2(a.projMat,a.viewOffMat),a.position[0]=a.viewInvOffMat.data[12],a.position[1]=a.viewInvOffMat.data[13],a.position[2]=a.viewInvOffMat.data[14],t.frustum.setFromMat4(a.projViewOffMat)}}else{if(sc=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(sc,gs),this.projId.setValue(sc.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data),t.calculateTransform)t.calculateTransform(Jl,gs);else{const e=t._node.getPosition(),s=t._node.getRotation();Jl.setTRS(e,s,it.ONE)}this.viewInvId.setValue(Jl.data),Ql.copy(Jl).invert(),this.viewId.setValue(Ql.data),tc.setFromMat4(Ql),this.viewId3.setValue(tc.data),ec.mul2(sc,Ql),e&&e.flipY?(nc.mul2(ic,ec),ac.mul2(ic,t.getProjectionMatrixSkybox()),this.viewProjId.setValue(nc.data),this.projSkyboxId.setValue(ac.data)):(this.viewProjId.setValue(ec.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data)),this.dispatchViewPos(t._node.getPosition()),t.frustum.setFromMat4(ec)}this.tbnBasis.setValue(e&&e.flipY?-1:1),this.nearClipId.setValue(t._nearClip),this.farClipId.setValue(t._farClip);const a=t._nearClip,r=t._farClip;this.cameraParams[0]=1/r,this.cameraParams[1]=r,this.cameraParams[2]=.5*(1-r/a),this.cameraParams[3]=.5*(1+r/a),this.cameraParamsId.setValue(this.cameraParams),this.clearView(t,e,s,!1)}clearView(t,e,s,i,n){const a=this.device;a.setRenderTarget(e),a.updateBegin(),i&&(a.setColorWrite(!0,!0,!0,!0),a.setDepthWrite(!0));const r=e?e.width:a.width,o=e?e.height:a.height,h=t.rect;let l=Math.floor(h.x*r),c=Math.floor(h.y*o),d=Math.floor(h.z*r),u=Math.floor(h.w*o);if(a.setViewport(l,c,d,u),t._scissorRectClear){const e=t.scissorRect;l=Math.floor(e.x*r),c=Math.floor(e.y*o),d=Math.floor(e.z*r),u=Math.floor(e.w*o)}a.setScissor(l,c,d,u),s&&(n||(n=t._clearOptions),a.clear(n||{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?ni:0)|(t._clearDepthBuffer?ai:0)|(t._clearStencilBuffer?ri:0),stencil:t._clearStencil}))}dispatchGlobalLights(t){if(this.ambientColor[0]=t.ambientLight.r,this.ambientColor[1]=t.ambientLight.g,this.ambientColor[2]=t.ambientLight.b,t.gammaCorrection)for(let t=0;t<3;t++)this.ambientColor[t]=Math.pow(this.ambientColor[t],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(t.exposure),t.skyboxModel&&this.skyboxIntensityId.setValue(t.skyboxIntensity)}_resolveLight(t,e){const s="light"+e;this.lightColorId[e]=t.resolve(s+"_color"),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(s+"_direction"),this.lightShadowMapId[e]=t.resolve(s+"_shadowMap"),this.lightShadowMatrixId[e]=t.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[e]=t.resolve(s+"_shadowParams"),this.lightRadiusId[e]=t.resolve(s+"_radius"),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(s+"_position"),this.lightWidth[e]=new Float32Array(3),this.lightWidthId[e]=t.resolve(s+"_halfWidth"),this.lightHeight[e]=new Float32Array(3),this.lightHeightId[e]=t.resolve(s+"_halfHeight"),this.lightInAngleId[e]=t.resolve(s+"_innerConeAngle"),this.lightOutAngleId[e]=t.resolve(s+"_outerConeAngle"),this.lightCookieId[e]=t.resolve(s+"_cookie"),this.lightCookieIntId[e]=t.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[e]=t.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[e]=t.resolve(s+"_cookieOffset"),this.shadowMatrixPaletteId[e]=t.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[e]=t.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[e]=t.resolve(s+"_shadowCascadeCount")}setLTCDirectionallLight(t,e,s,i,n){this.lightPos[e][0]=i.x-s.x*n,this.lightPos[e][1]=i.y-s.y*n,this.lightPos[e][2]=i.z-s.z*n,this.lightPosId[e].setValue(this.lightPos[e]);const a=t.transformVector(new it(-.5,0,0));this.lightWidth[e][0]=a.x*n,this.lightWidth[e][1]=a.y*n,this.lightWidth[e][2]=a.z*n,this.lightWidthId[e].setValue(this.lightWidth[e]);const r=t.transformVector(new it(0,0,.5));this.lightHeight[e][0]=r.x*n,this.lightHeight[e][1]=r.y*n,this.lightHeight[e][2]=r.z*n,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchDirectLights(t,e,s,i){let n=0;const a=this.device.scope;for(let r=0;r<t.length;r++){if(!(t[r].mask&s))continue;const o=t[r],h=o._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(a,n),this.lightColorId[n].setValue(e.gammaCorrection?o._linearFinalColor:o._finalColor),h.getY(o._direction).mulScalar(-1),o._direction.normalize(),this.lightDir[n][0]=o._direction.x,this.lightDir[n][1]=o._direction.y,this.lightDir[n][2]=o._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),o.shape!==$t&&this.setLTCDirectionallLight(h,n,o._direction,i._node.getPosition(),i.farClip),o.castShadows){const t=o.getRenderData(i,0),e=o._getUniformBiasValues(t);this.lightShadowMapId[n].setValue(t.shadowBuffer),this.lightShadowMatrixId[n].setValue(t.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(o._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(o._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(o.numCascades);const s=o._shadowRenderParams;s.length=3,s[0]=o._shadowResolution,s[1]=e.normalBias,s[2]=e.bias,this.lightShadowParamsId[n].setValue(s)}n++}return n}setLTCPositionalLight(t,e){const s=t.transformVector(new it(-.5,0,0));this.lightWidth[e][0]=s.x,this.lightWidth[e][1]=s.y,this.lightWidth[e][2]=s.z,this.lightWidthId[e].setValue(this.lightWidth[e]);const i=t.transformVector(new it(0,0,.5));this.lightHeight[e][0]=i.x,this.lightHeight[e][1]=i.y,this.lightHeight[e][2]=i.z,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchOmniLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),s.shape!==$t&&this.setLTCPositionalLight(n,i),s.castShadows){const t=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(t.shadowBuffer);const e=s._getUniformBiasValues(t),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=e.normalBias,n[2]=e.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),s.shape!==$t&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const t=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(t.shadowBuffer),this.lightShadowMatrixId[i].setValue(t.shadowMatrix.data);const e=s._getUniformBiasValues(t),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=e.normalBias,n[2]=e.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n)}if(s._cookie){if(!s.castShadows){const t=Kr.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(t.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(t,e,s,i,n){let a=i;const r=this.device.scope,o=t[Yt],h=o.length;for(let t=0;t<h;t++){const i=o[t];i.mask&s&&(i.isStatic||(this.dispatchOmniLight(e,r,i,a),a++))}let l=0;if(n){let t=n[l];for(;t&&t._type===Yt;)this.dispatchOmniLight(e,r,t,a),a++,l++,t=n[l]}const c=t[Kt],d=c.length;for(let t=0;t<d;t++){const i=c[t];i.mask&s&&(i.isStatic||(this.dispatchSpotLight(e,r,i,a),a++))}if(n){let t=n[l];for(;t&&t._type===Kt;)this.dispatchSpotLight(e,r,t,a),a++,l++,t=n[l]}}cull(t,e,s){let i=0;const n=e.length,a=t.cullingMask||4294967295;if(!t.frustumCulling){for(let t=0;t<n;t++){const n=e[t];(n.visible||n.command)&&(n.mask&&0==(n.mask&a)||(s[i]=n,i++,n.visibleThisFrame=!0))}return i}for(let r=0;r<n;r++){const n=e[r];if(n.command)s[i]=n,i++,n.visibleThisFrame=!0;else{if(!n.visible)continue;let e=!0;if(n.mask&&0==(n.mask&a))continue;n.cull&&(e=n._isVisible(t)),e&&(s[i]=n,i++,n.visibleThisFrame=!0)}}return i}cullLights(t,e){for(let s=0;s<e.length;s++){const i=e[s];!i.visibleThisFrame&&i.enabled&&(i._type===Xt?i.visibleThisFrame=!0:(i.getBoundingSphere(bc),(t.frustum.containsSphere(bc)||i.castShadows&&!i.shadowMap)&&(i.visibleThisFrame=!0)))}}updateCpuSkinMatrices(t){Ec++;const e=t.length;if(0!==e)for(let s=0;s<e;s++){const e=t[s].skinInstance;e&&(e.updateMatrices(t[s].node,Ec),e._dirty=!0)}}updateGpuSkinMatrices(t){const e=t.length;for(let s=0;s<e;s++){if(!t[s].visibleThisFrame)continue;const e=t[s].skinInstance;e&&e._dirty&&(e.updateMatrixPalette(t[s].node,Ec),e._dirty=!1)}}updateMorphing(t){const e=t.length;for(let s=0;s<e;s++){const e=t[s].morphInstance;e&&e._dirty&&t[s].visibleThisFrame&&e.update()}}setBaseConstants(t,e){t.setCullMode(e.cull),e.opacityMap&&(this.opacityMapId.setValue(e.opacityMap),this.alphaTestId.setValue(e.alphaTest))}setSkinning(t,e,s){e.skinInstance&&(this._skinDrawCalls++,t.supportsBoneTextures?(wc=e.skinInstance.boneTexture,this.boneTextureId.setValue(wc),Sc[0]=wc.width,Sc[1]=wc.height,Sc[2]=1/wc.width,Sc[3]=1/wc.height,this.boneTextureSizeId.setValue(Sc)):this.poseMatrixId.setValue(e.skinInstance.matrixPalette))}drawInstance(t,e,s,i,n){if(Mc=e.instancingData,Mc){if(Mc.count>0&&(this._instancedDrawCalls++,t.setVertexBuffer(Mc.vertexBuffer),t.draw(s.primitive[i],Mc.count),Mc.vertexBuffer===Rc))return this._removedByInstancing+=Mc.count,e.instancingData=null,Mc.count-1}else Tc=e.node.worldTransform,this.modelMatrixId.setValue(Tc.data),n&&(Ac=e.node.normalMatrix,e.node._dirtyNormal&&(Tc.invertTo3x3(Ac),Ac.transpose(),e.node._dirtyNormal=!1),this.normalMatrixId.setValue(Ac.data)),t.draw(s.primitive[i]);return 0}drawInstance2(t,e,s,i){if(Mc=e.instancingData,Mc){if(Mc.count>0&&(this._instancedDrawCalls++,t.draw(s.primitive[i],Mc.count,!0),Mc.vertexBuffer===Rc))return this._removedByInstancing+=Mc.count,e.instancingData=null,Mc.count-1}else t.draw(s.primitive[i],void 0,!0);return 0}renderShadows(t,e){const s=this.device;s.grabPassAvailable=!1;for(let s=0;s<t.length;s++)this._shadowRenderer.render(t[s],e);s.grabPassAvailable=!0}renderCookies(t){const e=this.lightTextureAtlas.cookieRenderTarget;for(let s=0;s<t.length;s++)this._cookieRenderer.render(t[s],e)}updateShader(t,e,s,i,n){t.material._scene=this.scene,t.material._dirtyBlend&&(this.scene.layers._dirtyBlend=!0),t.material.updateShader(this.device,this.scene,e,s,i,n),t._shader[i]=t.material.shader}setCullMode(t,e,s){const i=s.material;let n=oi;if(t){let t=1;if(i.cull>oi&&i.cull<ci){s.flipFaces&&(t*=-1),e&&(t*=-1);const i=s.node.worldTransform;i.getX(yc),i.getY(vc),i.getZ(xc),yc.cross(yc,vc),yc.dot(xc)<0&&(t*=-1)}n=t<0?i.cull===li?hi:li:i.cull}if(this.device.setCullMode(n),n===oi&&i.cull===oi){const t=s.node.worldTransform;t.getX(yc),t.getY(vc),t.getZ(xc),yc.cross(yc,vc),yc.dot(xc)<0?this.twoSidedLightingNegScaleFactorId.setValue(-1):this.twoSidedLightingNegScaleFactorId.setValue(1)}}setVertexBuffers(t,e){t.setVertexBuffer(e.vertexBuffer)}setMorphing(t,e){if(e)if(e.morph.useTextureMorph)t.setVertexBuffer(e.morph.vertexBufferIds),this.morphPositionTex.setValue(e.texturePositions),this.morphNormalTex.setValue(e.textureNormals),this.morphTexParams.setValue(e._textureParams);else{for(let s=0;s<e._activeVertexBuffers.length;s++){const i=e._activeVertexBuffers[s];if(i){const e=Mn+(s+8);i.format.elements[0].name=e,i.format.elements[0].scopeId=t.scope.resolve(e),i.format.update(),t.setVertexBuffer(i)}}this.morphWeightsA.setValue(e._shaderMorphWeightsA),this.morphWeightsB.setValue(e._shaderMorphWeightsB)}}dispatchViewPos(t){const e=this.viewPos;e[0]=t.x,e[1]=t.y,e[2]=t.z,this.viewPosId.setValue(e)}renderForwardPrepareMaterials(t,e,s,i,n,a,r){const o=(t,e,s)=>{Lc.drawCalls.push(t),Lc.isNewMaterial.push(e),Lc.lightMaskChanged.push(s)};Lc.drawCalls.length=0,Lc.isNewMaterial.length=0,Lc.lightMaskChanged.length=0;const h=this.device,l=this.scene,c=a?a._lightHash:0;let d,u,p,m=null;for(let t=0;t<s;t++){const s=e[t];if(!n||!s.mask||n&s.mask)if(s.command)o(s,!1,!1);else{s.material||(s.material=Eo.get(h));const t=s.material,e=s._shaderDefs,n=s.mask;if(t&&t===m&&e!==d&&(m=null),(s.isStatic||u)&&(m=null),t!==m&&(this._materialSwitches++,t.dirty&&(t.updateUniforms(h,l),t.dirty=!1),!s._shader[r]||s._shaderDefs!==e||s._lightHash!==c)){if(s.isStatic)this.updateShader(s,e,s._staticLightList,r,i);else{const n=r+"_"+e+"_"+c;s._shader[r]=t.variants[n],s._shader[r]||(this.updateShader(s,e,null,r,i),t.variants[n]=s._shader[r])}s._shaderDefs=e,s._lightHash=c}o(s,t!==m,!m||n!==p),m=t,d=e,p=n,u=s.isStatic}}return Lc}renderForward(t,e,s,i,n,a,r,o,h){const l=this.device,c=this.scene,d=t.vrDisplay,u=1<<n,p=.5*l.width,m=this.renderForwardPrepareMaterials(t,e,s,i,a,o,n),f=m.drawCalls.length;for(let e=0;e<f;e++){const s=m.drawCalls[e];if(s.command)s.command();else{const a=m.isNewMaterial[e],o=m.lightMaskChanged[e],_=s.material;s._shaderDefs;const g=s.mask;if(a){if(s._shader[n].failed||l.setShader(s._shader[n])||(s._shader[n].failed=!0),_.setParameters(l),o){const e=this.dispatchDirectLights(i[Xt],c,g,t);this.dispatchLocalLights(i,c,g,e,s._staticLightList)}this.alphaTestId.setValue(_.alphaTest),l.setBlending(_.blend),_.blend&&(_.separateAlphaBlend?(l.setBlendFunctionSeparate(_.blendSrc,_.blendDst,_.blendSrcAlpha,_.blendDstAlpha),l.setBlendEquationSeparate(_.blendEquation,_.blendAlphaEquation)):(l.setBlendFunction(_.blendSrc,_.blendDst),l.setBlendEquation(_.blendEquation))),l.setColorWrite(_.redWrite,_.greenWrite,_.blueWrite,_.alphaWrite),l.setDepthWrite(_.depthWrite),_.depthWrite&&!_.depthTest?(l.setDepthFunc(xi),l.setDepthTest(!0)):(l.setDepthFunc(vi),l.setDepthTest(_.depthTest)),l.setAlphaToCoverage(_.alphaToCoverage),_.depthBias||_.slopeDepthBias?(l.setDepthBias(!0),l.setDepthBiasValues(_.depthBias,_.slopeDepthBias)):l.setDepthBias(!1)}this.setCullMode(t._cullFaces,h,s);const y=s.stencilFront||_.stencilFront,v=s.stencilBack||_.stencilBack;y||v?(l.setStencilTest(!0),y===v?(l.setStencilFunc(y.func,y.ref,y.readMask),l.setStencilOperation(y.fail,y.zfail,y.zpass,y.writeMask)):(y?(l.setStencilFuncFront(y.func,y.ref,y.readMask),l.setStencilOperationFront(y.fail,y.zfail,y.zpass,y.writeMask)):(l.setStencilFuncFront(xi,0,255),l.setStencilOperationFront(Wn,Wn,Wn,255)),v?(l.setStencilFuncBack(v.func,v.ref,v.readMask),l.setStencilOperationBack(v.fail,v.zfail,v.zpass,v.writeMask)):(l.setStencilFuncBack(xi,0,255),l.setStencilOperationBack(Wn,Wn,Wn,255)))):l.setStencilTest(!1);const x=s.mesh;s.setParameters(l,u),this.setVertexBuffers(l,x),this.setMorphing(l,s.morphInstance),this.setSkinning(l,s,_);const b=s.renderStyle;if(l.setIndexBuffer(x.indexBuffer[b]),r&&r(s,e),d&&d.presenting)l.setViewport(0,0,p,l.height),this.projId.setValue(uc.data),this.projSkyboxId.setValue(uc.data),this.viewInvId.setValue(rc.data),this.viewId.setValue(hc.data),this.viewId3.setValue(mc.data),this.viewProjId.setValue(_c.data),this.dispatchViewPos(cc),e+=this.drawInstance(l,s,x,b,!0),this._forwardDrawCalls++,l.setViewport(p,0,p,l.height),this.projId.setValue(pc.data),this.projSkyboxId.setValue(pc.data),this.viewInvId.setValue(oc.data),this.viewId.setValue(lc.data),this.viewId3.setValue(fc.data),this.viewProjId.setValue(gc.data),this.dispatchViewPos(dc),e+=this.drawInstance2(l,s,x,b),this._forwardDrawCalls++;else if(t.xr&&t.xr.session&&t.xr.views.length){const i=t.xr.views;for(let t=0;t<i.length;t++){const n=i[t];l.setViewport(n.viewport.x,n.viewport.y,n.viewport.z,n.viewport.w),this.projId.setValue(n.projMat.data),this.projSkyboxId.setValue(n.projMat.data),this.viewId.setValue(n.viewOffMat.data),this.viewInvId.setValue(n.viewInvOffMat.data),this.viewId3.setValue(n.viewMat3.data),this.viewProjId.setValue(n.projViewOffMat.data),this.viewPosId.setValue(n.position),e+=0===t?this.drawInstance(l,s,x,b,!0):this.drawInstance2(l,s,x,b),this._forwardDrawCalls++}}else e+=this.drawInstance(l,s,x,b,!0),this._forwardDrawCalls++;e<f-1&&!m.isNewMaterial[e+1]&&_.setParameters(l,s.parameters)}}l.updateEnd(),Lc.length=0}setupInstancing(t){t.enableAutoInstancing&&(Rc||(Rc=new $a(t,Ja.defaultInstancingFormat,t.autoInstancingMaxObjects,ei)))}updateShaders(t,e){const s=t.length;for(let i=0;i<s;i++){const s=t[i].material;if(s&&!Ic.has(s)&&(Ic.add(s),s.updateShader!==Io.prototype.updateShader)){if(e&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants(),s.shader=null}}Ic.clear()}beginFrame(t,e){const s=t._meshInstances,i=this.scene;if(i.updateShaders||e){const t=!i.updateShaders&&e;this.updateShaders(s,t),i.updateShaders=!1,i._shaderVersion++}this.updateCpuSkinMatrices(s);const n=s.length;for(let t=0;t<n;t++)s[t].visibleThisFrame=!1;const a=t._lights,r=a.length;for(let t=0;t<r;t++)a[t].visibleThisFrame=a[t]._type===Xt}beginLayers(t){const e=t.layerList.length;for(let s=0;s<e;s++)t.layerList[s]._postRenderCounter=0;const s=this.scene,i=s._shaderVersion;for(let n=0;n<e;n++){const e=t.layerList[n];e._shaderVersion=i,e._preRenderCalledForCameras=0,e._postRenderCalledForCameras=0;const a=t.subLayerList[n];e._postRenderCounter|=a?2:1,e._postRenderCounterMax=e._postRenderCounter;for(let t=0;t<e.cameras.length;t++)e.instances.prepare(t);e._needsStaticPrepare&&e._staticLightHash&&(e._staticPrepareDone&&(Zl.revert(e.opaqueMeshInstances),Zl.revert(e.transparentMeshInstances)),Zl.prepare(this.device,s,e.opaqueMeshInstances,e._lights),Zl.prepare(this.device,s,e.transparentMeshInstances,e._lights),t._dirty=!0,s.updateShaders=!0,e._needsStaticPrepare=!1,e._staticPrepareDone=!0)}}gpuUpdate(t){this.updateGpuSkinMatrices(t),this.updateMorphing(t)}setSceneConstants(){const t=this.scene;if(this.dispatchGlobalLights(t),t.fog!==kt){if(this.fogColor[0]=t.fogColor.r,this.fogColor[1]=t.fogColor.g,this.fogColor[2]=t.fogColor.b,t.gammaCorrection)for(let t=0;t<3;t++)this.fogColor[t]=Math.pow(this.fogColor[t],2.2);this.fogColorId.setValue(this.fogColor),t.fog===Bt?(this.fogStartId.setValue(t.fogStart),this.fogEndId.setValue(t.fogEnd)):this.fogDensityId.setValue(t.fogDensity)}const e=this.device;this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize)}updateLightStats(t,e){}cullShadowmaps(t){for(let e=0;e<t._lights.length;e++){const s=t._lights[e];if(s._type!==Xt&&s.visibleThisFrame&&s.castShadows&&s.shadowUpdateMode!==ts){const i=t._lightCompositionData[e].shadowCastersList;this._shadowRenderer.cullLocal(s,i)}}const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.directionalLightsIndices.length;for(let e=0;e<n;e++){const s=i.directionalLightsIndices[e],n=t._lights[s],a=t._lightCompositionData[s].shadowCastersList;this._shadowRenderer.cullDirectional(n,a,i.camera.camera)}}}cullComposition(t){const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.layerIndex,a=t.layerList[n];if(!a.enabled||!t.subLayerEnabled[n])continue;const r=t.subLayerList[n],o=i.cameraIndex,h=a.cameras[o];if(h){h.frameBegin(i.renderTarget),i.firstCameraUse&&(this.updateCameraFrustum(h.camera),this._camerasRendered++),this.cullLights(h.camera,a._lights);const t=a.instances,e=r?t.visibleTransparent[o]:t.visibleOpaque[o];if(!e.done){a.onPreCull&&a.onPreCull(o);const t=r?a.transparentMeshInstances:a.opaqueMeshInstances;e.length=this.cull(h.camera,t,e.list),e.done=!0,a.onPostCull&&a.onPostCull(o)}h.frameEnd()}}this.cullShadowmaps(t)}updateLightTextureAtlas(t){this.lightTextureAtlas.update(t._splitLights[Kt],t._splitLights[Yt],this.scene.lighting)}updateClusters(t){for(let e=0;e<t._worldClusters.length;e++){t._worldClusters[e].update(t._lights,this.scene.gammaCorrection,this.scene.lighting)}}renderComposition(t){const e=this.device,s=this.scene.clusteredLightingEnabled;this.scene._updateSkybox(this.device),this.beginLayers(t);const i=t._update(s),n=0!=(i&Cs);this.updateLightStats(t,i),this.beginFrame(t,n),this.setSceneConstants(),this.cullComposition(t),this.gpuUpdate(t._meshInstances),s&&(this.updateLightTextureAtlas(t),this.scene.lighting.cookiesEnabled&&(this.renderCookies(t._splitLights[Kt]),this.renderCookies(t._splitLights[Yt]))),(!s||s&&this.scene.lighting.shadowsEnabled)&&(this.renderShadows(t._splitLights[Kt]),this.renderShadows(t._splitLights[Yt])),s&&this.updateClusters(t);const a=t._renderActions;for(let i=0;i<a.length;i++){const n=a[i],o=n.layerIndex,h=t.layerList[o],l=t.subLayerList[o],c=n.cameraIndex,d=h.cameras[c];if(n.directionalLights.length>0&&this.renderShadows(n.directionalLights,d.camera),h.enabled&&t.subLayerEnabled[o]){if(d&&(d.frameBegin(n.renderTarget),n.firstCameraUse&&d.onPreRender&&d.onPreRender()),!l&&h.onPreRenderOpaque?h.onPreRenderOpaque(c):l&&h.onPreRenderTransparent&&h.onPreRenderTransparent(c),h._preRenderCalledForCameras&1<<c||(h.onPreRender&&h.onPreRender(c),h._preRenderCalledForCameras|=1<<c),d){var r;if(n.clearColor||n.clearDepth||n.clearStencil){const t=d.camera._clearColorBuffer,e=d.camera._clearDepthBuffer,s=d.camera._clearStencilBuffer;d.camera._clearColorBuffer=n.clearColor,d.camera._clearDepthBuffer=n.clearDepth,d.camera._clearStencilBuffer=n.clearStencil,this.clearView(d.camera,n.renderTarget,!0,!0),d.camera._clearColorBuffer=t,d.camera._clearDepthBuffer=e,d.camera._clearStencilBuffer=s}h._sortVisible(l,d.camera.node,c);const t=h.instances,i=l?t.visibleTransparent[c]:t.visibleOpaque[c];this.scene._activeCamera=d.camera,this.setCamera(d.camera,n.renderTarget),s&&n.lightClusters&&n.lightClusters.activate(this.lightTextureAtlas);const a=!!(d.camera._flipFaces^(null==n||null==(r=n.renderTarget)?void 0:r.flipY)),o=this._forwardDrawCalls;this.renderForward(d.camera,i.list,i.length,h._splitLights,h.shaderPass,h.cullingMask,h.onDrawCall,h,a),h._forwardDrawCalls+=this._forwardDrawCalls-o,e.setColorWrite(!0,!0,!0,!0),e.setStencilTest(!1),e.setAlphaToCoverage(!1),e.setDepthBias(!1),d.frameEnd(),n.lastCameraUse&&d.onPostRender&&d.onPostRender(),n.triggerPostprocess&&d.onPostprocessing&&d.onPostprocessing()}!l&&h.onPostRenderOpaque?h.onPostRenderOpaque(c):l&&h.onPostRenderTransparent&&h.onPostRenderTransparent(c),!h.onPostRender||h._postRenderCalledForCameras&1<<c||(h._postRenderCounter&=~(l?2:1),0===h._postRenderCounter&&(h.onPostRender(c),h._postRenderCalledForCameras|=1<<c,h._postRenderCounter=h._postRenderCounterMax))}}}}let Fc,Oc,kc,Bc;const zc=[null,function(t,e){return t.drawOrder-e.drawOrder},function(t,e){return Fc=t._key[is],Oc=e._key[is],Fc===Oc&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Oc-Fc},function(t,e){return e.zdist-t.zdist},function(t,e){return t.zdist-e.zdist}];function Uc(t,e){return e.key-t.key}let Vc=0;class Nc{constructor(){this.list=[],this.length=0,this.done=!1}}class Wc{constructor(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}prepare(t){this.visibleOpaque[t]||(this.visibleOpaque[t]=new Nc),this.visibleTransparent[t]||(this.visibleTransparent[t]=new Nc),this.visibleOpaque[t].done=!1,this.visibleTransparent[t].done=!1}delete(t){t<this.visibleOpaque.length&&this.visibleOpaque.splice(t,1),t<this.visibleTransparent.length&&this.visibleTransparent.splice(t,1)}}class Gc{constructor(t={}){void 0!==t.id?(this.id=t.id,Vc=Math.max(this.id+1,Vc)):this.id=Vc++,this.name=t.name,this._enabled=void 0===t.enabled||t.enabled,this._refCounter=this._enabled?1:0,this.opaqueSortMode=void 0===t.opaqueSortMode?Ss:t.opaqueSortMode,this.transparentSortMode=void 0===t.transparentSortMode?ws:t.transparentSortMode,this.renderTarget=t.renderTarget,this.shaderPass=void 0===t.shaderPass?hs:t.shaderPass,this.passThrough=void 0!==t.passThrough&&t.passThrough,this._clearColorBuffer=!!t.clearColorBuffer&&t.clearColorBuffer,this._clearDepthBuffer=!!t.clearDepthBuffer&&t.clearDepthBuffer,this._clearStencilBuffer=!!t.clearStencilBuffer&&t.clearStencilBuffer,this.onPreCull=t.onPreCull,this.onPreRender=t.onPreRender,this.onPreRenderOpaque=t.onPreRenderOpaque,this.onPreRenderTransparent=t.onPreRenderTransparent,this.onPostCull=t.onPostCull,this.onPostRender=t.onPostRender,this.onPostRenderOpaque=t.onPostRenderOpaque,this.onPostRenderTransparent=t.onPostRenderTransparent,this.onDrawCall=t.onDrawCall,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=t.layerReference,this.instances=t.layerReference?t.layerReference.instances:new Wc,this.cullingMask=t.cullingMask?t.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}get renderTarget(){return this._renderTarget}set renderTarget(t){this._renderTarget=t,this._dirtyCameras=!0}get enabled(){return this._enabled}set enabled(t){t!==this._enabled&&(this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get clearColor(){return this._clearColor}set clearColor(t){this._clearColor.copy(t)}get clearColorBuffer(){return this._clearColorBuffer}set clearColorBuffer(t){this._clearColorBuffer=t,this._dirtyCameras=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t,this._dirtyCameras=!0}get clearStencilBuffer(){return this._clearStencilBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t,this._dirtyCameras=!0}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(t,e){const s=this._shaderVersion,i=this.shadowCasters;for(let n=0;n<t.length;n++){const a=t[n],r=a.material,o=r.blendType===Pt?this.opaqueMeshInstances:this.transparentMeshInstances;this.opaqueMeshInstances.indexOf(a)<0&&this.transparentMeshInstances.indexOf(a)<0&&o.push(a),!e&&a.castShadow&&i.indexOf(a)<0&&i.push(a),!this.passThrough&&s>=0&&r._shaderVersion!==s&&(r.updateShader!==Io.prototype.updateShader&&(r.clearVariants(),r.shader=null),r._shaderVersion=s)}this.passThrough||(this._dirty=!0)}removeMeshInstanceFromArray(t,e){let s=-1,i=0;const n=e.length;for(let a=0;a<n;a++){const n=e[a];if(n===t){s=a,i=1;break}if(n._staticSource===t)s<0&&(s=a),i++;else if(s>=0)break}s>=0&&e.splice(s,i)}removeMeshInstances(t,e){const s=this.opaqueMeshInstances,i=this.transparentMeshInstances,n=this.shadowCasters;for(let a=0;a<t.length;a++){const r=t[a];if(this.removeMeshInstanceFromArray(r,s),this.removeMeshInstanceFromArray(r,i),!e){const t=n.indexOf(r);t>=0&&n.splice(t,1)}}this._dirty=!0}clearMeshInstances(t){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!t&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,t||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))}addLight(t){const e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),e.type!==Xt&&this._clusteredLightsSet.add(e),this._lights.push(e),this._dirtyLights=!0,this._generateLightHash())}removeLight(t){const e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),e.type!==Xt&&this._clusteredLightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this._dirtyLights=!0,this._generateLightHash())}clearLights(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0}get clusteredLightsSet(){return this._clusteredLightsSet}addShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=t[s];i.castShadow&&(e.indexOf(i)<0&&e.push(i))}this._dirtyLights=!0}removeShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=e.indexOf(t[s]);i>=0&&e.splice(i,1)}this._dirtyLights=!0}_generateLightHash(){if(this._lights.length>0){this._lights.sort(Uc);let t="",e="";for(let s=0;s<this._lights.length;s++)this._lights[s].isStatic?e+=this._lights[s].key:t+=this._lights[s].key;0===t.length?this._lightHash=0:this._lightHash=Za(t),0===e.length?this._staticLightHash=0:this._staticLightHash=Za(e)}else this._lightHash=0,this._staticLightHash=0}addCamera(t){this.cameras.indexOf(t)>=0||(this.cameras.push(t),this._dirtyCameras=!0)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this._dirtyCameras=!0,this.instances.delete(e))}clearCameras(){this.cameras.length=0,this._dirtyCameras=!0}_calculateSortDistances(t,e,s,i){for(let n=0;n<e;n++){const e=t[n];if(e.command)continue;if(e.layer<=Vt)continue;if(e.calculateSortDistance){e.zdist=e.calculateSortDistance(e,s,i);continue}const a=e.aabb.center,r=a.x-s.x,o=a.y-s.y,h=a.z-s.z;e.zdist=r*i.x+o*i.y+h*i.z}}_sortVisible(t,e,s){const i=this.instances,n=t?this.transparentSortMode:this.opaqueSortMode;if(n===xs)return;const a=t?i.visibleTransparent[s]:i.visibleOpaque[s];n===Ts?(kc=e.getPosition(),Bc=e.forward,this.customCalculateSortValues&&this.customCalculateSortValues(a.list,a.length,kc,Bc),a.list.length!==a.length&&(a.list.length=a.length),this.customSortCallback&&a.list.sort(this.customSortCallback)):(n!==ws&&n!==Ms||(kc=e.getPosition(),Bc=e.forward,this._calculateSortDistances(a.list,a.length,kc,Bc)),a.list.length!==a.length&&(a.list.length=a.length),a.list.sort(zc[n]))}}const Hc=function(t,e){if(t.size!==e.size)return!1;for(const s of t)if(!e.has(s))return!1;return!0};class jc{constructor(){this.layerIndex=0,this.cameraIndex=0,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.directionalLightsSet=new Set,this.directionalLights=[],this.directionalLightsIndices=[]}reset(){this.lightClusters=null,this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0}collectDirectionalLights(t,e,s){this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0;for(let i=0;i<e.length;i++){const n=e[i];if(n.castShadows)for(let e=0;e<t.length;e++)if(t[e]._splitLights[Xt].indexOf(n)>=0&&!this.directionalLightsSet.has(n)){this.directionalLightsSet.add(n),this.directionalLights.push(n);const t=s.indexOf(n);this.directionalLightsIndices.push(t)}}}}class qc{constructor(){this.shadowCastersSet=new Set,this.shadowCastersList=[]}clearShadowCasters(){this.shadowCastersSet.clear(),this.shadowCastersList.length=0}addShadowCasters(t){for(let e=0;e<t.length;e++){const s=t[e];this.shadowCastersSet.has(s)||(this.shadowCastersSet.add(s),this.shadowCastersList.push(s))}}}const Xc=new Set,Yc=[];class Kc extends u{constructor(t,e="Untitled"){var s;super(),"string"==typeof t&&(e=t=null),this.device=t||(null==(s=Fh())?void 0:s.graphicsDevice),this.name=e,this.logRenderActions=!1,this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirty=!1,this._dirtyBlend=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._meshInstances=[],this._meshInstancesSet=new Set,this._lights=[],this._lightsMap=new Map,this._lightCompositionData=[],this._splitLights=[[],[],[]],this.cameras=[],this._renderActions=[],this._worldClusters=[],this._emptyWorldClusters=null}destroy(){this._emptyWorldClusters&&(this._emptyWorldClusters.destroy(),this._emptyWorldClusters=null),this._worldClusters.forEach((t=>{t.destroy()})),this._worldClusters=null}get emptyWorldClusters(){return this._emptyWorldClusters||(this._emptyWorldClusters=new Cl(this.device),this._emptyWorldClusters.name="ClusterEmpty",this._emptyWorldClusters.update([],!1,null)),this._emptyWorldClusters}_splitLightsArray(t){const e=t._lights;t._splitLights[Xt].length=0,t._splitLights[Yt].length=0,t._splitLights[Kt].length=0;for(let s=0;s<e.length;s++){const i=e[s];i.enabled&&t._splitLights[i._type].push(i)}}_update(t=!1){const e=this.layerList.length;let s=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(let t=0;t<e;t++){const e=this.layerList[t];e._dirty&&(this._dirty=!0),e._dirtyLights&&(this._dirtyLights=!0),e._dirtyCameras&&(this._dirtyCameras=!0)}function i(t,e,s){let i=!1;const n=s.length;for(let a=0;a<n;a++){const n=s[a];if(!e.has(n)){e.add(n),t.push(n);const s=n.material;s&&s._dirtyBlend&&(i=!0,s._dirtyBlend=!1)}}return i}if(this._dirty){s|=As,this._meshInstances.length=0,this._meshInstancesSet.clear();for(let t=0;t<e;t++){const e=this.layerList[t];e.passThrough||(this._dirtyBlend=i(this._meshInstances,this._meshInstancesSet,e.opaqueMeshInstances)||this._dirtyBlend,this._dirtyBlend=i(this._meshInstances,this._meshInstancesSet,e.transparentMeshInstances)||this._dirtyBlend),e._dirty=!1}this._dirty=!1}function n(t,e,s){for(let i=0;i<e.length;){const n=e[i].material;(n&&n.blendType!==Pt)===s?(t.push(e[i]),e[i]=e[e.length-1],e.length--):i++}}if(this._dirtyBlend){s|=Rs;for(let t=0;t<e;t++){const e=this.layerList[t];e.passThrough||(n(e.opaqueMeshInstances,e.transparentMeshInstances,!1),n(e.transparentMeshInstances,e.opaqueMeshInstances,!0))}this._dirtyBlend=!1}if(this._dirtyLights&&(s|=Cs,this._dirtyLights=!1,this.updateLights()),s&&this.updateShadowCasters(),this._dirtyCameras||s&Cs){this._dirtyCameras=!1,s|=Ps,this.cameras.length=0;for(let t=0;t<e;t++){const e=this.layerList[t];e._dirtyCameras=!1;for(let t=0;t<e.cameras.length;t++){const s=e.cameras[t];this.cameras.indexOf(s)<0&&this.cameras.push(s)}}this.cameras.length>1&&this.cameras.sort(((t,e)=>t.priority-e.priority));const i=[];let n=0;for(let t=0;t<this.cameras.length;t++){const s=this.cameras[t];i.length=0;let a=!0;const r=n;let o=null,h=!1;for(let t=0;t<e;t++){const e=this.layerList[t];if(e&&e.cameras.length>0&&s.layers.indexOf(e.id)>=0){i.push(e),h||e.id!==s.disablePostEffectsLayer||(h=!0,o&&(o.triggerPostprocess=!0));const r=e.cameras.indexOf(s);r>=0&&(o=this.addRenderAction(this._renderActions,n,e,t,r,a,h),n++,a=!1)}}r<n&&(this._renderActions[r].collectDirectionalLights(i,this._splitLights[Xt],this._lights),o.lastCameraUse=!0),!h&&o&&(o.triggerPostprocess=!0),s.renderTarget&&s.postEffectsEnabled&&this.propagateRenderTarget(r-1,s)}this._renderActions.length=n,t&&this.allocateLightClusters()}return(s&Cs||s&Ps)&&this._logRenderActions(),s}updateShadowCasters(){const t=this._lights.length;for(let e=0;e<t;e++)this._lightCompositionData[e].clearShadowCasters();const e=this.layerList.length;for(let t=0;t<e;t++){const e=this.layerList[t];if(!Xc.has(e)){Xc.add(e);const t=e._lights;for(let s=0;s<t.length;s++)if(t[s].castShadows){const i=this._lightsMap.get(t[s]);this._lightCompositionData[i].addShadowCasters(e.shadowCasters)}}}Xc.clear()}updateLights(){this._lights.length=0,this._lightsMap.clear();const t=this.layerList.length;for(let e=0;e<t;e++){const t=this.layerList[e];if(!Xc.has(t)){Xc.add(t);const e=t._lights;for(let t=0;t<e.length;t++){const s=e[t];let i=this._lightsMap.get(s);if(void 0===i){i=this._lights.length,this._lightsMap.set(s,i),this._lights.push(s);let t=this._lightCompositionData[i];t||(t=new qc,this._lightCompositionData[i]=t)}}}this._splitLightsArray(t),t._dirtyLights=!1}Xc.clear(),this._splitLightsArray(this);const e=this._lights.length;this._lightCompositionData.length=e}findCompatibleCluster(t,e){for(let s=0;s<e;s++){const e=this._renderActions[s],i=this.layerList[e.layerIndex];if(t===i)return e.lightClusters;if(e.lightClusters&&Hc(t._clusteredLightsSet,i._clusteredLightsSet))return e.lightClusters}return null}allocateLightClusters(){Yc.push(...this._worldClusters),this._worldClusters.length=0;const t=this._renderActions.length;for(let e=0;e<t;e++){const t=this._renderActions[e],s=this.layerList[t.layerIndex];if(s._clusteredLightsSet.size){if((this.subLayerList[t.layerIndex]?s.transparentMeshInstances:s.opaqueMeshInstances).length){let i=this.findCompatibleCluster(s,e);i||(Yc.length&&(i=Yc.pop()),i||(i=new Cl(this.device)),i.name="Cluster-"+this._worldClusters.length,this._worldClusters.push(i)),t.lightClusters=i}}t.lightClusters||(t.lightClusters=this.emptyWorldClusters)}Yc.forEach((t=>{t.destroy()})),Yc.length=0}addRenderAction(t,e,s,i,n,a,r){let o=t[e];o||(o=t[e]=new jc);let h=s.renderTarget;const l=s.cameras[n];l&&l.renderTarget&&s.id!==Gt&&(h=l.renderTarget);let c=!1;for(let s=e-1;s>=0;s--)if(t[s].camera===l&&t[s].renderTarget===h){c=!0;break}const d=a||!c;let u=!!d&&l.clearColorBuffer,p=!!d&&l.clearDepthBuffer,m=!!d&&l.clearStencilBuffer;return u|=s.clearColorBuffer,p|=s.clearDepthBuffer,m|=s.clearStencilBuffer,r&&l.postEffectsEnabled&&(h=null),o.reset(),o.triggerPostprocess=!1,o.layerIndex=i,o.cameraIndex=n,o.camera=l,o.renderTarget=h,o.clearColor=u,o.clearDepth=p,o.clearStencil=m,o.firstCameraUse=a,o.lastCameraUse=!1,o}propagateRenderTarget(t,e){for(let s=t;s>=0;s--){const t=this._renderActions[s],i=this.layerList[t.layerIndex];if(t.renderTarget&&i.id!==Gt)break;if(i.id===Gt)continue;const n=null==t?void 0:t.camera.camera;if(n&&(!e.camera.rect.equals(n.rect)||!e.camera.scissorRect.equals(n.scissorRect)))break;t.renderTarget=e.renderTarget}}_logRenderActions(){}_isLayerAdded(t){return this.layerList.indexOf(t)>=0}_isSublayerAdded(t,e){for(let s=0;s<this.layerList.length;s++)if(this.layerList[s]===t&&this.subLayerList[s]===e)return!0;return!1}push(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insert(t,e){if(this._isLayerAdded(t))return;this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(e,s-1),this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}remove(t){let e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];e>=0;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("remove",t);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1)}pushOpaque(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertOpaque(t,e){if(this._isSublayerAdded(t,!1))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeOpaque(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&!this.subLayerList[e])return this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(t)<0&&this.fire("remove",t))}pushTransparent(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertTransparent(t,e){if(this._isSublayerAdded(t,!0))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeTransparent(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&this.subLayerList[e])return this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(t)<0&&this.fire("remove",t))}_getSublayerIndex(t,e){let s=this.layerList.indexOf(t);if(s<0)return-1;if(this.subLayerList[s]!==e){if(s=this.layerList.indexOf(t,s+1),s<0)return-1;if(this.subLayerList[s]!==e)return-1}return s}getOpaqueIndex(t){return this._getSublayerIndex(t,!1)}getTransparentIndex(t){return this._getSublayerIndex(t,!0)}getLayerById(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].id===t)return this.layerList[e];return null}getLayerByName(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].name===t)return this.layerList[e];return null}_updateOpaqueOrder(t,e){for(let s=t;s<=e;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(t,e){for(let s=t;s<=e;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(t,e,s){let i=-1,n=-1;for(let e=0,n=t.length;e<n;e++){const n=t[e];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]))}for(let t=0,i=e.length;t<i;t++){const i=e[t];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)}sortOpaqueLayers(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)}}const $c=new it,Zc=new it,Jc=new it,Qc={bias:0,normalBias:0},td={r:0,g:1,b:2,a:3},ed=[[new nt(0,0,1,1)],[new nt(0,0,.5,.5),new nt(0,.5,.5,.5)],[new nt(0,0,.5,.5),new nt(0,.5,.5,.5),new nt(.5,0,.5,.5)],[new nt(0,0,.5,.5),new nt(0,.5,.5,.5),new nt(.5,0,.5,.5),new nt(.5,.5,.5,.5)]];class sd{constructor(t,e,s,i){this.light=i,this.camera=e,this.shadowCamera=Kl.createShadowCamera(t,i._shadowType,i._type,s),this.shadowMatrix=new dt,this.shadowViewport=new nt(0,0,1,1),this.shadowScissor=new nt(0,0,1,1),this.face=s,this.visibleCasters=[]}get shadowBuffer(){const t=this.shadowCamera.renderTarget;if(t){const e=this.light;return e._type===Yt?t.colorBuffer:e._isPcf&&e.device.webgl2?t.depthBuffer:t.colorBuffer}return null}}class id{constructor(t){this.device=t,this._type=Xt,this._color=new J(.8,.8,.8),this._intensity=1,this._castShadows=!1,this._enabled=!1,this.mask=as,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=te,this._shadowType=se,this._vsmBlurSize=11,this.vsmBlurMode=ce,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=$t,this._finalColor=new Float32Array([.8,.8,.8]);const e=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([e,e,e]),this._position=new it(0,0,0),this._direction=new it(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowMap=null,this._shadowRenderParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=ss,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1}destroy(){this._destroyShadowMap(),this._renderData=null}_destroyShadowMap(){this._renderData&&(this._renderData.length=0),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),this.shadowUpdateMode===ts&&(this.shadowUpdateMode=es)}getRenderData(t,e){for(let s=0;s<this._renderData.length;s++){const i=this._renderData[s];if(i.camera===t&&i.face===e)return i}const s=new sd(this.device,t,e,this);return this._renderData.push(s),s}clone(){const t=new id(this.device);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.shape=this._shape,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t}_getUniformBiasValues(t){const e=t.shadowCamera._farClip;switch(this._type){case Yt:Qc.bias=this.shadowBias,Qc.normalBias=this._normalOffsetBias;break;case Kt:this._isVsm?Qc.bias=-2e-4:(Qc.bias=20*this.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(Qc.bias*=-100)),Qc.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case Xt:this._isVsm?Qc.bias=-2e-4:(Qc.bias=this.shadowBias/e*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(Qc.bias*=-100)),Qc.normalBias=this._isVsm?this.vsmBias/(e/7):this._normalOffsetBias}return Qc}get numCascades(){return this.cascades.length}set numCascades(t){this.cascades&&this.numCascades==t||(this.cascades=ed[t-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get shadowMap(){return this._shadowMap}set shadowMap(t){this._shadowMap!==t&&(this._destroyShadowMap(),this._shadowMap=t)}get numShadowFaces(){const t=this._type;return t===Xt?this.numCascades:t===Yt?6:1}getColor(){return this._color}getBoundingSphere(t){if(this._type===Kt){const e=this.attenuationEnd,s=this._outerConeAngle,i=Math.cos(s*V.DEG_TO_RAD),n=this._node;$c.copy(n.up),$c.mulScalar(.5*-e*i),$c.add(n.getPosition()),t.center=$c,Zc.copy(n.up),Zc.mulScalar(-e),Jc.copy(n.right),Jc.mulScalar(Math.sin(s*V.DEG_TO_RAD)*e),Zc.add(Jc),t.radius=.5*Zc.length()}else this._type===Yt&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)}getBoundingBox(t){if(this._type===Kt){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*V.DEG_TO_RAD)*e);t.center.set(0,.5*-e,0),t.halfExtents.set(n,.5*e,n),t.setFromTransformedAabb(t,i.getWorldTransform())}else this._type===Yt&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateFinalColor(){const t=this._color,e=t.r,s=t.g,i=t.b,n=this._intensity,a=this._finalColor,r=this._linearFinalColor;a[0]=e*n,a[1]=s*n,a[2]=i*n,n>=1?(r[0]=Math.pow(e,2.2)*n,r[1]=Math.pow(s,2.2)*n,r[2]=Math.pow(i,2.2)*n):(r[0]=Math.pow(a[0],2.2),r[1]=Math.pow(a[1],2.2),r[2]=Math.pow(a[2],2.2))}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}updateShadow(){this.shadowUpdateMode!==ss&&(this.shadowUpdateMode=es)}layersDirty(){var t;null!=(t=this._scene)&&t.layers&&(this._scene.layers._dirtyLights=!0)}updateKey(){let t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|td[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8;3===this._cookieChannel.length&&(t|=td[this._cookieChannel.charAt(1)]<<16,t|=td[this._cookieChannel.charAt(2)]<<14),t!==this.key&&null!==this._scene&&this.layersDirty(),this.key=t}get type(){return this._type}set type(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shape(){return this._shape}set shape(t){if(this._shape===t)return;this._shape=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shadowType(){return this._shadowType}set shadowType(t){if(this._shadowType===t)return;const e=this.device;this._type===Yt&&(t=se),t!==re||e.webgl2||(t=se),t!==ae||e.textureFloatRenderable||(t=ne),t!==ne||e.textureHalfFloatRenderable||(t=ie),this._isVsm=t>=ie&&t<=ae,this._isPcf=t===re||t===se,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(this._enabled=t,this.layersDirty())}get castShadows(){return this._castShadows&&this.mask!==os&&0!==this.mask}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get shadowResolution(){return this._shadowResolution}set shadowResolution(t){this._shadowResolution!==t&&(t=this._type===Yt?Math.min(t,this.device.maxCubeMapSize):Math.min(t,this.device.maxTextureSize),this._shadowResolution=t,this._destroyShadowMap())}get vsmBlurSize(){return this._vsmBlurSize}set vsmBlurSize(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}get normalOffsetBias(){return this._normalOffsetBias}set normalOffsetBias(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}get falloffMode(){return this._falloffMode}set falloffMode(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}get innerConeAngle(){return this._innerConeAngle}set innerConeAngle(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180))}get outerConeAngle(){return this._outerConeAngle}set outerConeAngle(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._outerConeAngleCos=Math.cos(t*Math.PI/180))}get intensity(){return this._intensity}set intensity(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new dt),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new nt(0,0,1,1)),this._atlasViewport}get cookie(){return this._cookie}set cookie(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieFalloff(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}get cookieChannel(){return this._cookieChannel}set cookieChannel(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),s=3-t.length;for(let i=0;i<s;i++)t+=e}this._cookieChannel=t,this.updateKey()}}get cookieTransform(){return this._cookieTransform}set cookieTransform(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new st,this._cookieOffsetSet=!1),this.updateKey())}get cookieOffset(){return this._cookieOffset}set cookieOffset(t){if(this._cookieOffset===t)return;!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new nt(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}}class nd{constructor(t,e,s){this._maxTextureSize=e,this._supportsAreaLights=t,this._dirtyLightsFnc=s,this._areaLightsEnabled=!1,this._cells=new it(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=se,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048}get cells(){return this._cells}set cells(t){this._cells.copy(t)}get maxLightsPerCell(){return this._maxLightsPerCell}set maxLightsPerCell(t){this._maxLightsPerCell=V.clamp(t,1,255)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set cookieAtlasResolution(t){this._cookieAtlasResolution=V.clamp(t,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowAtlasResolution(t){this._shadowAtlasResolution=V.clamp(t,32,this._maxTextureSize)}get shadowType(){return this._shadowType}set shadowType(t){this._shadowType!==t&&(this._shadowType=t,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set cookiesEnabled(t){this._cookiesEnabled!==t&&(this._cookiesEnabled=t,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set areaLightsEnabled(t){this._supportsAreaLights&&this._areaLightsEnabled!==t&&(this._areaLightsEnabled=t,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this._dirtyLightsFnc())}}const ad=new Mt;class rd{constructor(t,e){this.scene=t,this.light=e,this.store(),e.numCascades=1,e.type!==Xt&&(e._node.getWorldTransform(),e.getBoundingSphere(ad),this.lightBounds=new bt,this.lightBounds.center.copy(ad.center),this.lightBounds.halfExtents.set(ad.radius,ad.radius,ad.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades}restore(){const t=this.light;t.mask=this.mask,t.shadowUpdateMode=this.shadowUpdateMode,t.enabled=this.enabled,t.intensity=this.intensity,t._node.setLocalRotation(this.rotation),t.numCascades=this.numCascades}startBake(){this.light.enabled=!0,this.light._destroyShadowMap()}endBake(t){const e=this.light;e.enabled=!1,e.shadowMap&&e.shadowMap.cached&&(t.add(e,e.shadowMap),e.shadowMap=null)}}const od=new st;class hd extends rd{get numVirtualLights(){return this.light.type===Xt?this.light.bakeNumSamples:1}prepareVirtualLight(t,e){const s=this.light;if(s._node.setLocalRotation(this.rotation),t>0){const i=s.bakeArea;oo(od,t,e),od.mulScalar(.5*i),s._node.rotateLocal(od.x,0,od.y)}s._node.getWorldTransform();const i=this.scene.gammaCorrection?2.2:1,n=Math.pow(this.intensity,i);s.intensity=Math.pow(n/e,1/i)}}class ld extends jr{constructor(t,e){if(super(t),t==Fh()&&(e=t),this._batchHandle=null,this.c={},this._app=e,!e&&(this._app=Fh(),!this._app))throw new Error("Couldn't find current application");this._guid=null,this._destroying=!1,this._template=!1}addComponent(t,e){const s=this._app.systems[t];return s?this.c[t]?null:s.addComponent(this,e):null}removeComponent(t){const e=this._app.systems[t];e&&this.c[t]&&e.removeComponent(this)}findComponent(t){const e=this.findOne((function(e){return e.c&&e.c[t]}));return e&&e.c[t]}findComponents(t){return this.find((function(e){return e.c&&e.c[t]})).map((function(e){return e.c[t]}))}getGuid(){return this._guid||this.setGuid(m.create()),this._guid}setGuid(t){const e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this}_notifyHierarchyStateChanged(t,e){let s=!1;t===this&&0===this._app._enableList.length&&(s=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&this._app._enableList.push(t);const i=t._children;for(let t=0,s=i.length;t<s;t++)i[t]._enabled&&this._notifyHierarchyStateChanged(i[t],e);if(t._beingEnabled=!1,s){for(let t=0;t<this._app._enableList.length;t++)this._app._enableList[t]._onHierarchyStatePostChanged();this._app._enableList.length=0}}_onHierarchyStateChanged(t){super._onHierarchyStateChanged(t);const e=this.c;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];i.enabled&&(t?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const t=this.c;for(const e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()}findByGuid(t){if(this._guid===t)return this;const e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null}destroy(){this._destroying=!0;for(const t in this.c)this.c[t].enabled=!1;for(const t in this.c)this.c[t].system.removeComponent(this);this._parent&&this._parent.removeChild(this);const t=this._children;let e=t.shift();for(;e;)e instanceof ld&&e.destroy(),e._parent=null,e=t.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,cd(this,this,e,t),e}_cloneRecursively(t){const e=new ld(this._app);super._cloneInternal(e);for(const t in this.c){this.c[t].system.cloneComponent(this,e)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof ld){const s=i._cloneRecursively(t);e.addChild(s),t[i.getGuid()]=s}}return e}}function cd(t,e,s,i){if(e instanceof ld){const n=e.c;for(const e in n){const a=n[e],r=a.system.getPropertiesOfType("entity");for(let n=0,o=r.length;n<o;n++){const o=r[n].name,h=a[o];if(!!t.findByGuid(h)){const t=i[h].getGuid();t&&(s.c[e][o]=t)}}}n.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);const a=e.children.filter((function(t){return t instanceof ld})),r=s.children.filter((function(t){return t instanceof ld}));for(let e=0,s=a.length;e<s;e++)cd(t,a[e],r[e],i)}}const dd=new it;class ud extends rd{constructor(t){const e=new ld("AmbientLight");e.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:se,color:J.WHITE,intensity:1}),super(t,e.light.light)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(t,e){ho(dd,t,e,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(dd.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=this.scene.gammaCorrection?2.2:1,i=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(i,s);this.light.intensity=Math.pow(n/e,1/s)}}class pd{constructor(t,e=null){this.node=t,this.component=t.render||t.model,e=e||this.component.meshInstances,this.store(),this.meshInstances=e,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}class md{constructor(t){this.device=t,this.shaderDilate=fr(t,ir.fullscreenQuadVS,ir.dilatePS,"lmDilate"),this.constantTexSource=t.scope.resolve("source"),this.constantPixelOffset=t.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(t){this.constantTexSource.setValue(t)}prepare(t,e){this.pixelOffset[0]=1/t,this.pixelOffset[1]=1/e,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(t,e){this.shaderDenoise||(this.shaderDenoise=fr(this.device,ir.fullscreenQuadVS,ir.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=t,this.sigmas[1]=e,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(t,e)}evaluateDenoiseUniforms(t,e){function s(t,e){return.39894*Math.exp(-.5*t*t/(e*e))/e}this.kernel=this.kernel||new Float32Array(15);const i=this.kernel,n=Math.floor(7);for(let e=0;e<=n;++e){const a=s(e,t);i[n+e]=a,i[n-e]=a}this.constantKernel.setValue(this.kernel);const a=1/s(0,e);this.bZnorm.setValue(a)}}const fd=new it;class _d{constructor(t,e,s,i,n){this.device=t,this.root=e,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i._shadowRenderer.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new J,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){nl.decRef(this.blackTex),this.blackTex=null,nl.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null}initBake(t){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new md(t),this.constantBakeDir=t.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new Mr(this.device,{width:4,height:4,format:Li,type:Yn}),this.blackTex.name="lightmapBlack",nl.incRef(this.blackTex);const e=new Rr;e.clearColor.set(0,0,0,0),e.clearColorBuffer=!0,e.clearDepthBuffer=!1,e.clearStencilBuffer=!1,e.frustumCulling=!1,e.projection=ye,e.aspectRatio=1,e.node=new jr,this.camera=e}}finishBake(t){function e(t){nl.decRef(t.colorBuffer),t.destroy()}this.materials=[],this.renderTargets.forEach((t=>{e(t)})),this.renderTargets.clear(),t.forEach((t=>{t.renderTargets.forEach((t=>{e(t)})),t.renderTargets.length=0})),this.ambientAOMaterial=null}createMaterialForPass(t,e,s,i){const n=new Wo;if(n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.transformVS="#define UV1LAYOUT\n"+ir.transformVS,0===s){let t=ir.bakeLmEndPS;i?t=`\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(${e.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight += vec3(${e.ambientBakeOcclusionBrightness.toFixed(1)});\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = saturate(dDiffuseLight);\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight *= dAmbientLight;\n\t\t\t\t\t\t\t\t`+t:(n.ambient=new J(0,0,0),n.ambientTint=!0),n.chunks.endPS=t,n.lightMap=this.blackTex}else n.chunks.basePS=ir.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",n.chunks.endPS=ir.bakeDirLmEndPS;return n.chunks.outputAlphaPS="\n",n.chunks.outputAlphaOpaquePS="\n",n.chunks.outputAlphaPremulPS="\n",n.cull=oi,n.forceUv1=!0,n.update(),n.updateShader(t,e),n}createMaterials(t,e,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(t,e,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,e,0,!0),this.ambientAOMaterial.onUpdateShader=function(t){return t.lightMapWithoutAmbient=!0,t.separateAmbient=!0,t})}createTexture(t,e,s){const i=new Mr(this.device,{width:t,height:t,format:Li,mipmaps:!1,type:e,minFilter:di,magFilter:di,addressU:Ws,addressV:Ws});return i.name=s,i}collectModels(t,e,s){var i,n,a;if(!t.enabled)return;let r;if(null!=(i=t.model)&&i.model&&null!=(n=t.model)&&n.enabled&&(s&&s.push(new pd(t)),t.model.lightmapped&&e&&(r=t.model.model.meshInstances)),null!=(a=t.render)&&a.enabled&&(s&&s.push(new pd(t)),t.render.lightmapped&&e&&(r=t.render.meshInstances)),r){let s=!0;for(let t=0;t<r.length;t++)if(!r[t].mesh.vertexBuffer.format.hasUv1){s=!1;break}if(s){const s=[];for(let i=0;i<r.length;i++){const n=r[i].mesh;this._tempSet.has(n)?e.push(new pd(t,[r[i]])):s.push(r[i]),this._tempSet.add(n)}this._tempSet.clear(),s.length>0&&e.push(new pd(t,s))}}for(let i=0;i<t._children.length;i++)this.collectModels(t._children[i],e,s)}prepareShadowCasters(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const i=t[s].meshInstances;for(let t=0;t<i.length;t++)i[t].visibleThisFrame=!0,e.push(i[t])}}return e}updateTransforms(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;for(let t=0;t<s.length;t++)s[t].node.getWorldTransform()}}calculateLightmapSize(t){let e;const s=this.scene.lightmapSizeMultiplier||16,i=fd;let n,a;t.model?(a=t.model.lightmapSizeMultiplier,t.model.asset?(e=this.assets.get(t.model.asset).data,e.area&&(n=e.area)):t.model._area&&(e=t.model,e._area&&(n=e._area))):t.render&&(a=t.render.lightmapSizeMultiplier,"asset"!==t.render.type&&t.render._area&&(e=t.render,e._area&&(n=e._area)));const r={x:1,y:1,z:1,uv:1};n&&(r.x=n.x,r.y=n.y,r.z=n.z,r.uv=n.uv);const o=a||1;r.x*=o,r.y*=o,r.z*=o;const h=t.render||t.model,l=this.computeNodeBounds(h.meshInstances);i.copy(l.halfExtents);let c=r.x*i.y*i.z+r.y*i.x*i.z+r.z*i.x*i.y;c/=r.uv,c=Math.sqrt(c);return Math.min(V.nextPowerOfTwo(c*s),this.scene.lightmapMaxResolution||2048)}setLightmaping(t,e,s,i){for(let n=0;n<t.length;n++){const a=t[n],r=a.meshInstances;for(let t=0;t<r.length;t++){const n=r[t];if(n.setLightmapped(e),e){i&&(n._shaderDefs|=i),n.mask=rs;for(let t=0;t<s;t++){const e=a.renderTargets[t].colorBuffer;e.minFilter=ui,e.magFilter=ui,n.setRealtimeLightmap(dl.lightmapParamNames[t],e)}}}}}bake(t,e=_s){const s=this.device,i=k();this.scene._updateSkybox(s),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,a=s._renderTargetCreationTime,r=s._shaderStats.compileTime,o=[],h=[];if(t){for(let e=0;e<t.length;e++)this.collectModels(t[e],o,null);this.collectModels(this.root,null,h)}else this.collectModels(this.root,o,h);if(o.length>0){const t=e===_s?2:1;this.setLightmaping(o,!1,t),this.initBake(s),this.bakeInternal(t,o,h);let i=je;e===_s&&(i|=qe),this.scene.ambientBake&&(i|=Je),this.setLightmaping(o,!0,t,i),this.finishBake(o)}const l=k();this.stats.totalRenderTime=l-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-r,this.stats.fboTime=s._renderTargetCreationTime-a,this.stats.lightmapCount=o.length}allocateTextures(t,e){for(let s=0;s<t.length;s++){const i=t[s],n=this.calculateLightmapSize(i.node);for(let t=0;t<e;t++){const e=this.createTexture(n,Xn,"lightmapper_lightmap_"+s);nl.incRef(e),i.renderTargets[t]=new uh({colorBuffer:e,depth:!1})}if(!this.renderTargets.has(n)){const t=this.createTexture(n,Xn,"lightmapper_temp_lightmap_"+n);nl.incRef(t),this.renderTargets.set(n,new uh({colorBuffer:t,depth:!1}))}}}prepareLightsToBake(t,e,s){if(this.scene.ambientBake){const t=new ud(this.scene);s.push(t)}const i=t._lights;for(let t=0;t<i.length;t++){const n=i[t],a=new hd(this.scene,n);e.push(a),n.enabled&&0!=(n.mask&os)&&(n.isStatic=!1,n.mask=4294967295,n.shadowUpdateMode=n.type===Xt?ss:es,s.push(a))}s.sort()}restoreLights(t){for(let e=0;e<t.length;e++)t[e].restore()}setupScene(){this.revertStatic=!1,this.scene._needsStaticPrepare&&(this.scene._needsStaticPrepare=!1,this.revertStatic=!0),this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog=kt,this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight),this.revertStatic&&(this.scene._needsStaticPrepare=!0)}computeNodeBounds(t){const e=new bt;if(t.length>0){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}computeNodesBounds(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;t[e].bounds=this.computeNodeBounds(s)}}computeBounds(t){const e=new bt;for(let s=0;s<t.length;s++){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}backupMaterials(t){for(let e=0;e<t.length;e++)this.materials[e]=t[e].material}restoreMaterials(t){for(let e=0;e<t.length;e++)t[e].material=this.materials[e]}lightCameraPrepare(t,e){const s=e.light;let i;if(s.type===Kt){i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=ge,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i)}return i}lightCameraPrepareAndCull(t,e,s,i){const n=t.light;let a=!0;if(n.type===Xt){fd.copy(i.center),fd.y+=i.halfExtents.y,this.camera.node.setPosition(fd),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;const t=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=t}else t.lightBounds.intersects(e.bounds)||(a=!1);if(n.type===Kt){let t=!1;const i=e.meshInstances;for(let e=0;e<i.length;e++)if(i[e]._isVisible(s)){t=!0;break}t||(a=!1)}return a}setupLightArray(t,e){t[Xt].length=0,t[Yt].length=0,t[Kt].length=0,t[e.type][0]=e}renderShadowMap(t,e,s,i){const n=i.light;return!t&&n.castShadows&&(n.shadowMap||(n.shadowMap=this.shadowMapCache.get(this.device,n)),n.type===Xt?this.renderer._shadowRenderer.cullDirectional(n,e,this.camera):this.renderer._shadowRenderer.cullLocal(n,e),this.renderer.renderShadows(s[n.type],this.camera)),!0}postprocessTextures(t,e,s){const i=this.lightmapFilters.shaderDilate,n=this.scene.lightmapFilterEnabled;n&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness);for(let a=0;a<e.length;a++){const r=e[a];for(let e=0;e<s;e++){const s=r.renderTargets[e],a=s.colorBuffer,o=this.renderTargets.get(a.width),h=o.colorBuffer;this.lightmapFilters.prepare(a.width,a.height);for(let r=0;r<1;r++){this.lightmapFilters.setSourceTexture(a);er(t,o,n&&0===e&&0===r?this.lightmapFilters.shaderDenoise:i),this.lightmapFilters.setSourceTexture(h),er(t,s,i)}}}}bakeInternal(t,e,s){const i=this.scene,n=this.device;this.createMaterials(n,i,t),this.setupScene(),i.layers._update(),this.computeNodesBounds(e),this.allocateTextures(e,t);const a=[],r=[];this.prepareLightsToBake(i.layers,a,r),this.updateTransforms(s);const o=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(o),this.renderer.gpuUpdate(o);const h=this.computeBounds(o);let l,c,d,u;for(l=0;l<e.length;l++){for(d=e[l].meshInstances,c=0;c<d.length;c++)u=d[c],u.setLightmapped(!1),u.mask=os,u.setRealtimeLightmap(dl.lightmapParamNames[0],u.material.lightMap?u.material.lightMap:this.blackTex),u.setRealtimeLightmap(dl.lightmapParamNames[1],this.blackTex)}for(c=0;c<r.length;c++)r[c].light.enabled=!1;const p=[[],[],[]];let m,f,_=!1;for(l=0;l<r.length;l++){const s=r[l],a=s instanceof ud;let g=s.numVirtualLights;t>1&&g>1&&(g=1);for(let r=0;r<g;r++){g>1&&s.prepareVirtualLight(r,g),s.startBake();let l=!1;const y=this.lightCameraPrepare(n,s);for(f=0;f<e.length;f++){const n=e[f];d=n.meshInstances;if(this.lightCameraPrepareAndCull(s,n,y,h)){for(this.setupLightArray(p,s.light),l=this.renderShadowMap(l,o,p,s),this.backupMaterials(d),m=0;m<t&&!(m>0&&r>0)&&!(a&&m>0);m++){const t=n.renderTargets[m],e=n.renderTargets[m].colorBuffer.width,o=this.renderTargets.get(e),h=o.colorBuffer;0===m?_=i.updateShaders:_&&(i.updateShaders=!0);let l=this.passMaterials[m];if(a){r+1===g&&0===m&&(l=this.ambientAOMaterial)}for(c=0;c<d.length;c++)d[c].material=l;for(this.renderer.updateShaders(d),this.renderer.setCamera(this.camera,o,!0),1===m&&this.constantBakeDir.setValue(s.light.bakeDir?1:0),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,d,d.length,p,ls),n.renderTargets[m]=o,this.renderTargets.set(e,t),c=0;c<d.length;c++)u=d[c],u.setRealtimeLightmap(dl.lightmapParamNames[m],h),u._shaderDefs|=je}this.restoreMaterials(d)}}s.endBake(this.shadowMapCache)}}for(this.postprocessTextures(n,e,t),f=0;f<s.length;f++)s[f].restore();this.restoreLights(a),this.restoreScene(),this.shadowMapCache.clear()}}class gd extends Ih{constructor(t,e){super(),this.device=e||Fh().graphicsDevice,this._targets=t,this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=gd.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=gd.FORMAT_FLOAT),this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=gd.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=gd.FORMAT_FLOAT),void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)),this._init(),this._updateMorphFlags(),this._calculateAabb()}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let t=0;t<this._targets.length;t++)this._targets[t]._initVertexBuffers(this.device);for(let t=0;t<this._targets.length;t++)this._targets[t]._postInit()}_initTextureBased(){const t=[],e=[];for(let s=0;s<this._targets.length;s++){const i=this._targets[s];i.options.deltaPositions&&(t.push(i.options.deltaPositions),e.push({target:i,name:"texturePositions"})),i.options.deltaNormals&&(t.push(i.options.deltaNormals),e.push({target:i,name:"textureNormals"}))}const s=[],i=[];let n=1;const a=t[0].length;for(let e=0;e<a;e+=3){let a=!1;for(let s=0;s<t.length;s++){const i=t[s];if(0!==i[e]||0!==i[e+1]||0!==i[e+2]){a=!0;break}}a?(s.push(n+.2),i.push(e/3),n++):s.push(.2)}const r=Math.min(this.device.maxTextureSize,4096);let o=Math.ceil(Math.sqrt(n));o=Math.min(o,r);const h=Math.ceil(n/o);if(h>r)return!1;this.morphTextureWidth=o,this.morphTextureHeight=h;let l=!1,c=3;const d=br.float2Half;this._textureFormat===gd.FORMAT_HALF_FLOAT&&(l=!0,c=4);const u=this.morphTextureWidth*this.morphTextureHeight*c,p=l?new Uint16Array(u):new Float32Array(u);for(let s=0;s<t.length;s++){const n=t[s];for(let t=0;t<i.length;t++){const e=i[t];l?(p[t*c+c]=d(n[3*e]),p[t*c+c+1]=d(n[3*e+1]),p[t*c+c+2]=d(n[3*e+2])):(p[t*c+c]=n[3*e],p[t*c+c+1]=n[3*e+1],p[t*c+c+2]=n[3*e+2])}const a=e[s].target,r=this._textureFormat===gd.FORMAT_FLOAT?Bi:ki;a._setTexture(e[s].name,this._createTexture("MorphTarget",r,p))}const m=[{semantic:Vn,components:1,type:oa}];return this.vertexBufferIds=new $a(this.device,new Ja(this.device,m),s.length,ti,new Float32Array(s)),!0}destroy(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)}}_calculateAabb(){const t=new it,e=new it;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;t.min(i.getMin()),e.max(i.getMax())}this.aabb=new bt,this.aabb.setMinMax(t,e)}_createTexture(t,e,s){const i=new Mr(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:di,magFilter:di,addressU:Ws,addressV:Ws});return i.name=t,s&&(i.lock().set(s),i.unlock()),i}}gd.FORMAT_FLOAT=0,gd.FORMAT_HALF_FLOAT=1;class yd{constructor(t){this.morph=t,t.incRefCount(),this.device=t.device,this.meshInstance=null,this._weights=[];for(let e=0;e<t._targets.length;e++)this.setWeight(e,t._targets[e].defaultWeight);if(this._activeTargets=[],t.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const e=(e,s)=>{const i=t._renderTextureFormat===gd.FORMAT_FLOAT?zi:ki;return this[s]=t._createTexture(e,i),new uh({colorBuffer:this[s],depth:!1})};t.morphPositions&&(this.rtPositions=e("MorphRTPos","texturePositions")),t.morphNormals&&(this.rtNormals=e("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([t.morphTextureWidth,t.morphTextureHeight,1/t.morphTextureWidth,1/t.morphTextureHeight]);for(let t=0;t<this.maxSubmitCount;t++)this["morphBlendTex"+t]=this.device.scope.resolve("morphBlendTex"+t);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.meshInstance=null,this.shader=null;const t=this.morph;t&&(this.morph=null,t.decRefCount(),t.getRefCount()<1&&t.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new yd(this.morph)}getWeight(t){return this._weights[t]}setWeight(t,e){this._weights[t]=e,this._dirty=!0}_getFragmentShader(t){let e="";t>0&&(e+="varying vec2 uv0;\nuniform highp float morphFactor["+t+"];\n");for(let s=0;s<t;s++)e+="uniform highp sampler2D morphBlendTex"+s+";\n";e+="void main (void) {\n\t\thighp vec4 color = vec4(0, 0, 0, 1);\n";for(let s=0;s<t;s++)e+="\t\tcolor.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+", uv0).xyz;\n";return e+="\t\tgl_FragColor = color;\n}\n",e}_getShader(t){let e=this.shaderCache[t];if(!e){const s=this._getFragmentShader(t);e=fr(this.device,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}\n\t\t",s,"textureMorph"+t),this.shaderCache[t]=e}return e}_updateTextureRenderTarget(t,e){const s=this.device,i=(e,i)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlending(i),i&&(s.setBlendFunction(js,js),s.setBlendEquation(Zs));const n=this._getShader(e);er(s,t,n,void 0,void 0,i)};let n=0,a=!1;const r=this._activeTargets.length;for(let t=0;t<r;t++){const s=this._activeTargets[t],r=s.target[e];r&&(this["morphBlendTex"+n].setValue(r),this._shaderMorphWeights[n]=s.weight,n++,n>=this.maxSubmitCount&&(i(n,a),n=0,a=!0))}(n>0||0===r&&!this.zeroTextures)&&i(n,a)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)}_updateVertexMorph(){const t=this.maxSubmitCount;for(let e=0;e<t;e++)this._shaderMorphWeights[e]=0,this._activeVertexBuffers[e]=null;let e=0,s=this.morph.morphPositions?4:0;for(let t=0;t<this._activeTargets.length;t++){const i=this._activeTargets[t].target;i._vertexBufferPositions&&(this._activeVertexBuffers[e]=i._vertexBufferPositions,this._shaderMorphWeights[e]=this._activeTargets[t].weight,e++),i._vertexBufferNormals&&(this._activeVertexBuffers[s]=i._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[t].weight,s++)}}update(){this._dirty=!1;const t=this.morph._targets;let e=0;for(let s=0;s<t.length;s++){const i=Math.abs(this.getWeight(s));if(i>1e-5){this._activeTargets.length<=e&&(this._activeTargets[e]={});const n=this._activeTargets[e++];n.absWeight=i,n.weight=this.getWeight(s),n.target=t[s]}}this._activeTargets.length=e;const s=this.morph.maxActiveTargets;this._activeTargets.length>s&&(this._activeTargets.sort((function(t,e){return t.absWeight<e.absWeight?1:e.absWeight<t.absWeight?-1:0})),this._activeTargets.length=s),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class vd{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(t){this.graph=t}getCameras(){return this.cameras}setCameras(t){this.cameras=t}getLights(){return this.lights}setLights(t){this.lights=t}getMaterials(){const t=[];for(let e=0;e<this.meshInstances.length;e++){const s=this.meshInstances[e];-1===t.indexOf(s.material)&&t.push(s.material)}return t}clone(){const t=[],e=[],s=function s(i){const n=i.clone();t.push(i),e.push(n);for(let t=0;t<i._children.length;t++)n.addChild(s(i._children[t]));return n}(this.graph),i=[],n=[],a=[];for(let t=0;t<this.skinInstances.length;t++){const e=this.skinInstances[t].skin,i=new sl(e),a=[];for(let t=0;t<e.boneNames.length;t++){const i=e.boneNames[t],n=s.findByName(i);a.push(n)}i.bones=a,n.push(i)}for(let t=0;t<this.morphInstances.length;t++){const e=this.morphInstances[t].morph,s=new yd(e);a.push(s)}for(let s=0;s<this.meshInstances.length;s++){const r=this.meshInstances[s],o=t.indexOf(r.node),h=new dl(r.mesh,r.material,e[o]);if(r.skinInstance){const t=this.skinInstances.indexOf(r.skinInstance);h.skinInstance=n[t]}if(r.morphInstance){const t=this.morphInstances.indexOf(r.morphInstance);h.morphInstance=a[t]}i.push(h)}const r=new vd;return r.graph=s,r.meshInstances=i,r.skinInstances=n,r.morphInstances=a,r.getGraph().syncHierarchy(),r}destroy(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].destroy();this.meshInstances.length=0}generateWireframe(){dl._prepareRenderStyleForArray(this.meshInstances,xe)}show(){for(let t=0;this.meshInstances&&t<this.meshInstances.length;t++)this.meshInstances[t].visible=!0}hide(){for(let t=0;this.meshInstances&&t<this.meshInstances.length;t++)this.meshInstances[t].visible=!1}}class xd{constructor(t){2===arguments.length&&(t=arguments[1]),this.options=t,this._name=t.name,this._defaultWeight=t.defaultWeight||0,this.aabb=t.aabb,this.aabb||(this.aabb=new bt,t.deltaPositions&&this.aabb.compute(t.deltaPositions)),this.deltaPositions=t.deltaPositions}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get morphPositions(){return!!this._vertexBufferPositions||!!this.texturePositions}get morphNormals(){return!!this._vertexBufferNormals||!!this.textureNormals}_postInit(){this.options=null}_initVertexBuffers(t){const e=this.options;this._vertexBufferPositions=this._createVertexBuffer(t,e.deltaPositions,e.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(t,e.deltaNormals,e.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())}_createVertexBuffer(t,e,s=oa){if(e){return new $a(t,new Ja(t,[{semantic:Tn,components:3,type:s}]),e.length/3,ti,e)}return null}_setTexture(t,e){this[t]=e}destroy(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}}let bd,Sd=1;const wd=new dt,Md=new dt,Td=new it,Ad=new it,Cd=new it,Pd=new it,Rd=new it,Ed=new it,Ld=new it,Id=new it,Dd=new it,Fd=new it,Od=new it,kd=new it,Bd=new it;function zd(t){return t-Math.floor(t)}function Ud(t){return Math.max(Math.min(t,1),0)}function Vd(t,e){return t-e*Math.floor(t/e)}function Nd(t){let e=zd(t),s=zd(255*t);return e-=s/255,s-=s/255,[e,s]}class Wd{constructor(t){this._emitter=t}calcSpawnPosition(t,e,s,i,n){const a=this._emitter,r=Math.random(),o=Math.random(),h=Math.random(),l=Math.random();if(a.useCpu&&(t[4*n+0+2*a.numParticlesPot*4]=r,t[4*n+1+2*a.numParticlesPot*4]=o,t[4*n+2+2*a.numParticlesPot*4]=h),Ad.x=r-.5,Ad.y=o-.5,Ad.z=h-.5,a.emitterShape===pe){const t=Math.max(Math.abs(Ad.x),Math.max(Math.abs(Ad.y),Math.abs(Ad.z))),n=t+(.5-t)*s[0],r=t+(.5-t)*s[1],o=t+(.5-t)*s[2];Ad.x=n*(t===Math.abs(Ad.x)?Math.sign(Ad.x):2*Ad.x),Ad.y=r*(t===Math.abs(Ad.y)?Math.sign(Ad.y):2*Ad.y),Ad.z=o*(t===Math.abs(Ad.z)?Math.sign(Ad.z):2*Ad.z),a.localSpace?Td.copy(e.transformPoint(Ad)):Td.copy(i).add(e.transformPoint(Ad))}else{Ad.normalize();const t=0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius,e=l*(1-t)+t;a.localSpace?Td.copy(Ad.mulScalar(e*a.emitterRadius)):Td.copy(i).add(Ad.mulScalar(e*a.emitterRadius))}let c=-V.lerp(a.rate,a.rate2,r)*n;if(a.pack8){const e=(Td.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5,s=(Td.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5,i=(Td.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5;let o=V.lerp(a.startAngle*V.DEG_TO_RAD,a.startAngle2*V.DEG_TO_RAD,r);o=o%(2*Math.PI)/(2*Math.PI);const h=Nd(e);t[4*n]=h[0],t[4*n+1]=h[1];const l=Nd(s);t[4*n+2]=l[0],t[4*n+3]=l[1];const d=Nd(i);t[4*n+0+4*a.numParticlesPot]=d[0],t[4*n+1+4*a.numParticlesPot]=d[1];const u=Nd(o);t[4*n+2+4*a.numParticlesPot]=u[0],t[4*n+3+4*a.numParticlesPot]=u[1];const p=1;t[4*n+3+4*a.numParticlesPot*2]=p;const m=Math.max(a.lifetime,(a.numParticles-1)*Math.max(a.rate,a.rate2));c=(c+m)/(m+(a.lifetime+1));const f=function(t){let e=zd(t),s=zd(255*t),i=zd(65025*t),n=zd(160581375*t);return e-=s/255,s-=i/255,i-=n/255,n-=n/255,[e,s,i,n]}(c);t[4*n+0+4*a.numParticlesPot*3]=f[0],t[4*n+1+4*a.numParticlesPot*3]=f[1],t[4*n+2+4*a.numParticlesPot*3]=f[2],t[4*n+3+4*a.numParticlesPot*3]=f[3]}else t[4*n]=Td.x,t[4*n+1]=Td.y,t[4*n+2]=Td.z,t[4*n+3]=V.lerp(a.startAngle*V.DEG_TO_RAD,a.startAngle2*V.DEG_TO_RAD,r),t[4*n+3+4*a.numParticlesPot]=c}update(t,e,s,i,n,a,r,o){let h,l,c;const d=this._emitter;if(d.meshInstance.node){const t=d.meshInstance.node.worldTransform;for(let e=0;e<12;e++)wd.data[e]=t.data[e];Md.copy(wd),Md.invert(),bd=d.meshInstance.node.localScale,Sd=Math.max(Math.max(bd.x,bd.y),bd.z)}a=null===d.meshInstance.node||d.localSpace?it.ZERO:d.meshInstance.node.getPosition();const u=d.camera?d.camera._node.getPosition():it.ZERO,p=d.useMesh?17:15;let m,f,_,g,y,v,x,b,S;const w=d.precision-1;for(let e=0;e<d.numParticles;e++){const M=Math.floor(d.vbCPU[e*d.numParticleVerts*(d.useMesh?6:4)+3]),T=s[4*M+0+2*d.numParticlesPot*4];Cd.x=T,Cd.y=s[4*M+1+2*d.numParticlesPot*4],Cd.z=s[4*M+2+2*d.numParticlesPot*4];const A=d.rate+(d.rate2-d.rate)*T,C=d.lifetime;let P=s[4*M+3+4*d.numParticlesPot]+r;const R=Ud(P/C);let E=0,L=0;const I=0;(P-r<=0||P>=C)&&this.calcSpawnPosition(s,i,n,a,M);let D=P>0&&P<C;D&&(c=R*w,m=Math.floor(c),f=Math.ceil(c),c%=1,h=d.qRotSpeed[m],l=d.qRotSpeed[f],_=h+(l-h)*c,h=d.qRotSpeed2[m],l=d.qRotSpeed2[f],g=h+(l-h)*c,h=d.qScale[m],l=d.qScale[f],E=h+(l-h)*c,h=d.qScale2[m],l=d.qScale2[f],y=h+(l-h)*c,h=d.qAlpha[m],l=d.qAlpha[f],v=h+(l-h)*c,h=d.qAlpha2[m],l=d.qAlpha2[f],x=h+(l-h)*c,h=d.qRadialSpeed[m],l=d.qRadialSpeed[f],b=h+(l-h)*c,h=d.qRadialSpeed2[m],l=d.qRadialSpeed2[f],S=h+(l-h)*c,b+=100*T%1*(S-b),Pd.x=s[4*M],Pd.y=s[4*M+1],Pd.z=s[4*M+2],d.localSpace?Dd.copy(Pd):Dd.copy(Pd).sub(a),Dd.normalize().mulScalar(b),m*=3,f*=3,h=d.qLocalVelocity[m],l=d.qLocalVelocity[f],Ed.x=h+(l-h)*c,h=d.qLocalVelocity[m+1],l=d.qLocalVelocity[f+1],Ed.y=h+(l-h)*c,h=d.qLocalVelocity[m+2],l=d.qLocalVelocity[f+2],Ed.z=h+(l-h)*c,h=d.qLocalVelocity2[m],l=d.qLocalVelocity2[f],Id.x=h+(l-h)*c,h=d.qLocalVelocity2[m+1],l=d.qLocalVelocity2[f+1],Id.y=h+(l-h)*c,h=d.qLocalVelocity2[m+2],l=d.qLocalVelocity2[f+2],Id.z=h+(l-h)*c,h=d.qVelocity[m],l=d.qVelocity[f],Rd.x=h+(l-h)*c,h=d.qVelocity[m+1],l=d.qVelocity[f+1],Rd.y=h+(l-h)*c,h=d.qVelocity[m+2],l=d.qVelocity[f+2],Rd.z=h+(l-h)*c,h=d.qVelocity2[m],l=d.qVelocity2[f],Ld.x=h+(l-h)*c,h=d.qVelocity2[m+1],l=d.qVelocity2[f+1],Ld.y=h+(l-h)*c,h=d.qVelocity2[m+2],l=d.qVelocity2[f+2],Ld.z=h+(l-h)*c,Ed.x+=(Id.x-Ed.x)*Cd.x,Ed.y+=(Id.y-Ed.y)*Cd.y,Ed.z+=(Id.z-Ed.z)*Cd.z,d.initialVelocity>0&&(d.emitterShape===me?(Ad.copy(Cd).mulScalar(2).sub(it.ONE).normalize(),Ed.add(Ad.mulScalar(d.initialVelocity))):Ed.add(it.FORWARD.mulScalar(d.initialVelocity))),Rd.x+=(Ld.x-Rd.x)*Cd.x,Rd.y+=(Ld.y-Rd.y)*Cd.y,Rd.z+=(Ld.z-Rd.z)*Cd.z,_+=(g-_)*Cd.y,E=(E+1e4*T%1*(y-E))*Sd,L=1e3*T%1*(x-v),d.meshInstance.node&&(d.localSpace?(Ed.x/=bd.x,Ed.y/=bd.y,Ed.z/=bd.z):wd.transformPoint(Ed,Ed)),d.localSpace?(Md.transformPoint(Rd,Rd),Ed.add(Rd).add(Dd)):(Ed.add(Rd.mul(bd)),Ed.add(Dd.mul(bd))),kd.copy(Ed),Fd.copy(Pd).add(Ed.mulScalar(r)),Od.copy(Fd),s[4*M]=Od.x,s[4*M+1]=Od.y,s[4*M+2]=Od.z,s[4*M+3]+=_*r,d.wrap&&d.wrapBounds&&(d.localSpace||Od.sub(a),Od.x=Vd(Od.x,d.wrapBounds.x)-.5*d.wrapBounds.x,Od.y=Vd(Od.y,d.wrapBounds.y)-.5*d.wrapBounds.y,Od.z=Vd(Od.z,d.wrapBounds.z)-.5*d.wrapBounds.z,d.localSpace||Od.add(a)),d.sort>0&&(1===d.sort?(Bd.copy(Od).sub(u),d.particleDistance[M]=-(Bd.x*Bd.x+Bd.y*Bd.y+Bd.z*Bd.z)):2===d.sort?d.particleDistance[M]=P:3===d.sort&&(d.particleDistance[M]=-P))),o?P<0&&(s[4*M+3+2*d.numParticlesPot*4]=-1):(P>=C&&(P-=Math.max(C,(d.numParticles-1)*A),s[4*M+3+2*d.numParticlesPot*4]=d.loop?1:-1),P<0&&d.loop&&(s[4*M+3+2*d.numParticlesPot*4]=1)),s[4*M+3+2*d.numParticlesPot*4]<0&&(D=!1),s[4*M+3+4*d.numParticlesPot]=P;for(let i=0;i<d.numParticleVerts;i++){const n=(e*d.numParticleVerts+i)*(d.useMesh?6:4);let a=d.vbCPU[n],r=d.vbCPU[n+1],o=d.vbCPU[n+2];D||(a=r=o=0);const h=e*d.numParticleVerts*p+i*p;t[h]=Od.x,t[h+1]=Od.y,t[h+2]=Od.z,t[h+3]=R,t[h+4]=d.alignToMotion?I:s[4*M+3],t[h+5]=E,t[h+6]=L,t[h+7]=kd.x,t[h+8]=a,t[h+9]=r,t[h+10]=o,t[h+11]=kd.y,t[h+12]=M,t[h+13]=kd.z,t[h+14]=d.vbCPU[n+3],d.useMesh&&(t[h+15]=d.vbCPU[n+4],t[h+16]=d.vbCPU[n+5])}}if(d.sort>de&&d.camera){const t=d.useMesh?6:4,s=d.particleDistance;for(let i=0;i<d.numParticles;i++)e[i][0]=i,e[i][1]=s[Math.floor(d.vbCPU[i*d.numParticleVerts*t+3])];d.vbOld.set(d.vbCPU),e.sort((function(t,e){return t[1]-e[1]}));for(let s=0;s<d.numParticles;s++){const i=e[s][0]*d.numParticleVerts*t,n=s*d.numParticleVerts*t;for(let e=0;e<d.numParticleVerts*t;e++)d.vbCPU[n+e]=d.vbOld[i+e]}}}}const Gd=new at,Hd=new at,jd=new at;class qd{constructor(t,e){this._emitter=t,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=e.scope.resolve("particleTexIN"),this.constantParticleTexOUT=e.scope.resolve("particleTexOUT"),this.constantEmitterPos=e.scope.resolve("emitterPos"),this.constantEmitterScale=e.scope.resolve("emitterScale"),this.constantSpawnBounds=e.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=e.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=e.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=e.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=e.scope.resolve("initialVelocity"),this.constantFrameRandom=e.scope.resolve("frameRandom"),this.constantDelta=e.scope.resolve("delta"),this.constantRate=e.scope.resolve("rate"),this.constantRateDiv=e.scope.resolve("rateDiv"),this.constantLifetime=e.scope.resolve("lifetime"),this.constantGraphSampleSize=e.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=e.scope.resolve("graphNumSamples"),this.constantInternalTex0=e.scope.resolve("internalTex0"),this.constantInternalTex1=e.scope.resolve("internalTex1"),this.constantInternalTex2=e.scope.resolve("internalTex2"),this.constantInternalTex3=e.scope.resolve("internalTex3"),this.constantEmitterMatrix=e.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=e.scope.resolve("emitterMatrixInv"),this.constantNumParticles=e.scope.resolve("numParticles"),this.constantNumParticlesPot=e.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=e.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=e.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=e.scope.resolve("rotSpeedDivMult"),this.constantSeed=e.scope.resolve("seed"),this.constantStartAngle=e.scope.resolve("startAngle"),this.constantStartAngle2=e.scope.resolve("startAngle2"),this.constantOutBoundsMul=e.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=e.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=e.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=e.scope.resolve("inBoundsCenter"),this.constantMaxVel=e.scope.resolve("maxVel"),this.constantFaceTangent=e.scope.resolve("faceTangent"),this.constantFaceBinorm=e.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(t,e,s,i,n){const a=this._emitter;t.setBlending(!1),t.setColorWrite(!0,!0,!0,!0),t.setCullMode(oi),t.setDepthTest(!1),t.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/a.precision),this.constantGraphNumSamples.setValue(a.precision),this.constantNumParticles.setValue(a.numParticles),this.constantNumParticlesPot.setValue(a.numParticlesPot),this.constantInternalTex0.setValue(a.internalTex0),this.constantInternalTex1.setValue(a.internalTex1),this.constantInternalTex2.setValue(a.internalTex2),this.constantInternalTex3.setValue(a.internalTex3);const r=a.meshInstance.node,o=null===r?it.ONE:r.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x,this.worldBoundsMulUniform[1]=a.worldBoundsMul.y,this.worldBoundsMulUniform[2]=a.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let t=a.maxVel*Math.max(Math.max(o.x,o.y),o.z);t=Math.max(t,1),this.constantMaxVel.setValue(t)}const h=null===r||a.localSpace?it.ZERO:r.getPosition(),l=null===r?dt.IDENTITY:r.getWorldTransform();a.emitterShape===pe?(Gd.setFromMat4(e),this.constantSpawnBounds.setValue(Gd.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(a.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius)),this.constantInitialVelocity.setValue(a.initialVelocity),Hd.setFromMat4(l),l.invertTo3x3(jd),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(a.rate),this.constantRateDiv.setValue(a.rate2-a.rate),this.constantStartAngle.setValue(a.startAngle*V.DEG_TO_RAD),this.constantStartAngle2.setValue(a.startAngle2*V.DEG_TO_RAD),this.constantSeed.setValue(a.seed),this.constantLifetime.setValue(a.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(Hd.data),this.constantEmitterMatrixInv.setValue(jd.data),this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax),this.constantVelocityDivMult.setValue(a.velocityUMax),this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]);let c=a.swapTex?a.particleTexOUT:a.particleTexIN;c=a.beenReset?a.particleTexStart:c;const d=a.swapTex?a.particleTexIN:a.particleTexOUT;this.constantParticleTexIN.setValue(c),er(t,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,n?a.shaderParticleUpdateOnStop:a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn),a.material.setParameter("particleTexOUT",c),a.material.setParameter("particleTexIN",d),a.beenReset=!1,a.swapTex=!a.swapTex,t.setDepthTest(!0),t.setDepthWrite(!0),a.prevWorldBoundsSize.copy(a.worldBoundsSize),a.prevWorldBoundsCenter.copy(a.worldBounds.center),a.pack8&&this._setInputBounds()}}const Xd=[[-1,-1],[1,-1],[1,1],[-1,1]];function Yd(t,e,s,i,n=zi,a,r){let o=di;r&&n===Li&&(o=ui);const h=new Mr(t,{width:e,height:s,format:n,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:Ws,addressV:Ws});h.name="PSTexture";const l=h.lock();if(n===Li){const t=new Uint8Array(i.length);for(let e=0;e<i.length;e++)t[e]=i[e]*a*255;i=t}return l.set(i),h.unlock(),h}function Kd(t){return Math.max(Math.min(t,1),0)}const $d=new tt([0,0,1,0]),Zd=new tt([0,1,1,1]),Jd=new et([0,0,1,0],[0,0,1,0],[0,0,1,0]),Qd=new et([0,1,1,1],[0,1,1,1],[0,1,1,1]);let tu=2;const eu=new Float32Array(3),su=new dt,iu=new it,nu=new it,au=new it;let ru,ou;function hu(t,e){void 0!==ou[t]&&null!==ou[t]?ru[t]=ou[t]:ru[t]=e}function lu(t,e,s){return(255*t<<16|255*e<<8|255*s)/(1<<24)}function cu(t,e){const s=t.length/3,i=new Array(4*s);for(let n=0;n<s;n++)i[4*n]=t[3*n],i[4*n+1]=t[3*n+1],i[4*n+2]=t[3*n+2],i[4*n+3]=lu(e[3*n],e[3*n+1],e[3*n+2]);return i}function du(t,e){const s=e.length,i=t.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++){const a=Math.abs(t[n*s+i]);e[i]=Math.max(e[i],a)}}function uu(t,e,s){const i=function(t,e){const s=new Float32Array(t.length);for(let i=0;i<t.length;i++)s[i]=t[i]-e[i];return s}(e,t);return du(i,s),function(t,e){const s=e.length,i=t.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++)t[n*s+i]/=0===e[i]?1:e[i],t[n*s+i]*=.5,t[n*s+i]+=.5}(i,s),i}class pu{constructor(t,e){this.graphicsDevice=t;const s=t;this.precision=32,this._addTimeTime=0,pu.staticInit(s),ru=this,ou=e,hu("numParticles",1),this.numParticles>t.maxTextureSize&&(this.numParticles=t.maxTextureSize),hu("rate",1),hu("rate2",this.rate),hu("lifetime",50),hu("emitterExtents",new it(0,0,0)),hu("emitterExtentsInner",new it(0,0,0)),hu("emitterRadius",0),hu("emitterRadiusInner",0),hu("emitterShape",pe),hu("initialVelocity",1),hu("wrap",!1),hu("localSpace",!1),hu("screenSpace",!1),hu("wrapBounds",null),hu("colorMap",pu.DEFAULT_PARAM_TEXTURE),hu("normalMap",null),hu("loop",!0),hu("preWarm",!1),hu("sort",de),hu("mode",ue),hu("scene",null),hu("lighting",!1),hu("halfLambert",!1),hu("intensity",1),hu("stretch",0),hu("alignToMotion",!1),hu("depthSoftening",0),hu("mesh",null),hu("particleNormal",new it(0,1,0)),hu("orientation",fe),hu("depthWrite",!1),hu("noFog",!1),hu("blendType",Ct),hu("node",null),hu("startAngle",0),hu("startAngle2",this.startAngle),hu("animTilesX",1),hu("animTilesY",1),hu("animStartFrame",0),hu("animNumFrames",1),hu("animNumAnimations",1),hu("animIndex",0),hu("randomizeAnimIndex",!1),hu("animSpeed",1),hu("animLoop",!0),this._gpuUpdater=new qd(this,s),this._cpuUpdater=new Wd(this),this.constantLightCube=s.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),hu("colorGraph",Qd),hu("colorGraph2",this.colorGraph),hu("scaleGraph",Zd),hu("scaleGraph2",this.scaleGraph),hu("alphaGraph",Zd),hu("alphaGraph2",this.alphaGraph),hu("localVelocityGraph",Jd),hu("localVelocityGraph2",this.localVelocityGraph),hu("velocityGraph",Jd),hu("velocityGraph2",this.velocityGraph),hu("rotationSpeedGraph",$d),hu("rotationSpeedGraph2",this.rotationSpeedGraph),hu("radialSpeedGraph",$d),hu("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=new Array(6),this.lightCubeDir[0]=new it(-1,0,0),this.lightCubeDir[1]=new it(1,0,0),this.lightCubeDir[2]=new it(0,-1,0),this.lightCubeDir[3]=new it(0,1,0),this.lightCubeDir[4]=new it(0,0,-1),this.lightCubeDir[5]=new it(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!1,this.pack8=!0,this.localBounds=new bt,this.worldBoundsNoTrail=new bt,this.worldBoundsTrail=[new bt,new bt],this.worldBounds=new bt,this.worldBoundsSize=new it,this.prevWorldBoundsSize=new it,this.prevWorldBoundsCenter=new it,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new it,this.worldBoundsAdd=new it,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}static staticInit(t){if(!pu.DEFAULT_PARAM_TEXTURE){const e=16,s=.5*e+.5,i=new Float32Array(e*e*4);for(let t=0;t<e;t++)for(let n=0;n<e;n++){const a=n+1-s,r=t+1-s,o=Kd(1-Kd(Math.sqrt(a*a+r*r)/e)-.5),h=t*e+n;i[4*h]=1,i[4*h+1]=1,i[4*h+2]=1,i[4*h+3]=o}pu.DEFAULT_PARAM_TEXTURE=Yd(t,e,e,i,Li,1,!0),pu.DEFAULT_PARAM_TEXTURE.minFilter=ui,pu.DEFAULT_PARAM_TEXTURE.magFilter=ui}}static staticDestroy(){pu.DEFAULT_PARAM_TEXTURE&&(pu.DEFAULT_PARAM_TEXTURE.destroy(),pu.DEFAULT_PARAM_TEXTURE=null)}onChangeCamera(){this.regenShader(),this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let t=!1;t=this.emitterShape===pe?!this.emitterExtents.equals(this.prevEmitterExtents):!(this.emitterRadius===this.prevEmitterRadius),t&&this.calculateLocalBounds()}const t=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,t),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const e=this.simTimeTotal;e>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=e+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,t),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,t)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?dt.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let t=Number.MAX_VALUE,e=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=-Number.MAX_VALUE,a=-Number.MAX_VALUE,r=0,o=0;const h=this.lifetime/this.precision,l=[this.qVelocity,this.qVelocity2],c=[this.qLocalVelocity,this.qLocalVelocity2],d=[0,0],u=[0,0],p=[0,0],m=[0,0],f=[0,0];let _,g,y;for(let v=0;v<this.precision+1;v++){const x=Math.min(v,this.precision-1);for(let r=0;r<2;r++)_=c[r][3*x+0]*h+d[r],g=c[r][3*x+1]*h+u[r],y=c[r][3*x+2]*h+p[r],t=Math.min(_,t),e=Math.min(g,e),s=Math.min(y,s),i=Math.max(_,i),n=Math.max(g,n),a=Math.max(y,a),d[r]=_,u[r]=g,p[r]=y;for(let t=0;t<2;t++)f[t]+=h*Math.sqrt(l[t][3*x+0]*l[t][3*x+0]+l[t][3*x+1]*l[t][3*x+1]+l[t][3*x+2]*l[t][3*x+2]);m[0]+=this.qRadialSpeed[x]*h,m[1]+=this.qRadialSpeed2[x]*h,r=Math.max(r,Math.max(Math.abs(m[0]),Math.abs(m[1]))),o=Math.max(o,this.qScale[x])}this.emitterShape===pe?(_=.5*this.emitterExtents.x,g=.5*this.emitterExtents.y,y=.5*this.emitterExtents.z):(_=this.emitterRadius,g=this.emitterRadius,y=this.emitterRadius);const v=Math.max(f[0],f[1]);nu.x=t-o-_-r-v,nu.y=e-o-g-r-v,nu.z=s-o-y-r-v,au.x=i+o+_+r+v,au.y=n+o+g+r+v,au.z=a+o+y+r+v,this.localBounds.setMinMax(nu,au)}rebuild(){const t=this.graphicsDevice;if(null===this.colorMap&&(this.colorMap=pu.DEFAULT_PARAM_TEXTURE),this.spawnBounds=this.emitterShape===pe?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>de||t.maxVertexTextures<=1||t.fragmentUniformsCount<64||t.forceCpuParticles||!t.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!t.textureFloatRenderable)&&!this.useCpu,tu=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh){this.numParticles*this.mesh.vertexBuffer.numVertices>65535||(this.useMesh=!0)}this.numParticlesPot=V.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?dt.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let t=0;t<this.numParticles;t++)this.vbToSort[t]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*tu*4);const e=null===this.node||this.localSpace?it.ZERO:this.node.getPosition();this.emitterShape===pe&&(null===this.node||this.localSpace?su.setTRS(it.ZERO,ft.IDENTITY,this.spawnBounds):su.setTRS(it.ZERO,this.node.getRotation(),iu.copy(this.spawnBounds).mul(this.node.localScale)),eu[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,eu[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,eu[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let t=0;t<this.numParticles;t++)this._cpuUpdater.calcSpawnPosition(this.particleTex,su,eu,e,t),this.useCpu&&(this.particleTex[4*t+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*tu*4);for(let t=0;t<this.particleTexStart.length;t++)this.particleTexStart[t]=this.particleTex[t];this.useCpu||(this.pack8?(this.particleTexIN=Yd(t,this.numParticlesPot,tu,this.particleTex,Li,1,!1),this.particleTexOUT=Yd(t,this.numParticlesPot,tu,this.particleTex,Li,1,!1),this.particleTexStart=Yd(t,this.numParticlesPot,tu,this.particleTexStart,Li,1,!1)):(this.particleTexIN=Yd(t,this.numParticlesPot,tu,this.particleTex),this.particleTexOUT=Yd(t,this.numParticlesPot,tu,this.particleTex),this.particleTexStart=Yd(t,this.numParticlesPot,tu,this.particleTexStart)),this.rtParticleTexIN=new uh({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new uh({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=(this.localSpace?"#define LOCAL_SPACE\n":"")+ir.particleUpdaterInitPS+(this.pack8?ir.particleInputRgba8PS+ir.particleOutputRgba8PS:ir.particleInputFloatPS+ir.particleOutputFloatPS)+(this.emitterShape===pe?ir.particleUpdaterAABBPS:ir.particleUpdaterSpherePS)+ir.particleUpdaterStartPS,i=s+ir.particleUpdaterRespawnPS+ir.particleUpdaterEndPS,n=s+ir.particleUpdaterNoRespawnPS+ir.particleUpdaterEndPS,a=s+ir.particleUpdaterOnStopPS+ir.particleUpdaterEndPS,r=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=fr(t,ir.fullscreenQuadVS,i,"fsQuad0"+r),this.shaderParticleUpdateNoRespawn=fr(t,ir.fullscreenQuadVS,n,"fsQuad1"+r),this.shaderParticleUpdateOnStop=fr(t,ir.fullscreenQuadVS,a,"fsQuad2"+r),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const o=new Uh(t);o.vertexBuffer=this.vertexBuffer,o.indexBuffer[0]=this.indexBuffer,o.primitive[0].type=rn,o.primitive[0].base=0,o.primitive[0].count=this.numParticles*this.numParticleIndices,o.primitive[0].indexed=!0,this.material=new Io,this.material.name=this.node.name,this.material.cull=oi,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();const h=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new dl(o,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=h,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==pu.DEFAULT_PARAM_TEXTURE||this.normalMap)}rebuildGraphs(){const t=this.precision,e=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(t),this.qVelocity=this.velocityGraph.quantize(t),this.qColor=this.colorGraph.quantizeClamped(t,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(t),this.qScale=this.scaleGraph.quantize(t),this.qAlpha=this.alphaGraph.quantize(t),this.qRadialSpeed=this.radialSpeedGraph.quantize(t),this.qLocalVelocity2=this.localVelocityGraph2.quantize(t),this.qVelocity2=this.velocityGraph2.quantize(t),this.qColor2=this.colorGraph2.quantizeClamped(t,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t),this.qScale2=this.scaleGraph2.quantize(t),this.qAlpha2=this.alphaGraph2.quantize(t),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t);for(let e=0;e<t;e++)this.qRotSpeed[e]*=V.DEG_TO_RAD,this.qRotSpeed2[e]*=V.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=uu(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=uu(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=uu(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=uu(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=uu(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=uu(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=uu(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const t=[0,0,0];du(this.qVelocity,t);const e=[0,0,0];du(this.qVelocity2,e);const s=[0,0,0];du(this.qLocalVelocity,s);const i=[0,0,0];du(this.qLocalVelocity2,i);const n=[0];du(this.qRadialSpeed,n);const a=[0];du(this.qRadialSpeed2,a);let r=Math.max(t[0],e[0]);r=Math.max(r,t[1]),r=Math.max(r,e[1]),r=Math.max(r,t[2]),r=Math.max(r,e[2]);let o=Math.max(s[0],i[0]);o=Math.max(o,s[1]),o=Math.max(o,i[1]),o=Math.max(o,s[2]),o=Math.max(o,i[2]);const h=Math.max(n[0],a[0]);this.maxVel=r+o+h}this.useCpu||(this.internalTex0=Yd(e,t,1,cu(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Yd(e,t,1,cu(this.qVelocity,this.qVelocityDiv)),this.internalTex2=Yd(e,t,1,function(t,e,s,i,n){const a=new Array(4*t.length);for(let r=0;r<t.length;r++)a[4*r]=t[r],a[4*r+1]=e[r],a[4*r+2]=0,a[4*r+3]=lu(s[r],i[r],n[r]);return a}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=Yd(e,t,1,function(t,e){const s=new Array(4*t.length);for(let i=0;i<t.length;i++)s[4*i]=t[i],s[4*i+1]=e[i],s[4*i+2]=0,s[4*i+3]=0;return s}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=Yd(e,t,1,function(t,e){const s=new Array(4*e.length);for(let i=0;i<e.length;i++)s[4*i]=t[3*i],s[4*i+1]=t[3*i+1],s[4*i+2]=t[3*i+2],s[4*i+3]=e[i];return s}(this.qColor,this.qAlpha),Li,1,!0)}_initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}regenShader(){const t=this.graphicsDevice.getProgramLibrary(),e=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=e?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());const e=this.emitter.inTools,s=t.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!e&&this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!==fe});this.shader=s},this.material.updateShader()}resetMaterial(){const t=this.material;t.setParameter("stretch",this.stretch),this._isAnimated()&&(t.setParameter("animTexTilesParams",this.animTilesParams),t.setParameter("animTexParams",this.animParams),t.setParameter("animTexIndexParams",this.animIndexParams)),t.setParameter("colorMult",this.intensity),this.useCpu||(t.setParameter("internalTex0",this.internalTex0),t.setParameter("internalTex1",this.internalTex1),t.setParameter("internalTex2",this.internalTex2),t.setParameter("internalTex3",this.internalTex3)),t.setParameter("colorParam",this.colorParam),t.setParameter("numParticles",this.numParticles),t.setParameter("numParticlesPot",this.numParticlesPot),t.setParameter("lifetime",this.lifetime),t.setParameter("rate",this.rate),t.setParameter("rateDiv",this.rate2-this.rate),t.setParameter("seed",this.seed),t.setParameter("scaleDivMult",this.scaleUMax[0]),t.setParameter("alphaDivMult",this.alphaUMax[0]),t.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),t.setParameter("graphNumSamples",this.precision),t.setParameter("graphSampleSize",1/this.precision),t.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),t.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),t.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),t.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,t.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&t.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&t.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&t.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(t.cull=oi),this._compParticleFaceParams()}_compParticleFaceParams(){let t,e;if(this.orientation===fe)t=new Float32Array([1,0,0]),e=new Float32Array([0,0,1]);else{let s;if(this.orientation===_e)s=this.particleNormal.normalize();else{s=(null===this.node?dt.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize()}const i=new it(1,0,0);1===Math.abs(i.dot(s))&&i.set(0,0,1);const n=(new it).cross(s,i).normalize();i.cross(n,s).normalize(),t=new Float32Array([i.x,i.y,i.z]),e=new Float32Array([n.x,n.y,n.z])}this.material.setParameter("faceTangent",t),this.material.setParameter("faceBinorm",e)}_allocate(t){const e=t*this.numParticleVerts,s=t*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==e){if(this.useCpu){const t=[{semantic:Tn,components:4,type:oa},{semantic:An,components:4,type:oa},{semantic:Cn,components:4,type:oa},{semantic:Pn,components:1,type:oa},{semantic:Rn,components:this.useMesh?4:2,type:oa}],i=new Ja(this.graphicsDevice,t);this.vertexBuffer=new $a(this.graphicsDevice,i,e,ei),this.indexBuffer=new ph(this.graphicsDevice,Si,s)}else{const t=[{semantic:Tn,components:4,type:oa}];this.useMesh&&t.push({semantic:An,components:2,type:oa});const i=new Ja(this.graphicsDevice,t);this.vertexBuffer=new $a(this.graphicsDevice,i,e,ei),this.indexBuffer=new ph(this.graphicsDevice,Si,s)}const i=new Float32Array(this.vertexBuffer.lock());let n,a,r;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),a=n.length/this.mesh.vertexBuffer.numVertices;for(let t=0;t<this.mesh.vertexBuffer.format.elements.length;t++)if(this.mesh.vertexBuffer.format.elements[t].name===_n){r=this.mesh.vertexBuffer.format.elements[t].offset/4;break}}for(let t=0;t<e;t++){const e=Math.floor(t/this.numParticleVerts);if(this.useMesh){const s=t%this.numParticleVerts;i[6*t]=n[s*a],i[6*t+1]=n[s*a+1],i[6*t+2]=n[s*a+2],i[6*t+3]=e,i[6*t+4]=n[s*a+r+0],i[6*t+5]=1-n[s*a+r+1]}else{const s=t%4;i[4*t]=Xd[s][0],i[4*t+1]=Xd[s][1],i[4*t+2]=0,i[4*t+3]=e}}this.useCpu&&(this.vbCPU=new Float32Array(i),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let o=0;const h=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(let e=0;e<t;e++)if(this.useMesh)for(let t=0;t<this.numParticleIndices;t++)h[e*this.numParticleIndices+t]=n[t]+e*this.numParticleVerts;else{const t=4*e;h[o++]=t,h[o++]=t+1,h[o++]=t+2,h[o++]=t,h[o++]=t+2,h[o++]=t+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();const t=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=t,this.preWarm&&this.prewarm(this.lifetime)}prewarm(t){const e=t/this.lifetime,s=Math.min(Math.floor(e*this.precision),this.precision),i=t/s;for(let t=0;t<s;t++)this.addTime(i,!1)}resetTime(){this.endTime=function(t){const e=Math.max(t.rate,t.rate2)*t.numParticles+t.lifetime;return Date.now()+1e3*e}(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(t,e){const s=this.graphicsDevice;if(this.simTimeTotal+=t,this.calculateWorldBounds(),this._isAnimated()){const t=this.animTilesParams;t[0]=1/this.animTilesX,t[1]=1/this.animTilesY;const e=this.animParams;e[0]=this.animStartFrame,e[1]=this.animNumFrames*this.animSpeed,e[2]=this.animNumFrames-1,e[3]=this.animNumAnimations-1;const s=this.animIndexParams;s[0]=this.animIndex,s[1]=this.randomizeAnimIndex}let i;this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),this.emitterShape===pe&&(eu[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,eu[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,eu[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?su.setTRS(it.ZERO,ft.IDENTITY,this.emitterExtents):su.setTRS(it.ZERO,this.meshInstance.node.getRotation(),iu.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));const n=null===this.meshInstance.node?it.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){const s=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(s,this.vbToSort,this.particleTex,su,eu,i,t,e)}else this._gpuUpdater.update(s,su,eu,t,e);this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)}destroy(){this.camera=null,this._destroyResources()}}pu.DEFAULT_PARAM_TEXTURE=null;const mu=new Set,fu={depth:1,flags:ai};class _u{constructor(t,e,s){t instanceof ch&&(t=Fh()),this.app=t,this.device=t.graphicsDevice,this.pickColor=new Float32Array(4),this.pickColor[3]=1,this.mapping=[],this.cameraEntity=null,this.layer=null,this.layerComp=null,this.initLayerComposition(),this._renderTarget=null;const i=this.device;this.clearDepthCommand=new cl(0,0,(function(){i.clear(fu)})),this.width=0,this.height=0,this.resize(e,s)}getSelection(t,e,s,i){const n=this.device;if("object"==typeof t){const n=t;t=n.x,e=n.y,s=n.width,i=n.height}else e=this.renderTarget.height-(e+(i||1));t=Math.floor(t),e=Math.floor(e),s=Math.floor(Math.max(s||1,1)),i=Math.floor(Math.max(i||1,1));const a=n.renderTarget;n.setRenderTarget(this.renderTarget),n.updateBegin();const r=new Uint8Array(4*s*i);n.readPixels(t,e,s,i,r),n.updateEnd(),n.setRenderTarget(a);const o=this.mapping;for(let t=0;t<s*i;t++){const e=r[4*t+0]<<16|r[4*t+1]<<8|r[4*t+2];16777215!==e&&mu.add(o[e])}const h=[];return mu.forEach((t=>h.push(t))),mu.clear(),h}allocateRenderTarget(){const t=new Mr(this.device,{format:Li,width:this.width,height:this.height,mipmaps:!1,minFilter:di,magFilter:di,addressU:Ws,addressV:Ws});t.name="pick",this.renderTarget=new uh({colorBuffer:t,depth:!0})}releaseRenderTarget(){this.cameraEntity.camera.renderTarget=null,this._renderTarget&&(this._renderTarget._colorBuffer.destroy(),this._renderTarget.destroy(),this._renderTarget=null)}initLayerComposition(){const t=this.device,e=this,s=t.scope.resolve("uColor");this.cameraEntity=new ld,this.cameraEntity.addComponent("camera"),this.layer=new Gc({name:"Picker",shaderPass:us,opaqueSortMode:xs,onDrawCall:function(i,n){e.pickColor[0]=(n>>16&255)/255,e.pickColor[1]=(n>>8&255)/255,e.pickColor[2]=(255&n)/255,s.setValue(e.pickColor),t.setBlending(!1),e.mapping[n]=i}}),this.layer.addCamera(this.cameraEntity.camera),this.layerComp=new Kc("picker"),this.layerComp.pushOpaque(this.layer)}prepare(t,e,s){t instanceof Rr&&(t=t.node.camera),s instanceof Gc&&(s=[s]),this.layer.clearMeshInstances();const i=this.layer.opaqueMeshInstances,n=e.layers.layerList,a=e.layers.subLayerEnabled,r=e.layers.subLayerList;for(let e=0;e<n.length;e++){const o=n[e];if(!(s&&s.indexOf(o)<0)&&(o.enabled&&a[e])){if(o.cameras.indexOf(t)>=0){o._clearDepthBuffer&&i.push(this.clearDepthCommand);const t=r[e]?o.instances.transparentMeshInstances:o.instances.opaqueMeshInstances;for(let e=0;e<t.length;e++){const s=t[e];s.pick&&i.push(s)}}}}this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.updateCamera(t),this.mapping.length=0,this.app.renderer.renderComposition(this.layerComp)}updateCamera(t){this.cameraEntity.copy(t.entity),this.cameraEntity.name="PickerCamera";const e=this.cameraEntity.camera;e.copy(t),e.clearColorBuffer=!0,e.clearDepthBuffer=!0,e.clearStencilBuffer=!0,e.clearColor=J.WHITE,e.renderTarget=this.renderTarget,this.layer.clearCameras(),this.layer.addCamera(e),e.layers=[this.layer.id]}resize(t,e){this.width=Math.floor(t),this.height=Math.floor(e)}}const gu=["#ifdef MAPFLOAT","uniform float material_shininess;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_glossMap;","#endif","","void getGlossiness() {","\t\tdGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tdGlossiness *= material_shininess;","#endif","","#ifdef MAPTEXTURE","\t\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","\t\tdGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tdGlossiness = 1.0 - dGlossiness;","","\t\tdGlossiness += 0.0000001;","}"].join("\n")+"\n",yu=["#ifdef MAPCOLOR","uniform vec3 material_specular;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_specularMap;","#endif","","void getSpecularity() {","\t\tdSpecularity = vec3(1.0);","","\t\t#ifdef MAPCOLOR","\t\t\t\tdSpecularity *= material_specular;","\t\t#endif","","\t\t#ifdef MAPTEXTURE","\t\t\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;","\t\t\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));","\t\t#endif","","\t\t#ifdef MAPVERTEX","\t\t\t\tdSpecularity *= saturate(vVertexColor.$VC);","\t\t#endif","}"].join("\n")+"\n",vu=["#ifdef MAPFLOAT","uniform float material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_clearCoatGlossMap;","#endif","","void getClearCoatGlossiness() {","\t\tccGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tccGlossiness *= material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","\t\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","\t\tccGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tccGlossiness = 1.0 - ccGlossiness;","","\t\tccGlossiness += 0.0000001;","}"].join("\n")+"\n",xu="MASK",bu="BLEND",Su="OPAQUE",wu=[{name:"baseColor",type:"Color"},{name:"baseColorMap",type:"Texture"},{name:"baseColorMapUv",type:"number"},{name:"baseColorMapOffset",type:"Vec2"},{name:"baseColorMapScale",type:"Vec2"},{name:"baseColorVertex",type:"boolean"},{name:"opacity",type:"number"},{name:"opacityMap",type:"Texture"},{name:"opacityMapUv",type:"number"},{name:"opacityMapOffset",type:"Vec2"},{name:"opacityMapScale",type:"Vec2"},{name:"metallic",type:"number"},{name:"metallicMap",type:"Texture"},{name:"metallicMapUv",type:"number"},{name:"metallicMapOffset",type:"Vec2"},{name:"metallicMapScale",type:"Vec2"},{name:"roughness",type:"number"},{name:"roughnessMap",type:"Texture"},{name:"roughnessMapUv",type:"number"},{name:"roughnessMapOffset",type:"Vec2"},{name:"roughnessMapScale",type:"Vec2"},{name:"normalMap",type:"Texture"},{name:"normalMapUv",type:"number"},{name:"normalMapOffset",type:"Vec2"},{name:"normalMapScale",type:"Vec2"},{name:"normalScale",type:"number"},{name:"occlusionMap",type:"Texture"},{name:"occlusionMapUv",type:"number"},{name:"occlusionMapOffset",type:"Vec2"},{name:"occlusionMapScale",type:"Vec2"},{name:"occlusionStrength",type:"number"},{name:"emissive",type:"Color"},{name:"emissiveMap",type:"Texture"},{name:"emissiveMapUv",type:"number"},{name:"emissiveMapOffset",type:"Vec2"},{name:"emissiveMapScale",type:"Vec2"},{name:"alphaCutoff",type:"number"},{name:"doubleSided",type:"boolean"},{name:"alphaMode",type:"string"},{name:"clearcoat",type:"number"},{name:"clearcoatMap",type:"Texture"},{name:"clearcoatMapUv",type:"number"},{name:"clearcoatMapOffset",type:"Vec2"},{name:"clearcoatMapScale",type:"Vec2"},{name:"clearcoatRoughness",type:"number"},{name:"clearcoatRoughnessMap",type:"Texture"},{name:"clearcoatRoughnessMapUv",type:"number"},{name:"clearcoatRoughnessMapOffset",type:"Vec2"},{name:"clearcoatRoughnessMapScale",type:"Vec2"},{name:"clearcoatNormalScale",type:"number"},{name:"clearcoatNormalMap",type:"Texture"},{name:"clearcoatNormalMapUv",type:"number"},{name:"clearcoatNormalMapOffset",type:"Vec2"},{name:"clearcoatNormalMapScale",type:"Vec2"}];class Mu extends Wo{constructor(){super(),this.metalnessMapChannel="b",this.glossMapChannel="g",this.opacityMapChannel="a",this.diffuseMapChannel="rgb",this.aoMapChannel="r",this.clearCoatMapChannel="r",this.clearCoatGlossMapChannel="g",this.useMetalness=!0,this.diffuseTint=!0,this.diffuseVertexColor=!1,this.specularTint=!0,this.specularVertexColor=!0,this._chunks.specularPS=yu,this._chunks.glossPS=gu,this._chunks.clearCoatGlossPS=vu,this._baseColor=new J,this._baseColorMap=null,this._baseColorMapUv=0,this._baseColorMapOffset=new st,this._baseColorMapScale=new st(1,1),this._baseColorVertex=!1,this._opacity=0,this._opacityMap=null,this._opacityMapUv=0,this._opacityMapOffset=new st,this._opacityMapScale=new st(1,1),this._metallic=1,this._metallicMap=null,this._metallicMapUv=0,this._metallicMapOffset=new st,this._metallicMapScale=new st,this._roughness=1,this._roughnessMap=null,this._roughnessMapUv=0,this._roughnessMapOffset=new st,this._roughnessMapScale=new st(1,1),this._normalScale=1,this._normalMap=null,this._normalMapUv=0,this._normalMapOffset=new st,this._normalMapScale=new st(1,1),this._occlusionMap=null,this._occlusionMapUv=0,this._occlusionMapOffset=new st,this._occlusionMapScale=new st(1,1),this._occlusionStrength=1,this._emissive=new J,this._emissiveMap=null,this._emissiveMapUv=0,this._emissiveMapOffset=new st,this._emissiveMapScale=new st(1,1),this._clearcoat=0,this._clearcoatMap=null,this._clearcoatMapUv=0,this._clearcoatMapOffset=new st,this._clearcoatMapScale=new st,this._clearcoatRoughness=0,this._clearcoatRoughnessMap=null,this._clearcoatRoughnessMapUv=0,this._clearcoatRoughnessMapOffset=new st,this._clearcoatRoughnessMapScale=new st,this._clearcoatNormalScale=1,this._clearcoatNormalMap=null,this._clearcoatNormalMapUv=0,this._clearcoatNormalMapOffset=new st,this._clearcoatNormalMapScale=new st,this._opacity=1,this._alphaCutoff=0,this._doubleSided=!1,this._alphaMode=Su}clone(){const t=new Mu;this._cloneInternal(t);for(let e=0;e<wu.length;e++){const s=wu[e].name;void 0!==this[s]&&(this[s]&&this[s].copy?t[s]?t[s].copy(this[s]):t[s]=this[s].clone():t[s]=this[s])}return t}}const Tu=function(t,e,s){s=s||{},t!==e&&Object.defineProperty(Mu.prototype,t,{get:s.get?s.get:function(){return this[`_${t}`]},set:s.set?s.set:function(i){let n;n=s.inset?s.inset.call(this,i):i,t!==e&&(this[e]=n),this[`_${t}`]=n}})},Au=function(t,e,s){s=s||{},t!==e&&Object.defineProperty(Mu.prototype,t,{get:s.get?s.get:function(){return this[`_${t}`]},set:s.set?s.set:function(i){let n;n=s.inset?s.inset.call(this,i):i,this[e].copy(n),this[`_${t}`].copy(n)}})};Au("baseColor","diffuse",{}),Tu("baseColorMap","diffuseMap"),Tu("baseColorMapUv","diffuseMapUv"),Au("baseColorMapOffset","diffuseMapOffset"),Au("baseColorMapScale","diffuseMapTiling"),Tu("baseColorVertex","diffuseVertexColor"),Tu("opacity","opacity"),Tu("opacityMap","opacityMap"),Tu("opacityMapUv","opacityMapUv"),Au("opacityMapOffset","opacityMapOffset"),Au("opacityMapScale","opacityMapTiling"),Tu("metallic","metalness"),Tu("metallicMap","metalnessMap"),Tu("metallicMapUv","metalnessMapUv"),Au("metallicMapOffset","metalnessMapOffset"),Au("metallicMapScale","metalnessMapTiling"),Tu("roughness","shininess",{get:function(){return this._roughness},set:function(t){this._roughness=t,this.shininess=100*t}}),Tu("roughnessMap","glossMap"),Tu("roughnessMapUv","glossMapUv"),Au("roughnessMapOffset","glossMapOffset"),Au("roughnessMapScale","glossMapTiling"),Tu("normalScale","bumpiness"),Tu("normalMap","normalMap"),Tu("normalMapUv","normalMapUv"),Au("normalMapOffset","normalMapOffset"),Au("normalMapScale","normalMapTiling"),Tu("occlusionMap","aoMap"),Tu("occlusionStrength","aoStrength"),Tu("occlusionMapUv","aoMapUv"),Au("occlusionMapOffset","aoMapOffset"),Au("occlusionMapScale","aoMapTiling"),Au("emissive","",{set:function(t){var e=this._emissive;(0===e.r&&0===e.g&&0===e.b||1===e.r&&1===e.g&&1===e.b)!=(0===t.r&&0===t.g&&0===t.b||1===t.r&&1===t.g&&1===t.b)&&(this.dirtyShader=!0),this.dirtyColor=!0,this._emissive=t}}),Tu("emissiveMap","",{set:function(t){this.emissiveTint=!!t;var e=this._emissiveMap;!!e!=!!t&&(this.dirtyShader=!0),e&&t&&(e.type===t.type&&e.fixCubemapSeams===t.fixCubemapSeams&&e.format===t.format||(this.dirtyShader=!0)),this._emissiveMap=t}}),Tu("emissiveMapUv","emissiveMapUv"),Au("emissiveMapOffset","emissiveMapOffset"),Au("emissiveMapScale","emissiveMapTiling"),Tu("alphaCutoff","alphaTest"),Tu("doubleSided","twoSidedLighting",{inset:function(t){this.cull=t?oi:hi}}),Tu("alphaMode","",{get:function(){return this._alphaMode},set:function(t){switch(t){case xu:this.blendType=Pt;break;case bu:this.blendType=Ct;break;default:this.blendType=Pt}this._alphaMode=t}}),Tu("clearcoat","clearCoat",{set:function(t){this._clearcoat=t,this.clearCoat=.25*t}}),Tu("clearcoatMap","clearCoatMap"),Tu("clearcoatMapUv","clearCoatMapUv"),Au("clearcoatMapOffset","clearCoatMapOffset"),Au("clearcoatMapScale","clearCoatMapTiling"),Tu("clearcoatRoughness","clearCoatGlossiness"),Tu("clearcoatRoughnessMap","clearCoatGlossMap"),Tu("clearcoatRoughnessMapUv","clearCoatGlossMapUv"),Au("clearcoatRoughnessMapOffset","clearCoatGlossMapOffset"),Au("clearcoatRoughnessMapScale","clearCoatGlossMapTiling"),Tu("clearcoatNormalScale","clearCoatBumpiness"),Tu("clearcoatNormalMap","clearCoatNormalMap"),Tu("clearcoatNormalMapUv","clearCoatNormalMapUv"),Au("clearcoatNormalMapOffset","clearCoatNormalMapOffset"),Au("clearcoatNormalMapScale","clearCoatNormalMapTiling");class Cu extends u{constructor(t){super(),this.device=t||Fh().graphicsDevice,this.root=null,this._gravity=new it(0,-9.8,0),this._layers=null,this._fog=kt,this.fogColor=new J(0,0,0),this.fogStart=1,this.fogEnd=1e3,this.fogDensity=0,this.ambientLight=new J(0,0,0),this._gammaCorrection=Ce,this._toneMapping=0,this.exposure=1,this._skyboxCubeMap=null,this._prefilteredCubemaps=[null,null,null,null,null,null],this._envAtlas=null,this._internalEnvAtlas=null,this.skyboxModel=null,this._skyboxIntensity=1,this._skyboxMip=0,this._skyboxRotation=new ft,this._skyboxRotationMat3=null,this._skyboxRotationMat4=null,this._ambientBake=!1,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this.ambientBakeOcclusionContrast=0,this.ambientBakeOcclusionBrightness=0,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=_s,this.lightmapFilterEnabled=!1,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!1,this._lightingParams=new nd(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this._layers._dirtyLights=!0})),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this._models=[]}destroy(){this._resetSkyboxModel(),this.root=null,this.off()}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set clusteredLightingEnabled(t){!this._clusteredLightingEnabled||t?this._clusteredLightingEnabled=t:console.error("Turning off enabled clustered lighting is not currently supported")}get lighting(){return this._lightingParams}get fog(){return this._fog}set fog(t){t!==this._fog&&(this._fog=t,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set gammaCorrection(t){t!==this._gammaCorrection&&(this._gammaCorrection=t,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}set toneMapping(t){t!==this._toneMapping&&(this._toneMapping=t,this.updateShaders=!0)}get skybox(){return this._skyboxCubeMap}set skybox(t){t!==this._skyboxCubeMap&&(this._skyboxCubeMap=t,this._resetSkyboxModel())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxIntensity(t){t!==this._skyboxIntensity&&(this._skyboxIntensity=t,this._resetSkyboxModel())}get ambientBake(){return this._ambientBake}set ambientBake(t){this._ambientBake=t}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeNumSamples(t){this._ambientBakeNumSamples=V.clamp(Math.floor(t),1,255)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set ambientBakeSpherePart(t){this._ambientBakeSpherePart=V.clamp(t,.001,1)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterRange(t){this._lightmapFilterRange=Math.max(t,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set lightmapFilterSmoothness(t){this._lightmapFilterSmoothness=Math.max(t,.001)}get skyboxRotation(){return this._skyboxRotation}set skyboxRotation(t){this._skyboxRotation.equals(t)||(this._skyboxRotation.copy(t),this._resetSkyboxModel())}get skyboxMip(){return this._skyboxMip}set skyboxMip(t){t!==this._skyboxMip&&(this._skyboxMip=t,this._resetSkyboxModel())}get prefilteredCubemaps(){return this._prefilteredCubemaps}set prefilteredCubemaps(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const a=t[n]||null;e[n]!==a&&(e[n]=a,s=!0),i=i&&!!e[n]}s&&(this._resetSkyboxModel(),i?(this._internalEnvAtlas=Ro.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas||(this.envAtlas=this._internalEnvAtlas)):this._internalEnvAtlas&&(this._envAtlas===this._internalEnvAtlas&&(this.envAtlas=null),this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null))}get envAtlas(){return this._envAtlas}set envAtlas(t){t!==this._envAtlas&&(this._envAtlas=t,this.updateShaders=!0)}get drawCalls(){let t=this.layers._meshInstances;return t.length||(this.layers._update(),t=this.layers._meshInstances),t}set drawCalls(t){}get layers(){return this._layers}set layers(t){const e=this._layers;this._layers=t,this.fire("set:layers",e,t)}applySettings(t){this._gravity.set(t.physics.gravity[0],t.physics.gravity[1],t.physics.gravity[2]),this.ambientLight.set(t.render.global_ambient[0],t.render.global_ambient[1],t.render.global_ambient[2]),this._fog=t.render.fog,this.fogColor.set(t.render.fog_color[0],t.render.fog_color[1],t.render.fog_color[2]),this.fogStart=t.render.fog_start,this.fogEnd=t.render.fog_end,this.fogDensity=t.render.fog_density,this._gammaCorrection=t.render.gamma_correction,this._toneMapping=t.render.tonemapping,this.lightmapSizeMultiplier=t.render.lightmapSizeMultiplier,this.lightmapMaxResolution=t.render.lightmapMaxResolution,this.lightmapMode=t.render.lightmapMode,this.exposure=t.render.exposure,this._skyboxIntensity=void 0===t.render.skyboxIntensity?1:t.render.skyboxIntensity,this._skyboxMip=void 0===t.render.skyboxMip?0:t.render.skyboxMip,t.render.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(t.render.skyboxRotation[0],t.render.skyboxRotation[1],t.render.skyboxRotation[2]),this._resetSkyboxModel()}_getSkyboxTex(){const t=this._prefilteredCubemaps;if(this._skyboxMip){return t[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||t[0]||this._skyboxCubeMap}return this._skyboxCubeMap||t[0]||this._envAtlas}_updateSkybox(t){if(this.skyboxModel)return;const e=this._getSkyboxTex();if(!e)return;const s=new Io,i=this;s.updateShader=function(s,n,a,r,o){const h=t.getProgramLibrary();e.cubemap?this.shader=h.getProgram("skybox",{type:"cubemap",rgbm:e.type===Yn,hdr:e.type===Yn||e.format===zi,useIntensity:1!==i.skyboxIntensity,mip:e.fixCubemapSeams?i.skyboxMip:0,fixSeams:e.fixCubemapSeams,gamma:o===ls?i.gammaCorrection?Ee:Ce:i.gammaCorrection,toneMapping:o===ls?Le:i.toneMapping}):this.shader=h.getProgram("skybox",{type:"envAtlas",encoding:e.encoding,useIntensity:1!==i.skyboxIntensity,gamma:o===ls?i.gammaCorrection?Ee:Ce:i.gammaCorrection,toneMapping:o===ls?Le:i.toneMapping})},s.updateShader(),e.cubemap?s.setParameter("texture_cubeMap",e):(s.setParameter("texture_envAtlas",e),s.setParameter("mipLevel",this._skyboxMip)),this.skyboxRotation.equals(ft.IDENTITY)?s.setParameter("cubeMapRotationMatrix",at.IDENTITY.data):(this._skyboxRotationMat4||(this._skyboxRotationMat4=new dt),this._skyboxRotationMat3||(this._skyboxRotationMat3=new at),this._skyboxRotationMat4.setTRS(it.ZERO,this._skyboxRotation,it.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3),s.setParameter("cubeMapRotationMatrix",this._skyboxRotationMat3.data)),s.cull=li,s.depthWrite=!1;const n=this.layers.getLayerById(Ht);if(n){const i=new jr("Skybox"),a=$h(t),r=new dl(a,s,i);r.cull=!1,r._noDepthDrawGl1=!0,r.pick=!1;const o=new vd;o.graph=i,o.meshInstances=[r],this.skyboxModel=o,n.addMeshInstances(o.meshInstances),this.skyLayer=n,this.fire("set:skybox",e)}}_resetSkyboxModel(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy()),this.skyboxModel=null,this.updateShaders=!0}setSkybox(t){t?(this.skybox=t[0]||null,this.prefilteredCubemaps=t.slice(1)):(this.skybox=null,this.prefilteredCubemaps=[null,null,null,null,null,null])}addModel(t){if(this.containsModel(t))return;const e=this.layers.getLayerById(Wt);e&&(e.addMeshInstances(t.meshInstances),this._models.push(t))}addShadowCaster(t){const e=this.layers.getLayerById(Wt);e&&e.addShadowCasters(t.meshInstances)}removeModel(t){const e=this._models.indexOf(t);if(-1!==e){const s=this.layers.getLayerById(Wt);if(!s)return;s.removeMeshInstances(t.meshInstances),this._models.splice(e,1)}}removeShadowCasters(t){const e=this.layers.getLayerById(Wt);e&&e.removeShadowCasters(t.meshInstances)}containsModel(t){return this._models.indexOf(t)>=0}getModels(t){return this._models}}Cu.prototype.applySettings=function(t){if(t.physics&&t.render)return this._gravity.set(t.physics.gravity[0],t.physics.gravity[1],t.physics.gravity[2]),this.ambientLight.set(t.render.global_ambient[0],t.render.global_ambient[1],t.render.global_ambient[2]),this._fog=t.render.fog,this.fogColor.set(t.render.fog_color[0],t.render.fog_color[1],t.render.fog_color[2]),this.fogStart=t.render.fog_start,this.fogEnd=t.render.fog_end,this.fogDensity=t.render.fog_density,this._gammaCorrection=t.render.gamma_correction,this._toneMapping=t.render.tonemapping,this.lightmapSizeMultiplier=t.render.lightmapSizeMultiplier,this.lightmapMaxResolution=t.render.lightmapMaxResolution,this.lightmapMode=t.render.lightmapMode,this.exposure=t.render.exposure,this._skyboxIntensity=void 0===t.render.skyboxIntensity?1:t.render.skyboxIntensity,this._skyboxMip=void 0===t.render.skyboxMip?0:t.render.skyboxMip,t.render.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(t.render.skyboxRotation[0],t.render.skyboxRotation[1],t.render.skyboxRotation[2]),void this._resetSkyboxModel();this.ambientLight.set(t.global_ambient.r,t.global_ambient.g,t.global_ambient.b),this._fog=t.fog,this.fogColor.set(t.fog_color.r,t.fog_color.g,t.fog_color.b),this.fogStart=t.fog_start,this.fogEnd=t.fog_end,this.fogDensity=t.fog_density,this._gammaCorrection=t.gamma_correction,this._toneMapping=t.tonemapping,this.exposure=t.tonemapping_exposure,this.lightmapSizeMultiplier=t.lightmapSizeMultiplier,this.lightmapMaxResolution=t.lightmapMaxResolution,this.lightmapMode=t.lightmapMode,this._skyboxIntensity=void 0===t.skyboxIntensity?1:t.skyboxIntensity,this._skyboxMip=void 0===t.skyboxMip?0:t.skyboxMip,this._skyboxRotation.setFromAxisAngle(it.UP,void 0===t.skyboxAngle?0:t.skyboxAngle),this._resetSkyboxModel(),this.updateShaders=!0};class Pu{constructor(t,e,s){this.device=t,this.inverseBindPose=e,this.boneNames=s}}const Ru=[0,0,1,0,0,1,0,0,1,0,0,1],Eu=[0,1,3,2,3,1];class Lu extends u{constructor(t,e){super(),this._device=t,this._pixelsPerUnit=e&&void 0!==e.pixelsPerUnit?e.pixelsPerUnit:1,this._renderMode=e&&void 0!==e.renderMode?e.renderMode:ps,this._atlas=e&&void 0!==e.atlas?e.atlas:null,this._frameKeys=e&&void 0!==e.frameKeys?e.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}_createMeshes(){const t=this._meshes.length;for(let e=0;e<t;e++){const t=this._meshes[e];t&&t.destroy()}const e=this._frameKeys.length;this._meshes=new Array(e);const s=this.renderMode===ms||this._renderMode===fs?this._create9SliceMesh:this._createSimpleMesh;for(let t=0;t<e;t++){const e=this._atlas.frames[this._frameKeys[t]];this._meshes[t]=e?s.call(this,e):null}this.fire("set:meshes")}_createSimpleMesh(t){const e=t.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,n=e.z/this._pixelsPerUnit,a=e.w/this._pixelsPerUnit,r=t.pivot.x,o=t.pivot.y,h=[-r*n,-o*a,0,(1-r)*n,-o*a,0,(1-r)*n,(1-o)*a,0,-r*n,(1-o)*a,0],l=e.x/s,c=1-e.y/i,d=(e.x+e.z)/s,u=1-(e.y+e.w)/i,p=[l,c,d,c,d,u,l,u];return Gh(this._device,h,{uvs:p,normals:Ru,indices:Eu})}_create9SliceMesh(){const t=st.ONE,e=[],s=[],i=[],n=[];let a=0;for(let r=0;r<=3;r++){const o=0===r||3===r?0:1;for(let h=0;h<=3;h++){const l=-t.x+2*t.x*(r<=1?0:3)/3,c=0,d=-(-t.y+2*t.y*(h<=1?0:3)/3),u=0===h||3===h?0:1;e.push(-l,c,d),s.push(0,1,0),i.push(o,u),r<3&&h<3&&(n.push(a+3+1,a+1,a),n.push(a+3+1,a+3+2,a+1)),a++}}const r={normals:s,uvs:i,indices:n};return Gh(this._device,e,r)}_onSetFrames(t){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(t,e){const s=this._frameKeys.indexOf(t);s<0||(e?this.renderMode===ps&&(this._meshes[s]=this._createSimpleMesh(e)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(t){const e=this._frameKeys.indexOf(t);e<0||(this._meshes[e]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(const t of this._meshes)t&&t.destroy();this._meshes.length=0}get frameKeys(){return this._frameKeys}set frameKeys(t){this._frameKeys=t,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",t)}get atlas(){return this._atlas}set atlas(t){t!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=t,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",t))}get pixelsPerUnit(){return this._pixelsPerUnit}set pixelsPerUnit(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,this.fire("set:pixelsPerUnit",t),this._atlas&&this._frameKeys&&this.renderMode===ps&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get renderMode(){return this._renderMode}set renderMode(t){if(this._renderMode===t)return;const e=this._renderMode;this._renderMode=t,this.fire("set:renderMode",t),e!==ps&&t!==ps||this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get meshes(){return this._meshes}}class Iu{constructor(t){this.func=void 0===t.func?xi:t.func,this.ref=t.ref||0,this.readMask=void 0===t.readMask?255:t.readMask,this.writeMask=void 0===t.writeMask?255:t.writeMask,this.fail=t.fail||Wn,this.zfail=t.zfail||Wn,this.zpass=t.zpass||Wn}clone(){return new Iu({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})}}class Du extends u{constructor(){super(),this._texture=null,this._frames=null}setFrame(t,e){let s=this._frames[t];s?(s.rect.copy(e.rect),s.pivot.copy(e.pivot),s.border.copy(e.border)):(s={rect:e.rect.clone(),pivot:e.pivot.clone(),border:e.border.clone()},this._frames[t]=s),this.fire("set:frame",t.toString(),s)}removeFrame(t){const e=this._frames[t];e&&(delete this._frames[t],this.fire("remove:frame",t.toString(),e))}destroy(){this._texture&&this._texture.destroy()}get texture(){return this._texture}set texture(t){this._texture=t,this.fire("set:texture",t)}get frames(){return this._frames}set frames(t){this._frames=t,this.fire("set:frames",t)}}class Fu{constructor(t,e,s,i){this.time=t,this.position=e,this.rotation=s,this.scale=i}}class Ou{constructor(){this._name="",this._keys=[]}}class ku{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(t){return this._nodeDict[t]}get nodes(){return this._nodes}addNode(t){this._nodes.push(t),this._nodeDict[t._name]=t}}class Bu{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new ft,this._pos=new it,this._scale=new it,this._targetNode=null}getTarget(){return this._targetNode}setTarget(t){this._targetNode=t}}class zu{constructor(t){this._animation=null,this._time=0,this.looping=!0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const e=t=>{const s=new Bu;s._name=t.name,this._interpolatedKeys.push(s),this._interpolatedKeyDict[t.name]=s,this._currKeyIndices[t.name]=0;for(let s=0;s<t._children.length;s++)e(t._children[s])};e(t)}get animation(){return this._animation}set animation(t){this._animation=t,this.currentTime=0}get currentTime(){return this._time}set currentTime(t){this._time=t;const e=this._interpolatedKeys.length;for(let t=0;t<e;t++){const e=this._interpolatedKeys[t]._name;this._currKeyIndices[e]=0}this.addTime(0),this.updateGraph()}get numNodes(){return this._interpolatedKeys.length}addTime(t){if(null!==this._animation){const e=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=t,this._time>s){this._time=this.looping?0:s;for(let t=0;t<e.length;t++){const s=e[t]._name;this._currKeyIndices[s]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let t=0;t<e.length;t++){const s=e[t],i=s._name;this._currKeyIndices[i]=s._keys.length-2}}const i=t>=0?1:-1;for(let t=0;t<e.length;t++){const s=e[t],n=s._name,a=s._keys,r=this._interpolatedKeyDict[n];if(void 0===r)continue;let o=!1;if(1!==a.length)for(let t=this._currKeyIndices[n];t<a.length-1&&t>=0;t+=i){const e=a[t],s=a[t+1];if(e.time<=this._time&&s.time>=this._time){const i=(this._time-e.time)/(s.time-e.time);r._pos.lerp(e.position,s.position,i),r._quat.slerp(e.rotation,s.rotation,i),r._scale.lerp(e.scale,s.scale,i),r._written=!0,this._currKeyIndices[n]=t,o=!0;break}}(1===a.length||!o&&0===this._time&&this.looping)&&(r._pos.copy(a[0].position),r._quat.copy(a[0].rotation),r._scale.copy(a[0].scale),r._written=!0)}}}blend(t,e,s){const i=this._interpolatedKeys.length;for(let n=0;n<i;n++){const i=t._interpolatedKeys[n],a=e._interpolatedKeys[n],r=this._interpolatedKeys[n];i._written&&a._written?(r._quat.slerp(i._quat,e._interpolatedKeys[n]._quat,s),r._pos.lerp(i._pos,e._interpolatedKeys[n]._pos,s),r._scale.lerp(i._scale,a._scale,s),r._written=!0):i._written?(r._quat.copy(i._quat),r._pos.copy(i._pos),r._scale.copy(i._scale),r._written=!0):a._written&&(r._quat.copy(a._quat),r._pos.copy(a._pos),r._scale.copy(a._scale),r._written=!0)}}setGraph(t){if(this.graph=t,t)for(let e=0;e<this._interpolatedKeys.length;e++){const s=this._interpolatedKeys[e],i=t.findByName(s._name);this._interpolatedKeys[e].setTarget(i)}else for(let t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)}updateGraph(){if(this.graph)for(let t=0;t<this._interpolatedKeys.length;t++){const e=this._interpolatedKeys[t];if(e._written){const t=e.getTarget();t.localPosition.copy(e._pos),t.localRotation.copy(e._quat),t.localScale.copy(e._scale),t._dirtyLocal||t._dirtifyLocal(),e._written=!1}}}}const Uu=0,Vu=1,Nu=2;class Wu{static joinPath(t,e){e=e||".";return t.map((function(t){return t.replace(/\\/g,"\\\\").replace(new RegExp("\\"+e,"g"),"\\"+e)})).join(e)}static splitPath(t,e){e=e||".";const s=[];let i="",n=0;for(;n<t.length;){let a=t[n++];"\\"===a&&n<t.length?(a=t[n++],i+="\\"===a||a===e?a:"\\"+a):a===e?(s.push(i),i=""):i+=a}return i.length>0&&s.push(i),s}static encode(t,e,s){return`${Array.isArray(t)?t.join("/"):t}/${e}/${Array.isArray(s)?s.join("/"):s}`}resolve(t){return null}unresolve(t){}update(t){}}class Gu{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(t,e){if(t<this._left||t>=this._right){const s=e.length;if(s)if(t<e[0])this._left=-1/0,this._right=e[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(t>=e[s-1])this._left=e[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(t,e);this._left=e[s],this._right=e[s+1],this._len=this._right-this._left;const i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(t-this._left)*this._recip,this._hermite.valid=!1}_findKey(t,e){let s=0;for(;t>=e[s+1];)s++;return s}eval(t,e,s){const i=s._data,n=s._components,a=this._p0*n;if(e===Uu)for(let e=0;e<n;++e)t[e]=i[a+e];else{const s=this._t,r=this._p1*n;switch(e){case Vu:for(let e=0;e<n;++e)t[e]=V.lerp(i[a+e],i[r+e],s);break;case Nu:{const e=this._hermite;if(!e.valid){const t=s*s,i=s+s,n=1-s,a=n*n;e.valid=!0,e.p0=(1+i)*a,e.m0=s*a,e.p1=t*(3-i),e.m1=t*(s-1)}const a=(3*this._p0+1)*n,r=(3*this._p0+2)*n,o=(3*this._p1+1)*n,h=(3*this._p1+0)*n;for(let s=0;s<n;++s)t[s]=e.p0*i[a+s]+e.m0*i[r+s]*this._len+e.p1*i[o+s]+e.m1*i[h+s]*this._len;break}}}}}class Hu{constructor(t){this._name=t.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let e=0;e<t._inputs.length;++e)this._cache[e]=new Gu;const e=t._curves,s=t._outputs;for(let t=0;t<e.length;++t){const i=s[e[t]._output],n=[];for(let t=0;t<i._components;++t)n[t]=0;this._results[t]=n}}}class ju{constructor(t,e,s,i,n,a){for(this._name=t.name,this._track=t,this._snapshot=new Hu(t),this._playing=i,this._time=e,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=a,this._eventCursor=0;this._track.events[this._eventCursor]&&this._track.events[this._eventCursor].time<this.time;)this._eventCursor++}get name(){return this._name}set name(t){this._name=t}get track(){return this._track}get snapshot(){return this._snapshot}get time(){return this._time}set time(t){this._time=t}get speed(){return this._speed}set speed(t){this._speed=t}get loop(){return this._loop}set loop(t){this._loop=t}get blendWeight(){return this._blendWeight}set blendWeight(t){this._blendWeight=t}get blendOrder(){return this._blendOrder}set blendOrder(t){this._blendOrder=t}get eventCursor(){return this._eventCursor}set eventCursor(t){this._eventCursor=t}activeEventsForFrame(t,e){let s;for(0===t&&(this.eventCursor=0),e>this.track.duration&&(s=e-this.track.duration,e=this.track.duration);this.track.events[this.eventCursor]&&this.track.events[this.eventCursor].time>=t&&(e===this.track.duration?this.track.events[this.eventCursor].time<=e:this.track.events[this.eventCursor].time<e);){const t=this.track.events[this.eventCursor];this._eventHandler.fire(t.name,U({track:this.track},t)),this.eventCursor++}Number.isFinite(s)&&this.activeEventsForFrame(0,s)}_update(t){if(this._playing){let e=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(e,e+i*t),e+=i*t,i>=0?e>s&&(n?e=e%s||0:(e=this._track.duration,this.pause())):e<0&&(n?e=s+(e%s||0):(e=0,this.pause())),this._time=e}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}class qu{constructor(t,e,s,i){this._paths=t,this._input=e,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class Xu{constructor(t,e){this._components=t,this._data=e}get components(){return this._components}get data(){return this._data}}const Yu="NONE",Ku="PREV_STATE",$u="NEXT_STATE",Zu="PREV_STATE_NEXT_STATE",Ju="NEXT_STATE_PREV_STATE",Qu="GREATER_THAN",tp="LESS_THAN",ep="GREATER_THAN_EQUAL_TO",sp="LESS_THAN_EQUAL_TO",ip="EQUAL_TO",np="NOT_EQUAL_TO",ap="INTEGER",rp="FLOAT",op="BOOLEAN",hp="TRIGGER",lp="1D",cp="2D_DIRECTIONAL",dp="2D_CARTESIAN",up="DIRECT",pp="START",mp="END",fp="ANY",_p=[pp,mp,fp],gp="OVERWRITE";class yp{constructor(t,e){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=e,this.dirty=!0,this.value=[0,0,0,1]}getWeight(t){return this.dirty&&this.updateWeights(),0!==this.totalWeight&&this.mask[t]?this.weights[t]/this.totalWeight:0}setMask(t,e){this.mask[t]=e,this._component.layers[t].blendType===gp&&(this.mask=this.mask.fill(0,0,t)),this.dirty=!0}updateWeights(){this.totalWeight=0;for(let t=0;t<this.weights.length;t++)this.weights[t]=this._component.layers[t].weight,this.totalWeight+=this.mask[t]*this.weights[t];this.dirty=!1}updateValue(t,e){0===this.counter&&(this.value[0]=0,this.value[1]=0,this.value[2]=0,this.value[3]=1),this.mask[t]&&(0===this.counter?vp._set(this.value,e,this.valueType):vp._blend(this.value,e,this.getWeight(t),this.valueType))}}yp.TYPE_QUAT="quaternion",yp.TYPE_VEC3="vector3";class vp{constructor(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}static _dot(t,e){const s=t.length;let i=0;for(let n=0;n<s;++n)i+=t[n]*e[n];return i}static _normalize(t){let e=vp._dot(t,t);if(e>0){e=1/Math.sqrt(e);const s=t.length;for(let i=0;i<s;++i)t[i]*=e}}static _set(t,e,s){const i=t.length;if("quaternion"===s){let s=vp._dot(e,e);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)t[n]=e[n]*s}else for(let s=0;s<i;++s)t[s]=e[s]}static _blendVec(t,e,s){const i=1-s,n=t.length;for(let a=0;a<n;++a)t[a]=t[a]*i+e[a]*s}static _blendQuat(t,e,s){const i=t.length,n=1-s;vp._dot(t,e)<0&&(s=-s);for(let a=0;a<i;++a)t[a]=t[a]*n+e[a]*s;vp._normalize(t)}static _blend(t,e,s,i){"quaternion"===i?vp._blendQuat(t,e,s):vp._blendVec(t,e,s)}static _stableSort(t,e){const s=t.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(e(t[n],t[i])){const e=t[i];t[i]=t[n],t[n]=e}}get clips(){return this._clips}addClip(t){const e=this._targets,s=this._binder,i=t.track.curves,n=t.snapshot,a=[],r=[];for(let t=0;t<i.length;++t){const o=i[t].paths;for(let i=0;i<o.length;++i){const h=o[i],l=s.resolve(h);let c=e[l&&l.targetPath||null];if(!c&&l){c={target:l,value:[],curves:0,blendCounter:0};for(let t=0;t<c.target.components;++t)c.value.push(0);if(e[l.targetPath]=c,s.animComponent){if(!s.animComponent.targets[l.targetPath]){let t;t="localRotation"===l.targetPath.substring(l.targetPath.length-13)?yp.TYPE_QUAT:yp.TYPE_VEC3,s.animComponent.targets[l.targetPath]=new yp(s.animComponent,t)}s.animComponent.targets[l.targetPath].layerCounter++,s.animComponent.targets[l.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,a.push(n._results[t]),r.push(c))}}this._clips.push(t),this._inputs.push(a),this._outputs.push(r)}removeClip(t){const e=this._targets,s=this._binder,i=this._clips,n=i[t].track.curves;for(let t=0;t<n.length;++t){const i=n[t].paths;for(let t=0;t<i.length;++t){const n=i[t],a=this._binder.resolve(n);a&&(a.curves--,0===a.curves&&(s.unresolve(n),delete e[a.targetPath],s.animComponent&&s.animComponent.targets[a.targetPath].layerCounter--))}}i.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}findClip(t){const e=this._clips;for(let s=0;s<e.length;++s){const i=e[s];if(i.name===t)return i}return null}rebind(){this._binder.rebind(),this._targets={};const t=[...this.clips];this.removeClips(),t.forEach((t=>{this.addClip(t)}))}assignMask(t){return this._binder.assignMask(t)}update(t){const e=this._clips,s=e.map((function(t,e){return e}));vp._stableSort(s,(function(t,s){return e[t].blendOrder<e[s].blendOrder}));for(let i=0;i<s.length;++i){const n=s[i],a=e[n],r=this._inputs[n],o=this._outputs[n],h=a.blendWeight;let l,c,d;if(h>0&&a._update(t),h>=1)for(let t=0;t<r.length;++t)l=r[t],c=o[t],d=c.value,vp._set(d,l,c.target.type),c.blendCounter++;else if(h>0)for(let t=0;t<r.length;++t)l=r[t],c=o[t],d=c.value,0===c.blendCounter?vp._set(d,l,c.target.type):vp._blend(d,l,h,c.target.type),c.blendCounter++}const i=this._targets,n=this._binder;for(const t in i)if(i.hasOwnProperty(t)){const e=i[t];if(n.animComponent&&e.target.isTransform){const s=n.animComponent.targets[t];s.counter===s.layerCounter&&(s.counter=0),s.updateValue(n.layerIndex,e.value),e.target.func(s.value),s.counter++}else e.target.func(e.value);e.blendCounter=0}n.update(t)}}class xp{constructor(t,e,s,i){this._func=t,this._type=e,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}get func(){return this._func}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class bp{constructor(t){this._events=[...t],this._events.sort(((t,e)=>t.time-e.time))}get events(){return this._events}}class Sp{constructor(t,e,s,i,n,a=new bp([])){this._name=t,this._duration=e,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=a}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}get events(){return this._animEvents.events}set events(t){this._animEvents=t}eval(t,e){e._time=t;const s=this._inputs,i=this._outputs,n=this._curves,a=e._cache,r=e._results;for(let e=0;e<s.length;++e)a[e].update(t,s[e]._data);for(let t=0;t<n.length;++t){const e=n[t],s=i[e._output],o=r[t];a[e._input].eval(o,e._interpolation,s)}}}class wp{constructor(t){if(this._isPathInMask=(t,e)=>{const s=this._mask[t];return!!s&&!!(s.children||e&&!1!==s.value)},this.graph=t,!t)return;this._mask=null;const e={};!function t(s){e[s.name]=s;for(let e=0;e<s.children.length;++e)t(s.children[e])}(t),this.nodes=e,this.targetCache={};const s=function(t){let e,s=t;for(;s&&!(s instanceof ld);)s=s.parent;return s&&(s.render?e=s.render.meshInstances:s.model&&(e=s.model.meshInstances)),e};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(t){const e=t.localPosition;return wp.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localPosition")},localRotation:function(t){const e=t.localRotation;return wp.createAnimTarget((function(t){e.set(...t)}),"quaternion",4,t,"localRotation")},localScale:function(t){const e=t.localScale;return wp.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localScale")},weights:function(t){const e=s(t);if(e){const s=[];for(let i=0;i<e.length;++i)e[i].node.name===t.name&&e[i].morphInstance&&s.push(e[i].morphInstance);if(s.length>0){const e=function(t){for(let e=0;e<t.length;++e)for(let i=0;i<s.length;i++)s[i].setWeight(e,t[e])};return wp.createAnimTarget(e,"vector",s[0].morph._targets.length,t,"weights")}}return null},materialTexture:(t,e)=>{const i=s(t);if(i){let s;for(let e=0;e<i.length;++e)if(i[e].node.name===t.name){s=i[e];break}if(s){const i=t=>{const i=this.animComponent.system.app.assets.get(t[0]);i&&i.resource&&"texture"===i.type&&(s.material[e]=i.resource,s.material.update())};return wp.createAnimTarget(i,"vector",1,t,"materialTexture","material")}}return null}}}_isPathActive(t){if(!this._mask)return!0;const e=[t.entityPath[0],this.graph.name];for(let s=0;s<e.length;++s){let i=e[s];if(this._isPathInMask(i,1===t.entityPath.length))return!0;for(let e=1;e<t.entityPath.length;e++)if(i+="/"+t.entityPath[e],this._isPathInMask(i,e===t.entityPath.length-1))return!0}return!1}findNode(t){if(!this._isPathActive(t))return null;let e;return this.graph&&(e=this.graph.findByPath(t.entityPath)),e||(e=this.nodes[t.entityPath[t.entityPath.length-1]||""]),e}static createAnimTarget(t,e,s,i,n,a){const r=Wu.encode(i.path,a||"entity",n);return new xp(t,e,s,r)}resolve(t){const e=Wu.encode(t.entityPath,t.component,t.propertyPath);let s=this.targetCache[e];if(s)return s;const i=this.findNode(t);if(!i)return null;const n=this.handlers[t.propertyPath];return n?(s=n(i),s?(this.targetCache[e]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null):null}unresolve(t){if("graph"!==t.component)return;const e=this.nodes[t.entityPath[t.entityPath.length-1]||""];if(this.nodeCounts[e.path]--,0===this.nodeCounts[e.path]){const t=this.activeNodes,s=t.indexOf(e.node),i=t.length;s<i-1&&(t[s]=t[i-1]),t.pop()}}update(t){const e=this.activeNodes;for(let t=0;t<e.length;++t)e[t]._dirtifyLocal()}assignMask(t){return t!==this._mask&&(this._mask=t,!0)}}class Mp{constructor(t,e,s,i,n=1){this._state=t,this._parent=e,this._name=s,Array.isArray(i)?(this._point=new st(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}set weight(t){this._weight=t}get normalizedWeight(){const t=this._state.totalWeight;return 0===t?0:this.weight/t}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}get weightedSpeed(){return this._weightedSpeed}set weightedSpeed(t){this._weightedSpeed=t}get animTrack(){return this._animTrack}set animTrack(t){this._animTrack=t}}class Tp extends Mp{constructor(t,e,s,i,n,a,r,o,h){super(t,e,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=h,this._syncAnimations=!1!==r,this._pointCache={};for(let e=0;e<a.length;e++){const i=a[e];i.children?this._children.push(o(i.type,this,null,s,1,i.parameter?[i.parameter]:i.parameters,i.children,o,h)):this._children.push(new Mp(t,this,i.name,i.point,i.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(t){for(let e=0;e<this._children.length;e++)if(this._children[e].name===t)return this._children[e];return null}updateParameterValues(){let t=!0;for(let e=0;e<this._parameterValues.length;e++){const s=this._findParameter(this._parameters[e]).value;this._parameterValues[e]!==s&&(this._parameterValues[e]=s,t=!1)}return t}getNodeWeightedDuration(t){return this._children[t].animTrack.duration/this._children[t].speedMultiplier*this._children[t].weight}getNodeCount(){let t=0;for(let e=0;e<this._children.length;e++){this._children[e].constructor===Tp?t+=this._children[e].getNodeCount():t++}return t}}class Ap extends Tp{constructor(t,e,s,i,n,a,r,o,h){a.sort(((t,e)=>t.point-e.point)),super(t,e,s,i,n,a,r,o,h)}calculateWeights(){if(this.updateParameterValues())return;let t=0;this._children[0].weight=0;for(let e=0;e<this._children.length;e++){const s=this._children[e];if(e!==this._children.length-1){const t=this._children[e+1];if(s.point===t.point)s.weight=.5,t.weight=.5;else if(V.between(this._parameterValues[0],s.point,t.point,!0)){const e=Math.abs(s.point-t.point),i=(e-Math.abs(s.point-this._parameterValues[0]))/e;s.weight=i,t.weight=1-i}else t.weight=0}this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let e=0;e<this._children.length;e++){const s=this._children[e];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t}}}class Cp extends Tp{pointDistanceCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=this._children[e].point.clone().sub(this._children[t].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;Cp._p.set(...this._parameterValues),t=0,e=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;Cp._pip.set(Cp._p.x,Cp._p.y).sub(n);let a=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(s===t)continue;const e=this.pointDistanceCache(s,t),i=V.clamp(1-Cp._pip.dot(e)/e.lengthSq(),0,1);i<a&&(a=i)}i.weight=a,t+=a,this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}Cp._p=new st,Cp._pip=new st;class Pp extends Tp{pointCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=new st((this._children[e].pointLength-this._children[t].pointLength)/((this._children[e].pointLength+this._children[t].pointLength)/2),2*st.angleRad(this._children[t].point,this._children[e].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;Pp._p.set(...this._parameterValues);const s=Pp._p.length();t=0,e=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],a=n.point,r=n.pointLength;let o=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(i===t)continue;const e=this.pointCache(i,t),n=this._children[t].pointLength;Pp._pip.set((s-r)/((n+r)/2),2*st.angleRad(a,Pp._p));const h=V.clamp(1-Math.abs(Pp._pip.dot(e)/e.lengthSq()),0,1);h<o&&(o=h)}n.weight=o,t+=o,this._syncAnimations&&(e+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i.weight=i._weight/t,this._syncAnimations){const s=i.animTrack.duration/e*t;i.weightedSpeed=i.absoluteSpeed*s}}}}Pp._p=new st,Pp._pip=new st;class Rp extends Tp{calculateWeights(){if(this.updateParameterValues())return;let t=0,e=0;for(let s=0;s<this._children.length;s++)if(t+=Math.max(this._parameterValues[s],0),this._syncAnimations){const t=this._children[s];e+=t.animTrack.duration/t.absoluteSpeed*t.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=Math.max(this._parameterValues[s],0)/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}class Ep{constructor(t,e,s,i,n){this._controller=t,this._name=e,this._animations={},this._animationList=[],this._speed=s||1,this._loop=void 0===i||i;const a=this._controller.findParameter.bind(this._controller);this._blendTree=n?this._createTree(n.type,this,null,e,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,a):new Mp(this,null,e,1,s)}_createTree(t,e,s,i,n,a,r,o,h,l){switch(t){case lp:return new Ap(e,s,i,n,a,r,o,h,l);case dp:return new Cp(e,s,i,n,a,r,o,h,l);case cp:return new Pp(e,s,i,n,a,r,o,h,l);case up:return new Rp(e,s,i,n,a,r,o,h,l)}}_getNodeFromPath(t){let e=this._blendTree;for(let s=1;s<t.length;s++)e=e.getChild(t[s]);return e}addAnimation(t,e){const s=t.join("."),i=this._animationList.findIndex((function(t){return t.path===s}));if(i>=0)this._animationList[i].animTrack=e;else{const s=this._getNodeFromPath(t);s.animTrack=e,this._animationList.push(s)}}get name(){return this._name}get animations(){return this._animationList}set animations(t){this._animationList=t}get speed(){return this._speed}set speed(t){this._speed=t}get loop(){return this._loop}set loop(t){this._loop=t}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==Mp?this._blendTree.getNodeCount():1}get playable(){return-1!==_p.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const t=this.name+"."+this.animations[0].animTrack.name,e=this._controller.animEvaluator.findClip(t);if(e)return e.loop}return!1}get totalWeight(){let t=0;for(let e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}get timelineDuration(){let t=0;for(let e=0;e<this.animations.length;e++){const s=this.animations[e];s.animTrack.duration>t&&(t=s.animTrack.duration)}return t}}class Lp{constructor({from:t,to:e,time:s=0,priority:i=0,conditions:n=[],exitTime:a=null,transitionOffset:r=null,interruptionSource:o=Yu}){this._from=t,this._to=e,this._time=s,this._priority=i,this._conditions=n,this._exitTime=a,this._transitionOffset=r,this._interruptionSource=o}get from(){return this._from}get to(){return this._to}set to(t){this._to=t}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class Ip{constructor(t,e,s,i,n,a,r){this._animEvaluator=t,this._states={},this._stateNames=[],this._eventHandler=a,this._consumedTriggers=r;for(let t=0;t<e.length;t++)this._states[e[t].name]=new Ep(this,e[t].name,e[t].speed,e[t].loop,e[t].blendTree),this._stateNames.push(e[t].name);this._transitions=s.map((t=>new Lp(U({},t)))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=i,this._previousStateName=null,this._activeStateName=pp,this._playing=!1,this._activate=n,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=Yu,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}get activeState(){return this._findState(this._activeStateName)}set activeState(t){this._activeStateName=t}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}get previousState(){return this._findState(this._previousStateName)}set previousState(t){this._previousStateName=t}get previousStateName(){return this._previousStateName}get playable(){let t=!0;for(let e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}get playing(){return this._playing}set playing(t){this._playing=t}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this.activeStateName===pp||this.activeStateName===mp)return 0;let t=0;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this._animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(t=Math.max(t,s.track.duration))}return t}get activeStateCurrentTime(){return this._timeInState}set activeStateCurrentTime(t){this._timeInStateBefore=t,this._timeInState=t;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this.animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(s.time=t)}}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(t){return this._animEvaluator.assignMask(t)}_findState(t){return this._states[t]}_getActiveStateProgressForTime(t){if(this.activeStateName===pp||this.activeStateName===mp||this.activeStateName===fp)return 1;const e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?t/e.track.duration:null}_findTransitionsFromState(t){let e=this._findTransitionsFromStateCache[t];return e||(e=this._transitions.filter((function(e){return e.from===t})),e.sort((function(t,e){return t.priority<e.priority})),this._findTransitionsFromStateCache[t]=e),e}_findTransitionsBetweenStates(t,e){let s=this._findTransitionsBetweenStatesCache[t+"->"+e];return s||(s=this._transitions.filter((function(s){return s.from===t&&s.to===e})),s.sort((function(t,e){return t.priority<e.priority})),this._findTransitionsBetweenStatesCache[t+"->"+e]=s),s}_transitionHasConditionsMet(t){let e=!0;for(let s=0;s<t.conditions.length;s++){const i=t.conditions[s],n=this.findParameter(i.parameterName);switch(i.predicate){case Qu:e=e&&n.value>i.value;break;case tp:e=e&&n.value<i.value;break;case ep:e=e&&n.value>=i.value;break;case sp:e=e&&n.value<=i.value;break;case ip:e=e&&n.value===i.value;break;case np:e=e&&n.value!==i.value}if(!e)return e}return e}_findTransition(t,e){let s=[];if(t&&e)s.concat(this._findTransitionsBetweenStates(t,e));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case Ku:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(fp));break;case $u:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(fp));break;case Zu:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(fp));break;case Ju:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(fp))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(fp));if(s=s.filter((t=>{if(t.to===this.activeStateName)return!1;if(t.hasExitTime){let e=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(t.exitTime<1&&this.activeState.loop&&(e-=Math.floor(e),s-=Math.floor(s)),!(t.exitTime>e&&t.exitTime<=s))return null}return this._transitionHasConditionsMet(t)})),s.length>0){const t=s[0];if(t.to===mp){const e=this._findTransitionsFromState(pp)[0];t.to=e.to}return t}return null}updateStateFromTransition(t){let e,s,i;this.previousState=t.from?this.activeStateName:null,this.activeState=t.to;for(let e=0;e<t.conditions.length;e++){const s=t.conditions[e];this.findParameter(s.parameterName).type===hp&&this._consumedTriggers.add(s.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const t=Math.min(this._currTransitionTime/this._totalTransitionTime,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-t:this._transitionPreviousStates[n].weight=t:this._transitionPreviousStates[n].weight=1,e=this._findState(this._transitionPreviousStates[n].name);for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name+".previous."+n),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+n),n!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource;const n=this.activeState,a=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1;let r=0,o=0;if(a){const e=n.timelineDuration*t.transitionOffset;r=e,o=e}this._timeInState=r,this._timeInStateBefore=o;for(let e=0;e<n.animations.length;e++){if(i=this._animEvaluator.findClip(n.animations[e].name),i)i.reset();else{const t=Number.isFinite(n.animations[e].speed)?n.animations[e].speed:n.speed;i=new ju(n.animations[e].animTrack,this._timeInState,t,!0,n.loop,this._eventHandler),i.name=n.animations[e].name,this._animEvaluator.addClip(i)}if(t.time>0?i.blendWeight=0:i.blendWeight=n.animations[e].normalizedWeight,i.play(),a)i.time=n.timelineDuration*t.transitionOffset;else{const t=n.speed>=0?0:this.activeStateDuration;i.time=t}}}_transitionToState(t){if(!this._findState(t))return;let e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new Lp({from:null,to:t})),this.updateStateFromTransition(e)}assignAnimation(t,e,s,i){const n=t.split(".");let a=this._findState(n[0]);a||(a=new Ep(this,n[0],1),this._states[n[0]]=a,this._stateNames.push(n[0])),a.addAnimation(n,e),void 0!==s&&(a.speed=s),void 0!==i&&(a.loop=i),!this._playing&&this._activate&&this.playable&&this.play()}removeNodeAnimations(t){if(-1!==_p.indexOf(t))return;const e=this._findState(t);return e?(e.animations=[],!0):void 0}play(t){t&&this._transitionToState(t),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=pp,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(t){if(!this._playing)return;let e,s,i;this._timeInStateBefore=this._timeInState,this._timeInState+=t;const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=t,this._currTransitionTime<=this._totalTransitionTime){const t=0===this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){e=this._findState(this._transitionPreviousStates[n].name);const a=this._transitionPreviousStates[n].weight;for(let r=0;r<e.animations.length;r++)s=e.animations[r],i=this._animEvaluator.findClip(s.name+".previous."+n),i&&(i.blendWeight=(1-t)*s.normalizedWeight*a)}e=this.activeState;for(let i=0;i<e.animations.length;i++)s=e.animations[i],this._animEvaluator.findClip(s.name).blendWeight=t*s.normalizedWeight}else{this._isTransitioning=!1;const t=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let e=0;e<n-t;e++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==Mp){e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(t)}findParameter(t){return this._parameters[t]}}class Dp{constructor(t){if(this._layers=[],this._parameters={},Array.isArray(t.layers))this._layers=t.layers;else for(const e in t.layers){const s=t.layers[e],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let e=0;e<s.states.length;e++)i.states.push(t.states[s.states[e]]);for(let e=0;e<s.transitions.length;e++){const n=t.transitions[s.transitions[e]];if(n.conditions&&!Array.isArray(n.conditions)){const t=Object.keys(n.conditions),e=[];for(let s=0;s<t.length;s++){const i=n.conditions[t[s]];i.parameterName&&e.push(i)}n.conditions=e}Number.isInteger(n.from)&&(n.from=t.states[n.from].name),Number.isInteger(n.to)&&(n.to=t.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const e in t.parameters){const s=t.parameters[e];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}const Fp="msdf",Op="bitmap";class kp{constructor(t,e){this.type=e&&e.type||Fp,this.em=1,this.textures=t,this.intensity=0,this._data=null,this.data=e}get data(){return this._data}set data(t){if(this._data=t,t&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const t in this._data.chars)this._data.chars[t].map=0}}const Bp="linear",zp="inverse",Up="exponential";function Vp(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}class Np{constructor(t,e,s={}){if(this.volume=void 0===s.volume?1:s.volume,this.loop=void 0!==s.loop&&s.loop,this.pitch=void 0===s.pitch?1:s.pitch,this.sound=e,this.paused=!1,this.suspended=!1,this.manager=t,this.source=null,Vp()){this.startTime=0,this.startOffset=0;const e=t.context;this.gain=e.createGain()}else e.audio&&(this.source=e.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(t){this.loop=t,this.source&&(this.source.loop=t)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}}Vp()?Object.assign(Np.prototype,{play:function(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){!this.source&&this.paused?(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)):console.warn("Call pause() before unpausing.")},stop:function(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(t){t=V.clamp(t,0,1),this.volume=t,this.gain&&(this.gain.gain.value=t*this.manager.volume)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate.value=t)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){const t=this.manager.context;this.sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}):Object.assign(Np.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(t){t=V.clamp(t,0,1),this.volume=t,this.source&&(this.source.volume=t*this.manager.volume)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate=t)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});class Wp extends Np{constructor(t,e,s){super(t,e,s),this.position=new it,this.velocity=new it,Vp()?this.panner=t.context.createPanner():(this.maxDistance=1e4,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=zp)}getPosition(){return this.position}getVelocity(){return this.velocity}}if(Vp())Object.assign(Wp.prototype,{setPosition:function(t){this.position.copy(t),this.panner.setPosition(t.x,t.y,t.z)},setVelocity:function(t){this.velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(t){this.panner.maxDistance=t},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(t){this.panner.refDistance=t},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(t){this.panner.rolloffFactor=t},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(t){this.panner.distanceModel=t},_createSource:function(){const t=this.manager.context;this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this))}});else{let t=new it;const e=function(e,s,i,n,a,r){t=t.sub2(e,s);const o=t.length();if(o<i)return 1;if(o>n)return 0;let h=0;return r===Bp?h=1-a*(o-i)/(n-i):r===zp?h=i/(i+a*(o-i)):r===Up&&(h=Math.pow(o/i,-a)),V.clamp(h,0,1)};Object.assign(Wp.prototype,{setPosition:function(t){if(this.position.copy(t),this.source){const t=this.manager.listener.getPosition(),s=e(t,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.getVolume();this.source.volume=i*s}},setVelocity:function(t){this.velocity.copy(t)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}class Gp{constructor(t){this._manager=t,this.position=new it,this.velocity=new it,this.orientation=new dt}getPosition(){return this.position}setPosition(t){this.position.copy(t);const e=this.listener;e&&e.setPosition(t.x,t.y,t.z)}getVelocity(){return this.velocity}setVelocity(t){this.velocity.copy(t);const e=this.listener;e&&e.setPosition(t.x,t.y,t.z)}setOrientation(t){this.orientation.copy(t);const e=this.listener;e&&e.setOrientation(-t.data[8],-t.data[9],-t.data[10],t.data[4],t.data[5],t.data[6])}getOrientation(){return this.orientation}get listener(){const t=this._manager.context;return t?t.listener:null}}class Hp extends u{constructor(t){super(),this._context=null,this._forceWebAudioApi=t.forceWebAudioApi,this._resumeContext=null,this._unlock=null,Vp()||this._forceWebAudioApi?(this._resumeContext=()=>{e.polyfill.window.removeEventListener("mousedown",this._resumeContext),e.polyfill.window.removeEventListener("touchend",this._resumeContext),this.context&&this.context.resume()},e.polyfill.window.addEventListener("mousedown",this._resumeContext),e.polyfill.window.addEventListener("touchend",this._resumeContext),C.ios&&(this._unlock=()=>{e.polyfill.window.removeEventListener("touchend",this._unlock);const t=this.context;if(t){const e=t.createBuffer(1,1,44100),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect()}},e.polyfill.window.addEventListener("touchend",this._unlock))):console.warn("No support for 3D audio found"),this.listener=new Gp(this),this._volume=1,this.suspended=!1}suspend(){this.suspended=!0,this.fire("suspend")}resume(){const t=()=>{this.suspended=!1,this.fire("resume")};!Vp()&&!this._forceWebAudioApi||"interrupted"!==this.context.state&&"suspended"!==this.context.state?t():this.context.resume().then(t)}destroy(){this._resumeContext&&(e.polyfill.window.removeEventListener("mousedown",this._resumeContext),e.polyfill.window.removeEventListener("touchend",this._resumeContext)),this._unlock&&e.polyfill.window.removeEventListener("touchend",this._unlock),this.fire("destroy"),this._context&&this._context.close&&(this._context.close(),this._context=null)}playSound(t,e={}){let s=null;return Np&&(s=new Np(this,t,e),s.play()),s}playSound3d(t,e,s={}){let i=null;return Wp&&(i=new Wp(this,t,s),i.setPosition(e),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}get volume(){return this._volume}set volume(t){t=V.clamp(t,0,1),this._volume=t,this.fire("volumechange",t)}get context(){return this._context||(this._context=wx.createWebAudioContext(),(Vp()||this._forceWebAudioApi)&&("undefined"!=typeof AudioContext?this._context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this._context=new webkitAudioContext))),this._context}}class jp{constructor(t){this.buffer=t}get duration(){let t=0;return this.buffer?t=this.buffer.duration:this.audio&&(t=this.audio.duration),t||0}}function qp(t,e){return t>e?e:t%e||0}class Xp extends u{constructor(t,e,s){super(),this._manager=t,this._volume=void 0!==s.volume?V.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._sound=e,this._state=2,this._suspended=!1,this._suspendEndEvent=!1,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this.source=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,Vp()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}get loop(){return this._loop}set loop(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}get startTime(){return this._startTime}set startTime(t){this._startTime=Math.max(0,Number(t)||0);const e=0===this._state;this.stop(),e&&this.play()}get duration(){return this._sound?this._duration?qp(this._duration,this._sound.duration):this._sound.duration:0}set duration(t){this._duration=Math.max(0,Number(t)||0);const e=0===this._state;this.stop(),e&&this.play()}get isPlaying(){return 0===this._state}get isPaused(){return 1===this._state}get isStopped(){return 2===this._state}get isSuspended(){return this._suspended}}Vp()?(Object.assign(Xp.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop(),this.source||this._createSource();let t=qp(this._startOffset,this.duration);return t=qp(this._startTime+t,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=t,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function(){return this._playWhenLoaded=!1,!(0!==this._state||!this.source)&&(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();let t=this.currentTime;return null!==this._startOffset&&(t=qp(this._startOffset,this.duration),t=qp(this._startTime+t,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=t,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function(){return this._playWhenLoaded=!1,!(2===this._state||!this.source)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(t,e){if(!t)return void console.error("The firstNode must be a valid Audio Node");e||(e=t);const s=this._manager.context.destination;this._firstNode!==t&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=t,this._connectorNode.connect(t)),this._lastNode!==e&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=e,this._lastNode.connect(s))},clearExternalNodes:function(){const t=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(t),this._lastNode=null),this._connectorNode.connect(t)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;const t=this._manager.context;return this._sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=qp(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,qp(this._startTime+this._duration,this.source.buffer.duration)))),this.source},_updateCurrentTime:function(){this._currentTime=qp((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(Xp.prototype,"volume",{get:function(){return this._volume},set:function(t){t=V.clamp(t,0,1),this._volume=t,this.gain&&(this.gain.gain.value=t*this._manager.volume)}}),Object.defineProperty(Xp.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(Xp.prototype,"sound",{get:function(){return this._sound},set:function(t){this._sound=t,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(Xp.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(t){if(!(t<0))if(0===this._state){const e=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=t,this.play(),this._suspendInstanceEvents=e}else this._startOffset=t,this._currentTime=t}})):(Object.assign(Xp.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let t=qp(this._startOffset,this.duration);t=qp(this._startTime+t,this._sound.duration),this._startOffset=null,this.source.currentTime=t},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>qp(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=qp(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(Xp.prototype,"volume",{get:function(){return this._volume},set:function(t){t=V.clamp(t,0,1),this._volume=t,this.source&&(this.source.volume=t*this._manager.volume)}}),Object.defineProperty(Xp.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(Xp.prototype,"sound",{get:function(){return this._sound},set:function(t){this.stop(),this._sound=t}}),Object.defineProperty(Xp.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(t){t<0||(this._startOffset=t,this.source&&this._isReady&&(this.source.currentTime=qp(this._startTime+qp(t,this.duration),this._sound.duration),this._startOffset=null))}}));class Yp extends Xp{constructor(t,e,s){super(t,e,s),s=s||{},this._position=new it,s.position&&(this.position=s.position),this._velocity=new it,s.velocity&&(this.velocity=s.velocity),this.maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this.refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this.rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this.distanceModel=void 0!==s.distanceModel?s.distanceModel:Bp}}if(Vp())Object.assign(Yp.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(Yp.prototype,"position",{get:function(){return this._position},set:function(t){this._position.copy(t),this.panner.setPosition(t.x,t.y,t.z)}}),Object.defineProperty(Yp.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)}}),Object.defineProperty(Yp.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(t){this.panner.maxDistance=t}}),Object.defineProperty(Yp.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(t){this.panner.refDistance=t}}),Object.defineProperty(Yp.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(t){this.panner.rolloffFactor=t}}),Object.defineProperty(Yp.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(t){this.panner.distanceModel=t}});else{let t=new it;const e=function(e,s,i,n,a,r){t=t.sub2(e,s);const o=t.length();if(o<i)return 1;if(o>n)return 0;let h=0;return r===Bp?h=1-a*(o-i)/(n-i):r===zp?h=i/(i+a*(o-i)):r===Up&&(h=Math.pow(o/i,-a)),V.clamp(h,0,1)};Object.defineProperty(Yp.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){const t=this._manager.listener.getPosition(),s=e(t,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.volume;this.source.volume=i*s*this._manager.volume}}}),Object.defineProperty(Yp.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t)}}),Object.defineProperty(Yp.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(Yp.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(Yp.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(Yp.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}class Kp{constructor(t){this._blobUrls={};for(let e=0,s=t.length;e<s;e++)t[e].url&&(this._blobUrls[t[e].name]=t[e].url)}hasBlobUrl(t){return!!this._blobUrls[t]}getBlobUrl(t){return this._blobUrls[t]}destroy(){for(const t in this._blobUrls)e.polyfill.URL.revokeObjectURL(this._blobUrls[t]);this._blobUrls=null}}class $p{constructor(t){this._assets=t,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}_onAssetAdded(t){if("bundle"===t.type){this._bundleAssets[t.id]=t,this._registerBundleEventListeners(t.id);for(let e=0,s=t.data.assets.length;e<s;e++)this._indexAssetInBundle(t.data.assets[e],t)}else this._assetsInBundles[t.id]&&this._indexAssetFileUrls(t)}_registerBundleEventListeners(t){this._assets.on("load:"+t,this._onBundleLoaded,this),this._assets.on("error:"+t,this._onBundleError,this)}_unregisterBundleEventListeners(t){this._assets.off("load:"+t,this._onBundleLoaded,this),this._assets.off("error:"+t,this._onBundleError,this)}_indexAssetInBundle(t,e){if(this._assetsInBundles[t]){const s=this._assetsInBundles[t];-1===s.indexOf(e)&&s.push(e)}else this._assetsInBundles[t]=[e];const s=this._assets.get(t);s&&this._indexAssetFileUrls(s)}_indexAssetFileUrls(t){const e=this._getAssetFileUrls(t);if(e)for(let s=0,i=e.length;s<i;s++){const i=e[s];this._urlsInBundles[i]=this._assetsInBundles[t.id]}}_getAssetFileUrls(t){let e=t.getFileUrl();if(!e)return null;e=this._normalizeUrl(e);const s=[e];if("font"===t.type){const i=t.data.info.maps.length;for(let t=1;t<i;t++)s.push(e.replace(".png",t+".png"))}return s}_normalizeUrl(t){return t&&t.split("?")[0]}_onAssetRemoved(t){if("bundle"===t.type){delete this._bundleAssets[t.id],this._unregisterBundleEventListeners(t.id);for(const e in this._assetsInBundles){const s=this._assetsInBundles[e],i=s.indexOf(t);if(-1!==i&&(s.splice(i,1),!s.length)){delete this._assetsInBundles[e];for(const t in this._urlsInBundles)this._urlsInBundles[t]===s&&delete this._urlsInBundles[t]}}this._onBundleError(`Bundle ${t.id} was removed`,t)}else if(this._assetsInBundles[t.id]){delete this._assetsInBundles[t.id];const e=this._getAssetFileUrls(t);for(let t=0,s=e.length;t<s;t++)delete this._urlsInBundles[e[t]]}}_onBundleLoaded(t){t.resource?e.polyfill.requestAnimationFrame((()=>{if(this._fileRequests)for(const e in this._fileRequests){const s=this._urlsInBundles[e];if(!s||-1===s.indexOf(t))continue;const i=decodeURIComponent(e);let n=null;t.resource.hasBlobUrl(i)||(n=`Bundle ${t.id} does not contain URL ${e}`);const a=this._fileRequests[e];for(let e=0,s=a.length;e<s;e++)n?a[e](n):a[e](null,t.resource.getBlobUrl(i));delete this._fileRequests[e]}})):this._onBundleError(`Bundle ${t.id} failed to load`,t)}_onBundleError(t,e){for(const e in this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(e)){const s=this._fileRequests[e];for(let e=0,i=s.length;e<i;e++)s[e](t);delete this._fileRequests[e]}}}_findLoadedOrLoadingBundleForUrl(t){const e=this._urlsInBundles[t];if(!e)return null;const s=e.length;for(let t=0;t<s;t++)if(e[t].loaded&&e[t].resource)return e[t];for(let t=0;t<s;t++)if(e[t].loading)return e[t];return null}listBundlesForAsset(t){return this._assetsInBundles[t.id]||null}list(){const t=[];for(const e in this._bundleAssets)t.push(this._bundleAssets[e]);return t}hasUrl(t){return!!this._urlsInBundles[t]}canLoadUrl(t){return!!this._findLoadedOrLoadingBundleForUrl(t)}loadUrl(t,e){const s=this._findLoadedOrLoadingBundleForUrl(t);if(s)if(s.loaded){const i=decodeURIComponent(t);if(!s.resource.hasBlobUrl(i))return void e(`Bundle ${s.id} does not contain URL ${t}`);e(null,s.resource.getBlobUrl(i))}else this._fileRequests.hasOwnProperty(t)?this._fileRequests[t].push(e):this._fileRequests[t]=[e];else e(`URL ${t} not found in any bundles`)}destroy(){this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this);for(const t in this._bundleAssets)this._unregisterBundleEventListeners(t);this._assets=null,this._bundleAssets=null,this._assetsInBundles=null,this._urlsInBundles=null,this._fileRequests=null}}function Zp(){const t=0,s=1,i=2,n=3,a=8,r=9,o=10,h=11,l=12,c=13,d=14,u=16,p={astc:o,dxt:i,etc1:t,etc2:t,pvr:a,atc:h,none:d},m={astc:o,dxt:n,etc1:u,etc2:s,pvr:r,atc:l,none:u},f=21,_=22,g=23,y=8,v=10,x=26,b=27,S=28,w=29,M=30,T=7,A=3,C=5,P=(e,p)=>{switch(e){case t:return p.formats.etc1?f:_;case s:return g;case i:return y;case n:return v;case a:return x;case r:return b;case o:return S;case h:return w;case l:return M;case c:return T;case d:return A;case u:return C}},R=t=>{const e=function(t,e){const s=t*(2/255)-1,i=e*(2/255)-1,n=Math.sqrt(1-Math.min(1,s*s+i*i));return Math.max(0,Math.min(255,Math.floor(.5*(n+1)*255)))};for(let s=0;s<t.length;s+=4){const i=t[s+3],n=t[s+1];t[s+0]=i,t[s+2]=e(i,n),t[s+3]=255}return t},E=t=>{const e=new Uint16Array(t.length/4);for(let s=0;s<t.length;s+=4){const i=t[s+0],n=t[s+1],a=t[s+2];e[s/4]=(248&i)<<8|(252&n)<<3|a>>3}return e},L=()=>void 0!==e.polyfill.performance?e.polyfill.performance.now():0;let I,D,F;const O=(t,e,s)=>{if(s){if(t.formats.astc)return"astc"}else if(e){if(t.formats.etc2)return"etc2"}else if(t.formats.etc1||t.formats.etc2)return"etc1";return(e=>{for(let s=0;s<e.length;++s){const i=e[s];if(t.formats[i])return i}return"none"})(e?F:D)},k=(e,c,d,u)=>{switch(d){case t:case s:return!0;case i:case n:return 0==(3&e)&&0==(3&c);case a:case r:return((t,e)=>0==(t&t-1)&&0==(e&e-1))(e,c)&&(e===c||u);case o:case h:case l:return!0}},B=(t,e,s)=>s.isKTX2?((t,e,s)=>{if(!I.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const i=L(),n=new I.KTX2File(new Uint8Array(e)),a=n.getWidth(),r=n.getHeight(),o=n.getLevels(),h=!!n.getHasAlpha(),l=n.isUASTC&&n.isUASTC();if(!a||!r||!o)throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${a} height=${r} levels=${o}`);const f=O(s.deviceDetails,h,l),_=!!s.isGGGR&&"pvr"===f;let g,y;if(_?g=c:(g=h?m[f]:p[f],k(a,r,g,s.deviceDetails.webgl2)||(g=h?c:d)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);const v=[];for(let e=0;e<o;++e){const s=n.getImageTranscodedSizeInBytes(e,0,0,g),i=new Uint8Array(s);if(!n.transcodeImage(i,e,0,0,g,0,-1,-1))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);const a=g===d||g===u;v.push(a?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),_)for(g=d,y=0;y<v.length;++y)v[y]=E(R(v[y]));return{format:P(g,s.deviceDetails),width:a,height:r,levels:v,cubemap:!1,transcodeTime:L()-i,url:t,unswizzledGGGR:_}})(t,e,s):((t,e,s)=>{const i=L(),n=new I.BasisFile(new Uint8Array(e)),a=n.getImageWidth(0,0),r=n.getImageHeight(0,0),o=n.getNumImages(),h=n.getNumLevels(0),l=!!n.getHasAlpha(),f=n.isUASTC&&n.isUASTC();if(!(a&&r&&o&&h))throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${a} height=${r} images=${o} levels=${h}`);const _=O(s.deviceDetails,l,f),g=!!s.isGGGR&&"pvr"===_;let y,v;if(g?y=c:(y=l?m[_]:p[_],k(a,r,y,s.deviceDetails.webgl2)||(y=l?c:d)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);const x=[];for(let e=0;e<h;++e){const s=n.getImageTranscodedSizeInBytes(0,e,y),i=new Uint8Array(s);if(!n.transcodeImage(i,0,e,y,0,0))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);const a=y===d||y===u;x.push(a?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),g)for(y=d,v=0;v<x.length;++v)x[v]=E(R(x[v]));return{format:P(y,s.deviceDetails),width:a,height:r,levels:x,cubemap:!1,transcodeTime:L()-i,url:t,unswizzledGGGR:g}})(t,e,s),z=(t,e,s)=>{try{const i=B(t,e,s);i.levels=i.levels.map((t=>t.buffer)),self.postMessage({url:t,data:i},i.levels)}catch(e){self.postMessage({url:t,err:e},null)}},U=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":((t,e)=>{self.importScripts(t.basisUrl),self.BASIS(t.module?{instantiateWasm:(e,s)=>(WXWebAssembly.instantiate(t.module,e).then((t=>{s(t)})).catch((t=>{console.error("instantiate failed + "+t)})),{})}:null).then((s=>{s.initializeBasis(),I=s,D=t.rgbPriority,F=t.rgbaPriority,e(null)}))})(e.config,(()=>{for(let t=0;t<U.length;++t)z(U[t].url,U[t].data,U[t].options);U.length=0}));break;case"transcode":I?z(e.url,e.data,e.options):U.push(e)}}}const Jp=t=>({astc:!!t.extCompressedTextureASTC,atc:!!t.extCompressedTextureATC,dxt:!!t.extCompressedTextureS3TC,etc1:!!t.extCompressedTextureETC1,etc2:!!t.extCompressedTextureETC,pvr:!!t.extCompressedTexturePVRTC});class Qp{constructor(t,e,s){this.queue=t,this.worker=new Worker(e.workerUrl),this.worker.addEventListener("message",(t=>{const e=t.data;this.queue.handleResponse(e.url,e.err,e.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:e}),this.eager=s}run(t){const e=[];t.data instanceof ArrayBuffer&&e.push(t.data),this.worker.postMessage({type:"transcode",url:t.url,format:t.format,data:t.data,options:t.options},e),this.eager&&this.queue.enqueueClient(this)}}const tm=["etc1","etc2","astc","dxt","pvr","atc"],em=["astc","dxt","etc2","pvr","atc"],sm=new class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(t,e,s,i){if(this.callbacks.hasOwnProperty(t))this.callbacks[t].push(s);else{this.callbacks[t]=[s];const n={url:t,data:e,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(t){this.queue.length>0?t.run(this.queue.shift()):this.clients.push(t)}handleResponse(t,e,s){const i=this.callbacks[t];if(e)for(let t=0;t<i.length;++t)i[t](e);else{s.format===Ci||s.format===Ri?s.levels=s.levels.map((function(t){return new Uint16Array(t)})):s.levels=s.levels.map((function(t){return new Uint8Array(t)}));for(let t=0;t<i.length;++t)i[t](null,s)}delete this.callbacks[t]}};let im=null,nm=!1;function am(t){if(!nm){if(t){if(t.lazyInit)return void(im=t)}else t=im||{};if(!t.glueUrl||!t.wasmUrl||!t.fallbackUrl){const s=((e.polyfill.window.config?e.polyfill.window.config.wasmModules:e.polyfill.window.PRELOAD_MODULES)||[]).find((function(t){return"BASIS"===t.moduleName}));if(s){const i=e.polyfill.window.ASSET_PREFIX||"";t.glueUrl||(t.glueUrl=i+s.glueUrl),t.wasmUrl||(t.wasmUrl=i+s.wasmUrl),t.fallbackUrl||(t.fallbackUrl=i+s.fallbackUrl)}}if(t.glueUrl||t.wasmUrl||t.fallbackUrl){nm=!0;const s=Math.max(1,Math.min(16,t.numWorkers||1)),i=1===t.numWorkers||!t.hasOwnProperty("eagerWorkers")||t.eagerWorkers;t.rgbPriority=t.rgbPriority||tm,t.rgbaPriority=t.rgbaPriority||em,((t,s)=>{const i=()=>{const t="("+Zp.toString()+")()\n\n";return new e.polyfill.Blob([t],{type:"application/javascript"})},n=(n,a)=>{s(null,{workerUrl:e.polyfill.URL.createObjectURL(i()),basisUrl:e.polyfill.URL.createObjectURL(n),module:a,rgbPriority:t.rgbPriority,rgbaPriority:t.rgbaPriority})};if(t.glueUrl&&t.wasmUrl&&(()=>{try{if("object"==typeof WXWebAssembly&&"function"==typeof WXWebAssembly.instantiate&&new WXWebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0))instanceof WXWebAssembly.Module)return new WXWebAssembly.Instance(new WXWXWebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0)))instanceof WXWebAssembly.Instance}catch(t){}return!1})()){let i=null,a=null;j.get(t.glueUrl,{responseType:"blob"}).then((t=>{a?n(t,a):i=t})).catch((t=>{s(t)}));e.polyfill.fetch(t.wasmUrl).then((t=>t.arrayBuffer())).then((t=>WXWebAssembly.compile(t))).then((t=>{i?n(i,t):a=t})).catch((t=>{s(t,null)}))}else j.get(t.fallbackUrl,{responseType:"blob"}).then((t=>{n(t,null)})).catch((t=>{s(t)}))})(t,((t,e)=>{if(t)console.error(`failed to initialize basis worker: ${t}`);else for(let t=0;t<s;++t)sm.enqueueClient(new Qp(sm,e,i))}))}}}let rm=null;function om(t,e,s,i,n){return am(),rm||(rm={webgl2:t.webgl2,formats:Jp(t)}),sm.enqueueJob(e,s,i,{deviceDetails:rm,isGGGR:!(null==n||!n.isGGGR),isKTX2:!(null==n||!n.isKTX2)}),nm}class hm{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=H.ResponseType.JSON),j.get(t.load,s).then((t=>{e(null,t)})).catch((s=>{e("Error loading animation clip resource: "+t.original+" ["+s+"]")}))}open(t,e){const s=e.name,i=e.duration,n=e.inputs.map((function(t){return new Xu(1,t)})),a=e.outputs.map((function(t){return new Xu(t.components,t.data)})),r=e.curves.map((function(t){return new qu([t.path],t.inputIndex,t.outputIndex,t.interpolation)}));return new Sp(s,i,n,a,r)}}class lm{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=H.ResponseType.JSON),j.get(t.load,s).then((t=>{e(null,t)})).catch((s=>{e("Error loading animation state graph resource: "+t.original+" ["+s+"]")}))}open(t,e){return new Dp(e)}}class cm extends u{constructor(){super(),this._meshes=null}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++){const t=this._meshes[e];t&&(t.decRefCount(),t.getRefCount()<1&&(t.destroy(),this._meshes[e]=null))}}}incRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++)this._meshes[e]&&this._meshes[e].incRefCount()}}get meshes(){return this._meshes}set meshes(t){this.decRefMeshes(),this._meshes=t,this.incRefMeshes(),this.fire("set:meshes",t)}destroy(){if(!this._meshes)return;let t=this._meshes;for(let e=0;e<t.length;e++){t[e].destroy()}this.meshes=null}}const dm={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},um={};function pm(t,e){for(let s=0,i=t.length;s<i;s++)um[t[s]]=e}function mm(t){const e=t.indexOf("-");return-1!==e?t.substring(0,e):t}function fm(t,e){if(e[t])return t;let s=dm[t];if(s&&e[s])return s;const i=mm(t);return s=dm[i],e[s]?s:e[i]?i:"en-US"}pm(["ja","ko","th","vi","zh","id"],(function(t){return 0})),pm(["fa","hi"],(function(t){return t>=0&&t<=1?0:1})),pm(["fr","pt"],(function(t){return t>=0&&t<2?0:1})),pm(["da"],(function(t){return 1===t||!Number.isInteger(t)&&t>=0&&t<=1?0:1})),pm(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(function(t){return 1===t?0:1})),pm(["ru","uk"],(function(t){if(Number.isInteger(t)){const e=t%10,s=t%100;if(1===e&&11!==s)return 0;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(0===e||e>=5&&e<=9||s>=11&&s<=14)return 2}return 3})),pm(["pl"],(function(t){if(Number.isInteger(t)){if(1===t)return 0;const e=t%10,s=t%100;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||s>=12&&s<=14)return 2}return 3})),pm(["ar"],(function(t){if(0===t)return 0;if(1===t)return 1;if(2===t)return 2;if(Number.isInteger(t)){const e=t%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5}));const _m=um[mm("en-US")];function gm(t){return um[t]||_m}const ym=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i");class vm{constructor(t,e,s,i,n,a){this.url=t||"",this.filename=e||"",this.hash=void 0===s?null:s,this.size=void 0===i?null:i,this.opt=void 0===n?null:n,this.contents=a||null}equals(t){return this.url===t.url&&this.filename===t.filename&&this.hash===t.hash&&this.size===t.size&&this.opt===t.opt&&this.contents===t.contents}}let xm=-1;const bm={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Sm=["pvr","dxt","etc2","etc1","basis"];class wm extends u{constructor(t,e,s,i,n){super(),this._id=xm--,this.name=t||"",this.type=e,this.tags=new O(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}getFileUrl(){const t=this.file;if(!t||!t.url)return null;let e=t.url;if("script"!==this.type&&t.hash){const s=-1!==e.indexOf("?")?"&":"?";e+=s+"t="+t.hash}return e}getAbsoluteUrl(t){if(t.startsWith("blob:")||t.startsWith("data:"))return t;const e=f.getDirectory(this.file.url);return f.join(e,t)}getLocalizedAssetId(t){return t=fm(t,this._i18n),this._i18n[t]||null}addLocalizedAssetId(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)}removeLocalizedAssetId(t){const e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))}ready(t,e){e=e||this,this.resource?t.call(e,this):this.once("load",(function(s){t.call(e,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const t=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let e=0;e<t.length;++e){const s=t[e];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(t,e,s,i=0){var n;null!=s&&null!=(n=s.file)&&n.contents?setTimeout((()=>{e(null,s.file.contents)}),0):j.get(t,{responseType:"arraybuffer",retry:i>0,maxRetries:i}).then((t=>{e(null,t)})).catch((t=>{e(t)}))}get id(){return this._id}set id(t){this._id=t}get file(){return this._file}set file(t){if(t&&t.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var e,s;const i=(null==(e=this.registry)||null==(s=e._loader)?void 0:s._app)||Fh(),n=null==i?void 0:i.graphicsDevice;if(n)for(let e=0,s=Sm.length;e<s;e++){const s=Sm[e];if(t.variants[s]&&n[bm[s]]){t=t.variants[s];break}if(i.enableBundles){const t=i.bundles.listBundlesForAsset(this);if(t&&t.find((t=>{var e;return null==t||null==(e=t.file)?void 0:e.variants[s]})))break}}}const i=this._file,n=t?new vm(t.url,t.filename,t.hash,t.size,t.opt,t.contents):null;(!!n!=!!i||n&&!n.equals(i))&&(this._file=n,this.fire("change",this,"file",n,i),this.reload())}get data(){return this._data}set data(t){const e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}get resource(){return this._resources[0]}set resource(t){const e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}get resources(){return this._resources}set resources(t){const e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}get preload(){return this._preload}set preload(t){t=!!t,this._preload!==t&&(this._preload=t,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get loadFaces(){return this._loadFaces}set loadFaces(t){t=!!t,this.hasOwnProperty("_loadFaces")&&t===this._loadFaces||(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}static fetchArrayBuffer(t,e,s,i=0){var n;if(t.indexOf("base64")>-1)return e(null,wx.base64ToArrayBuffer(t.split(",")[1]));null!=s&&null!=(n=s.file)&&n.contents?setTimeout((()=>{e(null,s.file.contents)})):j.get(t,{responseType:"arraybuffer",retry:i>0,maxRetries:i}).then((t=>{e(null,t)})).catch((t=>e(t)))}}class Mm extends Ih{constructor(t,e){super(),this.skin=t,this.skinInstance=e}}class Tm{static createCachedSkinedInstance(t,e,s){let i=Tm.getCachedSkinInstance(t,e);return i||(i=new sl(t),i.resolve(e,s),Tm.addCachedSkinInstance(t,e,i)),i}static getCachedSkinInstance(t,e){let s=null;const i=Tm._skinInstanceCache.get(e);if(i){const e=i.find((e=>e.skin===t));e&&(e.incRefCount(),s=e.skinInstance)}return s}static addCachedSkinInstance(t,e,s){let i=Tm._skinInstanceCache.get(e);i||(i=[],Tm._skinInstanceCache.set(e,i));let n=i.find((e=>e.skin===t));n||(n=new Mm(t,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(t){if(t){const e=t.rootBone;if(e){const s=Tm._skinInstanceCache.get(e);if(s){const i=s.findIndex((e=>e.skinInstance===t));if(i>=0){const n=s[i];n.decRefCount(),0===n.getRefCount()&&(s.splice(i,1),s.length||Tm._skinInstanceCache.delete(e),t&&(t.destroy(),n.skinInstance=null))}}}}}}Tm._skinInstanceCache=new Map;class Am{constructor(t,e,s,i){const n=function(t,i,n){const a=Am.createAsset(e.name,t,i,n);return s.add(a),a},a=[];for(let e=0;e<t.renders.length;++e)a.push(n("render",t.renders[e],e));const r=[];for(let e=0;e<t.materials.length;++e)r.push(n("material",t.materials[e],e));const o=[];for(let e=0;e<t.animations.length;++e)o.push(n("animation",t.animations[e],e));this.data=t,this._model=null,this._assetName=e.name,this._assets=s,this._defaultMaterial=i,this.renders=a,this.materials=r,this.textures=t.textures,this.animations=o}get model(){if(!this._model){const t=Am.createModel(this.data,this._defaultMaterial),e=Am.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}static createAsset(t,e,s,i){const n=new wm(t+"/"+e+"/"+i,e,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(t){const e=new ld;return e.addComponent("model",Object.assign({type:"asset",asset:this.model},t)),e}instantiateRenderEntity(t){const e=this._defaultMaterial,s=[],i=function(t,i,n,a,r,o){const h=void 0===n.materialIndex?e:a[n.materialIndex],l=new dl(n,h);return n.morph&&(l.morphInstance=new yd(n.morph)),o.hasOwnProperty("skin")&&s.push({meshInstance:l,rootBone:t,entity:i}),l},n=function e(s,n,a){const r=new ld;n._cloneInternal(r),s||(s=r);let o=null;for(let t=0;t<a.nodes.length;t++){if(a.nodes[t]===n){const e=a.gltf.nodes[t];if(e.hasOwnProperty("mesh")){const t=a.renders[e.mesh].meshes;for(var h=0;h<t.length;h++){const n=t[h];if(n){const t=i(s,r,n,a.materials,a.skins,e);o||(o=[]),o.push(t)}}}if(a.lights){const t=a.lights.get(e);t&&r.addChild(t.clone())}if(a.cameras){const t=a.cameras.get(e);t&&t.camera.system.cloneComponent(t,r)}}}o&&r.addComponent("render",Object.assign({type:"asset",meshInstances:o,rootBone:s},t));const l=n.children;for(let t=0;t<l.length;t++){const i=e(s,l[t],a);r.addChild(i)}return r},a=[];for(const t of this.data.scenes)a.push(n(null,t,this.data));return s.forEach((t=>{t.meshInstance.skinInstance=Tm.createCachedSkinedInstance(t.meshInstance.mesh.skin,t.rootBone,t.entity)})),Am.createSceneHierarchy(a,"Entity")}static createSceneHierarchy(t,e){let s=null;if(1===t.length)s=t[0];else{s=new e("SceneGroup");for(const e of t)s.addChild(e)}return s}static createModel(t,e){const s=function(t,s,i,n,a,r,o){const h=void 0===s.materialIndex?e:a[s.materialIndex],l=new dl(s,h,r);if(s.morph){const e=new yd(s.morph);l.morphInstance=e,t.morphInstances.push(e)}if(o.hasOwnProperty("skin")){const e=o.skin,a=i[e];s.skin=a;const r=n[e];l.skinInstance=r,t.skinInstances.push(r)}t.meshInstances.push(l)},i=new vd,n=[];for(const e of t.skins){const t=new sl(e);t.bones=e.bones,n.push(t)}i.graph=Am.createSceneHierarchy(t.scenes,"GraphNode");for(let e=0;e<t.nodes.length;e++){const r=t.nodes[e];if(r.root===i.graph){const o=t.gltf.nodes[e];if(o.hasOwnProperty("mesh")){const e=t.renders[o.mesh].meshes;for(var a=0;a<e.length;a++){const h=e[a];h&&s(i,h,t.skins,n,t.materials,r,o)}}}}return i}destroy(){const t=this._assets,e=function(e){t.remove(e),e.unload()},s=function(t){t.forEach((function(t){e(t)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null}}class Cm{constructor(t){this.gltf=t,this.nodes=null,this.scenes=null,this.animations=null,this.textures=null,this.materials=null,this.renders=null,this.skins=null,this.lights=null,this.cameras=null,this.nodeVariants=null,this.materialVariants=null}destroy(){this.renders&&this.renders.forEach((t=>{t.meshes=null}))}}const Pm=function(t){return/^data:.*,.*$/i.test(t)},Rm=function(t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},Em=function(t){switch(t){case 5120:return ea;case 5121:return sa;case 5122:return ia;case 5123:return na;case 5124:return aa;case 5125:return ra;case 5126:return oa;default:return 0}},Lm=function(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},Im={POSITION:ln,NORMAL:cn,TANGENT:dn,COLOR_0:mn,JOINTS_0:pn,WEIGHTS_0:un,TEXCOORD_0:_n,TEXCOORD_1:gn,TEXCOORD_2:yn,TEXCOORD_3:vn,TEXCOORD_4:xn,TEXCOORD_5:bn,TEXCOORD_6:Sn,TEXCOORD_7:wn},Dm=function(t,e,s){const i=(t=>{switch(t){case ea:return t=>Math.max(t/127,-1);case sa:return t=>t/255;case ia:return t=>Math.max(t/32767,-1);case na:return t=>t/65535;default:return t=>t}})(s),n=e.length;for(let s=0;s<n;++s)t[s]=i(e[s]);return t},Fm=["KHR_materials_variants"],Om=function t(e,s,i=!1){const n=Rm(e.type),a=function(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}}(e.componentType);if(!a)return null;const r=s[e.bufferView];let o;if(e.sparse){const i=e.sparse,r={count:i.count,type:"SCALAR"},h=t(Object.assign(r,i.indices),s,!0),l={count:i.count,type:e.scalar,componentType:e.componentType},c=t(Object.assign(l,i.values),s,!0);if(e.hasOwnProperty("bufferView")){o=t({bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type},s,!0).slice()}else o=new a(e.count*n);for(let t=0;t<i.count;++t){const e=h[t];for(let s=0;s<n;++s)o[e*n+s]=c[t*n+s]}}else if(i&&r.hasOwnProperty("byteStride")){const t=n*a.BYTES_PER_ELEMENT,s=new ArrayBuffer(e.count*t),i=new Uint8Array(s);let h=0;for(let s=0;s<e.count;++s){let n=(e.byteOffset||0)+s*r.byteStride;for(let e=0;e<t;++e)i[h++]=r[n++]}o=new a(s)}else o=new a(r.buffer,r.byteOffset+(e.byteOffset||0),e.count*n);return o},km=function(t,e){const s=Om(t,e,!0);if(s instanceof Float32Array||!t.normalized)return s;const i=new Float32Array(s.length);return Dm(i,s,Em(t.componentType)),i},Bm=function(t){let e=t.min,s=t.max;if(!e||!s)return null;if(t.normalized){const i=Em(t.componentType);e=Dm([],e,i),s=Dm([],s,i)}return new bt(new it(.5*(s[0]+e[0]),.5*(s[1]+e[1]),.5*(s[2]+e[2])),new it(.5*(s[0]-e[0]),.5*(s[1]-e[1]),.5*(s[2]-e[2])))},zm=function(t,e){const s=t[ln];if(!s||3!==s.components)return;let i;if(s.size!==s.stride){const t=s.stride/Da[s.type],e=new Ia[s.type](s.buffer,s.offset,s.count*t);i=new Ia[s.type](3*s.count);for(let n=0;n<s.count;++n)i[3*n+0]=e[n*t+0],i[3*n+1]=e[n*t+1],i[3*n+2]=e[n*t+2]}else i=new Ia[s.type](s.buffer,s.offset,3*s.count);const n=s.count;e||(e=function(t){const e=new Uint16Array(t);for(let s=0;s<t;s++)e[s]=s;return e}(n));const a=Nh(i,e),r=new Float32Array(a.length);r.set(a),t[cn]={buffer:r.buffer,size:12,offset:0,stride:12,count:n,components:3,type:oa}};const Um=function(t){const e=new wm(t.name+"_clone",t.type,t.file,t.data,t.options);return e.loaded=!0,e.resource=function(t){const e=new Mr(t.device,t);return e._levels=function(t){const e=[];for(let s=0;s<t._levels.length;++s){let i=[];if(t.cubemap)for(let e=0;e<6;++e)i.push(t._levels[s][e]);else i=t._levels[s];e.push(i)}return e}(t),e}(t.resource),t.registry.add(e),e},Vm=function(t,e,s,i){const n=e[ln];if(!n)return null;const a=n.count,r=[];for(const t in e)e.hasOwnProperty(t)&&r.push({semantic:t,components:e[t].components,type:e[t].type,normalize:!!e[t].normalize});const o=[ln,cn,dn,mn,pn,un,_n,gn];let h,l,c,d,u,p;r.sort((function(t,e){const s=o.indexOf(t.semantic),i=o.indexOf(e.semantic);return s<i?-1:i<s?1:0}));const m=new Ja(t,r);let f=!0;for(h=0;h<m.elements.length;++h)if(u=m.elements[h],d=e[u.name],p=d.offset-n.offset,d.buffer!==n.buffer||d.stride!==u.stride||d.size!==u.size||p!==u.offset){f=!1;break}const _=new $a(t,m,a,ti),g=_.lock(),y=new Uint32Array(g);let v;if(f)v=new Uint32Array(n.buffer,n.offset,a*_.format.size/4),y.set(v);else{let t,s;for(h=0;h<_.format.elements.length;++h){u=_.format.elements[h],t=u.stride/4,d=e[u.name],s=d.stride/4,v=new Uint32Array(d.buffer,d.offset,(d.count-1)*s+(d.size+3)/4);let i=0,n=u.offset/4;const r=Math.floor((d.size+3)/4);for(l=0;l<a;++l){for(c=0;c<r;++c)y[n+c]=v[i+c];i+=s,n+=t}}}return s&&function(t,e,s){var i,n;const a=[],r=[],o=[];for(i=0;i<t.format.elements.length;++i){const e=t.format.elements[i];if(e.name===_n||e.name===gn)switch(e.dataType){case oa:a.push({offset:e.offset/4+1,stride:e.stride/4});break;case na:r.push({offset:e.offset/2+1,stride:e.stride/2});break;case sa:o.push({offset:e.offset+1,stride:e.stride})}}const h=function(a,r,o){const h=new r(t.storage);for(i=0;i<a.length;++i){let r=a[i].offset;const l=a[i].stride;for(n=0;n<t.numVertices;++n)h[r]=s&&e?h[r]:o-h[r],r+=l}};a.length>0&&h(a,Float32Array,1),r.length>0&&h(r,Uint16Array,65535),o.length>0&&h(o,Uint8Array,255)}(_,s,i),_.unlock(),_},Nm=new dt,Wm=new it,Gm=function(t,s,i,n,a,r,o,h){const l=[];return s.primitives.forEach((function(c){let d,u,p,m=null,f=!0;if(c.hasOwnProperty("extensions")){const s=c.extensions;if(s.hasOwnProperty("KHR_draco_mesh_compression")){const i=e.polyfill.window.DracoDecoderModule;if(i){const e=s.KHR_draco_mesh_compression;if(e.hasOwnProperty("attributes")){const s=n[e.bufferView],o=new i.DecoderBuffer;o.Init(s,s.length);const l=new i.Decoder,c=l.GetEncodedGeometryType(o);let _,g;switch(c){case i.POINT_CLOUD:d=en,_=new i.PointCloud,g=l.DecodeBufferToPointCloud(o,_);break;case i.TRIANGULAR_MESH:d=rn,_=new i.Mesh,g=l.DecodeBufferToMesh(o,_);case i.INVALID_GEOMETRY_TYPE:}if(!g||!g.ok()||0==_.ptr)return void a("Failed to decode draco compressed asset: "+(g?g.error_msg():"Mesh asset - invalid draco compressed geometry type: "+c));const y=_.num_faces();if(c===i.TRIANGULAR_MESH){const t=_.num_points()>65535;p=3*y;const e=p*(t?4:2),s=i._malloc(e);t?(l.GetTrianglesUInt32Array(_,e,s),m=new Uint32Array(i.HEAPU32.buffer,s,p).slice()):(l.GetTrianglesUInt16Array(_,e,s),m=new Uint16Array(i.HEAPU16.buffer,s,p).slice()),i._free(s)}u=function(t,e,s,i,n,a,r,o){const h=e.num_points(),l=function(t){const s=i.GetAttributeByUniqueId(e,t),a=h*s.num_components();let r,o,l,c;switch(s.data_type()){case n.DT_UINT8:c=sa,l=1,r=n._malloc(a*l),i.GetAttributeDataArrayForAllPoints(e,s,n.DT_UINT8,a*l,r),o=new Uint8Array(n.HEAPU8.buffer,r,a).slice();break;case n.DT_UINT16:c=na,l=2,r=n._malloc(a*l),i.GetAttributeDataArrayForAllPoints(e,s,n.DT_UINT16,a*l,r),o=new Uint16Array(n.HEAPU16.buffer,r,a).slice();break;case n.DT_FLOAT32:default:c=oa,l=4,r=n._malloc(a*l),i.GetAttributeDataArrayForAllPoints(e,s,n.DT_FLOAT32,a*l,r),o=new Float32Array(n.HEAPF32.buffer,r,a).slice()}return n._free(r),{values:o,numComponents:s.num_components(),componentSizeInBytes:l,storageType:c,normalized:s.normalized()}},c={},d=s.attributes;for(const t in d)if(d.hasOwnProperty(t)&&Im.hasOwnProperty(t)){const e=Im[t],s=l(d[t]),i=s.numComponents*s.componentSizeInBytes;c[e]={values:s.values,buffer:s.values.buffer,size:i,offset:0,stride:i,count:h,components:s.numComponents,type:s.storageType,normalize:s.normalized}}return c.hasOwnProperty(cn)||zm(c,a),Vm(t,c,r,o)}(t,_,e,l,i,m,r,h),i.destroy(_),i.destroy(l),i.destroy(o),f=!1}}}}u||(m=c.hasOwnProperty("indices")?Om(i[c.indices],n,!0):null,u=function(t,e,s,i,n,a,r,o){const h={},l=[];for(const t in e)e.hasOwnProperty(t)&&Im.hasOwnProperty(t)&&(h[t]=e[t],l.push(t+":"+e[t]));l.sort();const c=l.join();let d=r[c];if(!d){const l={};for(const t in h){const s=i[e[t]],a=Om(s,n),r=n[s.bufferView],o=Im[t],h=Rm(s.type)*Lm(s.componentType),c=r.hasOwnProperty("byteStride")?r.byteStride:h;l[o]={buffer:a.buffer,size:h,offset:a.byteOffset,stride:c,count:s.count,components:Rm(s.type),type:Em(s.componentType),normalize:s.normalized}}l.hasOwnProperty(cn)||zm(l,s),d=Vm(t,l,a,o),r[c]=d}return d}(t,c.attributes,m,i,n,r,o,h),d=function(t){if(!t.hasOwnProperty("mode"))return rn;switch(t.mode){case 0:return en;case 1:return sn;case 2:return nn;case 3:return an;case 4:default:return rn;case 5:return on;case 6:return hn}}(c));let _=null;if(u){if(_=new Uh(t),_.vertexBuffer=u,_.primitive[0].type=d,_.primitive[0].base=0,_.primitive[0].indexed=null!==m,null!==m){let e;e=m instanceof Uint8Array?bi:m instanceof Uint16Array?Si:wi,e!==wi||t.extUintElement||(e=Si,m=new Uint16Array(m));const s=new ph(t,e,m.length,ti,m);_.indexBuffer[0]=s,_.primitive[0].count=m.length}else _.primitive[0].count=u.numVertices;_.materialIndex=c.material;let e=i[c.attributes.POSITION];if(_.aabb=Bm(e),f&&c.hasOwnProperty("targets")){const a=[];c.targets.forEach((function(t,r){const o={};t.hasOwnProperty("POSITION")&&(e=i[t.POSITION],o.deltaPositions=km(e,n),o.deltaPositionsType=oa,o.aabb=Bm(e)),t.hasOwnProperty("NORMAL")&&(e=i[t.NORMAL],o.deltaNormals=km(e,n),o.deltaNormalsType=oa),s.hasOwnProperty("extras")&&s.extras.hasOwnProperty("targetNames")?o.name=s.extras.targetNames[r]:o.name=r.toString(10),s.hasOwnProperty("weights")&&(o.defaultWeight=s.weights[r]),a.push(new xd(o))})),_.morph=new gd(a,t)}}if(c.hasOwnProperty("extensions")){const t=c.extensions;if(t.hasOwnProperty("KHR_materials_variants")){var g=t.KHR_materials_variants;_._materialsVariants=g}}l.push(_)})),l},Hm=function(t,e,s,i){const n=[0,0],a=[1,1],r=function(t,e,r){var o;let h;const l=t.texCoord;if(l)for(h=0;h<r.length;++h)e[r[h]+"MapUv"]=l;const c=null==(o=t.extensions)?void 0:o.KHR_texture_transform;if(c){const t=c.offset||Array.from(n),o=c.scale||Array.from(a),l=c.rotation?-c.rotation*V.RAD_TO_DEG:0,d=new st(o[0],i&&s?-o[1]:o[1]),u=new st(t[0],i&&s?t[1]:1-o[1]-t[1]);for(h=0;h<r.length;++h)e[`${r[h]}MapScale`]=d,e[`${r[h]}MapOffset`]=u,e[`${r[h]}MapRotation`]=l}};var o=new Mu;let h,l;if(t.hasOwnProperty("name")&&(o.name=t.name),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness"));else if(t.hasOwnProperty("pbrMetallicRoughness")){const s=t.pbrMetallicRoughness;if(s.hasOwnProperty("baseColorFactor")?(h=s.baseColorFactor,o.baseColor=new J(Math.pow(h[0],1/2.2),Math.pow(h[1],1/2.2),Math.pow(h[2],1/2.2)),o.opacity=h[3]):(o.baseColor.set(1,1,1),o.opacity=1),s.hasOwnProperty("baseColorTexture")){const t=s.baseColorTexture;l=e[t.index],o.baseColorMap=l,o.opacityMap=l,r(t,o,["baseColor","opacity"])}if(o.useMetalness=!0,s.hasOwnProperty("metallicFactor")&&(o.metallic=s.metallicFactor),s.hasOwnProperty("roughnessFactor")?o.roughness=s.roughnessFactor:o.roughness=1,s.hasOwnProperty("metallicRoughnessTexture")){var c=s.metallicRoughnessTexture;o.metallicMap=o.roughnessMap=e[c.index],r(c,o,["metallic","roughness"])}s.hasOwnProperty("extras")&&s.extras.hasOwnProperty("baseColorVertex")&&(o.baseColorVertex=s.extras.baseColorVertex)}if(t.hasOwnProperty("normalTexture")){const s=t.normalTexture;o.normalMap=e[s.index],r(s,o,["normal"]),s.hasOwnProperty("scale")&&(o.normalScale=s.scale)}if(t.hasOwnProperty("occlusionTexture")){var d=t.occlusionTexture;o.occlusionMap=e[d.index],r(d,o,["occlusion"]),d.hasOwnProperty("strength")&&(o.occlusionStrength=d.strength)}if(t.hasOwnProperty("emissiveFactor")?(h=t.emissiveFactor,o.emissive=new J(Math.pow(h[0],1/2.2),Math.pow(h[1],1/2.2),Math.pow(h[2],1/2.2)),o.emissiveTint=!0):(o.emissive.set(0,0,0),o.emissiveTint=!1),t.hasOwnProperty("emissiveTexture")){const s=t.emissiveTexture;o.emissiveMap=e[s.index],r(s,o,["emissive"])}if(t.hasOwnProperty("alphaMode")&&(o.alphaMode=t.alphaMode,"MASK"==o.alphaMode&&(t.hasOwnProperty("alphaCutoff")?o.alphaTest=t.alphaCutoff:o.alphaTest=.5)),t.hasOwnProperty("doubleSided")&&(o.doubleSided=t.doubleSided),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_clearcoat")){const s=t.extensions.KHR_materials_clearcoat;if(s.hasOwnProperty("clearcoatFactor")?o.clearcoat=s.clearcoatFactor:o.clearcoat=0,s.hasOwnProperty("clearcoatTexture")){var u=s.clearcoatTexture;o.clearcoatMap=e[u.index],r(u,o,["clearcoat"])}if(s.hasOwnProperty("clearcoatRoughnessFactor")?o.clearcoatRoughness=s.clearcoatRoughnessFactor:o.clearcoatRoughness=0,s.hasOwnProperty("clearcoatRoughnessTexture")){var p=s.clearcoatRoughnessTexture;o.clearcoatRoughnessMap=e[p.index],r(p,o,["clearcoatRoughness"])}if(s.hasOwnProperty("clearcoatNormalTexture")){var m=s.clearcoatNormalTexture;o.clearcoatNormalMap=e[m.index],r(m,o,["clearcoatNormal"]),m.hasOwnProperty("scale")&&(o.clearcoatNormalScale=m.scale)}}return t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_unlit")&&(o.useLighting=!1,o.emissive.copy(o.diffuse),o.emissiveTint=o.diffuseTint,o.emissiveMap=o.diffuseMap,o.emissiveMapUv=o.diffuseMapUv,o.emissiveMapTiling.copy(o.diffuseMapTiling),o.emissiveMapOffset.copy(o.diffuseMapOffset),o.emissiveMapChannel=o.diffuseMapChannel,o.emissiveVertexColor=o.diffuseVertexColor,o.emissiveVertexColorChannel=o.diffuseVertexColorChannel,o.diffuse.set(0,0,0),o.diffuseTint=!1,o.diffuseMap=null,o.diffuseVertexColor=!1),o.update(),o},jm=function(t,e){const s=new jr;if(t.hasOwnProperty("name")&&t.name.length>0?s.name=t.name:s.name="node_"+e,t.hasOwnProperty("matrix")&&(Nm.data.set(t.matrix),Nm.getTranslation(Wm),s.setLocalPosition(Wm),Nm.getEulerAngles(Wm),s.setLocalEulerAngles(Wm),Nm.getScale(Wm),s.setLocalScale(Wm)),t.hasOwnProperty("rotation")){const e=t.rotation;s.setLocalRotation(e[0],e[1],e[2],e[3])}if(t.hasOwnProperty("translation")){const e=t.translation;s.setLocalPosition(e[0],e[1],e[2])}if(t.hasOwnProperty("scale")){const e=t.scale;s.setLocalScale(e[0],e[1],e[2])}return t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("tags")&&s.tags.add(...t.extras.tags),s},qm=function(t,e){const s="orthographic"===t.type?ye:ge,i=s===ye?t.orthographic:t.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:Es};i.zfar&&(n.farClip=i.zfar),s===ye?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=Ls,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*V.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=Ls,n.aspectRatio=i.aspectRatio));const a=new ld(t.name);return a.addComponent("camera",n),a},Xm=function(t,e){const s={enabled:!1,type:"point"===t.type?"omni":t.type,color:t.hasOwnProperty("color")?new J(t.color):J.WHITE,range:t.hasOwnProperty("range")?t.range:9999,falloffMode:ee,intensity:t.hasOwnProperty("intensity")?V.clamp(t.intensity,0,2):1};t.hasOwnProperty("spot")&&(s.innerConeAngle=t.spot.hasOwnProperty("innerConeAngle")?t.spot.innerConeAngle*V.RAD_TO_DEG:0,s.outerConeAngle=t.spot.hasOwnProperty("outerConeAngle")?t.spot.outerConeAngle*V.RAD_TO_DEG:Math.PI/4);const i=new ld(e.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},Ym=function(t,e,s,i){if(!e.hasOwnProperty("skins")||0===e.skins.length)return[];const n=new Map;return e.skins.map((function(a){return function(t,e,s,i,n,a){let r,o,h;const l=e.joints,c=l.length,d=[];if(e.hasOwnProperty("inverseBindMatrices")){const t=e.inverseBindMatrices,n=Om(s[t],i,!0),a=[];for(r=0;r<c;r++){for(o=0;o<16;o++)a[o]=n[16*r+o];h=new dt,h.set(a),d.push(h)}}else for(r=0;r<c;r++)h=new dt,d.push(h);const u=[];for(r=0;r<c;r++)u[r]=n[l[r]].name;const p=u.join("#");let m=a.get(p);return m||(m=new Pu(t,d,u),a.set(p,m)),m}(t,a,e.accessors,i,s,n)}))},Km=function(t,e,s,i){if(!t.hasOwnProperty("animations")||0===t.animations.length)return[];const n=i&&i.animation&&i.animation.preprocess,a=i&&i.animation&&i.animation.postprocess;return t.animations.map((function(i,r){n&&n(i);const o=function(t,e,s,i,n){const a=function(t){return new Xu(Rm(t.type),km(t,i))},r={STEP:Uu,LINEAR:Vu,CUBICSPLINE:Nu},o={},h=[],l={},c=[],d=[];let u;for(u=0;u<t.samplers.length;++u){const e=t.samplers[u];o.hasOwnProperty(e.input)||(o[e.input]=h.length,h.push(a(s[e.input]))),l.hasOwnProperty(e.output)||(l[e.output]=c.length,c.push(a(s[e.output])));const i=e.hasOwnProperty("interpolation")&&r.hasOwnProperty(e.interpolation)?r[e.interpolation]:Vu;d.push(new qu([],o[e.input],l[e.output],i))}const p=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"},f=t=>{const e=[];for(;t;)e.unshift(t.name),t=t.parent;return e};for(u=0;u<t.channels.length;++u){const e=t.channels[u],s=e.target,i=d[e.sampler],a=f(n[s.node]);i._paths.push({entityPath:a,component:"graph",propertyPath:[m[s.path]]}),s.path.startsWith("rotation")&&i.interpolation!==Nu?p.push(i.output):s.path.startsWith("weights")&&(c[i.output]._components=c[i.output].data.length/h[i.input].data.length)}p.sort();let _,g=null;for(u=0;u<p.length;++u){const t=p[u];if(0===u||t!==g){if(_=c[t],4===_.components){const t=_.data,e=t.length-4;for(let s=0;s<e;s+=4)t[s+0]*t[s+4]+t[s+1]*t[s+5]+t[s+2]*t[s+6]+t[s+3]*t[s+7]<0&&(t[s+4]*=-1,t[s+5]*=-1,t[s+6]*=-1,t[s+7]*=-1)}g=t}}let y=0;for(u=0;u<h.length;u++)_=h[u]._data,y=Math.max(y,0===_.length?0:_[_.length-1]);return new Sp(t.hasOwnProperty("name")?t.name:"animation_"+e,y,h,c,d)}(i,r,t.accessors,s,e);return a&&a(i,o),o}))},$m=function(t,e,s){t.nodes.forEach((t=>{if(t.hasOwnProperty("mesh")&&t.hasOwnProperty("skin")){e[t.mesh].meshes.forEach((e=>{e.skin=s[t.skin]}))}}))},Zm=function(t,e,s,i,n,a){const r=n&&n.global&&n.global.preprocess,o=n&&n.global&&n.global.postprocess;r&&r(e);const h=e.extensionsRequired&&e.extensionsRequired.indexOf("KHR_texture_basisu")>=0&&e.extensionsUsed&&e.extensionsUsed.indexOf("KHR_texture_basisu")>=0,l=e.extensionsRequired&&e.extensionsRequired.indexOf("KHR_mesh_quantization")>=0&&e.extensionsUsed&&e.extensionsUsed.indexOf("KHR_mesh_quantization")>=0,c=function(t,e){if(!t.hasOwnProperty("nodes")||0===t.nodes.length)return[];const s=e&&e.node&&e.node.preprocess,i=e&&e.node&&e.node.process||jm,n=e&&e.node&&e.node.postprocess,a=t.nodes.map((function(t,e){s&&s(t);const a=i(t,e);return n&&n(t,a),a}));for(let e=0;e<t.nodes.length;++e){const s=t.nodes[e];if(s.hasOwnProperty("children")){const t=a[e],i={};for(let e=0;e<s.children.length;++e){const n=a[s.children[e]];n.parent||(i.hasOwnProperty(n.name)?n.name+=i[n.name]++:i[n.name]=1,t.addChild(n))}}}return a}(e,n),d=function(t,e){var s;const i=[],n=t.scenes.length;if(1===n&&1===(null==(s=t.scenes[0].nodes)?void 0:s.length)){const s=t.scenes[0].nodes[0];i.push(e[s])}else for(let s=0;s<n;s++){const n=t.scenes[s];if(n.nodes){const t=new jr(n.name);for(let s=0;s<n.nodes.length;s++){const i=e[n.nodes[s]];t.addChild(i)}i.push(t)}}return i}(e,c),u=function(t,e,s){let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const n=t.extensions.KHR_lights_punctual.lights;if(n.length){const a=s&&s.light&&s.light.preprocess,r=s&&s.light&&s.light.process||Xm,o=s&&s.light&&s.light.postprocess;t.nodes.forEach((function(t,s){if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("light")){const h=t.extensions.KHR_lights_punctual.light,l=n[h];if(l){a&&a(l);const n=r(l,e[s]);o&&o(l,n),n&&(i||(i=new Map),i.set(t,n))}}}))}}return i}(e,c,n),p=function(t,e,s){let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("cameras")&&t.cameras.length>0){const n=s&&s.camera&&s.camera.preprocess,a=s&&s.camera&&s.camera.process||qm,r=s&&s.camera&&s.camera.postprocess;t.nodes.forEach((function(s,o){if(s.hasOwnProperty("camera")){const h=t.cameras[s.camera];if(h){n&&n(h);const t=a(h,e[o]);r&&r(h,t),t&&(i||(i=new Map),i.set(s,t))}}}))}return i}(e,c,n),m=Km(e,c,s,n),f=function(t,e,s,i,n){if(!t.hasOwnProperty("materials")||0===t.materials.length)return[];const a=s&&s.material&&s.material.preprocess,r=s&&s.material&&s.material.process||Hm,o=s&&s.material&&s.material.postprocess;return t.materials.map((function(t){a&&a(t);const s=r(t,e,i,n);return o&&o(t,s),s}))}(e,i.map((function(t){return t.resource})),n,h,l),_=function(t,e,s,i,n,a){if(!e.hasOwnProperty("meshes")||0===e.meshes.length||!e.hasOwnProperty("accessors")||0===e.accessors.length||!e.hasOwnProperty("bufferViews")||0===e.bufferViews.length)return[];const r={};return e.meshes.map((function(o){return Gm(t,o,e.accessors,s,i,n,r,a)}))}(t,e,s,a,h,l),g=Ym(t,e,c,s),y=function(t){return t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("nodeVariants")&&0!==t.extras.nodeVariants.length?t.extras.nodeVariants:[]}(e),v=function(t){return t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("materialVariants")&&0!=t.extras.materialVariants.length?t.extras.materialVariants:[]}(e),x=[];for(let t=0;t<_.length;t++)x[t]=new cm,x[t].meshes=_[t];!function(t){let e={};if(!t.hasOwnProperty("extensions")||!t.hasOwnProperty("extensionsUsed"))return e;for(let s=0;s<Fm.length;s++){const i=Fm[s];-1!=t.extensionsUsed.indexOf(i)&&(e[i]=t.extensions[i])}}(e),$m(e,x,g),$m(e,x,g);const b=new Cm(e);b.nodes=c,b.scenes=d,b.animations=m,b.textures=i,b.materials=f,b.renders=x,b.skins=g,b.lights=u,b.cameras=p,b.nodeVariants=y,b.materialVariants=v,o&&o(e,b),a(null,b)};let Jm=0;const Qm=function(t,e,s,i,n,a,r){const o=a&&a.image&&a.image.preprocess,h=a&&a.image&&a.image.processAsync||function(t,e){e(null,null)},l=a&&a.image&&a.image.postprocess,c=function(e){l&&l(t,e),r(null,e)},d={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=function(e,s,i,a){let o=(t.name||"gltf-texture")+"-"+Jm++;i&&(o+="."+d[i]);const h={url:e||o};if(s&&(h.contents=s.slice(0).buffer),i){const t=d[i];t&&(h.filename=h.url+"."+t)}const l=new wm(o,"texture",h,null,a);l.on("load",c),l.on("error",r),n.add(l),n.load(l)};o&&o(t),h(t,(function(n,a){var o;n?r(n):a?c(a):t.hasOwnProperty("uri")?Pm(t.uri)?u(t.uri,null,(o=t.uri).substring(o.indexOf(":")+1,o.indexOf(";")),null):u(f.join(i,t.uri),null,null,{crossOrigin:"anonymous"}):t.hasOwnProperty("bufferView")&&t.hasOwnProperty("mimeType")?u(null,s[t.bufferView],t.mimeType,null):r("Invalid image found in gltf (neither uri or bufferView found). index="+e)}))},tf=function(t,e,s,i,n,a){if(!t.hasOwnProperty("images")||0===t.images.length||!t.hasOwnProperty("textures")||0===t.textures.length)return void a(null,[]);const r=n&&n.texture&&n.texture.preprocess,o=n&&n.texture&&n.texture.processAsync||function(t,e,s){s(null,null)},h=n&&n.texture&&n.texture.postprocess,l=[],c=[];let d=t.textures.length;const u=function(e,s){if(c[s]||(c[s]=[]),c[s].push(e),0==--d){const e=[];c.forEach((function(s,i){s.forEach((function(s,n){const a=0===n?l[i]:Um(l[i]);!function(t,e){const s=function(t,e){switch(t){case 9728:return di;case 9729:return ui;case 9984:return pi;case 9985:return fi;case 9986:return mi;case 9987:return _i;default:return e}},i=function(t,e){switch(t){case 33071:return Ws;case 33648:return Gs;case 10497:return Ns;default:return e}};t&&(e=e||{},t.minFilter=s(e.minFilter,_i),t.magFilter=s(e.magFilter,ui),t.addressU=i(e.wrapS,Ns),t.addressV=i(e.wrapT,Ns))}(a.resource,(t.samplers||[])[t.textures[s].sampler]),e[s]=a,h&&h(t.textures[s],a)}))})),a(null,e)}};for(let h=0;h<t.textures.length;++h){const c=t.textures[h];r&&r(c),o(c,t.images,function(r,o,h,c){if(h)a(h);else{var d,p;if(null==c)void 0===(c=null==o||null==(d=o.extensions)||null==(p=d.KHR_texture_basisu)?void 0:p.source)&&(c=o.source);if(l[c])u(r,c);else{const o=t.images[c];Qm(o,r,e,s,i,n,(function(t,e){t?a(t):(l[c]=e,u(r,c))}))}}}.bind(null,h,c))}},ef=function(t,s){const i=JSON.parse(function(t){if(void 0!==e.polyfill.TextDecoder)return(new e.polyfill.TextDecoder).decode(t);let s="";for(let e=0;e<t.length;e++)s+=String.fromCharCode(t[e]);return decodeURIComponent(escape(s))}(t));i.asset&&i.asset.version&&parseFloat(i.asset.version)<2?s(`Invalid gltf version. Expected version 2.0 or above but found version '${i.asset.version}'.`):s(null,i)},sf=function(t,e,s){let i=t.toLowerCase().indexOf(".glb")>0;t&&i?function(t,e){const s=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),a=s.getUint32(8,!0);if(1179937895!==i)return void e("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16));if(2!==n)return void e("Invalid version number found in glb header. Expected 2, found "+n);if(a<=0||a>s.byteLength)return void e("Invalid length found in glb header. Found "+a);const r=[];let o=12;for(;o<a;){const t=s.getUint32(o,!0);if(o+t+8>s.byteLength)throw new Error("Invalid chunk length found in glb. Found "+t);const e=s.getUint32(o+4,!0),i=new Uint8Array(s.buffer,s.byteOffset+o+8,t);r.push({length:t,type:e,data:i}),o+=t+8}1===r.length||2===r.length?1313821514===r[0].type?r.length>1&&5130562!==r[1].type?e("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+r[1].type.toString(16)):e(null,{gltfChunk:r[0].data,binaryChunk:2===r.length?r[1].data:null}):e("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+r[0].type.toString(16)):e("Invalid number of chunks found in glb file.")}(e,s):s(null,{gltfChunk:e,binaryChunk:null})},nf=function(t,e,s,i){const n=[],a=s&&s.bufferView&&s.bufferView.preprocess,r=s&&s.bufferView&&s.bufferView.processAsync||function(t,e,s){s(null,null)},o=s&&s.bufferView&&s.bufferView.postprocess;let h=t.bufferViews?t.bufferViews.length:0;if(!h)return void i(null,null);const l=function(e,s){const a=t.bufferViews[e];a.hasOwnProperty("byteStride")&&(s.byteStride=a.byteStride),n[e]=s,o&&o(a,s),0==--h&&i(null,n)};for(let s=0;s<t.bufferViews.length;++s){const n=t.bufferViews[s];a&&a(n),r(n,e,function(t,s,n,a){if(n)i(n);else if(a)l(t,a);else{const i=e[s.buffer],n=new Uint8Array(i.buffer,i.byteOffset+(s.byteOffset||0),s.byteLength);l(t,n)}}.bind(null,s,n))}};class af{static parseAsync(t,s,i,n,a,r,o){sf(t,i,(function(t,i){t?o(t):ef(i.gltfChunk,(function(t,h){t?o(t):function(t,s,i,n,a){const r=[];if(!t.buffers||0===t.buffers.length)return void a(null,r);const o=n&&n.buffer&&n.buffer.preprocess,h=n&&n.buffer&&n.buffer.processAsync||function(t,e){e(null,null)},l=n&&n.buffer&&n.buffer.postprocess;let c=t.buffers.length;const d=function(e,s){r[e]=s,l&&l(t.buffers[e],s),0==--c&&a(null,r)};for(let n=0;n<t.buffers.length;++n){const r=t.buffers[n];o&&o(r),h(r,function(t,n,r,o){if(r)a(r);else if(o)d(t,new Uint8Array(o));else if(n.hasOwnProperty("uri"))if(Pm(n.uri)){const s=e.polyfill.atob(n.uri.split(",")[1]),i=new Uint8Array(s.length);for(let t=0;t<s.length;t++)i[t]=s.charCodeAt(t);d(t,i)}else j.get(f.join(i,n.uri),{responseType:"arraybuffer",retry:!1}).then((e=>{d(t,new Uint8Array(e))})).catch((t=>a(t)));else d(t,s)}.bind(null,n,r))}}(h,i.binaryChunk,s,r,(function(t,e){t?o(t):nf(h,e,r,(function(t,e){t?o(t):tf(h,e,s,a,r,(function(t,s){t?o(t):Zm(n,h,e,s,r,o)}))}))}))}))}))}static parse(t,e,s,i){let n=null;return i=i||{},sf(t,e,(function(t,e){t?console.error(t):ef(e.gltfChunk,(function(t,a){t?console.error(t):nf(a,[e.binaryChunk],i,(function(t,e){t?console.error(t):Zm(s,a,e,[],i,(function(t,e){t?console.error(t):n=e}))}))}))})),n}constructor(t,e,s){this._device=t,this._assets=e,this._defaultMaterial=Eo.get(t),this._maxRetries=s}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}load(t,e,s){wm.fetchArrayBuffer(t.load,((i,n)=>{i?e(i):af.parseAsync(this._getUrlWithoutParams(t.original),f.extractPath(t.load),n,this._device,s.registry,s.options,((t,i)=>{t?e(t):e(null,new Am(i,s,this._assets,this._defaultMaterial))}))}),s,this._maxRetries)}open(t,e,s){return e}patch(t,e){}}af.parseMaterialsVariants=function(t,e){if(!t.extensions.KHR_materials_variants||t.extensions.KHR_materials_variants.variants.length<=0)return;let s=[];for(let e=0;e<t.extensions.KHR_materials_variants.variants.length;e++){let i=t.extensions.KHR_materials_variants.variants[e],n={};i.hasOwnProperty("extras")&&(i.extras.hasOwnProperty("id")&&(n.id=i.extras.id),i.extras.hasOwnProperty("description")&&(n.description=i.extras.description)),n.name=i.name,n.relations=[],s.push(n)}const i=function(t,e){let i=t._materialsVariants;for(let n=0;n<s.length;n++){let a=t.material;for(let s=0;s<i.mappings.length;s++)i.mappings[s].variants.indexOf(n)>=0&&(a=void 0===i.mappings[s].material?t.material:e[i.mappings[s].material]);s[n].relations.push(a)}};for(let s=0;s<t.nodes.length;s++){if(t.nodes[s].root===e.graph){const e=t.gltf.nodes[s];if(e.hasOwnProperty("mesh")){const s=t.renders[e.mesh].meshes;for(var n=0;n<s.length;n++){s[n]&&i(s[n],t.materials)}}}}return s};class rf{constructor(t){this._device=t,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(".glb"===f.getExtension(t.original).toLowerCase()?s.responseType=H.ResponseType.ARRAY_BUFFER:s.responseType=H.ResponseType.JSON),j.get(t.load,s).then((t=>{e(null,t)})).catch((s=>{e("Error loading animation resource: "+t.original+" ["+s+"]")}))}open(t,e){if(".glb"===f.getExtension(t).toLowerCase()){const t=af.parse("filename.glb",e,null);if(t){const e=t.animations;return t.destroy(),e}return null}return this["_parseAnimationV"+e.animation.version](e)}_parseAnimationV3(t){const e=t.animation,s=new ku;s.name=e.name,s.duration=e.duration;for(let t=0;t<e.nodes.length;t++){const i=new Ou,n=e.nodes[t];i._name=n.name;for(let t=0;t<n.keys.length;t++){const e=n.keys[t],s=e.time,a=e.pos,r=e.rot,o=e.scale,h=new it(a[0],a[1],a[2]),l=(new ft).setFromEulerAngles(r[0],r[1],r[2]),c=new it(o[0],o[1],o[2]),d=new Fu(s,h,l,c);i._keys.push(d)}s.addNode(i)}return s}_parseAnimationV4(t){const e=t.animation,s=new ku;s.name=e.name,s.duration=e.duration;for(let t=0;t<e.nodes.length;t++){const i=new Node,n=e.nodes[t];i._name=n.name;const a=n.defaults.p,r=n.defaults.r,o=n.defaults.s;for(let t=0;t<n.keys.length;t++){const e=n.keys[t],s=e.t,h=a||e.p,l=r||e.r,c=o||e.s,d=new it(h[0],h[1],h[2]),u=(new ft).setFromEulerAngles(l[0],l[1],l[2]),p=new it(c[0],c[1],c[2]),m=new Fu(s,d,u,p);i._keys.push(m)}s.addNode(i)}return s}}const of=function(){if(void 0===e.polyfill.window)return!1;const t=e.polyfill.window.navigator.userAgent,s=t.indexOf("MSIE ");if(s>0)return parseInt(t.substring(s+5,t.indexOf(".",s)),10);if(t.indexOf("Trident/")>0){const e=t.indexOf("rv:");return parseInt(t.substring(e+3,t.indexOf(".",e)),10)}return!1}(),hf={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"};class lf{constructor(t){this.manager=t,this.maxRetries=0}_isSupported(t){const e=f.getExtension(t);return!!hf[e]}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=function(t){e(null,new jp(t))},i=function(s){let i="Error loading audio url: "+t.original;s&&(i+=": "+(s.message||s)),console.warn(i),e(i)};if(this._createSound){if(!this._isSupported(t.original))return void i(`Audio format for ${t.original} not supported`);this._createSound(t.load,s,i)}else i(null)}open(t,e){return e}_createSound(t,s,i){if(Vp()){const e=this.manager;if(!e.context)return void i("Audio manager has no audio context");const n={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.startsWith("blob:")||t.startsWith("data:"))&&(n.responseType=H.ResponseType.ARRAY_BUFFER),j.get(t,n).then((t=>{e.context.decodeAudioData(t,s,i)})).catch((t=>{i(t)}))}else{let n=null;try{n=new Audio}catch(t){return void i("No support for Audio element")}of&&e.polyfill.document.body.appendChild(n);const a=function t(){n.removeEventListener("canplaythrough",t),of&&e.polyfill.document.body.removeChild(n),s(n)};n.onerror=function(){n.onerror=null,of&&e.polyfill.document.body.removeChild(n),i()},n.addEventListener("canplaythrough",a),n.src=t}}}class cf{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),j.get(t.load,{responseType:H.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((t=>{e(null,t)})).catch((s=>{e("Error loading binary resource: "+t.original+" ["+s+"]")}))}open(t,e){return e}patch(t,e){}}let df;function uf(t){let s,i;if(void 0!==e.polyfill.TextDecoder)try{s=new e.polyfill.TextDecoder("utf-8"),i=new e.polyfill.TextDecoder("windows-1252")}catch(t){console.warn("TextDecoder not supported - pc.Untar module will not work")}else console.warn("TextDecoder not supported - pc.Untar module will not work");function n(t){this._fields=t}function a(t){this._arrayBuffer=t||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._paxHeader=null,this._bytesRead=0}n.parse=function(t,e,i){const a=new Uint8Array(t,e,i);let r=0;const o=[];for(;r<i;){let n;for(n=r;n<i&&32!==a[n];n++);if(n>=i)throw new Error("Invalid PAX header data format.");const h=parseInt(s.decode(new Uint8Array(t,e+r,n-r)),10),l=s.decode(new Uint8Array(t,e+n+1,h-(n-r)-2)).split("=");if(2!==l.length)throw new Error("Invalid PAX header data format.");0===l[1].length&&(l[1]=null),o.push({name:l[0],value:l[1]}),r+=h}return new n(o)},n.prototype.applyHeader=function(t){for(let e=0;e<this._fields.length;e++){let s=this._fields[e].name;const i=this._fields[e].value;"path"===s&&(s="name"),null===i?delete t[s]:t[s]=i}},t||(df=a),a.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},a.prototype._readNextFile=function(){const s=new DataView(this._arrayBuffer,this._bytesRead,512),a=i.decode(s);this._bytesRead+=512;let r=a.substr(0,100).replace(/\0/g,"");const o=a.substr(257,6),h=parseInt(a.substr(124,12),8),l=a.substr(156,1),c=this._bytesRead;let d=null,u=!1;switch(l){case"0":case"":if(u=!0,!t){const t=new e.polyfill.Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+h)]);d=e.polyfill.URL.createObjectURL(t)}break;case"g":this._globalPaxHeader=n.parse(this._arrayBuffer,this._bytesRead,h);break;case"x":this._paxHeader=n.parse(this._arrayBuffer,this._bytesRead,h)}this._bytesRead+=h;const p=h%512;if(0!==p&&(this._bytesRead+=512-p),!u)return null;if(-1!==o.indexOf("ustar")){const t=a.substr(345,155).replace(/\0/g,"");t.length>0&&(r=t.trim()+r.trim())}const m={name:r,start:c,size:h,url:d};return this._globalPaxHeader&&this._globalPaxHeader.applyHeader(m),this._paxHeader&&(this._paxHeader.applyHeader(m),this._paxHeader=null),m},a.prototype.untar=function(t){if(!s)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];const e=[];for(;this._hasNext();){const s=this._readNextFile();s&&(t&&s.name&&(s.name=t+s.name),e.push(s))}return e},t&&(self.onmessage=function(t){const e=t.data.id;try{const s=new a(t.data.arrayBuffer).untar(t.data.prefix);postMessage({id:e,files:s,arrayBuffer:t.data.arrayBuffer},[t.data.arrayBuffer])}catch(t){postMessage({id:e,error:t.toString()})}})}let pf=null;class mf{constructor(t){this._requestId=0,this._pendingRequests={},this._filenamePrefix=t,this._worker=new Worker(function(){if(!pf){const t="("+uf.toString()+")(true)\n\n",s=new e.polyfill.Blob([t],{type:"application/javascript"});pf=e.polyfill.URL.createObjectURL(s)}return pf}()),this._worker.addEventListener("message",this._onMessage.bind(this))}_onMessage(t){const s=t.data.id;if(!this._pendingRequests[s])return;const i=this._pendingRequests[s];if(delete this._pendingRequests[s],t.data.error)i(t.data.error);else{const s=t.data.arrayBuffer;for(let i=0,n=t.data.files.length;i<n;i++){const n=t.data.files[i],a=new e.polyfill.Blob([s.slice(n.start,n.start+n.size)]);n.url=e.polyfill.URL.createObjectURL(a)}i(null,t.data.files)}}untar(t,e){const s=this._requestId++;this._pendingRequests[s]=e,this._worker.postMessage({id:s,prefix:this._filenamePrefix,arrayBuffer:t},[t])}hasPendingRequests(){return Object.keys(this._pendingRequests).length>0}destroy(){this._worker&&(this._worker.terminate(),this._worker=null,this._pendingRequests=null)}}uf();class ff{constructor(t){this._assets=t,this._worker=null,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this;j.get(t.load,{responseType:H.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((i=>{try{s._untar(i,e)}catch(s){e("Error loading bundle resource "+t.original+": "+s)}})).catch((s=>{e("Error loading bundle resource "+t.original+": "+s)}))}_untar(t,e){const s=this;if(C.workers)s._worker||(s._worker=new mf(s._assets.prefix)),s._worker.untar(t,(function(t,i){e(t,i),s._worker.hasPendingRequests()||(s._worker.destroy(),s._worker=null)}));else{const i=new df(t).untar(s._assets.prefix);e(null,i)}}open(t,e){return new Kp(e)}patch(t,e){}}class _f extends u{constructor(t){super(),this.data=t,this._model=null,this.nodes=[],this.renders=[],this.materials=[],this.textures=[],this.animations=[],this.registry=null,this._defaultMaterial=null,this._assetName=null,this._assets=null}get model(){if(!this._model){const t=_f.createModel(this.data,this._defaultMaterial),e=_f.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}static createAsset(t,e,s,i){const n=new wm(t,e,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(t){return null}instantiateRenderEntity(t){const e=this._defaultMaterial,s=[],i=function(t,i,n,a,r,o){const h=void 0===n.materialIndex?e:a[n.materialIndex],l=new dl(n,h);return n.morph&&(l.morphInstance=new yd(n.morph)),o.hasOwnProperty("skin")&&s.push({meshInstance:l,rootBone:t,entity:i}),l},n=function e(s,n,a){const r=new ld;n._cloneInternal(r),s||(s=r);let o=null;for(let t=0;t<a.nodes.length;t++){if(a.nodes[t]===n){const e=a.gltf.nodes[t];if(e.hasOwnProperty("mesh")){const t=a.renders[e.mesh].meshes;for(var h=0;h<t.length;h++){const n=t[h];if(n){const t=i(s,r,n,a.materials,a.skins,e);o||(o=[]),o.push(t)}}}if(a.lights){const t=a.lights.get(e);t&&r.addChild(t.clone())}if(a.cameras){const t=a.cameras.get(e);t&&t.camera.system.cloneComponent(t,r)}}}o&&r.addComponent("render",Object.assign({type:"asset",meshInstances:o},t));const l=n.children;for(let t=0;t<l.length;t++){const i=e(s,l[t],a);r.addChild(i)}return r},a=[];for(const t of this.data.scenes)a.push(n(null,t,this.data));return s.forEach((t=>{t.meshInstance.skinInstance=Tm.createCachedSkinedInstance(t.meshInstance.mesh.skin,t.rootBone,t.entity)})),_f.createSceneHierarchy(a,"Entity")}static createSceneHierarchy(t,e){let s=null;if(1===t.length)s=t[0];else{s=new e("SceneGroup");for(const e of t)s.addChild(e)}return s}static createModel(t,e){const s=function(t,s,i,n,a,r,o){const h=void 0===s.materialIndex?e:a[s.materialIndex],l=new dl(s,h,r);if(s.morph){const e=new yd(s.morph);l.morphInstance=e,t.morphInstances.push(e)}if(o.hasOwnProperty("skin")){const e=o.skin,a=i[e];s.skin=a;const r=n[e];l.skinInstance=r,t.skinInstances.push(r)}t.meshInstances.push(l)},i=new vd,n=[];for(const e of t.skins){const t=new sl(e);t.bones=e.bones,n.push(t)}i.graph=_f.createSceneHierarchy(t.scenes,"GraphNode");for(let e=0;e<t.nodes.length;e++){const r=t.nodes[e];if(r.root===i.graph){const o=t.gltf.nodes[e];if(o.hasOwnProperty("mesh")){const e=t.renders[o.mesh].meshes;for(var a=0;a<e.length;a++){const h=e[a];h&&s(i,h,t.skins,n,t.materials,r,o)}}}}return i}destroy(){const t=this.registry,e=function(e){t.remove(e),e.unload()},s=function(t){t.forEach((function(t){e(t)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this.rendersIndex&&(this.rendersIndex=[]),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null}}class gf{constructor(t,e){this.glbParser=new af(t,e,0),this.parsers={}}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=f.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.glbParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return this._getParser(t).open(t,e,s)}patch(t,e){const s=t.resource,i=s&&s.data;if(i){const n=function(s,i,n,a){const r=_f.createAsset(a||t.name+"/"+s+"/"+n,s,i,n);return e.add(r),r};let a;const r=[];for(let t=0;t<i.nodes.length;t++)r.push(i.nodes[t]);const o=[];for(a=0;a<i.renders.length;++a)o.push(n("render",i.renders[a],a));const h=[];for(a=0;a<i.materials.length;++a)h.push(n("material",i.materials[a],a,i.materials[a].name));const l=[];for(a=0;a<i.animations.length;++a)l.push(n("animation",i.animations[a],a,i.animations[a].name));s.nodes=r,s._assetName=t.name,s._assets=e,s.renders=o,s.materials=h,s.textures=i.textures,s.animations=l,s.registry=e}}}let yf,vf=null;class xf extends _f{constructor(t,e){super(t),this.materialSchemes=[],this.nodeSchemes=[],this.template=null,this._defaultMaterial=e,this._instantiateRenderContainers=[]}instantiateRenderContainer(t){const e=this._defaultMaterial,s=[],i=function(t,i,n,a,r,o){const h=void 0===n.materialIndex?e:a[n.materialIndex],l=new dl(n,h);return n.morph&&(l.morphInstance=new yd(n.morph)),o.hasOwnProperty("skin")&&s.push({meshInstance:l,rootBone:t,entity:i}),l};let n;t=t||{};const a=this.data.materialVariants;a&&a.length>0&&(n={});for(let t=0;a&&t<a.length;t++){const e=a[t];for(let t=0;e.variantsData&&t<e.variantsData.length;t++){const s=e.variantsData[t];for(let t=0;t<s.materialMapping.length;t++){const e=s.materialMapping[t];n[e.mesh]||(n[e.mesh]={}),n[e.mesh][s.id]={id:s.id,name:s.name,materialAssets:e.primitiveMaterial.map((t=>t<0?void 0:this.materials[t].id))}}}}let r;const o=this.data.nodeVariants;o&&o.length>0&&(r={});for(let t=0;o&&t<o.length;t++){const e=o[t];for(let t=0;e.variantsData&&t<e.variantsData.length;t++){const s=e.variantsData[t];for(let t=0;s.mapping&&t<s.mapping.length;t++){const e=s.mapping[t];r[e.node]||(r[e.node]={}),r[e.node][s.id]={id:s.id,name:s.name,enabled:e.enabled}}}}const h=(e,s,a)=>{if(s){const l=new ld;s._cloneInternal(l),e||(e=l);let c=null,d=null,u=null;for(let t=0;t<a.nodes.length;t++){if(a.nodes[t]===s){const s=a.gltf.nodes[t];if(u=r&&r[t],s.hasOwnProperty("mesh")){const t=a.renders[s.mesh].meshes;for(var o=0;o<t.length;o++){const n=t[o];if(n){const t=i(e,l,n,a.materials,a.skins,s);c||(c=[]),c.push(t)}}d=n&&n[s.mesh]}if(a.lights){const t=a.lights.get(s);t&&l.addChild(t.clone())}if(a.cameras){const t=a.cameras.get(s);t&&t.camera.system.cloneComponent(t,l)}}}c&&l.addComponent("render",Object.assign({type:"asset",meshInstances:c,rootBone:e},t.render||{})),d&&l.addComponent("materialVariants",{variants:d}),u&&l.addComponent("nodeVariants",{variants:u});const p=s.children;for(let t=0;t<p.length;t++){const s=h(e,p[t],a);l.addChild(s)}return l}return null},l=[];for(const t of this.data.scenes)l.push(h(null,t,this.data));s.forEach((t=>{t.meshInstance.skinInstance=Tm.createCachedSkinedInstance(t.meshInstance.mesh.skin,t.rootBone,t.entity)}));const c=_f.createSceneHierarchy(l,"Container");return this.materialSchemes.length>0&&c.addComponent("materialSchemes",{schemes:this.materialSchemes}),this.nodeSchemes.length>0&&c.addComponent("nodeSchemes",{schemes:this.nodeSchemes}),this.animations.length>0&&c.addComponent("animation",Object.assign({assets:this.animations},t.animation||{})),this._instantiateRenderContainers.push(c),c}destroy(){super.destroy();for(let t=0;t<this._instantiateRenderContainers.length;t++){this._instantiateRenderContainers[t].destroy()}}}class bf extends gf{constructor(t,e,s){super(t.graphicsDevice,e),this.defaultMaterial=s,this._device=t.graphicsDevice,this.app=t}load(t,s,i){"string"==typeof t&&(t={load:t,original:t});const n={responseType:H.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries,bufferView:{processAsync:function(t,s,i){if(t.extensions&&t.extensions.EXT_meshopt_compression){const n=t.extensions.EXT_meshopt_compression;(yf||(yf=new Promise(((t,s)=>{if(!vf)return Promise.reject("downloadConfig is not defined.");const i=e.polyfill.document.createElement("script");i.type="text/javascript",i.src=vf.url,e.polyfill.document.body.appendChild(i),i.onload=function(){t()}}))),yf).then((()=>{const t=MeshoptDecoder;t.ready.then((()=>{const e=n.byteOffset||0,a=n.byteLength||0,r=n.count,o=n.byteStride,h=new Uint8Array(r*o),l=new Uint8Array(s[n.buffer].buffer,s[n.buffer].byteOffset+e,a);t.decodeGltfBuffer(h,r,o,l,n.mode,n.filter),i(null,h)}))}))}else i(null,null)}.bind(this)},image:{processAsync:((t,e)=>{const s=t.uri;if(s){const t=new wm(s.filename,"texture",{url:s.url,filename:s.filename});t.on("load",(function(){e(null,t)})),this.app.assets.add(t),this.app.assets.load(t)}else e(null,null)}).bind(this)},buffer:{processAsync:((t,e)=>{const s=t.uri;if(s){const t=new wm(s.filename,"binary",{url:s.url,filename:s.filename});t.on("load",(function(){e(null,new Uint8Array(t.resource))})),this.app.assets.add(t),this.app.assets.load(t)}else e(null,null)}).bind(this)}},a=this,r=(e,s)=>{af.parseAsync(f.getBasename(t.load),f.extractPath(t.load),e,a._device,i.registry,n,(function(t,e){t?s(t):s(null,new xf(e,a.defaultMaterial))}))};i&&i.file&&i.file.contents?r(i.file.contents,s):j.get(t.load.replace(".glb",".glb.gz"),U({},n,{retry:!1,maxRetries:0})).then((t=>{if(s)return r(t,s)})).catch((e=>{j.get(t.load,n).then((t=>{s&&r(t,s)})).catch((e=>{s("Error loading model: "+t.original+" ["+e+"]")}))}))}_createTemplate(t){const e=t.data.gltf,s=t.renders,i=t.materials,n=new ft,a=new dt,r=new it,o=[];e.nodes.map(((t,e)=>{const s={};if(t.hasOwnProperty("name")&&t.name.length>0?s.name=t.name:s.name="node_"+e,t.hasOwnProperty("matrix")&&(a.data.set(t.matrix),a.getTranslation(r),s.position=[r.x,r.y,r.z],a.getEulerAngles(r),s.rotation=[r.x,r.y,r.z],a.getScale(r),s.scale=[r.x,r.y,r.z]),t.hasOwnProperty("rotation")){const e=t.rotation;n.set(e[0],e[1],e[2],e[3]);const i=n.getEulerAngles();s.rotation=[i.x,i.y,i.z]}else s.rotation=[0,0,0];if(t.hasOwnProperty("translation")){const e=t.translation;s.position=e}else s.position=[0,0,0];if(t.hasOwnProperty("scale")){const e=t.scale;s.scale=e}else s.scale=[1,1,1];s.parent=null,s.children=[],s.resource_id=m.create(),o.push(s)})),e.nodes.map(((t,n)=>{const a=o[n];if(t.hasOwnProperty("mesh")){a.components={};const n=s[t.mesh];let r=[];const h=e.meshes[t.mesh];if(h&&h.primitives.length>0&&(r=h.primitives.map((t=>i[t.material]&&i[t.material].id))),a.components.render={asset:n.id,type:"asset",materialAssets:r},t.hasOwnProperty("skin")){const s=e.skins[t.skin];if(s){let t;t=void 0!==s.skeleton?s.skeleton:s.joints[0];const e=o[t].resource_id;a.components.render.rootBone=e}}}for(let e=0;t.children&&e<t.children.length;e++){const s=t.children[e];o[s].parent=a.resource_id,a.children.push(o[s].resource_id)}})),e.scenes.map(((t,e)=>{const s={parent:null,children:[],resource_id:m.create(),position:[0,0,0],scale:[1,1,1],rotation:[0,0,0],name:t.name};o.push(s);for(let e=0;e<t.nodes.length;e++){const i=t.nodes[e];s.children.push(o[i].resource_id)}}));const h={entities:{}};return o.forEach((t=>{h.entities[t.resource_id]=t})),h}patch(t,e){super.patch(t,e);var s=t.resource,i=s&&s.data;s.renders,s.materials;const n=function(t){return t.map((t=>{var e;return{id:t.id,name:t.name,variants:(null==(e=t.variantsData)?void 0:e.map((t=>({id:t.id,name:t.name,tags:t.tags||[],colorTag:t.colorTag}))))||[]}}))||[]};i.materialVariants&&(s.materialSchemes=n(i.materialVariants)),i.nodeVariants&&(s.nodeSchemes=n(i.nodeVariants))}}class Sf{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((t=>{e(null,t)})).catch((s=>{e("Error loading css resource: "+t.original+" ["+s+"]")}))}open(t,e){return e}patch(t,e){}}class wf{constructor(t,e,s){this._device=t,this._registry=e,this._loader=s}load(t,e,s){this.loadAssets(s,e)}open(t,e,s){return s?s.resource:null}patch(t,e){this.loadAssets(t,(function(s,i){s&&(e.fire("error",t),e.fire("error:"+t.id,s,t),t.fire("error",t))}))}getAssetIds(t){const e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(let s=0;s<6;++s)e[s+1]=t.data.textures[s];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e}compareAssetIds(t,e){return t&&e?parseInt(t,10)===t||"string"==typeof t?t===e:t.url===e.url:null!==t==(null!==e)}update(t,e,s){const i=t.data||{},n=t._handlerState.assets,a=t._resources;let r,o,h;const l=[null,null,null,null,null,null,null],c=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?Yn:Xn:null};if(t.loaded&&s[0]===n[0])l[1]=a[1]||null,l[2]=a[2]||null,l[3]=a[3]||null,l[4]=a[4]||null,l[5]=a[5]||null,l[6]=a[6]||null;else if(s[0])for(r=s[0].resource,h=0;h<6;++h)l[h+1]=new Mr(this._device,{name:t.name+"_prelitCubemap"+(r.width>>h),cubemap:!0,type:c()||r.type,width:r.width>>h,height:r.height>>h,format:r.format,levels:[r._levels[h]],fixCubemapSeams:!0,addressU:Ws,addressV:Ws,mipmaps:0===h});const d=s.slice(1);if(t.loaded&&this.cmpArrays(d,n.slice(1)))l[0]=a[0]||null;else if(-1===d.indexOf(null)){const e=d.map((function(t){return t.resource})),n=[];for(o=0;o<e[0]._levels.length;++o)n.push(e.map((function(t){return t._levels[o]})));const a=new Mr(this._device,{name:t.name+"_faces",cubemap:!0,type:c()||e[0].type,width:e[0].width,height:e[0].height,format:e[0].format,levels:n,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:e[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:e[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:Ws,addressV:Ws,fixCubemapSeams:!!s[0]});l[0]=a}if(!this.cmpArrays(l,a))for(t.resources=l,t._handlerState.assetIds=e,t._handlerState.assets=s,h=0;h<a.length;++h)null!==a[h]&&-1===l.indexOf(a[h])&&a[h].destroy();for(h=0;h<n.length;++h)null!==n[h]&&-1===s.indexOf(n[h])&&n[h].unload()}cmpArrays(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}resolveId(t){const e=parseInt(t,10);return e===t||e.toString()===t?e:t}loadAssets(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(t),n=[null,null,null,null,null,null,null],a=t._handlerState.assetIds,r=t._handlerState.assets,o=s._registry;let h=7;const l=function(a,r){n[a]=r,h--,0===h&&(s.update(t,i,n),e(null,t.resources))},c=function(t,s,i){e(s)},d=function(t,e){e.loaded?l(t,e):(o.once("load:"+e.id,l.bind(s,t)),o.once("error:"+e.id,c.bind(s,t)),e.loading||o.load(e))};let u;for(let e=0;e<7;++e){const n=this.resolveId(i[e]);if(n)if(s.compareAssetIds(n,a[e]))l(e,r[e]);else if(parseInt(n,10)===n)u=o.get(n),u?d(e,u):setTimeout(function(t,e){const s=o.get(e);s?d(t,s):c(0,"failed to find dependent cubemap asset="+e)}.bind(null,e,n));else{const i="string"==typeof n?{url:n,filename:n}:n;u=new wm(t.name+"_part_"+e,"texture",i),o.add(u),o.once("load:"+u.id,l.bind(s,e)),o.once("error:"+u.id,c.bind(s,e)),o.load(u)}else l(e,null)}}}class Mf{load(t,e){e(null,null)}open(t,e){return e}}function Tf(t){return t.version<3&&(t.version<2&&(t.info.maps=t.info.maps||[{width:t.info.width,height:t.info.height}]),t.chars=Object.keys(t.chars||{}).reduce((function(e,s){const i=t.chars[s],n=void 0!==i.letter?i.letter:L.fromCodePoint(s);return t.version<2&&(i.map=i.map||0),e[n]=i,e}),{}),t.version=3),t}class Af{constructor(t){this._loader=t,this.maxRetries=0}load(t,e,s){"string"==typeof t&&(t={load:t,original:t});const i=this;".json"===f.getExtension(t.original)?j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((s=>{var n=Tf(s);i._loadTextures(t.load.replace(".json",".png"),n,(function(t,s){if(t)return e(t);e(null,{data:n,textures:s})}))})).catch((s=>{e("Error loading font resource: "+t.original+" ["+s+"]")})):(s&&s.data&&(s.data=Tf(s.data)),this._loadTextures(t.load,s&&s.data,e))}_loadTextures(t,e,s){const i=e.info.maps.length;let n=0,a=null;const r=new Array(i),o=this._loader,h=function(e){const h=function(t,o){if(!a){if(t)return a=t,s(t);o.upload(),r[e]=o,n++,n===i&&s(null,r)}};0===e?o.load(t,"texture",h):o.load(t.replace(".png",e+".png"),"texture",h)};for(let t=0;t<i;t++)h(t)}open(t,e,s){let i;return i=e.textures?new kp(e.textures,e.data):new kp(e,null),i}patch(t,e){const s=t.resource;!s.data&&t.data?s.data=t.data:!t.data&&s.data&&(t.data=s.data),t.data&&(t.data=Tf(t.data))}}const Cf=function(t,e,s){const i=s.singleVecs;let n,a;const r=e.___1;r||(n=s.tripleVecs,a=e.___2);let o=r?r[0]:n[a];t.setLocalPosition(i[o],i[o+1],i[o+2]),o=r?r[1]:n[a+1],t.setLocalEulerAngles(i[o],i[o+1],i[o+2]),o=r?r[2]:n[a+2],t.setLocalScale(i[o],i[o+1],i[o+2])},Pf=function(t,e){const s=t.charCodeAt(0)-e.fieldFirstCode;return e.fieldArray[s]},Rf=function(t,e){let s=0;for(let i=0;i<t.length;i++)s=s*e.fieldCodeBase+t.charCodeAt(i)-e.fieldFirstCode;return e.fieldArray[s]};class Ef{constructor(t,e){this._node=t,this._data=e}run(){const t=Object.prototype.toString.call(this._node);return"[object Object]"===t?this._handleMap():"[object Array]"===t?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={};Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(t){let e=t;const s=t.length;1===s?e=Pf(t,this._data):2===s&&(e=Rf(t,this._data)),this._result[e]=new Ef(this._node[t],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(t){const e=new Ef(t,this._data).run();this._result.push(e)}}class Lf{constructor(t,e){this._app=t,this._isTemplate=e}parse(t){const e={};let s=null;const i=t.compressedFormat;i&&!t.entDecompressed&&(t.entDecompressed=!0,t.entities=new Ef(t.entities,i).run());for(const n in t.entities){const a=t.entities[n],r=this._createEntity(a,i);e[n]=r,null===a.parent&&(s=r)}for(const s in t.entities){const i=e[s],n=t.entities[s].children,a=n.length;for(let t=0;t<a;t++){const s=e[n[t]];s&&i.addChild(s)}}return this._openComponentData(s,t.entities),s}_createEntity(t,e){const s=new ld;if(s.name=t.name,s.setGuid(t.resource_id),this._setPosRotScale(s,t,e),s._enabled=void 0===t.enabled||t.enabled,this._isTemplate?s._template=!0:s._enabledInHierarchy=s._enabled,s.template=t.template,t.tags)for(let e=0;e<t.tags.length;e++)s.tags.add(t.tags[e]);return t.labels&&t.labels.forEach((function(t){s.addLabel(t)})),s}_setPosRotScale(t,e,s){if(s)Cf(t,e,s);else{const s=e.position,i=e.rotation,n=e.scale;t.setLocalPosition(s[0],s[1],s[2]),t.setLocalEulerAngles(i[0],i[1],i[2]),t.setLocalScale(n[0],n[1],n[2])}}_openComponentData(t,e){const s=e[t.getGuid()];for(const e in s.components)s.components[e]&&t.addComponent(e,s.components[e]);let i=s.children.length;const n=t._children;for(let t=0;t<i;t++)n[t]=this._openComponentData(n[t],e);return t}}const If={load:function(t,e,s){"string"==typeof t&&(t={load:t,original:t}),j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((t=>{s(null,t)})).catch((e=>{let i="Error while loading scene JSON "+t.original;e.message?(i+=": "+e.message,e.stack&&(i+="\n"+e.stack)):i+=": "+e,s(i)}))}};class Df{constructor(t){this._app=t,this.maxRetries=0}load(t,e){If.load(t,this.maxRetries,e)}open(t,e){this._app.systems.script.preloading=!0;const s=new Lf(this._app,!1).parse(e);return this._app.systems.script.preloading=!1,s}}class Ff{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((t=>{e(null,t)})).catch((s=>{e("Error loading html resource: "+t.original+" ["+s+"]")}))}open(t,e){return e}patch(t,e){}}class Of{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=H.ResponseType.JSON),j.get(t.load,s).then((t=>{e(null,t)})).catch((s=>{e("Error loading JSON resource: "+t.original+" ["+s+"]")}))}open(t,e){return e}patch(t,e){}}class kf{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([ke,Be,ze]),cull:this._createEnumValidator([oi,hi,li,ci]),blendType:this._createEnumValidator([Tt,At,Ct,Pt,Rt,Et,Lt,It,Dt,Ft,Ot]),shadingModel:this._createEnumValidator([Me,Te])}}setInvalid(t,e){this.valid=!1,this.removeInvalid&&delete e[t]}validate(t){const e=ko,s="path"===t.mappingFormat;for(const i in t){const n=e[i];if(n)if(n.startsWith("enum")){const e=n.split(":")[1];this.enumValidators[e]&&(this.enumValidators[e](t[i])||this.setInvalid(i,t))}else if("number"===n)"number"!=typeof t[i]&&this.setInvalid(i,t);else if("boolean"===n)"boolean"!=typeof t[i]&&this.setInvalid(i,t);else if("string"===n)"string"!=typeof t[i]&&this.setInvalid(i,t);else if("vec2"===n)t[i]instanceof Array&&2===t[i].length||this.setInvalid(i,t);else if("rgb"===n)t[i]instanceof Array&&3===t[i].length||this.setInvalid(i,t);else if("texture"===n)s?"string"==typeof t[i]||t[null===i]||t[i]instanceof Mr||this.setInvalid(i,t):"number"!=typeof t[i]&&null!==t[i]&&(t[i]instanceof Mr||this.setInvalid(i,t));else if("boundingbox"===n)t[i].center&&t[i].center instanceof Array&&3===t[i].center.length||this.setInvalid(i,t),t[i].halfExtents&&t[i].halfExtents instanceof Array&&3===t[i].halfExtents.length||this.setInvalid(i,t);else if("cubemap"===n)"number"!=typeof t[i]&&null!==t[i]&&void 0!==t[i]&&(t[i]instanceof Mr&&t[i].cubemap||this.setInvalid(i,t));else if("chunks"===n){const e=Object.keys(t[i]);for(let s=0;s<e.length;s++)"string"!=typeof t[i][e[s]]&&this.setInvalid(e[s],t[i])}else console.error("Unknown material type: "+n);else this.valid=!1}return t.validated=!0,this.valid}_createEnumValidator(t){return function(e){return t.indexOf(e)>=0}}}class Bf{constructor(){this._validator=null}parse(t){const e=this.migrate(t),s=this._validate(e),i=new Wo;return this.initialize(i,s),i}initialize(t,e){e.validated||(e=this._validate(e)),e.chunks&&(t.chunks=U({},e.chunks));for(const s in e){const i=ko[s],n=e[s];if("vec2"===i)t[s]=new st(n[0],n[1]);else if("rgb"===i)t[s]=new J(n[0],n[1],n[2]);else if("texture"===i)n instanceof Mr?t[s]=n:t[s]instanceof Mr&&"number"==typeof n&&n>0||(t[s]=null);else if("cubemap"===i)n instanceof Mr?t[s]=n:t[s]instanceof Mr&&"number"==typeof n&&n>0||(t[s]=null),"cubeMap"!==s||n||(t.prefilteredCubemaps=null);else if("boundingbox"===i){const e=new it(n.center[0],n.center[1],n.center[2]),i=new it(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]);t[s]=new bt(e,i)}else t[s]=e[s]}t.update()}migrate(t){let e;void 0===t.shadingModel&&("blinn"===t.shader?t.shadingModel=Te:t.shadingModel=Me),t.shader&&delete t.shader,t.mapping_format&&(t.mappingFormat=t.mapping_format,delete t.mapping_format);const s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(e=0;e<s.length;e++){const i=s[e][0],n=s[e][1];void 0!==t[i]&&void 0===t[n]&&(t[n]=t[i],delete t[i])}const i=["fresnelFactor","shadowSampleType"];for(e=0;e<i.length;e++){const s=i[e];t.hasOwnProperty(s)&&delete t[s]}return t}_validate(t){return t.validated||(this._validator||(this._validator=new kf),this._validator.validate(t)),t}}var zf,Uf={name:"string",baseColor:"rgb",baseColorMap:"texture",baseColorMapUv:"number",baseColorMapOffset:"vec2",baseColorMapScale:"vec2",opacity:"number",opacityMap:"texture",opacityMapUv:"number",opacityMapOffset:"vec2",opacityMapScale:"vec2",metallic:"number",metallicMap:"texture",metallicMapUv:"number",metallicMapOffset:"vec2",metallicMapScale:"vec2",roughness:"number",roughnessMap:"texture",roughnessMapUv:"number",roughnessMapOffset:"vec2",roughnessMapScale:"vec2",normalMap:"texture",normalMapOffset:"vec2",normalMapScale:"vec2",normalMapUv:"number",normalScale:"number",occlusionMap:"texture",occlusionMapUv:"number",occlusionMapOffset:"vec2",occlusionMapScale:"vec2",occlusionStrength:"number",emissive:"rgb",emissiveMap:"texture",emissiveMapUv:"number",emissiveMapOffset:"vec2",emissiveMapScale:"vec2",alphaCutoff:"number",doubleSided:"boolean",alphaMode:"number",clearcoat:"number",clearcoatMap:"texture",clearcoatMapUv:"number",clearcoatMapOffset:"vec2",clearcoatMapScale:"vec2",clearcoatRoughness:"number",clearcoatRoughnessMap:"texture",clearcoatRoughnessMapUv:"number",clearcoatRoughnessMapOffset:"vec2",clearcoatRoughnessMapScale:"vec2",clearcoatNormalScale:"number",clearcoatNormalMap:"texture",clearcoatNormalMapUv:"number",clearcoatNormalMapOffset:"vec2",clearcoatNormalMapScale:"vec2"},Vf=[];for(zf in Uf)"texture"===Uf[zf]&&Vf.push(zf);class Nf{constructor(t,e,s,i,n){this.propertyName=t,this.parent=e,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)}_onAdd(t){this.asset=t,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)}_onRemove(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t),this.asset=null}_onUnload(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)}get id(){return this._id}set id(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}get url(){return this._url}set url(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}destroy(){}}class Wf{constructor(){}parse(t){let e=new Mu;return this.initialize(e,t),e}initialize(t,e){let s=wu;for(let i=0;i<s.length;i++){let n=s[i].type,a=s[i].name;const r=e[a];switch(n){case"string":case"number":case"boolean":void 0!==e[a]&&(t[a]=e[a]);break;case"Cubemap":case"Texture":r instanceof Mr?t[a]=r:t[a]instanceof Mr&&r||(t[a]=null);break;case"Color":void 0!==e[a]&&(t[a]=new J(e[a]));break;case"Vec2":void 0!==e[a]&&(t[a]=new st(e[a]))}}t.update()}migrate(t){return t}}const Gf={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};class Hf{constructor(t){this._assets=t.assets,this._device=t.graphicsDevice,this._placeholderTextures=null,this._parser={standard:new Bf,pbr:new Wf},this.maxRetries=0}load(t,e){e(null,null)}_isStandard(t){return this._getParser(t)==this._parser.standard}_getParser(t){return t.alphaMode?this._parser.pbr:this._parser.standard}open(t,e){const s=this._getParser(e).parse(e);return e._engine&&(s._data=e,delete e._engine),s}_createPlaceholders(){this._placeholderTextures={};const t={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(const e in t){if(!t.hasOwnProperty(e))continue;this._placeholderTextures[e]=new Mr(this._device,{width:2,height:2,format:Li}),this._placeholderTextures[e].name="placeholder";const s=this._placeholderTextures[e].lock();for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[4*i+n]=t[e][n];this._placeholderTextures[e].unlock()}}patch(t,e){t.resource._data&&(t._data=t.resource._data,delete t.resource._data),t.data.name=t.name,t.resource.name=t.name,this._bindAndAssignAssets(t,e),t.off("unload",this._onAssetUnload,this),t.on("unload",this._onAssetUnload,this)}_onAssetUnload(t){delete t.data.parameters,delete t.data.chunks,delete t.data.name}_assignTexture(t,e,s){e.resource[t]=s}_getPlaceholderTexture(t){this._placeholderTextures||this._createPlaceholders();const e=Gf[t];return this._placeholderTextures[e]}_assignPlaceholderTexture(t,e){e.resource[t]=this._getPlaceholderTexture(t,e)}_onTextureLoad(t,e,s){this._assignTexture(t,e,s.resource),e.resource.update()}_onTextureAdd(t,e,s){this._assets.load(s)}_onTextureRemoveOrUnload(t,e,s){const i=e.resource;i&&e.resource[t]===s.resource&&(this._assignPlaceholderTexture(t,e),i.update())}_assignCubemap(t,e,s){e.resource[t]=s[0],"cubeMap"===t&&(e.resource.prefilteredCubemaps=s.slice(1))}_onCubemapLoad(t,e,s){this._assignCubemap(t,e,s.resources),this._getParser(e.data).initialize(e.resource,e.data)}_onCubemapAdd(t,e,s){e.data.shadingModel===Me&&(e.loadFaces=!0),this._assets.load(s)}_onCubemapRemoveOrUnload(t,e,s){const i=e.resource;e.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(t,e,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(t,e){const s=this._getParser(t.data).migrate(t.data),i=t.resource,n="path"===s.mappingFormat,a=this._isStandard(s)?Bo:Vf;let r,o,h;for(r=0;r<a.length;r++){o=a[r],h=i._assetReferences[o];const l=s[o],c=i[o],d=c===this._getPlaceholderTexture(o,t),u=s.validated;!l||c&&u&&!d?h&&(n?h.url=null:h.id=null):(h||(h=new Nf(o,t,e,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[o]=h),n?h.url=t.getAbsoluteUrl(l):h.id=l,h.asset&&(h.asset.resource?this._assignTexture(o,t,h.asset.resource):this._assignPlaceholderTexture(o,t),e.load(h.asset)))}const l=zo;for(r=0;r<l.length;r++)o=l[r],h=i._assetReferences[o],s[o]&&!t.data.prefilteredCubeMap128&&(h||(h=new Nf(o,t,e,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[o]=h),n?h.url=s[o]:h.id=s[o],h.asset&&(h.asset.loaded&&this._assignCubemap(o,t,h.asset.resources),e.load(h.asset)));this._getParser(s).initialize(i,s)}}function jf(t){const e=this;if(!e.resource)return;const s=t.resource,i=s.renders&&s.renders[e.data.renderIndex];i&&(e.resource.meshes=i.resource.meshes)}function qf(t){const e=this;e.registry.off("load:"+t.id,jf,e),e.registry.on("load:"+t.id,jf,e),e.registry.off("remove:"+t.id,Xf,e),e.registry.once("remove:"+t.id,Xf,e),t.resource?jf.call(e,t):e.registry.load(t)}function Xf(t){const e=this;e.registry.off("load:"+t.id,jf,e),e.resource&&e.resource.destroy()}class Yf{constructor(t){this._registry=t}load(t,e,s){}open(t,e){return new cm}patch(t,e){if(!t.data.containerAsset)return;const s=e.get(t.data.containerAsset);s?qf.call(t,s):e.once("add:"+t.data.containerAsset,qf,t)}}class Kf{load(t,e,s){throw new Error("not implemented")}open(t,e,s){throw new Error("not implemented")}patch(t,e){}}class $f{constructor(t){this._handlers={},this._requests={},this._cache={},this._app=t}addHandler(t,e){this._handlers[t]=e,e._loader=this}removeHandler(t){delete this._handlers[t]}getHandler(t){return this._handlers[t]}load(t,e,s,i){const n=this._handlers[e];if(!n){return void s("No handler for asset type: "+e)}if(!t)return void this._loadNull(n,s,i);const a=t+e;if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const e=this,r=function(t,s){t?e._onFailure(a,t):n.load(s,(function(t,r,o){if(e._requests[a])if(t)e._onFailure(a,t);else try{e._onSuccess(a,n.open(s.original,r,i),o)}catch(t){e._onFailure(a,t)}}),i)},o=t.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(o)){if(!this._app.bundles.canLoadUrl(o))return void r(`Bundle for ${t} not loaded yet`);this._app.bundles.loadUrl(o,(function(t,e){r(t,{load:e,original:o})}))}else r(null,{load:t,original:i&&i.file.filename||t})}}_loadNull(t,e,s){t.load(null,(function(i,n,a){if(i)e(i);else try{e(null,t.open(null,n,s),a)}catch(t){e(t)}}),s)}_onSuccess(t,e,s){this._cache[t]=e;for(let i=0;i<this._requests[t].length;i++)this._requests[t][i](null,e,s);delete this._requests[t]}_onFailure(t,e){if(console.error(e),this._requests[t]){for(let s=0;s<this._requests[t].length;s++)this._requests[t][s](e);delete this._requests[t]}}open(t,e){const s=this._handlers[t];return s?s.open(null,e):(console.warn("No resource handler found for: "+t),e)}patch(t,e){const s=this._handlers[t.type];s?s.patch&&s.patch(t,e):console.warn("No resource handler found for: "+t.type)}clearCache(t,e){delete this._cache[t+e]}getFromCache(t,e){if(this._cache[t+e])return this._cache[t+e]}enableRetry(t=5){t=Math.max(0,t)||0;for(const e in this._handlers)this._handlers[e].maxRetries=t}disableRetry(){for(const t in this._handlers)this._handlers[t].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}let Zf=!1,Jf=!1;const Qf={app:null,create:function(t,e){if(!Zf)return;const s=e(Qf.app);s._pcScriptName=t,t_._push(s),this.fire("created",t,e)},attribute:function(t,e,s,i){},createLoadingScreen:function(t){if(Jf)return;Jf=!0;t(Fh())}};Object.defineProperty(Qf,"legacy",{get:function(){return Zf},set:function(t){Zf=t}}),p.attach(Qf);class t_{constructor(t){this._app=t,this._scripts={},this._cache={}}static _push(t){Qf.legacy&&t_._types.length>0||t_._types.push(t)}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this;Qf.app=this._app,this._loadScript(t.load,((t,i,n)=>{if(t)e(t);else if(Qf.legacy){let t=null;t_._types.length&&(t=t_._types.pop()),t?this._scripts[i]=t:t=null,e(null,t,n)}else{const t={};for(let e=0;e<t_._types.length;e++)t[t_._types[e].name]=t_._types[e];t_._types.length=0,e(null,t,n),delete s._loader._cache[i+"script"]}}))}open(t,e){return e}patch(t,e){}_loadScript(t,s){"string"==typeof t&&(t={load:t,original:t});const i={retry:this.maxRetries>0,maxRetries:this.maxRetries};j.get(t.load,i).then((i=>{const n=e.polyfill.document.head,a=e.polyfill.document.createElement("script");this._cache[t]=a,a.async=!1,a.addEventListener("error",(function(t){s(`Script: ${t.target.src} failed to load`)}),!1);let r=!1;a.onload=a.onreadystatechange=function(){r||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(r=!0,s(null,t,a))},a.src=i,n.appendChild(a)})).catch((e=>{s("Error loading JSON resource: "+t.original+" ["+e+"]")}))}}t_._types=[];class e_{constructor(t){this._app=t,this.maxRetries=0}load(t,e){If.load(t,this.maxRetries,e)}open(t,e){this._app.systems.script.preloading=!0;const s=new Lf(this._app,!1).parse(e),i=this._app.scene;return i.root=s,this._app.applySceneSettings(e.settings),this._app.systems.script.preloading=!1,i}patch(t,e){}}class s_{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((t=>{e(null,t)})).catch((s=>{e("Error loading shader resource: "+t.original+" ["+s+"]")}))}open(t,e){return e}patch(t,e){}}function i_(t){const e=this;e.resource&&(e.resource.atlas=t.resource)}function n_(t){this.registry.load(t)}class a_{constructor(t,e){this._assets=t,this._device=e,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),".json"===f.getExtension(t.original)&&j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((t=>{e(null,t)})).catch((t=>{e(t)}))}open(t,e){const s=new Lu(this._device);return t&&(s.__data=e),s}patch(t,e){const s=t.resource;if(s.__data&&(t.data.pixelsPerUnit=s.__data.pixelsPerUnit,t.data.renderMode=s.__data.renderMode,t.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){const i=e.getByUrl(s.__data.textureAtlasAsset);i?t.data.textureAtlasAsset=i.id:console.warn("Could not find textureatlas with url: "+s.__data.textureAtlasAsset)}s.startUpdate(),s.renderMode=t.data.renderMode,s.pixelsPerUnit=t.data.pixelsPerUnit,s.frameKeys=t.data.frameKeys,this._updateAtlas(t),s.endUpdate(),t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}_updateAtlas(t){const e=t.resource;if(!t.data.textureAtlasAsset)return void(e.atlas=null);this._assets.off("load:"+t.data.textureAtlasAsset,i_,t),this._assets.on("load:"+t.data.textureAtlasAsset,i_,t);const s=this._assets.get(t.data.textureAtlasAsset);s&&s.resource?e.atlas=s.resource:s?this._assets.load(s):(this._assets.off("add:"+t.data.textureAtlasAsset,n_,t),this._assets.on("add:"+t.data.textureAtlasAsset,n_,t))}_onAssetChange(t,e,s,i){"data"===e&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,i_,t),this._assets.off("add:"+i.textureAtlasAsset,n_,t))}}class r_{constructor(t,e){this._app=t,this._data=e,this._templateRoot=null}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){const t=new Lf(this._app,!0);this._templateRoot=t.parse(this._data)}}class o_{constructor(t){this._app=t,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),this._app.assets,j.get(t.load).then((t=>{e(null,t)})).catch((s=>{e("Error requesting template: "+t.original)}))}open(t,e){return new r_(this._app,e)}}class h_{constructor(){this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((t=>{e(null,t)})).catch((s=>{e("Error loading text resource: "+t.original+" ["+s+"]")}))}open(t,e){return e}patch(t,e){}}class l_{constructor(t,e){this.device=e,this.maxRetries=0}load(t,e,s){const i=this.device;wm.fetchArrayBuffer(t.load,((n,a)=>{n?e(n):(n=>{var a,r,o;om(i,t.load,n,e,{isGGGR:0!=(8&(null==s||null==(a=s.file)||null==(r=a.variants)||null==(o=r.basis)?void 0:o.opt))})||e(`Basis module not found. Asset '${s.name}' basis texture variant will not be loaded.`)})(a)}),s,this.maxRetries)}open(t,e,s){var i=new Mr(s,{name:t,addressU:e.cubemap?Ws:Ns,addressV:e.cubemap?Ws:Ns,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels});return i.upload(),i}}class c_{constructor(t){this.crossOrigin=t.prefix?"anonymous":null,this.maxRetries=0,this.useImageBitmap=!1}load(t,s,i){var n;const a=!(null==i||null==(n=i.file)||!n.contents);a&&(t={load:e.polyfill.URL.createObjectURL(new e.polyfill.Blob([i.file.contents],{type:"image/"+f.getExtension(t.original).toLowerCase().slice(1)})),original:t.original});const r=(i,n)=>{a&&e.polyfill.URL.revokeObjectURL(t.load),s(i,n)};let o;i&&i.options&&i.options.hasOwnProperty("crossOrigin")?o=i.options.crossOrigin:ym.test(t.load)&&(o=this.crossOrigin),this.useImageBitmap?this._loadImageBitmap(t.load,t.original,o,r):this._loadImage(t.load,t.original,o,r)}open(t,e,s){const i=f.getExtension(t).toLowerCase(),n=".jpg"===i||".jpeg"===i?Ei:Li,a=new Mr(s,{name:t,width:e.width,height:e.height,format:n});return a.setSource(e),a}_loadImage(t,s,i,n){const a=new e.polyfill.Image;i&&(a.crossOrigin=i),this.maxRetries,wm.fetchArrayBuffer(t,((t,s)=>{if(t)return void n(t);const a=e.polyfill.URL.createObjectURL(new e.polyfill.Blob([s])),r=new e.polyfill.Image;i&&(r.crossOrigin=i),r.src=a,r.onload=()=>{e.polyfill.URL.revokeObjectURL(a),n(null,r)}}))}_loadImageBitmap(t,s,i,n){const a={responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};j.get(t,a).then((t=>{e.polyfill.createImageBitmap(t,{premultiplyAlpha:"none"}).then((function(t){n(null,t)})).catch((function(t){n(t)}))})).catch((t=>{n(t)}))}}const d_=[1481919403,3140563232,169478669],u_={33776:Ii,33778:Di,33779:Fi,36196:ji,37492:qi,37496:Xi,35840:$i,35841:Yi,35842:Zi,35843:Ki,32849:Ei,32856:Li,35905:Gi,35907:Hi,35898:Wi,34843:Oi,34842:ki};class p_{constructor(t){this.maxRetries=0}load(t,e,s){wm.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=this.parse(e);if(!i)return null;const n=new Mr(s,{name:t,addressU:i.cubemap?Ws:Ns,addressV:i.cubemap?Ws:Ns,width:i.width,height:i.height,format:i.format,cubemap:i.cubemap,levels:i.levels});return n.upload(),n}parse(t){const e=new Uint32Array(t);if(d_[0]!==e[0]||d_[1]!==e[1]||d_[2]!==e[2])return null;const s={endianness:e[3],glType:e[4],glTypeSize:e[5],glFormat:e[6],glInternalFormat:e[7],glBaseInternalFormat:e[8],pixelWidth:e[9],pixelHeight:e[10],pixelDepth:e[11],numberOfArrayElements:e[12],numberOfFaces:e[13],numberOfMipmapLevels:e[14],bytesOfKeyValueData:e[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;const i=u_[s.glInternalFormat];if(void 0===i)return null;let n=16+s.bytesOfKeyValueData/4;const a=s.numberOfFaces>1,r=[];for(let c=0;c<(s.numberOfMipmapLevels||1);c++){const s=e[n++];a&&r.push([]);const d=a?r[c]:r;for(let e=0;e<(a?6:1);++e)d.push((o=t,h=4*n,l=s,i===Wi?new Uint32Array(o,h,l/4):new Uint8Array(o,h,l))),n+=s+3>>2}var o,h,l;return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:r,cubemap:a}}}const m_=166;class f_{constructor(t,e){this.maxRetries=0,this.device=e}load(t,e,s){wm.fetchArrayBuffer(t.load,((i,n)=>{i?e(i,n):this.parse(n,t,e,s)}),s,this.maxRetries)}open(t,e,s){const i=new Mr(s,{name:t,addressU:e.cubemap?Ws:Ns,addressV:e.cubemap?Ws:Ns,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels});return i.upload(),i}typedArrayToBuffer(t){return t.buffer.slice(t.byteOffset,t.byteLength+t.byteOffset)}parse(t,e,s,i){const n=new D(t),a=[n.readU32be(),n.readU32be(),n.readU32be()];if(2873840728!==a[0]||540160187!==a[1]||218765834!==a[2])return null;const r={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},h=[];for(let t=0;t<Math.max(1,r.levelCount);++t)h.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);const l=n.readU8();if(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===r.supercompressionScheme||l===m_){var c,d,u;om(this.device,e.load,t,s,{isGGGR:0!=(8&(null==i||null==(c=i.file)||null==(d=c.variants)||null==(u=d.basis)?void 0:u.opt)),isKTX2:!0})||s('Basis module not found. Asset "'+i.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}class __{constructor(t){this.maxRetries=0}load(t,e,s){wm.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=new Uint32Array(e,0,32),n=i[4],a=i[3],r=Math.max(i[7],1),o=4===i[20],h=i[21],l=i[22],c=65024===i[28],d=827611204,u=825438800,p=825439312;let m,f=!1,_=!1,g=!1,y=!1,v=null,x=1;if(o?h===d?(v=Ii,f=!0):894720068===h?(v=Fi,f=!0):113===h?(v=ki,x=2):116===h?(v=zi,x=4):826496069===h?(v=ji,f=!0,_=!0):h===u||825504336===h?(v=h===u?Yi:Ki,f=!0,g=!0):h!==p&&825504848!==h||(v=h===p?$i:Zi,f=!0,y=!0):32===l&&(v=Li),!v)return m=new Mr(s,{width:4,height:4,format:Ei}),m.name="dds-legacy-empty",m;m=new Mr(s,{name:t,addressU:c?Ws:Ns,addressV:c?Ws:Ns,width:n,height:a,format:v,cubemap:c,mipmaps:r>1});let b=128;const S=c?6:1;let w;const M=h===d?8:16;let T,A,C;for(let t=0;t<S;t++){let s=n,i=a;for(let n=0;n<r;n++){f?_?w=Math.floor((s+3)/4)*Math.floor((i+3)/4)*8:g?w=Math.max(s,16)*Math.max(i,8)/4:y?w=Math.max(s,8)*Math.max(i,8)/2:(T=Math.floor((s+4-1)/4),A=Math.floor((i+4-1)/4),C=T*A,w=C*M):w=s*i*4;const a=v===zi?new Float32Array(e,b,w):v===ki?new Uint16Array(e,b,w):new Uint8Array(e,b,w);c?(m._levels[n]||(m._levels[n]=[]),m._levels[n][t]=a):m._levels[n]=a,b+=w*x,s=Math.max(.5*s,1),i=Math.max(.5*i,1)}}return m.upload(),m}}class g_{constructor(t){this.maxRetries=0}load(t,e,s){wm.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=this.parse(e);if(!i)return null;const n=new Mr(s,{name:t,addressU:Ns,addressV:Ws,minFilter:pi,magFilter:di,width:i.width,height:i.height,levels:i.levels,format:Li,type:Kn,mipmaps:!1});return n.upload(),n}parse(t){const e=new D(t);if(!e.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const t=e.readLine();if(0===t.length)break;{const e=t.split("=");2===e.length&&(s[e[0]]=e[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const i=e.readLine().split(" ");if(4!==i.length)return null;const n=parseInt(i[1],10),a=parseInt(i[3],10),r=this._readPixels(e,a,n,"-Y"===i[0]);return r?{width:a,height:n,levels:[r]}:null}_readPixels(t,e,s,i){if(e<8||e>32767)return this._readPixelsFlat(t,e,s);const n=[0,0,0,0];if(t.readArray(n),2!==n[0]||2!==n[1]||0!=(128&n[2]))return t.skip(-4),this._readPixelsFlat(t,e,s);const a=new ArrayBuffer(e*s*4),r=new Uint8Array(a);let o,h,l,c,d,u,p=i?0:4*e*(s-1);for(h=0;h<s;++h){if(h&&t.readArray(n),(n[2]<<8)+n[3]!==e)return null;for(c=0;c<4;++c)for(o=0;o<e;)if(d=t.readU8(),d>128){if(d-=128,o+d>e)return null;for(u=t.readU8(),l=0;l<d;++l)r[p+c+4*o++]=u}else{if(0===d||o+d>e)return null;for(l=0;l<d;++l)r[p+c+4*o++]=t.readU8()}p+=4*e*(i?1:-1)}return r}_readPixelsFlat(t,e,s){return t.remainingBytes===e*s*4?new Uint8Array(t.arraybuffer,t.offset):null}}const y_={repeat:Ns,clamp:Ws,mirror:Gs},v_={nearest:di,linear:ui,nearest_mip_nearest:pi,linear_mip_nearest:fi,nearest_mip_linear:mi,linear_mip_linear:_i},x_={default:Xn,rgbm:Yn,rgbe:Kn,swizzleGGGR:$n};class b_{constructor(t,e,s){this._device=t,this._assets=e,this._loader=s,this.imgParser=new c_(e),this.parsers={dds:new __(e),ktx:new p_(e),ktx2:new f_(e,t),basis:new l_(e,t),hdr:new g_(e)}}get crossOrigin(){return this.imgParser.crossOrigin}set crossOrigin(t){this.imgParser.crossOrigin=t}get maxRetries(){return this.imgParser.maxRetries}set maxRetries(t){this.imgParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=f.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.imgParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,s,i){if(t){var n=this._getParser(t,i).open(t,s,this._device);return null===n?n=new Mr(this._device,{width:4,height:4,format:Ei}):(!function(t){const s=Math.log2(Math.max(t._width,t._height))+1;if(t._format!==Li&&t._format!==zi||t._volume||t._compressed||1===t._levels.length||t._levels.length===s||(i=t._cubemap?t._levels[0][0]:t._levels[0])instanceof e.polyfill.HTMLCanvasElement||i instanceof e.polyfill.HTMLImageElement||i instanceof HTMLVideoElement)return;var i;const n=function(t,e,s){const i=Math.max(1,t>>1),n=Math.max(1,e>>1),a=new s.constructor(i*n*4),r=Math.floor(t/i),o=Math.floor(e/n),h=r*o;for(let e=0;e<n;++e)for(let n=0;n<i;++n)for(let l=0;l<4;++l){let c=0;for(let i=0;i<o;++i)for(let a=0;a<r;++a)c+=s[4*(n*r+a+(e*o+i)*t)+l];a[4*(n+e*i)+l]=c/h}return a};for(let e=t._levels.length;e<s;++e){const s=Math.max(1,t._width>>e-1),i=Math.max(1,t._height>>e-1);if(t._cubemap){const a=[];for(let r=0;r<6;++r)a.push(n(s,i,t._levels[e-1][r]));t._levels.push(a)}else t._levels.push(n(s,i,t._levels[e-1]))}t._levelsUpdated=t._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(n),s.unswizzledGGGR&&(i.file.variants.basis.opt&=-9)),n}}patch(t,e){const s=t.resource;if(!s)return;t.name&&t.name.length>0&&(s.name=t.name);const i=t.data;i&&i.hasOwnProperty("minfilter")&&(s.minFilter=v_[i.minfilter]),i&&i.hasOwnProperty("magfilter")&&(s.magFilter=v_[i.magfilter]),s.cubemap||(i&&i.hasOwnProperty("addressu")&&(s.addressU=y_[i.addressu]),i&&i.hasOwnProperty("addressv")&&(s.addressV=y_[i.addressv])),i&&i.hasOwnProperty("mipmaps")&&(s.mipmaps=i.mipmaps),i&&i.hasOwnProperty("anisotropy")&&(s.anisotropy=i.anisotropy),i&&i.hasOwnProperty("flipY")&&(s.flipY=!!i.flipY),i&&i.hasOwnProperty("type")?s.type=x_[i.type]:i&&i.hasOwnProperty("rgbm")&&i.rgbm?s.type=Yn:t.file&&0!=(8&t.file.opt)&&(s.type=$n)}}const S_={repeat:Ns,clamp:Ws,mirror:Gs},w_={nearest:di,linear:ui,nearest_mip_nearest:pi,linear_mip_nearest:fi,nearest_mip_linear:mi,linear_mip_linear:_i},M_=/^data\.frames\.(\d+)$/;class T_{constructor(t){this._loader=t,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this,i=this._loader.getHandler("texture");if(".json"!==f.getExtension(t.original))return i.load(t,e);j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((i=>{var n=t.original.replace(".json",".png");s._loader.load(n,"texture",(function(t,s){t?e(t):e(null,{data:i,texture:s})}))})).catch((t=>{e(t)}))}open(t,e){const s=new Du;if(e.texture&&e.data)s.texture=e.texture,s.__data=e.data;else{const i=this._loader.getHandler("texture").open(t,e);if(!i)return null;s.texture=i}return s}patch(t,e){t.resource.__data&&(void 0!==t.resource.__data.minfilter&&(t.data.minfilter=t.resource.__data.minfilter),void 0!==t.resource.__data.magfilter&&(t.data.magfilter=t.resource.__data.magfilter),void 0!==t.resource.__data.addressu&&(t.data.addressu=t.resource.__data.addressu),void 0!==t.resource.__data.addressv&&(t.data.addressv=t.resource.__data.addressv),void 0!==t.resource.__data.mipmaps&&(t.data.mipmaps=t.resource.__data.mipmaps),void 0!==t.resource.__data.anisotropy&&(t.data.anisotropy=t.resource.__data.anisotropy),void 0!==t.resource.__data.rgbm&&(t.data.rgbm=!!t.resource.__data.rgbm),t.data.frames=t.resource.__data.frames,delete t.resource.__data);const s=t.resource.texture;if(s&&(s.name=t.name,t.data.hasOwnProperty("minfilter")&&s.minFilter!==w_[t.data.minfilter]&&(s.minFilter=w_[t.data.minfilter]),t.data.hasOwnProperty("magfilter")&&s.magFilter!==w_[t.data.magfilter]&&(s.magFilter=w_[t.data.magfilter]),t.data.hasOwnProperty("addressu")&&s.addressU!==S_[t.data.addressu]&&(s.addressU=S_[t.data.addressu]),t.data.hasOwnProperty("addressv")&&s.addressV!==S_[t.data.addressv]&&(s.addressV=S_[t.data.addressv]),t.data.hasOwnProperty("mipmaps")&&s.mipmaps!==t.data.mipmaps&&(s.mipmaps=t.data.mipmaps),t.data.hasOwnProperty("anisotropy")&&s.anisotropy!==t.data.anisotropy&&(s.anisotropy=t.data.anisotropy),t.data.hasOwnProperty("rgbm"))){const e=t.data.rgbm?Yn:Xn;s.type!==e&&(s.type=e)}t.resource.texture=s;const i={};for(const e in t.data.frames){const s=t.data.frames[e];i[e]={rect:new nt(s.rect),pivot:new st(s.pivot),border:new nt(s.border)}}t.resource.frames=i,t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}_onAssetChange(t,e,s){let i;if("data"===e||"data.frames"===e){const e={};for(const t in s.frames)i=s.frames[t],e[t]={rect:new nt(i.rect),pivot:new st(i.pivot),border:new nt(i.border)};t.resource.frames=e}else{const n=e.match(M_);if(n){const e=n[1];s?(t.resource.frames[e]?(i=t.resource.frames[e],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):t.resource.frames[e]={rect:new nt(s.rect),pivot:new st(s.pivot),border:new nt(s.border)},t.resource.fire("set:frame",e,t.resource.frames[e])):t.resource.frames[e]&&(delete t.resource.frames[e],t.resource.fire("remove:frame",e))}}}}class A_{constructor(t=null){this._index={},this._key=t}addItem(t){const e=t.tags._list;for(const s of e)this.add(s,t)}removeItem(t){const e=t.tags._list;for(const s of e)this.remove(s,t)}add(t,e){this._index[t]&&-1!==this._index[t].list.indexOf(e)||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))}remove(t,e){if(!this._index[t])return;if(this._key&&!this._index[t].keys[e[this._key]])return;const s=this._index[t].list.indexOf(e);-1!==s&&(this._index[t].list.splice(s,1),this._key&&delete this._index[t].keys[e[this._key]],0===this._index[t].list.length&&delete this._index[t])}find(t){const e={},s=[];let i,n,a,r,o;const h=(t,e)=>this._index[t].list.length-this._index[e].list.length;for(let l=0;l<t.length;l++){if(n=t[l],n instanceof Array){if(0===n.length)continue;if(1!==n.length){o=!1;for(let t=0;t<n.length;t++)if(!this._index[n[t]]){o=!0;break}if(o)continue;a=n.slice(0).sort(h),r=a.slice(1),1===r.length&&(r=r[0]);for(let t=0;t<this._index[a[0]].list.length;t++)i=this._index[a[0]].list[t],(this._key?!e[i[this._key]]:-1===s.indexOf(i))&&i.tags.has(r)&&(this._key&&(e[i[this._key]]=!0),s.push(i));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(let t=0;t<this._index[n].list.length;t++)i=this._index[n].list[t],this._key?e[i[this._key]]||(e[i[this._key]]=!0,s.push(i)):-1===s.indexOf(i)&&s.push(i)}return s}}class C_ extends u{constructor(t){super(),this._loader=t,this._assets=[],this._cache={},this._names={},this._tags=new A_("_id"),this._urls={},this.prefix=null}list(t){return t=t||{},this._assets.filter((e=>{let s=!0;return void 0!==t.preload&&(s=e.preload===t.preload),s}))}add(t){const e=this._assets.push(t)-1;let s;this._cache[t.id]=e,this._names[t.name]||(this._names[t.name]=[]),this._names[t.name].push(e),t.file&&(s=t.file.url,this._urls[s]=e),t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire("add:"+t.id,t),s&&this.fire("add:url:"+s,t)}remove(t){const e=this._cache[t.id],s=t.file?t.file.url:null;if(void 0!==e){this._assets.splice(e,1),delete this._cache[t.id],this._names={},this._urls=[];for(let t=0,e=this._assets.length;t<e;t++){const e=this._assets[t];this._cache[e.id]=t,this._names[e.name]||(this._names[e.name]=[]),this._names[e.name].push(t),e.file&&(this._urls[e.file.url]=t)}return this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire("remove:"+t.id,t),s&&this.fire("remove:url:"+s,t),!0}return!1}get(t){const e=this._cache[t];return this._assets[e]}getByUrl(t){const e=this._urls[t];return this._assets[e]}load(t){if(t.loading||t.loaded)return;const s=t.file,i=e=>{e instanceof Array?t.resources=e:t.resource=e,this._loader.patch(t,this),this.fire("load",t),this.fire("load:"+t.id,t),s&&s.url&&this.fire("load:url:"+s.url,t),t.fire("load",t)},n=(s,n,a)=>{if(t.loaded=!0,t.loading=!1,s)this.fire("error",s,t),this.fire("error:"+t.id,s,t),t.fire("error",s,t);else{if(!Qf.legacy&&"script"===t.type){const s=this._loader.getHandler("script");s._cache[t.id]&&s._cache[t.id].parentNode===e.polyfill.document.head&&e.polyfill.document.head.removeChild(s._cache[t.id]),s._cache[t.id]=a}i(n)}};if(s||"cubemap"===t.type)this.fire("load:start",t),this.fire("load:"+t.id+":start",t),t.loading=!0,this._loader.load(t.getFileUrl(),t.type,n,t);else{const e=this._loader.open(t.type,t.data);t.loaded=!0,i(e)}}loadFromUrl(t,e,s){this.loadFromUrlAndFilename(t,null,e,s)}loadFromUrlAndFilename(t,e,s,i){const n=f.getBasename(e||t),a={filename:e||n,url:t};let r=this.getByUrl(t);if(r){if(r.loaded)return void i(r.loadFromUrlError||null,r)}else r=new wm(n,s,a),this.add(r);const o=t=>{t.once("load",(t=>{"material"===s?this._loadTextures(t,((e,s)=>{i(e,t)})):i(null,t)})),t.once("error",(e=>{e&&(this.loadFromUrlError=e),i(e,t)})),this.load(t)};r.resource?i(null,r):"model"===s?this._loadModel(r,o):o(r)}_loadModel(t,e){const s=t.getFileUrl(),i=f.getExtension(s);if(".json"===i||".glb"===i){const n=f.getDirectory(s),a=f.getBasename(s),r=f.join(n,a.replace(i,".mapping.json"));this._loader.load(r,"json",((s,i)=>{s?(t.data={mapping:[]},e(t)):this._loadMaterials(t,i,((s,n)=>{t.data=i,e(t)}))}))}else e(t)}_loadMaterials(t,e,s){const i=[];let n=0;const a=(t,e)=>{this._loadTextures(e,((t,a)=>{i.push(e),i.length===n&&s(null,i)}))};for(let s=0;s<e.mapping.length;s++){const i=e.mapping[s].path;if(i){n++;const e=t.getAbsoluteUrl(i);this.loadFromUrl(e,"material",a)}}0===n&&s(null,i)}_loadTextures(t,e){const s=[];let i=0;const n=t.data;if("path"!==n.mappingFormat)return void e(null,s);const a=(t,n)=>{t&&console.error(t),s.push(n),s.length===i&&e(null,s)},r=Bo;for(let e=0;e<r.length;e++){const s=n[r[e]];if(s&&"string"==typeof s){i++;const e=t.getAbsoluteUrl(s);this.loadFromUrl(e,"texture",a)}}0===i&&e(null,s)}findAll(t,e){const s=this._names[t];if(s){const t=s.map((t=>this._assets[t]));return e?t.filter((t=>t.type===e)):t}return[]}_onTagAdd(t,e){this._tags.add(t,e)}_onTagRemove(t,e){this._tags.remove(t,e)}findByTag(){return this._tags.find(arguments)}filter(t){return this._assets.filter((e=>t(e)))}find(t,e){const s=this.findAll(t,e);return s.length>0?s[0]:null}}class P_ extends u{constructor(t){super(),this._app=t,t.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}_bindDefaultAsset(){const t=this._app.assets.get(this._defaultAsset);t?this._onDefaultAssetAdd(t):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);const t=this._app.assets.get(this._defaultAsset);t&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleRemove,this),t.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(t){this._defaultAsset===t.id&&(t.on("add:localized",this._onLocaleAdd,this),t.on("remove:localized",this._onLocaleRemove,this),t.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(t){this._defaultAsset===t.id&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const t=this._app.assets.get(this._localizedAsset);t&&(t.on("load",this._onLocalizedAssetLoad,this),t.on("change",this._onLocalizedAssetChange,this),t.on("remove",this._onLocalizedAssetRemove,this),t.resource?this._onLocalizedAssetLoad(t):this._app.assets.load(t))}_unbindLocalizedAsset(){const t=this._app.assets.get(this._localizedAsset);t&&(t.off("load",this._onLocalizedAssetLoad,this),t.off("change",this._onLocalizedAssetChange,this),t.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(t){this._localizedAsset===t.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(t){this.fire("load",t)}_onLocalizedAssetChange(t,e,s,i){this.fire("change",t,e,s,i)}_onLocalizedAssetRemove(t){this._localizedAsset===t.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",t)}_onLocaleAdd(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)}_onLocaleRemove(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)}_onSetLocale(t){if(!this._defaultAsset)return void(this.localizedAsset=null);const e=this._app.assets.get(this._defaultAsset);if(!e||this._disableLocalization)return void(this.localizedAsset=this._defaultAsset);const s=e.getLocalizedAssetId(t);this.localizedAsset=s||this._defaultAsset}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}get defaultAsset(){return this._defaultAsset}set defaultAsset(t){const e=t instanceof wm?t.id:t;this._defaultAsset!==e&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=e,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get localizedAsset(){return this._localizedAsset}set localizedAsset(t){const e=t instanceof wm?t.id:t;if(this._localizedAsset!==e&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=e,this._localizedAsset)){this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}}get autoLoad(){return this._autoLoad}set autoLoad(t){this._autoLoad!==t&&(this._autoLoad=t,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get disableLocalization(){return this._disableLocalization}set disableLocalization(t){this._disableLocalization!==t&&(this._disableLocalization=t,this._onSetLocale(this._app.i18n.locale))}}const R_="FILL_WINDOW",E_="KEEP_ASPECT",L_="AUTO",I_="FIXED",D_=new jr;class F_{constructor(t,e,s){this.material=e,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Uh(t),this.meshInstance=null}addLines(t,e){const s=this.positions,i=t.length;for(let e=0;e<i;e++){const i=t[e];s.push(i.x,i.y,i.z)}const n=this.colors;if(e.length)for(let t=0;t<i;t++){const s=e[t];n.push(s.r,s.g,s.b,s.a)}else for(let t=0;t<i;t++)n.push(e.r,e.g,e.b,e.a)}addLinesArrays(t,e){this.positions.push(...t);const s=this.colors;if(e.length)s.push(...e);else{const i=t.length/3;for(let t=0;t<i;t++)s.push(e.r,e.g,e.b,e.a)}}onPreRender(){this.positions.length>0&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(sn,!1),this.meshInstance||(D_.worldTransform=dt.IDENTITY,D_._dirtyWorld=D_._dirtyNormal=!1,this.meshInstance=new dl(this.mesh,this.material,D_),this.meshInstance.cull=!1,this.layer.addMeshInstances([this.meshInstance],!0)),this.meshInstance.visible=!0)}onPostRender(){this.positions.length=0,this.colors.length=0,this.meshInstance.visible=!1}}class O_{constructor(t){this.device=t,this.map=new Map}getBatch(t,e){let s=this.map.get(t);return s||(s=new F_(this.device,t,e),this.map.set(t,s)),s}onPreRender(){this.map.forEach((t=>{t.onPreRender()}))}onPostRender(){this.map.forEach((t=>{t.onPostRender()}))}}const k_=[];class B_{constructor(t,e){this.device=t,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.usedGraphNodes=[],this.freeGraphNodes=[],this.batchesMap=new Map,this.allBatches=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map,e.on("prerender",this.onPreRender,this),e.on("postrender",this.onPostRender,this)}createMaterial(t){const e=new Jh;return e.vertexColors=!0,e.blend=!0,e.blendType=Ct,e.depthTest=t,e.update(),e}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(t,e){let s=this.batchesMap.get(t);s||(s=new O_(this.device),this.batchesMap.set(t,s)),this.allBatches.add(s);const i=e?this.materialDepth:this.materialNoDepth;return s.getBatch(i,t)}static getTextureVS(){return"\n\t\t\t\t\t\tattribute vec2 aPosition;\n\t\t\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\tvoid main(void) {\n\t\t\t\t\t\t\t\tgl_Position = matrix_model * vec4(aPosition, 0, 1);\n\t\t\t\t\t\t\t\tuv0 = aPosition.xy + 0.5;\n\t\t\t\t\t\t}\n\t\t\t\t"}getTextureShader(){if(!this.textureShader){const t={attributes:{aPosition:ln},vshader:B_.getTextureVS(),fshader:"\n\t\t\t\t\t\t\t\t\t\tprecision lowp float;\n\t\t\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\t\t\tuniform sampler2D colorMap;\n\t\t\t\t\t\t\t\t\t\tvoid main (void) {\n\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t"};this.textureShader=new sr(this.device,t)}return this.textureShader}getDepthTextureShader(){if(!this.depthTextureShader){const t=this.device.webgl2?"#define GL2":"",e={attributes:{aPosition:ln},vshader:B_.getTextureVS(),fshader:`\n\t\t\t\t\t\t\t\t\t\tprecision ${this.device.precision} float;\n\t\t\t\t\t\t\t\t\t\t${t}\n\t\t\t\t\t\t\t\t\t\t${ir.screenDepthPS}\n\t\t\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\t\t\t\t\t\t\t\tfloat depth = getLinearScreenDepth(uv0) * camera_params.x;\n\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = vec4(vec3(depth), 1.0);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t`};this.depthTextureShader=new sr(this.device,e)}return this.depthTextureShader}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Uh(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(on)),this.quadMesh}drawMesh(t,e,s,i,n){if(!i){const n=this.getGraphNode(e);(i=new dl(s,t,n)).cull=!1}let a=this.layerMeshInstances.get(n);a||(a=[],this.layerMeshInstances.set(n,a)),a.push(i)}drawWireAlignedBox(t,e,s,i,n){k_.push(t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z);this.getBatch(n,i).addLinesArrays(k_,s),k_.length=0}drawWireSphere(t,e,s,i,n,a){const r=2*Math.PI/i;let o=0;for(let s=0;s<i;s++){const s=Math.sin(o),i=Math.cos(o);o+=r;const n=Math.sin(o),a=Math.cos(o);k_.push(t.x+e*s,t.y,t.z+e*i),k_.push(t.x+e*n,t.y,t.z+e*a),k_.push(t.x+e*s,t.y+e*i,t.z),k_.push(t.x+e*n,t.y+e*a,t.z),k_.push(t.x,t.y+e*s,t.z+e*i),k_.push(t.x,t.y+e*n,t.z+e*a)}this.getBatch(a,n).addLinesArrays(k_,s),k_.length=0}getGraphNode(t){let e=null;return e=this.freeGraphNodes.length>0?this.freeGraphNodes.pop():new jr,this.usedGraphNodes.push(e),e.worldTransform=t,e._dirtyWorld=e._dirtyNormal=!1,e}onPreRender(){this.allBatches.forEach((t=>{t.onPreRender()})),this.layerMeshInstances.forEach(((t,e)=>{e.addMeshInstances(t,!0)}))}onPostRender(){this.allBatches.forEach((t=>{t.onPostRender()})),this.allBatches.clear(),this.layerMeshInstances.forEach(((t,e)=>{e.removeMeshInstances(t,!0),t.length=0}));const t=this.freeGraphNodes;this.freeGraphNodes=this.usedGraphNodes,this.usedGraphNodes=t}}class z_{static createTexture(t,e,s){const i=new Mr(t,{width:s,height:s,format:e,addressU:Ws,addressV:Ws,type:Xn,magFilter:ui,minFilter:di,anisotropy:1});return i.name="AreaLightLUT",i}static setUniforms(t,e,s){t.scope.resolve("areaLightsLutTex1").setValue(e),t.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(t){const e=z_.createTexture(t,Li,2);e.lock().fill(0),e.unlock(),z_.setUniforms(t,e,e)}static set(t,e){function s(t,e,s){const i=z_.createTexture(t,s,64);return i.lock().set(e),i.unlock(),i.upload(),i}function i(t,e,s){const i=t.length,n=new Float32Array(i);for(let a=0;a<i;a++){const i=a%4;n[a]=(t[a]+e[i])*s[i]}return n}function n(t){const e=t.length,s=new Uint16Array(e),i=br.float2Half;for(let n=0;n<e;n++)s[n]=i(t[n]);return s}function a(t){const e=t.length,s=new Uint8ClampedArray(e);for(let i=0;i<e;i++)s[i]=255*t[i];return s}const r=new Int16Array(e,0,2),o=r[0],h=r[1];if(0!==o||1!==h);else{const r=new Float32Array(e,4,16384),o=new Float32Array(e,65540,16384);let h,l;const c=t.areaLightLutFormat;if(c===zi)h=r,l=o;else if(c===ki)h=n(r),l=n(o);else{const t=[-.306897,0,0,0],e=[1.442787,1,1,1];h=a(i(r,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),l=a(i(o,t,e))}const d=s(t,h,c),u=s(t,l,c);z_.setUniforms(t,d,u)}}}class U_ extends Kf{constructor(t,e,s){super(),this._device=t,this._registry=e,this._loader=s,this._hdrParser=new g_(e)}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._hdrParser.load(t,e,s)}open(t,e,s){return this._hdrParser.open(t,e,this._device)}patch(t,e){let s=t.resource;t._sourceTexture=s;const i=[],n=(t,e)=>{const s=new Mr(this._device,{name:"skyboxFaces",cubemap:!0,width:e,height:e,type:Yn.toString(),addressU:Ws,addressV:Ws,fixCubemapSeams:!1,mipmaps:!1});return Ao(this._device,t,s),s};if(s.cubemap)s.type===Xn||s.type===Yn?i.push(s):i.push(n(s,s.width));else{let t=n(s,s.width/4);i.push(t)}const a=[128,64,32,16,8,4],r=[void 0,512,128,32,8,2];for(let t=0;t<a.length;++t){const e=new Mr(this._device,{cubemap:!0,name:"skyboxPrefilter"+t,width:a[t],height:a[t],type:Yn,addressU:Ws,addressV:Ws,fixCubemapSeams:!0,mipmaps:!1});Ao(this._device,i[1]||s,e,r[t],4096),i.push(e)}t.resources=i}}class V_{constructor(t){this.app=t,this.model=null,this.skybox=null,this.audios=[],this.data=null}instantiateScene(t={}){return new Promise(((e,s)=>{if(!t.skipSetting){const t=this.data.scene,e=this.skybox;this.app.scene.updateShaders=!0,this.app.scene._skyboxIntensity=t.skyboxIntensity,this.app.scene._skyboxMip=t.skyboxMip,this.app.scene._toneMapping=t.tonemapping,this.app.scene.exposure=t.tonemapping_exposure,this.app.scene.gammaCorrection=1;let s=new ft;s.setFromAxisAngle(it.UP,t.skyboxAngle),this.app.scene.skyboxRotation=s,this.app.setSkybox(e)}const i=()=>{const s=this.model.resource.instantiateRenderContainer({animation:t.animation});if(s.hasComponent("animation")&&this.data.animationAudio&&this.data.animationAudio.length>0){let e=s.addComponent("animationAudio",{positional:!1});for(let s=0;s<this.model.resource.animations.length;s++){const i=this.model.resource.animations[s],n=i.resource;let a,r=this.data.animationAudio[s];a=r.audio<0||!this.data.audio[r.audio]?null:this.app.assets.find(this.data.audio[r.audio].path),e.addSlot(i.name,U({asset:a,volume:r.volume,duration:n.duration},t.animationAudio))}e.animation=s.getComponent("animation")}e(s)};this.model.resource?i():this.model.once("load",i)}))}destroy(){this.model&&this.model.destroy(),this.skybox&&this.skybox.destroy();for(let t=0;t<this.audios.length;t++){this.audios[t].destroy()}this.data=null}}class N_{constructor(t,e){this.app=t,this.assets=e,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),j.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries}).then((e=>this.createResource(t.load,e))).then((t=>{e(null,t)})).catch((s=>{e("Error loading emw.scene resource: "+t.original+" ["+s+"]")}))}createResource(t,e){return new Promise(((s,i)=>{const n=new V_(this.app),a=new z(t),r=`${a.scheme}://${a.authority}/`,o=e,h=o.scene,l=o.id;let c=new wm(h.skybox,"cubemap-hdr",{url:r+h.skyboxHDR},{cubemap:!0,rgbm:!1});this.assets.add(c),this.assets.load(c);const d=[];for(let t=0;o.audio&&t<o.audio.length;t++){let e=new wm(o.audio[t].path,"audio",{url:r+l+"/"+o.audio[t].path});this.assets.add(e),this.assets.load(e),d.push(e)}let u=new wm(h.gltf,"emw-container",{url:r+l+"/"+h.gltf});this.assets.add(u),this.assets.load(u),n.model=u,n.audios=d,n.skybox=c,n.data=o,u.once("load",(()=>{s(n)}))}))}open(t,e){return e}patch(t,e){}}class W_ extends u{constructor(t){super(),this.app=t,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(t){const e=t.__name;return this._scripts.hasOwnProperty(e)?(setTimeout((()=>{if(t.prototype.swap){const s=this._scripts[e],i=this._list.indexOf(s);this._list[i]=t,this._scripts[e]=t,this.fire("swap",e,t),this.fire("swap:"+e,t)}else console.warn(`script registry already has '${e}' script, define 'swap' method for new script type to enable code hot swapping`)})),!1):(this._scripts[e]=t,this._list.push(t),this.fire("add",e,t),this.fire("add:"+e,t),setTimeout((()=>{if(!this._scripts.hasOwnProperty(e))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const t=this.app.systems.script._components;let s;const i=[],n=[];for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const n=t.items[t.loopIndex];if(n._scriptsIndex[e]&&n._scriptsIndex[e].awaiting){n._scriptsData&&n._scriptsData[e]&&(s=n._scriptsData[e].attributes);const t=n.create(e,{preloading:!0,ind:n._scriptsIndex[e].ind,attributes:s});t&&i.push(t)}}for(let t=0;t<i.length;t++)i[t].__initializeAttributes();for(let t=0;t<i.length;t++)i[t].enabled&&(i[t]._initialized=!0,n.push(i[t]),i[t].initialize&&i[t].initialize());for(let t=0;t<n.length;t++)n[t].enabled&&!n[t]._postInitialized&&(n[t]._postInitialized=!0,n[t].postInitialize&&n[t].postInitialize())})),!0)}remove(t){let e=t,s=t;if("string"!=typeof s?s=e.__name:e=this.get(s),this.get(s)!==e)return!1;delete this._scripts[s];const i=this._list.indexOf(e);return this._list.splice(i,1),this.fire("remove",s,e),this.fire("remove:"+s,e),!0}get(t){return this._scripts[t]||null}has(t){if("string"==typeof t)return this._scripts.hasOwnProperty(t);if(!t)return!1;const e=t.__name;return this._scripts[e]===t}list(){return this._list}}class G_{_validate(t){if(!t.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==t.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!t.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(t.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let e=0,s=t.data.length;e<s;e++){const s=t.data[e];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${e}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${e}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${e}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${e}].messages" field`)}}parse(t){return t.data}}class H_ extends u{constructor(t){super(),this.locale="en-US",this._translations={},this._availableLangs={},this._app=t,this._assets=[],this._parser=new G_}static findAvailableLocale(t,e){return fm(t,e)}findAvailableLocale(t){if(this._translations[t])return t;const e=mm(t);return this._findFallbackLocale(t,e)}getText(t,e){let s,i=t;e||(e=this._locale,s=this._lang);let n=this._translations[e];return n||(s||(s=mm(e)),e=this._findFallbackLocale(e,s),n=this._translations[e]),n&&n.hasOwnProperty(t)&&(i=n[t],Array.isArray(i)&&(i=i[0]),null==i&&(i=t)),i}getPluralText(t,e,s){let i,n,a=t;s?(i=mm(s),n=gm(i)):(s=this._locale,i=this._lang,n=this._pluralFn);let r=this._translations[s];if(r||(i=mm(s=this._findFallbackLocale(s,i)),n=gm(i),r=this._translations[s]),r&&r[t]&&n){const s=n(e);a=r[t][s],null==a&&(a=t)}return a}addData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.info.locale,n=s.messages;if(!this._translations[i]){this._translations[i]={};const t=mm(i);this._availableLangs[t]||(this._availableLangs[t]=i)}Object.assign(this._translations[i],n),this.fire("data:add",i,n)}}removeData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.info.locale,n=this._translations[i];if(!n)continue;const a=s.messages;for(const t in a)delete n[t];0===Object.keys(n).length&&(delete this._translations[i],delete this._availableLangs[mm(i)]),this.fire("data:remove",i,a)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}get locale(){return this._locale}set locale(t){if(this._locale===t)return;let e=mm(t);if("in"===e&&(e="id",t=function(t,e){const s=t.indexOf("-");return-1!==s?e+t.substring(s):e}(t,e),this._locale===t))return;const s=this._locale;this._locale=t,this._lang=e,this._pluralFn=gm(this._lang),this.fire("set:locale",t,s)}get assets(){return this._assets}set assets(t){const e={};for(let s=0,i=t.length;s<i;s++){e[t[s]instanceof wm?t[s].id:t[s]]=!0}let s=this._assets.length;for(;s--;){const t=this._assets[s];if(!e[t]){this._app.assets.off("add:"+t,this._onAssetAdd,this);const e=this._app.assets.get(t);e&&this._onAssetRemove(e),this._assets.splice(s,1)}}for(const t in e){const e=parseInt(t,10);if(-1!==this._assets.indexOf(e))continue;this._assets.push(e);const s=this._app.assets.get(e);s?this._onAssetAdd(s):this._app.assets.once("add:"+e,this._onAssetAdd,this)}}_findFallbackLocale(t,e){let s=dm[t];return s&&this._translations[s]?s:(s=dm[e],s&&this._translations[s]?s:(s=this._availableLangs[e],s&&this._translations[s]?s:"en-US"))}_onAssetAdd(t){t.on("load",this._onAssetLoad,this),t.on("change",this._onAssetChange,this),t.on("remove",this._onAssetRemove,this),t.on("unload",this._onAssetUnload,this),t.resource&&this._onAssetLoad(t)}_onAssetLoad(t){this.addData(t.resource)}_onAssetChange(t){t.resource&&this.addData(t.resource)}_onAssetRemove(t){t.off("load",this._onAssetLoad,this),t.off("change",this._onAssetChange,this),t.off("remove",this._onAssetRemove,this),t.off("unload",this._onAssetUnload,this),t.resource&&this.removeData(t.resource),this._app.assets.once("add:"+t.id,this._onAssetAdd,this)}_onAssetUnload(t){t.resource&&this.removeData(t.resource)}}class j_ extends u{constructor(t,s){super(),this._app=t,this._device=t.graphicsDevice,this.id=s.displayId,this._frameData=null,e.polyfill.window.VRFrameData&&(this._frameData=new e.polyfill.window.VRFrameData),this.display=s,this._camera=null,this.sitToStandInv=new dt,this.leftView=new dt,this.leftProj=new dt,this.leftViewInv=new dt,this.leftPos=new it,this.rightView=new dt,this.rightProj=new dt,this.rightViewInv=new dt,this.rightPos=new it,this.combinedPos=new it,this.combinedView=new dt,this.combinedProj=new dt,this.combinedViewInv=new dt,this.combinedFov=0,this.combinedAspect=0,this.presenting=!1,this._presentChange=t=>{let e;if(e=t.display?t.display:t.detail&&t.detail.display?t.detail.display:t.detail&&t.detail.vrdisplay?t.detail.vrdisplay:this.display,e===this.display){if(this.presenting=this.display&&this.display.isPresenting,this.presenting){const t=this.display.getEyeParameters("left"),e=this.display.getEyeParameters("right"),s=2*Math.max(t.renderWidth,e.renderWidth),i=Math.max(t.renderHeight,e.renderHeight);this._app.graphicsDevice.setResolution(s,i),this._app._allowResize=!1}else this._app.setCanvasResolution(L_),this._app._allowResize=!0;this.fire("beforepresentchange",this),this.fire("presentchange",this)}},e.polyfill.window.addEventListener("vrdisplaypresentchange",this._presentChange,!1)}destroy(){e.polyfill.window.removeEventListener("vrdisplaypresentchange",this._presentChange),this._camera&&(this._camera.vrDisplay=null),this._camera=null}poll(){if(this.display){this.display.getFrameData(this._frameData),this.leftProj.data=this._frameData.leftProjectionMatrix,this.rightProj.data=this._frameData.rightProjectionMatrix;const t=this.display.stageParameters;t?(this.sitToStandInv.set(t.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));let e=this.leftProj.data[3]+this.leftProj.data[0],s=this.leftProj.data[11]+this.leftProj.data[8],i=1/Math.sqrt(e*e+s*s);e*=i,s*=i;let n=-Math.atan2(s,e);e=this.rightProj.data[3]+this.rightProj.data[0],s=this.rightProj.data[11]+this.rightProj.data[8],i=1/Math.sqrt(e*e+s*s),e*=i,s*=i,n=Math.max(n,-Math.atan2(s,e)),n*=2,this.combinedFov=n;const a=this.rightProj.data[5]/this.rightProj.data[0];this.combinedAspect=a;const r=this.combinedView;r.copy(this.leftView),r.invert(),this.leftViewInv.copy(r);const o=this.combinedPos;o.x=this.leftPos.x=r.data[12],o.y=this.leftPos.y=r.data[13],o.z=this.leftPos.z=r.data[14],r.copy(this.rightView),r.invert(),this.rightViewInv.copy(r);const h=o.x-r.data[12],l=o.y-r.data[13],c=o.z-r.data[14],d=Math.sqrt(h*h+l*l+c*c);this.rightPos.x=r.data[12],this.rightPos.y=r.data[13],this.rightPos.z=r.data[14],o.x+=r.data[12],o.y+=r.data[13],o.z+=r.data[14],o.x*=.5,o.y*=.5,o.z*=.5;const u=.5*Math.PI,p=.5*n,m=Math.PI-(u+p),f=.5*d*Math.sin(m),_=r.data[8],g=r.data[9],y=r.data[10];r.data[12]=o.x+_*f,r.data[13]=o.y+g*f,r.data[14]=o.z+y*f,this.combinedViewInv.copy(r),r.invert(),this.combinedProj.setPerspective(n*V.RAD_TO_DEG,a,this.display.depthNear+f,this.display.depthFar+f,!0)}}requestPresent(t){this.display?this.presenting?t&&t(new Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then((function(){t&&t()}),(function(e){t&&t(e)})):t&&t(new Error("No VrDisplay to requestPresent"))}exitPresent(t){this.display||t&&t(new Error("No VrDisplay to exitPresent")),this.presenting?this.display.exitPresent().then((function(){t&&t()}),(function(){t&&t(new Error("exitPresent failed"))})):t&&t(new Error("VrDisplay not presenting"))}requestAnimationFrame(t){this.display&&this.display.requestAnimationFrame(t)}submitFrame(){this.display&&this.display.submitFrame()}reset(){this.display&&this.display.resetPose()}setClipPlanes(t,e){this.display&&(this.display.depthNear=t,this.display.depthFar=e)}getFrameData(){if(this.display)return this._frameData}get capabilities(){return this.display?this.display.capabilities:{}}}class q_ extends u{constructor(t){super(),this.isSupported=q_.isSupported,this._index={},this.displays=[],this.display=null,this._app=t,this._onDisplayConnect=this._onDisplayConnect.bind(this),this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this),this._attach(),this._getDisplays(((t,e)=>{if(t)this.fire("error",t);else{for(let t=0;t<e.length;t++)this._addDisplay(e[t]);this.fire("ready",this.displays)}}))}_attach(){e.polyfill.window.addEventListener("vrdisplayconnect",this._onDisplayConnect),e.polyfill.window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)}_detach(){e.polyfill.window.removeEventListener("vrdisplayconnect",this._onDisplayConnect),e.polyfill.window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)}destroy(){this._detach()}poll(){const t=this.displays.length;if(t)for(let e=0;e<t;e++)this.displays[e]._camera&&this.displays[e].poll()}_getDisplays(t){e.polyfill.navigator.getVRDisplays?e.polyfill.navigator.getVRDisplays().then((function(e){t&&t(null,e)})):t&&t(new Error("WebVR not supported"))}_addDisplay(t){if(this._index[t.displayId])return;const e=new j_(this._app,t);this._index[e.id]=e,this.displays.push(e),this.display||(this.display=e),this.fire("displayconnect",e)}_onDisplayConnect(t){t.detail&&t.detail.display?this._addDisplay(t.detail.display):this._addDisplay(t.display)}_onDisplayDisconnect(t){let e;e=t.detail&&t.detail.display?t.detail.display.displayId:t.display.displayId;const s=this._index[e];if(!s)return;s.destroy(),delete this._index[s.id];const i=this.displays.indexOf(s);this.displays.splice(i,1),this.display===s&&(this.displays.length?this.display=this.displays[0]:this.display=null),this.fire("displaydisconnect",s)}}q_.isSupported=void 0!==e.polyfill.navigator&&!!e.polyfill.navigator.getVRDisplays;const X_="inline",Y_="immersive-vr",K_="immersive-ar",$_="viewer",Z_="left",J_="cpu-optimized",Q_="gpu-optimized",tg="luminance-alpha",eg=[],sg=[];class ig extends u{constructor(t,e,s){super(),this.manager=t,this._xrHitTestSource=e,this._transient=s}remove(){if(!this._xrHitTestSource)return;const t=this.manager.hitTest.sources,e=t.indexOf(this);-1!==e&&t.splice(e,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(t){if(this._transient){const e=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let t=0;t<e.length;t++){const s=e[t];let i;s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else this.updateHitResults(t.getHitTestResults(this._xrHitTestSource))}updateHitResults(t,e){for(let s=0;s<t.length;s++){const i=t[s].getPose(this.manager._referenceSpace);let n=eg.pop();n||(n=new it),n.copy(i.transform.position);let a=sg.pop();a||(a=new ft),a.copy(i.transform.orientation),this.fire("result",n,a,e),this.manager.hitTest.fire("result",this,n,a,e),eg.push(n),sg.push(a)}}}class ng extends u{constructor(t){super(),this.manager=t,this._supported=C.browser&&!(!e.polyfill.window.XRSession||!e.polyfill.window.XRSession.prototype.requestHitTestSource),this._session=null,this.sources=[],this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this.manager.type===K_&&(this._session=this.manager.session)}_onSessionEnd(){if(this._session){this._session=null;for(let t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[]}}isAvailable(t,e){let s;return this._supported||(s=new Error("XR HitTest is not supported")),this._session||(s=new Error("XR Session is not started (1)")),this.manager.type!==K_&&(s=new Error("XR HitTest is available only for AR")),!s||(t&&t(s),e&&e.fire("error",s),!1)}start(t){if(t=t||{},!this.isAvailable(t.callback,this))return;let e;t.profile||t.spaceType||(t.spaceType=$_);const s=t.offsetRay;s&&(e=new XRRay(new DOMPoint(s.origin.x,s.origin.y,s.origin.z),new DOMPoint(s.direction.x,s.direction.y,s.direction.z)));const i=t.callback;t.spaceType?this._session.requestReferenceSpace(t.spaceType).then((s=>{if(!this._session){const t=new Error("XR Session is not started (2)");return i&&i(t),void this.fire("error",t)}this._session.requestHitTestSource({space:s,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((t=>{this._onHitTestSource(t,!1,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))})).catch((t=>{i&&i(t),this.fire("error",t)})):this._session.requestHitTestSourceForTransientInput({profile:t.profile,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((t=>{this._onHitTestSource(t,!0,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))}_onHitTestSource(t,e,s){if(!this._session){t.cancel();const e=new Error("XR Session is not started (3)");return s&&s(e),void this.fire("error",e)}const i=new ig(this.manager,t,e);this.sources.push(i),s&&s(null,i),this.fire("add",i)}update(t){for(let e=0;e<this.sources.length;e++)this.sources[e].update(t)}get supported(){return this._supported}}class ag{constructor(t,e){this._index=t,this._hand=e,this._hand._fingers.push(this),this._joints=[],this._tip=null}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const rg=C.browser&&e.polyfill.window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],og={};for(let t=0;t<rg.length;t++)og[rg[t]]=!0;class hg{constructor(t,e,s,i=null){this._index=t,this._id=e,this._hand=s,this._finger=i,this._wrist="wrist"===e,this._tip=this._finger&&!!og[e],this._radius=null,this._localTransform=new dt,this._worldTransform=new dt,this._localPosition=new it,this._localRotation=new ft,this._position=new it,this._rotation=new ft,this._dirtyLocal=!0}update(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,it.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let lg=[];const cg=new it,dg=new it,ug=new it;C.browser&&e.polyfill.window.XRHand&&(lg=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class pg extends u{constructor(t){super();const e=t._xrInputSource.hand;if(this._manager=t._manager,this._inputSource=t,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null,e.get("wrist")){const t=new hg(0,"wrist",this,null);this._wrist=t,this._joints.push(t),this._jointsById.wrist=t}for(let t=0;t<lg.length;t++){const s=new ag(t,this);for(let i=0;i<lg[t].length;i++){const n=lg[t][i];if(!e.get(n))continue;const a=new hg(i,n,this,s);this._joints.push(a),this._jointsById[n]=a,a.tip&&(this._tips.push(a),s._tip=a),s._joints.push(a)}}}update(t){const e=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){const i=this._joints[s],n=e.hand.get(i._id);if(n){let e;if("hidden"!==t.session.visibilityState&&(e=t.getJointPose(n,this._manager._referenceSpace)),e)i.update(e),i.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],a=this._jointsById["index-finger-tip"],r=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&a&&r&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,a._localPosition,.5);let t=s,e=o;if(this._inputSource.handedness===Z_){const s=t;t=e,e=s}cg.sub2(t._localPosition,this._wrist._localPosition),dg.sub2(e._localPosition,this._wrist._localPosition),ug.cross(cg,dg).normalize(),cg.lerp(n._localPosition,r._localPosition,.5),cg.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(ug,cg,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(t){const e=this._fingers[t];return cg.sub2(e.joints[0]._localPosition,e.joints[1]._localPosition).normalize(),dg.sub2(e.joints[2]._localPosition,e.joints[3]._localPosition).normalize(),cg.dot(dg)<-.8}getJointById(t){return this._jointsById[t]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}const mg=new ft;let fg=0;class _g extends u{constructor(t,e){super(),this._id=++fg,this._manager=t,this._xrInputSource=e,this._ray=new Vs,this._rayLocal=new Vs,this._grip=!1,this._hand=null,e.hand&&(this._hand=new pg(this)),this._localTransform=null,this._worldTransform=null,this._position=new it,this._rotation=new ft,this._localPosition=null,this._localRotation=null,this._dirtyLocal=!0,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[]}update(t){if(this._hand)this._hand.update(t);else{if(this._xrInputSource.gripSpace){const e=t.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);e&&(this._grip||(this._grip=!0,this._localTransform=new dt,this._worldTransform=new dt,this._localPosition=new it,this._localRotation=new ft),this._dirtyLocal=!0,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation))}const e=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);e&&(this._dirtyRay=!0,this._rayLocal.origin.copy(e.transform.position),this._rayLocal.direction.set(0,0,-1),mg.copy(e.transform.orientation),mg.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,it.ONE));const t=this._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const t=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else t&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(t={}){t.profile=this._xrInputSource.profiles[0];const e=t.callback;t.callback=(t,s)=>{s&&this.onHitTestSourceAdd(s),e&&e(t,s)},this._manager.hitTest.start(t)}onHitTestSourceAdd(t){this._hitTestSources.push(t),this.fire("hittest:add",t),t.on("result",(function(e,s,i){i===this&&this.fire("hittest:result",t,e,s)}),this),t.once("remove",(function(){this.onHitTestSourceRemove(t),this.fire("hittest:remove",t)}),this)}onHitTestSourceRemove(t){const e=this._hitTestSources.indexOf(t);-1!==e&&this._hitTestSources.splice(e,1)}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}get elementInput(){return this._elementInput}set elementInput(t){this._elementInput!==t&&(this._elementInput=t,this._elementInput||(this._elementEntity=null))}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}}class gg extends u{constructor(t){super(),this.manager=t,this._session=null,this._inputSources=[],this._onInputSourcesChangeEvt=t=>{this._onInputSourcesChange(t)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){this._session=this.manager.session,this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session.addEventListener("select",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("select",t),this.fire("select",e,t)})),this._session.addEventListener("selectstart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!0,e.fire("selectstart",t),this.fire("selectstart",e,t)})),this._session.addEventListener("selectend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!1,e.fire("selectend",t),this.fire("selectend",e,t)})),this._session.addEventListener("squeeze",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("squeeze",t),this.fire("squeeze",e,t)})),this._session.addEventListener("squeezestart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!0,e.fire("squeezestart",t),this.fire("squeezestart",e,t)})),this._session.addEventListener("squeezeend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!1,e.fire("squeezeend",t),this.fire("squeezeend",e,t)}));const t=this._session.inputSources;for(let e=0;e<t.length;e++)this._addInputSource(t[e])}_onSessionEnd(){let t=this._inputSources.length;for(;t--;){const e=this._inputSources[t];this._inputSources.splice(t,1),e.fire("remove"),this.fire("remove",e)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session=null}_onInputSourcesChange(t){for(let e=0;e<t.removed.length;e++)this._removeInputSource(t.removed[e]);for(let e=0;e<t.added.length;e++)this._addInputSource(t.added[e])}_getByInputSource(t){for(let e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t)return this._inputSources[e];return null}_addInputSource(t){if(this._getByInputSource(t))return;const e=new _g(this.manager,t);this._inputSources.push(e),this.fire("add",e)}_removeInputSource(t){for(let e=0;e<this._inputSources.length;e++){if(this._inputSources[e].inputSource!==t)continue;const s=this._inputSources[e];this._inputSources.splice(e,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();return s.fire("remove"),void this.fire("remove",s)}}update(t){for(let e=0;e<this._inputSources.length;e++)this._inputSources[e].update(t)}get inputSources(){return this._inputSources}}const yg=new it,vg=new it,xg=new dt,bg=new dt;class Sg extends u{constructor(t){super(),this._manager=t,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new ft,this._color=new J,this._sphericalHarmonics=new Float32Array(27),this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let t;this._manager.session||(t=new Error("XR session is not running")),t||this._manager.type===K_||(t=new Error("XR session type is not AR")),t||this._supported||(t=new Error("light-estimation is not supported")),(!t&&this._lightProbe||this._lightProbeRequested)&&(t=new Error("light estimation is already requested")),t?this.fire("error",t):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((t=>{const e=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?e&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))})).catch((t=>{this._lightProbeRequested=!1,this.fire("error",t)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(t){if(!this._lightProbe)return;const e=t.getLightEstimate(this._lightProbe);if(!e)return;this._available||(this._available=!0,this.fire("available"));const s=e.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),yg.copy(s).mulScalar(1/this._intensity),this._color.set(yg.x,yg.y,yg.z),yg.set(0,0,0),vg.copy(e.primaryLightDirection),xg.setLookAt(vg,yg,it.UP),bg.setFromAxisAngle(it.RIGHT,90),xg.mul(bg),this._rotation.setFromMat4(xg),this._sphericalHarmonics.set(e.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}class wg extends u{constructor(t,e){super(),this._image=t,this._bitmap=null,this._width=e,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new it,this._rotation=new ft}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:e.polyfill.createImageBitmap(this._image).then((t=>(this._bitmap=t,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}get image(){return this._image}get width(){return this._width}set width(t){this._width=t}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}}class Mg extends u{constructor(t){super(),this._manager=t,this._supported=C.browser&&!!e.polyfill.window.XRImageTrackingResult,this._available=!1,this._images=[],this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(t,e){if(!this._supported||this._manager.active)return null;const s=new wg(t,e);return this._images.push(s),s}remove(t){if(this._manager.active)return;const e=this._images.indexOf(t);-1!==e&&(t.destroy(),this._images.splice(e,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then((t=>{this._available=!0;for(let e=0;e<t.length;e++)this._images[e]._trackable="trackable"===t[e]})).catch((t=>{this._available=!1,this.fire("error",t)}))}_onSessionEnd(){this._available=!1;for(let t=0;t<this._images.length;t++)this._images[t]._pose=null,this._images[t]._measuredWidth=0,this._images[t]._tracking&&(this._images[t]._tracking=!1,this._images[t].fire("untracked"))}prepareImages(t){this._images.length?Promise.all(this._images.map((function(t){return t.prepare()}))).then((function(e){t(null,e)})).catch((function(e){t(e,null)})):t(null,null)}update(t){if(!this._available)return;const e=t.getImageTrackingResults(),s={};for(let i=0;i<e.length;i++){s[e[i].index]=e[i];const n=this._images[e[i].index];n._emulated="emulated"===e[i].trackingState,n._measuredWidth=e[i].measuredWidthInMeters,n._dirtyTransform=!0,n._pose=t.getPose(e[i].imageSpace,this._manager._referenceSpace)}for(let t=0;t<this._images.length;t++)this._images[t]._tracking&&!s[t]?(this._images[t]._tracking=!1,this._images[t].fire("untracked")):!this._images[t]._tracking&&s[t]&&(this._images[t]._tracking=!0,this._images[t].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}class Tg{constructor(t){this._manager=t,this._supported=C.browser&&!!e.polyfill.window.XRDOMOverlayState,this._root=null}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(t){this._supported&&!this._manager.active&&(this._root=t)}get root(){return this._root}}class Ag extends u{constructor(t){super(),this._manager=t,this._available=!1,this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._matrixDirty=!1,this._matrix=new dt,this._emptyBuffer=new Uint8Array(32),this._depthBuffer=null,this._texture=new Mr(this._manager.app.graphicsDevice,{format:Ai,mipmaps:!1,addressU:Ws,addressV:Ws,minFilter:ui,magFilter:ui}),this.supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const t=this._manager.session;try{this._usage=t.depthUsage,this._dataFormat=t.depthDataFormat}catch(t){this._usage=null,this._dataFormat=null,this._available=!1,this.fire("error",t)}}_onSessionEnd(){this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._available&&(this._available=!1,this.fire("unavailable")),this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload()}_updateTexture(){const t=this._depthInfoCpu||this._depthInfoGpu;if(t){let e=!1;if(t.width===this._texture.width&&t.height===this._texture.height||(this._texture._width=t.width,this._texture._height=t.height,this._matrixDirty=!0,e=!0),this._depthInfoCpu){const t=this._depthInfoCpu.data;this._depthBuffer=new Uint8Array(t),this._texture._levels[0]=this._depthBuffer,this._texture.upload()}else this._depthInfoGpu&&(this._texture._levels[0]=this._depthInfoGpu.texture,this._texture.upload());e&&this.fire("resize",t.width,t.height)}else this._depthBuffer&&(this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())}update(t,e){if(!this._usage)return;let s=null,i=null;if(this._usage===J_&&e?s=t.getDepthInformation(e):this._usage===Q_&&e&&(i=t.getDepthInformation(e)),(this._depthInfoCpu&&!s||!this._depthInfoCpu&&s||this.depthInfoGpu&&!i||!this._depthInfoGpu&&i)&&(this._matrixDirty=!0),this._depthInfoCpu=s,this._depthInfoGpu=i,this._updateTexture(),this._matrixDirty){this._matrixDirty=!1;const t=this._depthInfoCpu||this._depthInfoGpu;t?this._matrix.data.set(t.normDepthBufferFromNormView.matrix):this._matrix.setIdentity()}!this._depthInfoCpu&&!this._depthInfoGpu||this._available?this._depthInfoCpu||this._depthInfoGpu||!this._available||(this._available=!1,this.fire("unavailable")):(this._available=!0,this.fire("available"))}getDepth(t,e){return this._depthInfoCpu?this._depthInfoCpu.getDepthInMeters(t,e):null}get supported(){return C.browser&&!!e.polyfill.window.XRDepthInformation}get available(){return this._available}get usage(){return this._usage}get dataFormat(){return this._dataFormat}get width(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.width||0}get height(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.height||0}get texture(){return this._texture}get uvMatrix(){return this._matrix}get rawValueToMeters(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.rawValueToMeters||0}}let Cg=0;class Pg extends u{constructor(t,e){super(),this._id=++Cg,this._planeDetection=t,this._manager=this._planeDetection._manager,this._xrPlane=e,this._lastChangedTime=this._xrPlane.lastChangedTime,this._orientation=this._xrPlane.orientation,this._position=new it,this._rotation=new ft}destroy(){this.fire("remove")}update(t){const e=t.getPose(this._xrPlane.planeSpace,this._manager._referenceSpace);e&&(this._position.copy(e.transform.position),this._rotation.copy(e.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this.id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}}class Rg extends u{constructor(t){super(),this._manager=t,this._supported=C.browser&&!!e.polyfill.window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=null,this._supported&&this._manager.on("end",this._onSessionEnd,this)}_onSessionEnd(){if(this._planes)for(let t=0;t<this._planes.length;t++)this._planes[t].destroy();this._planesIndex.clear(),this._planes=null,this._available&&(this._available=!1,this.fire("unavailable"))}update(t){let e;if(this._available)e=t.detectedPlanes;else try{e=t.detectedPlanes,this._planes=[],this._available=!0,this.fire("available")}catch(t){return}for(const[t,s]of this._planesIndex)e.has(t)||(this._planesIndex.delete(t),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(const s of e){let e=this._planesIndex.get(s);e?e.update(t):(e=new Pg(this,s),this._planesIndex.set(s,e),this._planes.push(e),e.update(t),this.fire("add",e))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}class Eg extends u{constructor(t){super(),this.app=t,this._supported=C.browser&&!!e.polyfill.navigator.xr,this._available={},this._available[X_]=!1,this._available[Y_]=!1,this._available[K_]=!1,this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this._referenceSpace=null,this.depthSensing=new Ag(this),this.domOverlay=new Tg(this),this.hitTest=new ng(this),this.imageTracking=new Mg(this),this.planeDetection=new Rg(this),this.input=new gg(this),this.lightEstimation=new Sg(this),this._camera=null,this.views=[],this.viewsPool=[],this._localPosition=new it,this._localRotation=new ft,this._depthNear=.1,this._depthFar=1e3,this._width=0,this._height=0,this._supported&&(e.polyfill.navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck())}start(t,e,s,i){let n=i;if("object"==typeof i&&(n=i.callback),!this._available[e])return void(n&&n(new Error("XR is not available")));if(this._session)return void(n&&n(new Error("XR session is already started")));this._camera=t,this._camera.camera.xr=this,this._type=e,this._spaceType=s,this._setClipPlanes(t.nearClip,t.farClip);const a={requiredFeatures:[s],optionalFeatures:[]};if(e===K_){if(a.optionalFeatures.push("light-estimation"),a.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&a.optionalFeatures.push("image-tracking"),i.planeDetection&&a.optionalFeatures.push("plane-detection")),this.domOverlay.supported&&this.domOverlay.root&&(a.optionalFeatures.push("dom-overlay"),a.domOverlay={root:this.domOverlay.root}),i&&i.depthSensing&&this.depthSensing.supported){a.optionalFeatures.push("depth-sensing");const t=[J_],e=[tg];if(i.depthSensing.usagePreference){const e=t.indexOf(i.depthSensing.usagePreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const t=e.indexOf(i.depthSensing.dataFormatPreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.dataFormatPreference)}a.depthSensing={usagePreference:t,dataFormatPreference:e}}}else e===Y_&&a.optionalFeatures.push("hand-tracking");i&&i.optionalFeatures&&(a.optionalFeatures=a.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((t,i)=>{if(t)return n&&n(t),void this.fire("error",t);null!==i&&(a.trackedImages=i),this._onStartOptionsReady(e,s,a,n)})):this._onStartOptionsReady(e,s,a,n)}_onStartOptionsReady(t,s,i,n){e.polyfill.navigator.xr.requestSession(t,i).then((t=>{this._onSessionStart(t,s,n)})).catch((t=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,n&&n(t),this.fire("error",t)}))}end(t){this._session?(t&&this.once("end",t),this._session.end()):t&&t(new Error("XR Session is not initialized"))}isAvailable(t){return this._available[t]}_deviceAvailabilityCheck(){for(const t in this._available)this._sessionSupportCheck(t)}_sessionSupportCheck(t){e.polyfill.navigator.xr.isSessionSupported(t).then((e=>{this._available[t]!==e&&(this._available[t]=e,this.fire("available",t,e),this.fire("available:"+t,e))})).catch((t=>{this.fire("error",t)}))}_onSessionStart(t,e,s){let i=!1;this._session=t;const n=()=>{this.fire("visibility:change",t.visibilityState)},a=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},r=()=>{this._session=null,this._referenceSpace=null,this.views=[],this._width=0,this._height=0,this._type=null,this._spaceType=null,this._camera&&(this._camera.off("set_nearClip",a),this._camera.off("set_farClip",a),this._camera.camera.xr=null,this._camera=null),t.removeEventListener("end",r),t.removeEventListener("visibilitychange",n),i||this.fire("end"),this.app.tick()};t.addEventListener("end",r),t.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._baseLayer=new XRWebGLLayer(t,this.app.graphicsDevice.gl),t.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),t.requestReferenceSpace(e).then((t=>{this._referenceSpace=t,this.app.tick(),s&&s(null),this.fire("start")})).catch((e=>{i=!0,t.end(),s&&s(e),this.fire("error",e)}))}_setClipPlanes(t,e){this._depthNear===t&&this._depthFar===e||(this._depthNear=t,this._depthFar=e,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}update(t){if(!this._session)return;const e=t.session.renderState.baseLayer.framebufferWidth,s=t.session.renderState.baseLayer.framebufferHeight;this._width===e&&this._height===s||(this._width=e,this._height=s,this.app.graphicsDevice.setResolution(e,s));const i=t.getViewerPose(this._referenceSpace),n=i?i.views.length:0;if(n>this.views.length)for(let t=0;t<=n-this.views.length;t++){let t=this.viewsPool.pop();t||(t={viewport:new nt,projMat:new dt,viewMat:new dt,viewOffMat:new dt,viewInvMat:new dt,viewInvOffMat:new dt,projViewOffMat:new dt,viewMat3:new at,position:new Float32Array(3),rotation:new ft}),this.views.push(t)}else if(n<=this.views.length)for(let t=0;t<this.views.length-n;t++)this.viewsPool.push(this.views.pop());if(i){const e=i.transform.position,s=i.transform.orientation;this._localPosition.set(e.x,e.y,e.z),this._localRotation.set(s.x,s.y,s.z,s.w);const n=t.session.renderState.baseLayer;for(let t=0;t<i.views.length;t++){const e=i.views[t],s=this.views[t],a=n.getViewport(e);s.viewport.x=a.x,s.viewport.y=a.y,s.viewport.z=a.width,s.viewport.w=a.height,s.projMat.set(e.projectionMatrix),s.viewMat.set(e.transform.inverse.matrix),s.viewInvMat.set(e.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(t),this._type===K_&&(this.hitTest.supported&&this.hitTest.update(t),this.lightEstimation.supported&&this.lightEstimation.update(t),this.depthSensing.supported&&this.depthSensing.update(t,i&&i.views[0]),this.imageTracking.supported&&this.imageTracking.update(t),this.planeDetection.supported&&this.planeDetection.update(t)),this.fire("update",t)}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get visibilityState(){return this._session?this._session.visibilityState:null}get camera(){return this._camera?this._camera.entity:null}}class Lg extends u{constructor(t,e){super(),this.system=t,this.entity=e,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(t,e,s){this.fire("set_"+t,t,e,s)})),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(t,e){e.forEach((function(e){const s="object"==typeof e?e.name:e;Object.defineProperty(t,s,{get:function(){return this.data[s]},set:function(t){const e=this.data,i=e[s];e[s]=t,this.fire("set",s,i,t)},configurable:!0})})),t._accessorsBuilt=!0}buildAccessors(t){Lg._buildAccessors(this,t)}onSetEnabled(t,e,s){e!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}}class Ig extends u{constructor(t){super(),this.app=t,this.store={},this.schema=[]}addComponent(t,e={}){const s=new this.ComponentType(this,t),i=new this.DataType;return this.store[t.getGuid()]={entity:t,data:i},t[this.id]=s,t.c[this.id]=s,this.initializeComponentData(s,e,[]),this.fire("add",t,s),t.fire("component:"+this.id+":add",s),s}removeComponent(t){const e=this.store[t.getGuid()],s=t.c[this.id];this.fire("beforeremove",t,s),delete this.store[t.getGuid()],delete t[this.id],delete t.c[this.id],this.fire("remove",t,e.data),t.fire("component:"+this.id+":remove",s)}cloneComponent(t,e){const s=this.store[t.getGuid()];return this.addComponent(e,s.data)}initializeComponentData(t,e={},s){for(let i=0,n=s.length;i<n;i++){const n=s[i];let a,r;"object"==typeof n?(a=n.name,r=n.type):(a=n,r=void 0);let o=e[a];void 0!==o?(void 0!==r&&(o=Dg(o,r)),t[a]=o):t[a]=t.data[a]}t.enabled&&t.entity.enabled&&t.onEnable()}getPropertiesOfType(t){const e=[];return(this.schema||[]).forEach((function(s){s&&"object"==typeof s&&s.type===t&&e.push(s)})),e}destroy(){this.off()}}function Dg(t,e){if(!t)return t;switch(e){case"rgb":return t instanceof J?t.clone():new J(t[0],t[1],t[2]);case"rgba":return t instanceof J?t.clone():new J(t[0],t[1],t[2],t[3]);case"vec2":return t instanceof st?t.clone():new st(t[0],t[1]);case"vec3":return t instanceof it?t.clone():new it(t[0],t[1],t[2]);case"vec4":return t instanceof nt?t.clone():new nt(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw new Error("Could not convert unhandled type: "+e)}}p.attach(Ig);class Fg extends Lg{constructor(t,e){super(t,e),this.animationsIndex={},this.canTriggerEvent=!0,this.on("set_animations",this.onSetAnimations,this),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this)}play(t,e=0){this._play(t,e),this.fire("play",t)}_play(t,e=0){if(!this.enabled||!this.entity.enabled)return;const s=this.data;if(s.animations[t]){if(s.prevAnim=s.currAnim,s.currAnim=t,s.model){s.skeleton||s.animEvaluator||this._createAnimationController();const t=s.animations[s.prevAnim],i=s.animations[s.currAnim];if(s.blending=e>0&&s.prevAnim,s.blending&&(s.blend=0,s.blendSpeed=1/e),s.skeleton&&(s.blending?(s.fromSkel.animation=t,s.fromSkel.addTime(s.skeleton._time),s.toSkel.animation=i):s.skeleton.animation=i),s.animEvaluator){const t=s.animEvaluator;if(s.blending)for(;t.clips.length>1;)t.removeClip(0);else s.animEvaluator.removeClips();const e=new ju(s.animations[s.currAnim],0,1,!0,s.loop);e.name=s.currAnim,e.blendWeight=s.blending?0:1,e.reset(),s.animEvaluator.addClip(e)}}s.playing=!0,this.canTriggerEvent=!0}}resume(t,e){let s=this.currentTime;this._play(t,e),this.currentTime=s,this.fire("resume",t)}playOrResume(t){this.currentTime>0&&this.currentTime<this.animations[t].duration?this.resume(t,this.currentTime):this.play(t)}pause(){this.playing=!1,this.canTriggerEvent=!1,this.fire("pause",this.currAnim)}stop(){this.currentTime=0,this.playing=!1,this.canTriggerEvent=!1,this.fire("stop")}getAnimation(t){return this.data.animations[t]}setModel(t){const e=this.data;t!==e.model&&(this._resetAnimationController(),e.model=t,e.animations&&e.currAnim&&e.animations[e.currAnim]&&this.play(e.currAnim))}_resetAnimationController(){const t=this.data;t.skeleton=null,t.fromSkel=null,t.toSkel=null,t.animEvaluator=null}_createAnimationController(){const t=this.data,e=t.model,s=t.animations;let i=!1,n=!1;for(const t in s)if(s.hasOwnProperty(t)){s[t].constructor===Sp?n=!0:i=!0}const a=e;i?(t.fromSkel=new zu(a),t.toSkel=new zu(a),t.skeleton=new zu(a),t.skeleton.looping=t.loop,t.skeleton.setGraph(a)):n&&(t.animEvaluator=new vp(new wp(this.entity)))}loadAnimationAssets(t){if(!t||!t.length)return;const e=this.system.app.assets,s=t=>{if(t.resources.length>1)for(let e=0;e<t.resources.length;e++)this.animations[t.resources[e].name]=t.resources[e],this.animationsIndex[t.id]=t.resources[e].name;else this.animations[t.name]=t.resource,this.animationsIndex[t.id]=t.name;this.animations=this.animations},i=t=>{t.off("change",this.onAssetChanged,this),t.on("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this),t.resource?s(t):(t.once("load",s,this),this.enabled&&this.entity.enabled&&e.load(t))};for(let s=0,n=t.length;s<n;s++){const n=e.get(t[s]);n?i(n):e.on("add:"+t[s],i)}}onAssetChanged(t,e,s,i){if("resource"===e||"resources"===e)if("resources"===e&&s&&0===s.length&&(s=null),s){let e=!1;if(s.length>1){if(i&&i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name];else delete this.animations[t.name];e=!1;for(let t=0;t<s.length;t++)this.animations[s[t].name]=s[t],e||this.data.currAnim!==s[t].name||this.data.playing&&this.data.enabled&&this.entity.enabled&&(e=!0,this.play(s[t].name));e||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name];this.animations[t.name]=s[0]||s,e=!1,this.data.currAnim===t.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(e=!0,this.play(t.name)),e||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[t.id]=t.name}else{if(i.length>1)for(let t=0;t<i.length;t++)delete this.animations[i[t].name],this.data.currAnim===i[t].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.data.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}onAssetRemoved(t){if(t.off("remove",this.onAssetRemoved,this),this.animations){if(t.resources.length>1)for(let e=0;e<t.resources.length;e++)delete this.animations[t.resources[e].name],this.data.currAnim===t.resources[e].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.data.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}_stopCurrentAnimation(){const t=this.data;if(t.currAnim=null,t.playing=!1,t.skeleton&&(t.skeleton.currentTime=0,t.skeleton.animation=null),t.animEvaluator){for(let e=0;e<t.animEvaluator.clips.length;++e)t.animEvaluator.clips[e].stop();t.animEvaluator.update(0),t.animEvaluator.removeClips()}}onSetAnimations(t,e,s){const i=this.data;if(s||i.animations,this.setModel(this.entity),!i.currAnim&&i.activate&&i.enabled&&this.entity.enabled){const t=Object.keys(i.animations);t.length>0&&this.play(t[0])}}onSetAssets(t,e,s){if(e&&e.length)for(let t=0;t<e.length;t++)if(e[t]){const s=this.system.app.assets.get(e[t]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);const t=this.animationsIndex[s.id];this.data.currAnim===t&&this._stopCurrentAnimation(),delete this.animations[t],delete this.animationsIndex[s.id]}}const i=s.map((t=>t instanceof wm?t.id:t));this.loadAnimationAssets(i)}onSetLoop(t,e,s){const i=this.data;if(i.skeleton&&(i.skeleton.looping=i.loop),i.animEvaluator)for(let t=0;t<i.animEvaluator.clips.length;++t)i.animEvaluator.clips[t].loop=i.loop}onSetCurrentTime(t,e,s){const i=this.data;if(i.skeleton){const t=i.skeleton;t.currentTime=s,t.addTime(0),t.updateGraph()}if(i.animEvaluator){const t=i.animEvaluator;for(let e=0;e<t.clips.length;++e)t.clips[e].time=s}}onEnable(){super.onEnable();const t=this.data,e=t.assets,s=this.system.app.assets;if(e)for(let t=0,i=e.length;t<i;t++){let i=e[t];i instanceof wm||(i=s.get(i)),i&&!i.resource&&s.load(i)}if(t.activate&&!t.currAnim){const e=Object.keys(t.animations);e.length>0&&this.play(e[0])}}onBeforeRemove(){for(let t=0;t<this.assets.length;t++){let e=this.assets[t];"number"==typeof e&&(e=this.system.app.assets.get(e)),e&&(e.off("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this))}const t=this.data;delete t.animation,delete t.skeleton,delete t.fromSkel,delete t.toSkel,delete t.animEvaluator}get currentTime(){const t=this.data;if(t.skeleton)return this.data.skeleton._time;if(t.animEvaluator){const e=t.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}set currentTime(t){const e=this.data;if(e.skeleton){const s=e.skeleton;s.currentTime=t,s.addTime(0),s.updateGraph()}if(e.animEvaluator){const s=e.animEvaluator;for(let e=0;e<s.clips.length;++e)s.clips[e].time=t}this.fire("currentTime:changed",t)}get duration(){return this.data.animations[this.data.currAnim].duration}}class Og{constructor(){this.assets=[],this.modelAsset="",this.speed=1,this.loop=!0,this.activate=!0,this.enabled=!0,this.animations={},this.model=null,this.prevAnim=null,this.currAnim=null,this.blending=!1,this.blend=0,this.blendSpeed=0,this.playing=!1,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}}const kg=["enabled","assets","modelAsset","speed","loop","activate","animations","skeleton","model","prevAnim","currAnim","fromSkel","toSkel","blending","blendTimeRemaining","playing"];class Bg extends Ig{constructor(t){super(t),this.id="animation",this.ComponentType=Fg,this.DataType=Og,this.schema=kg,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["activate","enabled","loop","speed","assets"],super.initializeComponentData(t,e,s)}cloneComponent(t,e){this.addComponent(e,{}),e.animation.assets=t.animation.assets.slice(),e.animation.data.speed=t.animation.speed,e.animation.data.loop=t.animation.loop,e.animation.data.activate=t.animation.activate,e.animation.data.enabled=t.animation.enabled;const s={},i=t.animation.animations;for(const t in i)i.hasOwnProperty(t)&&(s[t]=i[t]);e.animation.animations=s;const n={},a=t.animation.animationsIndex;for(const t in a)a.hasOwnProperty(t)&&(n[t]=a[t]);e.animation.animationsIndex=n}onBeforeRemove(t,e){e.onBeforeRemove()}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],n=i.data,a=i.entity.animation;if(n.enabled&&i.entity.enabled){if(n.blending&&(n.blend+=t*n.blendSpeed,n.blend>=1&&(n.blend=1)),n.playing){const e=n.skeleton;if(null!==e&&null!==n.model){if(n.blending)e.blend(n.fromSkel,n.toSkel,n.blend);else{const s=t*n.speed;e.addTime(s),(n.speed>0&&e._time===e._animation.duration&&!n.loop||n.speed<0&&0===e._time&&!n.loop)&&(n.playing=!1)}n.blending&&1===n.blend&&(e.animation=n.toSkel._animation),e.updateGraph()}}const e=n.animEvaluator;if(e){for(let t=0;t<e.clips.length;++t){const s=e.clips[t];s.speed=n.speed,n.playing?s.resume():s.pause()}n.blending&&e.clips.length>1&&(e.clips[1].blendWeight=n.blend),e.update(t)}n.blending&&1===n.blend&&(n.blending=!1)}a.loop&&(a.canTriggerEvent=!0),a.playing&&a.currentTime==a.duration&&(a.canTriggerEvent&&a.fire("finish"),a.canTriggerEvent=!1)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lg._buildAccessors(Fg.prototype,kg);const zg=new st,Ug=new it,Vg=new nt,Ng=new J,Wg=new ft;class Gg extends wp{constructor(t,e,s,i,n){super(e),this.animComponent=t,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(t){return t[0]}static _packBoolean(t){return!!t[0]}static _packVec2(t){return zg.x=t[0],zg.y=t[1],zg}static _packVec3(t){return Ug.x=t[0],Ug.y=t[1],Ug.z=t[2],Ug}static _packVec4(t){return Vg.x=t[0],Vg.y=t[1],Vg.z=t[2],Vg.w=t[3],Vg}static _packColor(t){return Ng.r=t[0],Ng.g=t[1],Ng.b=t[2],Ng.a=t[3],Ng}static _packQuat(t){return Wg.x=t[0],Wg.y=t[1],Wg.z=t[2],Wg.w=t[3],Wg}resolve(t){const e=Wu.encode(t.entityPath,t.component,t.propertyPath);let s,i,n,a=this.targetCache[e];if(a)return a;switch(t.component){case"entity":s=this._getEntityFromHierarchy(t.entityPath),n=Wu.encode(s.path,"entity",t.propertyPath),i=s;break;case"graph":if(i=this.findNode(t),!i)return null;n=Wu.encode(i.path,"graph",t.propertyPath);break;default:if(s=this._getEntityFromHierarchy(t.entityPath),i=s.findComponent(t.component),!i)return null;n=Wu.encode(s.path,t.component,t.propertyPath)}return a=this._createAnimTargetForProperty(i,t.propertyPath,n),this.targetCache[e]=a,a}update(t){const e=this.activeNodes;if(e)for(let t=0;t<e.length;t++)e[t]._dirtifyLocal()}_getEntityFromHierarchy(t){if(!this.animComponent.entity.name===t[0])return null;const e=this.animComponent.entity;return 1===t.length?e:e._parent.findByPath(t)}_resolvePath(t,e,s){const i=e.length-(s?0:1);for(let s=0;s<i;s++)t=t[e[s]];return t}_setter(t,e,s){const i=this._resolvePath(t,e),n=e[e.length-1],a="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[a]){const t=i[a].bind(i);return function(e){t(s(e))}}const r=i[n];if("object"==typeof r&&r.hasOwnProperty("copy"))return function(t){r.copy(s(t))};if(-1!==[st,it,nt,J,ft].indexOf(i.constructor)&&e.length>1){const a=e.length>2?this._resolvePath(t,e.slice(0,-1)):t,r=e[e.length-2];return function(t){i[n]=s(t),a[r]=i}}return function(t){i[n]=s(t)}}_createAnimTargetForProperty(t,e,s){if(this.handlers&&"weights"===e[0])return this.handlers.weights(t);if(this.handlers&&"material"===e[0]&&2===e.length){const s=e[1];if(s.indexOf("Map")===s.length-3)return this.handlers.materialTexture(t,s)}const i=this._resolvePath(t,e,!0);if(void 0===i)return null;let n,a,r;if("number"==typeof i)n=this._setter(t,e,Gg._packFloat),a="vector",r=1;else if("boolean"==typeof i)n=this._setter(t,e,Gg._packBoolean),a="vector",r=1;else if("object"==typeof i)switch(i.constructor){case st:n=this._setter(t,e,Gg._packVec2),a="vector",r=2;break;case it:n=this._setter(t,e,Gg._packVec3),a="vector",r=3;break;case nt:n=this._setter(t,e,Gg._packVec4),a="vector",r=4;break;case J:n=this._setter(t,e,Gg._packColor),a="vector",r=4;break;case ft:n=this._setter(t,e,Gg._packQuat),a="quaternion",r=4;break;default:return null}return-1!==e.indexOf("material")?new xp((function(e){n(e),t.material.update()}),a,r,s):new xp(n,a,r,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const t={};!function e(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])}(this.graph),this.nodes=t}}class Hg{constructor(t,e,s,i=1,n=gp){this._name=t,this._controller=e,this._component=s,this._weight=i,this._blendType=n,this._mask=null}play(t){this._controller.play(t)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(t){this._controller.update(t)}assignMask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}get mask(){return this._mask}assignAnimation(t,e,s,i){e.constructor===Sp&&(this._controller.assignAnimation(t,e,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new Lp({from:"START",to:t})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(t){this._controller.removeNodeAnimations(t)&&(this._component.playing=!1)}transition(t,e=0,s=null){this._controller.updateStateFromTransition(new Lp({from:this._controller.activeStateName,to:t,time:e,transitionOffset:s}))}get name(){return this._name}get playing(){return this._controller.playing}set playing(t){this._controller.playing=t}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}set activeStateCurrentTime(t){this._controller.activeStateCurrentTime=t}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}get weight(){return this._weight}set weight(t){this._weight=t,this._component.dirtifyTargets()}get blendType(){return this._blendType}set blendType(t){t!==this._blendType&&(this._blendType=t,this._component.rebind())}}class jg extends Lg{constructor(t,e){super(t,e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set}get stateGraphAsset(){return this._stateGraphAsset}set stateGraphAsset(t){if(null===t)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let e,s;t instanceof wm?(e=t.id,s=this.system.app.assets.get(e),s||(this.system.app.assets.add(t),s=this.system.app.assets.get(e))):(e=t,s=this.system.app.assets.get(e)),s&&this._stateGraphAsset!==e&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(t=>{this._stateGraph=t.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=e)}_onStateGraphAssetChangeEvent(t){const e=this.animationAssets,s=this.layers.map((t=>t.mask));this.removeStateGraph(),this._stateGraph=new Dp(t._data),this.loadStateGraph(this._stateGraph),this.animationAssets=e,this.loadAnimationAssets(),this.layers.forEach(((t,e)=>t.assignMask(s[e]))),this.rebind()}get animationAssets(){return this._animationAssets}set animationAssets(t){this._animationAssets=t,this.loadAnimationAssets()}get speed(){return this._speed}set speed(t){this._speed=t}get activate(){return this._activate}set activate(t){this._activate=t}get playing(){return this._playing}set playing(t){this._playing=t}get rootBone(){return this._rootBone}set rootBone(t){if("string"==typeof t){const e=this.entity.root.findByGuid(t);this._rootBone=e}else this._rootBone=t instanceof ld?t:null;this.rebind()}get stateGraph(){return this._stateGraph}set stateGraph(t){this._stateGraph=t}get layers(){return this._layers}set layers(t){this._layers=t}get layerIndicies(){return this._layerIndicies}set layerIndicies(t){this._layerIndicies=t}get parameters(){return this._parameters}set parameters(t){this._parameters=t}get targets(){return this._targets}set targets(t){this._targets=t}get playable(){for(let t=0;t<this._layers.length;t++)if(!this._layers[t].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}dirtifyTargets(){const t=Object.values(this._targets);for(let e=0;e<t.length;e++)t[e].dirty=!0}_addLayer({name:t,states:e,transitions:s,weight:i,mask:n,blendType:a}){let r;r=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,h=new Gg(this,r,t,n,o),l=new vp(h),c=new Ip(l,e,s,this._parameters,this._activate,this,this._consumedTriggers);return this._layers.push(new Hg(t,c,this,i,a)),this._layerIndices[t]=o,this._layers[o]}addLayer(t,e,s,i){const n=this.findAnimationLayer(t);if(n)return n;return this._addLayer({name:t,states:[{name:"START",speed:1}],transitions:[],weight:e,mask:s,blendType:i})}loadStateGraph(t){this._stateGraph=t,this._parameters={};const e=Object.keys(t.parameters);for(let s=0;s<e.length;s++){const i=e[s];this._parameters[i]={type:t.parameters[i].type,value:t.parameters[i].value}}this._layers=[];for(let e=0;e<t.layers.length;e++){const s=t.layers[e];this._addLayer.bind(this)(U({},s))}this.setupAnimationAssets()}setupAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t],s=e.name;for(let t=0;t<e.states.length;t++){const i=e.states[t];if(-1===_p.indexOf(i)){const t=s+":"+i;this._animationAssets[t]||(this._animationAssets[t]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t];for(let t=0;t<e.states.length;t++){const s=e.states[t];if(-1!==_p.indexOf(s))continue;const i=this._animationAssets[e.name+":"+s];if(!i||!i.asset){this.removeNodeAnimations(s,e.name);continue}const n=i.asset,a=this.system.app.assets.get(n);a&&(a.resource?this.onAnimationAssetLoaded(e.name,s,a):(a.once("load",function(t,e){return function(s){this.onAnimationAssetLoaded(t,e,s)}.bind(this)}.bind(this)(e.name,s)),this.system.app.assets.load(a)))}}}onAnimationAssetLoaded(t,e,s){const i=s.resource;s.data.events&&(i.events=new bp(Object.values(s.data.events))),this.findAnimationLayer(t).assignAnimation(e,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1}resetStateGraph(){if(this.stateGraphAsset){const t=this.system.app.assets.get(this.stateGraphAsset).resource;this.loadStateGraph(t)}else this.removeStateGraph()}reset(){this._parameters=Object.assign({},this._stateGraph.parameters);for(let t=0;t<this._layers.length;t++){const e=this._layers[t].playing;this._layers[t].reset(),this._layers[t].playing=e}}rebind(){this._targets={};for(let t=0;t<this._layers.length;t++)this._layers[t].rebind()}findAnimationLayer(t){const e=this._layerIndices[t];return this._layers[e]||null}addAnimationState(t,e,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new Dp({layers:[{name:n,states:[{name:"START",speed:1},{name:t,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}}));const a=this.findAnimationLayer(n);var r;a?a.assignAnimation(t,e,s,i):null==(r=this.addLayer(n))||r.assignAnimation(t,e,s,i)}assignAnimation(t,e,s,i=1,n=!0){if(!this._stateGraph&&-1===t.indexOf("."))return this.loadStateGraph(new Dp({layers:[{name:"Base",states:[{name:"START",speed:1},{name:t,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}})),void this.baseLayer.assignAnimation(t,e);const a=s?this.findAnimationLayer(s):this.baseLayer;a&&a.assignAnimation(t,e,i,n)}removeNodeAnimations(t,e){const s=e?this.findAnimationLayer(e):this.baseLayer;s&&s.removeNodeAnimations(t)}getParameterValue(t,e){const s=this._parameters[t];if(s&&s.type===e)return s.value}setParameterValue(t,e,s){const i=this._parameters[t];i&&i.type===e&&(i.value=s)}getFloat(t){return this.getParameterValue(t,rp)}setFloat(t,e){this.setParameterValue(t,rp,e)}getInteger(t){return this.getParameterValue(t,ap)}setInteger(t,e){"number"==typeof e&&e%1==0&&this.setParameterValue(t,ap,e)}getBoolean(t){return this.getParameterValue(t,op)}setBoolean(t,e){this.setParameterValue(t,op,!!e)}getTrigger(t){return this.getParameterValue(t,hp)}setTrigger(t,e=!1){this.setParameterValue(t,hp,!0),e&&this._consumedTriggers.add(t)}resetTrigger(t){this.setParameterValue(t,hp,!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(t){for(let e=0;e<this.layers.length;e++)this.layers[e].update(t*this.speed);this._consumedTriggers.forEach((t=>{this.parameters[t].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone.getGuid()]?this.rootBone=e[t.rootBone.getGuid()]:this.rebind()}}class qg{constructor(){this.enabled=!0}}const Xg=["enabled"];class Yg extends Ig{constructor(t){super(t),this.id="anim",this.ComponentType=jg,this.DataType=qg,this.schema=Xg,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,Xg);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(e).forEach((s=>{i.includes(s)||(t[s]=e[s])})),e.stateGraph&&(t.stateGraph=e.stateGraph,t.loadStateGraph(t.stateGraph)),e.layers?e.layers.forEach(((e,s)=>{e._controller.states.forEach((i=>{e._controller._states[i]._animationList.forEach((e=>{t.layers[s].assignAnimation(e.name,e.animTrack)}))}))})):e.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,e.animationAssets)),e.masks&&Object.keys(e.masks).forEach((s=>{if(t.layers[s]){const i=e.masks[s].mask,n={};Object.keys(i).forEach((t=>{n[decodeURI(t)]=i[t]})),t.layers[s].assignMask(n)}}))}onAnimationUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(t)}}cloneComponent(t,e){const s={stateGraphAsset:t.anim.stateGraphAsset,animationAssets:t.anim.animationAssets,speed:t.anim.speed,activate:t.anim.activate,playing:t.anim.playing,rootBone:t.anim.rootBone,stateGraph:t.anim.stateGraph,layers:t.anim.layers,layerIndices:t.anim.layerIndices,parameters:t.anim.parameters};this.addComponent(e,s)}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}Lg._buildAccessors(jg.prototype,Xg);class Kg extends Lg{setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}class $g{constructor(){this.enabled=!0}}const Zg=["enabled"];class Jg extends Ig{constructor(t,e){super(t),this.id="audiolistener",this.ComponentType=Kg,this.DataType=$g,this.schema=Zg,this.manager=e,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["enabled"],super.initializeComponentData(t,e,s)}onUpdate(t){if(this.current){const t=this.current.getPosition();this.manager.listener.setPosition(t);const e=this.current.getWorldTransform();this.manager.listener.setOrientation(e)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lg._buildAccessors(Kg.prototype,Zg);class Qg extends Lg{constructor(t,e){super(t,e),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}play(t){if(!this.enabled||!this.entity.enabled)return;let e;this.channel&&this.stop();const s=this.data;if(s.sources[t])if(s["3d"]){const i=this.entity.getPosition();e=this.system.manager.playSound3d(s.sources[t],i,s),s.currentSource=t,s.channel=e}else e=this.system.manager.playSound(s.sources[t],s),s.currentSource=t,s.channel=e}pause(){this.channel&&this.channel.pause()}unpause(){this.channel&&this.channel.paused&&this.channel.unpause()}stop(){this.channel&&(this.channel.stop(),this.channel=null)}onSetAssets(t,e,s){const i=[],n=s.length;if(e&&e.length)for(let t=0;t<e.length;t++)if(e[t]){const s=this.system.app.assets.get(e[t]);s&&(s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this),this.currentSource===s.name&&this.stop())}if(n)for(let t=0;t<n;t++)e.indexOf(s[t])<0&&(s[t]instanceof wm?i.push(s[t].id):i.push(s[t]));!this.system._inTools&&i.length&&this.loadAudioSourceAssets(i)}onAssetChanged(t,e,s,i){if("resource"===e){this.data.sources&&(this.data.sources[t.name]=s,this.data.currentSource===t.name&&this.channel&&(this.channel.paused?(this.play(t.name),this.pause()):this.play(t.name)))}}onAssetRemoved(t){t.off("remove",this.onAssetRemoved,this),this.data.sources[t.name]&&(delete this.data.sources[t.name],this.data.currentSource===t.name&&(this.stop(),this.data.currentSource=null))}onSetLoop(t,e,s){e!==s&&this.channel&&this.channel.setLoop(s)}onSetVolume(t,e,s){e!==s&&this.channel&&this.channel.setVolume(s)}onSetPitch(t,e,s){e!==s&&this.channel&&this.channel.setPitch(s)}onSetMaxDistance(t,e,s){e!==s&&this.channel instanceof Wp&&this.channel.setMaxDistance(s)}onSetMinDistance(t,e,s){e!==s&&this.channel instanceof Wp&&this.channel.setMinDistance(s)}onSetRollOffFactor(t,e,s){e!==s&&this.channel instanceof Wp&&this.channel.setRollOffFactor(s)}onSetDistanceModel(t,e,s){e!==s&&this.channel instanceof Wp&&this.channel.setDistanceModel(s)}onSet3d(t,e,s){if(e!==s&&this.system.initialized&&this.currentSource){let t=!1,e=!1;this.channel&&(t=this.channel.paused,e=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=t,this.channel.suspended=e)}}onEnable(){const t=this.data.assets;if(t){const e=this.system.app.assets;for(let s=0,i=t.length;s<i;s++){let i=t[s];i instanceof wm||(i=e.get(i)),i&&!i.resource&&e.load(i)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())}onDisable(){this.pause()}loadAudioSourceAssets(t){const e=t.map((t=>this.system.app.assets.get(t))),s={};let i=null,n=e.length;const a=t=>{n--},r=()=>{this.data.sources=s,this.data.currentSource=i,this.enabled&&this.activate&&i&&this.onEnable()};e.forEach(((e,o)=>{e?(i=i||e.name,e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.off("error",a,this),e.on("error",a,this),e.ready((t=>{s[t.name]=t.resource,n--,0===n&&r()})),!e.resource&&this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)):(n--,0===n&&r(),this.system.app.assets.on("add:"+t[o],(t=>{t.ready((t=>{this.data.sources[t.name]=t.resource})),t.resource||this.system.app.assets.load(t)})))}))}}class ty{constructor(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=zp,this.paused=!0,this.sources={},this.currentSource=null,this.channel=null}}const ey=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"];class sy extends Ig{constructor(t,e){super(t),this.id="audiosource",this.ComponentType=Qg,this.DataType=ty,this.schema=ey,this.manager=e,this.initialized=!1,this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}initializeComponentData(t,e,s){s=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],super.initializeComponentData(t,e,s),t.paused=!(t.enabled&&t.activate)}onInitialize(t){t.audiosource&&t.enabled&&t.audiosource.enabled&&t.audiosource.activate&&t.audiosource.play(t.audiosource.currentSource);const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof ld&&this.onInitialize(e[t]);this.initialized=!0}onUpdate(t){const e=this.store;for(const t in e)if(e.hasOwnProperty(t)){const s=e[t],i=s.entity,n=s.data;if(n.enabled&&i.enabled&&n.channel instanceof Wp){const t=i.getPosition();n.channel.setPosition(t)}}}onRemove(t,e){e.channel&&(e.channel.stop(),e.channel=null)}setVolume(t){this.manager.setVolume(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("update",this.onUpdate,this)}}Lg._buildAccessors(Qg.prototype,ey);class iy extends u{constructor(t,e,s){if(super(),!(t&&t instanceof Lg))throw new Error("The parentComponent argument is required and must be a Component");if(!e||"string"!=typeof e)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=t,this._entityPropertyName=e,this._entity=null,this._app=t.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(t,e){const s=this._parseEventListenerConfig(t,"external",this._parentComponent),i=this._parseEventListenerConfig(e,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(t,e,s){return Object.keys(t).map((function(i,n){const a=i.split("#"),r=a[0],o=a[1],h=t[i];if(2!==a.length||"string"!=typeof r||0===r.length||"string"!=typeof o||0===o.length)throw new Error("Invalid event listener description: `"+i+"`");if("function"!=typeof h)throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:e+"_"+n+"_"+i,sourceName:r,eventName:o,callback:h,scope:s}}),this)}_toggleLifecycleListeners(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this),this._app.systems[t]("postPostInitialize",this._updateEntityReference,this),this._app[t]("tools:sceneloaded",this._onSceneLoaded,this);const e=[];for(let t=0;t<this._eventListenerConfigs.length;++t){const s=this._eventListenerConfigs[t],i=this._app.systems[s.sourceName];i&&(-1===e.indexOf(i)&&e.push(i),i&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),i&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(let s=0;s<e.length;++s)e[s][t]("add",this._onComponentAdd,this),e[s][t]("beforeremove",this._onComponentRemove,this)}_onSetEntity(t,e,s){if(s instanceof ld)this._updateEntityReference();else{if(null!=s&&"string"!=typeof s)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");e!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let t,e=this._parentComponent.data[this._entityPropertyName];if(e instanceof ld)t=e,e=t.getGuid(),this._parentComponent.data[this._entityPropertyName]=e;else{const s=this._parentComponent.system.app.root;t=this._parentComponent.entity.isDescendantOf(s)&&e?s.findByGuid(e):null}this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),this._entity=t,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(t){for(const e in this._entity.c)this._callGainOrLoseListener(e,t)}_callGainOrLoseListener(t,e){if(this._entity.c.hasOwnProperty(t)&&e[t]){const s=e[t];s.callback.call(s.scope)}}_toggleEntityListeners(t,e){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(t,this._eventListenerConfigs[s],e)}_toggleComponentListeners(t,e,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===e&&this._safeToggleListener(t,n,s)}}_safeToggleListener(t,e,s){const i="on"===t;if(i&&this._listenerStatusFlags[e.id])return;const n=this._getEventSource(e.sourceName,s);n&&(n[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=i)}_getEventSource(t,e){if("entity"===t)return this._entity;const s=this._entity[t];return s||(e||console.warn("Entity has no component with name "+t),null)}_onEntityDestroy(t){this._entity===t&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(t,e){e===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(t){return!(!this._entity||!this._entity.c)&&!!this._entity.c[t]}get entity(){return this._entity}}const ny=0,ay=1,ry="group",oy="image",hy="text",ly="DEFAULT",cy="HOVER",dy="PRESSED",uy="INACTIVE",py={};py[ly]="_defaultTint",py[cy]="hoverTint",py[dy]="pressedTint",py[uy]="inactiveTint";const my={};my[ly]="_defaultSpriteAsset",my[cy]="hoverSpriteAsset",my[dy]="pressedSpriteAsset",my[uy]="inactiveSpriteAsset";const fy={};fy[ly]="_defaultSpriteFrame",fy[cy]="hoverSpriteFrame",fy[dy]="pressedSpriteFrame",fy[uy]="inactiveSpriteFrame";class _y extends Lg{constructor(t,e){super(t,e),this._visualState=ly,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new J(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new iy(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",t)}_toggleLifecycleListeners(t,e){this[t]("set_active",this._onSetActive,this),this[t]("set_transitionMode",this._onSetTransitionMode,this),this[t]("set_hoverTint",this._onSetTransitionValue,this),this[t]("set_pressedTint",this._onSetTransitionValue,this),this[t]("set_inactiveTint",this._onSetTransitionValue,this),this[t]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[t]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[t]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[t]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(t,e,s){e!==s&&this._updateVisualState()}_onSetTransitionMode(t,e,s){e!==s&&(this._cancelTween(),this._resetToDefaultVisualState(e),this._forceReapplyVisualState())}_onSetTransitionValue(t,e,s){e!==s&&this._forceReapplyVisualState()}_onElementComponentRemove(t){this.entity===t&&this._toggleHitElementListeners("off")}_onElementComponentAdd(t){this.entity===t&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(t){if(this.entity.element){const e="on"===t;if(e&&this._hasHitElementListeners)return;this.entity.element[t]("mouseenter",this._onMouseEnter,this),this.entity.element[t]("mouseleave",this._onMouseLeave,this),this.entity.element[t]("mousedown",this._onMouseDown,this),this.entity.element[t]("mouseup",this._onMouseUp,this),this.entity.element[t]("touchstart",this._onTouchStart,this),this.entity.element[t]("touchend",this._onTouchEnd,this),this.entity.element[t]("touchleave",this._onTouchLeave,this),this.entity.element[t]("touchcancel",this._onTouchCancel,this),this.entity.element[t]("selectstart",this._onSelectStart,this),this.entity.element[t]("selectend",this._onSelectEnd,this),this.entity.element[t]("selectenter",this._onSelectEnter,this),this.entity.element[t]("selectleave",this._onSelectLeave,this),this.entity.element[t]("click",this._onClick,this),this._hasHitElementListeners=e}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const t=this._imageReference.entity.element;t.type!==ry&&(this._storeDefaultColor(t.color),this._storeDefaultOpacity(t.opacity),this._storeDefaultSpriteAsset(t.spriteAsset),this._storeDefaultSpriteFrame(t.spriteFrame))}}_storeDefaultColor(t){this._defaultTint.r=t.r,this._defaultTint.g=t.g,this._defaultTint.b=t.b}_storeDefaultOpacity(t){this._defaultTint.a=t}_storeDefaultSpriteAsset(t){this._defaultSpriteAsset=t}_storeDefaultSpriteFrame(t){this._defaultSpriteFrame=t}_onSetColor(t){this._isApplyingTint||(this._storeDefaultColor(t),this._forceReapplyVisualState())}_onSetOpacity(t){this._isApplyingTint||(this._storeDefaultOpacity(t),this._forceReapplyVisualState())}_onSetSpriteAsset(t){this._isApplyingSprite||(this._storeDefaultSpriteAsset(t),this._forceReapplyVisualState())}_onSetSpriteFrame(t){this._isApplyingSprite||(this._storeDefaultSpriteFrame(t),this._forceReapplyVisualState())}_onMouseEnter(t){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",t)}_onMouseLeave(t){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",t)}_onMouseDown(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",t)}_onMouseUp(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",t)}_onTouchStart(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",t)}_onTouchEnd(t){t.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",t)}_onTouchLeave(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",t)}_onTouchCancel(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",t)}_onSelectStart(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",t)}_onSelectEnd(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",t)}_onSelectEnter(t){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",t)}_onSelectLeave(t){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",t)}_onClick(t){this._fireIfActive("click",t)}_fireIfActive(t,e){this.data.active&&this.fire(t,e)}_updateVisualState(t){const e=this._visualState,s=this._determineVisualState();if((e!==s||t)&&this.enabled)switch(this._visualState=s,e===cy&&this._fireIfActive("hoverend"),e===dy&&this._fireIfActive("pressedend"),s===cy&&this._fireIfActive("hoverstart"),s===dy&&this._fireIfActive("pressedstart"),this.transitionMode){case ny:{const t=this[py[this._visualState]];this._applyTint(t);break}case ay:{const t=my[this._visualState],e=fy[this._visualState],s=this[t],i=this[e];this._applySprite(s,i);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(t){if(this._imageReference.hasComponent("element"))switch(t){case ny:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case ay:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}}_determineVisualState(){return this.active?this._isPressed?dy:this._isHovering?cy:ly:uy}_applySprite(t,e){e=e||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==t&&(this._imageReference.entity.element.spriteAsset=t),this._imageReference.entity.element.spriteFrame!==e&&(this._imageReference.entity.element.spriteFrame=e),this._isApplyingSprite=!1)}_applyTint(t){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(t):this._applyTintWithTween(t)}_applyTintImmediately(t){if(!t||!this._imageReference.hasComponent("element"))return;const e=gy(t);this._isApplyingTint=!0,e.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=e),this._imageReference.entity.element.opacity!=t.a&&(this._imageReference.entity.element.opacity=t.a),this._isApplyingTint=!1}_applyTintWithTween(t){if(!t||!this._imageReference.hasComponent("element"))return;const e=gy(t),s=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;e.equals(s)&&t.a==i||(this._tweenInfo={startTime:k(),from:new J(s.r,s.g,s.b,i),to:t.clone(),lerpColor:new J})}_updateTintTween(){const t=k()-this._tweenInfo.startTime;let e=0===this.fadeDuration?1:t/this.fadeDuration;if(e=V.clamp(e,0,1),Math.abs(e-1)>1e-5){const t=this._tweenInfo.lerpColor;t.lerp(this._tweenInfo.from,this._tweenInfo.to,e),this._applyTintImmediately(new J(t.r,t.g,t.b,t.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}function gy(t){return new J(t.r,t.g,t.b)}class yy{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new nt,this.transitionMode=ny,this.hoverTint=new J(.75,.75,.75),this.pressedTint=new J(.5,.5,.5),this.inactiveTint=new J(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}const vy=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class xy extends Ig{constructor(t){super(t),this.id="button",this.ComponentType=_y,this.DataType=yy,this.schema=vy,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,vy)}onUpdate(t){const e=this.store;for(const t in e){const s=e[t].entity,i=s.button;i.enabled&&s.enabled&&i.onUpdate()}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}let by;Lg._buildAccessors(_y.prototype,vy);class Sy{constructor(t,e){this.effect=t,this.inputTarget=e,this.outputTarget=null,this.name=t.constructor.name}}class wy{constructor(t,e){this.app=t,this.camera=e,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=()=>{this.resizeRenderTargets()},e.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(t,e){const s=this.camera.rect,i=Math.floor(s.z*this.app.graphicsDevice.width*this.renderTargetScale),n=Math.floor(s.w*this.app.graphicsDevice.height*this.renderTargetScale),a=new Mr(this.app.graphicsDevice,{format:t,width:i,height:n,mipmaps:!1,minFilter:di,magFilter:di,addressU:Ws,addressV:Ws});return a.name=e,a}_createOffscreenTarget(t,e){const s=this.app.graphicsDevice,i=e?s.getHdrFormat():Li,n=this.camera.entity.name+"-posteffect-"+this.effects.length,a=this._allocateColorBuffer(i,n),r=this.app.graphicsDevice.supportsStencil,o=t?s.samples:1;return new uh({colorBuffer:a,depth:t,stencil:r,samples:o})}_resizeOffscreenTarget(t){const e=t.colorBuffer.format,s=t.colorBuffer.name;t.destroyFrameBuffers(),t.destroyTextureBuffers(),t._colorBuffer=this._allocateColorBuffer(e,s)}_destroyOffscreenTarget(t){t.destroyTextureBuffers(),t.destroy()}setRenderTargetScale(t){this.renderTargetScale=t,this.resizeRenderTargets()}addEffect(t){const e=this.effects,s=0===e.length,i=this._createOffscreenTarget(s,t.hdr),n=new Sy(t,i);e.push(n),this._sourceTarget=n.inputTarget,e.length>1&&(e[e.length-2].outputTarget=n.inputTarget),this._newPostEffect=t,t.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(t){let e=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===t){e=s;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[e].inputTarget),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){const e=this.effects[t].effect;this._newPostEffect!==e&&(e.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){by||(by=this.app.scene.layers.getLayerById(Gt)),by&&by.incrementCounter()}_releaseDepthMap(){by&&by.decrementCounter()}destroy(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let t=null;const e=this.effects.length;if(e)for(let s=0;s<e;s++){const i=this.effects[s];let n=i.outputTarget;s===e-1&&(t=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,t)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(t,e){const s=this.camera.rect,i=this.app.graphicsDevice;this.camera.camera.aspectRatio=i.width*s.z/(i.height*s.w),this.resizeTimeout||(k()-this.resizeLast>100?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))}resizeRenderTargets(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=k();const t=this.camera.rect,e=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale),s=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale),i=this.effects;for(let t=0,n=i.length;t<n;t++){const n=i[t];n.inputTarget.width===e&&n.inputTarget.height===s||this._resizeOffscreenTarget(n.inputTarget)}}onCameraRectChanged(t,e,s){this.enabled&&this.resizeRenderTargets()}}const My=[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustum",readonly:!0},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"projectionMatrix",readonly:!0},{name:"scissorRect",readonly:!1},{name:"viewMatrix",readonly:!0},{name:"vrDisplay",readonly:!1}];class Ty extends Lg{constructor(t,e){super(t,e),this._camera=new Rr,this._camera.node=e,this._priority=0,this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._disablePostEffectsLayer=qt,this._postEffects=new wy(t.app,this)}get camera(){return this._camera}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirtyCameras=!0}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set disablePostEffectsLayer(t){this._disablePostEffectsLayer=t,this.dirtyLayerCompositionCameras()}get postEffectsEnabled(){return this._postEffects.enabled}get layers(){return this._camera.layers}set layers(t){const e=this._camera.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}if(this._camera.layers=t,this.enabled&&this.entity.enabled)for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}get postEffects(){return this._postEffects}get priority(){return this._priority}set priority(t){this._priority=t,this.dirtyLayerCompositionCameras()}get rect(){return this._camera.rect}set rect(t){this._camera.rect=t,this.fire("set:rect",this._camera.rect)}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearColorBuffer(t){this._camera.clearColorBuffer=t,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearDepthBuffer(t){this._camera.clearDepthBuffer=t,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set clearStencilBuffer(t){this._camera.clearStencilBuffer=t,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set renderTarget(t){this._camera.renderTarget=t,this.dirtyLayerCompositionCameras()}screenToWorld(t,e,s,i){const n=this.system.app.graphicsDevice,a=n.clientRect.width,r=n.clientRect.height;return this._camera.screenToWorld(t,e,s,a,r,i)}worldToScreen(t,e){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(t,i,n,e)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}removeCameraFromLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}}onLayersChanged(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addCamera(this)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeCamera(this)}onEnable(){const t=this.system,e=t.app.scene,s=e.layers;t.addCamera(this),e.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const t=this.system,e=t.app.scene,s=e.layers;this.postEffects.disable(),this.removeCameraFromLayers(),e.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),t.removeCamera(this)}onRemove(){this.onDisable(),this.off()}calculateAspectRatio(t){const e=t||this.system.app.graphicsDevice,s=this.rect;return e.width*s.z/(e.height*s.w)}frameBegin(t){this.aspectRatioMode===Es&&(this.aspectRatio=this.calculateAspectRatio(t))}frameEnd(){}enterVr(t,e){if(t instanceof Function&&!e&&(e=t,t=null),this.system.app.vr)if(t||(t=this.system.app.vr.display),t){const s=this;t.capabilities.canPresent?t.requestPresent((function(i){i||(s.vrDisplay=t,s.vrDisplay.once("beforepresentchange",(function(t){t.presenting||(s.vrDisplay=null)}))),e(i)})):(s.vrDisplay=t,e())}else e("No pc.VrDisplay to present");else e("VrManager not created. Enable VR in project settings.")}exitVr(t){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){const e=this.vrDisplay;this.vrDisplay=null,e.exitPresent(t)}else this.vrDisplay=null,t();else t("Not presenting VR")}startXr(t,e,s){this.system.app.xr.start(this,t,e,s)}endXr(t){this._camera.xr?this._camera.xr.end(t):t&&t(new Error("Camera is not in XR"))}copy(t){My.forEach((e=>{if(!e.readonly){const s=e.name;this[s]=t[s]}})),this.clearColorBuffer=t.clearColorBuffer,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencilBuffer=t.clearStencilBuffer,this.disablePostEffectsLayer=t.disablePostEffectsLayer,this.layers=t.layers,this.priority=t.priority,this.renderTarget=t.renderTarget,this.rect=t.rect}}My.forEach((function(t){const e=t.name,s={get:function(){return this._camera[e]}};t.readonly||(s.set=function(t){this._camera[e]=t}),Object.defineProperty(Ty.prototype,e,s)}));class Ay{constructor(){this.enabled=!0}}const Cy=["enabled"];class Py extends Ig{constructor(t){super(t),this.id="camera",this.ComponentType=Ty,this.DataType=Ay,this.schema=Cy,this.cameras=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect"];for(let i=0;i<s.length;i++){const n=s[i];if(e.hasOwnProperty(n)){const s=e[n];switch(n){case"rect":case"scissorRect":Array.isArray(s)?t[n]=new nt(s[0],s[1],s[2],s[3]):t[n]=s;break;case"clearColor":Array.isArray(s)?t[n]=new J(s[0],s[1],s[2],s[3]):t[n]=s;break;default:t[n]=s}}}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.camera;this.addComponent(e,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect})}onBeforeRemove(t,e){this.removeCamera(e)}onUpdate(t){if(this.app.vr){const t=this.store;for(const e in t){const s=t[e];if(s.data.enabled&&s.entity.enabled){const t=s.entity.camera,e=t.vrDisplay;e&&(e.setClipPlanes(t.nearClip,t.farClip),s.entity&&(s.entity.localTransform.copy(e.combinedViewInv),s.entity._dirtyLocal=!1,s.entity._dirtifyWorld()))}}}}onAppPrerender(){for(let t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()}addCamera(t){this.cameras.push(t),this.sortCamerasByPriority()}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this.sortCamerasByPriority())}sortCamerasByPriority(){this.cameras.sort((function(t,e){return t.priority-e.priority}))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lg._buildAccessors(Ty.prototype,Cy);class Ry extends Lg{constructor(t,e){super(t,e),this._compoundParent=null,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}onSetType(t,e,s){e!==s&&this.system.changeType(this,e,s)}onSetHalfExtents(t,e,s){const i=this.data.type;this.data.initialized&&"box"===i&&this.system.recreatePhysicalShapes(this)}onSetRadius(t,e,s){const i=this.data.type;!this.data.initialized||"sphere"!==i&&"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetHeight(t,e,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAxis(t,e,s){const i=this.data.type;!this.data.initialized||"capsule"!==i&&"cylinder"!==i&&"cone"!==i||this.system.recreatePhysicalShapes(this)}onSetAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&t.off("remove",this.onAssetRemoved,this)}if(s){s instanceof wm&&(this.data.asset=s.id);const t=i.get(this.data.asset);t&&(t.off("remove",this.onAssetRemoved,this),t.on("remove",this.onAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&t.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof wm&&(this.data.renderAsset=s.id);const t=i.get(this.data.renderAsset);t&&(t.off("remove",this.onRenderAssetRemoved,this),t.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(t,e,s){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(t,e,s){this.onSetModel(t,e,s)}onAssetRemoved(t){t.off("remove",this.onAssetRemoved,this),this.data.asset===t.id&&(this.asset=null)}onRenderAssetRemoved(t){t.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===t.id&&(this.renderAsset=null)}_getCompoundChildShapeIndex(t){const e=this.data.shape,s=e.getNumChildShapes();for(let i=0;i<s;i++){if(e.getChildShape(i).ptr===t.ptr)return i}return null}_onInsert(t){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let t=this.entity.parent;for(;t;){if(t.collision&&"compound"===t.collision.type){0===t.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}}}_updateCompound(){const t=this.entity;if(t._dirtyWorld){let e=t._dirtyLocal,s=t;for(;s&&!e&&(!s.collision||s.collision!==this._compoundParent);)s._dirtyLocal&&(e=!0),s=s.parent;if(e){t.forEach(this.system.implementations.compound._updateEachDescendantTransform,t);const e=this._compoundParent.entity.rigidbody;e&&e.activate()}}}onEnable(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const t=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(t&&(!t.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else{const t=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(t,this.data.shape),Ammo.destroy(t),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}class Ey{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new it(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}const Ly="static",Iy="dynamic",Dy="kinematic",Fy=2,Oy=4,ky=1,By=4,zy=5,Uy=1,Vy=2,Ny=4,Wy=16,Gy=65535,Hy=65533;let jy,qy,Xy;class Yy{constructor(t,e,s){this.entity=e.entity,this.component=e,this.app=t,"undefined"==typeof Ammo||jy||(jy=new Ammo.btVector3,qy=new Ammo.btQuaternion,Xy=new Ammo.btTransform),this.initialize(s)}initialize(t){const e=this.entity,s=t.shape;if(s&&"undefined"!=typeof Ammo){e.trigger&&e.trigger.destroy();const t=1,i=e.getPosition(),n=e.getRotation();jy.setValue(i.x,i.y,i.z),qy.setValue(n.x,n.y,n.z,n.w),Xy.setOrigin(jy),Xy.setRotation(qy);const a=this.app.systems.rigidbody.createBody(t,s,Xy);a.setRestitution(0),a.setFriction(0),a.setDamping(0,0),jy.setValue(0,0,0),a.setLinearFactor(jy),a.setAngularFactor(jy),a.setCollisionFlags(a.getCollisionFlags()|Oy),a.entity=e,this.body=a,this.component.enabled&&e.enabled&&this.enable()}}destroy(){const t=this.body;t&&(this.disable(),this.app.systems.rigidbody.destroyBody(t))}_getEntityTransform(t){const e=this.entity.getPosition(),s=this.entity.getRotation();jy.setValue(e.x,e.y,e.z),qy.setValue(s.x,s.y,s.z,s.w),t.setOrigin(jy),t.setRotation(qy)}updateTransform(){this._getEntityTransform(Xy);const t=this.body;t.setWorldTransform(Xy),t.activate()}enable(){const t=this.body;if(!t)return;const e=this.app.systems;e.rigidbody.addBody(t,Wy,Hy^Wy),e.rigidbody._triggers.push(this),t.forceActivationState(ky),this.updateTransform()}disable(){const t=this.body;if(!t)return;const e=this.app.systems,s=e.rigidbody._triggers.indexOf(this);s>-1&&e.rigidbody._triggers.splice(s,1),e.rigidbody.removeBody(t),t.forceActivationState(zy)}}const Ky=new dt,$y=new it,Zy=new ft,Jy=new jr,Qy=["enabled","type","halfExtents","radius","axis","height","asset","renderAsset","shape","model","render"];class tv{constructor(t){this.system=t}beforeInitialize(t,e){e.shape=null,e.model=new vd,e.model.graph=new jr}afterInitialize(t,e){this.recreatePhysicalShapes(t),t.data.initialized=!0}reset(t,e){this.beforeInitialize(t,e),this.afterInitialize(t,e)}recreatePhysicalShapes(t){const e=t.entity,s=t.data;if("undefined"!=typeof Ammo){e.trigger&&(e.trigger.destroy(),delete e.trigger),s.shape&&(t._compoundParent&&(this.system._removeCompoundChild(t._compoundParent,s.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),Ammo.destroy(s.shape),s.shape=null),s.shape=this.createPhysicalShape(t.entity,s);const i=!t._compoundParent;if("compound"!==s.type||t._compoundParent&&t!==t._compoundParent){if("compound"!==s.type&&(t._compoundParent&&t===t._compoundParent&&e.forEach(this.system.implementations.compound._updateEachDescendant,t),!t.rigidbody)){t._compoundParent=null;let s=e.parent;for(;s;){if(s.collision&&"compound"===s.collision.type){t._compoundParent=s.collision;break}s=s.parent}}}else t._compoundParent=t,e.forEach(this._addEachDescendant,t);t._compoundParent&&t!==t._compoundParent&&(i&&0===t._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t._compoundParent):(this.system.updateCompoundChildTransform(e),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate())),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):t._compoundParent||(e.trigger?e.trigger.initialize(s):e.trigger=new Yy(this.system.app,t,s))}}createPhysicalShape(t,e){}updateTransform(t,e,s,i){t.entity.trigger&&t.entity.trigger.updateTransform()}beforeRemove(t,e){e.data.shape&&(e._compoundParent&&!e._compoundParent.entity._destroying&&(this.system._removeCompoundChild(e._compoundParent,e.data.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),e._compoundParent=null,Ammo.destroy(e.data.shape),e.data.shape=null)}remove(t,e){const s=this.system.app;t.rigidbody&&t.rigidbody.body&&t.rigidbody.disableSimulation(),t.trigger&&(t.trigger.destroy(),delete t.trigger),s.scene.containsModel(e.model)&&(s.root.removeChild(e.model.graph),s.scene.removeModel(e.model))}clone(t,e){const s=this.system.store[t.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],radius:s.data.radius,axis:s.data.axis,height:s.data.height,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render};return this.system.addComponent(e,i)}}class ev extends tv{createPhysicalShape(t,e){if("undefined"!=typeof Ammo){const t=e.halfExtents,s=new Ammo.btVector3(t?t.x:.5,t?t.y:.5,t?t.z:.5),i=new Ammo.btBoxShape(s);return Ammo.destroy(s),i}}}class sv extends tv{createPhysicalShape(t,e){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(e.radius)}}class iv extends tv{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=e.radius||.5,n=Math.max((e.height||2)-2*i,0);let a=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btCapsuleShapeX(i,n);break;case 1:a=new Ammo.btCapsuleShape(i,n);break;case 2:a=new Ammo.btCapsuleShapeZ(i,n)}return a}}class nv extends tv{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=void 0!==e.radius?e.radius:.5,n=void 0!==e.height?e.height:1;let a=null,r=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btVector3(.5*n,i,i),r=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(i,.5*n,i),r=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(i,i,.5*n),r=new Ammo.btCylinderShapeZ(a)}return a&&Ammo.destroy(a),r}}class av extends tv{createPhysicalShape(t,e){const s=void 0!==e.axis?e.axis:1,i=void 0!==e.radius?e.radius:.5,n=void 0!==e.height?e.height:1;let a=null;if("undefined"!=typeof Ammo)switch(s){case 0:a=new Ammo.btConeShapeX(i,n);break;case 1:a=new Ammo.btConeShape(i,n);break;case 2:a=new Ammo.btConeShapeZ(i,n)}return a}}class rv extends tv{beforeInitialize(t,e){}createAmmoMesh(t,e,s){let i;if(this.system._triMeshCache[t.id])i=this.system._triMeshCache[t.id];else{const e=t.vertexBuffer,s=e.getFormat();let n,a;for(let t=0;t<s.elements.length;t++){const i=s.elements[t];if(i.name===ln){a=new Float32Array(e.lock(),i.offset),n=i.stride/4;break}}const r=[];t.getIndices(r);const o=t.primitive[0].count/3,h=new Ammo.btVector3,l=new Ammo.btVector3,c=new Ammo.btVector3;let d,u,p;const m=t.primitive[0].base;i=new Ammo.btTriangleMesh,this.system._triMeshCache[t.id]=i;for(let t=0;t<o;t++)d=r[m+3*t]*n,u=r[m+3*t+1]*n,p=r[m+3*t+2]*n,h.setValue(a[d],a[d+1],a[d+2]),l.setValue(a[u],a[u+1],a[u+2]),c.setValue(a[p],a[p+1],a[p+2]),i.addTriangle(h,l,c,!0);Ammo.destroy(h),Ammo.destroy(l),Ammo.destroy(c)}const n=new Ammo.btBvhTriangleMeshShape(i,!0),a=this.system._getNodeScaling(e);n.setLocalScaling(a),Ammo.destroy(a);const r=this.system._getNodeTransform(e);s.addChildShape(r,n),Ammo.destroy(r)}createPhysicalShape(t,e){if("undefined"!=typeof Ammo&&(e.model||e.render)){const s=new Ammo.btCompoundShape;if(e.model){const t=e.model.meshInstances;for(let e=0;e<t.length;e++)this.createAmmoMesh(t[e].mesh,t[e].node,s)}else if(e.render){const t=e.render.meshes;for(let e=0;e<t.length;e++)this.createAmmoMesh(t[e],Jy,s)}const i=t.getWorldTransform().getScale(),n=new Ammo.btVector3(i.x,i.y,i.z);return s.setLocalScaling(n),Ammo.destroy(n),s}}recreatePhysicalShapes(t){const e=t.data;(e.renderAsset||e.asset)&&t.enabled&&t.entity.enabled?this.loadAsset(t,e.renderAsset||e.asset,e.renderAsset?"render":"model"):this.doRecreatePhysicalShape(t)}loadAsset(t,e,s){const i=t.data,n=this.system.app.assets,a=n.get(e);a?(a.ready((e=>{i[s]=e.resource,this.doRecreatePhysicalShape(t)})),n.load(a)):n.once("add:"+e,(e=>{e.ready((e=>{i[s]=e.resource,this.doRecreatePhysicalShape(t)})),n.load(e)}))}doRecreatePhysicalShape(t){const e=t.entity,s=t.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(e,s),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):e.trigger?e.trigger.initialize(s):e.trigger=new Yy(this.system.app,t,s)):(this.beforeRemove(e,t),this.remove(e,s))}updateTransform(t,e,s,i){if(t.shape){const e=t.entity.getWorldTransform().getScale(),s=t.shape.getLocalScaling();e.x===s.x()&&e.y===s.y()&&e.z===s.z()||this.doRecreatePhysicalShape(t)}super.updateTransform(t,e,s,i)}destroyShape(t){if(!t.shape)return;const e=t.shape.getNumChildShapes();for(let s=0;s<e;s++){const e=t.shape.getChildShape(s);Ammo.destroy(e)}Ammo.destroy(t.shape),t.shape=null}remove(t,e){this.destroyShape(e),super.remove(t,e)}}class ov extends tv{createPhysicalShape(t,e){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape}_addEachDescendant(t){t.collision&&!t.rigidbody&&(t.collision._compoundParent=this,t!==this.entity&&t.collision.system.recreatePhysicalShapes(t.collision))}_updateEachDescendant(t){t.collision&&t.collision._compoundParent===this&&(t.collision._compoundParent=null,t===this.entity||t.rigidbody||t.collision.system.recreatePhysicalShapes(t.collision))}_updateEachDescendantTransform(t){t.collision&&t.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(t)}}class hv extends Ig{constructor(t){super(t),this.id="collision",this.ComponentType=Ry,this.DataType=Ey,this.schema=Qy,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(t,e,s){const i={};for(let t=0,n=(s=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled"]).length;t<n;t++){const n=s[t];i[n]=e[n]}let n;e.hasOwnProperty("asset")?(n=s.indexOf("model"),-1!==n&&s.splice(n,1),n=s.indexOf("render"),-1!==n&&s.splice(n,1)):e.hasOwnProperty("model")&&(n=s.indexOf("asset"),-1!==n&&s.splice(n,1)),i.type||(i.type=t.data.type),t.data.type=i.type,i.halfExtents&&Array.isArray(i.halfExtents)&&(i.halfExtents=new it(i.halfExtents[0],i.halfExtents[1],i.halfExtents[2]));const a=this._createImplementation(i.type);a.beforeInitialize(t,i),super.initializeComponentData(t,i,s),a.afterInitialize(t,i)}_createImplementation(t){if(void 0===this.implementations[t]){let e;switch(t){case"box":e=new ev(this);break;case"sphere":e=new sv(this);break;case"capsule":e=new iv(this);break;case"cylinder":e=new nv(this);break;case"cone":e=new av(this);break;case"mesh":e=new rv(this);break;case"compound":e=new ov(this)}this.implementations[t]=e}return this.implementations[t]}_getImplementation(t){return this.implementations[t.collision.data.type]}cloneComponent(t,e){return this._getImplementation(t).clone(t,e)}onBeforeRemove(t,e){this.implementations[e.data.type].beforeRemove(t,e),e.onBeforeRemove()}onRemove(t,e){this.implementations[e.type].remove(t,e)}updateCompoundChildTransform(t){if(this._removeCompoundChild(t.collision._compoundParent,t.collision.data.shape),t.enabled&&t.collision.enabled){const e=this._getNodeTransform(t,t.collision._compoundParent.entity);t.collision._compoundParent.shape.addChildShape(e,t.collision.data.shape),Ammo.destroy(e)}}_removeCompoundChild(t,e){if(t.shape.removeChildShape)t.shape.removeChildShape(e);else{const s=t._getCompoundChildShapeIndex(e);null!==s&&t.shape.removeChildShapeByIndex(s)}}onTransformChanged(t,e,s,i){this.implementations[t.data.type].updateTransform(t,e,s,i)}changeType(t,e,s){this.implementations[e].beforeRemove(t.entity,t),this.implementations[e].remove(t.entity,t.data),this._createImplementation(s).reset(t,t.data)}recreatePhysicalShapes(t){this.implementations[t.data.type].recreatePhysicalShapes(t)}_calculateNodeRelativeTransform(t,e){if(t===e){const e=t.getWorldTransform().getScale();Ky.setScale(e.x,e.y,e.z)}else this._calculateNodeRelativeTransform(t.parent,e),Ky.mul(t.getLocalTransform())}_getNodeScaling(t){const e=t.getWorldTransform().getScale();return new Ammo.btVector3(e.x,e.y,e.z)}_getNodeTransform(t,e){let s,i;e?(this._calculateNodeRelativeTransform(t,e),s=$y,i=Zy,Ky.getTranslation(s),i.setFromMat4(Ky)):(s=t.getPosition(),i=t.getRotation());const n=new Ammo.btTransform;n.setIdentity();const a=n.getOrigin();a.setValue(s.x,s.y,s.z);const r=new Ammo.btQuaternion;return r.setValue(i.x,i.y,i.z,i.w),n.setRotation(r),Ammo.destroy(r),Ammo.destroy(a),n}destroy(){for(const t in this._triMeshCache)Ammo.destroy(this._triMeshCache[t]);this._triMeshCache=null,super.destroy()}}Lg._buildAccessors(Ry.prototype,Qy);class lv extends u{constructor(){super(),this.list=[]}add(t){const e=t.id;if(this[e])throw new Error(`ComponentSystem name '${e}' already registered or not allowed`);this[e]=t,this.list.push(t)}remove(t){const e=t.id;if(!this[e])throw new Error(`No ComponentSystem named '${e}' registered`);delete this[e];const s=this.list.indexOf(this[e]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let t=0;t<this.list.length;t++)this.list[t].destroy()}}class cv{constructor(t,e,s){this._entity=t,this._element=t.element,this.model=new vd,this.node=new jr,this.model.graph=this.node,this.mesh=e,this.meshInstance=new dl(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+t.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null}setMesh(t){this.meshInstance&&(this.mesh=t,this.meshInstance.mesh=t,this.meshInstance.visible=!!t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=t),this.forceUpdateAabb())}setMask(t){if(this.meshInstance){if(t){this.unmaskMeshInstance=new dl(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const t in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data)}else{const t=this.model.meshInstances.indexOf(this.unmaskMeshInstance);t>=0&&this.model.meshInstances.splice(t,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}}setMaterial(t){this.meshInstance&&(this.meshInstance.material=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=t))}setParameter(t,e){this.meshInstance&&(this.meshInstance.setParameter(t,e),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(t,e))}deleteParameter(t){this.meshInstance&&(this.meshInstance.deleteParameter(t),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(t))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const t=function t(e){let s;const i=e.children,n=i.length;if(n){for(let t=0;t<n;t++)i[t].element&&(s=i[t]);if(!s)return null;const e=t(s);return e||s}return null};if(this.unmaskMeshInstance){const e=t(this._entity);e&&e.element?this.unmaskMeshInstance.drawOrder=e.element.drawOrder+e.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(t){this.meshInstance&&(this.meshInstance.drawOrder=t)}setCull(t){if(!this.meshInstance)return;const e=this._element;let s=null;t&&e._isScreenCulled()&&(s=function(t){return e.isVisibleForCamera(t)}),this.meshInstance.cull=t,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=t,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(t){this.meshInstance&&(this.meshInstance.screenSpace=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=t))}setLayer(t){this.meshInstance&&(this.meshInstance.layer=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=t))}forceUpdateAabb(t){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(t){this.meshInstance&&(this.meshInstance._updateAabbFunc=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=t))}}class dv{constructor(t){this._element=t,this._entity=t.entity,this._system=t.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._rect=new nt(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new st,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new nt,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new nt,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new cv(this._entity,this._defaultMesh,this._material),this._color=new J(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(t){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(t){this._updateMaterial(t)}_onScreenChange(t,e){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(t){this._renderable.setDrawOrder(t),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",(function(){this._renderable.setUnmaskDrawOrder()}),this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)}_use9Slicing(){return this.sprite&&(this.sprite.renderMode===ms||this.sprite.renderMode===fs)}_updateMaterial(t){const e=!!this._mask,s=!(!this.sprite||this.sprite.renderMode!==ms),i=!(!this.sprite||this.sprite.renderMode!==fs);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(t,e,s,i)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(t),this._renderable.setLayer(t?Ut:Nt))}_createMesh(){const t=this._element,e=t.calculatedWidth,s=t.calculatedHeight,i=this._rect,n=new ArrayBuffer(128),a=new Float32Array(n);a[5]=1,a[6]=i.x,a[7]=1-i.y,a[8]=e,a[13]=1,a[14]=i.x+i.z,a[15]=1-i.y,a[16]=e,a[17]=s,a[21]=1,a[22]=i.x+i.z,a[23]=1-(i.y+i.w),a[25]=s,a[29]=1,a[30]=i.x,a[31]=1-(i.y+i.w);const r=[{semantic:ln,components:3,type:oa},{semantic:cn,components:3,type:oa},{semantic:_n,components:2,type:oa}],o=this._system.app.graphicsDevice,h=new Ja(o,r),l=new $a(o,h,4,ti,n),c=new Uh(o);return c.vertexBuffer=l,c.primitive[0].type=hn,c.primitive[0].base=0,c.primitive[0].count=4,c.primitive[0].indexed=!1,c.aabb.setMinMax(it.ZERO,new it(e,s,0)),this._updateMesh(c),c}_updateMesh(t){const e=this._element,s=e.calculatedWidth,i=e.calculatedHeight,n=e._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||this.sprite.renderMode!==ms&&this.sprite.renderMode!==fs){const n=t.vertexBuffer,a=new Float32Array(n.lock()),r=e.pivot.x,o=e.pivot.y;a[0]=0-r*s,a[1]=0-o*i,a[8]=s-r*s,a[9]=0-o*i,a[16]=s-r*s,a[17]=i-o*i,a[24]=0-r*s,a[25]=i-o*i;let h=1,l=1,c=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const t=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];t&&(c=t.rect,h=this._sprite.atlas.texture.width,l=this._sprite.atlas.texture.height)}a[6]=c.x/h,a[7]=1-c.y/l,a[14]=(c.x+c.z)/h,a[15]=1-c.y/l,a[22]=(c.x+c.z)/h,a[23]=1-(c.y+c.w)/l,a[30]=c.x/h,a[31]=1-(c.y+c.w)/l,n.unlock();const d=new it(0-r*s,0-o*i,0),u=new it(s-r*s,i-o*i,0);t.aabb.setMinMax(d,u),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else{const t=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],n=2/t.rect.z,a=2/t.rect.w;this._innerOffset.set(t.border.x*n,t.border.y*a,t.border.z*n,t.border.w*a);const r=this.sprite.atlas.texture;this._atlasRect.set(t.rect.x/r.width,t.rect.y/r.height,t.rect.z/r.width,t.rect.w/r.height);const o=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,h=t.rect.z/o,l=t.rect.w/o;this._outerScale.set(Math.max(s,this._innerOffset.x*h),Math.max(i,this._innerOffset.y*l));let c=h,d=l;this._outerScale.x/=h,this._outerScale.y/=l,c*=V.clamp(s/(this._innerOffset.x*h),1e-4,1),d*=V.clamp(i/(this._innerOffset.y*l),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(c,d,1),this._renderable.node.setLocalPosition((.5-e.pivot.x)*s,(.5-e.pivot.y)*i,0))}this._meshDirty=!1}_updateSprite(){let t=!1,e=null;this._sprite&&this._sprite.atlas&&(e=this._sprite.meshes[this.spriteFrame],t=this._sprite.renderMode===ms||this._sprite.renderMode===fs),this.mesh=t?e:this._defaultMesh,this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._renderable.node.getWorldTransform()),t}_toggleMask(){this._element._dirtifyMask();const t=this._element._isScreenSpace();this._updateMaterial(t),this._renderable.setMask(!!this._mask)}_onMaterialLoad(t){this.material=t.resource}_onMaterialAdded(t){this._system.app.assets.off("add:"+t.id,this._onMaterialAdded,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_bindMaterialAsset(t){this._entity.enabled&&(t.on("load",this._onMaterialLoad,this),t.on("change",this._onMaterialChange,this),t.on("remove",this._onMaterialRemove,this),t.resource?this._onMaterialLoad(t):this._system.app.assets.load(t))}_unbindMaterialAsset(t){t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(t){this._system.app.assets.off("add:"+t.id,this._onTextureAdded,this),this._textureAsset===t.id&&this._bindTextureAsset(t)}_bindTextureAsset(t){this._entity.enabled&&(t.on("load",this._onTextureLoad,this),t.on("change",this._onTextureChange,this),t.on("remove",this._onTextureRemove,this),t.resource?this._onTextureLoad(t):this._system.app.assets.load(t))}_unbindTextureAsset(t){t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this)}_onTextureLoad(t){this.texture=t.resource}_onTextureChange(t){}_onTextureRemove(t){}_onSpriteAssetAdded(t){this._system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)}_bindSpriteAsset(t){this._entity.enabled&&(t.on("load",this._onSpriteAssetLoad,this),t.on("change",this._onSpriteAssetChange,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._system.app.assets.load(t))}_unbindSpriteAsset(t){t.off("load",this._onSpriteAssetLoad,this),t.off("change",this._onSpriteAssetChange,this),t.off("remove",this._onSpriteAssetRemove,this),t.data.textureAtlasAsset&&this._system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(t){if(t&&t.resource)if(t.resource.atlas)this.sprite=t.resource;else{const e=t.data.textureAtlasAsset;if(e){const t=this._system.app.assets;t.off("load:"+e,this._onTextureAtlasLoad,this),t.once("load:"+e,this._onTextureAtlasLoad,this)}}else this.sprite=null}_onSpriteAssetChange(t){this._onSpriteAssetLoad(t)}_onSpriteAssetRemove(t){}_bindSprite(t){t.on("set:meshes",this._onSpriteMeshesChange,this),t.on("set:pixelsPerUnit",this._onSpritePpuChange,this),t.on("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(t){t.off("set:meshes",this._onSpriteMeshesChange,this),t.off("set:pixelsPerUnit",this._onSpritePpuChange,this),t.off("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=V.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){this.sprite.renderMode!==ps&&null===this._pixelsPerUnit&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(t){const e=this._spriteAsset;e instanceof wm?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._system.app.assets.get(e))}onEnable(){if(this._materialAsset){const t=this._system.app.assets.get(this._materialAsset);t&&t.resource!==this._material&&this._bindMaterialAsset(t)}if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==this._texture&&this._bindTextureAsset(t)}if(this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==this._sprite&&this._bindSpriteAsset(t)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(t){this._renderable.meshInstance.stencilFront=t,this._renderable.meshInstance.stencilBack=t;let e=0;if(this._element.maskedBy&&(e=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const t=new Iu({ref:e+1,func:yi,zpass:jn});this._renderable.unmaskMeshInstance.stencilFront=t,this._renderable.unmaskMeshInstance.stencilBack=t}}get color(){return this._color}set color(t){const e=t.r,s=t.g,i=t.b;this._color.r===e&&this._color.g===s&&this._color.b===i||(this._color.r=e,this._color.g=s,this._color.b=i,this._colorUniform[0]=e,this._colorUniform[1]=s,this._colorUniform[2]=i,this._renderable.setParameter("material_emissive",this._colorUniform)),this._element&&this._element.fire("set:color",this._color)}get opacity(){return this._color.a}set opacity(t){t!==this._color.a&&(this._color.a=t,this._renderable.setParameter("material_opacity",t)),this._element&&this._element.fire("set:opacity",t)}get rect(){return this._rect}set rect(t){let e,s,i,n;t instanceof nt?(e=t.x,s=t.y,i=t.z,n=t.w):(e=t[0],s=t[1],i=t[2],n=t[3]),e===this._rect.x&&s===this._rect.y&&i===this._rect.z&&n===this._rect.w||(this._rect.set(e,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get material(){return this._material}set material(t){if(this._material!==t){if(!t){const e=this._element._isScreenSpace();t=this.mask?e?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}this._material=t,t&&(this._renderable.setMaterial(t),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}get materialAsset(){return this._materialAsset}set materialAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof wm&&(s=t.id),this._materialAsset!==s){if(this._materialAsset){e.off("add:"+this._materialAsset,this._onMaterialAdded,this);const t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this))}if(this._materialAsset=s,this._materialAsset){const t=e.get(this._materialAsset);t?this._bindMaterialAsset(t):(this.material=null,e.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this.material=null}}get texture(){return this._texture}set texture(t){if(this._texture!==t){if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==t&&(this.textureAsset=null)}this._texture=t,t?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}get textureAsset(){return this._textureAsset}set textureAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof wm&&(s=t.id),this._textureAsset!==s){if(this._textureAsset){e.off("add:"+this._textureAsset,this._onTextureAdded,this);const t=e.get(this._textureAsset);t&&(t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const t=e.get(this._textureAsset);t?this._bindTextureAsset(t):(this.texture=null,e.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}get spriteAsset(){return this._spriteAsset}set spriteAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof wm&&(s=t.id),this._spriteAsset!==s){if(this._spriteAsset){e.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);const t=e.get(this._spriteAsset);t&&this._unbindSpriteAsset(t)}if(this._spriteAsset=s,this._spriteAsset){const t=e.get(this._spriteAsset);t?this._bindSpriteAsset(t):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get sprite(){return this._sprite}set sprite(t){if(this._sprite!==t){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==t&&(this.spriteAsset=null)}this._sprite=t,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=V.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){const e=this._spriteFrame;this._sprite?this._spriteFrame=V.clamp(t,0,this._sprite.frameKeys.length-1):this._spriteFrame=t,this._spriteFrame!==e&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",t)}get mesh(){return this._renderable.mesh}set mesh(t){this._renderable.setMesh(t),this._defaultMesh===t?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this._toggleMask())}get pixelsPerUnit(){return this._pixelsPerUnit}set pixelsPerUnit(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,!this._sprite||this._sprite.renderMode!==ms&&this._sprite.renderMode!==fs||this._updateSprite())}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}const uv=/[A-Z|a-z|0-9|_|-|/]/;class pv{constructor(t){this._symbols=t,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let t=this._read();for(;8===t;)t=this._read();return 0!==t&&1!==t&&(this._last=this._index),t}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const t=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let e=this.read(),s="";for(;s+=(s.length>0?"\n":"")+t[e]+" '"+this.buf().join("")+"'",0!==e&&1!==e;)e=this.read();return s}_read(){return this._buf=[],this._eof()?0:"text"===this._mode?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?2:0;case"[":return this._mode="tag",this._buf.length>0?2:this._tag();case"\\":if(this._next(),"["===this._cur)this._store();else this._output("\\");break;default:this._store()}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}}_whitespace(){for(this._store();-1!==" \t\n\r\v\f".indexOf(this._cur);)this._store();return 8}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store()}}_identifier(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7}_isIdentifierSymbol(t){return 1===t.length&&null!==t.match(uv)}_eof(){return null===this._cur}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(t){this._buf.push(t)}}class mv{constructor(t){this._scanner=new pv(t),this._error=null}parse(t,e){for(;;){switch(this._scanner.read()){case 0:return!0;case 1:default:return!1;case 2:Array.prototype.push.apply(t,this._scanner.buf());break;case 3:if(!this._parseTag(t,e))return!1}}}error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(t,e){let s=this._scanner.read();if(7!==s)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if("/"===i[0]){for(let n=e.length-1;n>=0;--n)if(i==="/"+e[n].name&&null===e[n].end)return e[n].end=t.length,s=this._scanner.read(),4===s||(this._error="expected close bracket",!1);return this._error="failed to find matching tag",!1}const n={name:i,value:null,attributes:{},start:t.length,end:null};if(s=this._scanner.read(),5===s){if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;n.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case 4:return e.push(n),!0;case 7:{const t=this._scanner.buf().join("");if(s=this._scanner.read(),5!==s)return this._error="expected equals",!1;if(s=this._scanner.read(),6!==s)return this._error="expected string",!1;const e=this._scanner.buf().join("");n.attributes[t]=e;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function fv(t,e){for(const s in e){if(!e.hasOwnProperty(s))continue;const i=e[s];i instanceof Object?(t.hasOwnProperty(s)||(t[s]={}),fv(t[s],e[s])):t[s]=i}}function _v(t){if(0===t.length)return null;const e={};for(let s=0;s<t.length;++s){const i=t[s],n={};n[i.name]={value:i.value,attributes:i.attributes},fv(e,n)}return e}function gv(t){const e=new mv(t),s=[],i=[];if(!e.parse(s,i))return console.warn(e.error()),{symbols:t,tags:null};const n=i.find((function(t){return null===t.end}));if(n)return console.warn(`Markup error: found unclosed tag='${n.name}'`),{symbols:t,tags:null};const a=function(t,e){if(0===t.length)return null;const s={};for(let e=0;e<t.length;++e){const i=t[e];s.hasOwnProperty(i.start)?null===s[i.start].open?s[i.start].open=[i]:s[i.start].open.push(i):s[i.start]={open:[i],close:null},s.hasOwnProperty(i.end)?null===s[i.end].close?s[i.end].close=[i]:s[i.end].close.push(i):s[i.end]={open:null,close:[i]}}let i=[];function n(t){i=i.filter((function(e){return void 0===t.find((function(t){return t===e}))}))}function a(t){for(let e=0;e<t.length;++e)i.push(t[e])}const r=Object.keys(s).sort((function(t,e){return t-e})),o=[];for(let t=0;t<r.length;++t){const e=s[r[t]];null!==e.close&&n(e.close),null!==e.open&&a(e.open),o.push({start:r[t],tags:_v(i)})}const h=[];let l=null;for(let t=0;t<o.length;++t){const e=o[t];for(;h.length<e.start;)h.push(l?l.tags:null);l=e}for(;h.length<e;)h.push(null);return h}(i,s.length);return{symbols:s,tags:a}}class yv{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null}}const vv=/^[\r\n]$/,xv=/^[ \t]$/,bv=/^[ \t\-]|[\u200b]$/,Sv=/^[a-z0-9]$/i,wv=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,Mv=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,Tv=["​","؜","‎","‏","‪","‫","‬","‭","‮","⁦","⁧","⁨","⁩"],Av={width:0,height:0,xadvance:0,xoffset:0,yoffset:0};class Cv{constructor(t){this._element=t,this._system=t.system,this._entity=t.entity,this._text="",this._symbols=[],this._colorPalette=[],this._symbolColors=null,this._i18nKey=null,this._fontAsset=new P_(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new J(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new st(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new jr,this._model=new vd,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new bt,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new J(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new J(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new st(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),t.on("resize",this._onParentResize,this),t.on("set:screen",this._onScreenChange,this),t.on("screen:set:screenspace",this._onScreenSpaceChange,this),t.on("set:draworder",this._onDrawOrderChange,this),t.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(t,e){this._noResize||this._font&&this._updateText()}_onScreenChange(t){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(t){this._updateMaterial(t)}_onDrawOrderChange(t){if(this._drawOrder=t,this._model)for(let e=0,s=this._model.meshInstances.length;e<s;e++)this._model.meshInstances[e].drawOrder=t}_onPivotChange(t){this._font&&this._updateText()}_onLocaleSet(t){if(this._i18nKey){if(this.fontAsset){const t=this._system.app.assets.get(this.fontAsset);t&&t.resource&&t.resource===this._font||(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(t,e){this._i18nKey&&e[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(t){if(this.unicodeConverter){const e=this._system.getUnicodeConverter();e?t=e(t):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==t&&(this._font&&this._updateText(t),this._text=t)}_updateText(t){let e;if(void 0===t&&(t=this._text),this._symbols=L.getSymbols(t.normalize?t.normalize("NFC"):t),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){const t=class{static evaluate(t){return gv(t)}}.evaluate(this._symbols);this._symbols=t.symbols,e=t.tags}if(this._rtlReorder){const t=this._system.app.systems.element.getRtlReorder();if(t){const s=t(this._symbols);this._rtl=s.rtl,this._symbols=s.mapping.map((function(t){return this._symbols[t]}),this),e&&(e=s.mapping.map((function(t){return e[t]})))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;if(e){const t={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._symbolColors=[],t[this._color.toString(!1).toLowerCase()]=0;for(let s=0,i=this._symbols.length;s<i;++s){const i=e[s];let n=0;if(i&&i.color&&i.color.value){const e=i.color.value;if(7===e.length&&"#"===e[0]){const s=e.substring(1).toLowerCase();t.hasOwnProperty(s)?n=t[s]:/^([0-9a-f]{2}){3}$/.test(s)&&(n=this._colorPalette.length/3,t[s]=n,this._colorPalette.push(parseInt(s.substring(0,2),16)),this._colorPalette.push(parseInt(s.substring(2,4),16)),this._colorPalette.push(parseInt(s.substring(4,6),16)))}}this._symbolColors.push(n)}}else this._colorPalette=[],this._symbolColors=null;const s=this._calculateCharsPerTexture();let i=!1;const n=this._element,a=n._isScreenSpace(),r=n._isScreenCulled(),o=function(t){return n.isVisibleForCamera(t)};for(let t=0,e=this._meshInfo.length;t<e;t++){const e=s[t]||0,h=this._meshInfo[t];if(h.count!==e){if(i||(n.removeModelFromLayers(this._model),i=!0),h.count=e,h.positions.length=h.normals.length=3*e*4,h.indices.length=3*e*2,h.uvs.length=2*e*4,h.colors.length=4*e*4,h.meshInstance&&this._removeMeshInstance(h.meshInstance),0===e){h.meshInstance=null;continue}for(let t=0;t<e;t++)h.indices[3*t*2+0]=4*t,h.indices[3*t*2+1]=4*t+1,h.indices[3*t*2+2]=4*t+3,h.indices[3*t*2+3]=4*t+2,h.indices[3*t*2+4]=4*t+3,h.indices[3*t*2+5]=4*t+1,h.normals[4*t*3+0]=0,h.normals[4*t*3+1]=0,h.normals[4*t*3+2]=-1,h.normals[4*t*3+3]=0,h.normals[4*t*3+4]=0,h.normals[4*t*3+5]=-1,h.normals[4*t*3+6]=0,h.normals[4*t*3+7]=0,h.normals[4*t*3+8]=-1,h.normals[4*t*3+9]=0,h.normals[4*t*3+10]=0,h.normals[4*t*3+11]=-1;const s=Gh(this._system.app.graphicsDevice,h.positions,{uvs:h.uvs,normals:h.normals,colors:h.colors,indices:h.indices}),l=new dl(s,this._material,this._node);l.name="Text Element: "+this._entity.name,l.castShadow=!1,l.receiveShadow=!1,l.cull=!a,l.screenSpace=a,l.drawOrder=this._drawOrder,r&&(l.cull=!0,l.isVisibleFunc=o),this._setTextureParams(l,this._font.textures[t]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),l.setParameter("material_emissive",this._colorUniform),l.setParameter("material_opacity",this._color.a),l.setParameter("font_sdfIntensity",this._font.intensity),l.setParameter("font_pxrange",this._getPxRange(this._font)),l.setParameter("font_textureWidth",this._font.data.info.maps[t].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,l.setParameter("outline_color",this._outlineColorUniform),l.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,l.setParameter("shadow_color",this._shadowColorUniform);const c=-this._font.data.info.maps[t].width/this._font.data.info.maps[t].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=c*this._shadowOffsetScale*this._shadowOffset.y,l.setParameter("shadow_offset",this._shadowOffsetUniform),h.meshInstance=l,this._model.meshInstances.push(l)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),i&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(t){t.destroy();const e=this._model.meshInstances.indexOf(t);-1!==e&&this._model.meshInstances.splice(e,1)}_setMaterial(t){if(this._material=t,this._model)for(let e=0,s=this._model.meshInstances.length;e<s;e++){this._model.meshInstances[e].material=t}}_updateMaterial(t){const e=this._element,s=e._isScreenCulled(),i=function(t){return e.isVisibleForCamera(t)},n=this._font&&this._font.type===Fp;if(this._material=this._system.getTextElementMaterial(t,n),this._model)for(let e=0,n=this._model.meshInstances.length;e<n;e++){const n=this._model.meshInstances[e];n.cull=!t,n.material=this._material,n.screenSpace=t,s?(n.cull=!0,n.isVisibleFunc=i):n.isVisibleFunc=null}}_isWordBoundary(t){return bv.test(t)}_isValidNextChar(t){return null!==t&&!Mv.test(t)}_isNextCJKBoundary(t,e){return wv.test(t)&&(bv.test(e)||Sv.test(e))}_isNextCJKWholeWord(t){return wv.test(t)}_updateMeshes(){const t=this._font.data,e=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);const a=this._symbols.length;let r=0,o=0,h=0,l=0,c=1,d=0,u=0,p=0,m=0,f=0,_=0;const g=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let y=this._element.calculatedWidth;(this.autoWidth&&!g||!this._wrapLines)&&(y=Number.POSITIVE_INFINITY);let v,x,b,S,w=0,M=0,T=1;function A(t,s,i){e._lineWidths.push(Math.abs(i));const n=p>s?s+1:p,a=p>s?p+1:s,h=t.slice(n,a);if(_){let t=h.length;for(;t--&&_>0;)vv.test(h[t])&&(h.splice(t,1),_--)}e._lineContents.push(h.join("")),r=0,o-=e._scaledLineHeight,c++,m=0,f=0,_=0,d=0,p=s}let C=!0;for(;C;){C=!1,this._scaledLineHeight=n?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],r=0,o=0,h=0,l=0,c=1,d=0,u=0,p=0,m=0,f=0,_=0,T=this._fontSize/32,w=this._fontMinY*T,M=this._fontMaxY*T;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].quad=0,this._meshInfo[t].lines={};let e=255,g=255,P=255;for(let n=0;n<a;n++){v=this._symbols[n],S=n+1>=a?null:this._symbols[n+1];if(vv.test(v)){_++,(!this._wrapLines||this._maxLines<0||c<this._maxLines)&&(A(this._symbols,n,l),u=n+1,p=n+1);continue}let R,E,I=0,D=0,F=0,O=1;if(x=t.chars[v],!x)if(-1!==Tv.indexOf(v))x=Av;else if(t.chars[" "])x=t.chars[" "];else for(const e in t.chars){x=t.chars[e];break}if(x){let t=0;if(f>0){const e=this._font.data.kerning;if(e){const s=e[L.getCodePoint(this._symbols[n-1])||0];s&&(t=s[L.getCodePoint(this._symbols[n])||0]||0)}}R=x.scale||1,E=(x.width+x.height)/2,O=T*E/R,F=(x.xadvance+t)*T,I=(x.xoffset-t)*T,D=x.yoffset*T}else console.error(`Couldn't substitute missing character: '${v}'`);const k=xv.test(v),B=this._meshInfo[x&&x.map||0],z=r+this._spacing*F;if(z>y&&f>0&&!k&&(this._maxLines<0||c<this._maxLines)){if(0!==m){const e=Math.max(n-u,0);if(this._meshInfo.length<=1)B.lines[c-1]-=e,B.quad-=e;else{const e=n;for(let s=u;s<e;s++){const e=this._symbols[s],i=t.chars[e],n=this._meshInfo[i&&i.map||0];n.lines[c-1]-=1,n.quad-=1}}n-=e+1,A(this._symbols,u,d);continue}u=n,A(this._symbols,n,l)}b=B.quad,B.lines[c-1]=b;let U=r-I,N=U+O;const W=o-D,G=W+O;if(this._rtl){const t=O-I-this._spacing*F-I;U-=t,N-=t}let H;if(B.positions[4*b*3+0]=U,B.positions[4*b*3+1]=W,B.positions[4*b*3+2]=h,B.positions[4*b*3+3]=N,B.positions[4*b*3+4]=W,B.positions[4*b*3+5]=h,B.positions[4*b*3+6]=N,B.positions[4*b*3+7]=G,B.positions[4*b*3+8]=h,B.positions[4*b*3+9]=U,B.positions[4*b*3+10]=G,B.positions[4*b*3+11]=h,this.width=Math.max(this.width,z),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(H=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),H=V.clamp(H,s,i),H!==this._element.fontSize)){this._fontSize=H,C=!0;break}if(this.height=Math.max(this.height,M-(o+w)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(H=V.clamp(this._fontSize-1,s,i),H!==this._element.fontSize)){this._fontSize=H,C=!0;break}r+=this._spacing*F,k||(l=r),(this._isWordBoundary(v)||this._isValidNextChar(S)&&(this._isNextCJKBoundary(v,S)||this._isNextCJKWholeWord(S)))&&(m++,d=l,u=n+1),f++;const j=this._getUv(v);if(B.uvs[4*b*2+0]=j[0],B.uvs[4*b*2+1]=1-j[1],B.uvs[4*b*2+2]=j[2],B.uvs[4*b*2+3]=1-j[1],B.uvs[4*b*2+4]=j[2],B.uvs[4*b*2+5]=1-j[3],B.uvs[4*b*2+6]=j[0],B.uvs[4*b*2+7]=1-j[3],this._symbolColors){const t=3*this._symbolColors[n];e=this._colorPalette[t],g=this._colorPalette[t+1],P=this._colorPalette[t+2]}B.colors[4*b*4+0]=e,B.colors[4*b*4+1]=g,B.colors[4*b*4+2]=P,B.colors[4*b*4+3]=255,B.colors[4*b*4+4]=e,B.colors[4*b*4+5]=g,B.colors[4*b*4+6]=P,B.colors[4*b*4+7]=255,B.colors[4*b*4+8]=e,B.colors[4*b*4+9]=g,B.colors[4*b*4+10]=P,B.colors[4*b*4+11]=255,B.colors[4*b*4+12]=e,B.colors[4*b*4+13]=g,B.colors[4*b*4+14]=P,B.colors[4*b*4+15]=255,B.quad++}C||p<a&&A(this._symbols,a,r)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const P=this._element.pivot.x,R=this._element.pivot.y,E=this._alignment.x,I=this._alignment.y;for(let t=0;t<this._meshInfo.length;t++){if(0===this._meshInfo[t].count)continue;let e=0;for(const s in this._meshInfo[t].lines){const i=this._meshInfo[t].lines[s],n=this._lineWidths[parseInt(s,10)],a=-P*this._element.calculatedWidth+E*(this._element.calculatedWidth-n)*(this._rtl?-1:1),r=(1-R)*this._element.calculatedHeight-M-(1-I)*(this._element.calculatedHeight-this.height);for(let s=e;s<=i;s++)this._meshInfo[t].positions[4*s*3]+=a,this._meshInfo[t].positions[4*s*3+3]+=a,this._meshInfo[t].positions[4*s*3+6]+=a,this._meshInfo[t].positions[4*s*3+9]+=a,this._meshInfo[t].positions[4*s*3+1]+=r,this._meshInfo[t].positions[4*s*3+4]+=r,this._meshInfo[t].positions[4*s*3+7]+=r,this._meshInfo[t].positions[4*s*3+10]+=r;if(this._rtl)for(let s=e;s<=i;s++){const e=4*s*3;for(let s=0;s<4;++s)this._meshInfo[t].positions[e+3*s]=this._element.calculatedWidth-this._meshInfo[t].positions[e+3*s]+2*a;const i=this._meshInfo[t].positions[e+3],n=this._meshInfo[t].positions[e+6];this._meshInfo[t].positions[e+3]=this._meshInfo[t].positions[e+0],this._meshInfo[t].positions[e+6]=this._meshInfo[t].positions[e+9],this._meshInfo[t].positions[e+0]=i,this._meshInfo[t].positions[e+9]=n}e=i+1}const s=4*this._meshInfo[t].count,i=4*this._meshInfo[t].quad,n=new Ch(this._meshInfo[t].meshInstance.mesh.vertexBuffer);for(let e=0;e<s;e++)e>=i?(n.element[ln].set(0,0,0),n.element[_n].set(0,0),n.element[mn].set(0,0,0,0)):(n.element[ln].set(this._meshInfo[t].positions[3*e+0],this._meshInfo[t].positions[3*e+1],this._meshInfo[t].positions[3*e+2]),n.element[_n].set(this._meshInfo[t].uvs[2*e+0],this._meshInfo[t].uvs[2*e+1]),n.element[mn].set(this._meshInfo[t].colors[4*e+0],this._meshInfo[t].colors[4*e+1],this._meshInfo[t].colors[4*e+2],this._meshInfo[t].colors[4*e+3])),n.next();n.end(),this._meshInfo[t].meshInstance.mesh.aabb.compute(this._meshInfo[t].positions),this._meshInfo[t].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(t){this.font!==t.resource&&(this.font=t.resource)}_onFontChange(t,e,s,i){if("data"===e){this._font.data=s;const t=this._font.data.info.maps.length;for(let e=0;e<t;e++){if(!this._meshInfo[e])continue;const t=this._meshInfo[e].meshInstance;t&&(t.setParameter("font_sdfIntensity",this._font.intensity),t.setParameter("font_pxrange",this._getPxRange(this._font)),t.setParameter("font_textureWidth",this._font.data.info.maps[e].width))}}}_onFontRemove(t){}_setTextureParams(t,e){this._font&&(this._font.type===Fp?(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap"),t.setParameter("texture_msdfMap",e)):this._font.type===Op&&(t.deleteParameter("texture_msdfMap"),t.setParameter("texture_emissiveMap",e),t.setParameter("texture_opacityMap",e)))}_getPxRange(t){const e=Object.keys(this._font.data.chars);for(let t=0;t<e.length;t++){const s=this._font.data.chars[e[t]];if(s.range)return(s.scale||1)*s.range}return 2}_getUv(t){const e=this._font.data;if(!e.chars[t]){const t=" ";return e.chars[t]?this._getUv(t):[0,0,0,0]}const s=e.chars[t].map,i=e.info.maps[s].width,n=e.info.maps[s].height,a=e.chars[t].x,r=e.chars[t].y,o=a,h=r,l=a+e.chars[t].width,c=r-e.chars[t].height,d=1-e.chars[t].height/n;return[o/i,d-h/n,l/i,d-c/n]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(t){if(this._model){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].stencilFront=t,e[s].stencilBack=t}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(t){const e={};void 0===t&&(t=this._symbols.length);for(let s=0,i=t;s<i;s++){const t=this._symbols[s];let i=this._font.data.chars[t];i||(i=this._font.data.chars[" "],i||(i=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const n=i.map;e[n]?e[n]++:e[n]=1}return e}_updateRenderRange(){const t=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),e=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const i=t[s]||0,n=e[s]||0,a=this._meshInfo[s].meshInstance;if(a){const t=a.mesh;t&&(t.primitive[0].base=3*i*2,t.primitive[0].count=3*(n-i)*2)}}}get text(){return this._text}set text(t){this._i18nKey=null;const e=null!=t&&t.toString()||"";this._setText(e)}get key(){return this._i18nKey}set key(t){const e=null!==t?t.toString():null;this._i18nKey!==e&&(this._i18nKey=e,e?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get color(){return this._color}set color(t){const e=t.r,s=t.g,i=t.b;if(this._color.r!==e||this._color.g!==s||this._color.b!==i)if(this._color.r=e,this._color.g=s,this._color.b=i,this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("material_emissive",this._colorUniform)}}this._element&&this._element.fire("set:color",this._color)}get opacity(){return this._color.a}set opacity(t){if(this._color.a!==t&&(this._color.a=t,this._model))for(let e=0,s=this._model.meshInstances.length;e<s;e++){this._model.meshInstances[e].setParameter("material_opacity",t)}this._element&&this._element.fire("set:opacity",t)}get lineHeight(){return this._lineHeight}set lineHeight(t){const e=this._lineHeight;this._lineHeight=t,this._scaledLineHeight=t,e!==t&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}set wrapLines(t){const e=this._wrapLines;this._wrapLines=t,e!==t&&this._font&&this._updateText()}get lines(){return this._lineContents}get spacing(){return this._spacing}set spacing(t){const e=this._spacing;this._spacing=t,e!==t&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontSize(t){const e=this._fontSize;this._fontSize=t,this._originalFontSize=t,e!==t&&this._font&&this._updateText()}get fontAsset(){return this._fontAsset.localizedAsset}set fontAsset(t){this._fontAsset.defaultAsset=t}get font(){return this._font}set font(t){let e;if(this._font&&(e=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=t,this._fontMinY=0,this._fontMaxY=0,!t)return;const s=this._font.data;for(const t in s.chars){const e=s.chars[t];e.bounds&&(this._fontMinY=Math.min(this._fontMinY,e.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,e.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset){this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null)}if(t.type!==e){const t=this._element._isScreenSpace();this._updateMaterial(t)}for(let t=0,e=this._font.textures.length;t<e;t++)if(this._meshInfo[t]){const e=this._meshInfo[t].meshInstance;e&&(e.setParameter("font_sdfIntensity",this._font.intensity),e.setParameter("font_pxrange",this._getPxRange(this._font)),e.setParameter("font_textureWidth",this._font.data.info.maps[t].width),this._setTextureParams(e,this._font.textures[t]))}else this._meshInfo[t]=new yv;let i=!1;for(let t=this._font.textures.length;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[t].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get alignment(){return this._alignment}set alignment(t){t instanceof st?this._alignment.set(t.x,t.y):this._alignment.set(t[0],t[1]),this._font&&this._updateText()}get autoWidth(){return this._autoWidth}set autoWidth(t){const e=this._autoWidth;if(this._autoWidth=t,t&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),e!==t){const t=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;t!==this._fontSize&&(this._fontSize=t,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set autoHeight(t){const e=this._autoHeight;if(this._autoHeight=t,t&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),e!==t){const t=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;t!==this._fontSize&&(this._fontSize=t,this._font&&this._updateText())}}get rtlReorder(){return this._rtlReorder}set rtlReorder(t){this._rtlReorder!==t&&(this._rtlReorder=t,this._font&&this._updateText())}get unicodeConverter(){return this._unicodeConverter}set unicodeConverter(t){this._unicodeConverter!==t&&(this._unicodeConverter=t,this._setText(this._text))}get aabb(){if(this._aabbDirty){let t=!1;for(let e=0;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(t?this._aabb.add(this._meshInfo[e].meshInstance.aabb):(this._aabb.copy(this._meshInfo[e].meshInstance.aabb),t=!0));this._aabbDirty=!1}return this._aabb}get outlineColor(){return this._outlineColor}set outlineColor(t){const e=t instanceof J?t.r:t[0],s=t instanceof J?t.g:t[1],i=t instanceof J?t.b:t[2],n=t instanceof J?t.a:t[3];if((this._outlineColor.r!==e||this._outlineColor.g!==s||this._outlineColor.b!==i||this._outlineColor.a!==n)&&(this._outlineColor.r=e,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,this._model)){this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("outline_color",this._outlineColorUniform)}}}get outlineThickness(){return this._outlineThickness}set outlineThickness(t){const e=this._outlineThickness;if(this._outlineThickness=t,e!==t&&this._font&&this._model)for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}get shadowColor(){return this._shadowColor}set shadowColor(t){const e=t instanceof J?t.r:t[0],s=t instanceof J?t.g:t[1],i=t instanceof J?t.b:t[2],n=t instanceof J?t.a:t[3];if((this._shadowColor.r!==e||this._shadowColor.g!==s||this._shadowColor.b!==i||this._shadowColor.a!==n)&&(this._shadowColor.r=e,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,this._model)){this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(let t=0,e=this._model.meshInstances.length;t<e;t++){this._model.meshInstances[t].setParameter("shadow_color",this._shadowColorUniform)}}}get shadowOffset(){return this._shadowOffset}set shadowOffset(t){const e=t instanceof st?t.x:t[0],s=t instanceof st?t.y:t[1];if((this._shadowOffset.x!==e||this._shadowOffset.y!==s)&&(this._shadowOffset.set(e,s),this._font&&this._model))for(let t=0,e=this._model.meshInstances.length;t<e;t++){const e=-this._font.data.info.maps[t].width/this._font.data.info.maps[t].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=e*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[t].setParameter("shadow_offset",this._shadowOffsetUniform)}}get minFontSize(){return this._minFontSize}set minFontSize(t){this._minFontSize!==t&&(this._minFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set maxFontSize(t){this._maxFontSize!==t&&(this._maxFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitWidth(t){this._autoFitWidth!==t&&(this._autoFitWidth=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set autoFitHeight(t){this._autoFitHeight!==t&&(this._autoFitHeight=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get maxLines(){return this._maxLines}set maxLines(t){this._maxLines!==t&&(null===t&&-1===this._maxLines||(this._maxLines=null===t?-1:t,this.font&&this._wrapLines&&this._updateText()))}get enableMarkup(){return this._enableMarkup}set enableMarkup(t){t=!!t,this._enableMarkup!==t&&(this._enableMarkup=t,this.font&&this._updateText())}get symbols(){return this._symbols}get symbolColors(){return null===this._symbolColors?null:this._symbolColors.map((function(t){return this._colorPalette.slice(3*t,3*t+3)}),this)}get rtl(){return this._rtl}get rangeStart(){return this._rangeStart}set rangeStart(t){(t=Math.max(0,Math.min(t,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=t,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}set rangeEnd(t){(t=Math.max(this._rangeStart,Math.min(t,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=t,this._updateRenderRange())}}const Pv=new it,Rv=new dt,Ev=new it,Lv=new it,Iv=new dt,Dv=new dt,Fv=new dt,Ov=new dt;class kv extends Lg{constructor(t,e){super(t,e),this._beingInitialized=!1,this._anchor=new nt,this._localAnchor=new nt,this._pivot=new st,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new nt(0,0,-32,-32),this._modelTransform=new dt,this._screenToWorld=new dt,this._anchorTransform=new dt,this._anchorDirty=!0,this._parentWorldTransform=new dt,this._screenTransform=new dt,this._screenCorners=[new it,new it,new it,new it],this._canvasCorners=[new st,new st,new st,new st],this._worldCorners=[new it,new it,new it,new it],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=ry,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._useInput=!1,this._layers=[qt],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=ld.prototype._sync,this.entity.setPosition=ld.prototype.setPosition,this.entity.setLocalPosition=ld.prototype.setLocalPosition}_setPosition(t,e,s){if(!this.element.screen)return ld.prototype.setPosition.call(this,t,e,s);t instanceof it?Pv.copy(t):Pv.set(t,e,s),this.getWorldTransform(),Rv.copy(this.element._screenToWorld).invert(),Rv.transformPoint(Pv,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(t,e,s){t instanceof it?this.localPosition.copy(t):this.localPosition.set(t,e,s);const i=this.element,n=this.localPosition,a=i._pivot;i._margin.x=n.x-i._calculatedWidth*a.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*a.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const t=this.element,e=t.screen;if(e){if(t._anchorDirty){let s=0,i=0,n=0,a=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,a=this._parent.element.pivot.y;else{const t=e.screen.resolution;s=t.x/e.screen.scale,i=t.y/e.screen.scale}t._anchorTransform.setTranslate(s*(t.anchor.x-n),-i*(a-t.anchor.y),0),t._anchorDirty=!1,t._calculateLocalAnchors()}t._sizeDirty&&t._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const e=this.localPosition,s=t._pivot;t._margin.x=e.x-t._calculatedWidth*s.x,t._margin.z=t._localAnchor.z-t._localAnchor.x-t._calculatedWidth-t._margin.x,t._margin.y=e.y-t._calculatedHeight*s.y,t._margin.w=t._localAnchor.w-t._localAnchor.y-t._calculatedHeight-t._margin.y,this._dirtyLocal=!1}if(!e)return this._dirtyWorld&&(t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0),ld.prototype._sync.call(this);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?t._screenToWorld.mul2(this._parent.element._modelTransform,t._anchorTransform):t._screenToWorld.copy(t._anchorTransform),t._modelTransform.mul2(t._screenToWorld,this.localTransform),e){t._screenToWorld.mul2(e.screen._screenMatrix,t._screenToWorld),e.screen.screenSpace||t._screenToWorld.mul2(e.worldTransform,t._screenToWorld),this.worldTransform.mul2(t._screenToWorld,this.localTransform);const s=t._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==e&&(Iv.setTRS(it.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,Iv));const n=Ev;n.set(0,0,this.localPosition.z);const a=Lv;a.set(t._absLeft+t._pivot.x*t.calculatedWidth,t._absBottom+t._pivot.y*t.calculatedHeight,0),Iv.setTranslate(-a.x,-a.y,-a.z),Dv.setTRS(n,this.getLocalRotation(),this.getLocalScale()),Fv.setTranslate(a.x,a.y,a.z),t._screenTransform.mul2(t._parentWorldTransform,Fv).mul(Dv).mul(Iv),t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0}else this.worldTransform.copy(t._modelTransform);this._dirtyWorld=!1}}_onInsert(t){const e=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(e.screen),this._dirtifyMask()}_dirtifyMask(){let t=this.entity;for(;t;){const e=t.parent;if((null===e||e.screen)&&t.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const e=this.system._prerender.indexOf(this.entity);e>=0&&this.system._prerender.splice(e,1);this.system._prerender.indexOf(t)<0&&this.system._prerender.push(t)}t=e}}_onPrerender(){for(let t=0;t<this.system._prerender.length;t++){const e=this.system._prerender[t];if(e.element){const t=1;e.element.syncMask(t)}}this.system._prerender.length=0}_bindScreen(t){t._bindElement(this)}_unbindScreen(t){t._unbindElement(this)}_updateScreen(t){this.screen&&this.screen!==t&&this._unbindScreen(this.screen.screen);const e=this.screen;this.screen=t,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,e),this._anchorDirty=!0;const s=this.entity.children;for(let e=0,i=s.length;e<i;e++)s[e].element&&s[e].element._updateScreen(t);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(t){const e=this._parseUpToScreen();this._updateMask(e.mask,t)}_setMaskedBy(t){const e=this._image||this._text;if(t){const s=t.element._image._maskRef,i=new Iu({ref:s,func:yi});e&&e._setStencil&&e._setStencil(i),this._maskedBy=t}else e&&e._setStencil&&e._setStencil(null),this._maskedBy=null}_updateMask(t,e){if(t){if(this._setMaskedBy(t),this.mask){const s=t.element._image._maskRef,i=new Iu({ref:s,func:yi,zpass:Hn});this._image._setStencil(i),this._image._maskRef=e,e++,t=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(t,e);this.mask&&e--}else{if(this._setMaskedBy(null),this.mask){const s=new Iu({ref:e,func:xi,zpass:Gn});this._image._setStencil(s),this._image._maskRef=e,e++,t=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(t,e);this.mask&&e--}}_parseUpToScreen(){const t={screen:null,mask:null};let e=this.entity._parent;for(;e&&!e.screen;)e.element&&e.element.mask&&(t.mask||(t.mask=e)),e=e.parent;return e&&e.screen&&(t.screen=e),t}_onScreenResize(t){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",t)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let t=1e3,e=1e3;const s=this.entity._parent;if(s&&s.element)t=s.element.calculatedWidth,e=s.element.calculatedHeight;else if(this.screen){const s=this.screen.screen.resolution,i=this.screen.screen.scale;t=s.x/i,e=s.y/i}this._localAnchor.set(this._anchor.x*t,this._anchor.y*e,this._anchor.z*t,this._anchor.w*e)}getOffsetPosition(t,e){const s=this.entity.getLocalPosition().clone();return s.x+=t,s.y+=e,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(t,e){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||(this._image?t.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&t.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(t){this.layers.indexOf(t.id)<0||(this._image?t.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&t.removeMeshInstances(this._text._model.meshInstances))}onEnable(){this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&this.system.app.batcher.insert(tl.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&this.system.app.batcher.remove(tl.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(t,e){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;t?this._setWidth(s):this._setCalculatedWidth(s,!1),e?this._setHeight(i):this._setCalculatedHeight(i,!1);const n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=!1}_setWidth(t){this._width=t,this._setCalculatedWidth(t,!1),this.fire("set:width",this._width)}_setHeight(t){this._height=t,this._setCalculatedHeight(t,!1),this.fire("set:height",this._height)}_setCalculatedWidth(t,e){if(!(Math.abs(t-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=t,this.entity._dirtifyLocal(),e){const t=this.entity.getLocalPosition(),e=this._pivot;this._margin.x=t.x-this._calculatedWidth*e.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(t,e){if(!(Math.abs(t-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=t,this.entity._dirtifyLocal(),e){const t=this.entity.getLocalPosition(),e=this._pivot;this._margin.y=t.y-this._calculatedHeight*e.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const t=this.entity._children;for(let e=0,s=t.length;e<s;e++)t[e].element&&(t[e].element._anchorDirty=!0,t[e].element._sizeDirty=!0)}addModelToLayers(t){this._addedModels.push(t);for(let e=0;e<this.layers.length;e++){const s=this.system.app.scene.layers.getLayerById(this.layers[e]);s&&s.addMeshInstances(t.meshInstances)}}removeModelFromLayers(t){const e=this._addedModels.indexOf(t);e>=0&&this._addedModels.splice(e,1);for(let e=0;e<this.layers.length;e++){const s=this.system.app.scene.layers.getLayerById(this.layers[e]);s&&s.removeMeshInstances(t.meshInstances)}}getMaskOffset(){const t=this.system.app.frame;this._offsetReadAt!==t&&(this._maskOffset=.5,this._offsetReadAt=t);const e=this._maskOffset;return this._maskOffset-=.001,e}isVisibleForCamera(t){let e,s,i,n;if(this.maskedBy){const t=this.maskedBy.element.screenCorners;e=Math.min(Math.min(t[0].x,t[1].x),Math.min(t[2].x,t[3].x)),s=Math.max(Math.max(t[0].x,t[1].x),Math.max(t[2].x,t[3].x)),n=Math.min(Math.min(t[0].y,t[1].y),Math.min(t[2].y,t[3].y)),i=Math.max(Math.max(t[0].y,t[1].y),Math.max(t[2].y,t[3].y))}else{const a=this.system.app.graphicsDevice.width,r=this.system.app.graphicsDevice.height,o=t._rect.z*a,h=t._rect.w*r;e=t._rect.x*a,s=e+o,i=(1-t._rect.y)*r,n=i-h}const a=this.screenCorners,r=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x)),o=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x)),h=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y)),l=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y));return!(o<e||r>s||h>i||l<n)}_isScreenSpace(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace}_isScreenCulled(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull}}function Bv(t){Object.defineProperty(kv.prototype,t,{get:function(){return this._text?this._text[t]:this._image?this._image[t]:null},set:function(e){this._text?this._text[t]=e:this._image&&(this._image[t]=e)}})}Object.defineProperty(kv.prototype,"type",{get:function(){return this._type},set:function(t){t!==this._type&&(this._type=t,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),t===oy?this._image=new dv(this):t===hy&&(this._text=new Cv(this)))}}),Object.defineProperty(kv.prototype,"layers",{get:function(){return this._layers},set:function(t){if(this._addedModels.length)for(let t=0;t<this._layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this._layers[t]);if(e)for(let t=0;t<this._addedModels.length;t++)e.removeMeshInstances(this._addedModels[t].meshInstances)}if(this._layers=t,this.enabled&&this.entity.enabled&&this._addedModels.length)for(let t=0;t<this._layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this._layers[t]);if(e)for(let t=0;t<this._addedModels.length;t++)e.addMeshInstances(this._addedModels[t].meshInstances)}}}),Object.defineProperty(kv.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(t){let e=0;this.screen&&(e=this.screen.screen.priority),t>16777215&&(t=16777215),this._drawOrder=(e<<24)+t,this.fire("set:draworder",this._drawOrder)}}),Object.defineProperty(kv.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}}),Object.defineProperty(kv.prototype,"_absRight",{get:function(){return this._localAnchor.z-this._margin.z}}),Object.defineProperty(kv.prototype,"_absTop",{get:function(){return this._localAnchor.w-this._margin.w}}),Object.defineProperty(kv.prototype,"_absBottom",{get:function(){return this._localAnchor.y+this._margin.y}}),Object.defineProperty(kv.prototype,"margin",{get:function(){return this._margin},set:function(t){this._margin.copy(t),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}}),Object.defineProperty(kv.prototype,"left",{get:function(){return this._margin.x},set:function(t){this._margin.x=t;const e=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+t;this._setWidth(s-i),e.x=t+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(e)}}),Object.defineProperty(kv.prototype,"right",{get:function(){return this._margin.z},set:function(t){this._margin.z=t;const e=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-t;this._setWidth(i-s),e.x=this._localAnchor.z-this._localAnchor.x-t-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(e)}}),Object.defineProperty(kv.prototype,"top",{get:function(){return this._margin.w},set:function(t){this._margin.w=t;const e=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-t;this._setHeight(i-s),e.y=this._localAnchor.w-this._localAnchor.y-t-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(e)}}),Object.defineProperty(kv.prototype,"bottom",{get:function(){return this._margin.y},set:function(t){this._margin.y=t;const e=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+t;this._setHeight(s-i),e.y=t+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(e)}}),Object.defineProperty(kv.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t,this._hasSplitAnchorsX||this._setCalculatedWidth(t,!0),this.fire("set:width",this._width)}}),Object.defineProperty(kv.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t,this._hasSplitAnchorsY||this._setCalculatedHeight(t,!0),this.fire("set:height",this._height)}}),Object.defineProperty(kv.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},set:function(t){this._setCalculatedWidth(t,!0)}}),Object.defineProperty(kv.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},set:function(t){this._setCalculatedHeight(t,!0)}}),Object.defineProperty(kv.prototype,"pivot",{get:function(){return this._pivot},set:function(t){const e=this._pivot.x,s=this._pivot.y;t instanceof st?this._pivot.set(t.x,t.y):this._pivot.set(t[0],t[1]);const i=this._margin.x+this._margin.z,n=this._pivot.x-e;this._margin.x+=i*n,this._margin.z-=i*n;const a=this._margin.y+this._margin.w,r=this._pivot.y-s;this._margin.y+=a*r,this._margin.w-=a*r,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}}),Object.defineProperty(kv.prototype,"anchor",{get:function(){return this._anchor},set:function(t){t instanceof nt?this._anchor.set(t.x,t.y,t.z,t.w):this._anchor.set(t[0],t[1],t[2],t[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}}),Object.defineProperty(kv.prototype,"_hasSplitAnchorsX",{get:function(){return Math.abs(this._anchor.x-this._anchor.z)>.001}}),Object.defineProperty(kv.prototype,"_hasSplitAnchorsY",{get:function(){return Math.abs(this._anchor.y-this._anchor.w)>.001}}),Object.defineProperty(kv.prototype,"aabb",{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}}),Object.defineProperty(kv.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const t=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const e=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),e&&this._screenCorners[s].mulScalar(this.screen.screen.scale),t&&this._screenCorners[s].add(t);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}}),Object.defineProperty(kv.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const t=this.system.app.graphicsDevice,e=this.screenCorners,s=t.canvas.clientWidth/t.width,i=t.canvas.clientHeight/t.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(e[n].x*s,(t.height-e[n].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}}),Object.defineProperty(kv.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const t=this.screenCorners;if(!this.screen.screen.screenSpace){Iv.copy(this.screen.screen._screenMatrix),Iv.data[13]=-Iv.data[13],Iv.mul2(this.screen.getWorldTransform(),Iv);for(let e=0;e<4;e++)Iv.transformPoint(t[e],this._worldCorners[e])}}else{const t=this.entity.getLocalPosition();Iv.setTranslate(-t.x,-t.y,-t.z),Dv.setTRS(it.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),Fv.setTranslate(t.x,t.y,t.z);const e=this.entity.parent?this.entity.parent:this.entity;Ov.copy(e.getWorldTransform()),Ov.mul(Fv).mul(Dv).mul(Iv),Ev.set(t.x-this.pivot.x*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),Ov.transformPoint(Ev,this._worldCorners[0]),Ev.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),Ov.transformPoint(Ev,this._worldCorners[1]),Ev.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),Ov.transformPoint(Ev,this._worldCorners[2]),Ev.set(t.x-this.pivot.x*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),Ov.transformPoint(Ev,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}}),Object.defineProperty(kv.prototype,"textWidth",{get:function(){return this._text?this._text.width:0}}),Object.defineProperty(kv.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}}),Object.defineProperty(kv.prototype,"useInput",{get:function(){return this._useInput},set:function(t){this._useInput!==t&&(this._useInput=t,this.system.app.elementInput?t?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):!0===this._useInput&&console.warn("Elements will not get any input events because this.system.app.elementInput is not created"),this.fire("set:useInput",t))}}),Object.defineProperty(kv.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(t){this._batchGroupId!==t&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher.remove(tl.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&this.system.app.batcher.insert(tl.ELEMENT,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=t)}}),Object.defineProperty(kv.prototype,"maskedBy",{get:function(){return this._maskedBy}}),Bv("fontSize"),Bv("minFontSize"),Bv("maxFontSize"),Bv("maxLines"),Bv("autoFitWidth"),Bv("autoFitHeight"),Bv("color"),Bv("font"),Bv("fontAsset"),Bv("spacing"),Bv("lineHeight"),Bv("wrapLines"),Bv("lines"),Bv("alignment"),Bv("autoWidth"),Bv("autoHeight"),Bv("rtlReorder"),Bv("unicodeConverter"),Bv("text"),Bv("key"),Bv("texture"),Bv("textureAsset"),Bv("material"),Bv("materialAsset"),Bv("sprite"),Bv("spriteAsset"),Bv("spriteFrame"),Bv("pixelsPerUnit"),Bv("opacity"),Bv("rect"),Bv("mask"),Bv("outlineColor"),Bv("outlineThickness"),Bv("shadowColor"),Bv("shadowOffset"),Bv("enableMarkup"),Bv("rangeStart"),Bv("rangeEnd");class zv{constructor(){this.enabled=!0}}const Uv=["enabled"];class Vv extends Ig{constructor(t){super(t),this.id="element",this.ComponentType=kv,this.DataType=zv,this.schema=Uv,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new Mr(t.graphicsDevice,{width:1,height:1,format:Li}),this._defaultTexture.name="element-system";const e=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,e.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this.defaultTextMaterial=null,this.defaultBitmapTextMaterial=null,this.defaultScreenSpaceTextMaterial=null,this.defaultScreenSpaceBitmapTextMaterial=null,this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(t,e,s){t._beingInitialized=!0,void 0!==e.anchor&&(e.anchor instanceof nt?t.anchor.copy(e.anchor):t.anchor.set(e.anchor[0],e.anchor[1],e.anchor[2],e.anchor[3])),void 0!==e.pivot&&(e.pivot instanceof st?t.pivot.copy(e.pivot):t.pivot.set(e.pivot[0],e.pivot[1]));const i=Math.abs(t.anchor.x-t.anchor.z)>.001,n=Math.abs(t.anchor.y-t.anchor.w)>.001;let a,r=!1;void 0!==e.margin&&(e.margin instanceof nt?t.margin.copy(e.margin):t._margin.set(e.margin[0],e.margin[1],e.margin[2],e.margin[3]),r=!0),void 0!==e.left&&(t._margin.x=e.left,r=!0),void 0!==e.bottom&&(t._margin.y=e.bottom,r=!0),void 0!==e.right&&(t._margin.z=e.right,r=!0),void 0!==e.top&&(t._margin.w=e.top,r=!0),r&&(t.margin=t._margin);let o=!1;void 0===e.width||i?i&&(o=!0):t.width=e.width,void 0===e.height||n?n&&(o=!0):t.height=e.height,o&&(t.anchor=t.anchor),void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.useInput&&(t.useInput=e.useInput),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),void 0!==e.type&&(t.type=e.type),t.type===oy?(void 0!==e.rect&&(t.rect=e.rect),void 0!==e.color&&(a=e.color,a instanceof J||(a=new J(e.color[0],e.color[1],e.color[2])),t.color=a),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.textureAsset&&(t.textureAsset=e.textureAsset),e.texture&&(t.texture=e.texture),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.spriteFrame&&(t.spriteFrame=e.spriteFrame),void 0!==e.pixelsPerUnit&&null!==e.pixelsPerUnit&&(t.pixelsPerUnit=e.pixelsPerUnit),void 0!==e.materialAsset&&(t.materialAsset=e.materialAsset),e.material&&(t.material=e.material),void 0!==e.mask&&(t.mask=e.mask)):t.type===hy&&(void 0!==e.autoWidth&&(t.autoWidth=e.autoWidth),void 0!==e.autoHeight&&(t.autoHeight=e.autoHeight),void 0!==e.rtlReorder&&(t.rtlReorder=e.rtlReorder),void 0!==e.unicodeConverter&&(t.unicodeConverter=e.unicodeConverter),null!==e.text&&void 0!==e.text?t.text=e.text:null!==e.key&&void 0!==e.key&&(t.key=e.key),void 0!==e.color&&(a=e.color,a instanceof J||(a=new J(a[0],a[1],a[2])),t.color=a),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.spacing&&(t.spacing=e.spacing),void 0!==e.fontSize&&(t.fontSize=e.fontSize,e.lineHeight||(t.lineHeight=e.fontSize)),void 0!==e.lineHeight&&(t.lineHeight=e.lineHeight),void 0!==e.maxLines&&(t.maxLines=e.maxLines),void 0!==e.wrapLines&&(t.wrapLines=e.wrapLines),void 0!==e.minFontSize&&(t.minFontSize=e.minFontSize),void 0!==e.maxFontSize&&(t.maxFontSize=e.maxFontSize),e.autoFitWidth&&(t.autoFitWidth=e.autoFitWidth),e.autoFitHeight&&(t.autoFitHeight=e.autoFitHeight),void 0!==e.fontAsset&&(t.fontAsset=e.fontAsset),void 0!==e.font&&(t.font=e.font),void 0!==e.alignment&&(t.alignment=e.alignment),void 0!==e.outlineColor&&(t.outlineColor=e.outlineColor),void 0!==e.outlineThickness&&(t.outlineThickness=e.outlineThickness),void 0!==e.shadowColor&&(t.shadowColor=e.shadowColor),void 0!==e.shadowOffset&&(t.shadowOffset=e.shadowOffset),void 0!==e.enableMarkup&&(t.enableMarkup=e.enableMarkup));const h=t._parseUpToScreen();h.screen&&t._updateScreen(h.screen),super.initializeComponentData(t,e,s),t._beingInitialized=!1,t.type===oy&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh)}onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return void 0!==s.key&&null!==s.key?i.key=s.key:i.text=s.text,this.addComponent(e,i)}getTextElementMaterial(t,e){return t?e?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new Wo,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=Rt,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new Wo,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=Rt,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):e?(this.defaultTextMaterial||(this.defaultTextMaterial=new Wo,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=Rt,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new Wo,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=Rt,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)}_createBaseImageMaterial(){const t=new Wo;return t.diffuse.set(0,0,0),t.emissive.set(.5,.5,.5),t.emissiveMap=this._defaultTexture,t.emissiveTint=!0,t.opacityMap=this._defaultTexture,t.opacityMapChannel="a",t.opacityTint=!0,t.opacity=0,t.useLighting=!1,t.useGammaTonemap=!1,t.useFog=!1,t.useSkybox=!1,t.blendType=Rt,t.depthWrite=!1,t}getImageElementMaterial(t,e,s,i){return t?e?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=ms,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=fs,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=ms,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=fs,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):e?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=ms,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=fs,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=ms,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=fs,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(t){this._unicodeConverter=t}registerRtlReorder(t){this._rtlReorder=t}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}Lg._buildAccessors(kv.prototype,Uv);const Nv="free",Wv="limited",Gv="locked",Hv=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class jv extends Lg{constructor(t,e){super(t,e),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX=Gv,this._linearLimitsX=new st(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=Gv,this._linearLimitsY=new st(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=Gv,this._linearLimitsZ=new st(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=Gv,this._angularLimitsX=new st(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=Gv,this._angularLimitsY=new st(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=Gv,this._angularLimitsZ=new st(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(t){this._destroyConstraint(),this._entityA=t,this._createConstraint()}get entityA(){return this._entityA}set entityB(t){this._destroyConstraint(),this._entityB=t,this._createConstraint()}get entityB(){return this._entityB}set breakForce(t){this._constraint&&this._breakForce!==t&&(this._constraint.setBreakingImpulseThreshold(t),this._breakForce=t)}get breakForce(){return this._breakForce}set enableCollision(t){this._destroyConstraint(),this._enableCollision=t,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(t){this._angularLimitsX.equals(t)||(this._angularLimitsX.copy(t),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(t){this._angularMotionX!==t&&(this._angularMotionX=t,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(t){this._angularLimitsY.equals(t)||(this._angularLimitsY.copy(t),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(t){this._angularMotionY!==t&&(this._angularMotionY=t,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(t){this._angularLimitsZ.equals(t)||(this._angularLimitsZ.copy(t),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(t){this._angularMotionZ!==t&&(this._angularMotionZ=t,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(t){this._linearLimitsX.equals(t)||(this._linearLimitsX.copy(t),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(t){this._linearMotionX!==t&&(this._linearMotionX=t,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(t){this._linearLimitsY.equals(t)||(this._linearLimitsY.copy(t),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(t){this._linearMotionY!==t&&(this._linearMotionY=t,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(t){this._linearLimitsZ.equals(t)||(this._linearLimitsZ.copy(t),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(t){this._linearMotionZ!==t&&(this._linearMotionZ=t,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(t,e){const s=t.getTranslation(),i=new ft;i.setFromMat4(t);const n=new Ammo.btVector3(s.x,s.y,s.z),a=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);e.setOrigin(n),e.setRotation(a),Ammo.destroy(n),Ammo.destroy(a)}_updateAngularLimits(){const t=this._constraint;if(t){let e,s,i,n,a,r;this._angularMotionX===Wv?(e=this._angularLimitsX.x*V.DEG_TO_RAD,n=this._angularLimitsX.y*V.DEG_TO_RAD):this._angularMotionX===Nv?(e=1,n=0):e=n=0,this._angularMotionY===Wv?(s=this._angularLimitsY.x*V.DEG_TO_RAD,a=this._angularLimitsY.y*V.DEG_TO_RAD):this._angularMotionY===Nv?(s=1,a=0):s=a=0,this._angularMotionZ===Wv?(i=this._angularLimitsZ.x*V.DEG_TO_RAD,r=this._angularLimitsZ.y*V.DEG_TO_RAD):this._angularMotionZ===Nv?(i=1,r=0):i=r=0;const o=new Ammo.btVector3(e,s,i);t.setAngularLowerLimit(o),o.setValue(n,a,r),t.setAngularUpperLimit(o),Ammo.destroy(o)}}_updateLinearLimits(){const t=this._constraint;if(t){let e,s,i,n,a,r;this._linearMotionX===Wv?(e=this._linearLimitsX.x,n=this._linearLimitsX.y):this._linearMotionX===Nv?(e=1,n=0):e=n=0,this._linearMotionY===Wv?(s=this._linearLimitsY.x,a=this._linearLimitsY.y):this._linearMotionY===Nv?(s=1,a=0):s=a=0,this._linearMotionZ===Wv?(i=this._linearLimitsZ.x,r=this._linearLimitsZ.y):this._linearMotionZ===Nv?(i=1,r=0):i=r=0;const o=new Ammo.btVector3(e,s,i);t.setLinearLowerLimit(o),o.setValue(n,a,r),t.setLinearUpperLimit(o),Ammo.destroy(o)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const t=new dt,e=this._entityA.rigidbody.body;e.activate();const s=this.entity.getWorldTransform(),i=this._entityA.getWorldTransform().clone().invert();t.mul2(i,s);const n=new Ammo.btTransform;if(this._convertTransform(t,n),this._entityB&&this._entityB.rigidbody){const i=this._entityB.rigidbody.body;i.activate();const a=this._entityB.getWorldTransform().clone().invert();t.mul2(a,s);const r=new Ammo.btTransform;this._convertTransform(t,r),this._constraint=new Ammo.btGeneric6DofSpringConstraint(e,i,n,r,!this._enableCollision),Ammo.destroy(r)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(e,n,!this._enableCollision);Ammo.destroy(n);const a=["X","Y","Z","X","Y","Z"];for(let t=0;t<6;t++){const e=t<3?"_linear":"_angular";this._constraint.enableSpring(t,this[e+"Spring"+a[t]]),this._constraint.setDamping(t,this[e+"Damping"+a[t]]),this._constraint.setEquilibriumPoint(t,this[e+"Equilibrium"+a[t]]),this._constraint.setStiffness(t,this[e+"Stiffness"+a[t]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits();this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){if(this._constraint){this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null}}initFromData(t){for(const e of Hv)t.hasOwnProperty(e)&&(t[e]instanceof st?this["_"+e].copy(t[e]):this["_"+e]=t[e]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(t,e,s){}_onBeforeRemove(){this.fire("remove")}}const qv={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach((t=>{["Damping","Equilibrium","Spring","Stiffness"].forEach((e=>{["X","Y","Z"].forEach((s=>{const i=t+e+s,n="_"+i;let a="linear"===t?0:3;"Y"===s&&(a+=1),"Z"===s&&(a+=2),Object.defineProperty(jv.prototype,i,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,this._constraint[qv[e]](a,t))}})}))}))}));class Xv{constructor(){this.enabled=!0}}const Yv=["enabled"];class Kv extends Ig{constructor(t){super(t),this.id="joint",this.app=t,this.ComponentType=jv,this.DataType=Xv,this.schema=Yv}initializeComponentData(t,e,s){t.initFromData(e)}}Lg._buildAccessors(jv.prototype,Yv);class $v extends Lg{constructor(t,e){super(t,e),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}}function Zv(t){const e="_"+t;Object.defineProperty($v.prototype,t,{get:function(){return this[e]},set:function(t){this[e]!==t&&(this[e]=t,this.fire("resize"))}})}Zv("minWidth"),Zv("minHeight"),Zv("maxWidth"),Zv("maxHeight"),Zv("fitWidthProportion"),Zv("fitHeightProportion"),Zv("excludeFromLayout");class Jv{constructor(){this.enabled=!0}}const Qv=["enabled"];class tx extends Ig{constructor(t){super(t),this.id="layoutchild",this.ComponentType=$v,this.DataType=Jv,this.schema=Qv}initializeComponentData(t,e,s){void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.minWidth&&(t.minWidth=e.minWidth),void 0!==e.minHeight&&(t.minHeight=e.minHeight),void 0!==e.maxWidth&&(t.maxWidth=e.maxWidth),void 0!==e.maxHeight&&(t.maxHeight=e.maxHeight),void 0!==e.fitWidthProportion&&(t.fitWidthProportion=e.fitWidthProportion),void 0!==e.fitHeightProportion&&(t.fitHeightProportion=e.fitHeightProportion),void 0!==e.excludeFromLayout&&(t.excludeFromLayout=e.excludeFromLayout),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.layoutchild;return this.addComponent(e,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}}Lg._buildAccessors($v.prototype,Qv);const ex=0,sx=1,ix=2,nx=3,ax={};ax[Is]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},ax[Ds]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};const rx={};rx[Is]=Ds,rx[Ds]=Is;const ox={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},hx="NONE",lx="APPLY_STRETCHING",cx="APPLY_SHRINKING",dx=new st;function ux(t){let e;const s=ax[t],i=ax[rx[t]];function n(t,e){return-e[s.size]*t.pivot[s.axis]}function a(t,e){return-e[i.size]*t.pivot[i.axis]}function r(t,e){return e[s.size]*(1-t.pivot[s.axis])}function o(t){const e=t.entity.layoutchild;return!e||!e.enabled||!e.excludeFromLayout}function h(t,e,s){switch(t){case ex:return hx;case sx:return e<s?lx:hx;case ix:return e>=s?cx:hx;case nx:return e<s?lx:e>=s?cx:hx;default:throw new Error("Unrecognized fitting mode: "+t)}}function l(t,s){return _(t,s.size)+(t.length-1)*e.spacing[s.axis]}function c(t,e,s){const i=y(t,s.maxSize),n=g(t,s.fittingProportion),a=b(n,i);let r=dx[s.axis]-e;for(let e=0;e<t.length;++e){const o=i[e],h=u(o,r,n,a),l=t[o][s.size]+h,c=t[o][s.maxSize],d=Math.min(l,c);t[o][s.size]=d;r-=h-Math.max(l-d,0)}}function d(t,e,s){const i=y(t,s.minSize,!0),n=function(t){if(1===t.length)return[1];const e=[],s=t.length;for(let i=0;i<s;++i)e.push((1-t[i])/(s-1));return e}(g(t,s.fittingProportion)),a=b(n,i);let r=e-dx[s.axis];for(let e=0;e<t.length;++e){const o=i[e],h=u(o,r,n,a),l=t[o][s.size]-h,c=t[o][s.minSize],d=Math.max(l,c);t[o][s.size]=d;r-=h-Math.max(d-l,0)}}function u(t,e,s,i){const n=s[t],a=i[t];return Math.abs(n)<1e-5&&Math.abs(a)<1e-5?e:e*n/a}function p(t){const e=[];for(let s=0;s<t.length;++s){const i=t[s],n=Math.max(m(i,"minWidth"),0),a=Math.max(m(i,"minHeight"),0),r=Math.max(m(i,"maxWidth"),n),o=Math.max(m(i,"maxHeight"),a),h=f(m(i,"width"),n,r),l=f(m(i,"height"),a,o),c=m(i,"fitWidthProportion"),d=m(i,"fitHeightProportion");e.push({minWidth:n,minHeight:a,maxWidth:r,maxHeight:o,width:h,height:l,fitWidthProportion:c,fitHeightProportion:d})}return e}function m(t,e){const s=t.entity.layoutchild;return s&&s.enabled&&void 0!==s[e]&&null!==s[e]?s[e]:void 0!==t[e]?t[e]:ox[e]}function f(t,e,s){return Math.min(Math.max(t,e),s)}function _(t,e){return t.reduce((function(t,s){return t+s[e]}),0)}function g(t,e){const s=_(t,e),i=[],n=t.length;if(0===s)for(let t=0;t<n;++t)i.push(1/n);else for(let a=0;a<n;++a)i.push(t[a][e]/s);return i}function y(t,e,s){return t.forEach(v),t.slice().sort((function(t,i){return s?i[e]-t[e]:t[e]-i[e]})).map(x)}function v(t,e){t.index=e}function x(t){return t.index}function b(t,e){const s=[];s[e[t.length-1]]=t[e[t.length-1]];for(let i=t.length-2;i>=0;--i)s[e[i]]=s[e[i+1]]+t[e[i]];return s}return function(t,u){t=t.filter(o),e=u,dx.x=e.containerSize.x-e.padding.x-e.padding.z,dx.y=e.containerSize.y-e.padding.y-e.padding.w,function(t){for(let e=0;e<t.length;++e){const s=t[e],i=s.anchor;0===i.x&&0===i.y&&0===i.z&&0===i.w||(s.anchor=nt.ZERO)}}(t);const m=function(t){const s=e.orientation===Is&&e.reverseX||e.orientation===Ds&&e.reverseY,i=e.orientation===Is&&e.reverseY||e.orientation===Ds&&e.reverseX;if(s)for(let e=0;e<t.length;++e)s&&t[e].reverse();i&&t.reverse();return t}(function(t){if(!e.wrap)return[t];const i=[[]],n=p(t);let a=0;const r=e[s.fitting]===ix;for(let o=0;o<t.length;++o){i[i.length-1].length>0&&(a+=e.spacing[s.axis]);const h=n[o][s.size];a+=h,!r&&a>dx[s.axis]&&0!==i[i.length-1].length&&(a=h,i.push([])),i[i.length-1].push(t[o]),r&&a>dx[s.axis]&&o!==t.length-1&&(a=0,i.push([]))}return i}(t)),f=function(t,s){const n=[],a=[];for(let e=0;e<t.length;++e){const r=t[e];r.largestElement=null,r.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let t=0;t<r.length;++t){const n=s[e][t];n[i.size]>r.largestSize[i.size]&&(r.largestElement=r[t],r.largestSize=n)}n.push(r.largestElement),a.push(r.largestSize)}const r=l(a,i),o=h(e[i.fitting],r,dx[i.axis]);o===lx?c(a,r,i):o===cx&&d(a,r,i);for(let n=0;n<t.length;++n){const a=t[n];for(let r=0;r<a.length;++r){const o=s[n][r],l=o[i.size],c=1===t.length?dx[i.axis]:a.largestSize[i.size],d=h(e[i.fitting],l,c);d===lx?o[i.size]=Math.min(c,o[i.maxSize]):d===cx&&(o[i.size]=Math.max(c,o[i.minSize]))}}return s}(m,function(t){const i=[];for(let n=0;n<t.length;++n){const a=p(t[n]),r=l(a,s),o=h(e[s.fitting],r,dx[s.axis]);o===lx?c(a,r,s):o===cx&&d(a,r,s),i.push(a)}return i}(m)),_=function(t,o){const h={};h[s.axis]=0,h[i.axis]=0,t[s.size]=Number.NEGATIVE_INFINITY;const l=[];for(let c=0;c<t.length;++c){const d=t[c];if(0===d.length){l.push([]);continue}const u=[],p=o[c];for(let t=0;t<d.length;++t){const o=d[t],l=p[t];h[i.axis]-=a(o,l),h[s.axis]-=n(o,l),u[t]={},u[t][s.axis]=h[s.axis],u[t][i.axis]=h[i.axis],h[i.axis]+=a(o,l),h[s.axis]+=r(o,l)+e.spacing[s.axis]}d[s.size]=h[s.axis]-e.spacing[s.axis],d[i.size]=d.largestSize[i.size],t[s.size]=Math.max(t[s.size],d[s.size]),h[s.axis]=0,h[i.axis]+=d[i.size]+e.spacing[i.axis],l.push(u)}return t[i.size]=h[i.axis]-e.spacing[i.axis],l}(m,f);return function(t,n,a){const r=e.alignment[s.axis],o=e.alignment[i.axis],h=e.padding[s.axis],l=e.padding[i.axis];for(let c=0;c<t.length;++c){const d=t[c],u=n[c],p=a[c],m=(dx[s.axis]-d[s.size])*r+h,f=(dx[i.axis]-t[i.size])*o+l;for(let t=0;t<d.length;++t){const n=(d[i.size]-u[t][i.size])*e.alignment[i.axis];p[t][s.axis]+=m,p[t][i.axis]+=f+n}}}(m,f,_),function(t,n,a){for(let r=0;r<t.length;++r){const o=t[r],h=n[r],l=a[r];for(let t=0;t<o.length;++t){const n=o[t];n[s.calculatedSize]=h[t][s.size],n[i.calculatedSize]=h[t][i.size],e.orientation===Is?n.entity.setLocalPosition(l[t][s.axis],l[t][i.axis],n.entity.getLocalPosition().z):n.entity.setLocalPosition(l[t][i.axis],l[t][s.axis],n.entity.getLocalPosition().z)}}}(m,f,_),function(t){const s=t.width,i=t.height,n=(dx.x-s)*e.alignment.x+e.padding.x,a=(dx.y-i)*e.alignment.y+e.padding.y;return{bounds:new nt(n,a,s,i)}}(m)}}const px={};px[Is]=ux(Is),px[Ds]=ux(Ds);class mx{calculateLayout(t,e){const s=px[e.orientation];if(s)return s(t,e);throw new Error("Unrecognized orientation value: "+e.orientation)}}function fx(t){return t.element}function _x(t){return t.enabled&&t.element&&t.element.enabled}class gx extends Lg{constructor(t,e){super(t,e),this._orientation=Is,this._reverseX=!1,this._reverseY=!0,this._alignment=new st(0,1),this._padding=new nt,this._spacing=new st,this._widthFitting=ex,this._heightFitting=ex,this._wrap=!1,this._layoutCalculator=new mx,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach((t=>{this._listenForReflowEvents(t,"on")})),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),t.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),t.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}_isSelfOrChild(t){return t===this.entity||-1!==this.entity.children.indexOf(t)}_listenForReflowEvents(t,e){t.element&&(t.element[e]("enableelement",this._scheduleReflow,this),t.element[e]("disableelement",this._scheduleReflow,this),t.element[e]("resize",this._scheduleReflow,this),t.element[e]("set:pivot",this._scheduleReflow,this)),t.layoutchild&&(t.layoutchild[e]("set_enabled",this._scheduleReflow,this),t.layoutchild[e]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"off"),this._scheduleReflow())}_onChildInsert(t){this._listenForReflowEvents(t,"on"),this._scheduleReflow()}_onChildRemove(t){this._listenForReflowEvents(t,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const t=fx(this.entity),e=this.entity.children.filter(_x).map(fx);if(!t||0===e.length)return;const s=Math.max(t.calculatedWidth,0),i=Math.max(t.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new st(s,i)};this._isPerformingReflow=!0;const a=this._layoutCalculator.calculateLayout(e,n);this._isPerformingReflow=!1,this.fire("reflow",a)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach((t=>{this._listenForReflowEvents(t,"off")})),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}function yx(t){const e="_"+t;Object.defineProperty(gx.prototype,t,{get:function(){return this[e]},set:function(t){this[e]!==t&&(this[e]=t,this._scheduleReflow())}})}yx("orientation"),yx("reverseX"),yx("reverseY"),yx("alignment"),yx("padding"),yx("spacing"),yx("widthFitting"),yx("heightFitting"),yx("wrap");class vx{constructor(){this.enabled=!0}}const xx=["enabled"];class bx extends Ig{constructor(t){super(t),this.id="layoutgroup",this.ComponentType=gx,this.DataType=vx,this.schema=xx,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e,s){void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.orientation&&(t.orientation=e.orientation),void 0!==e.reverseX&&(t.reverseX=e.reverseX),void 0!==e.reverseY&&(t.reverseY=e.reverseY),void 0!==e.alignment&&(e.alignment instanceof st?t.alignment.copy(e.alignment):t.alignment.set(e.alignment[0],e.alignment[1]),t.alignment=t.alignment),void 0!==e.padding&&(e.padding instanceof nt?t.padding.copy(e.padding):t.padding.set(e.padding[0],e.padding[1],e.padding[2],e.padding[3]),t.padding=t.padding),void 0!==e.spacing&&(e.spacing instanceof st?t.spacing.copy(e.spacing):t.spacing.set(e.spacing[0],e.spacing[1]),t.spacing=t.spacing),void 0!==e.widthFitting&&(t.widthFitting=e.widthFitting),void 0!==e.heightFitting&&(t.heightFitting=e.heightFitting),void 0!==e.wrap&&(t.wrap=e.wrap),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.layoutgroup;return this.addComponent(e,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(t){-1===this._reflowQueue.indexOf(t)&&this._reflowQueue.push(t)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(0===this._reflowQueue.length)return;let t=0;for(;this._reflowQueue.length>0;){const e=this._reflowQueue.slice();this._reflowQueue.length=0,e.sort((function(t,e){return t.entity.graphDepth-e.entity.graphDepth}));for(let t=0;t<e.length;++t)e[t].reflow();if(++t>=100){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}Lg._buildAccessors(gx.prototype,xx);const Sx=[],Mx=[];class Tx extends Lg{constructor(t,e){super(t,e),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.addLight(this)}}removeLightFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeLight(this)}}onLayersChanged(t,e){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.entity.enabled&&t.addLight(this)}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&t.removeLight(this)}refreshProperties(){for(let t=0;t<Sx.length;t++){const e=Sx[t];this[e]=this[e]}this.enabled&&this.entity.enabled&&this.onEnable()}updateShadow(){this.light.updateShadow()}onCookieAssetSet(){let t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}}function Ax(t,e,s,i){const n=Tx.prototype;Sx.push(t),Mx.push(e),Object.defineProperty(n,t,{get:function(){return this.data[t]},set:function(e){const n=this.data,a=n[t];(i||a!==e)&&(n[t]=e,s&&s.call(this,e,a))},configurable:!0})}Ax("enabled",!0,(function(t,e){this.onSetEnabled(null,e,t)})),Ax("light",null),Ax("type","directional",(function(t,e){this.system.changeType(this,e,t),this.refreshProperties()})),Ax("color",new J(1,1,1),(function(t,e){this.light.setColor(t)}),!0),Ax("intensity",1,(function(t,e){this.light.intensity=t})),Ax("shape",$t,(function(t,e){this.light.shape=t})),Ax("castShadows",!1,(function(t,e){this.light.castShadows=t})),Ax("shadowDistance",40,(function(t,e){this.light.shadowDistance=t})),Ax("shadowResolution",1024,(function(t,e){this.light.shadowResolution=t})),Ax("shadowBias",.05,(function(t,e){this.light.shadowBias=-.01*V.clamp(t,0,1)})),Ax("numCascades",1,(function(t,e){this.light.numCascades=V.clamp(Math.floor(t),1,4)})),Ax("bakeNumSamples",1,(function(t,e){this.light.bakeNumSamples=V.clamp(Math.floor(t),1,255)})),Ax("bakeArea",0,(function(t,e){this.light.bakeArea=V.clamp(t,0,180)})),Ax("cascadeDistribution",.5,(function(t,e){this.light.cascadeDistribution=V.clamp(t,0,1)})),Ax("normalOffsetBias",0,(function(t,e){this.light.normalOffsetBias=V.clamp(t,0,1)})),Ax("range",10,(function(t,e){this.light.attenuationEnd=t})),Ax("innerConeAngle",40,(function(t,e){this.light.innerConeAngle=t})),Ax("outerConeAngle",45,(function(t,e){this.light.outerConeAngle=t})),Ax("falloffMode",te,(function(t,e){this.light.falloffMode=t})),Ax("shadowType",se,(function(t,e){this.light.shadowType=t})),Ax("vsmBlurSize",11,(function(t,e){this.light.vsmBlurSize=t})),Ax("vsmBlurMode",ce,(function(t,e){this.light.vsmBlurMode=t})),Ax("vsmBias",.0025,(function(t,e){this.light.vsmBias=V.clamp(t,0,1)})),Ax("cookieAsset",null,(function(t,e){if(!this._cookieAssetId||!(t instanceof wm&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof wm)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;const e=this.system.app.assets.get(t);e?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),Ax("cookie",null,(function(t,e){this.light.cookie=t})),Ax("cookieIntensity",1,(function(t,e){this.light.cookieIntensity=V.clamp(t,0,1)})),Ax("cookieFalloff",!0,(function(t,e){this.light.cookieFalloff=t})),Ax("cookieChannel","rgb",(function(t,e){this.light.cookieChannel=t})),Ax("cookieAngle",0,(function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new nt);let e=1,s=1;this.cookieScale&&(e=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(t*V.DEG_TO_RAD),n=Math.sin(t*V.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),Ax("cookieScale",null,(function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new nt);const e=t.x,s=t.y,i=Math.cos(this.cookieAngle*V.DEG_TO_RAD),n=Math.sin(this.cookieAngle*V.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0),Ax("cookieOffset",null,(function(t,e){this.light.cookieOffset=t}),!0),Ax("shadowUpdateMode",ss,(function(t,e){this.light.shadowUpdateMode=t}),!0),Ax("mask",1,(function(t,e){this.light.mask=t})),Ax("affectDynamic",!0,(function(t,e){t?this.light.mask|=as:this.light.mask&=~as,this.light.layersDirty()})),Ax("affectLightmapped",!1,(function(t,e){t?(this.light.mask|=rs,this.bake&&(this.light.mask&=~os)):(this.light.mask&=~rs,this.bake&&(this.light.mask|=os))})),Ax("bake",!1,(function(t,e){t?(this.light.mask|=os,this.affectLightmapped&&(this.light.mask&=~rs)):(this.light.mask&=~os,this.affectLightmapped&&(this.light.mask|=rs)),this.light.layersDirty()})),Ax("bakeDir",!0,(function(t,e){this.light.bakeDir=t})),Ax("isStatic",!1,(function(t,e){this.light.isStatic=t})),Ax("layers",[Wt],(function(t,e){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeLight(this)}for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&this.enabled&&this.entity.enabled&&s.addLight(this)}}));class Cx{constructor(){const t=Sx,e=Mx;for(let s=0;s<t.length;s++){const i=e[s];i&&i.clone?this[t[s]]=i.clone():this[t[s]]=i}}}const Px={directional:Xt,omni:Yt,point:Yt,spot:Kt};class Rx extends Ig{constructor(t){super(t),this.id="light",this.ComponentType=Tx,this.DataType=Cx,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e){const s=Sx,i={};for(let t=0,n=s.length;t<n;t++){const n=s[t];i[n]=e[n]}i.type||(i.type=t.data.type),t.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new J(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new st(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new st(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=$t);const n=new id(this.app.graphicsDevice);n.type=Px[i.type],n._node=t.entity,n._scene=this.app.scene,t.data.light=n,super.initializeComponentData(t,i,s)}_onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.light,i=[];let n;const a=Sx;for(let t=0;t<a.length;t++)n=a[t],"light"!==n&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);this.addComponent(e,i)}changeType(t,e,s){e!==s&&(t.light.type=Px[s])}}class Ex extends Lg{constructor(t,e){super(t,e),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._material=t.defaultMaterial,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[Wt],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._assetOld=0,this._materialEvents=null,this._dirtyModelAsset=!1,this._dirtyMaterialAsset=!1,this._clonedModel=!1,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}addModelToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this.meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this.meshInstances)}_setMaterialEvent(t,e,s,i){const n=e+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[t]||(this._materialEvents[t]={}),this._materialEvents[t][n]={id:s,handler:i}}_unsetMaterialEvents(){const t=this.system.app.assets,e=this._materialEvents;if(e){for(let s=0,i=e.length;s<i;s++){if(!e[s])continue;const i=e[s];for(const e in i)t.off(e,i[e].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(t){let e=null;if(isNaN(parseInt(t,10))){if(this.asset){const s=this._getMaterialAssetUrl(t);s&&(e=this.system.app.assets.getByUrl(s))}}else e=this.system.app.assets.get(t);return e}_getMaterialAssetUrl(t){if(!this.asset)return null;const e=this.system.app.assets.get(this.asset);return e?e.getAbsoluteUrl(t):null}_loadAndSetMeshInstanceMaterial(t,e,s){const i=this.system.app.assets;t&&(t.resource?(e.material=t.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=this.system.defaultMaterial}))):(this._setMaterialEvent(s,"load",t.id,(function(i){e.material=i.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=this.system.defaultMaterial}))})),this.enabled&&this.entity.enabled&&i.load(t)))}onEnable(){const t=this.system.app,e=t.scene;e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;let i;if(this._model?this.addModelToLayers():s&&this._asset&&(i=t.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=t.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),s&&this._mapping)for(const e in this._mapping)this._mapping[e]&&(i=this._getAssetByIdOrPath(this._mapping[e]),i&&!i.resource&&t.assets.load(i));this._batchGroupId>=0&&t.batcher.insert(tl.MODEL,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&t.batcher.remove(tl.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()}hide(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!1}}show(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!0}}_bindMaterialAsset(t){if(t.on("load",this._onMaterialAssetLoad,this),t.on("unload",this._onMaterialAssetUnload,this),t.on("remove",this._onMaterialAssetRemove,this),t.on("change",this._onMaterialAssetChange,this),t.resource)this._onMaterialAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMaterialAsset(t){t.off("load",this._onMaterialAssetLoad,this),t.off("unload",this._onMaterialAssetUnload,this),t.off("remove",this._onMaterialAssetRemove,this),t.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(t){this.system.app.assets.off("add:"+t.id,this._onMaterialAssetAdd,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_onMaterialAssetLoad(t){this._setMaterial(t.resource)}_onMaterialAssetUnload(t){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(t){this._onMaterialAssetUnload(t)}_onMaterialAssetChange(t){}_bindModelAsset(t){if(this._unbindModelAsset(t),t.on("load",this._onModelAssetLoad,this),t.on("unload",this._onModelAssetUnload,this),t.on("change",this._onModelAssetChange,this),t.on("remove",this._onModelAssetRemove,this),t.resource)this._onModelAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindModelAsset(t){t.off("load",this._onModelAssetLoad,this),t.off("unload",this._onModelAssetUnload,this),t.off("change",this._onModelAssetChange,this),t.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(t){this.system.app.assets.off("add:"+t.id,this._onModelAssetAdded,this),t.id===this._asset&&this._bindModelAsset(t)}_onModelAssetLoad(t){this.model=t.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(t){this.model=null}_onModelAssetChange(t,e,s,i){"data"===e&&(this.mapping=this._mapping)}_onModelAssetRemove(t){this.model=null}_setMaterial(t){if(this._material===t)return;this._material=t;const e=this._model;if(e&&"asset"!==this._type){const s=e.meshInstances;for(let e=0,i=s.length;e<i;e++)s[e].material=t}}get meshInstances(){return this._model?this._model.meshInstances:null}set meshInstances(t){this._model&&(this._model.meshInstances=t)}get customAabb(){return this._customAabb}set customAabb(t){if(this._customAabb=t,this._model){const t=this._model.meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb)}}get type(){return this._type}set type(t){if(this._type!==t)if(this._area=null,this._type=t,"asset"===t||"resource"===t)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{const e=Zh(this.system.app.graphicsDevice,t);this._area=e.area;const s=e.mesh,i=new jr,n=new vd;n.graph=i,n.meshInstances=[new dl(s,this._material,i)],this.model=n,this._asset=null}}get asset(){return this._asset}set asset(t){const e=this.system.app.assets;let s=t;if(t instanceof wm&&(s=t.id),this._asset!==s){if(this._asset){e.off("add:"+this._asset,this._onModelAssetAdded,this);const t=e.get(this._asset);t&&this._unbindModelAsset(t)}if(this._asset=s,this._asset){const t=e.get(this._asset);t?this._bindModelAsset(t):(this.model=null,e.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get model(){return this._model}set model(t){if(this._model!==t&&(!t||!t._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=t,this._model)){this._model._immutable=!0;const t=this._model.meshInstances;for(let e=0;e<t.length;e++)t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic,t[e].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&(this.entity.anim.playing?this.entity.anim.rebind():this.entity.anim.resetStateGraph()),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}get lightmapped(){return this._lightmapped}set lightmapped(t){if(t!==this._lightmapped&&(this._lightmapped=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get castShadows(){return this._castShadows}set castShadows(t){if(this._castShadows===t)return;const e=this._model;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e.meshInstances)}const n=e.meshInstances;for(let e=0;e<n.length;e++)n[e].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e.meshInstances)}}this._castShadows=t}get receiveShadows(){return this._receiveShadows}set receiveShadows(t){if(this._receiveShadows!==t&&(this._receiveShadows=t,this._model)){const e=this._model.meshInstances;for(let s=0,i=e.length;s<i;s++)e[s].receiveShadow=t}}get castShadowsLightmap(){return this._castShadowsLightmap}set castShadowsLightmap(t){this._castShadowsLightmap=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get isStatic(){return this._isStatic}set isStatic(t){if(this._isStatic!==t&&(this._isStatic=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++){e[s].isStatic=t}}}get layers(){return this._layers}set layers(t){const e=this.system.app.scene.layers;if(this.meshInstances)for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}get batchGroupId(){return this._batchGroupId}set batchGroupId(t){if(this._batchGroupId===t)return;const e=this.system.app.batcher;this.entity.enabled&&this._batchGroupId>=0&&e.remove(tl.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&e.insert(tl.MODEL,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=t}get materialAsset(){return this._materialAsset}set materialAsset(t){let e=t;t instanceof wm&&(e=t.id);const s=this.system.app.assets;if(e!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);const t=s.get(this._materialAsset);t&&this._unbindMaterialAsset(t)}if(this._materialAsset=e,this._materialAsset){const t=s.get(this._materialAsset);t?this._bindMaterialAsset(t):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get material(){return this._material}set material(t){this._material!==t&&(this.materialAsset=null,this._setMaterial(t))}get mapping(){return this._mapping}set mapping(t){if("asset"!==this._type)return;if(this._unsetMaterialEvents(),t||(t={}),this._mapping=t,!this._model)return;const e=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let s=0,a=e.length;s<a;s++)if(void 0!==t[s])t[s]?(n=this.system.app.assets.get(t[s]),this._loadAndSetMeshInstanceMaterial(n,e[s],s)):e[s].material=this.system.defaultMaterial;else if(i)if(i[s]&&(i[s].material||i[s].path)){if(void 0!==i[s].material)n=this.system.app.assets.get(i[s].material);else if(void 0!==i[s].path){const t=this._getMaterialAssetUrl(i[s].path);t&&(n=this.system.app.assets.getByUrl(t))}this._loadAndSetMeshInstanceMaterial(n,e[s],s)}else e[s].material=this.system.defaultMaterial}}class Lx{constructor(){this.enabled=!0}}const Ix=["enabled"];class Dx extends Ig{constructor(t){super(t),this.id="model",this.ComponentType=Ex,this.DataType=Lx,this.schema=Ix,this.defaultMaterial=Eo.get(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let i=0;i<s.length;i++)e.hasOwnProperty(s[i])&&(t[s[i]]=e[s[i]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new bt(new it(e.aabbCenter),new it(e.aabbHalfExtents))),super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s={type:t.model.type,asset:t.model.asset,castShadows:t.model.castShadows,receiveShadows:t.model.receiveShadows,castShadowsLightmap:t.model.castShadowsLightmap,lightmapped:t.model.lightmapped,lightmapSizeMultiplier:t.model.lightmapSizeMultiplier,isStatic:t.model.isStatic,enabled:t.model.enabled,layers:t.model.layers,batchGroupId:t.model.batchGroupId,mapping:c({},t.model.mapping)};let i=t.model.materialAsset;i instanceof wm||null==i||(i=this.app.assets.get(i));const n=t.model.material;n&&n!==this.defaultMaterial&&i&&n!==i.resource||(s.materialAsset=i);const a=this.addComponent(e,s);if(t.model.model&&"asset"===t.model.type&&!t.model.asset&&(a.model=t.model.model.clone(),a._clonedModel=!0),s.materialAsset||(a.material=n),t.model.model){const e=t.model.model.meshInstances,s=a.model.meshInstances;for(let t=0;t<e.length;t++)s[t].mask=e[t].mask,s[t].material=e[t].material,s[t].layer=e[t].layer,s[t].receiveShadow=e[t].receiveShadow}t.model.customAabb&&(a.customAabb=t.model.customAabb.clone())}onRemove(t,e){e.onRemove()}}Lg._buildAccessors(Ex.prototype,Ix);class Fx extends Lg{constructor(t,e){super(t,e),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._batchGroupId=-1,this._meshInstances=[],this._layers=[Wt],this._renderStyle=ve,this._customAabb=null,this._area=null,this._rootBone=new iy(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new Nf("asset",this,t.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=t.defaultMaterial,this._materialReferences=[],e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}_onSetRootBone(t){t&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const t=this._meshInstances;if(t){this.removeFromLayers(),this._clearSkinInstances();for(let e=0;e<t.length;e++)t[e].destroy();this._meshInstances.length=0}}addToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this._meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this._meshInstances)}onEnable(){const t=this.system.app,e=t.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].asset&&this.system.app.assets.load(this._materialReferences[t].asset);this._batchGroupId>=0&&t.batcher.insert(tl.RENDER,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&t.batcher.remove(tl.RENDER,this.batchGroupId,this.entity),this.removeFromLayers()}hide(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!1}show(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const t=this._assetReference.asset.resource;t.off("set:meshes",this._onSetMeshes,this),t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(t){this._cloneMeshes(t)}_clearSkinInstances(){for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t];Tm.removeCachedSkinInstance(e.skinInstance),e.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof jr)for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t],s=e.mesh;s.skin&&!s.skinInstance&&(e.skinInstance=Tm.createCachedSkinedInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(t){if(t&&t.length){const e=[];for(let s=0;s<t.length;s++){const i=t[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,a=new dl(i,n||this.system.defaultMaterial,this.entity);e.push(a),i.morph&&(a.morphInstance=new yd(i.morph))}this.meshInstances=e,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(t,e,s){s.resource?this._onMaterialLoad(t,e,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(t,e){0===t&&(this.material=e)}_onMaterialLoad(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=s.resource),this._updateMainMaterial(t,s.resource)}_onMaterialRemove(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}_onMaterialUnload(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}get renderStyle(){return this._renderStyle}set renderStyle(t){this._renderStyle!==t&&(this._renderStyle=t,dl._prepareRenderStyleForArray(this._meshInstances,t))}get customAabb(){return this._customAabb}set customAabb(t){this._customAabb=t;const e=this._meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb)}get type(){return this._type}set type(t){if(this._type!==t&&(this._area=null,this._type=t,this.destroyMeshInstances(),"asset"!==t)){let e=this._material;e&&e!==this.system.defaultMaterial||(e=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=Zh(this.system.app.graphicsDevice,t);this._area=s.area,this.meshInstances=[new dl(s.mesh,e||this.system.defaultMaterial,this.entity)]}}get meshInstances(){return this._meshInstances}set meshInstances(t){if(this.destroyMeshInstances(),this._meshInstances=t,this._meshInstances){const t=this._meshInstances;for(let e=0;e<t.length;e++)t[e].node||(t[e].node=this.entity),t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic,t[e].renderStyle=this._renderStyle,t[e].setLightmapped(this._lightmapped),t[e].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get lightmapped(){return this._lightmapped}set lightmapped(t){if(t!==this._lightmapped){this._lightmapped=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get castShadows(){return this._castShadows}set castShadows(t){if(this._castShadows!==t){const e=this._meshInstances;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=i.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e)}for(let s=0;s<e.length;s++)e[s].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e)}}this._castShadows=t}}get receiveShadows(){return this._receiveShadows}set receiveShadows(t){if(this._receiveShadows!==t){this._receiveShadows=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].receiveShadow=t}}get castShadowsLightmap(){return this._castShadowsLightmap}set castShadowsLightmap(t){this._castShadowsLightmap=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get isStatic(){return this._isStatic}set isStatic(t){if(this._isStatic!==t){this._isStatic=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].isStatic=t}}get layers(){return this._layers}set layers(t){const e=this.system.app.scene.layers;let s;if(this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.addMeshInstances(this._meshInstances)}get batchGroupId(){return this._batchGroupId}set batchGroupId(t){if(this._batchGroupId!==t){const e=this.system.app.batcher;this.entity.enabled&&this._batchGroupId>=0&&e.remove(tl.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&e.insert(tl.RENDER,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=t}}get material(){return this._material}set material(t){if(this._material!==t&&(this._material=t,this._meshInstances&&"asset"!==this._type))for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].material=t}get materialAssets(){return this._materialReferences.map((function(t){return t.id}))}set materialAssets(t=[]){if(this._materialReferences.length>t.length){for(let e=t.length;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this._materialReferences.length=t.length}for(let e=0;e<t.length;e++)if(this._materialReferences[e]||this._materialReferences.push(new Nf(e,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),t[e]){const s=t[e]instanceof wm?t[e].id:t[e];this._materialReferences[e].id!==s&&(this._materialReferences[e].id=s),this._materialReferences[e].asset&&this._onMaterialAdded(e,this,this._materialReferences[e].asset)}else this._materialReferences[e].id=null,this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)}get asset(){return this._assetReference.id}set asset(t){const e=t instanceof wm?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onRenderAssetAdded())}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone]&&(this.rootBone=e[t.rootBone]),this._clearSkinInstances()}}class Ox{constructor(){this.enabled=!0,this.rootBone=null}}const kx=[{name:"rootBone",type:"entity"},"enabled"],Bx=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class zx extends Ig{constructor(t){super(t),this.id="render",this.ComponentType=Fx,this.DataType=Ox,this.schema=kx,this.defaultMaterial=Eo.get(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let s=0;s<Bx.length;s++)e.hasOwnProperty(Bx[s])&&(t[Bx[s]]=e[Bx[s]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new bt(new it(e.aabbCenter),new it(e.aabbHalfExtents))),super.initializeComponentData(t,e,kx)}cloneComponent(t,e){const s={};for(let e=0;e<Bx.length;e++)s[Bx[e]]=t.render[Bx[e]];delete s.meshInstances;const i=this.addComponent(e,s),n=t.render.meshInstances,a=n.map((t=>t.mesh));i._onSetMeshes(a);for(let t=0;t<n.length;t++)i.meshInstances[t].material=n[t].material;t.render.customAabb&&(i.customAabb=t.render.customAabb.clone())}onRemove(t,e){e.onRemove()}}Lg._buildAccessors(Fx.prototype,kx);const Ux=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],Vx=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],Nx=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],Wx=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let Gx;class Hx extends Lg{constructor(t,e){super(t,e),this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),Ux.forEach((t=>{this.on(`set_${t}`,this.onSetSimpleProperty,this)})),Vx.forEach((t=>{this.on(`set_${t}`,this.onSetComplexProperty,this)})),Nx.forEach((t=>{this.on(`set_${t}`,this.onSetGraphProperty,this)})),this._requestedDepth=!1,this._drawOrder=0}get drawOrder(){return this._drawOrder}set drawOrder(t){this._drawOrder=t,this.emitter&&(this.emitter.drawOrder=t)}addModelToLayers(){if(this.data.model)for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&(e.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=e)}}removeModelFromLayers(t){if(this.data.model)for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeMeshInstances(this.data.model.meshInstances)}}onSetLayers(t,e,s){if(this.data.model){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeMeshInstances(this.data.model.meshInstances)}if(this.enabled&&this.entity.enabled)for(let t=0;t<s.length;t++){const e=this.system.app.scene.layers.getLayerById(s[t]);e&&e.addMeshInstances(this.data.model.meshInstances)}}}onLayersChanged(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){if(!this.data.model)return;this.layers.indexOf(t.id)<0||t.addMeshInstances(this.data.model.meshInstances)}onLayerRemoved(t){if(!this.data.model)return;this.layers.indexOf(t.id)<0||t.removeMeshInstances(this.data.model.meshInstances)}_bindColorMapAsset(t){if(t.on("load",this._onColorMapAssetLoad,this),t.on("unload",this._onColorMapAssetUnload,this),t.on("remove",this._onColorMapAssetRemove,this),t.on("change",this._onColorMapAssetChange,this),t.resource)this._onColorMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindColorMapAsset(t){t.off("load",this._onColorMapAssetLoad,this),t.off("unload",this._onColorMapAssetUnload,this),t.off("remove",this._onColorMapAssetRemove,this),t.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(t){this.colorMap=t.resource}_onColorMapAssetUnload(t){this.colorMap=null}_onColorMapAssetRemove(t){this._onColorMapAssetUnload(t)}_onColorMapAssetChange(t){}onSetColorMapAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindColorMapAsset(t)}if(s){s instanceof wm&&(this.data.colorMapAsset=s.id,s=s.id);const t=i.get(s);t?this._bindColorMapAsset(t):i.once("add:"+s,(t=>{this._bindColorMapAsset(t)}))}else this.colorMap=null}_bindNormalMapAsset(t){if(t.on("load",this._onNormalMapAssetLoad,this),t.on("unload",this._onNormalMapAssetUnload,this),t.on("remove",this._onNormalMapAssetRemove,this),t.on("change",this._onNormalMapAssetChange,this),t.resource)this._onNormalMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindNormalMapAsset(t){t.off("load",this._onNormalMapAssetLoad,this),t.off("unload",this._onNormalMapAssetUnload,this),t.off("remove",this._onNormalMapAssetRemove,this),t.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(t){this.normalMap=t.resource}_onNormalMapAssetUnload(t){this.normalMap=null}_onNormalMapAssetRemove(t){this._onNormalMapAssetUnload(t)}_onNormalMapAssetChange(t){}onSetNormalMapAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindNormalMapAsset(t)}if(s){s instanceof wm&&(this.data.normalMapAsset=s.id,s=s.id);const t=i.get(s);t?this._bindNormalMapAsset(t):i.once("add:"+s,(t=>{this._bindNormalMapAsset(t)}))}else this.normalMap=null}_bindMeshAsset(t){if(t.on("load",this._onMeshAssetLoad,this),t.on("unload",this._onMeshAssetUnload,this),t.on("remove",this._onMeshAssetRemove,this),t.on("change",this._onMeshAssetChange,this),t.resource)this._onMeshAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMeshAsset(t){t.off("load",this._onMeshAssetLoad,this),t.off("unload",this._onMeshAssetUnload,this),t.off("remove",this._onMeshAssetRemove,this),t.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(t){this._onMeshChanged(t.resource)}_onMeshAssetUnload(t){this.mesh=null}_onMeshAssetRemove(t){this._onMeshAssetUnload(t)}_onMeshAssetChange(t){}onSetMeshAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindMeshAsset(t)}if(s){s instanceof wm&&(this.data.meshAsset=s.id,s=s.id);const t=i.get(s);t&&this._bindMeshAsset(t)}else this._onMeshChanged(null)}onSetMesh(t,e,s){!s||s instanceof wm||"number"==typeof s?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(t){!t||t instanceof Uh||(t=t.meshInstances[0]?t.meshInstances[0].mesh:null),this.data.mesh=t,this.emitter&&(this.emitter.mesh=t,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(t,e,s){const i=this.system.app.assets;if(e){const t=i.get(e);t&&this._unbindRenderAsset(t)}if(s){s instanceof wm&&(this.data.renderAsset=s.id,s=s.id);const t=i.get(s);t&&this._bindRenderAsset(t)}else this._onRenderChanged(null)}_bindRenderAsset(t){if(t.on("load",this._onRenderAssetLoad,this),t.on("unload",this._onRenderAssetUnload,this),t.on("remove",this._onRenderAssetRemove,this),t.resource)this._onRenderAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindRenderAsset(t){t.off("load",this._onRenderAssetLoad,this),t.off("unload",this._onRenderAssetUnload,this),t.off("remove",this._onRenderAssetRemove,this),t.resource&&t.resource.off("set:meshes",this._onRenderSetMeshes,this)}_onRenderAssetLoad(t){this._onRenderChanged(t.resource)}_onRenderAssetUnload(t){this._onRenderChanged(null)}_onRenderAssetRemove(t){this._onRenderAssetUnload(t)}_onRenderChanged(t){t?(t.off("set:meshes",this._onRenderSetMeshes,this),t.on("set:meshes",this._onRenderSetMeshes,this),t.meshes&&this._onRenderSetMeshes(t.meshes)):this._onMeshChanged(null)}_onRenderSetMeshes(t){this._onMeshChanged(t&&t[0])}onSetLoop(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetTime())}onSetBlendType(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(Gx||(Gx=this.system.app.scene.layers.getLayerById(Gt)),Gx&&(Gx.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&Gx&&(Gx.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(t,e,s){e!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[t]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[t]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetMaterial())}onSetComplexProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const t=this.data;for(let e=0,s=Wx.length;e<s;e++){let s=t[Wx[e]];if(s){if(!(s instanceof wm)){if(!(parseInt(s,10)>=0))continue;s=this.system.app.assets.get(s)}s&&!s.resource&&this.system.app.assets.load(s)}}if(!this.emitter){let e=t.mesh;e instanceof Uh||(e=null),this.emitter=new pu(this.system.app.graphicsDevice,{numParticles:t.numParticles,emitterExtents:t.emitterExtents,emitterExtentsInner:t.emitterExtentsInner,emitterRadius:t.emitterRadius,emitterRadiusInner:t.emitterRadiusInner,emitterShape:t.emitterShape,initialVelocity:t.initialVelocity,wrap:t.wrap,localSpace:t.localSpace,screenSpace:t.screenSpace,wrapBounds:t.wrapBounds,lifetime:t.lifetime,rate:t.rate,rate2:t.rate2,orientation:t.orientation,particleNormal:t.particleNormal,animTilesX:t.animTilesX,animTilesY:t.animTilesY,animStartFrame:t.animStartFrame,animNumFrames:t.animNumFrames,animNumAnimations:t.animNumAnimations,animIndex:t.animIndex,randomizeAnimIndex:t.randomizeAnimIndex,animSpeed:t.animSpeed,animLoop:t.animLoop,startAngle:t.startAngle,startAngle2:t.startAngle2,scaleGraph:t.scaleGraph,scaleGraph2:t.scaleGraph2,colorGraph:t.colorGraph,colorGraph2:t.colorGraph2,alphaGraph:t.alphaGraph,alphaGraph2:t.alphaGraph2,localVelocityGraph:t.localVelocityGraph,localVelocityGraph2:t.localVelocityGraph2,velocityGraph:t.velocityGraph,velocityGraph2:t.velocityGraph2,rotationSpeedGraph:t.rotationSpeedGraph,rotationSpeedGraph2:t.rotationSpeedGraph2,radialSpeedGraph:t.radialSpeedGraph,radialSpeedGraph2:t.radialSpeedGraph2,colorMap:t.colorMap,normalMap:t.normalMap,loop:t.loop,preWarm:t.preWarm,sort:t.sort,stretch:t.stretch,alignToMotion:t.alignToMotion,lighting:t.lighting,halfLambert:t.halfLambert,intensity:t.intensity,depthSoftening:t.depthSoftening,scene:this.system.app.scene,mesh:e,depthWrite:t.depthWrite,noFog:t.noFog,node:this.entity,blendType:t.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,this.psys=new vd,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],t.model=this.psys,this.emitter.psys=this.psys,t.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}t.model&&this.emitter.colorMap&&this.addModelToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&t.depthSoftening&&this._requestDepth()}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth()),this.emitter&&(this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1);const t=this.data;t.model&&(this.entity.removeChild(t.model.getGraph()),t.model.destroy(),t.model=null),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<Wx.length;e++){const s=Wx[e];t[s]&&(this[s]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)}rebuild(){const t=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]),this.enabled=t}}class jx{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new it,this.emitterExtentsInner=new it,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=pe,this.initialVelocity=0,this.wrapBounds=new it,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=ue,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=fe,this.particleNormal=new it(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=Ct,this.model=null,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[Wt]}}const qx=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class Xx extends Ig{constructor(t){super(t),this.id="particlesystem",this.ComponentType=Hx,this.DataType=jx,this.schema=qx,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i={};s=[];const n=this.propertyTypes;(e.mesh instanceof wm||"number"==typeof e.mesh)&&(e.meshAsset=e.mesh,delete e.mesh);for(const t in e){if(e.hasOwnProperty(t)&&(s.push(t),i[t]=e[t]),"vec3"===n[t])Array.isArray(i[t])&&(i[t]=new it(i[t][0],i[t][1],i[t][2]));else if("curve"===n[t]){if(!(i[t]instanceof tt)){const e=i[t].type;i[t]=new tt(i[t].keys),i[t].type=e}}else if("curveset"===n[t]&&!(i[t]instanceof et)){const e=i[t].type;i[t]=new et(i[t].keys),i[t].type=e}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(t,i,s)}cloneComponent(t,e){const s=t.particlesystem.data,i=this.schema,n={};for(let t=0,e=i.length;t<e;t++){const e=i[t];let a=s[e];a instanceof it||a instanceof tt||a instanceof et?(a=a.clone(),n[e]=a):"layers"===e?n.layers=s.layers.slice(0):null!=a&&(n[e]=a)}return this.addComponent(e,n)}onUpdate(t){const e=this.store;let s;const i=this.app.stats.particles;for(const n in e)if(e.hasOwnProperty(n)){const a=e[n],r=a.entity,o=a.data;if(o.enabled&&r.enabled){const e=o.model.emitter;if(!e.meshInstance.visible)continue;if(e.lighting){const t=o.layers;let s;for(let i=0;i<t.length;i++){const n=this.app.scene.layers.getLayerById(t[i]);if(!n)continue;n._lightCube||(n._lightCube=new Float32Array(18)),s=n._lightCube;for(let t=0;t<6;t++)s[3*t]=this.app.scene.ambientLight.r,s[3*t+1]=this.app.scene.ambientLight.g,s[3*t+2]=this.app.scene.ambientLight.b;const a=n._splitLights[Xt];for(let t=0;t<a.length;t++)for(let i=0;i<6;i++){const n=Math.max(e.lightCubeDir[i].dot(a[t]._direction),0)*a[t]._intensity;s[3*i]+=a[t]._color.r*n,s[3*i+1]+=a[t]._color.g*n,s[3*i+2]+=a[t]._color.b*n}}e.constantLightCube.setValue(s)}if(!o.paused){if(e.simTime+=t,e.simTime>e.fixedTimeStep&&(s=Math.floor(e.simTime/e.fixedTimeStep),e.simTime-=s*e.fixedTimeStep),s){s=Math.min(s,e.maxSubSteps);for(let t=0;t<s;t++)e.addTime(e.fixedTimeStep,!1);i._updatesPerFrame+=s,i._frameTime+=e._addTimeTime,e._addTimeTime=0}e.finishFrame()}}}}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lg._buildAccessors(Hx.prototype,qx);class Yx{constructor(t,e){this._constructor=t,this._pool=[],this._count=0,this._resize(e)}_resize(t){if(t>this._pool.length)for(let e=this._pool.length;e<t;e++)this._pool[e]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0}}let Kx,$x,Zx,Jx,Qx,tb,eb;class sb extends Lg{constructor(t,e){super(t,e),"undefined"==typeof Ammo||Kx||(Kx=new Ammo.btTransform,$x=new Ammo.btVector3,Zx=new Ammo.btVector3,Jx=new Ammo.btQuaternion,Qx=new Ammo.btVector3(0,0,0)),this._angularDamping=0,this._angularFactor=new it(1,1,1),this._angularVelocity=new it,this._body=null,this._friction=.5,this._group=Vy,this._linearDamping=0,this._linearFactor=new it(1,1,1),this._linearVelocity=new it,this._mask=Hy,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=Ly}get angularDamping(){return this._angularDamping}set angularDamping(t){this._angularDamping!==t&&(this._angularDamping=t,this._body&&this._body.setDamping(this._linearDamping,t))}get angularFactor(){return this._angularFactor}set angularFactor(t){this._angularFactor.equals(t)||(this._angularFactor.copy(t),this._body&&this._type===Iy&&($x.setValue(t.x,t.y,t.z),this._body.setAngularFactor($x)))}get angularVelocity(){if(this._body&&this._type===Iy){const t=this._body.getAngularVelocity();this._angularVelocity.set(t.x(),t.y(),t.z())}return this._angularVelocity}set angularVelocity(t){this._body&&this._type===Iy&&(this._body.activate(),$x.setValue(t.x,t.y,t.z),this._body.setAngularVelocity($x),this._angularVelocity.copy(t))}get body(){return this._body}set body(t){this._body!==t&&(this._body=t,t&&this._simulationEnabled&&t.activate())}get friction(){return this._friction}set friction(t){this._friction!==t&&(this._friction=t,this._body&&this._body.setFriction(t))}get group(){return this._group}set group(t){this._group!==t&&(this._group=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get linearDamping(){return this._linearDamping}set linearDamping(t){this._linearDamping!==t&&(this._linearDamping=t,this._body&&this._body.setDamping(t,this._angularDamping))}get linearFactor(){return this._linearFactor}set linearFactor(t){this._linearFactor.equals(t)||(this._linearFactor.copy(t),this._body&&this._type===Iy&&($x.setValue(t.x,t.y,t.z),this._body.setLinearFactor($x)))}get linearVelocity(){if(this._body&&this._type===Iy){const t=this._body.getLinearVelocity();this._linearVelocity.set(t.x(),t.y(),t.z())}return this._linearVelocity}set linearVelocity(t){this._body&&this._type===Iy&&(this._body.activate(),$x.setValue(t.x,t.y,t.z),this._body.setLinearVelocity($x),this._linearVelocity.copy(t))}get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mass(){return this._mass}set mass(t){if(this._mass!==t&&(this._mass=t,this._body&&this._type===Iy)){const e=this.enabled&&this.entity.enabled;e&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(t,$x),this._body.setMassProps(t,$x),this._body.updateInertiaTensor(),e&&this.enableSimulation()}}get restitution(){return this._restitution}set restitution(t){this._restitution!==t&&(this._restitution=t,this._body&&this._body.setRestitution(t))}get rollingFriction(){return this._rollingFriction}set rollingFriction(t){this._rollingFriction!==t&&(this._rollingFriction=t,this._body&&this._body.setRollingFriction(t))}get type(){return this._type}set type(t){if(this._type!==t){switch(this._type=t,this.disableSimulation(),t){case Iy:this._group=Uy,this._mask=Gy;break;case Dy:this._group=Ny,this._mask=Gy;break;default:this._group=Vy,this._mask=Hy}this.createBody()}}createBody(){const t=this.entity;let e;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&this.system.onRemove(t,this);const s=this._type===Iy?this._mass:0;this._getEntityTransform(Kx);const i=this.system.createBody(s,e,Kx);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===Iy){const t=this._linearFactor;$x.setValue(t.x,t.y,t.z),i.setLinearFactor($x);const e=this._angularFactor;$x.setValue(e.x,e.y,e.z),i.setAngularFactor($x)}else this._type===Dy&&(i.setCollisionFlags(i.getCollisionFlags()|Fy),i.setActivationState(By));i.entity=t,this.body=i,this.enabled&&t.enabled&&this.enableSimulation()}}isActive(){return!!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate()}enableSimulation(){const t=this.entity;if(t.collision&&t.collision.enabled&&!this._simulationEnabled){const e=this._body;if(e){switch(this.system.addBody(e,this._group,this._mask),this._type){case Iy:this.system._dynamic.push(this),e.forceActivationState(ky),this.syncEntityToBody();break;case Dy:this.system._kinematic.push(this),e.forceActivationState(By);break;case Ly:e.forceActivationState(ky),this.syncEntityToBody()}"compound"===t.collision.type&&this.system._compounds.push(t.collision),e.activate(),this._simulationEnabled=!0}}}disableSimulation(){const t=this._body;if(t&&this._simulationEnabled){const e=this.system;let s=e._compounds.indexOf(this.entity.collision);s>-1&&e._compounds.splice(s,1),s=e._dynamic.indexOf(this),s>-1&&e._dynamic.splice(s,1),s=e._kinematic.indexOf(this),s>-1&&e._kinematic.splice(s,1),e.removeBody(t),t.forceActivationState(zy),this._simulationEnabled=!1}}applyForce(){let t,e,s,i,n,a;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;case 6:t=arguments[0],e=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5]}const r=this._body;r&&(r.activate(),$x.setValue(t,e,s),void 0!==i?(Zx.setValue(i,n,a),r.applyForce($x,Zx)):r.applyForce($x,Qx))}applyTorque(){let t,e,s;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),$x.setValue(t,e,s),i.applyTorque($x))}applyImpulse(){let t,e,s,i,n,a;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,a=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;case 6:t=arguments[0],e=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5];break;default:return}const r=this._body;r&&(r.activate(),$x.setValue(t,e,s),void 0!==i?(Zx.setValue(i,n,a),r.applyImpulse($x,Zx)):r.applyImpulse($x,Qx))}applyTorqueImpulse(){let t,e,s;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),$x.setValue(t,e,s),i.applyTorqueImpulse($x))}isStatic(){return this._type===Ly}isStaticOrKinematic(){return this._type===Ly||this._type===Dy}isKinematic(){return this._type===Dy}_getEntityTransform(t){const e=this.entity,s=e.getPosition(),i=e.getRotation();$x.setValue(s.x,s.y,s.z),Jx.setValue(i.x,i.y,i.z,i.w),t.setOrigin($x),t.setRotation(Jx)}syncEntityToBody(){const t=this._body;if(t){if(this._getEntityTransform(Kx),t.setWorldTransform(Kx),this._type===Dy){const e=t.getMotionState();e&&e.setWorldTransform(Kx)}t.activate()}}_updateDynamic(){const t=this._body;if(t.isActive()){const e=t.getMotionState();if(e){e.getWorldTransform(Kx);const t=Kx.getOrigin(),s=Kx.getRotation();this.entity.setPosition(t.x(),t.y(),t.z()),this.entity.setRotation(s.x(),s.y(),s.z(),s.w())}}}_updateKinematic(){const t=this._body.getMotionState();t&&(this._getEntityTransform(Kx),t.setWorldTransform(Kx))}teleport(){arguments.length<3?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof ft?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}}class ib{constructor(){this.enabled=!0}}class nb{constructor(t,e,s){this.entity=t,this.point=e,this.normal=s}}class ab{constructor(t,e,s){0===arguments.length?(this.a=null,this.b=null,this.impulse=0,this.localPointA=new it,this.localPointB=new it,this.pointA=new it,this.pointB=new it,this.normal=new it):(this.a=t,this.b=e,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal)}}class rb{constructor(t=new it,e=new it,s=new it,i=new it,n=new it,a=0){this.localPoint=t,this.localPointOther=e,this.point=s,this.pointOther=i,this.normal=n,this.impulse=a}}class ob{constructor(t,e){this.other=t,this.contacts=e}}const hb=["enabled"];class lb extends Ig{constructor(t){super(t),this.id="rigidbody",this._stats=t.stats.frame,this.ComponentType=sb,this.DataType=ib,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=hb,this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new it(0,-9.81,0),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}tb=new Ammo.btVector3,eb=new Ammo.btVector3,this.contactPointPool=new Yx(rb,1),this.contactResultPool=new Yx(ob,1),this.singleContactResultPool=new Yx(ab,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const s of i)if(e.hasOwnProperty(s)){const i=e[s];Array.isArray(i)?t[s]=new it(i[0],i[1],i[2]):t[s]=i}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&(e.enabled=!1)}onRemove(t,e){const s=e.body;s&&(this.removeBody(s),this.destroyBody(s),e.body=null)}addBody(t,e,s){void 0!==e&&void 0!==s?this.dynamicsWorld.addRigidBody(t,e,s):this.dynamicsWorld.addRigidBody(t)}removeBody(t){this.dynamicsWorld.removeRigidBody(t)}createBody(t,e,s){const i=new Ammo.btVector3(0,0,0);0!==t&&e.calculateLocalInertia(t,i);const n=new Ammo.btDefaultMotionState(s),a=new Ammo.btRigidBodyConstructionInfo(t,n,e,i),r=new Ammo.btRigidBody(a);return Ammo.destroy(a),Ammo.destroy(i),r}destroyBody(t){const e=t.getMotionState();e&&Ammo.destroy(e),Ammo.destroy(t)}raycastFirst(t,e){let s=null;tb.setValue(t.x,t.y,t.z),eb.setValue(e.x,e.y,e.z);const i=new Ammo.ClosestRayResultCallback(tb,eb);if(this.dynamicsWorld.rayTest(tb,eb,i),i.hasHit()){const t=i.get_m_collisionObject(),e=Ammo.castObject(t,Ammo.btRigidBody);if(e){const t=i.get_m_hitPointWorld(),n=i.get_m_hitNormalWorld();if(s=new nb(e.entity,new it(t.x(),t.y(),t.z()),new it(n.x(),n.y(),n.z())),arguments.length>2){(0,arguments[2])(s)}}}return Ammo.destroy(i),s}raycastAll(t,e){const s=[];tb.setValue(t.x,t.y,t.z),eb.setValue(e.x,e.y,e.z);const i=new Ammo.AllHitsRayResultCallback(tb,eb);if(this.dynamicsWorld.rayTest(tb,eb,i),i.hasHit()){const t=i.get_m_collisionObjects(),e=i.get_m_hitPointWorld(),n=i.get_m_hitNormalWorld(),a=t.size();for(let i=0;i<a;i++){const a=Ammo.castObject(t.at(i),Ammo.btRigidBody);if(a){const t=e.at(i),r=n.at(i),o=new nb(a.entity,new it(t.x(),t.y(),t.z()),new it(r.x(),r.y(),r.z()));s.push(o)}}}return Ammo.destroy(i),s}_storeCollision(t,e){let s=!1;const i=t.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:t},this.collisions[i].others.indexOf(e)<0&&(this.collisions[i].others.push(e),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:t},this.frameCollisions[i].others.push(e),s}_createContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),a=t.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPoint.set(e.x(),e.y(),e.z()),r.localPointOther.set(s.x(),s.y(),s.z()),r.point.set(i.x(),i.y(),i.z()),r.pointOther.set(n.x(),n.y(),n.z()),r.normal.set(a.x(),a.y(),a.z()),r.impulse=t.getAppliedImpulse(),r}_createReverseContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),a=t.get_m_normalWorldOnB(),r=this.contactPointPool.allocate();return r.localPointOther.set(e.x(),e.y(),e.z()),r.localPoint.set(s.x(),s.y(),s.z()),r.pointOther.set(i.x(),i.y(),i.z()),r.point.set(n.x(),n.y(),n.z()),r.normal.set(a.x(),a.y(),a.z()),r.impulse=t.getAppliedImpulse(),r}_createSingleContactResult(t,e,s){const i=this.singleContactResultPool.allocate();return i.a=t,i.b=e,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(t,e){const s=this.contactResultPool.allocate();return s.other=t,s.contacts=e,s}_cleanOldCollisions(){for(const t in this.collisions)if(this.collisions.hasOwnProperty(t)){const e=this.frameCollisions[t],s=this.collisions[t],i=s.entity,n=i.collision,a=i.rigidbody,r=s.others;let o=r.length;for(;o--;){const t=r[o];(!e||e.others.indexOf(t)<0)&&(r.splice(o,1),i.trigger?(n&&n.fire("triggerleave",t),t.rigidbody&&t.rigidbody.fire("triggerleave",i)):t.trigger||(a&&a.fire("collisionend",t),n&&n.fire("collisionend",t)))}0===r.length&&delete this.collisions[t]}}_hasContactEvent(t){const e=t.collision;if(e&&(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact")))return!0;const s=t.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(t,e){const s=Ammo.wrapPointer(t,Ammo.btDynamicsWorld).getDispatcher(),i=s.getNumManifolds();this.frameCollisions={};for(let t=0;t<i;t++){const e=s.getManifoldByIndexInternal(t),i=e.getBody0(),n=e.getBody1(),a=Ammo.castObject(i,Ammo.btRigidBody),r=Ammo.castObject(n,Ammo.btRigidBody),o=a.entity,h=r.entity;if(!o||!h)continue;const l=a.getCollisionFlags(),c=r.getCollisionFlags(),d=e.getNumContacts(),u=[],p=[];let m;if(d>0)if(l&Oy||c&Oy){const t=o.collision&&(o.collision.hasEvent("triggerenter")||o.collision.hasEvent("triggerleave")),e=h.collision&&(h.collision.hasEvent("triggerenter")||h.collision.hasEvent("triggerleave")),s=o.rigidbody&&(o.rigidbody.hasEvent("triggerenter")||o.rigidbody.hasEvent("triggerleave")),i=h.rigidbody&&(h.rigidbody.hasEvent("triggerenter")||h.rigidbody.hasEvent("triggerleave"));t&&(m=this._storeCollision(o,h),!m||c&Oy||o.collision.fire("triggerenter",h)),e&&(m=this._storeCollision(h,o),!m||l&Oy||h.collision.fire("triggerenter",o)),s&&(m||(m=this._storeCollision(h,o)),m&&o.rigidbody.fire("triggerenter",h)),i&&(m||(m=this._storeCollision(o,h)),m&&h.rigidbody.fire("triggerenter",o))}else{const t=this._hasContactEvent(o),s=this._hasContactEvent(h),i=this.hasEvent("contact");if(i||t||s){for(let n=0;n<d;n++){const a=e.getContactPoint(n),r=this._createContactPointFromAmmo(a);if(t||s){u.push(r);const t=this._createReverseContactPointFromAmmo(a);p.push(t)}if(i){const t=this._createSingleContactResult(o,h,r);this.fire("contact",t)}}if(t){const t=this._createContactResult(h,u);m=this._storeCollision(o,h),o.collision&&(o.collision.fire("contact",t),m&&o.collision.fire("collisionstart",t)),o.rigidbody&&(o.rigidbody.fire("contact",t),m&&o.rigidbody.fire("collisionstart",t))}if(s){const t=this._createContactResult(o,p);m=this._storeCollision(h,o),h.collision&&(h.collision.fire("contact",t),m&&h.collision.fire("collisionstart",t)),h.rigidbody&&(h.rigidbody.fire("contact",t),m&&h.rigidbody.fire("collisionstart",t))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(t){let e,s;const i=this.dynamicsWorld.getGravity();i.x()===this.gravity.x&&i.y()===this.gravity.y&&i.z()===this.gravity.z||(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(e=0,s=n.length;e<s;e++)n[e].updateTransform();const a=this._compounds;for(e=0,s=a.length;e<s;e++)a[e]._updateCompound();const r=this._kinematic;for(e=0,s=r.length;e<s;e++)r[e]._updateKinematic();this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);const o=this._dynamic;for(e=0,s=o.length;e<s;e++)o[e]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)}}Lg._buildAccessors(sb.prototype,hb);const cb="none",db="blend",ub=new dt;class pb extends Lg{constructor(t,e){super(t,e),this._resolution=new st(640,320),this._referenceResolution=new st(640,320),this._scaleMode=cb,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new dt,this._elements=new Set,t.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(t,e){if(!(t instanceof ld))return e;if(t.element){const s=t.element.drawOrder;t.element.drawOrder=e++,t.element._batchGroupId>=0&&s!==t.element.drawOrder&&this.system.app.batcher.markGroupDirty(t.element._batchGroupId)}t.particlesystem&&(t.particlesystem.drawOrder=e++);const s=t.children;for(let t=0;t<s.length;t++)e=this._recurseDrawOrderSync(s[t],e);return e}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){const t=this._resolution.x/this.scale,e=this._resolution.y/this.scale,s=t,i=-e;this._screenMatrix.setOrtho(0,s,i,0,1,-1),this._screenSpace||(ub.setScale(.5*t,.5*e,1),this._screenMatrix.mul2(ub,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(t,e){const s=Math.log2(t.x/e.x),i=Math.log2(t.y/e.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(t,e){this._screenSpace&&(this._resolution.set(t,e),this.resolution=this._resolution)}_bindElement(t){this._elements.add(t)}_unbindElement(t){this._elements.delete(t)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach((t=>t._onScreenRemove())),this._elements.clear(),this.off()}set resolution(t){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get resolution(){return this._resolution}set referenceResolution(t){this._referenceResolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get referenceResolution(){return this._scaleMode===cb?this._resolution:this._referenceResolution}set screenSpace(t){this._screenSpace=t,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach((t=>t._onScreenSpaceChange()))}get screenSpace(){return this._screenSpace}set scaleMode(t){t!==cb&&t!==db&&(t=cb),this._screenSpace||t===cb||(t=cb),this._scaleMode=t,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(t){this._scaleBlend=t,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach((t=>t._onScreenResize(this._resolution)))}get scaleBlend(){return this._scaleBlend}get priority(){return this._priority}set priority(t){t>255&&(t=255),this._priority=t}}class mb{constructor(){this.enabled=!0}}const fb=["enabled"];class _b extends Ig{constructor(t){super(t),this.id="screen",this.ComponentType=pb,this.DataType=mb,this.schema=fb,this.windowResolution=new st,this._drawOrderSyncQueue=new I,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(t,e,s){void 0!==e.priority&&(t.priority=e.priority),void 0!==e.screenSpace&&(t.screenSpace=e.screenSpace),t.cull=t.screenSpace,void 0!==e.scaleMode&&(t.scaleMode=e.scaleMode),void 0!==e.scaleBlend&&(t.scaleBlend=e.scaleBlend),void 0!==e.resolution&&(e.resolution instanceof st?t._resolution.copy(e.resolution):t._resolution.set(e.resolution[0],e.resolution[1]),t.resolution=t._resolution),void 0!==e.referenceResolution&&(e.referenceResolution instanceof st?t._referenceResolution.copy(e.referenceResolution):t._referenceResolution.set(e.referenceResolution[0],e.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),super.initializeComponentData(t,e,s)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(t){const e=this.store;for(const s in e)e[s].entity.screen.update&&e[s].entity.screen.update(t)}_onResize(t,e){this.windowResolution.x=t,this.windowResolution.y=e}cloneComponent(t,e){const s=t.screen;return this.addComponent(e,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(t,e){e.onRemove()}processDrawOrderSyncQueue(){const t=this._drawOrderSyncQueue.list();for(let e=0;e<t.length;e++){const s=t[e];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(t,e,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(t)||this._drawOrderSyncQueue.push(t,{callback:e,scope:s})}}Lg._buildAccessors(pb.prototype,fb);const gb=["x","y","z","w"],yb=[void 0,void 0,st,it,nt];function vb(t,e,s,i){switch(e.type){case"boolean":return!!s;case"number":if("number"==typeof s)return s;if("string"==typeof s){const t=parseInt(s,10);return isNaN(t)?null:t}return"boolean"==typeof s?0+s:null;case"json":{const i={};if(Array.isArray(e.schema)){s&&"object"==typeof s||(s={});for(let n=0;n<e.schema.length;n++){const a=e.schema[n];if(a.name)if(a.array){i[a.name]=[];const e=Array.isArray(s[a.name])?s[a.name]:[];for(let s=0;s<e.length;s++)i[a.name].push(vb(t,a,e[s]))}else{const e=s.hasOwnProperty(a.name)?s[a.name]:a.default;i[a.name]=vb(t,a,e)}}}return i}case"asset":return s instanceof wm?s:"number"==typeof s?t.assets.get(s)||null:"string"==typeof s&&t.assets.get(parseInt(s,10))||null;case"entity":return s instanceof jr?s:"string"==typeof s?t.getEntityFromIndex(s):null;case"rgb":case"rgba":if(s instanceof J)return i instanceof J?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length>=3&&s.length<=4){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;return i||(i=new J),i.r=s[0],i.g=s[1],i.b=s[2],i.a=3===s.length?1:s[3],i}return"string"==typeof s&&/#([0-9abcdef]{2}){3,4}/i.test(s)?(i||(i=new J),i.fromString(s),i):null;case"vec2":case"vec3":case"vec4":{const t=parseInt(e.type.slice(3),10),n=yb[t];if(s instanceof n)return i instanceof n?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length===t){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;i||(i=new n);for(let e=0;e<t;e++)i[gb[e]]=s[e];return i}return null}case"curve":if(s){let t;if(s instanceof tt||s instanceof et)t=s.clone();else{t=new(s.keys[0]instanceof Array?et:tt)(s.keys),t.type=s.type}return t}}return s}class xb{constructor(t){this.scriptType=t,this.index={}}add(t,e){this.index[t]||xb.reservedNames.has(t)||(this.index[t]=e,Object.defineProperty(this.scriptType.prototype,t,{get:function(){return this.__attributes[t]},set:function(s){const i="attr",n="attr:"+t,a=this.__attributes[t];let r=a;if(a&&"json"!==e.type&&a.clone&&(this._callbacks.attr||this._callbacks[n])&&(r=a.clone()),e.array){if(this.__attributes[t]=[],s)for(let i=0,n=s.length;i<n;i++)this.__attributes[t].push(vb(this.app,e,s[i],a?a[i]:null))}else this.__attributes[t]=vb(this.app,e,s,a);this.fire(i,t,this.__attributes[t],r),this.fire(n,this.__attributes[t],r)}}))}remove(t){return!!this.index[t]&&(delete this.index[t],delete this.scriptType.prototype[t],!0)}has(t){return!!this.index[t]}get(t){return this.index[t]||null}}xb.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","has","get","on","off","fire","once","hasEvent"]);class bb extends Lg{constructor(t,e){super(t,e),this._scripts=[],this._updateList=new F({sortBy:"__executionOrder"}),this._postUpdateList=new F({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const t=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,bb.scriptMethods.postInitialize))}this._endLooping(t)}_beginLooping(){const t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t}_endLooping(t){this._isLoopingThroughScripts=t,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(t,e,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const e=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e.enabled=e._enabled}this._endLooping(e)}_onBeforeRemove(){this.fire("remove");const t=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const e=this.scripts[t];e&&this.destroy(e.__scriptType.__name)}this._endLooping(t)}_removeDestroyedScripts(){const t=this._destroyedScripts.length;if(t){for(let e=0;e<t;e++){const t=this._destroyedScripts[e];this._removeScriptInstance(t)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let t=0,e=this.scripts.length;t<e;t++)this.scripts[t].__initializeAttributes()}_scriptMethod(t,e,s){t[e](s)}_onInitialize(){const t=this._scripts,e=this._beginLooping();for(let e=0,s=t.length;e<s;e++){const s=t[e];!s._initialized&&s.enabled&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,bb.scriptMethods.initialize))}this._endLooping(e)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(t){const e=this._updateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,bb.scriptMethods.update,t)}this._endLooping(s)}_onPostUpdate(t){const e=this._postUpdateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,bb.scriptMethods.postUpdate,t)}this._endLooping(s)}_insertScriptInstance(t,e,s){-1===e?(this._scripts.push(t),t.__executionOrder=s,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,s+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))}_removeScriptInstance(t){const e=this._scripts.indexOf(t);return-1===e||(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t)),e}_resetExecutionOrder(t,e){for(let s=t;s<e;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(t,e,s,i,n,a){if(t.array){const t=s.length;if(!t)return;const r=s.slice();for(let e=0;e<t;e++){const t=r[e]instanceof ld?r[e].getGuid():r[e];a[t]&&(r[e]=i?a[t].getGuid():a[t])}n[e]=r}else{if(s instanceof ld)s=s.getGuid();else if("string"!=typeof s)return;a[s]&&(n[e]=a[s])}}has(t){if("string"==typeof t)return!!this._scriptsIndex[t];if(!t)return!1;const e=t,s=e.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof e}get(t){if("string"==typeof t){const e=this._scriptsIndex[t];return e?e.instance:null}if(!t)return null;const e=t,s=e.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof e?n:null}create(t,e={}){const s=this;let i=t,n=t;if("string"==typeof i?i=this.system.app.scripts.get(i):i&&(n=i.__name),i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const t=new i({app:this.system.app,entity:this.entity,enabled:!e.hasOwnProperty("enabled")||e.enabled,attributes:e.attributes}),a=this._scripts.length;let r=-1;return"number"==typeof e.ind&&-1!==e.ind&&a>e.ind&&(r=e.ind),this._insertScriptInstance(t,r,a),this._scriptsIndex[n]={instance:t,onSwap:function(){s.swap(n)}},this[n]=t,e.preloading||t.__initializeAttributes(),this.fire("create",n,t),this.fire("create:"+n,t),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),e.preloading||(t.enabled&&!t._initialized&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,bb.scriptMethods.initialize)),t.enabled&&!t._postInitialized&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,bb.scriptMethods.postInitialize))),t}console.warn(`script '${n}' is already added to entity '${this.entity.name}'`)}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length},console.warn(`script '${n}' is not found, awaiting it to be added to registry`);return null}destroy(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(delete this._scriptsIndex[e],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const t=this._removeScriptInstance(n);t>=0&&this._resetExecutionOrder(t,this._scripts.length)}return this.system.app.scripts.off("swap:"+e,i.onSwap),delete this[e],this.fire("destroy",e,n||null),this.fire("destroy:"+e,n||null),n&&n.fire("destroy"),!0}swap(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(!i||!i.instance)return!1;const n=i.instance,a=this._scripts.indexOf(n),r=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return!!r.swap&&(r.__initializeAttributes(),this._scripts[a]=r,this._scriptsIndex[e].instance=r,this[e]=r,r.__executionOrder=a,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),r.update&&this._updateList.insert(r),r.postUpdate&&this._postUpdateList.insert(r),this._scriptMethod(r,bb.scriptMethods.swap,n),this.fire("swap",e,r),this.fire("swap:"+e,r),!0)}resolveDuplicatedEntityReferenceProperties(t,e){const s=this.entity.script;for(const i in t._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const a=t._scriptsIndex[i];if(!a||!a.instance)continue;const r=s[i].__attributesRaw,o=s[i].__attributes;if(!r&&!o)continue;const h=!!r,l=a.instance.__attributes;for(const t in l){if(!l[t])continue;const s=n.attributes.get(t);if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,t,l[t],h,r||o,e);else if("json"===s.type&&Array.isArray(s.schema)){const i=l[t],n=r?r[t]:o[t];for(let t=0;t<s.schema.length;t++){const a=s.schema[t];if("entity"===a.type)if(s.array)for(let t=0;t<i.length;t++)this._resolveEntityScriptAttribute(a,a.name,i[t][a.name],h,n[t],e);else this._resolveEntityScriptAttribute(a,a.name,i[a.name],h,n,e)}}}}}move(t,e){const s=this._scripts.length;if(e>=s||e<0)return!1;let i=t,n=t;"string"!=typeof n?n=t.__name:i=null;const a=this._scriptsIndex[n];if(!a||!a.instance)return!1;const r=a.instance;if(i&&!(r instanceof i))return!1;const o=this._scripts.indexOf(r);return-1!==o&&o!==e&&(this._scripts.splice(e,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,r,e,o),this.fire("move:"+n,r,e,o),!0)}get enabled(){return this._enabled}set enabled(t){const e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}get scripts(){return this._scripts}set scripts(t){this._scriptsData=t;for(const e in t){if(!t.hasOwnProperty(e))continue;const s=this._scriptsIndex[e];if(s){if("boolean"==typeof t[e].enabled&&(s.enabled=!!t[e].enabled),"object"==typeof t[e].attributes)for(const i in t[e].attributes)if(!xb.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const t=this.system.app.scripts.get(e);t&&t.attributes.add(i,{})}s[i]=t[e].attributes[i]}}else console.log(this.order)}}}bb.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};class Sb{constructor(){this.enabled=!0}}let wb=0;class Mb extends Ig{constructor(t){super(t),this.id="script",this.ComponentType=bb,this.DataType=Sb,this._components=new F({sortBy:"_executionOrder"}),this._enabledComponents=new F({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e){if(t._executionOrder=wb++,this._components.append(t),wb>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,t.enabled&&t.entity.enabled&&this._enabledComponents.append(t),e.hasOwnProperty("order")&&e.hasOwnProperty("scripts")){t._scriptsData=e.scripts;for(let s=0;s<e.order.length;s++)t.create(e.order[s],{enabled:e.scripts[e.order[s]].enabled,attributes:e.scripts[e.order[s]].attributes,preloading:this.preloading})}}cloneComponent(t,e){const s=[],i={};for(let e=0;e<t.script._scripts.length;e++){const n=t.script._scripts[e],a=n.__scriptType.__name;s.push(a);const r={};for(const t in n.__attributes)r[t]=n.__attributes[t];i[a]={enabled:n._enabled,attributes:r}}for(const e in t.script._scriptsIndex)e.awaiting&&s.splice(e.ind,0,e);const n={enabled:t.script.enabled,order:s,scripts:i};return this.addComponent(e,n)}_resetExecutionOrder(){wb=0;for(let t=0,e=this._components.length;t<e;t++)this._components.items[t]._executionOrder=wb++}_callComponentMethod(t,e,s){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][e](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")}_onUpdate(t){this._callComponentMethod(this._enabledComponents,"_onUpdate",t)}_onPostUpdate(t){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",t)}_addComponentToEnabled(t){this._enabledComponents.insert(t)}_removeComponentFromEnabled(t){this._enabledComponents.remove(t)}_onBeforeRemove(t,e){this._components.items.indexOf(e)>=0&&e._onBeforeRemove(),this._removeComponentFromEnabled(e),this._components.remove(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class Tb extends Lg{constructor(t,e){super(t,e),this.on("set_scripts",this.onSetScripts,this)}send(t,e){const s=Array.prototype.slice.call(arguments,2),i=this.entity.script.instances;let n;if(i&&i[t]&&(n=i[t].instance[e],n))return n.apply(i[t].instance,s)}onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))}onDisable(){this.system._disableScriptComponent(this)}onSetScripts(t,e,s){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(e,s))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;const t=s.map((function(t){return t.url}));if(this._loadFromCache(t))return;this._loadScripts(t)}}_updateScriptAttributes(t,e){let s=!0;if(t.length!==e.length)s=!1;else for(let i=0,n=e.length;i<n;i++)if(t[i].url!==e[i].url){s=!1;break}if(s)for(const t in this.instances)this.instances.hasOwnProperty(t)&&this.system._updateAccessors(this.entity,this.instances[t]);return s}_loadFromCache(t){const e=[],s=this.system.app._scriptPrefix||"",i=/^http(s)?:\/\//i;for(let n=0,a=t.length;n<a;n++){let a=t[n];i.test(a)||(a=f.join(s,a));const r=this.system.app.loader.getFromCache(a,"script");if(!r)return!1;e.push(r)}for(let s=0,i=e.length;s<i;s++){const i=e[s];if(!0!==i&&(i&&this.entity.script&&!this.entity.script.instances[i._pcScriptName])){const e=new i(this.entity);this.system._preRegisterInstance(this.entity,t[s],i._pcScriptName,e)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0}_loadScripts(t){let e=t.length;const s=this.system.app._scriptPrefix||"";t.forEach((t=>{let i=null,n=null;t.toLowerCase().startsWith("http://")||t.toLowerCase().startsWith("https://")?(n=t,i=t):(n=t,i=f.join(s,t)),this.system.app.loader.load(i,"script",((t,s)=>{if(e--,t)console.error(t);else if(s&&this.entity.script&&!this.entity.script.instances[s._pcScriptName]){const t=new s(this.entity);this.system._preRegisterInstance(this.entity,n,s._pcScriptName,t)}0===e&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}))}))}}class Ab{constructor(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1}}const Cb=["enabled","scripts","instances","runInTools"];class Pb extends Ig{constructor(t){super(t),this.id="script",this.ComponentType=Tb,this.DataType=Ab,this.schema=Cb,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("postInitialize",this.onPostInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.app.systems.on("fixedUpdate",this.onFixedUpdate,this),this.app.systems.on("postUpdate",this.onPostUpdate,this),this.app.systems.on("toolsUpdate",this.onToolsUpdate,this)}initializeComponentData(t,e,s){s=["runInTools","enabled","scripts"],e.scripts&&e.scripts.length&&e.scripts.forEach((function(t){if(t.attributes&&Array.isArray(t.attributes)){const e={};for(let s=0;s<t.attributes.length;s++)e[t.attributes[s].name]=t.attributes[s];t.attributes=e}})),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=this.store[t.getGuid()],i={runInTools:s.data.runInTools,scripts:[],enabled:s.data.enabled},n=s.data.scripts;for(let t=0,e=n.length;t<e;t++){const e=n[t].attributes;e&&delete n[t].attributes,i.scripts.push(c({},n[t])),e&&(i.scripts[t].attributes=this._cloneAttributes(e),n[t].attributes=e)}return this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&this._disableScriptComponent(e),this._destroyScriptComponent(e)}onInitialize(t){if(this._registerInstances(t),t.enabled){t.script&&t.script.enabled&&this._initializeScriptComponent(t.script);const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof ld&&this.onInitialize(e[t])}}onPostInitialize(t){if(t.enabled){t.script&&t.script.enabled&&this._postInitializeScriptComponent(t.script);const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof ld&&this.onPostInitialize(e[t])}}_callInstancesMethod(t,e){const s=t.data.instances;for(const t in s)if(s.hasOwnProperty(t)){const i=s[t].instance;i[e]&&i[e]()}}_initializeScriptComponent(t){this._callInstancesMethod(t,"initialize"),t.data.initialized=!0,t.enabled&&t.entity.enabled&&this._enableScriptComponent(t)}_enableScriptComponent(t){this._callInstancesMethod(t,"onEnable")}_disableScriptComponent(t){this._callInstancesMethod(t,"onDisable")}_destroyScriptComponent(t){const e=t.data.instances;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].instance;if(i.destroy&&i.destroy(),i.update){const t=this.instancesWithUpdate.indexOf(i);t>=0&&this.instancesWithUpdate.splice(t,1)}if(i.fixedUpdate){const t=this.instancesWithFixedUpdate.indexOf(i);t>=0&&this.instancesWithFixedUpdate.splice(t,1)}if(i.postUpdate){const t=this.instancesWithPostUpdate.indexOf(i);t>=0&&this.instancesWithPostUpdate.splice(t,1)}if(i.toolsUpdate){const t=this.instancesWithToolsUpdate.indexOf(i);t>=0&&this.instancesWithToolsUpdate.splice(t,1)}t.instances[s].instance===t[s]&&delete t[s],delete t.instances[s]}}_postInitializeScriptComponent(t){this._callInstancesMethod(t,"postInitialize"),t.data.postInitialized=!0}_updateInstances(t,e,s){for(let i=0,n=e.length;i<n;i++){const n=e[i];n&&n.entity&&n.entity.enabled&&n.entity.script.enabled&&n[t](s)}}onUpdate(t){this._updateInstances("update",this.instancesWithUpdate,t)}onFixedUpdate(t){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,t)}onPostUpdate(t){this._updateInstances("postUpdate",this.instancesWithPostUpdate,t)}onToolsUpdate(t){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,t)}broadcast(t,e){const s=Array.prototype.slice.call(arguments,2),i=this.store;for(const n in i)if(i.hasOwnProperty(n)){const a=i[n].data;if(a.instances[t]){const i=a.instances[t].instance[e];i&&i.apply(a.instances[t].instance,s)}}}_preRegisterInstance(t,e,s,i){if(t.script){if(t.script.data._instances=t.script.data._instances||{},t.script.data._instances[s])throw Error(`Script name collision '${s}'. Scripts from '${e}' and '${t.script.data._instances[s].url}' {${t.getGuid()}}`);t.script.data._instances[s]={url:e,name:s,instance:i}}}_registerInstances(t){if(t.script&&t.script.data._instances){t.script.instances=t.script.data._instances;for(const e in t.script.instances){const s=t.script.instances[e],i=s.instance;if(p.attach(i),i.update&&this.instancesWithUpdate.push(i),i.fixedUpdate&&this.instancesWithFixedUpdate.push(i),i.postUpdate&&this.instancesWithPostUpdate.push(i),i.toolsUpdate&&this.instancesWithToolsUpdate.push(i),t.script.scripts&&this._createAccessors(t,s),t.script[e])throw Error(`Script with name '${e}' is already attached to Script Component`);t.script[e]=i}delete t.script.data._instances}const e=t._children;for(let t=0,s=e.length;t<s;t++)e[t]instanceof ld&&this._registerInstances(e[t])}_cloneAttributes(t){const e={};for(const s in t)if(t.hasOwnProperty(s))if("entity"!==t[s].type)e[s]=c({},t[s]);else{const i=t[s].value;delete t[s].value,e[s]=c({},t[s]),e[s].value=i,t[s].value=i}return e}_createAccessors(t,e){const s=t.script.scripts.length,i=e.url;for(let n=0;n<s;n++){const s=t.script.scripts[n];if(s.url===i){const i=s.attributes;if(s.name&&i){for(const t in i)i.hasOwnProperty(t)&&this._createAccessor(i[t],e);t.script.data.attributes[s.name]=this._cloneAttributes(i)}break}}}_createAccessor(t,e){const s=this;t={name:t.name,value:t.value,type:t.type},this._convertAttributeValue(t),Object.defineProperty(e.instance,t.name,{get:function(){return t.value},set:function(i){const n=t.value;t.value=i,s._convertAttributeValue(t),e.instance.fire("set",t.name,n,t.value)},configurable:!0})}_updateAccessors(t,e){const s=t.script.scripts.length,i=e.url;for(let n=0;n<s;n++){const s=t.script,a=s.scripts[n];if(a.url===i){const t=a.name,i=a.attributes;if(t){if(i)for(const t in i)i.hasOwnProperty(t)&&this._createAccessor(i[t],e);const n=s.data.attributes[t];if(n)for(const t in n){const s=n[t];t in i?i[t].value!==s.value&&e.instance.onAttributeChanged&&e.instance.onAttributeChanged(s.name,s.value,i[t].value):delete e.instance[s.name]}i?s.data.attributes[t]=this._cloneAttributes(i):delete s.data.attributes[t]}break}}}_convertAttributeValue(t){if("rgb"===t.type||"rgba"===t.type)Array.isArray(t.value)&&(t.value=3===t.value.length?new J(t.value[0],t.value[1],t.value[2]):new J(t.value[0],t.value[1],t.value[2],t.value[3]));else if("vec2"===t.type)Array.isArray(t.value)&&(t.value=new st(t.value[0],t.value[1]));else if("vec3"===t.type||"vector"===t.type)Array.isArray(t.value)&&(t.value=new it(t.value[0],t.value[1],t.value[2]));else if("vec4"===t.type)Array.isArray(t.value)&&(t.value=new nt(t.value[0],t.value[1],t.value[2],t.value[3]));else if("entity"===t.type)null!==t.value&&"string"==typeof t.value&&(t.value=this.app.root.findByGuid(t.value));else if("curve"===t.type||"colorcurve"===t.type){const e=t.value.keys[0]instanceof Array?et:tt;t.value=new e(t.value.keys),t.value.type=t.value.type}}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("postInitialize",this.onPostInitialize,this),this.app.systems.off("update",this.onUpdate,this),this.app.systems.off("fixedUpdate",this.onFixedUpdate,this),this.app.systems.off("postUpdate",this.onPostUpdate,this),this.app.systems.off("toolsUpdate",this.onToolsUpdate,this)}}Lg._buildAccessors(Tb.prototype,Cb);const Rb=new st,Eb=new it,Lb=new it,Ib=new it,Db=new it,Fb=new it,Ob=new ft,kb={x:"y",y:"x"};class Bb extends u{constructor(t,e){if(super(),!(t&&t instanceof kv))throw new Error("Element was null or not an ElementComponent");if(e&&"x"!==e&&"y"!==e)throw new Error("Unrecognized axis: "+e);this._element=t,this._app=t.system.app,this._axis=e||null,this._enabled=!0,this._dragScale=new it,this._dragStartMousePosition=new it,this._dragStartHandlePosition=new it,this._deltaMousePosition=new it,this._deltaHandlePosition=new it,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(t){this._element[t]("mousedown",this._onMouseDownOrTouchStart,this),this._element[t]("touchstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(t){const s="on"===t,i=s?"addEventListener":"removeEventListener";this._hasDragListeners&&s||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[t]("mousemove",this._onMove,this),e.polyfill.window[i]("mouseup",this._handleMouseUpOrTouchEnd,!1)),C.touch&&(this._app.touch[t]("touchmove",this._onMove,this),e.polyfill.window[i]("touchend",this._handleMouseUpOrTouchEnd,!1),e.polyfill.window[i]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=s)}_onMouseDownOrTouchStart(t){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=t.camera,this._calculateDragScale();const e=this._screenToLocal(t);e&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(e),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(t){this._determineInputPosition(t),this._chooseRayOriginAndDirection(),Db.copy(this._element.entity.getPosition()),Fb.copy(this._element.entity.forward).mulScalar(-1);const e=Fb.dot(Ib);if(Math.abs(e)>0){const t=Db.sub(Lb).dot(Fb)/e,s=Lb.add(Ib.mulScalar(t));return Ob.copy(this._element.entity.getRotation()).invert().transformVector(s,s),s.mul(this._dragScale),s}return null}_determineInputPosition(t){const e=this._app.graphicsDevice.maxPixelRatio;void 0!==t.x&&void 0!==t.y?(Rb.x=t.x*e,Rb.y=t.y*e):t.changedTouches?(Rb.x=t.changedTouches[0].x*e,Rb.y=t.changedTouches[0].y*e):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(Lb.set(Rb.x,-Rb.y,0),Ib.set(0,0,-1)):(Eb.copy(this._dragCamera.screenToWorld(Rb.x,Rb.y,1)),Lb.copy(this._dragCamera.entity.getPosition()),Ib.copy(Eb).sub(Lb).normalize())}_calculateDragScale(){let t=this._element.entity.parent;const e=this._element.screen&&this._element.screen.screen,s=e&&e.screenSpace,i=s?e.scale:1,n=this._dragScale;for(n.set(i,i,i);t&&(n.mul(t.getLocalScale()),t=t.parent,!s||!t.screen););n.x=1/n.x,n.y=1/n.y,n.z=1/n.z}_onMove(t){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled){const e=this._screenToLocal(t);if(this._dragStartMousePosition&&e){if(this._deltaMousePosition.copy(e).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){const t=this._element.entity.getLocalPosition(),e=kb[this._axis];this._deltaHandlePosition[e]=t[e]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}get enabled(){return this._enabled}set enabled(t){this._enabled=t}get isDragging(){return this._isDragging}}const zb=0,Ub=1,Vb=2,Nb=0,Wb=1,Gb="mousedown",Hb="mousemove",jb="mouseup",qb="mousewheel",Xb=-1,Yb=new st;class Kb extends Lg{constructor(t,e){super(t,e),this._viewportReference=new iy(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new iy(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[Is]=new iy(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[Ds]=new iy(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[Is]=null,this._prevContentSizes[Ds]=null,this._scroll=new st,this._velocity=new it,this._dragStartPosition=new it,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",t),this._toggleElementListeners("on")}_toggleLifecycleListeners(t,e){this[t]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[t]("set_vertical",this._onSetVerticalScrollingEnabled,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(t){if(this.entity.element){if("on"===t&&this._hasElementListeners)return;this.entity.element[t]("resize",this._onSetContentOrViewportSize,this),this.entity.element[t](qb,this._onMouseWheel,this),this._hasElementListeners="on"===t}}_onElementComponentAdd(t){this.entity===t&&this._toggleElementListeners("on")}_onElementComponentRemove(t){this.entity===t&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new Bb(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[Is]=null,this._prevContentSizes[Ds]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(t){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(t),this._setVelocityFromContentPositionDelta(t),!this._disabledContentInput)){const e=t.x-this._dragStartPosition.x,s=t.y-this._dragStartPosition.y;(Math.abs(e)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(t){!this._scrollbarUpdateFlags[Is]&&this.enabled&&this.entity.enabled&&this._onSetScroll(t,null)}_onSetVerticalScrollbarValue(t){!this._scrollbarUpdateFlags[Ds]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,t)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(Is)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(Ds)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(Is),this._syncScrollbarPosition(Is)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(Ds),this._syncScrollbarPosition(Ds)}_onSetScroll(t,e,s){!1!==s&&this._velocity.set(0,0,0);let i=!1;i|=this._updateAxis(t,"x",Is),i|=this._updateAxis(e,"y",Ds),i&&this.fire("set:scroll",this._scroll)}_updateAxis(t,e,s){const i=null!==t&&Math.abs(t-this._scroll[e])>1e-5;return(i||this._isDragging()||0===t)&&(this._scroll[e]=this._determineNewScrollValue(t,e,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(t,e,s){if(!this._getScrollingEnabled(s))return this._scroll[e];switch(this.scrollMode){case zb:return V.clamp(t,0,this._getMaxScrollValue(s));case Ub:return this._setVelocityFromOvershoot(t,e,s),t;case Vb:return t;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),t}}_syncAll(){this._syncContentPosition(Is),this._syncContentPosition(Ds),this._syncScrollbarPosition(Is),this._syncScrollbarPosition(Ds),this._syncScrollbarEnabledState(Is),this._syncScrollbarEnabledState(Ds)}_syncContentPosition(t){const e=this._getAxis(t),s=this._getSign(t),i=this._contentReference.entity;if(i){const n=this._prevContentSizes[t],a=this._getContentSize(t);if(null!==n&&Math.abs(n-a)>1e-4){const s=this._getMaxOffset(t,n),i=this._getMaxOffset(t,a);this._scroll[e]=0===i?1:V.clamp(this._scroll[e]*s/i,0,1)}const r=this._scroll[e]*this._getMaxOffset(t),o=i.getLocalPosition();o[e]=r*s,i.setLocalPosition(o),this._prevContentSizes[t]=a}}_syncScrollbarPosition(t){const e=this._getAxis(t),s=this._scrollbarReferences[t].entity;s&&s.scrollbar&&(this._scrollbarUpdateFlags[t]=!0,s.scrollbar.value=this._scroll[e],s.scrollbar.handleSize=this._getScrollbarHandleSize(e,t),this._scrollbarUpdateFlags[t]=!1)}_syncScrollbarEnabledState(t){const e=this._scrollbarReferences[t].entity;if(e){const s=this._getScrollingEnabled(t),i=this._getScrollbarVisibility(t);switch(i){case Nb:return void(e.enabled=s);case Wb:return void(e.enabled=s&&this._contentIsLargerThanViewport(t));default:console.warn("Unhandled scrollbar visibility:"+i),e.enabled=s}}}_contentIsLargerThanViewport(t){return this._getContentSize(t)>this._getViewportSize(t)}_contentPositionToScrollValue(t){const e=this._getMaxOffset(Is),s=this._getMaxOffset(Ds);return Yb.x=0===e?0:t.x/e,Yb.y=0===s?0:t.y/-s,Yb}_getMaxOffset(t,e){e=void 0===e?this._getContentSize(t):e;const s=this._getViewportSize(t);return e<s?-this._getViewportSize(t):s-e}_getMaxScrollValue(t){return this._contentIsLargerThanViewport(t)?1:0}_getScrollbarHandleSize(t,e){const s=this._getViewportSize(e),i=this._getContentSize(e);if(Math.abs(i)<.001)return 1;const n=Math.min(s/i,1),a=this._toOvershoot(this._scroll[t],e);return 0===a?n:n/(1+Math.abs(a))}_getViewportSize(t){return this._getSize(t,this._viewportReference)}_getContentSize(t){return this._getSize(t,this._contentReference)}_getSize(t,e){return e.entity&&e.entity.element?e.entity.element[this._getCalculatedDimension(t)]:0}_getScrollingEnabled(t){return t===Is?this.horizontal:t===Ds?this.vertical:void console.warn("Unrecognized orientation: "+t)}_getScrollbarVisibility(t){return t===Is?this.horizontalScrollbarVisibility:t===Ds?this.verticalScrollbarVisibility:void console.warn("Unrecognized orientation: "+t)}_getSign(t){return t===Is?1:-1}_getAxis(t){return t===Is?"x":"y"}_getCalculatedDimension(t){return t===Is?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(Is),this._syncScrollbarEnabledState(Ds))}_updateVelocity(){if(!this._isDragging()){if(this.scrollMode===Ub&&(this._hasOvershoot("x",Is)&&this._setVelocityFromOvershoot(this.scroll.x,"x",Is),this._hasOvershoot("y",Ds)&&this._setVelocityFromOvershoot(this.scroll.y,"y",Ds)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const t=this._contentReference.entity.getLocalPosition();t.x+=this._velocity.x,t.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(t),this._setScrollFromContentPosition(t)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(t,e){return Math.abs(this._toOvershoot(this.scroll[t],e))>.001}_toOvershoot(t,e){const s=this._getMaxScrollValue(e);return t<0?t:t>s?t-s:0}_setVelocityFromOvershoot(t,e,s){const i=this._toOvershoot(t,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(i)>0&&(this._velocity[e]=-i/(50*this.bounceAmount+1))}_setVelocityFromContentPositionDelta(t){this._prevContentDragPosition?(this._velocity.sub2(t,this._prevContentDragPosition),this._prevContentDragPosition.copy(t)):(this._velocity.set(0,0,0),this._prevContentDragPosition=t.clone())}_setScrollFromContentPosition(t){let e=this._contentPositionToScrollValue(t);this._isDragging()&&(e=this._applyScrollValueTension(e)),this._onSetScroll(e.x,e.y,!1)}_applyScrollValueTension(t){let e=this._getMaxScrollValue(Is),s=this._toOvershoot(t.x,Is);return s>0?t.x=e+1*Math.log10(1+s):s<0&&(t.x=-1*Math.log10(1-s)),e=this._getMaxScrollValue(Ds),s=this._toOvershoot(t.y,Ds),s>0?t.y=e+1*Math.log10(1+s):s<0&&(t.y=-1*Math.log10(1-s)),t}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(t){this._scrollbarReferences[Is].hasComponent("scrollbar")&&(this._scrollbarReferences[Is].entity.scrollbar.enabled=t),this._scrollbarReferences[Ds].hasComponent("scrollbar")&&(this._scrollbarReferences[Ds].entity.scrollbar.enabled=t)}_setContentDraggingEnabled(t){this._contentDragHelper&&(this._contentDragHelper.enabled=t)}_onMouseWheel(t){if(this.useMouseWheel){const e=t.event,s=e.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=e.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,n=V.clamp(this._scroll.x+s,0,this._getMaxScrollValue(Is)),a=V.clamp(this._scroll.y+i,0,this._getMaxScrollValue(Ds));this.scroll=new st(n,a)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const t=this._disabledContentInputEntities.pop();t.element&&(t.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const t=e=>{e.element&&e.element.useInput&&(this._disabledContentInputEntities.push(e),e.element.useInput=!1);const s=e.children;for(let e=0,i=s.length;e<i;e++)t(s[e])},e=this._contentReference.entity;if(e){const s=e.children;for(let e=0,i=s.length;e<i;e++)t(s[e])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[Is].onParentComponentEnable(),this._scrollbarReferences[Ds].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}get scroll(){return this._scroll}set scroll(t){this._onSetScroll(t.x,t.y)}}class $b{constructor(){this.enabled=!0}}const Zb=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}];class Jb extends Ig{constructor(t){super(t),this.id="scrollview",this.ComponentType=Kb,this.DataType=$b,this.schema=Zb,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){void 0===e.dragThreshold&&(e.dragThreshold=10),void 0===e.useMouseWheel&&(e.useMouseWheel=!0),void 0===e.mouseWheelSensitivity&&(e.mouseWheelSensitivity=new st(1,1)),super.initializeComponentData(t,e,Zb)}onUpdate(t){const e=this.store;for(const t in e){const s=e[t].entity,i=s.scrollview;i.enabled&&s.enabled&&i.onUpdate()}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}Lg._buildAccessors(Kb.prototype,Zb);class Qb extends Lg{constructor(t,e){super(t,e),this._app=t.app,this._handleReference=new iy(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(t){this[t]("set_value",this._onSetValue,this),this[t]("set_handleSize",this._onSetHandleSize,this),this[t]("set_orientation",this._onSetOrientation,this)}_onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new Bb(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._destroyDragHelper()}_onHandleDrag(t){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(t[this._getAxis()]))}_onSetValue(t,e,s){Math.abs(s-e)>1e-5&&(this.data.value=V.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(t,e,s){Math.abs(s-e)>1e-5&&(this.data.handleSize=V.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(t,e,s){s!==e&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const t=this._handleReference.entity,e=t&&t.element;if(t){const e=t.getLocalPosition();e[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(e)}e&&(e[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(t){return t*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(t){return t*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?this.orientation===Is?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return this.orientation===Is?1:-1}_getAxis(){return this.orientation===Is?"x":"y"}_getDimension(){return this.orientation===Is?"width":"height"}_getOppositeDimension(){return this.orientation===Is?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(t){this._handleDragHelper&&(this._handleDragHelper.enabled=t)}onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}class tS{constructor(){this.enabled=!0}}const eS=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];class sS extends Ig{constructor(t){super(t),this.id="scrollbar",this.ComponentType=Qb,this.DataType=tS,this.schema=eS,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,eS)}_onRemoveComponent(t,e){e.onRemove()}}Lg._buildAccessors(Qb.prototype,eS);const iS={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new it,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class nS extends u{constructor(t,e="Untitled",s={}){super(),this._component=t,this._assets=t.system.app.assets,this._manager=t.system.manager,this.name=e,this._volume=void 0!==s.volume?V.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof wm&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this),this.instances=[]}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const t=this._createInstance();if(this.instances.push(t),this.isLoaded)t.play();else{const e=function(e){const s=t._playWhenLoaded;t.sound=e,s&&t.play()};this.off("load",e),this.once("load",e),this.load()}return t}pause(){let t=!1;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].pause()&&(t=!0);return t}resume(){let t=!1;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].resume()&&(t=!0);return t}stop(){let t=!1;const e=this.instances;let s=e.length;for(;s--;)e[s].stop(),t=!0;return e.length=0,t}load(){if(!this._hasAsset())return;const t=this._assets.get(this._asset);return t?(t.off("remove",this._onAssetRemoved,this),t.on("remove",this._onAssetRemoved,this),t.resource?void this.fire("load",t.resource):(t.off("load",this._onAssetLoad,this),t.once("load",this._onAssetLoad,this),void this._assets.load(t))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this))}setExternalNodes(t,e){if(t){if(e||(e=t),this._firstNode=t,this._lastNode=e,!this._overlap){const s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(t,e)}}else console.error("The firstNode must have a valid AudioNode")}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return null!=this._asset}_createInstance(){let t=null;const e=this._component;let s=null;if(this._hasAsset()){const t=this._assets.get(this._asset);t&&(s=t.resource)}const i=iS;return i.volume=this._volume*e.volume,i.pitch=this._pitch*e.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,e.positional?(i.position.copy(e.entity.getPosition()),i.maxDistance=e.maxDistance,i.refDistance=e.refDistance,i.rollOffFactor=e.rollOffFactor,i.distanceModel=e.distanceModel,t=new Yp(this._manager,s,i)):t=new Xp(this._manager,s,i),this._firstNode&&t.setExternalNodes(this._firstNode,this._lastNode),t}_onInstancePlay(t){this.fire("play",t),this._component.fire("play",this,t)}_onInstancePause(t){this.fire("pause",t),this._component.fire("pause",this,t)}_onInstanceResume(t){this.fire("resume",t),this._component.fire("resume",this,t)}_onInstanceStop(t){const e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("stop",t),this._component.fire("stop",this,t)}_onInstanceEnd(t){const e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("end",t),this._component.fire("end",this,t)}_onAssetAdd(t){this.load()}_onAssetLoad(t){this.load()}_onAssetRemoved(t){t.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+t.id,this._onAssetAdd,this),this.stop()}updatePosition(t){const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].position=t}get volume(){return this._volume}set volume(t){if(this._volume=V.clamp(Number(t)||0,0,1),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].volume=this._volume*this._component.volume}}get pitch(){return this._pitch}set pitch(t){if(this._pitch=Math.max(Number(t)||0,.01),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].pitch=this.pitch*this._component.pitch}}get loop(){return this._loop}set loop(t){this._loop=!!t;const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].loop=this._loop}get autoPlay(){return this._autoPlay}set autoPlay(t){this._autoPlay=!!t}get overlap(){return this._overlap}set overlap(t){this._overlap=!!t}get startTime(){return this._startTime}set startTime(t){if(this._startTime=Math.max(0,Number(t)||0),!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].startTime=this._startTime}}get duration(){let t=0;if(this._hasAsset()){const e=this._assets.get(this._asset);t=e.resource?e.resource.duration:0}return null!=this._duration?this._duration%(t||1):t}set duration(t){if(this._duration=Math.max(0,Number(t)||0)||null,!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].duration=this._duration}}get asset(){return this._asset}set asset(t){const e=this._asset;if(e){this._assets.off("add:"+e,this._onAssetAdd,this);const t=this._assets.get(e);t&&t.off("remove",this._onAssetRemoved,this)}this._asset=t,this._asset instanceof wm&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get isLoaded(){if(this._hasAsset()){const t=this._assets.get(this._asset);if(t)return!!t.resource}return!1}get isPlaying(){const t=this.instances;for(let e=0,s=t.length;e<s;e++)if(t[e].isPlaying)return!0;return!1}get isPaused(){const t=this.instances,e=t.length;if(0===e)return!1;for(let s=0;s<e;s++)if(!t[s].isPaused)return!1;return!0}get isStopped(){const t=this.instances;for(let e=0,s=t.length;e<s;e++)if(!t[e].isStopped)return!1;return!0}}class aS extends Lg{constructor(t,e){super(t,e),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=Bp,this._slots={},this._playingBeforeDisable={}}get positional(){return this._positional}set positional(t){this._positional=t;const e=this._slots;for(const t in e){const s=e[t];if(!s.overlap){const t=s.instances;for(let e=t.length-1;e>=0;e--){const i=t[e].isPlaying||t[e].isSuspended,n=t[e].currentTime;i&&t[e].stop();const a=s._createInstance();i&&(a.play(),a.currentTime=n),t.push(a)}}}}get slots(){return this._slots}set slots(t){const e=this._slots;if(e)for(const t in e)e[t].stop();const s={};for(const e in t)t[e]instanceof nS?s[t[e].name]=t[e]:t[e].name&&(s[t[e].name]=new nS(this,t[e].name,t[e]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}onEnable(){if(this.system._inTools)return;const t=this._slots,e=this._playingBeforeDisable;for(const s in t){const i=t[s];i.autoPlay&&i.isStopped?i.play():e[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const t=this._slots,e={};for(const s in t)t[s].overlap||t[s].isPlaying&&(t[s].pause(),e[s]=!0);this._playingBeforeDisable=e}onRemove(){this.off()}addSlot(t,e){const s=this._slots;if(s[t])return null;const i=new nS(this,t,e);return s[t]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(t){const e=this._slots;e[t]&&(e[t].stop(),delete e[t])}slot(t){return this._slots[t]}play(t){if(!this.enabled||!this.entity.enabled)return null;const e=this._slots[t];return e?e.play():null}pause(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.pause()}else for(const t in e)e[t].pause()}resume(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.isPaused&&s.resume()}else for(const t in e)e[t].resume()}stop(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.stop()}else for(const t in e)e[t].stop()}}function rS(t,e){Object.defineProperty(aS.prototype,t,{get:function(){return this[e]},set:function(s){this[e]=s;const i=this._slots;for(const e in i){const n=i[e];if(!n.overlap){const e=n.instances;for(let i=0,n=e.length;i<n;i++)e[i][t]=s}}}})}function oS(t,e){Object.defineProperty(aS.prototype,t,{get:function(){return this[e]},set:function(s){this[e]=s;const i=this._slots;for(const e in i){const n=i[e];if(!n.overlap){const e=n.instances;for(let i=0,a=e.length;i<a;i++)e[i][t]=n[t]*s}}}})}oS("pitch","_pitch"),oS("volume","_volume"),rS("refDistance","_refDistance"),rS("maxDistance","_maxDistance"),rS("rollOffFactor","_rollOffFactor"),rS("distanceModel","_distanceModel");class hS{constructor(){this.enabled=!0}}const lS=["enabled"];class cS extends Ig{constructor(t,e){super(t),this.id="sound",this.ComponentType=aS,this.DataType=hS,this.schema=lS,this.manager=e,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}initializeComponentData(t,e,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)e.hasOwnProperty(s[i])&&(t[s[i]]=e[s[i]]);super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.sound,i=s.slots,n={};for(const t in i){const e=i[t];n[t]={name:e.name,volume:e.volume,pitch:e.pitch,loop:e.loop,duration:e.duration,startTime:e.startTime,overlap:e.overlap,autoPlay:e.autoPlay,asset:e.asset}}const a={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(e,a)}onUpdate(t){const e=this.store;for(const t in e)if(e.hasOwnProperty(t)){const s=e[t].entity;if(s.enabled){const t=s.sound;if(t.enabled&&t.positional){const e=s.getPosition(),i=t.slots;for(const t in i)i[t].updatePosition(e)}}}}onBeforeRemove(t,e){const s=e.slots;for(const t in s)s[t].overlap||s[t].stop();e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}get volume(){return this.manager.volume}set volume(t){this.manager.volume=t}get context(){return Vp()?this.manager.context:null}}Lg._buildAccessors(aS.prototype,lS);const dS="simple",uS="animated";class pS extends u{constructor(t,e){super(),this._component=t,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=e.spriteAsset,this.name=e.name,this.fps=e.fps||0,this.loop=e.loop||!1,this._playing=!1,this._paused=!1,this._time=0}_onSpriteAssetAdded(t){this._component.system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)}_bindSpriteAsset(t){t.on("load",this._onSpriteAssetLoad,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._component.system.app.assets.load(t)}_unbindSpriteAsset(t){t.off("load",this._onSpriteAssetLoad,this),t.off("remove",this._onSpriteAssetRemove,this),t.resource&&t.resource.atlas&&this._component.system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(t){if(t.resource)if(t.resource.atlas)this.sprite=t.resource;else{const e=t.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+e,this._onTextureAtlasLoad,this),s.once("load:"+e,this._onTextureAtlasLoad,this)}else this.sprite=null}_onTextureAtlasLoad(t){const e=this._spriteAsset;e instanceof wm?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._component.system.app.assets.get(e))}_onSpriteAssetRemove(t){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&this.sprite.renderMode!==ps&&this._component._showFrame(this.frame)}_update(t){if(0===this.fps)return;if(!this._playing||this._paused||!this._sprite)return;const e=this.fps<0?-1:1,s=this._time+t*this._component.speed*e,i=this.duration,n=s>i||s<0;this._setTime(s);let a=this.frame;a=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0,a!==this._frame&&this._setFrame(a),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(t){this._time=t;const e=this.duration;this._time<0?this.loop?this._time=this._time%e+e:this._time=0:this._time>e&&(this.loop?this._time%=e:this._time=e)}_setFrame(t){this._sprite?this._frame=V.clamp(t,0,this._sprite.frameKeys.length-1):this._frame=t,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}get spriteAsset(){return this._spriteAsset}set spriteAsset(t){const e=this._component.system.app.assets;let s=t;if(t instanceof wm&&(s=t.id),this._spriteAsset!==s){if(this._spriteAsset){const t=e.get(this._spriteAsset);t&&this._unbindSpriteAsset(t)}if(this._spriteAsset=s,this._spriteAsset){const t=e.get(this._spriteAsset);t?this._bindSpriteAsset(t):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}get sprite(){return this._sprite}set sprite(t){if(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=t,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let e;t&&t.atlas?(t.atlas.texture&&(e=this._component._meshInstance,e&&(e.setParameter("texture_emissiveMap",t.atlas.texture),e.setParameter("texture_opacityMap",t.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):(e=this._component._meshInstance,e&&(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap")),this._component._hideModel())}}get frame(){return this._frame}set frame(t){this._setFrame(t);const e=this.fps||Number.MIN_VALUE;this._setTime(this._frame/e)}get isPlaying(){return this._playing}get isPaused(){return this._paused}get duration(){if(this._sprite){const t=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(t)}return 0}get time(){return this._time}set time(t){this._setTime(t),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}}class mS extends Lg{constructor(t,e){super(t,e),this._type=dS,this._material=t.defaultMaterial,this._color=new J(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[Wt],this._outerScale=new st(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new nt,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new nt,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new jr,this._model=new vd,this._model.graph=this._node,this._meshInstance=null,e.addChild(this._model.graph),this._model._entity=e,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new pS(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}onEnable(){const t=this.system.app,e=t.scene;e.on("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.on("add",this._onLayerAdded,this),e.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&t.batcher.insert(tl.SPRITE,this._batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.off("add",this._onLayerAdded,this),e.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0&&t.batcher.remove(tl.SPRITE,this._batchGroupId,this.entity)}onDestroy(){this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const t in this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel)return;if(!this._meshInstance)return;const t=[this._meshInstance];for(let e=0,s=this._layers.length;e<s;e++){const s=this.system.app.scene.layers.getLayerById(this._layers[e]);s&&s.addMeshInstances(t)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const t=[this._meshInstance];for(let e=0,s=this._layers.length;e<s;e++){const s=this.system.app.scene.layers.getLayerById(this._layers[e]);s&&s.removeMeshInstances(t)}this._addedModel=!1}_showFrame(t){if(!this.sprite)return;const e=this.sprite.meshes[t];if(!e)return void(this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1));let s;if(s=this.sprite.renderMode===ms?this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===fs?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new dl(e,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==e&&(this._meshInstance.mesh=e,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap")),!this.sprite.atlas||this.sprite.renderMode!==ms&&this.sprite.renderMode!==fs)this._meshInstance._updateAabbFunc=null;else{this._meshInstance._updateAabbFunc=this._updateAabbFunc;const e=this.sprite.atlas.frames[this.sprite.frameKeys[t]];if(e){const t=2/e.rect.z,s=2/e.rect.w;this._innerOffset.set(e.border.x*t,e.border.y*s,e.border.z*t,e.border.w*s);const i=this.sprite.atlas.texture;this._atlasRect.set(e.rect.x/i.width,e.rect.y/i.height,e.rect.z/i.width,e.rect.w/i.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)}this._updateTransform()}_updateTransform(){let t=this.flipX?-1:1,e=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(this.sprite.renderMode===ms||this.sprite.renderMode===fs)){let n=1,a=1;if(this.sprite.atlas){const t=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];t&&(n=t.rect.z,a=t.rect.w,s=(.5-t.pivot.x)*this._width,i=(.5-t.pivot.y)*this._height)}const r=n/this.sprite.pixelsPerUnit,o=a/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*r),Math.max(this._height,this._innerOffset.y*o)),t*=r,e*=o,this._outerScale.x/=r,this._outerScale.y/=o,t*=V.clamp(this._width/(this._innerOffset.x*r),1e-4,1),e*=V.clamp(this._height/(this._innerOffset.y*o),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(t,e,1),this._node.setLocalPosition(s,i,0)}_updateAabb(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._node.getWorldTransform()),t}_tryAutoPlay(){if(!this._autoPlayClip)return;if(this.type!==uS)return;const t=this._clips[this._autoPlayClip];!t||t.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(t.name)}_onLayersChanged(t,e){t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(t){this.layers.indexOf(t.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&t.addMeshInstances([this._meshInstance])}_onLayerRemoved(t){if(!this._meshInstance)return;this.layers.indexOf(t.id)<0||t.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeMeshInstances([this._meshInstance])}}addClip(t){const e=new pS(this,{name:t.name,fps:t.fps,loop:t.loop,spriteAsset:t.spriteAsset});return this._clips[t.name]=e,e.name&&e.name===this._autoPlayClip&&this._tryAutoPlay(),e}removeClip(t){delete this._clips[t]}clip(t){return this._clips[t]}play(t){const e=this._clips[t],s=this._currentClip;return s&&s!==e&&(s._playing=!1),this._currentClip=e,this._currentClip&&(this._currentClip=e,this._currentClip.play()),e}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this._type===dS?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===uS&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get frame(){return this._currentClip.frame}set frame(t){this._currentClip.frame=t}get spriteAsset(){return this._defaultClip._spriteAsset}set spriteAsset(t){this._defaultClip.spriteAsset=t}get sprite(){return this._currentClip.sprite}set sprite(t){this._currentClip.sprite=t}get material(){return this._material}set material(t){this._material=t,this._meshInstance&&(this._meshInstance.material=t)}get color(){return this._color}set color(t){this._color.r=t.r,this._color.g=t.g,this._color.b=t.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform))}get opacity(){return this._color.a}set opacity(t){this._color.a=t,this._meshInstance&&this._meshInstance.setParameter("material_opacity",t)}get clips(){return this._clips}set clips(t){if(t){for(const e in this._clips){let s=!1;for(const i in t)if(t[i].name===e){s=!0,this._clips[e].fps=t[i].fps,this._clips[e].loop=t[i].loop,t[i].hasOwnProperty("sprite")?this._clips[e].sprite=t[i].sprite:t[i].hasOwnProperty("spriteAsset")&&(this._clips[e].spriteAsset=t[i].spriteAsset);break}s||this.removeClip(e)}for(const e in t)this._clips[t[e].name]||this.addClip(t[e]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(const t in this._clips)this.removeClip(t)}get currentClip(){return this._currentClip}get speed(){return this._speed}set speed(t){this._speed=t}get flipX(){return this._flipX}set flipX(t){this._flipX!==t&&(this._flipX=t,this._updateTransform())}get flipY(){return this._flipY}set flipY(t){this._flipY!==t&&(this._flipY=t,this._updateTransform())}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._outerScale.x=this._width,!this.sprite||this.sprite.renderMode!==fs&&this.sprite.renderMode!==ms||this._updateTransform())}get height(){return this._height}set height(t){t!==this._height&&(this._height=t,this._outerScale.y=this.height,!this.sprite||this.sprite.renderMode!==fs&&this.sprite.renderMode!==ms||this._updateTransform())}get batchGroupId(){return this._batchGroupId}set batchGroupId(t){if(this._batchGroupId===t)return;const e=this._batchGroupId;this._batchGroupId=t,this.entity.enabled&&e>=0&&this.system.app.batcher.remove(tl.SPRITE,e,this.entity),this.entity.enabled&&t>=0?this.system.app.batcher.insert(tl.SPRITE,t,this.entity):e>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get autoPlayClip(){return this._autoPlayClip}set autoPlayClip(t){this._autoPlayClip=t instanceof pS?t.name:t,this._tryAutoPlay()}get drawOrder(){return this._drawOrder}set drawOrder(t){this._drawOrder=t,this._meshInstance&&(this._meshInstance.drawOrder=t)}get layers(){return this._layers}set layers(t){this._addedModel&&this._hideModel(),this._layers=t,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}}class fS{constructor(){this.enabled=!0}}const _S=["enabled"];class gS extends Ig{constructor(t){super(t),this.id="sprite",this.ComponentType=mS,this.DataType=fS,this.schema=_S,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}get defaultMaterial(){if(!this._defaultMaterial){const t=new Mr(this.app.graphicsDevice,{width:1,height:1,format:Li}),e=new Uint8Array(t.lock());e[0]=e[1]=e[2]=e[3]=255,t.name="sprite",t.unlock();const s=new Wo;s.diffuse.set(0,0,0),s.emissive.set(.5,.5,.5),s.emissiveMap=t,s.emissiveMapTint=!0,s.opacityMap=t,s.opacityMapChannel="a",s.opacityTint=!0,s.opacity=0,s.useLighting=!1,s.useGammaTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=Rt,s.depthWrite=!1,s.pixelSnap=!1,s.cull=oi,s.update(),this._defaultTexture=t,this._defaultMaterial=s}return this._defaultMaterial}set defaultMaterial(t){this._defaultMaterial=t}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){const t=this.defaultMaterial.clone();t.nineSlicedMode=ms,t.update(),this._default9SlicedMaterialSlicedMode=t}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialSlicedMode(t){this._default9SlicedMaterialSlicedMode=t}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){const t=this.defaultMaterial.clone();t.nineSlicedMode=fs,t.update(),this._default9SlicedMaterialTiledMode=t}return this._default9SlicedMaterialTiledMode}set default9SlicedMaterialTiledMode(t){this._default9SlicedMaterialTiledMode=t}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(t,e,s){if(void 0!==e.enabled&&(t.enabled=e.enabled),t.type=e.type,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),void 0!==e.drawOrder&&(t.drawOrder=e.drawOrder),void 0!==e.color&&(e.color instanceof J?t.color.set(e.color.r,e.color.g,e.color.b,void 0!==e.opacity?e.opacity:1):t.color.set(e.color[0],e.color[1],e.color[2],void 0!==e.opacity?e.opacity:1),t.color=t.color),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.flipX&&(t.flipX=e.flipX),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.width&&(t.width=e.width),void 0!==e.height&&(t.height=e.height),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.frame&&(t.frame=e.frame),e.clips)for(const s in e.clips)t.addClip(e.clips[s]);void 0!==e.speed&&(t.speed=e.speed),e.autoPlayClip&&(t.autoPlayClip=e.autoPlayClip),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.sprite;return this.addComponent(e,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];if(i.data.enabled&&i.entity.enabled){const e=i.entity.sprite;e._currentClip&&e._currentClip._update(t)}}}onBeforeRemove(t,e){e.onDestroy()}}Lg._buildAccessors(mS.prototype,_S);class yS extends Lg{constructor(t,e){super(t,e),this._oldState=!0,this._size=new it,this.on("set_enabled",this._onSetEnabled,this)}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(t,e,s){this._checkState()}_checkState(){const t=this.enabled&&this.entity.enabled;t!==this._oldState&&(this._oldState=t,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}set size(t){t instanceof it?this._size.copy(t):t instanceof Array&&t.length>=3&&this.size.set(t[0],t[1],t[2])}get size(){return this._size}}class vS{constructor(){this.enabled=!0}}const xS=["enabled"];class bS extends Ig{constructor(t){super(t),this.id="zone",this.ComponentType=yS,this.DataType=vS,this.schema=xS,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(t,e,s){t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,e.size&&(e.size instanceof it?t.size.copy(e.size):e.size instanceof Array&&e.size.length>=3&&t.size.set(e.size[0],e.size[1],e.size[2]))}cloneComponent(t,e){const s={size:t.zone.size};return this.addComponent(e,s)}_onBeforeRemove(t,e){e._onBeforeRemove()}}Lg._buildAccessors(yS.prototype,xS);class SS{constructor(t){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,vertices:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=t._shaderStats,this.vram=t._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return Fh().scene._stats}get lightmapper(){return Fh().lightmapper.stats}get batcher(){return Fh().batcher._stats}}class wS{constructor(t,e){this.name=t,this.url=e,this.data=null,this._loading=!1,this._onLoadedCallbacks=[]}get loaded(){return!!this.data}get loading(){return this._loading}}class MS{constructor(t){this._app=t,this._list=[],this._index={},this._urlIndex={}}destroy(){this._app=null}list(){return this._list}add(t,e){if(this._index.hasOwnProperty(t))return!1;const s=new wS(t,e),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null}findByUrl(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null}remove(t){if(this._index.hasOwnProperty(t)){const e=this._index[t];let s=this._list[e];delete this._urlIndex[s.url],delete this._index[t],this._list.splice(e,1);for(let t=0;t<this._list.length;t++)s=this._list[t],this._index[s.name]=t,this._urlIndex[s.url]=t}}_loadSceneData(t,e,s){let i=t;if(t instanceof wS?i=t.url:(t=this.findByUrl(i))||(t=new wS("Untitled",i)),!t.url)return void s("URL or SceneRegistryItem is null when loading a scene");if(t.loaded)return void s(null,t);const n=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!ym.test(i)&&(i=f.join(this._app.assets.prefix,i)),t._onLoadedCallbacks.push(s),t._loading||n.load(i,(function(s,i){t.data=i,t._loading=!1;for(let e=0;e<t._onLoadedCallbacks.length;e++)t._onLoadedCallbacks[e](s,t);e||(t.data=null),t._onLoadedCallbacks.length=0})),t._loading=!0}loadSceneData(t,e){this._loadSceneData(t,!0,e)}unloadSceneData(t){"string"==typeof t&&(t=this.findByUrl(t)),t&&(t.data=null)}loadSceneHierarchy(t,e){const s=this,i=this._app.loader.getHandler("hierarchy");this._loadSceneData(t,!1,(function(t,n){if(t)return void(e&&e(t));const a=n.url,r=n.data;s._app._preloadScripts(r,(function(){s._app.systems.script.preloading=!0;const n=i.open(a,r);s._app.systems.script.preloading=!1,s._app.loader.clearCache(a,"hierarchy"),s._app.root.addChild(n),s._app.systems.fire("initialize",n),s._app.systems.fire("postInitialize",n),s._app.systems.fire("postPostInitialize",n),e&&e(t,n)}))}))}loadSceneSettings(t,e){const s=this;this._loadSceneData(t,!1,(function(t,i){t?e&&e(t):(s._app.applySceneSettings(i.data.settings),e&&e(null))}))}loadScene(t,e){const s=this,i=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!ym.test(t)&&(t=f.join(this._app.assets.prefix,t)),i.load(t,(function(n,a){if(n)e&&e(n);else{const n=function(){s._app.systems.script.preloading=!0;const n=i.open(t,a),r=s.findByUrl(t);r&&!r.loaded&&(r.data=a),s._app.systems.script.preloading=!1,s._app.loader.clearCache(t,"scene"),s._app.loader.patch({resource:n,type:"scene"},s._app.assets),s._app.root.addChild(n.root),s._app.systems.rigidbody&&"undefined"!=typeof Ammo&&s._app.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),e&&e(null,n)};s._app._preloadScripts(a,n)}}))}}class TS{constructor(t){this.application=t,this.device=t.graphicsDevice,this.clearOptions=null,this.layer=null,this.init()}allocateTexture(t,e,s){const i=new Mr(t,{format:s,width:t.width,height:t.height,mipmaps:!1,minFilter:di,magFilter:di,addressU:Ws,addressV:Ws});return i.name=e,t.scope.resolve("uDepthMap").setValue(i),i}allocateRenderTarget(t,e,s,i,n){const a=this.allocateTexture(e,s,i);return t?(t.destroyFrameBuffers(),n?t._depthBuffer=a:t._colorBuffer=a):t=new uh({colorBuffer:n?null:a,depthBuffer:n?a:null,depth:!n,stencil:e.supportsStencil,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}initWebGl2(){const t=this.application,e=this;this.clearOptions={flags:0},this.layer=new Gc({enabled:!1,name:"Depth",id:Gt,onEnable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=e.allocateRenderTarget(this.renderTarget,t.graphicsDevice,"rt-depth2",Ni,!0)},onDisable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPreRenderOpaque:function(s){const i=t.graphicsDevice.gl;this.srcFbo=i.getParameter(i.FRAMEBUFFER_BINDING),this.renderTarget.width===t.graphicsDevice.width&&this.renderTarget.height===t.graphicsDevice.height||this.onEnable(),this.oldClear=this.cameras[s].camera._clearOptions,this.cameras[s].camera._clearOptions=e.clearOptions},onPostRenderOpaque:function(e){if(this.renderTarget){this.cameras[e].camera._clearOptions=this.oldClear,t.graphicsDevice.setRenderTarget(this.renderTarget),t.graphicsDevice.updateBegin();const s=t.graphicsDevice.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,this.srcFbo),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),s.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,s.DEPTH_BUFFER_BIT,s.NEAREST)}}})}initWebGl1(){const t=this.application,e=this;this.clearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:ni|ai},this.layer=new Gc({enabled:!1,name:"Depth",id:Gt,shaderPass:cs,onEnable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=e.allocateRenderTarget(this.renderTarget,t.graphicsDevice,"rt-depth1",Li,!1)},onDisable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPostCull:function(e){const s=this.instances.visibleOpaque[e],i=s.list,n=t.scene.layers,a=n.subLayerEnabled,r=n.subLayerList,o=t.scene.layers.getLayerById(Wt).renderTarget,h=this.cameras[e];let l=0;const c=n.layerList;for(let t=0;t<c.length;t++){const e=c[t];if(e===this)break;if(e.renderTarget!==o||!e.enabled||!a[t])continue;const s=e.cameras.indexOf(h);if(s<0)continue;let n=r[t]?e.instances.visibleTransparent[s]:e.instances.visibleOpaque[s];const d=n.length;n=n.list;for(let t=0;t<d;t++){const e=n[t];e.material&&e.material.depthWrite&&!e._noDepthDrawGl1&&(i[l]=e,l++)}}s.length=l},onPreRenderOpaque:function(s){this.renderTarget.width===t.graphicsDevice.width&&this.renderTarget.height===t.graphicsDevice.height||this.onEnable(),this.oldClear=this.cameras[s].camera._clearOptions,this.cameras[s].camera._clearOptions=e.clearOptions},onDrawCall:function(){t.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(t){this.renderTarget&&(this.cameras[t].camera._clearOptions=this.oldClear)}})}init(){this.device.webgl2?this.initWebGl2():this.initWebGl1()}patch(t){t.onEnable=this.layer.onEnable,t.onDisable=this.layer.onDisable,t.onPreRenderOpaque=this.layer.onPreRenderOpaque,t.onPostRenderOpaque=this.layer.onPostRenderOpaque,t.shaderPass=this.layer.shaderPass,t.onPostCull=this.layer.onPostCull,t.onDrawCall=this.layer.onDrawCall}}class AS extends u{constructor(t,e){super(),this.app=t,this.container=e,this.entity=e,this._enabled=!0}get enabled(){return this._enabled}set enabled(t){this.onSetEnabled(t)}onSetEnabled(t){if(t==this._enabled)return;const e=this._enabled;this._enabled=t,this.fire("set_enabled","enabled",e,t)}onEnable(){}onDisable(){}onPostStateChange(){}getPropertiesOfType(t){const e=[];return(this.constructor.properties||[]).forEach((function(s){s&&"object"==typeof s&&s.type===t&&e.push(s)})),e}}const CS=function(t,e,s){s=s||{},Object.defineProperty(t,e,{get:function(){return s.get?s.get.call(this):this["_"+e]},set:function(t){const i=this["_"+e],n=t;s.set?s.set.call(this,t):this["_"+e]=t,this.fire("set_"+e,e,i,n)},configurable:s.configurable||!1})};let PS=0;class RS{constructor(){this.registes=[]}regist(t,e){if(Object.freeze(t.type=e),Object.freeze(t.id=PS),this[e]){const t=this.registes.findIndex((t=>t.type==e));t>=0&&this.registes.splice(t,1)}this[e]=t,this["c_"+PS]=t,this.registes.push(t),PS++}buildAccessors(t,e){e.forEach((e=>{var s="object"==typeof e?e.name:e;const i=Object.getOwnPropertyDescriptor(t,s),n=null==i?void 0:i.set,a=null==i?void 0:i.get;Object.defineProperty(t,s,{get:function(){return a?a.bind(this)():this["_"+s]},set:function(t){const e=this["_"+s];n&&n.bind(this)(t);const i=t;this["_"+s]=t,this.fire("set_"+s,s,e,i)}})}))}getFnc(t){if(AS.isPrototypeOf(t))return t;return this[t]||this["c_"+t]}getKey(t){if(AS.isPrototypeOf(t))return t.type;const e=this[t]||this["c_"+t];return e?e.type:void 0}}const ES=new RS;const LS=function(t){return t.sort().toString()},IS=[];class DS extends u{constructor(t){super(),this.app=t,this.registes=new Map;for(let t=0;t<IS.length;t++)this.create(IS[t].fnc,...IS[t].type)}static regist(t,...e){IS.push({fnc:t,type:e})}connectStore(t){let e=this.registes.get(t.key);if(e)for(let s of e)s._stores.add(t),s.beforeConnectStore(t),s.fire("beforeconnect",t),s.connectStore(t),s.fire("connect",t)}disconnectStore(t){let e=this.registes.get(t.key);if(e){for(let s of e)s._stores.delete(t),s.beforeDisconnectStore(t),s.fire("beforedisconnect",t),s.disconnectStore(t),s.fire("disconnect",t);return!0}return!1}destroyStore(t){let e=this.registes.get(t.key);if(e){for(let s of e)s.onDestroy(t);return!0}return!1}connectContainer(t,...e){let s=LS(e),i=this.registes.get(s);if(i){for(let e of i)e._containers.add(t),e.beforeConnectContainer(t),e.fire("beforeconnect",e,t),e.connectContainer(t),e.fire("connect",e,t);return!0}return!1}disconnectContainer(t,...e){let s=LS(e),i=this.registes.get(s);if(i){for(let e of i)e._containers.delete(t),e.beforeDisconnectContainer(t),e.fire("beforedisconnect",e,t),e.disconnectContainer(t),e.fire("disconnect",e,t);return!0}return!1}getComponentTypsLinkSystems(...t){let e=Array.from(this.registes.keys());for(let s=0;s<e.length;s++){let i=e[s].split(","),n=!1;for(let e=0;e<t.length&&(n=i.indexOf(t[e])>=0,n);e++);n||(e.splice(s,1),s--)}return e}get(t){return this.registes.get(t)}getAllSystemPlans(t,e){const s=V.combinations(t.sort(),0);for(let t=0;t<s.length;t++){let i=LS(s[t]);this.registes.has(i)?e&&s[t].indexOf(e)<0&&(s.splice(t,1),t--):(s.splice(t,1),t--)}return s}create(t,...e){let s=new t(this.app),i=LS(e),n=this.registes.get(i);return n||(n=new Set,this.registes.set(i,n)),n.add(s),s.on("destroy",(()=>{this.delete(s)})),s}initialize(){for(let[t,e]of this.registes)for(let t of e)t.onInitialize();this.fire("initialize")}postInitialize(){for(let[t,e]of this.registes)for(let t of e)t.onPostInitialize();this.fire("postinitialize")}update(t){for(let e of this.registes.values())for(let s of e)s.stores.size&&s.onUpdate(t)}delete(t){this.registes.delete(t)}}class FS{constructor(){this.variants={}}}class OS{constructor(t){this._assets=t.assets,this._device=t.graphicsDevice,this._placeholderTextures=null,this.maxRetries=0}load(t,e){e(null,null)}open(t,e){return e}patch(t,e){let s=t.data,i=new FS;i.variants=s,t.resource=i}}function kS(t){const e=this;if(!e.resource)return;const s=t.resource,i=s.renders&&s.renders[e.data.renderIndex];i&&(e.resource.meshes=i.resource.meshes)}function BS(t){const e=this;e.registry.off("load:"+t.id,kS,e),e.registry.on("load:"+t.id,kS,e),e.registry.off("remove:"+t.id,zS,e),e.registry.once("remove:"+t.id,zS,e),t.resource?kS.call(e,t):e.registry.load(t)}function zS(t){const e=this;e.registry.off("load:"+t.id,kS,e),e.resource&&(e.resource.meshes=null)}class US{constructor(t){this._registry=t}load(t,e,s){}open(t,e){return new cm}patch(t,e){var s;if(null==(s=t.data)||!s.containerAsset)return;const i=e.get(t.data.containerAsset);i?BS.call(t,i):e.once("add:"+t.data.containerAsset,BS,t)}}class VS{constructor(){this.variants={}}}class NS{constructor(t){this._app=this,this._assets=t.assets,this._device=t.graphicsDevice,this._placeholderTextures=null,this.maxRetries=0}load(t,e){e(null,null)}open(t,e){return e}patch(t,e){let s=t.data,i=new VS;i.variants=s.variatns,t.resource=i}}class WS extends aS{constructor(t,e){super(t,e),this._currSlot=null,this._animation=null,this._changeTimeout=null,this._cacheCurrentTime={},this.entity.animation&&(this.animation=this.entity.animation),this.entity.on("component:animation:add",(t=>this.animation=t)),this.entity.on("component:animation:remove",(()=>this.animation=null))}_onAnimPlay(t){this._currSlot&&this.stop(),this.slots[t]&&(this.play(t),this._currSlot=t,this._cacheCurrentTime=0)}_onAnimStop(){this.stop(),this._currSlot=null,this._cacheCurrentTime=0}_onAnimResume(t){this.slots[t]&&this.resume(t)}_onAnimPause(t){this.slots[t]&&this.pause(t)}_onAnimSpeedChanged(t,e,s){this.pitch=s}_onAnimCurrentTimeChanged(t){this._currSlot&&(this._changeTimeout&&(clearTimeout(this._changeTimeout),this._changeTimeout=null),this._changeTimeout=setTimeout((()=>{if(!this._currSlot)return;let e=this.slots[this._currSlot].instances;for(let s=0;s<e.length;s++){e[s].currentTime=t}}),100))}get animation(){return this._animation}set animation(t){this._animation&&(this._animation.off("play",this._onAnimPlay),this._animation.off("stop",this._onAnimStop),this._animation.off("resume",this._onAnimResume),this._animation.off("pause",this._onAnimPause),this._animation.off("set_speed",this._onAnimSpeedChanged)),this._animation=t,this._animation&&(this._animation.on("play",this._onAnimPlay,this),this._animation.on("stop",this._onAnimStop,this),this._animation.on("resume",this._onAnimResume,this),this._animation.on("pause",this._onAnimPause,this),this._animation.on("set_speed",this._onAnimSpeedChanged,this))}onUpdate(t){if(!this._currSlot||!this.animation.currAnim)return;const e=this.animation.currentTime;if(this._cacheCurrentTime>e){let t=this.slots[this._currSlot].instances;for(let s=0;s<t.length;s++){t[s].currentTime=e}}this._cacheCurrentTime=e}}class GS{constructor(){this.enabled=!0,this.animation=null}}class HS extends cS{constructor(t,e){super(t,e),this.id="animationAudio",this.ComponentType=WS,this.DataType=GS}initializeComponentData(t,e,s){e.animation&&(t.animation=e.animation),super.initializeComponentData(t,e,[])}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].entity;if(i.enabled){const e=i.animationAudio;if(e.enabled&&e.positional){const t=i.getPosition(),s=e.slots;for(const e in s)s[e].updatePosition(t)}e.onUpdate(t)}}}cloneComponent(t,e){const s=t.animationAudio,i=s.slots,n={};for(const t in i){const e=i[t];n[t]={name:e.name,volume:e.volume,pitch:e.pitch,loop:e.loop,duration:e.duration,startTime:e.startTime,overlap:e.overlap,autoPlay:e.autoPlay,asset:e.asset}}const a={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(e,a)}}class jS extends Lg{constructor(t,e){super(t,e),this._schemes=void 0,this._currentSchemes={}}changeVariant(t,e){const s=this._schemes.find((e=>e.id==t));if(!s)return;this.entity.findComponents("materialVariants").forEach((t=>{s.variants.every((e=>!!t.variants[e.id]))&&t.changeVariant(e)})),this._currentSchemes[t]=e}get currentSchemes(){return this._currentSchemes}get schemes(){return this._schemes}set schemes(t){this._schemes=t}onBeforeRemove(){this._schemes=null}}class qS{constructor(){this.enabled=!0,this.schemes=null}}class XS extends Ig{constructor(t){super(t),this.id="materialSchemes",this.ComponentType=jS,this.DataType=qS,this.on("beforeremove",this.onBeforeRemove,this)}initializeComponentData(t,e={},s){s=["enabled","schemes"],super.initializeComponentData(t,e,s)}onBeforeRemove(t,e){e.onBeforeRemove()}}class YS extends Lg{constructor(t,e){super(t,e),this._variants=void 0,this._cacheMaterialAssets=void 0}changeVariant(t){const e=this._variants[t],s=this.entity.getComponent("render");e&&s?(this._cacheMaterialAssets||(this._cacheMaterialAssets=Array.from(s.meshInstances.map((t=>t.material)))),s.materialAssets=e.materialAssets,this.entity.fire("mat:variants:changed",this.entity,e.materialAssets)):this._cacheMaterialAssets&&(this._cacheMaterialAssets.forEach(((t,e)=>{s.meshInstances[e].material=t})),this.entity.fire("mat:variants:changed",this.entity,this._cacheMaterialAssets))}get variants(){return this._variants}set variants(t){this._variants=t}onBeforeRemove(){this._variants=null}}class KS{constructor(){this.enabled=!0,this.variants=null}}class $S extends Ig{constructor(t){super(t),this.id="materialVariants",this.ComponentType=YS,this.DataType=KS,this.on("beforeremove",this.onBeforeRemove,this)}initializeComponentData(t,e={},s){s=["enabled","variants"],super.initializeComponentData(t,e,s)}onBeforeRemove(t,e){e.onBeforeRemove()}}class ZS extends Lg{constructor(t,e){super(t,e),this._schemes=void 0}changeVariant(t,e){this._schemes.find((e=>e.id==t))&&this.entity.findComponents("nodeVariants").forEach((t=>{t.changeVariant(e)}))}get schemes(){return this._schemes}set schemes(t){this._schemes=t}onBeforeRemove(){this._schemes=null}}class JS{constructor(){this.enabled=!0,this.schemes=null}}class QS extends Ig{constructor(t){super(t),this.id="nodeSchemes",this.ComponentType=ZS,this.DataType=JS,this.on("beforeremove",this.onBeforeRemove,this)}initializeComponentData(t,e={},s){s=["enabled","schemes"],super.initializeComponentData(t,e,s)}onBeforeRemove(t,e){e.onBeforeRemove()}}class tw extends Lg{constructor(t,e){super(t,e),this._variants=void 0,this._cacheEnabled=void 0}changeVariant(t){let e=this._variants[t];e?(null==this._cacheEnabled&&(this._cacheEnabled=this.entity.enabled),this.entity.enabled=e.enabled):void 0!==this._cacheEnabled&&(this.entity.enabled=this._cacheEnabled)}get variants(){return this._variants}set variants(t){this._variants=t}onBeforeRemove(){this._variants=null,this._cacheEnabled=null}}class ew{constructor(){this.enabled=!0,this.variants=null}}class sw extends Ig{constructor(t){super(t),this.id="nodeVariants",this.ComponentType=tw,this.DataType=ew,this.on("beforeremove",this.onBeforeRemove,this)}initializeComponentData(t,e={},s){s=["enabled","variants"],super.initializeComponentData(t,e,s)}onBeforeRemove(t,e){e.onBeforeRemove()}}class iw extends Rh{constructor(t){super(t),this.SAMPLE_COUNT=15;var e={aPosition:ln},s=["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","\t\tgl_Position = vec4(aPosition, 0.0, 1.0);","\t\tvUv0 = (aPosition + 1.0) * 0.5;","}"].join("\n"),i=["precision "+t.precision+" float;","","varying vec2 vUv0;","","uniform sampler2D uBaseTexture;","uniform float uBloomThreshold;","","void main(void)","{","\t\tvec4 color = texture2D(uBaseTexture, vUv0);","","\t\tgl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);","}"].join("\n"),n=["precision "+t.precision+" float;","","#define SAMPLE_COUNT "+this.SAMPLE_COUNT,"","varying vec2 vUv0;","","uniform sampler2D uBloomTexture;","uniform vec2 uBlurOffsets[SAMPLE_COUNT];","uniform float uBlurWeights[SAMPLE_COUNT];","","void main(void)","{","\t\tvec4 color = vec4(0.0);","\t\tfor (int i = 0; i < SAMPLE_COUNT; i++)","\t\t{","\t\t\t\tcolor += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];","\t\t}","","\t\tgl_FragColor = color;","}"].join("\n"),a=["precision "+t.precision+" float;","","varying vec2 vUv0;","","uniform float uBloomEffectIntensity;","uniform sampler2D uBaseTexture;","uniform sampler2D uBloomTexture;","","void main(void)","{","\t\tvec4 bloom = texture2D(uBloomTexture, vUv0) * uBloomEffectIntensity;","\t\tvec4 base = texture2D(uBaseTexture, vUv0);","","\t\tbase *= (1.0 - clamp(bloom, 0.0, 1.0));","","\t\tgl_FragColor = base + bloom;","}"].join("\n");this.extractShader=new sr(t,{attributes:e,vshader:s,fshader:i}),this.blurShader=new sr(t,{attributes:e,vshader:s,fshader:n}),this.combineShader=new sr(t,{attributes:e,vshader:s,fshader:a});var r=t.width,o=t.height;this.targets=[];for(var h=0;h<2;h++){var l=new Mr(t,{format:Li,width:r>>1,height:o>>1});l.minFilter=ui,l.magFilter=ui,l.addressU=Ws,l.addressV=Ws,l.name="pe-bloom";var c=new uh(t,l,{depth:!1});this.targets.push(c)}this.bloomThreshold=.25,this.blurAmount=4,this.bloomIntensity=1.25,this.sampleWeights=new Float32Array(this.SAMPLE_COUNT),this.sampleOffsets=new Float32Array(2*this.SAMPLE_COUNT)}computeGaussian(t,e){return 1/Math.sqrt(2*Math.PI*e)*Math.exp(-t*t/(2*e*e))}calculateBlurValues(t,e,s,i,n){t[0]=this.computeGaussian(0,n),e[0]=0,e[1]=0;var a,r,o=t[0];for(a=0,r=Math.floor(this.SAMPLE_COUNT/2);a<r;a++){var h=this.computeGaussian(a+1,n);t[2*a]=h,t[2*a+1]=h,o+=2*h;var l=2*a+1.5;e[4*a]=s*l,e[4*a+1]=i*l,e[4*a+2]=-s*l,e[4*a+3]=-i*l}for(a=0,r=t.length;a<r;a++)t[a]/=o}render(t,e,s){var i=this.device,n=i.scope;n.resolve("uBloomThreshold").setValue(this.bloomThreshold),n.resolve("uBaseTexture").setValue(t.colorBuffer),Lh(i,this.targets[0],this.vertexBuffer,this.extractShader),this.calculateBlurValues(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount),n.resolve("uBlurWeights[0]").setValue(this.sampleWeights),n.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),n.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),Lh(i,this.targets[1],this.vertexBuffer,this.blurShader),this.calculateBlurValues(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount),n.resolve("uBlurWeights[0]").setValue(this.sampleWeights),n.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),n.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer),Lh(i,this.targets[0],this.vertexBuffer,this.blurShader),n.resolve("uBloomEffectIntensity").setValue(this.bloomIntensity),n.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),n.resolve("uBaseTexture").setValue(t.colorBuffer),Lh(i,e,this.vertexBuffer,this.combineShader,s)}}class nw extends Lg{constructor(t,e){super(t,e),this.effect=new iw(t.app.graphicsDevice),this._threshold=.25,this._blurAmount=4,this._intensity=1.25}get threshold(){return this._threshold}set threshold(t){this._threshold=t,this.effect.bloomThreshold=t}get blurAmount(){return this._blurAmount}set blurAmount(t){this._blurAmount=t,this.effect.blurAmount=t}get intensity(){return this._intensity}set intensity(t){this._intensity=t,this.effect.bloomIntensity=t}onBeforeRemove(){const t=this.entity.getComponent("camera");t&&t.postEffects.removeEffect(this.effect)}onEnable(){const t=this.entity.getComponent("camera");t&&t.postEffects.addEffect(this.effect)}onDisable(){const t=this.entity.getComponent("camera");t&&t.postEffects.removeEffect(this.effect)}}class aw{constructor(){this.enabled=!0,this.threshold=.25,this.blurAmount=4,this.intensity=1.25}}class rw extends Ig{constructor(t){super(t),this.id="cameraEffectBloom",this.ComponentType=nw,this.DataType=aw,this.on("beforeremove",this.onBeforeRemove,this)}initializeComponentData(t,e={},s){s=["threshold","blurAmount","intensity"],super.initializeComponentData(t,e,s)}onBeforeRemove(t,e){e.onBeforeRemove()}}class ow extends Rh{constructor(t){super(t),this.needsDepthBuffer=!0,this.ssaoShader=new sr(t,{attributes:{aPosition:ln},vshader:[t.webgl2?"#version 300 es\n\n"+ir.gles3VS:"","attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","\t\tgl_Position = vec4(aPosition, 0.0, 1.0);","\t\tvUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:[t.webgl2?"#version 300 es\n\n"+ir.gles3PS:"","precision "+t.precision+" float;",ir.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","#define saturate(x) clamp(x,0.0,1.0)","","// Largely based on 'Dominant Light Shadowing'","// 'Lighting Technology of The Last of Us Part II' by Hawar Doghramachi, Naughty Dog, LLC","","const float kSSCTLog2LodRate = 3.0;","","struct ConeTraceSetup {","\t // fragment info","\t\thighp vec2 ssStartPos;","\t\thighp vec3 vsStartPos;","\t\tvec3 vsNormal;","","\t // light (cone) info","\t\tvec3 vsConeDirection;","\t\tfloat shadowDistance;","\t\tfloat coneAngleTangeant;","\t\tfloat contactDistanceMaxInv;","\t\tvec2 jitterOffset;\t\t\t\t\t// (x = direction offset, y = step offset)","","\t // scene infos","\t\thighp mat4 screenFromViewMatrix;","\t\tfloat projectionScale;","\t\tvec4 resolution;","\t\tfloat maxLevel;","","\t // artistic/quality parameters","\t\tfloat intensity;","\t\tfloat depthBias;","\t\tfloat slopeScaledDepthBias;","\t\tint sampleCount;","};","","highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {","\t\t// this essentially returns (p * vec4(v, 1.0)).w, but we make some assumptions","\t\t// this assumes a perspective projection","\t\treturn -v.z;","\t\t// this assumes a perspective or ortho projection","\t\t// return p[2][3] * v.z + p[3][3];","}","","highp float getViewSpaceZFromW(const mat4 p, const float w) {","\t\t// this assumes a perspective projection","\t\treturn -w;","\t\t// this assumes a perspective or ortho projection","\t // return (w - p[3][3]) / p[2][3];","}","","float coneTraceOcclusion(in ConeTraceSetup setup) {","// skip fragments that are back-facing trace direction","// (avoid overshadowing of translucent surfaces)","\t\tfloat NoL = dot(setup.vsNormal, setup.vsConeDirection);","\t\tif (NoL < 0.0) {","\t\t\t\treturn 0.0;","\t\t}","","// start position of cone trace","\t\thighp vec2 ssStartPos = setup.ssStartPos;","\t\thighp vec3 vsStartPos = setup.vsStartPos;","\t\thighp float ssStartPosW = getWFromProjectionMatrix(setup.screenFromViewMatrix, vsStartPos);","\t\thighp float ssStartPosWInv = 1.0 / ssStartPosW;","","// end position of cone trace","\t\thighp vec3 vsEndPos = setup.vsConeDirection * setup.shadowDistance + vsStartPos;","\t\thighp float ssEndPosW = getWFromProjectionMatrix(setup.screenFromViewMatrix, vsEndPos);","\t\thighp float ssEndPosWInv = 1.0 / ssEndPosW;","\t\thighp vec2 ssEndPos = (setup.screenFromViewMatrix * vec4(vsEndPos, 1.0)).xy * ssEndPosWInv;","","// cone trace direction in screen-space","\t\tfloat ssConeLength = length(ssEndPos - ssStartPos);","\t\tvec2 ssConeVector = ssEndPos - ssStartPos;","","// direction perpendicular to cone trace direction","\t\tvec2 peremwoneDir = normalize(vec2(ssConeVector.y, -ssConeVector.x));","\t\tfloat vsEndRadius = setup.coneAngleTangeant * setup.shadowDistance;","","// normalized step","\t\thighp float dt = 1.0 / float(setup.sampleCount);","","// normalized (0 to 1) screen-space postion on the ray","\t\thighp float t = dt * setup.jitterOffset.y;","","// calculate depth bias","\t\tfloat vsDepthBias = saturate(1.0 - NoL) * setup.slopeScaledDepthBias + setup.depthBias;","","\t\tfloat occlusion = 0.0;","\t\tfor (int i = 0; i < 16; i++) {","\t\t\t\tfloat ssTracedDistance = ssConeLength * t;","\t\t\t\tfloat ssSliceRadius = setup.jitterOffset.x * (setup.coneAngleTangeant * ssTracedDistance);","\t\t\t\thighp vec2 ssSamplePos = peremwoneDir * ssSliceRadius + ssConeVector * t + ssStartPos;","","\t\t\t\tfloat level = clamp(floor(log2(ssSliceRadius)) - kSSCTLog2LodRate, 0.0, float(setup.maxLevel));","\t\t\t\tfloat vsSampleDepthLinear = -getLinearScreenDepth(ssSamplePos * setup.resolution.zw);","","\t\t\t // calculate depth range of cone slice","\t\t\t\tfloat vsSliceRadius = vsEndRadius * t;","","\t\t\t // calculate depth of cone center","\t\t\t\tfloat vsConeAxisDepth = -getViewSpaceZFromW(setup.screenFromViewMatrix, 1.0 / mix(ssStartPosWInv, ssEndPosWInv, t));","\t\t\t\tfloat vsJitteredSampleRadius = vsSliceRadius * setup.jitterOffset.x;","\t\t\t\tfloat vsSliceHalfRange = sqrt(vsSliceRadius * vsSliceRadius - vsJitteredSampleRadius * vsJitteredSampleRadius);","\t\t\t\tfloat vsSampleDepthMax = vsConeAxisDepth + vsSliceHalfRange;","","\t\t\t // calculate overlap of depth buffer height-field with trace cone","\t\t\t\tfloat vsDepthDifference = vsSampleDepthMax - vsSampleDepthLinear;","\t\t\t\tfloat overlap = saturate((vsDepthDifference - vsDepthBias) / (vsSliceHalfRange * 2.0));","","\t\t\t\t// attenuate by distance to avoid false occlusion","\t\t\t\tfloat attenuation = saturate(1.0 - (vsDepthDifference * setup.contactDistanceMaxInv));","\t\t\t\tocclusion = max(occlusion, overlap * attenuation);","\t\t\t\tif (occlusion >= 1.0) {\t// note: this can't get > 1.0 by construction","\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// fully occluded, early exit","\t\t\t\t\t\tbreak;","\t\t\t\t}","\t\t\t\tt += dt;","\t\t}","\t\treturn occlusion * setup.intensity;","}","","const float kLog2LodRate = 3.0;","","vec2 sq(const vec2 a) {","\t\treturn a * a;","}","","uniform float uInvFarPlane;","","vec2 pack(highp float depth) {","// we need 16-bits of precision","\t\thighp float z = clamp(depth * uInvFarPlane, 0.0, 1.0);","\t\thighp float t = floor(256.0 * z);","\t\tmediump float hi = t * (1.0 / 256.0);\t // we only need 8-bits of precision","\t\tmediump float lo = (256.0 * z) - t;\t\t // we only need 8-bits of precision","\t\treturn vec2(hi, lo);","}","","// random number between 0 and 1, using interleaved gradient noise","float random(const highp vec2 w) {","\t\tconst vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","\t\treturn fract(m.z * fract(dot(w, m.xy)));","}","","// returns the frag coord in the GL convention with (0, 0) at the bottom-left","highp vec2 getFragCoord() {","\t\treturn gl_FragCoord.xy;","}","","highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {","\t\treturn vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);","}","","highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {","\t\treturn normalize(cross(dpdx, dpdy));","}","","// Compute normals using derivatives, which essentially results in half-resolution normals","// this creates arifacts around geometry edges.","// Note: when using the spirv optimizer, this results in much slower execution time because","//\t\t\t this whole expression is inlined in the AO loop below.","","// Compute normals directly from the depth texture, resulting in full resolution normals","// Note: This is actually as cheap as using derivatives because the texture fetches","//\t\t\t are essentially equivalent to textureGather (which we don't have on ES3.0),","//\t\t\t and this is executed just once.","highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {","\t\thighp vec2 uvdx = uv + vec2(uResolution.z, 0.0);","\t\thighp vec2 uvdy = uv + vec2(0.0, uResolution.w);","\t\thighp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));","\t\thighp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));","\t\thighp vec3 dpdx = px - position;","\t\thighp vec3 dpdy = py - position;","\t\treturn faceNormal(dpdx, dpdy);","}","","// Ambient Occlusion, largely inspired from:","// 'The Alchemy Screen-Space Ambient Obscurance Algorithm' by Morgan McGuire","// 'Scalable Ambient Obscurance' by Morgan McGuire, Michael Mara and David Luebke","","uniform vec2 uSampleCount;","uniform float uSpiralTurns;","","#define PI (3.14159)","","vec3 tapLocation(float i, const float noise) {","\t\tfloat offset = ((2.0 * PI) * 2.4) * noise;","\t\tfloat angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;","\t\tfloat radius = (i + noise + 0.5) * uSampleCount.y;","\t\treturn vec3(cos(angle), sin(angle), radius * radius);","}","","highp vec2 startPosition(const float noise) {","\t\tfloat angle = ((2.0 * PI) * 2.4) * noise;","\t\treturn vec2(cos(angle), sin(angle));","}","","uniform vec2 uAngleIncCosSin;","","highp mat2 tapAngleStep() {","\t\thighp vec2 t = uAngleIncCosSin;","\t\treturn mat2(t.x, t.y, -t.y, t.x);","}","","vec3 tapLocationFast(float i, vec2 p, const float noise) {","\t\tfloat radius = (i + noise + 0.5) * uSampleCount.y;","\t\treturn vec3(p, radius * radius);","}","","uniform float uMaxLevel;","uniform float uInvRadiusSquared;","uniform float uMinHorizonAngleSineSquared;","uniform float uBias;","uniform float uPeak2;","","void computeAmbientOcclusionSAO(inout float occlusion, float i, float ssDiskRadius,","\t\t\t\tconst highp vec2 uv,\tconst highp vec3 origin, const vec3 normal,","\t\t\t\tconst vec2 tapPosition, const float noise) {","","\t\tvec3 tap = tapLocationFast(i, tapPosition, noise);","","\t\tfloat ssRadius = max(1.0, tap.z * ssDiskRadius);","","\t\tvec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uResolution.zw;","","\t\tfloat level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));","\t\thighp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);","\t\thighp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);","","\t\t// now we have the sample, compute AO","\t\tvec3 v = p - origin;\t\t\t\t// sample vector","\t\tfloat vv = dot(v, v);\t\t\t // squared distance","\t\tfloat vn = dot(v, normal);\t// distance * cos(v, normal)","","\t\t// discard samples that are outside of the radius, preventing distant geometry to","\t\t// cast shadows -- there are many functions that work and choosing one is an artistic","\t\t// decision.","\t\tfloat w = max(0.0, 1.0 - vv * uInvRadiusSquared);","\t\tw = w*w;","","\t\t// discard samples that are too close to the horizon to reduce shadows cast by geometry","\t\t// not sufficently tessellated. The goal is to discard samples that form an angle 'beta'","\t\t// smaller than 'epsilon' with the horizon. We already have dot(v,n) which is equal to the","\t\t// sin(beta) * |v|. So the test simplifies to vn^2 < vv * sin(epsilon)^2.","\t\tw *= step(vv * uMinHorizonAngleSineSquared, vn * vn);","","\t\tocclusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);","}","","uniform float uProjectionScaleRadius;","uniform float uIntensity;","","float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {","\t\tfloat noise = random(getFragCoord());","\t\thighp vec2 tapPosition = startPosition(noise);","\t\thighp mat2 angleStep = tapAngleStep();","","\t\t// Choose the screen-space sample radius","\t\t// proportional to the projected area of the sphere","\t\tfloat ssDiskRadius = -(uProjectionScaleRadius / origin.z);","","\t\tfloat occlusion = 0.0;","\t\tfor (float i = 0.0; i < 16.0; i += 1.0) {","\t\t\t\tcomputeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);","\t\t\t\ttapPosition = angleStep * tapPosition;","\t\t}","\t\treturn sqrt(occlusion * uIntensity);","}","","uniform float uPower;","","void main() {","\t\thighp vec2 uv = vUv0; //variable_vertex.xy; // interpolated to pixel center","","\t\thighp float depth = -getLinearScreenDepth(vUv0);","\t\thighp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);","\t\tvec3 normal = computeViewSpaceNormal(origin, uv);","","\t\tfloat occlusion = 0.0;","","\t\tif (uIntensity > 0.0) {","\t\t\t\tocclusion = scalableAmbientObscurance(uv, origin, normal);","\t\t}","","\t\t// occlusion to visibility","\t\tfloat aoVisibility = pow(saturate(1.0 - occlusion), uPower);","","\t\tvec4 inCol = vec4(1.0, 1.0, 1.0, 1.0); //texture2D( uColorBuffer,\tuv );","","\t\tgl_FragColor.rgb = inCol.rgb * vec3(aoVisibility); //postProcess.color.rgb = vec3(aoVisibility, pack(origin.z));","\t\tgl_FragColor.a = 1.0;","}","","void main_old()","{","\t\tvec2 aspectCorrect = vec2( 1.0, uAspect );","","\t\tfloat depth = getLinearScreenDepth(vUv0);","\t\tgl_FragColor.rgb = vec3(fract(floor(depth*256.0*256.0)),fract(floor(depth*256.0)),fract(depth));","\t\tgl_FragColor.a = 1.0;","}"].join("\n")}),this.blurShader=new sr(t,{attributes:{aPosition:ln},vshader:[t.webgl2?"#version 300 es\n\n"+ir.gles3VS:"","attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","\t\tgl_Position = vec4(aPosition, 0.0, 1.0);","\t\tvUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:[t.webgl2?"#version 300 es\n\n"+ir.gles3PS:"","precision "+t.precision+" float;",ir.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","uniform sampler2D uSSAOBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","uniform int uBilatSampleCount;","uniform float uFarPlaneOverEdgeDistance;","","float random(const highp vec2 w) {","\t\tconst vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","\t\treturn fract(m.z * fract(dot(w, m.xy)));","}","","float bilateralWeight(in float depth, in float sampleDepth) {","\t\tfloat diff = (sampleDepth - depth) * uFarPlaneOverEdgeDistance;","\t\treturn max(0.0, 1.0 - diff * diff);","}","","void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {","\t\t// ambient occlusion sample","\t\tfloat ssao = texture2D( uSSAOBuffer, position ).r;","\t\tfloat tdepth = -getLinearScreenDepth( position );","","\t\t// bilateral sample","\t\tfloat bilateral = bilateralWeight(depth, tdepth);","\t\tbilateral *= weight;","\t\tsum += ssao * bilateral;","\t\ttotalWeight += bilateral;","}","","void main() {","\t\thighp vec2 uv = vUv0; // variable_vertex.xy; // interpolated at pixel's center","","\t\t// we handle the center pixel separately because it doesn't participate in","\t\t// bilateral filtering","\t\tfloat depth = -getLinearScreenDepth(vUv0); // unpack(data.gb);","\t\tfloat totalWeight = 0.0; // float(4*2+1)*float(4*2+1);","\t\tfloat ssao = texture2D( uSSAOBuffer, vUv0 ).r;","\t\tfloat sum = ssao * totalWeight;","","\t\tfor (int x = -4; x <= 4; x++) {","\t\t\t for (int y = -4; y < 4; y++) {","\t\t\t\t\t float weight = 1.0;","\t\t\t\t\t vec2 offset = vec2(x,y)*uResolution.zw;","\t\t\t\t\t tap(sum, totalWeight, weight, depth, uv + offset);","\t\t\t }","\t\t}","","\t\tfloat ao = sum * (1.0 / totalWeight);","","\t\t// simple dithering helps a lot (assumes 8 bits target)","\t\t// this is most useful with high quality/large blurs","\t\t// ao += ((random(gl_FragCoord.xy) - 0.5) / 255.0);","","\t\tvec4 inCol = texture2D( uColorBuffer,\tvUv0 );","","\t\tgl_FragColor.rgb = inCol.rgb * ao;","\t\tgl_FragColor.a = 1.0;","}"].join("\n")});var e=t.width,s=t.height;this.targets=[];for(var i=0;i<1;i++){var n=new Mr(t,{format:Li,width:e,height:s,mipmaps:!1});n.minFilter=ui,n.magFilter=ui,n.addressU=Ws,n.addressV=Ws,n.name="ssao_"+i;var a=new uh(t,n,{depth:!1});this.targets.push(a)}this.maxBlur=.02}render(t,e,s){var i=this.device,n=i.scope,a=1/15.5*10*2*3.141,r=.5*i.height;n.resolve("uMaxBlur").setValue(this.maxBlur),n.resolve("uAspect").setValue(i.width/i.height),n.resolve("uResolution").setValue([i.width,i.height,1/i.width,1/i.height]),n.resolve("uColorBuffer").setValue(t.colorBuffer),n.resolve("uInvFarPlane").setValue(.02),n.resolve("uSampleCount").setValue([16,1/16]),n.resolve("uSpiralTurns").setValue(10),n.resolve("uAngleIncCosSin").setValue([Math.cos(a),Math.sin(a)]),n.resolve("uMaxLevel").setValue(0),n.resolve("uInvRadiusSquared").setValue(1/16),n.resolve("uMinHorizonAngleSineSquared").setValue(0),n.resolve("uBias").setValue(.001),n.resolve("uPeak2").setValue(.4*.4),n.resolve("uIntensity").setValue(.31410000000000005),n.resolve("uPower").setValue(1),n.resolve("uProjectionScaleRadius").setValue(4*r),Lh(i,this.targets[0],this.vertexBuffer,this.ssaoShader,s),n.resolve("uSSAOBuffer").setValue(this.targets[0].colorBuffer),n.resolve("uFarPlaneOverEdgeDistance").setValue(50/.7),n.resolve("uBilatSampleCount").setValue(4),Lh(i,e,this.vertexBuffer,this.blurShader,s)}}class hw extends Lg{constructor(t,e){super(t,e),this.effect=new ow(t.app.graphicsDevice),this._threshold=.25,this._blurAmount=4,this._intensity=1.25}get threshold(){return this._threshold}set threshold(t){this._threshold=t,this.effect.bloomThreshold=t}get blurAmount(){return this._blurAmount}set blurAmount(t){this._blurAmount=t,this.effect.blurAmount=t}get intensity(){return this._intensity}set intensity(t){this._intensity=t,this.effect.bloomIntensity=t}onBeforeRemove(){const t=this.entity.getComponent("camera");t&&t.postEffects.removeEffect(this.effect)}onEnable(){const t=this.entity.getComponent("camera");t&&t.postEffects.addEffect(this.effect)}onDisable(){const t=this.entity.getComponent("camera");t&&t.postEffects.removeEffect(this.effect)}}class lw{constructor(){this.enabled=!0,this.maxBlur=.02}}class cw extends Ig{constructor(t){super(t),this.id="cameraEffectSSAO",this.ComponentType=hw,this.DataType=lw,this.on("beforeremove",this.onBeforeRemove,this)}initializeComponentData(t,e={},s){s=["maxBlur"],super.initializeComponentData(t,e,s)}onBeforeRemove(t,e){e.onBeforeRemove()}}class dw{constructor(t){this.length=t,this.count=0}inc(){this.count++}done(){return this.count===this.length}}let uw=null;class pw extends u{constructor(t,s={}){super(),this.destroyed=!1,pw._applications[t.id]=this,Oh(this),uw=this,this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=Qf.legacy,this._librariesLoaded=!1,this._fillMode=E_,this._resolutionMode=I_,this._allowResize=!0,this.context=this,s.graphicsDeviceOptions||(s.graphicsDeviceOptions={}),C.browser&&e.polyfill.navigator.xr&&(s.graphicsDeviceOptions.xrCompatible=!0),s.graphicsDeviceOptions.alpha=s.graphicsDeviceOptions.alpha||!1,this.graphicsDevice=new ch(t,s.graphicsDeviceOptions),this._initDefaultMaterial(),this.stats=new SS(this.graphicsDevice),this._soundManager=new Hp(s),this.loader=new $f(this),so.init(this.graphicsDevice),this._entityIndex={},this.scene=new Cu(this.graphicsDevice),this.root=new ld(this),this.root._enabledInHierarchy=!0,this._enableList=[],this._enableList.size=0,this.assets=new C_(this.loader),s.assetPrefix&&(this.assets.prefix=s.assetPrefix),this.bundles=new $p(this.assets),this.enableBundles=void 0!==e.polyfill.TextDecoder,this.scriptsOrder=s.scriptsOrder||[],this.scripts=new W_(this),this.i18n=new H_(this),this.scenes=new MS(this);const i=this;this.defaultLayerWorld=new Gc({name:"World",id:Wt}),this.sceneDepth=new TS(this),this.defaultLayerDepth=this.sceneDepth.layer,this.defaultLayerSkybox=new Gc({enabled:!0,name:"Skybox",id:Ht,opaqueSortMode:xs}),this.defaultLayerUi=new Gc({enabled:!0,name:"UI",id:qt,transparentSortMode:bs,passThrough:!1}),this.defaultLayerImmediate=new Gc({enabled:!0,name:"Immediate",id:jt,opaqueSortMode:xs,passThrough:!0});const n=new Kc(this.graphicsDevice,"default");n.pushOpaque(this.defaultLayerWorld),n.pushOpaque(this.defaultLayerDepth),n.pushOpaque(this.defaultLayerSkybox),n.pushTransparent(this.defaultLayerWorld),n.pushOpaque(this.defaultLayerImmediate),n.pushTransparent(this.defaultLayerImmediate),n.pushTransparent(this.defaultLayerUi),this.scene.layers=n,this._immediateLayer=this.defaultLayerImmediate,this.scene.on("set:layers",(function(t,e){const s=e.layerList;let n;for(let t=0;t<s.length;t++)switch(n=s[t],n.id){case Gt:i.sceneDepth.patch(n);break;case qt:n.passThrough=i.defaultLayerUi.passThrough;break;case jt:n.passThrough=i.defaultLayerImmediate.passThrough}})),z_.createPlaceholder(this.graphicsDevice),this.renderer=new Dc(this.graphicsDevice),this.renderer.scene=this.scene,this.lightmapper=new _d(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this),this.batcher=new bl(this.graphicsDevice,this.root,this.scene),this.once("prerender",this._firstBatch,this),this.keyboard=s.keyboard||null,this.mouse=s.mouse||null,this.touch=s.touch||null,this.gamepads=s.gamepads||null,this.elementInput=s.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.vr=null,this.xr=new Eg(this),this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=s.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new ff(this.assets)),this.loader.addHandler("animation",new rf(this.graphicsDevice)),this.loader.addHandler("animclip",new hm),this.loader.addHandler("animstategraph",new lm),this.loader.addHandler("render",new Yf(this.assets)),this.loader.addHandler("material",new Hf(this)),this.loader.addHandler("texture",new b_(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("text",new h_),this.loader.addHandler("json",new Of),this.loader.addHandler("audio",new lf(this._soundManager)),this.loader.addHandler("script",new t_(this)),this.loader.addHandler("scene",new e_(this)),this.loader.addHandler("cubemap",new wf(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("cubemap-hdr",new U_(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("html",new Ff),this.loader.addHandler("css",new Sf),this.loader.addHandler("shader",new s_),this.loader.addHandler("hierarchy",new Df(this)),this.loader.addHandler("folder",new Mf),this.loader.addHandler("font",new Af(this.loader)),this.loader.addHandler("binary",new cf),this.loader.addHandler("textureatlas",new T_(this.loader)),this.loader.addHandler("sprite",new a_(this.assets,this.graphicsDevice)),this.loader.addHandler("template",new o_(this)),this.loader.addHandler("container",new gf(this.graphicsDevice,this.assets,Eo.get(this.graphicsDevice))),this.loader.addHandler("material-variants",new OS(this)),this.loader.addHandler("node-variants",new NS(this)),this.loader.addHandler("emw-container",new bf(this,this.assets,Eo.get(this.graphicsDevice))),this.loader.addHandler("emw-render",new US(this.assets)),this.loader.addHandler("emw-scene",new N_(this,this.assets)),this.systems=new lv,this.systems.add(new lb(this)),this.systems.add(new hv(this)),this.systems.add(new Kv(this)),this.systems.add(new Bg(this)),this.systems.add(new Yg(this)),this.systems.add(new Dx(this)),this.systems.add(new zx(this)),this.systems.add(new Py(this)),this.systems.add(new Rx(this)),Qf.legacy?this.systems.add(new Pb(this)):this.systems.add(new Mb(this)),this.systems.add(new sy(this,this._soundManager)),this.systems.add(new cS(this,this._soundManager)),this.systems.add(new Jg(this,this._soundManager)),this.systems.add(new Xx(this)),this.systems.add(new _b(this)),this.systems.add(new Vv(this)),this.systems.add(new xy(this)),this.systems.add(new Jb(this)),this.systems.add(new sS(this)),this.systems.add(new gS(this)),this.systems.add(new bx(this)),this.systems.add(new tx(this)),this.systems.add(new bS(this)),this.systems.add(new HS(this,this._soundManager)),this.systems.add(new XS(this)),this.systems.add(new $S(this)),this.systems.add(new QS(this)),this.systems.add(new sw(this)),this.systems.add(new rw(this)),this.systems.add(new cw(this)),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),void 0!==e.polyfill.document&&(void 0!==e.polyfill.document.hidden?(this._hiddenAttr="hidden",e.polyfill.document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==e.polyfill.document.mozHidden?(this._hiddenAttr="mozHidden",e.polyfill.document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==e.polyfill.document.msHidden?(this._hiddenAttr="msHidden",e.polyfill.document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==e.polyfill.document.webkitHidden&&(this._hiddenAttr="webkitHidden",e.polyfill.document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this._immediate=new B_(this.graphicsDevice,this),this.tick=fw(this)}static getApplication(t){return t?pw._applications[t]:Fh()}_initDefaultMaterial(){const t=new Mu;t.name="Default Material",t.shadingModel=Te,Eo.add(this.graphicsDevice,t)}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(t,e){j.get(t,{responseType:"JSON"}).then((t=>{const s=t.application_properties,i=t.scenes,n=t.assets;this._parseApplicationProperties(s,(t=>{this._parseScenes(i),this._parseAssets(n),e(t||null)}))})).catch((t=>{e(t)}))}preload(t){this.fire("preload:start");const e=this.assets.list({preload:!0}),s=new dw(e.length);let i=!1;const n=()=>{this.graphicsDevice&&!i&&s.done()&&(i=!0,this.fire("preload:end"),t())},a=e.length;if(s.length){const t=t=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()},i=(t,e)=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()};for(let r=0;r<e.length;r++)e[r].loaded?(s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()):(e[r].once("load",t),e[r].once("error",i),this.assets.load(e[r]))}else n()}_preloadScripts(t,e){if(!Qf.legacy)return void e();this.systems.script.preloading=!0;const s=this._getScriptReferences(t),i=s.length,n=new dw(i),a=/^http(s)?:\/\//;if(i){const t=(t,s)=>{t&&console.error(t),n.inc(),n.done()&&(this.systems.script.preloading=!1,e())};for(let e=0;e<i;e++){let i=s[e];!a.test(i.toLowerCase())&&this._scriptPrefix&&(i=f.join(self._scriptPrefix,s[e])),this.loader.load(i,"script",t)}}else this.systems.script.preloading=!1,e()}_handleAreaLightDataProperty(t){const e=this.assets.get(t);e?this.setAreaLightLuts(e):this.assets.once("add:"+t,this.setAreaLightLuts,this)}_parseApplicationProperties(t,s){if("number"==typeof t.maxAssetRetries&&t.maxAssetRetries>0&&this.loader.enableRetry(t.maxAssetRetries),t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=e.polyfill.window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.layers&&t.layerOrder){const e=new Kc(this.graphicsDevice,"application"),s={};for(const e in t.layers){const i=t.layers[e];i.id=parseInt(e,10),i.enabled=i.id!==Gt,s[e]=new Gc(i)}for(let i=0,n=t.layerOrder.length;i<n;i++){const n=t.layerOrder[i],a=s[n.layer];a&&(n.transparent?e.pushTransparent(a):e.pushOpaque(a),e.subLayerEnabled[i]=n.enabled)}this.scene.layers=e}if(t.batchGroups)for(let e=0,s=t.batchGroups.length;e<s;e++){const s=t.batchGroups[e];this.batcher.addGroup(s.name,s.dynamic,s.maxAabbSize,s.id,s.layers)}t.i18nAssets&&(this.i18n.assets=t.i18nAssets),t.areaLightDataAsset&&this._handleAreaLightDataProperty(t.areaLightDataAsset),this._loadLibraries(t.libraries,s)}_loadLibraries(t,e){const s=t.length;let i=s;const n=/^http(s)?:\/\//;if(s){const a=(t,s)=>{i--,t?e(t):0===i&&(this.onLibrariesLoaded(),e(null))};for(let e=0;e<s;++e){let s=t[e];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=f.join(this._scriptPrefix,s)),this.loader.load(s,"script",a)}}else this.onLibrariesLoaded(),e(null)}_parseScenes(t){if(t)for(let e=0;e<t.length;e++)this.scenes.add(t[e].name,t[e].url)}_parseAssets(t){const e=[],s={},i={};if(Qf.legacy){if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const s in t)i[s]||e.push(t[s])}else{for(let i=0;i<this.scriptsOrder.length;i++){const n=this.scriptsOrder[i];t[n]&&(s[n]=!0,e.push(t[n]))}if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const n in t)s[n]||i[n]||e.push(t[n])}for(let t=0;t<e.length;t++){const s=e[t],i=new wm(s.name,s.type,s.file,s.data);if(i.id=parseInt(s.id,10),i.preload=!!s.preload&&s.preload,i.loaded="script"===s.type&&s.data&&s.data.loadingType>0,i.tags.add(s.tags),s.i18n)for(const t in s.i18n)i.addLocalizedAssetId(t,s.i18n[t]);this.assets.add(i)}}_getScriptReferences(t){let e=[];t.settings.priority_scripts&&(e=t.settings.priority_scripts);const s=[],i={};for(let t=0;t<e.length;t++)s.push(e[t]),i[e[t]]=!0;const n=t.entities;for(const t in n){if(!n[t].components.script)continue;const e=n[t].components.script.scripts;for(let t=0;t<e.length;t++)i[e[t].url]||(s.push(e[t].url),i[e[t].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:k(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(t){this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(t),this.keyboard&&this.keyboard.update(t),this.gamepads&&this.gamepads.update(t)}update(t){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),Qf.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",t),this.systems.fire("animationUpdate",t),this.systems.fire("postUpdate",t),this.fire("update",t),this.inputUpdate(t)}render(){this.fire("prerender"),this.root.syncHierarchy(),this.batcher.updateAll(),this.renderer.renderComposition(this.scene.layers),this.fire("postrender")}_fillFrameStatsBasic(t,e,s){const i=this.stats.frame;i.dt=e,i.ms=s,t>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=t+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.stats.frame.totalDrawCalls=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let t=this.stats.frame;t.cameras=this.renderer._camerasRendered,t.materials=this.renderer._materialSwitches,t.shaders=this.graphicsDevice._shaderSwitchesPerFrame,t.vertices=this.graphicsDevice._vertices,t.shadowMapUpdates=this.renderer._shadowMapUpdates,t.shadowMapTime=this.renderer._shadowMapTime,t.depthMapTime=this.renderer._depthMapTime,t.forwardTime=this.renderer._forwardTime;const e=this.graphicsDevice._primsPerFrame;t.triangles=e[rn]/3+Math.max(e[on]-2,0)+Math.max(e[hn]-2,0),t.cullTime=this.renderer._cullTime,t.sortTime=this.renderer._sortTime,t.skinTime=this.renderer._skinTime,t.morphTime=this.renderer._morphTime,t.instancingTime=this.renderer._instancingTime,t.lightClusters=this.renderer._lightClusters,t.lightClustersTime=this.renderer._lightClustersTime,t.otherPrimitives=0;for(let s=0;s<e.length;s++)s<rn&&(t.otherPrimitives+=e[s]),e[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._instancingTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,t=this.stats.drawCalls,t.forward=this.renderer._forwardDrawCalls,t.culled=this.renderer._numDrawCallsCulled,t.depth=0,t.shadow=this.renderer._shadowDrawCalls,t.skinned=this.renderer._skinDrawCalls,t.immediate=0,t.instanced=0,t.removedByInstancing=0,t.misc=t.total-(t.forward+t.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.renderer._removedByInstancing=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,t=this.stats.particles,t.updatesPerFrame=t._updatesPerFrame,t.frameTime=t._frameTime,t._updatesPerFrame=0,t._frameTime=0}setCanvasFillMode(t,e,s){this._fillMode=t,this.resizeCanvas(e,s)}setCanvasResolution(t,e,s){this._resolutionMode=t,t===L_&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,s)}isHidden(){return e.polyfill.document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()}resizeCanvas(t,s){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const i=e.polyfill.window.innerWidth,n=e.polyfill.window.innerHeight;if(this._fillMode===E_){const e=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;e>i/n?s=(t=i)/e:t=(s=n)*e}else this._fillMode===R_&&(t=i,s=n);return this.graphicsDevice.canvas.style.width=t+"px",this.graphicsDevice.canvas.style.height=s+"px",this.updateCanvasSize(),{width:t,height:s}}updateCanvasSize(){if(this._allowResize&&!this.xr.active&&this._resolutionMode===L_){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(t){var e;let s;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const e=t.physics.gravity;this.systems.rigidbody.gravity.set(e[0],e[1],e[2])}this.scene.applySettings(t);const i=(null==(e=t.render)?void 0:e.skybox)||t.skybox;i?(s=this.assets.get(i),s?this.setSkybox(s):this.assets.once("add:"+i,this.setSkybox,this)):this.setSkybox(null)}setAreaLightLuts(t){if(t){const e=this.graphicsDevice;t.ready((t=>{z_.set(e,t.resource)})),this.assets.load(t)}}_onSkyboxRemoved(){this.setSkybox(null)}_onSkyboxChanged(){this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)}setSkybox(t){t!==this._skyboxAsset&&(this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,this._onSkyboxChanged,this),this.assets.off("remove:"+this._skyboxAsset.id,this._onSkyboxRemoved,this),this._skyboxAsset.off("change",this._onSkyboxChanged,this)),this._skyboxAsset=t,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,this._onSkyboxChanged,this),this.assets.once("remove:"+this._skyboxAsset.id,this._onSkyboxRemoved,this),this._skyboxAsset.on("change",this._onSkyboxChanged,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),this._onSkyboxChanged())}enableVr(){this.vr||(this.vr=new q_(this))}disableVr(){this.vr&&(this.vr.destroy(),this.vr=null)}_firstBake(){this.lightmapper.bake(null,this.scene.lightmapMode)}_firstBatch(){this.batcher.generate()}_processTimestamp(t){return t}_getDefaultDrawLayer(){return this.scene.layers.getLayerById(jt)}drawLine(t,e,s=J.WHITE,i=!0,n=this._getDefaultDrawLayer()){this._immediate.getBatch(n,i).addLines([t,e],[s,s])}drawLines(t,e,s=!0,i=this._getDefaultDrawLayer()){this._immediate.getBatch(i,s).addLines(t,e)}drawLineArrays(t,e,s=!0,i=this._getDefaultDrawLayer()){this._immediate.getBatch(i,s).addLinesArrays(t,e)}drawWireSphere(t,e,s=J.WHITE,i=20,n=!0,a=this._getDefaultDrawLayer()){this._immediate.drawWireSphere(t,e,s,i,n,a)}drawWireAlignedBox(t,e,s=J.WHITE,i=!0,n=this._getDefaultDrawLayer()){this._immediate.drawWireAlignedBox(t,e,s,i,n)}drawMeshInstance(t,e=this._getDefaultDrawLayer()){this._immediate.drawMesh(null,null,null,t,e)}drawMesh(t,e,s,i=this._getDefaultDrawLayer()){this._immediate.drawMesh(e,s,t,null,i)}drawQuad(t,e,s=this._getDefaultDrawLayer()){this._immediate.drawMesh(e,t,this._immediate.getQuadMesh(),null,s)}drawTexture(t,e,s,i,n,a,r=this._getDefaultDrawLayer()){const o=new dt;o.setTRS(new it(t,e,0),ft.IDENTITY,new it(s,i,0)),a||((a=new Io).setParameter("colorMap",n),a.shader=this._immediate.getTextureShader(),a.update()),this.drawQuad(o,a,r)}drawDepthTexture(t,e,s,i,n=this._getDefaultDrawLayer()){const a=new Io;a.shader=this._immediate.getDepthTextureShader(),a.update(),this.drawTexture(t,e,s,i,null,a,n)}destroy(){if(this._inFrameUpdate)return void(this._destroyRequested=!0);if(this.destroyed)return;const t=this.graphicsDevice.canvas.id;this.off("librariesloaded"),void 0!==e.polyfill.document&&(e.polyfill.document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),e.polyfill.document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),e.polyfill.document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),e.polyfill.document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const s=this.assets.list();for(let t=0;t<s.length;t++)s[t].unload(),s[t].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;for(const t in this.loader.getHandler("script")._cache){const e=this.loader.getHandler("script")._cache[t],s=e.parentNode;s&&s.removeChild(e)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper.destroy(),this.lightmapper=null,this.batcher.destroy(),this.batcher=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,Qa&&(Qa.destroy(),Qa=null),this.vr&&(this.vr.destroy(),this.vr=null),this.xr.end(),pu.staticDestroy(),this.renderer.destroy(),this.renderer=null,Eo.remove(this.graphicsDevice),this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),Qf.app=null,pw._applications[t]=null,Fh()===this&&Oh(null),this.destroyed=!0}getEntityFromIndex(t){return this._entityIndex[t]}}pw._applications={};const mw={},fw=function(t){const s=t;let i;return function(t,n){if(!s.graphicsDevice)return;Oh(s),i&&(e.polyfill.window.cancelAnimationFrame(i),i=null),uw=s;const a=s._processTimestamp(t)||k(),r=a-(s._time||a);let o=r/1e3;o=V.clamp(o,0,s.maxDeltaTime),o*=s.timeScale,s._time=a,s.vr&&s.vr.display?i=s.vr.display.requestAnimationFrame(s.tick):s.xr.session?i=s.xr.session.requestAnimationFrame(s.tick):e.polyfill.window.requestAnimationFrame(s.tick),s.graphicsDevice.contextLost||(s._fillFrameStatsBasic(a,o,r),s._inFrameUpdate=!0,s.fire("frameupdate",r),n?(s.xr.update(n),s.graphicsDevice.defaultFramebuffer=n.session.renderState.baseLayer.framebuffer):s.graphicsDevice.defaultFramebuffer=null,s.update(o),s.fire("framerender"),(s.autoRender||s.renderNextFrame)&&(s.updateCanvasSize(),s.render(),s.renderNextFrame=!1),mw.timestamp=k(),mw.target=s,s.fire("frameend",mw),s.fire("frameEnd",mw),s.vr&&s.vr.display&&s.vr.display.presenting&&s.vr.display.submitFrame(),s._inFrameUpdate=!1,s._destroyRequested&&s.destroy())}},_w=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*");class gw extends u{constructor(t){super(),this.initScriptType(t)}initScriptType(t){const e=this.constructor;this.app=t.app,this.entity=t.entity,this._enabled="boolean"!=typeof t.enabled||t.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=t.attributes||{},this.__scriptType=e,this.__executionOrder=-1}static __getScriptName(t){if("function"!=typeof t)return;if("name"in Function.prototype)return t.name;if(t===Function||t===Function.prototype.constructor)return"Function";const e=(""+t).match(_w);return e?e[1]:void 0}static get scriptName(){return this.__name}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new xb(this)),this.__attributes}__initializeAttributes(t){if(t||this.__attributesRaw){for(const t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(t){for(const e in t)t.hasOwnProperty(e)&&(this.prototype[e]=t[e])}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}set enabled(t){this._enabled=!!t,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,bb.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,bb.scriptMethods.postInitialize)))}}gw.__name=null;const yw=new Set(["system","entity","create","destroy","swap","move","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","has","get","on","off","fire","once","hasEvent"]);function vw(t,e){if(Qf.legacy)return null;if(yw.has(t))throw new Error(`script name: '${t}' is reserved, please change script name`);const s=function(t){u.prototype.initEventHandler.call(this),gw.prototype.initScriptType.call(this,t)};return(s.prototype=Object.create(gw.prototype)).constructor=s,s.extend=gw.extend,s.attributes=new xb(s),bw(s,t,e),s}const xw={};function bw(t,e,s){if(t.legacy)return;if("function"!=typeof t)throw new Error(`script class: '${t}' must be a constructor function (i.e. class).`);if(!(t.prototype instanceof gw))throw new Error(`script class: '${gw.__getScriptName(t)}' does not extend pc.ScriptType.`);if(e=e||t.__name||gw.__getScriptName(t),yw.has(e))throw new Error(`script name: '${e}' is reserved, please change script name`);t.__name=e;(s?s.scripts:pw.getApplication().scripts).add(t),t_._push(t)}xb.reservedNames.forEach(((t,e,s)=>{xw[t]=1})),vw.reservedAttributes=xw;class Sw{constructor(t,e){e?(this.key=e.keyCode,this.element=e.target,this.event=e):(this.key=null,this.element=null,this.event=null)}}new Sw;function ww(){return!!(e.polyfill.document.pointerLockElement||e.polyfill.document.mozPointerLockElement||e.polyfill.document.webkitPointerLockElement)}class Mw{constructor(t,e){let s={x:0,y:0};if(e){if(e instanceof Mw)throw Error("Expected MouseEvent");s=t._getTargetCoords(e)}else e={};if(s)this.x=s.x,this.y=s.y;else{if(!ww())return;this.x=0,this.y=0}this.wheelDelta=0,"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1)),ww()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),"mousedown"===e.type||"mouseup"===e.type?this.button=e.button:this.button=Xb,this.buttons=t._buttons.slice(0),this.element=e.target,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.event=e}}class Tw extends u{constructor(t){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this._target=null,this._attached=!1,this.attach(t)}static isPointerLocked(){return ww()}attach(t){if(this._target=t,!this._attached){this._attached=!0;var e=!!C.passiveEvents&&{passive:!1};this._target.addEventListener("mouseup",this._upHandler,e),this._target.addEventListener("mousedown",this._downHandler,e),this._target.addEventListener("mousemove",this._moveHandler,e),this._target.addEventListener("wheel",this._wheelHandler,e)}}detach(){this._attached&&(this._attached=!1,C.passiveEvents,this._target.removeEventListener("mouseup",this._upHandler),this._target.removeEventListener("mousedown",this._downHandler),this._target.removeEventListener("mousemove",this._moveHandler),this._target.removeEventListener("wheel",this._wheelHandler),this._target=null)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(t,s){if(!e.polyfill.document.body.requestPointerLock)return void(s&&s());const i=()=>{t(),e.polyfill.document.removeEventListener("pointerlockchange",i)},n=()=>{s(),e.polyfill.document.removeEventListener("pointerlockerror",n)};t&&e.polyfill.document.addEventListener("pointerlockchange",i,!1),s&&e.polyfill.document.addEventListener("pointerlockerror",n,!1),e.polyfill.document.body.requestPointerLock()}disablePointerLock(t){if(!e.polyfill.document.exitPointerLock)return;const s=()=>{t(),e.polyfill.document.removeEventListener("pointerlockchange",s)};t&&e.polyfill.document.addEventListener("pointerlockchange",s,!1),e.polyfill.document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(t){return this._buttons[t]}wasPressed(t){return this._buttons[t]&&!this._lastbuttons[t]}wasReleased(t){return!this._buttons[t]&&this._lastbuttons[t]}_handleUp(t){this._buttons[t.button]=!1;const e=new Mw(this,t);e.event&&this.fire(jb,e)}_handleDown(t){this._buttons[t.button]=!0;const e=new Mw(this,t);e.event&&this.fire(Gb,e)}_handleMove(t){const e=new Mw(this,t);e.event&&(this.fire(Hb,e),this._lastX=e.x,this._lastY=e.y)}_handleWheel(t){const e=new Mw(this,t);e.event&&this.fire(qb,e)}_getTargetCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);return t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?null:{x:t.clientX-s,y:t.clientY-i}}}let Aw,Cw;const Pw=new it,Rw=new it,Ew=new Vs,Lw=new Vs,Iw=new Vs;Ew.end=new it,Lw.end=new it,Iw.end=new it;const Dw=new it,Fw=new it,Ow=new it,kw=new it,Bw=new it,zw=new it,Uw=new it,Vw=new it,Nw=new it,Ww=new it,Gw=new it,Hw=new it,jw=new it,qw=new it,Xw=new it,Yw=new it,Kw=new it,$w=new it,Zw=new it,Jw=new it,Qw=new nt;function tM(t,e,s){return Gw.cross(t,e).dot(s)}class eM{constructor(t,e,s){this.event=t,this.element=e,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}class sM extends eM{constructor(t,e,s,i,n,a,r){super(t,e,s),this.x=i,this.y=n,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.button=t.button,Tw.isPointerLocked()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=i-a,this.dy=n-r),this.wheelDelta=0,"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1))}}class iM extends eM{constructor(t,e,s,i,n,a){super(t,e,s),this.touches=t.touches,this.changedTouches=t.changedTouches,this.x=i,this.y=n,this.touch=a}}class nM extends eM{constructor(t,e,s,i){super(t,e,s),this.inputSource=i}}class aM{constructor(t,e){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!e||!1!==e.useMouse,this._useTouch=!e||!1!==e.useTouch,this._useXr=!e||!1!==e.useXr,this._selectEventsAttached=!1,C.touch&&(this._clickedEntities={}),this.attach(t)}attach(t){this._attached&&(this._attached=!1,this.detach()),this._target=t,this._attached=!0;const s=!!C.passiveEvents&&{passive:!0};this._useMouse&&(e.polyfill.window.addEventListener("mouseup",this._upHandler,s),e.polyfill.window.addEventListener("mousedown",this._downHandler,s),e.polyfill.window.addEventListener("mousemove",this._moveHandler,s),e.polyfill.window.addEventListener("wheel",this._wheelHandler,s)),this._useTouch&&C.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,s),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;const t=!!C.passiveEvents&&{passive:!0};this._useMouse&&(e.polyfill.window.removeEventListener("mouseup",this._upHandler,t),e.polyfill.window.removeEventListener("mousedown",this._downHandler,t),e.polyfill.window.removeEventListener("mousemove",this._moveHandler,t),e.polyfill.window.removeEventListener("wheel",this._wheelHandler,t)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,t),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(t){-1===this._elements.indexOf(t)&&this._elements.push(t)}removeElement(t){const e=this._elements.indexOf(t);-1!==e&&this._elements.splice(e,1)}_handleUp(t){this._enabled&&(Tw.isPointerLocked()||(this._calcMouseCoords(t),null!==Aw&&this._onElementMouseEvent("mouseup",t)))}_handleDown(t){this._enabled&&(Tw.isPointerLocked()||(this._calcMouseCoords(t),null!==Aw&&this._onElementMouseEvent("mousedown",t)))}_handleMove(t){this._enabled&&(this._calcMouseCoords(t),null!==Aw&&(this._onElementMouseEvent("mousemove",t),this._lastX=Aw,this._lastY=Cw))}_handleWheel(t){this._enabled&&(this._calcMouseCoords(t),null!==Aw&&this._onElementMouseEvent("mousewheel",t))}_determineTouchedElements(t){const e={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){const n=s[i];let a=0;const r=t.changedTouches.length;for(let s=0;s<r;s++){if(e[t.changedTouches[s].identifier]){a++;continue}const i=this._calcTouchCoords(t.changedTouches[s]),r=this._getTargetElement(n,i.x,i.y);r&&(a++,e[t.changedTouches[s].identifier]={element:r,camera:n,x:i.x,y:i.y})}if(a===r)break}return e}_handleTouchStart(t){if(!this._enabled)return;const e=this._determineTouchedElements(t);for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=e[i.identifier],a=this._touchedElements[i.identifier];!n||a&&n.element===a.element||(this._fireEvent(t.type,new iM(t,n.element,n.camera,n.x,n.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=!1)}for(const t in e)this._touchedElements[t]=e[t]}_handleTouchEnd(t){if(!this._enabled)return;const e=this.app.systems.camera.cameras;for(const t in this._clickedEntities)delete this._clickedEntities[t];for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=this._touchedElements[i.identifier];if(!n)continue;const a=n.element,r=n.camera,o=n.x,h=n.y;if(delete this._touchedElements[i.identifier],delete this._touchesForWhichTouchLeaveHasFired[i.identifier],this._fireEvent(t.type,new iM(t,a,r,o,h,i)),0===t.touches.length){const s=this._calcTouchCoords(i);for(let n=e.length-1;n>=0;n--){this._getTargetElement(e[n],s.x,s.y)===a&&(this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new iM(t,a,r,o,h,i)),this._clickedEntities[a.entity.getGuid()]=!0))}}}}_handleTouchMove(t){if(t.preventDefault(),!this._enabled)return;const e=this._determineTouchedElements(t);for(let s=0,i=t.changedTouches.length;s<i;s++){const i=t.changedTouches[s],n=e[i.identifier],a=this._touchedElements[i.identifier];if(a){const e=this._calcTouchCoords(i);n&&n.element===a.element||this._touchesForWhichTouchLeaveHasFired[i.identifier]||(this._fireEvent("touchleave",new iM(t,a.element,a.camera,e.x,e.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=!0),this._fireEvent("touchmove",new iM(t,a.element,a.camera,e.x,e.y,i))}}}_onElementMouseEvent(t,e){let s;const i=this._hoveredElement;this._hoveredElement=null;const n=this.app.systems.camera.cameras;let a;for(let t=n.length-1;t>=0&&(a=n[t],s=this._getTargetElement(a,Aw,Cw),!s);t--);s&&(this._fireEvent(t,new sM(e,s,a,Aw,Cw,this._lastX,this._lastY)),this._hoveredElement=s,"mousedown"===t&&(this._pressedElement=s)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new sM(e,i,a,Aw,Cw,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new sM(e,this._hoveredElement,a,Aw,Cw,this._lastX,this._lastY))),"mouseup"===t&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new sM(e,this._hoveredElement,a,Aw,Cw,this._lastX,this._lastY))):this._pressedElement=null)}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;const t=this.app.xr.input.inputSources;for(let e=0;e<t.length;e++)this._onElementSelectEvent("selectmove",t[e],null)}_onXrInputRemove(t){const e=this._selectedElements[t.id];e&&(t._elementEntity=null,this._fireEvent("selectleave",new nM(null,e,null,t))),delete this._selectedElements[t.id],delete this._selectedPressedElements[t.id]}_onSelectStart(t,e){this._enabled&&this._onElementSelectEvent("selectstart",t,e)}_onSelectEnd(t,e){this._enabled&&this._onElementSelectEvent("selectend",t,e)}_onElementSelectEvent(t,e,s){let i;const n=this._selectedElements[e.id];let a;const r=this.app.systems.camera.cameras;let o;if(e.elementInput){Iw.set(e.getOrigin(),e.getDirection());for(let t=r.length-1;t>=0&&(o=r[t],i=this._getTargetElementByRay(Iw,o),!i);t--);}e._elementEntity=i||null,i?(this._selectedElements[e.id]=i,a=i):delete this._selectedElements[e.id],n!==a&&(n&&this._fireEvent("selectleave",new nM(s,n,o,e)),a&&this._fireEvent("selectenter",new nM(s,a,o,e))),"selectstart"===t&&(this._selectedPressedElements[e.id]=a,a&&this._fireEvent("selectstart",new nM(s,a,o,e)));const h=this._selectedPressedElements[e.id];!e.elementInput&&h&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new nM(s,n,o,e))),"selectend"===t&&e.elementInput&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new nM(s,n,o,e)),h&&h===n&&this._fireEvent("click",new nM(s,h,o,e)))}_fireEvent(t,e){let s=e.element;for(;s.fire(t,e),!e._stopPropagation&&s.entity.parent&&(s=s.entity.parent.element,s););}_calcMouseCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?(Aw=null,Cw=null):(Aw=t.clientX-s,Cw=t.clientY-i)}_calcTouchCoords(t){let e=0,s=0;t.target;return{x:t.pageX-e,y:t.pageY-s}}_sortElements(t,e){const s=this.app.scene.layers.sortTransparentLayers(t.layers,e.layers);return 0!==s?s:t.screen&&!e.screen?-1:!t.screen&&e.screen?1:t.screen||e.screen?t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?-1:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?1:e.drawOrder-t.drawOrder:0}_getTargetElement(t,e,s){let i,n,a=null,r=1/0;this._elements.sort(this._sortHandler);for(let o=0,h=this._elements.length;o<h;o++){const h=this._elements[o];if(h.screen&&h.screen.screen.screenSpace){if(void 0===i&&(i=this._calculateRayScreen(e,s,t,Ew)?Ew:null),!i)continue;if(this._checkElement(i,h,!0)>=0){a=h;break}}else{if(void 0===n&&(n=this._calculateRay3d(e,s,t,Lw)?Lw:null),!n)continue;const i=this._checkElement(n,h,!1);if(i>=0&&(i<r&&(a=h,r=i),h.screen)){a=h;break}}}return a}_getTargetElementByRay(t,e){let s=null;Ew.origin.copy(t.origin),Ew.direction.copy(t.direction),Ew.end.copy(Ew.direction).mulScalar(2*e.farClip).add(Ew.origin),this._elements.sort(this._sortHandler);for(let t=0,e=this._elements.length;t<e;t++){const e=this._elements[t];if((!e.screen||!e.screen.screen.screenSpace)&&this._checkElement(Ew,e,!1)>=0){s=e;break}}return s}_buildHitCorners(t,e,s,i,n){let a=e;if(t.entity&&t.entity.button){const e=t.entity.button.hitPadding||Qw;jw.copy(t.entity.up),qw.copy(jw).mulScalar(-1),Yw.copy(t.entity.right),Xw.copy(Yw).mulScalar(-1),jw.mulScalar(e.w*i),qw.mulScalar(e.y*i),Yw.mulScalar(e.z*s),Xw.mulScalar(e.x*s),Kw.copy(a[0]).add(qw).add(Xw),$w.copy(a[1]).add(qw).add(Yw),Zw.copy(a[2]).add(jw).add(Yw),Jw.copy(a[3]).add(jw).add(Xw),a=[Kw,$w,Zw,Jw]}if(s<0){const t=a[2].x,e=a[0].x;a[0].x=t,a[1].x=e,a[2].x=e,a[3].x=t}if(i<0){const t=a[2].y,e=a[0].y;a[0].y=t,a[1].y=t,a[2].y=e,a[3].y=e}if(n<0){const t=a[2].x,e=a[2].y,s=a[2].z;a[2].x=a[0].x,a[2].y=a[0].y,a[2].z=a[0].z,a[0].x=t,a[0].y=e,a[0].z=s}return a}_calculateScaleToScreen(t){let e=t.entity;const s=t.screen.screen.scale;for(Hw.set(s,s,s);e&&!e.screen;)Hw.mul(e.getLocalScale()),e=e.parent;return Hw}_calculateScaleToWorld(t){let e=t.entity;for(Hw.set(1,1,1);e;)Hw.mul(e.getLocalScale()),e=e.parent;return Hw}_calculateRayScreen(t,e,s,i){const n=this.app.graphicsDevice.width,a=this.app.graphicsDevice.height,r=s.rect.z*n,o=s.rect.w*a,h=s.rect.x*n,l=h+r,c=(1-s.rect.y)*a,d=c-o;let u=t*n/this._target.clientWidth,p=e*a/this._target.clientHeight;return u>=h&&u<=l&&p<=c&&p>=d&&(u=n*(u-h)/r,p=a*(p-d)/o,p=a-p,i.origin.set(u,p,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0)}_calculateRay3d(t,e,s,i){const n=this._target.clientWidth,a=this._target.clientHeight,r=s.rect.z*n,o=s.rect.w*a,h=s.rect.x*n,l=h+r,c=(1-s.rect.y)*a,d=c-o;let u=t,p=e;return t>=h&&t<=l&&e<=c&&p>=d&&(u=n*(u-h)/r,p=a*(p-d)/o,s.screenToWorld(u,p,s.nearClip,Pw),s.screenToWorld(u,p,s.farClip,Rw),i.origin.copy(Pw),i.direction.set(0,0,-1),i.end.copy(Rw),!0)}_checkElement(t,e,s){if(e.maskedBy&&this._checkElement(t,e.maskedBy.element,s)<0)return-1;let i;i=s?this._calculateScaleToScreen(e):this._calculateScaleToWorld(e);const n=this._buildHitCorners(e,s?e.screenCorners:e.worldCorners,i.x,i.y,i.z);return function(t,e,s){Dw.sub2(e,t),Fw.sub2(s[0],t),Ow.sub2(s[1],t),kw.sub2(s[2],t),zw.cross(kw,Dw);let i,n,a=Fw.dot(zw);if(a>=0){if(i=-Ow.dot(zw),i<0)return-1;if(n=tM(Dw,Ow,Fw),n<0)return-1;const t=1/(i+a+n);Uw.copy(s[0]).mulScalar(i*t),Vw.copy(s[1]).mulScalar(a*t),Nw.copy(s[2]).mulScalar(n*t),Ww.copy(Uw).add(Vw).add(Nw)}else{if(Bw.sub2(s[3],t),i=Bw.dot(zw),i<0)return-1;if(n=tM(Dw,Fw,Bw),n<0)return-1;a=-a;const e=1/(i+a+n);Uw.copy(s[0]).mulScalar(i*e),Vw.copy(s[3]).mulScalar(a*e),Nw.copy(s[2]).mulScalar(n*e),Ww.copy(Uw).add(Vw).add(Nw)}return Dw.sub2(s[0],s[2]).lengthSq()<1e-8||Dw.sub2(s[1],s[3]).lengthSq()<1e-8?-1:Ww.sub(t).lengthSq()}(t.origin,t.end,n)}get enabled(){return this._enabled}set enabled(t){this._enabled=t}get app(){return this._app||Fh()}set app(t){this._app=t}}function rM(t){let e=0,s=0;t.target;return{x:t.pageX-e,y:t.pageY-s}}class oM{constructor(t){const e=rM(t);this.id=t.identifier,this.x=e.x,this.y=e.y,this.target=t.target,this.touch=t}}class hM{constructor(t,e){if(this.element=e.target,this.event=e,this.touches=[],this.changedTouches=[],e){for(let t=0,s=e.touches.length;t<s;t++)this.touches.push(new oM(e.touches[t]));for(let t=0,s=e.changedTouches.length;t<s;t++)this.changedTouches.push(new oM(e.changedTouches[t]))}}getTouchById(t,e){for(let s=0,i=e.length;s<i;s++)if(e[s].id===t)return e[s];return null}}class lM extends u{constructor(t){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t)}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(t){this.fire("touchstart",new hM(this,t))}_handleTouchEnd(t){this.fire("touchend",new hM(this,t))}_handleTouchMove(t){t.preventDefault(),this.fire("touchmove",new hM(this,t))}_handleTouchCancel(t){this.fire("touchcancel",new hM(this,t))}}class cM extends ld{constructor(t,e){super(t,e)}}Object.defineProperty(ld.prototype,"components",{get:function(){return this.c}}),ld.prototype.getComponent=function(t){return this.c[t]},ld.prototype.hasComponent=function(t){return!!this.c[t]};class dM extends u{constructor(t){super(),this.app=t,this.destroyed=!1,this._stores=new Set}get stores(){return this._stores}onInitialize(){}onPostInitialize(){}onUpdate(){}onDestroy(){this.destroyed=!0,this.fire("destroy")}beforeConnectStore(t){}connectStore(t){}beforeDisconnectStore(t){}disconnectStore(t){}}const uM={};class pM extends AS{constructor(t,e){super(t,e),this._meshInstances=null,this._type="resource",this._resource=null,this._model=null,this._lightmapped=!1,this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[Wt],this._batchGroupId=-1,this._materialAsset=null,this._material=Eo.get(this.app.graphicsDevice),this._mapping={},e.on("remove",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this)}addModelToLayers(){for(var t,e=this.app.scene.layers,s=0;s<this._layers.length;s++)(t=e.getLayerById(this._layers[s]))&&t.addMeshInstances(this.meshInstances)}removeModelFromLayers(){for(var t,e=this.app.scene.layers,s=0;s<this._layers.length;s++)(t=e.getLayerById(this._layers[s]))&&t.removeMeshInstances(this.meshInstances)}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.container.enabled&&this.addModelToLayers()}onLayersChanged(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this.meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this.meshInstances)}_setMaterialEvent(t,e,s,i){var n=e+":"+s;this.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[t]||(this._materialEvents[t]={}),this._materialEvents[t][n]={id:s,handler:i}}_unsetMaterialEvents(){var t=this.app.assets,e=this._materialEvents;if(e){for(var s=0,i=e.length;s<i;s++)if(e[s]){var n=e[s];for(var a in n)t.off(a,n[a].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(t){var e=null;if(isNaN(parseInt(t,10))){if(this.resource){var s=this._getMaterialAssetUrl(t);s&&(e=this.app.assets.getByUrl(s))}}else e=this.app.assets.get(t);return e}_getMaterialAssetUrl(t){if(!this.resource)return null;var e=this.app.assets.get(this.resource);return e?e.getAbsoluteUrl(t):null}_loadAndSetMeshInstanceMaterial(t,e,s){var i=this.app.assets;t&&(t.resource?(e.material=t.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=Eo.get(this.app.graphicsDevice)}))):(this._setMaterialEvent(s,"load",t.id,(function(i){e.material=i.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=Eo.get(this.app.graphicsDevice)}))})),this.enabled&&this.container.enabled&&i.load(t)))}onEnable(){var t=this.app,e=t.scene;e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));var s,i="resource"===this._type;this._model?this.addModelToLayers():i&&this._resource&&(s=t.assets.get(this._resource))&&s.resource!==this._model&&this._bindModelAsset(s),this._materialAsset&&(s=t.assets.get(this._materialAsset))&&s.resource!==this._material&&this._bindMaterialAsset(s),this._batchGroupId>=0&&t.batcher.insert(tl.MODEL,this.batchGroupId,this.container)}onDisable(){var t=this.app,e=t.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&t.batcher.remove(tl.MODEL,this.batchGroupId,this.container),this._model&&this.removeModelFromLayers()}_bindMaterialAsset(t){if(t.on("load",this._onMaterialAssetLoad,this),t.on("unload",this._onMaterialAssetUnload,this),t.on("remove",this._onMaterialAssetRemove,this),t.on("change",this._onMaterialAssetChange,this),t.resource)this._onMaterialAssetLoad(t);else{if(!this.enabled||!this.container.enabled)return;this.app.assets.load(t)}}_unbindMaterialAsset(t){t.off("load",this._onMaterialAssetLoad,this),t.off("unload",this._onMaterialAssetUnload,this),t.off("remove",this._onMaterialAssetRemove,this),t.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(t){this.app.assets.off("add:"+t.id,this._onMaterialAssetAdd,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_onMaterialAssetLoad(t){this._setMaterial(t.resource)}_onMaterialAssetUnload(t){this._setMaterial(Eo.get(this.app.graphicsDevice))}_onMaterialAssetRemove(t){this._onMaterialAssetUnload(t)}_onMaterialAssetChange(t){}_bindModelAsset(t){if(this._unbindModelAsset(t),t.on("load",this._onModelAssetLoad,this),t.on("unload",this._onModelAssetUnload,this),t.on("change",this._onModelAssetChange,this),t.on("remove",this._onModelAssetRemove,this),t.resource)this._onModelAssetLoad(t);else{if(!this.enabled||!this.container.enabled)return;this.app.assets.load(t)}}_unbindModelAsset(t){t.off("load",this._onModelAssetLoad,this),t.off("unload",this._onModelAssetUnload,this),t.off("change",this._onModelAssetChange,this),t.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(t){this.app.assets.off("add:"+t.id,this._onModelAssetAdd,this),t.id===this._resource&&this._bindModelAsset(t)}_onModelAssetLoad(t){this.model=t.resource.clone(),this._mapping=JSON.parse(JSON.stringify(t.data)),this._clonedModel=!0}_onModelAssetUnload(t){this.model=null}_onModelAssetChange(t,e,s,i){"data"===e&&(this.mapping=s)}_onModelAssetRemove(t){this.model=null}_setMaterial(t){if(this._material!==t){this._material=t;var e=this._model;if(e&&"resource"!==this._type)for(var s=e.meshInstances,i=0,n=s.length;i<n;i++)s[i].material=t}}}pM.properties=["material","materialAsset","resource","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],CS(pM.prototype,"type",{set:function(t){if(this._type!==t){var e=null;if(this._area=null,this._type=t,"resource"===t)null!==this._resource?this._bindModelAsset(this._resource):this.model=null;else{var s=this.app.graphicsDevice;switch(t){case"box":uM.box||(uM.box=$h(s,{halfExtents:new it(.5,.5,.5)})),e=uM.box,this._area={x:2,y:2,z:2,uv:2/3};break;case"capsule":uM.capsule||(uM.capsule=qh(s,{radius:.5,height:2})),e=uM.capsule,this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":uM.cone||(uM.cone=Xh(s,{baseRadius:.5,peakRadius:0,height:1})),e=uM.cone,this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":uM.cylinder||(uM.cylinder=jh(s,{radius:.5,height:1})),e=uM.cylinder,this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":uM.plane||(uM.plane=Kh(s,{halfExtents:new st(.5,.5),widthSegments:1,lengthSegments:1})),e=uM.plane,this._area={x:0,y:1,z:0,uv:1};break;case"sphere":uM.sphere||(uM.sphere=Yh(s,{radius:.5})),e=uM.sphere,this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw new Error("Invalid model type: "+t)}var i=new jr,n=new vd;n.graph=i,n.meshInstances=[new dl(i,e,this._material)],this.model=n,this._resource=null}}}}),CS(pM.prototype,"resource",{set:function(t){var e=this.app.assets,s=t;if(t instanceof wm&&(s=t.id),this._resource!==s){if(this._resource){e.off("add:"+this._resource,this._onModelAssetAdded,this);var i=e.get(this._resource);i&&this._unbindModelAsset(i)}if(this._resource=s,this._resource){var n=e.get(this._resource);n?this._bindModelAsset(n):(this.model=null,e.on("add:"+this._resource,this._onModelAssetAdded,this))}else this.model=null}}}),CS(pM.prototype,"model",{set:function(t){var e;if(this._model!==t&&(!t||!t._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.container.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=t,this._model)){this._model._immutable=!0,this.meshInstances=this._model.meshInstances;var s=this.meshInstances;for(e=0;s&&e<s.length;e++)s[e].castShadow=this._castShadows,s[e].receiveShadow=this._receiveShadows,s[e].isStatic=this._isStatic;this.lightmapped=this._lightmapped,this.container.addChild(this._model.graph),this.enabled&&this.container.enabled&&this.addModelToLayers(),this._model._entity=this.container,this.container.hasComponent("animation")&&this.container.getComponent("animation").setModel(this._model),this.container.hasComponent("anim")&&this.container.getComponent("anim").resetStateGraph(),"resource"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}}),CS(pM.prototype,"lightmapped",{set:function(t){var e,s,i;if(t!==this._lightmapped&&(this._lightmapped=t,this._model)){var n=this.meshInstances;if(t)for(e=0;e<n.length;e++)i=(s=n[e]).mask,s.mask=(i|MASK_BAKED)&~(MASK_DYNAMIC|MASK_LIGHTMAP);else for(e=0;e<n.length;e++)(s=n[e]).deleteParameter("texture_lightMap"),s.deleteParameter("texture_dirLightMap"),s._shaderDefs&=~SHADERDEF_LM,i=s.mask,s.mask=(i|MASK_DYNAMIC)&~(MASK_BAKED|MASK_LIGHTMAP)}}}),CS(pM.prototype,"castShadows",{set:function(t){if(this._castShadows!==t){var e,s,i=this._model;if(i){var n=this.layers,a=this.app.scene;if(this._castShadows&&!t)for(s=0;s<n.length;s++)(e=a.layers.getLayerById(this.layers[s]))&&e.removeShadowCasters(i.meshInstances);var r=i.meshInstances;for(s=0;s<r.length;s++)r[s].castShadow=t;if(!this._castShadows&&t)for(s=0;s<n.length;s++)(e=a.layers.getLayerById(n[s]))&&e.addShadowCasters(i.meshInstances)}this._castShadows=t}}}),CS(pM.prototype,"receiveShadows",{set:function(t){if(this._receiveShadows!==t&&(this._receiveShadows=t,this._model))for(var e=this.meshInstances,s=0,i=e.length;s<i;s++)e[s].receiveShadow=t}}),CS(pM.prototype,"castShadowsLightmap"),CS(pM.prototype,"lightmapSizeMultiplier"),CS(pM.prototype,"isStatic",{set:function(t){var e;if(this._isStatic!==t&&(this._isStatic=t,this.meshInstances)){var s=this.meshInstances;for(e=0;e<s.length;e++)s[e].isStatic=t}}}),CS(pM.prototype,"layers",{set:function(t){var e,s,i=this.app.scene.layers;if(this.meshInstances)for(e=0;e<this._layers.length;e++)(s=i.getLayerById(this._layers[e]))&&s.removeMeshInstances(this.meshInstances);for(this._layers.length=0,e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.container.enabled&&this.meshInstances)for(e=0;e<this._layers.length;e++)(s=i.getLayerById(this._layers[e]))&&s.addMeshInstances(this.meshInstances)}}),CS(pM.prototype,"batchGroupId",{set:function(t){if(this._batchGroupId!==t){var e=this.app.batcher;this.container.enabled&&this._batchGroupId>=0&&e.remove(tl.MODEL,this.batchGroupId,this.container),this.container.enabled&&t>=0&&e.insert(tl.MODEL,t,this.container),t<0&&this._batchGroupId>=0&&this.enabled&&this.container.enabled&&this.addModelToLayers(),this._batchGroupId=t}}}),CS(pM.prototype,"materialAsset",{set:function(t){var e=t;t instanceof wm&&(e=t.id);var s=this.app.assets;if(e!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var i=s.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}if(this._materialAsset=e,this._materialAsset){var n=s.get(this._materialAsset);n?this._bindMaterialAsset(n):(this._setMaterial(Eo.get(this.app.graphicsDevice)),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(Eo.get(this.app.graphicsDevice))}}}),CS(pM.prototype,"material",{set:function(t){this._material!==t&&(this.materialAsset=null,this._setMaterial(t))}}),CS(pM.prototype,"mapping",{set:function(t){if("resource"!==this._type)return;if(this._unsetMaterialEvents(),t||(t={}),!this._model)return;if(!t.nodes||!t.meshes)return;var e=(t,s)=>{t.resource?s.material=t.resource:(t.once("load",e),assets.load(t)),t.once("remove",(t=>{s.material===t.resource&&(s.material=Eo.get(this.app.graphicsDevice))}))};let s=0;for(let i=0;i<t.nodes.length;i++){const n=t.nodes[i];if(n.hasOwnProperty("mesh")){const i=t.meshes[n.mesh];for(let t=0;t<i.primitives.length;t++){const n=i.primitives[t].material;if(n){const t=this.app.assets.get(n);t&&e(t,this.meshInstances[s])}else this.meshInstances[s].material=Eo.get(this.app.graphicsDevice);s++}}}this._mapping=t}}),ES.regist(pM,"model");class mM extends dM{connectStore(t){t.c.model.onEnable()}disconnectStore(t){t.c.model.onDisable()}onRemove(t){let e=t.model;"resource"===e.type?e.resource=null:e.model=null,e.materialAsset=null,e._unsetMaterialEvents(),t.off("remove",e.onRemoveChild),t.off("insert",e.onInsertChild)}}DS.regist(mM,"model");class fM extends u{constructor(t,e,s){if(super(),!(t&&t instanceof AS))throw new Error("The parentComponent argument is required and must be a Component");if(!e||"string"!=typeof e)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=t,this._containerPropertyName=e,this._container=null,this._app=t.app,this._configureEventListeners(s||{},{"container#destroy":this._onContainerDestroy}),this._toggleLifecycleListeners("on")}get container(){return this._container}_configureEventListeners(t,e){const s=this._parseEventListenerConfig(t,"external",this._parentComponent),i=this._parseEventListenerConfig(e,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(t,e,s){return Object.keys(t).map(((i,n)=>{const a=i.split("#"),r=a[0],o=a[1],h=t[i];if(2!==a.length||"string"!=typeof r||0===r.length||"string"!=typeof o||0===o.length)throw new Error("Invalid event listener description: `"+i+"`");if("function"!=typeof h)throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:e+"_"+n+"_"+i,sourceName:r,eventName:o,callback:h,scope:s}}),this)}onParentComponentEnable(){this._container||this._updateContainerReference()}_toggleLifecycleListeners(t){this._parentComponent[t]("set_"+this._containerPropertyName,this._onSetContainer,this),this._app.systemRegist[t]("postinitialize",this._onPostInitialize,this);const e=[];for(let t=0;t<this._eventListenerConfigs.length;t++){const s=this._eventListenerConfigs[t],i=this._app.systemRegist.get(s.sourceName);i&&(-1===e.indexOf(i)&&e.push(i),i&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),i&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(var s=0;s<e.length;++s)e[s][t]("connect",this._onComponentAdd,this),e[s][t]("beforedisconnect",this._onComponentRemove,this)}_onPostInitialize(){this._updateContainerReference()}_onSetContainer(t,e,s){if(s instanceof cM)this._updateContainerReference();else{if(null!=s&&"string"!=typeof s)return void console.warn("Entity field `"+this._containerPropertyName+"` was set to unexpected type '"+typeof s+"'");e!==s&&this._updateContainerReference()}}_onComponentAdd(t,e){var s=this._parentComponent.constructor.type;e===this._container&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(t){var e=this._parentComponent.constructor.type;t===this._container&&(this._callGainOrLoseListener(e,this._loseListeners),this._toggleComponentListeners("off",e,!0))}_updateContainerReference(){let t,e=this._parentComponent[this._containerPropertyName];if(e instanceof cM)t=e,e=t.getGuid(),this._parentComponent[this._containerPropertyName]=e;else{const s=this._app.root;t=this._parentComponent.container.isDescendantOf(s)&&e?s.findByGuid(e):null}this._container!==t&&(this._container&&this._onBeforeContainerChange(),this._container=t,this._container&&this._onAfterContainerChange(),this.fire("set:container",this._container))}_onBeforeContainerChange(){this._toggleContainerListeners("off"),this._callAllGainOrLoseListeners(this._gainListeners)}_onAfterContainerChange(){this._toggleContainerListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_callAllGainOrLoseListeners(t){for(let e in this._container.c)this._callGainOrLoseListener(e,t)}_callGainOrLoseListener(t,e){if(this._container.hasComponent(t)&&e[t]){const s=e[t];s.callback.call(s.scope)}}_toggleContainerListeners(t,e){if(this._container)for(let s=0;s<this._eventListenerConfigs.length;s++)this._safeToggleListener(t,this._eventListenerConfigs[s],e)}_toggleComponentListeners(t,e,s){for(var i=0;i<this._eventListenerConfigs.length;++i){var n=this._eventListenerConfigs[i];n.sourceName===e&&this._safeToggleListener(t,n,s)}}_safeToggleListener(t,e,s){var i="on"===t;if(!i||!this._listenerStatusFlags[e.id]){var n=this._getEventSource(e.sourceName,s);n&&(n[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=i)}}_onContainerDestroy(t){this._container===t&&(this._toggleContainerListeners("off",!0),this._container=null)}_getEventSource(t,e){if("container"===t)return this._container;let s=this._container.getComponent(t);return s||(e||console.warn("Container has no component with name "+t),null)}}class _M extends AS{constructor(t,e){super(t,e),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._batchGroupId=-1,this._rootBone=null,this._meshInstances=[],this._layers=[Wt],this._renderStyle=ve,this._customAabb=null,this._area=null,this._material=Eo.get(this.app.graphicsDevice),this._defaultMaterial=Eo.get(this.app.graphicsDevice),this._materialReferences=[],this._bone=new fM(this,"rootBone"),this._bone.on("set:container",this._onSetRootBone,this),this._assetReference=new Nf("asset",this,this.app.assets,{add:this._onRenderAssetAdd,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}_onRenderAssetAdd(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.container.enabled&&this.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){var t=this._assetReference.asset.resource;t.off("set:meshes",this._onSetMeshes,this),t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetRootBone(t){t&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this._cloneSkinInstances()}_onSetMeshes(t){this._cloneMeshes(t)}_cloneMeshes(t){if(t&&t.length){for(var e=[],s=0;s<t.length;s++){var i=t[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,a=new dl(i,n||this._defaultMaterial,this.container);e.push(a),i.morph&&(a.morphInstance=new yd(i.morph))}this.meshInstances=e,this._cloneSkinInstances()}}_cloneSkinInstances(){if(this._meshInstances.length&&this._bone.container instanceof jr&&this._bone.container.enabled)for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t],s=e.mesh;s.skin&&!s.skinInstance&&(e.skinInstance=Tm.createCachedSkinedInstance(s.skin,this._rootBone.container,this.container))}}_clearSkinInstances(){for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t];Tm.removeCachedSkinInstance(e.skinInstance),e.skinInstance=null}}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.container.enabled&&this.app.assets.load(this._assetReference.asset))}_onMaterialAdded(t,e,s){s.resource?this._onMaterialLoad(t,e,s):this.enabled&&this.entity.enabled&&this.app.assets.load(s)}_onMaterialLoad(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=s.resource)}_onMaterialRemove(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this._defaultMaterial)}_onMaterialUnload(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this._defaultMaterial)}destroyMeshInstances(){const t=this._meshInstances;if(t){this.removeFromLayers(),this._clearSkinInstances();for(var e=0;e<t.length;e++)t[e].destroy();this._meshInstances.length=0}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){let t,e=this.app.scene.layers;for(let s=0;s<this._layers.length;s++)t=e.getLayerById(this._layers[s]),t&&t.removeMeshInstances(this._meshInstances)}}addToLayers(){const t=this.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this._meshInstances)}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.container.enabled&&this.addToLayers()}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this._layers.indexOf(t.id)<0||t.addMeshInstances(this._meshInstances)}onLayerRemoved(t){this._layers.indexOf(t.id)<0||t.removeMeshInstances(this._meshInstances)}onEnable(){this._bone.onParentComponentEnable()}onConnect(){const t=this.app,e=this.app.scene;this._bone.onParentComponentEnable(),e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdd();for(let e=0;e<this._materialReferences.length;e++){const s=this._materialReferences[e];s.asset&&t.assets.load(s.asset)}this._batchGroupId>=0&&t.batcher.insert(tl.RENDER,this._batchGroupId,this.container)}onDisconnect(){const t=this.app,e=this.app.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&t.batcher.remove(tl.RENDER,this._batchGroupId,this.entity),this.removeFromLayers()}show(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!1}hide(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!0}get rootBone(){return this._rootBone}set rootBone(t){this._rootBone=t}get renderStyle(){return this._renderStyle}set renderStyle(t){this._renderStyle!==t&&(this._renderStyle=t,dl._prepareRenderStyleForArray(this._meshInstances,t))}get customAabb(){return this._customAabb}set customAabb(t){this._customAabb=t;var e=this._meshInstances;if(e)for(var s=0;s<e.length;s++)e[s].setCustomAabb(this._customAabb)}get type(){return this._type}set type(t){if(this._type!==t&&(this._area=null,this._type=t,this.destroyMeshInstances(),"asset"!==t)){let e=this._material;if(!e||e==this._defaultMaterial){const t=this._materialReferences[0];e=t&&t.asset&&t.asset.resource}const s=Zh(this.app.graphicsDevice,t);this._area=s.area,this.meshInstances=[new dl(s.mesh,e||this._defaultMaterial,this.container)]}}get meshInstances(){return this._meshInstances}set meshInstances(t){if(this.destroyMeshInstances(),this._meshInstances=t,this._meshInstances){const t=this._meshInstances;for(let e=0;e<t.length;e++)t[e].node||(t[e].node=this.container),t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic,t[e].renderStyle=this._renderStyle,t[e].setLightmapped(this._lightmapped),t[e].setCustomAabb(this._customAabb);this.enabled&&this.container.enabled&&this.addToLayers()}}get lightmapped(){return this._lightmapped}set lightmapped(t){if(t!==this._lightmapped){this._lightmapped=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get castShadows(){return this._castShadows}set castShadows(t){if(this._castShadows!==t){let e,s,i=this._meshInstances;if(i){const n=this._layers,a=this.app.scene;if(this._castShadows&&!t)for(e=0;e<n.length;e++)s=a.layers.getLayerById(n[e]),s&&s.removeShadowCasters(i);for(e=0;e<i.length;e++)i[e].castShadow=t;if(!this._castShadows&&t)for(e=0;e<n.length;e++)s=a.layers.getLayerById(n[e]),s&&s.addShadowCasters(i)}this._castShadows=t}}get receiveShadows(){return this._receiveShadows}set receiveShadows(t){if(this._receiveShadows!==t){this._receiveShadows=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].receiveShadow=t}}get castShadowsLightmap(){return this._castShadowsLightmap}set castShadowsLightmap(t){this._castShadowsLightmap=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get isStatic(){return this._isStatic}set isStatic(t){if(this._isStatic!==t){this._isStatic=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].isStatic=t}}get layers(){return this._layers}set layers(t){let e,s,i=this.app.scene.layers;if(this._meshInstances)for(e=0;e<this._layers.length;e++)s=i.getLayerById(this._layers[e]),s&&s.removeMeshInstances(this._meshInstances);for(this._layers.length=0,e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.container.enabled&&this._meshInstances)for(e=0;e<this._layers.length;e++)s=i.getLayerById(this._layers[e]),s&&s.addMeshInstances(this._meshInstances)}get batchGroupId(){return this._batchGroupId}set batchGroupId(t){if(this._batchGroupId!==t){const e=this.app.batcher;this.container.enabled&&this._batchGroupId>=0&&e.remove(tl.RENDER,this.batchGroupId,this.container),this.container.enabled&&t>=0&&e.insert(tl.RENDER,t,this.container),t<0&&this._batchGroupId>=0&&this.enabled&&this.container.enabled&&this.addToLayers(),this._batchGroupId=t}}get material(){return this._material}set material(t){if(this._material!==t&&(this._material=t,this._meshInstances&&"asset"!==this._type))for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].material=t}get materialAssets(){return this._materialReferences.map((t=>t.id))}set materialAssets(t){let e;if(t=t||[],this._materialReferences.length>t.length){for(e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this._materialReferences.length=t.length}for(e=0;e<t.length;e++)if(this._materialReferences[e]||this._materialReferences.push(new Nf(e,this,this.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),t[e]){var s=t[e]instanceof wm?t[e].id:t[e];this._materialReferences[e].id!==s&&(this._materialReferences[e].id=s),this._materialReferences[e].asset&&this._onMaterialAdded(e,this,this._materialReferences[e].asset)}else this._materialReferences[e].id=null,this._meshInstances[e]&&(this._meshInstances[e].material=this._defaultMaterial)}get asset(){return this._assetReference.id}set asset(t){var e=t instanceof wm?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onRenderAssetAdded())}}_M.properties=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId",{name:"rootBone",type:"container"}],ES.buildAccessors(_M.prototype,_M.properties),ES.regist(_M,"render");class gM extends dM{constructor(t){super(t)}connectStore(t){t.c.render.onConnect()}disconnectStore(t){t.c.render.onDisconnect()}onDestroy(t){t.c.render.destroyMeshInstances()}}DS.regist(gM,"render");class yM extends AS{constructor(t,e){super(t,e),this._camera=new Rr,this._camera.node=e,this._priority=0,this._postEffects=new wy(t,this),this._aspectRatio=0,this._aspectRatioMode=Es,this._clearColor=new J,this._clearColorBuffer=!0,this._clearDepthBuffer=!0,this._clearStencilBuffer=!0,this._farClip=1e3,this._nearClip=.1,this._fov=45,this._orthoHeight=10,this._rect=new nt(0,0,1,1),this._scissorRect=new nt(0,0,1,1),this._calculateTransform=null,this._calculateProjection=null,this._cullFaces=!0,this._flipFaces=!1,this._layers=[Wt,Gt,Ht,qt,jt]}get camera(){return this._camera}dirtyLayerCompositionCameras(){this.app.scene.layers._dirtyCameras=!0}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set disablePostEffectsLayer(t){this._disablePostEffectsLayer=t,this.dirtyLayerCompositionCameras()}get postEffectsEnabled(){return this._postEffects.enabled}screenToWorld(t,e,s,i){var n=this.app.graphicsDevice,a=n.clientRect.width,r=n.clientRect.height;return this._camera.screenToWorld(t,e,s,a,r,i)}worldToScreen(t,e){var s=this.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(t,i,n,e)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){for(var t=this.layers,e=0;e<t.length;e++){var s=this.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}removeCameraFromLayers(){for(var t=this.layers,e=0;e<t.length;e++){var s=this.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}}onLayersChanged(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addCamera(this)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeCamera(this)}onEnable(){var t=this.app.scene,e=t.layers;t.on("set:layers",this.onLayersChanged,this),e&&(e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)),this.enabled&&this.container.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){var t=this.app.scene,e=t.layers;this.postEffects.disable(),this.removeCameraFromLayers(),t.off("set:layers",this.onLayersChanged,this),e&&(e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this))}onRemove(){this.onDisable(),this.off()}calculateAspectRatio(t){var e=t||this.app.graphicsDevice,s=this.rect;return e.width*s.z/(e.height*s.w)}frameBegin(t){this.aspectRatioMode===Es&&(this.aspectRatio=this.calculateAspectRatio(t))}frameEnd(){}enterVr(t,e){if(t instanceof Function&&!e&&(e=t,t=null),this.app.vr)if(t||(t=this.app.vr.display),t){var s=this;t.capabilities.canPresent?t.requestPresent((function(i){i||(s.vrDisplay=t,s.vrDisplay.once("beforepresentchange",(function(t){t.presenting||(s.vrDisplay=null)}))),e(i)})):(s.vrDisplay=t,e())}else e("No pc.VrDisplay to present");else e("VrManager not created. Enable VR in project settings.")}exitVr(t){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var e=this.vrDisplay;this.vrDisplay=null,e.exitPresent(t)}else this.vrDisplay=null,t();else t("Not presenting VR")}startXr(t,e,s){this.app.xr.start(this,t,e,s)}endXr(t){this._camera.xr?this._camera.xr.end(t):t&&t(new Error("Camera is not in XR"))}}yM.properties=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform",{name:"clearColor",type:"rgba"},"clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority",{name:"rect",type:"vec4"},{name:"scissorRect",type:"vec4"}],[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustum",readonly:!0},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"projectionMatrix",readonly:!0},{name:"rect",readonly:!1},{name:"scissorRect",readonly:!1},{name:"viewMatrix",readonly:!0},{name:"vrDisplay",readonly:!1}].forEach((function(t){var e=t.name,s={get:function(){return this._camera[e]}};t.readonly||(s.set=function(t){this._camera[e]=t}),CS(yM.prototype,e,s)})),CS(yM.prototype,"layers",{get:function(){return this._camera.layers},set:function(t){var e,s,i=this._camera.layers;for(e=0;e<i.length;e++)(s=this.app.scene.layers.getLayerById(i[e]))&&s.removeCamera(this);if(this._camera.layers=t,this.enabled&&this.container.enabled)for(e=0;e<t.length;e++)(s=this.app.scene.layers.getLayerById(t[e]))&&s.addCamera(this)}}),CS(yM.prototype,"postEffects",{get:function(){return this._postEffects}}),CS(yM.prototype,"priority",{get:function(){return this._priority},set:function(t){this._priority=t,this.dirtyLayerCompositionCameras()}}),CS(yM.prototype,"clearColorBuffer",{get:function(){return this._camera.clearColorBuffer},set:function(t){this._camera.clearColorBuffer=t,this.dirtyLayerCompositionCameras()}}),CS(yM.prototype,"clearDepthBuffer",{get:function(){return this._camera.clearDepthBuffer},set:function(t){this._camera.clearDepthBuffer=t,this.dirtyLayerCompositionCameras()}}),CS(yM.prototype,"clearStencilBuffer",{get:function(){return this._camera.clearStencilBuffer},set:function(t){this._camera.clearStencilBuffer=t,this.dirtyLayerCompositionCameras()}}),CS(yM.prototype,"renderTarget",{get:function(){return this._camera.renderTarget},set:function(t){this._camera.renderTarget=t,this.dirtyLayerCompositionCameras()}}),ES.regist(yM,"camera");class vM extends dM{constructor(t){super(t),this.cameras=[],this.app.on("prerender",this.onAppPrerender,this)}connectStore(t){let e=t.c.camera;e.onEnable(),this.addCamera(e)}disconnectStore(t){let e=t.c.camera;e.onDisable(),this.removeCamera(e)}onAppPrerender(){for(var t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()}addCamera(t){this.cameras.push(t),this.sortCamerasByPriority()}removeCamera(t){var e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this.sortCamerasByPriority())}sortCamerasByPriority(){this.cameras.sort((function(t,e){return t.priority-e.priority}))}}DS.regist(vM,"camera");class xM extends AS{constructor(t,e){super(t,e),this.animationsIndex={},this._assets=[],this._speed=1,this._loop=!0,this._activate=!0,this._animations={},this._graph=null,this._prevAnim=null,this._currAnim=null,this._blending=!1,this._blend=0,this._blendSpeed=0,this._playing=!1,this._skeleton=null,this._fromSkel=null,this._toSkel=null,this._animEvaluator=null}play(t,e){this._play(t,e),this.fire("play",t)}_play(t,e){if(this.enabled&&this.container.enabled){var s=this;if(s.animations[t]){if(e=e||0,s.prevAnim=s.currAnim,s.currAnim=t,s.graph){s.skeleton||s.animEvaluator||this._createAnimationController();var i=s.animations[s.prevAnim],n=s.animations[s.currAnim];if(s.blending=e>0&&s.prevAnim,s.blending&&(s.blend=0,s.blendSpeed=1/e),s.skeleton&&(s.blending?(s.fromSkel.animation=i,s.fromSkel.addTime(s.skeleton._time),s.toSkel.animation=n):s.skeleton.animation=n),s.animEvaluator){var a=s.animEvaluator;if(s.blending)for(;a.clips.length>1;)a.removeClip(0);else s.animEvaluator.removeClips();var r=new ju(s.animations[s.currAnim],0,1,!0,s.loop);r.name=s.currAnim,r.blendWeight=s.blending?0:1,r.reset(),s.animEvaluator.addClip(r)}}s.playing=!0}}}resume(t,e){let s=this.currentTime;this._play(t,e),this.currentTime=s,this.fire("resume",t)}pause(){this.playing=!1,this.fire("pause",this.currAnim)}stop(){this.currentTime=0,this.playing=!1,this.fire("stop")}getAnimation(t){return this.animations[t]}setGraph(t){var e=this;t!==e.graph&&(this._resetAnimationController(),e.graph=t,e.animations&&e.currAnim&&e.animations[e.currAnim]&&this.play(e.currAnim))}_resetAnimationController(){var t=this;t.skeleton=null,t.fromSkel=null,t.toSkel=null,t.animEvaluator=null}_createAnimationController(){var t=this,e=t.graph,s=t.animations,i=!1,n=!1;for(var a in s){if(s.hasOwnProperty(a))s[a].constructor===Sp?n=!0:i=!0}i?(t.fromSkel=new zu(e),t.toSkel=new zu(e),t.skeleton=new zu(e),t.skeleton.looping=t.loop,t.skeleton.setGraph(e)):n&&(t.animEvaluator=new vp(new wp(e)))}loadAnimationAssets(t){if(t&&t.length){var e,s=this,i=this.app.assets,n=t.length,a=function(t){if(t.resources.length>1)for(var e=0;e<t.resources.length;e++)s.animations[t.resources[e].name]=t.resources[e],s.animationsIndex[t.id]=t.resources[e].name;else s.animations[t.name]=t.resource,s.animationsIndex[t.id]=t.name;s.animations=s.animations},r=function(t){t.off("change",s.onAssetChanged,s),t.on("change",s.onAssetChanged,s),t.off("remove",s.onAssetRemoved,s),t.on("remove",s.onAssetRemoved,s),t.resource?a(t):(t.once("load",a,s),s.enabled&&s.entity.enabled&&i.load(t))};for(e=0;e<n;e++){var o=i.get(t[e]);o?r(o):i.on("add:"+t[e],r)}}}onAssetChanged(t,e,s,i){var n;if("resource"===e||"resources"===e)if(s){var a=!1;if(s.length>1){if(i&&i.length>1)for(n=0;n<i.length;n++)delete this.animations[i[n].name];else delete this.animations[t.name];for(a=!1,n=0;n<s.length;n++)this.animations[s[n].name]=s[n],a||this.currAnim!==s[n].name||this.playing&&this.enabled&&this.container.enabled&&(a=!0,this.play(s[n].name,0));a||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(n=0;n<i.length;n++)delete this.animations[i[n].name];this.animations[t.name]=s[0]||s,a=!1,this.currAnim===t.name&&this.playing&&this.enabled&&this.container.enabled&&(a=!0,this.play(t.name,0)),a||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[t.id]=t.name}else{if(i.length>1)for(n=0;n<i.length;n++)delete this.animations[i[n].name];else delete this.animations[t.name];delete this.animationsIndex[t.id]}}onAssetRemoved(t){if(t.off("remove",this.onAssetRemoved,this),this.animations){if(t.resources.length>1)for(var e=0;e<t.resources.length;e++)delete this.animations[t.resources[e].name],this.currAnim===t.resources[e].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}_stopCurrentAnimation(){var t=this;t.currAnim=null,t.playing=!1,t.skeleton&&(t.skeleton.currentTime=0,t.skeleton.animation=null),t.animEvaluator&&t.animEvaluator.removeClips()}onSetAnimations(t,e,s){var i=this;let n=s||i.animations;if(this.setGraph(this.container),!i.currAnim&&i.activate&&i.enabled&&this.container.enabled)for(var a in n){this.play(a,0);break}}onSetAssets(t,e,s){if(e&&e.length)for(var i=0;i<e.length;i++)if(e[i]){var n=this.app.assets.get(e[i]);if(n){n.off("change",this.onAssetChanged,this),n.off("remove",this.onAssetRemoved,this);var a=this.animationsIndex[n.id];this.currAnim===a&&this._stopCurrentAnimation(),delete this.animations[a],delete this.animationsIndex[n.id]}}var r=s.map((function(t){return t instanceof wm?t.id:t}));this.loadAnimationAssets(r)}onSetLoop(t,e,s){var i=this;if(i.skeleton&&(i.skeleton.looping=i.loop),i.animEvaluator)for(var n=0;n<i.animEvaluator.clips.length;++n)i.animEvaluator.clips[n].loop=i.loop}onSetCurrentTime(t,e,s){var i=this;if(i.skeleton){var n=i.skeleton;n.currentTime=s,n.addTime(0),n.updateGraph()}if(i.animEvaluator)for(var a=i.animEvaluator,r=0;r<a.clips.length;++r)a.clips[r].time=s}onEnable(){var t=this,e=t.assets,s=this.app.assets;if(e)for(var i=0,n=e.length;i<n;i++){var a=e[i];a instanceof wm||(a=s.get(a)),a&&!a.resource&&s.load(a)}if(t.activate&&!t.currAnim)for(var r in t.animations){this.play(r,0);break}}onBeforeRemove(){for(var t=0;t<this.assets.length;t++){var e=this.assets[t];"number"==typeof e&&(e=this.app.assets.get(e)),e&&(e.off("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this))}var s=this;delete s.skeleton,delete s.fromSkel,delete s.toSkel,delete s.animEvaluator}}xM.properties=["enabled","assets","speed","loop","activate","animations","skeleton","graph","prevAnim","currAnim","fromSkel","toSkel","blending","playing"],CS(xM.prototype,"speed"),CS(xM.prototype,"activate"),CS(xM.prototype,"skeleton"),CS(xM.prototype,"graph"),CS(xM.prototype,"prevAnim"),CS(xM.prototype,"currAnim"),CS(xM.prototype,"fromSkel"),CS(xM.prototype,"toSkel"),CS(xM.prototype,"blending"),CS(xM.prototype,"playing"),CS(xM.prototype,"animations",{set:function(t){let e=this._assets;this.onSetAnimations("animations",e,t),this._animations=t}}),CS(xM.prototype,"assets",{set:function(t){let e=this._assets;this.onSetAssets("assets",e,t),this._assets=t}}),CS(xM.prototype,"loop",{set:function(t){let e=this._loop;this.onSetLoop("loop",e,t),this._loop=t}}),Object.defineProperties(xM.prototype,{currentTime:{get:function(){var t=this;if(t.skeleton)return this.data.skeleton._time;if(t.animEvaluator){var e=t.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0},set:function(t){var e=this;if(e.skeleton){var s=e.skeleton;s.currentTime=t,s.addTime(0),s.updateGraph()}if(e.animEvaluator)for(var i=e.animEvaluator,n=0;n<i.clips.length;++n)i.clips[n].time=t;this.fire("currentTime:changed",t)}},duration:{get:function(){return this.currAnim?this.animations[this.currAnim].duration:0}}}),ES.regist(xM,"animation");class bM extends dM{constructor(t){super(t)}connectStore(t){t.c.animation.onEnable()}onDestroy(t){console.log("destroy","animation"),t.c.animation.onBeforeRemove()}onUpdate(t){for(let r of this.stores){let o=r.c.animation;if(o.blending&&(o.blend+=t*o.blendSpeed,o.blend>=1&&(o.blend=1)),o.playing){var e=o.skeleton;if(null!==e&&null!==o.model){if(o.blending)e.blend(o.fromSkel,o.toSkel,o.blend);else{var s=t*o.speed;e.addTime(s),(o.speed>0&&e._time===e._animation.duration&&!o.loop||o.speed<0&&0===e._time&&!o.loop)&&(o.playing=!1)}o.blending&&1===o.blend&&(e.animation=o.toSkel._animation),e.updateGraph()}}var i=o.animEvaluator;if(i){for(var n=0;n<i.clips.length;++n){var a=i.clips[n];a.speed=o.speed,o.playing?a.resume():a.pause()}i.update(t)}o.blending&&1===o.blend&&(o.blending=!1)}}}DS.regist(bM,"animation");const SM={directional:Xt,omni:Yt,point:Yt,spot:Kt};var wM=[];class MM extends AS{constructor(t,e){super(t,e),this._type="directional",this._color=new J(1,1,1),this._intensity=1,this._shape=$t,this._castShadows=!1,this._shadowDistance=40,this._shadowResolution=1024,this._shadowBias=0,this._normalOffsetBias=0,this._range=10,this._innerConeAngle=40,this._outerConeAngle=45,this._falloffMode=te,this._shadowType=se,this._vsmBlurSize=11,this._vsmBlurMode=ce,this._vsmBias=0,this._cookieAsset=null,this._cookie=null,this._cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieAngle=0,this._cookieScale=null,this._cookieOffset=null,this._shadowUpdateMode=ss,this._mask=1,this._affectDynamic=!0,this._affectLightmapped=!1,this._bake=!1,this._bakeDir=!0,this._isStatic=!1,this._layers=[Wt],this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null;var s=new id(this.app.graphicsDevice);s.type=SM[this._type],s._node=this.container,s._scene=this.app.scene,this.light=s}addLightToLayers(){for(var t,e=0;e<this.layers.length;e++)(t=this.app.scene.layers.getLayerById(this.layers[e]))&&t.addLight(this)}removeLightFromLayers(){for(var t,e=0;e<this.layers.length;e++)(t=this.app.scene.layers.getLayerById(this.layers[e]))&&t.removeLight(this)}onLayersChanged(t,e){this.enabled&&this.container.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.container.enabled&&t.addLight(this)}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&t.removeLight(this)}refreshProperties(){for(var t,e=0;e<wM.length;e++)this[t=wM[e]]=this[t];this.enabled&&this.container.enabled&&this.onEnable()}updateShadow(){this.light.updateShadow()}onCookieAssetSet(){var t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.app.scene.on("set:layers",this.onLayersChanged,this),this.app.scene.layers&&(this.app.scene.layers.on("add",this.onLayerAdded,this),this.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.container.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.app.scene.off("set:layers",this.onLayersChanged,this),this.app.scene.layers&&(this.app.scene.layers.off("add",this.onLayerAdded,this),this.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}changeType(t,e){t!==e&&(this.light.type=SM[e])}}var TM=function(t,e,s,i){var n=MM.prototype;wM.push(t),CS(n,t,{set:function(e){var n=this["_"+t];(i||n!==e)&&(this["_"+t]=e,s&&s.call(this,e,n))},configurable:!0})};TM("light"),TM("type",0,(function(t,e){this.changeType(e,t),this.refreshProperties()})),TM("color",new J(1,1,1),(function(t,e){this.light.setColor(t)}),!0),TM("intensity",0,(function(t,e){this.light.intensity=t})),TM("shape",0,(function(t,e){this.light.shape=t})),TM("castShadows",0,(function(t,e){this.light.castShadows=t})),TM("shadowDistance",0,(function(t,e){this.light.shadowDistance=t})),TM("shadowResolution",0,(function(t,e){this.light.shadowResolution=t})),TM("shadowBias",0,(function(t,e){this.light.shadowBias=-.01*t})),TM("normalOffsetBias",0,(function(t,e){this.light.normalOffsetBias=t})),TM("range",0,(function(t,e){this.light.attenuationEnd=t})),TM("innerConeAngle",0,(function(t,e){this.light.innerConeAngle=t})),TM("outerConeAngle",0,(function(t,e){this.light.outerConeAngle=t})),TM("falloffMode",0,(function(t,e){this.light.falloffMode=t})),TM("shadowType",0,(function(t,e){this.light.shadowType=t})),TM("vsmBlurSize",0,(function(t,e){this.light.vsmBlurSize=t})),TM("vsmBlurMode",0,(function(t,e){this.light.vsmBlurMode=t})),TM("vsmBias",0,(function(t,e){this.light.vsmBias=t})),TM("cookieAsset",0,(function(t,e){if(!this._cookieAssetId||!(t instanceof wm&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof wm)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;var s=this.app.assets.get(t);s?this.onCookieAssetAdd(s):(this._cookieAssetAdd=!0,this.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),TM("cookie",0,(function(t,e){this.light.cookie=t})),TM("cookieIntensity",0,(function(t,e){this.light.cookieIntensity=t})),TM("cookieFalloff",0,(function(t,e){this.light.cookieFalloff=t})),TM("cookieChannel",0,(function(t,e){this.light.cookieChannel=t})),TM("cookieAngle",0,(function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new nt);var s=1,i=1;this.cookieScale&&(s=this.cookieScale.x,i=this.cookieScale.y);var n=Math.cos(t*V.DEG_TO_RAD),a=Math.sin(t*V.DEG_TO_RAD);this._cookieMatrix.set(n/s,-a/s,a/i,n/i),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),TM("cookieScale",0,(function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new nt);var s=t.x,i=t.y,n=Math.cos(this.cookieAngle*V.DEG_TO_RAD),a=Math.sin(this.cookieAngle*V.DEG_TO_RAD);this._cookieMatrix.set(n/s,-a/s,a/i,n/i),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0),TM("cookieOffset",0,(function(t,e){this.light.cookieOffset=t}),!0),TM("shadowUpdateMode",0,(function(t,e){this.light.shadowUpdateMode=t})),TM("mask",0,(function(t,e){this.light.mask=t})),TM("affectDynamic",0,(function(t,e){t?this.light.mask|=as:this.light.mask&=~as,this.light.layersDirty()})),TM("affectLightmapped",0,(function(t,e){t?(this.light.mask|=rs,this.bake&&(this.light.mask&=~os)):(this.light.mask&=~rs,this.bake&&(this.light.mask|=os))})),TM("bake",0,(function(t,e){t?(this.light.mask|=os,this.affectLightmapped&&(this.light.mask&=~rs)):(this.light.mask&=~os,this.affectLightmapped&&(this.light.mask|=rs))})),TM("bakeDir",0,(function(t,e){this.light.bakeDir=t})),TM("isStatic",0,(function(t,e){this.light.isStatic=t})),TM("layers",0,(function(t,e){var s,i;for(s=0;s<e.length;s++)(i=this.app.scene.layers.getLayerById(e[s]))&&i.removeLight(this);for(s=0;s<t.length;s++)(i=this.app.scene.layers.getLayerById(t[s]))&&this.enabled&&this.container.enabled&&i.addLight(this)})),MM.properties=wM,ES.regist(MM,"light");class AM extends dM{}DS.regist(AM,"light");class CM extends AS{constructor(t,e){super(t,e)}}ES.regist(CM,"audiolistener");class PM extends dM{constructor(t){super(t),this.manager=this.app._soundManager}onUpdate(t){for(let t of this.stores){let i=t.c.audiolistener;if(t.enabled&&i.enabled){var e=t.getPosition();this.manager.listener.setPosition(e);var s=t.getWorldTransform();this.manager.listener.setOrientation(s);break}}}}DS.regist(PM,"audiolistener");var RM={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new it,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class EM extends u{constructor(t,e,s){super(),this._component=t,this._assets=t.app.assets,this._manager=t.app._soundManager,this.name=e||"Untitled",s=s||{},this._volume=void 0!==s.volume?V.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!(void 0===s.loop||!s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._played=!1,this._asset=s.resource,this._asset instanceof wm&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this),this.instances=[]}get volume(){return this._volume}set volume(t){if(this._volume=V.clamp(Number(t)||0,0,1),!this._overlap)for(var e=this.instances,s=0,i=e.length;s<i;s++)e[s].volume=this._volume*this._component.volume}get pitch(){return this._pitch}set pitch(t){if(this._pitch=Math.max(Number(t)||0,.01),!this._overlap)for(var e=this.instances,s=0,i=e.length;s<i;s++)e[s].pitch=this.pitch*this._component.pitch}get loop(){return this._loop}set loop(t){this._loop=!!t;for(var e=this.instances,s=0,i=e.length;s<i;s++)e[s].loop=this._loop}get autoPlay(){return this._autoPlay}set autoPlay(t){this._autoPlay=!!t}get overlap(){return this._overlap}set overlap(t){this._overlap=!!t}get startTime(){return this._startTime}set startTime(t){if(this._startTime=Math.max(0,Number(t)||0),!this._overlap)for(var e=this.instances,s=0,i=e.length;s<i;s++)e[s].startTime=this._startTime}get duration(){var t=0;if(this._hasAsset()){var e=this._assets.get(this._asset);t=e.resource?e.resource.duration:0}return null!=this._duration?this._duration>t?t:this._duration%(t||1):t}set duration(t){if(this._duration=Math.max(0,Number(t)||0)||null,!this._overlap)for(var e=this.instances,s=0,i=e.length;s<i;s++)e[s].duration=this._duration}get asset(){return this._asset}set asset(t){var e=this._asset;if(e){this._assets.off("add:"+e,this._onAssetAdd,this);var s=this._assets.get(e);s&&s.off("remove",this._onAssetRemoved,this)}this._asset=t,this._asset instanceof wm&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get isLoaded(){if(this._hasAsset()){var t=this._assets.get(this._asset);if(t)return!!t.resource}return!1}get isPlaying(){for(var t=this.instances,e=0,s=t.length;e<s;e++)if(t[e].isPlaying)return!0;return!1}get isPaused(){var t=this.instances,e=t.length;if(0===e)return!1;for(var s=0;s<e;s++)if(!t[s].isPaused)return!1;return!0}get isStopped(){for(var t=this.instances,e=0,s=t.length;e<s;e++)if(!t[e].isStopped)return!1;return!0}play(){if(this.overlap||this.stop(),this.isLoaded||this._hasAsset()){var t=this._createInstance();if(this.instances.push(t),this.isLoaded)t.play();else{var e=e=>{var s=t._playWhenLoaded;t.sound=e,s&&this._played&&t.play()};this.off("load",e),this.once("load",e),this.load()}return this._played=!0,t}}pause(){for(var t=!1,e=this.instances,s=0,i=e.length;s<i;s++)e[s].pause()&&(t=!0);return this._played=!1,t}resume(){for(var t=!1,e=this.instances,s=0,i=e.length;s<i;s++)e[s].resume()&&(t=!0);return this._played=!0,t}stop(){for(var t=!1,e=this.instances,s=e.length;s--;)e[s].stop(),t=!0;return e.length=0,this._played=!1,t}load(){if(this._hasAsset()){var t=this._assets.get(this._asset);if(!t)return this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this);if(t.off("remove",this._onAssetRemoved,this),t.on("remove",this._onAssetRemoved,this),!t.resource)return t.off("load",this._onAssetLoad,this),t.once("load",this._onAssetLoad,this),void this._assets.load(t);this.fire("load",t.resource)}}setExternalNodes(t,e){if(t){if(e||(e=t),this._firstNode=t,this._lastNode=e,!this._overlap)for(var s=this.instances,i=0,n=s.length;i<n;i++)s[i].setExternalNodes(t,e)}else console.error("The firstNode must have a valid AudioNode")}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap)for(var t=this.instances,e=0,s=t.length;e<s;e++)t[e].clearExternalNodes()}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return null!=this._asset}_createInstance(){var t=null,e=this._component,s=null;if(this._hasAsset()){var i=this._assets.get(this._asset);i&&(s=i.resource)}var n=RM;return n.volume=this._volume*e.volume,n.pitch=this._pitch*e.pitch,n.loop=this._loop,n.startTime=this._startTime,n.duration=this._duration,n.onPlay=this._onInstancePlayHandler,n.onPause=this._onInstancePauseHandler,n.onResume=this._onInstanceResumeHandler,n.onStop=this._onInstanceStopHandler,n.onEnd=this._onInstanceEndHandler,e.positional?(n.position.copy(e.entity.getPosition()),n.maxDistance=e.maxDistance,n.refDistance=e.refDistance,n.rollOffFactor=e.rollOffFactor,n.distanceModel=e.distanceModel,t=new Yp(this._manager,s,n)):t=new Xp(this._manager,s,n),this._firstNode&&t.setExternalNodes(this._firstNode,this._lastNode),t}_onInstancePlay(t){this.fire("play",t),this._component.fire("play",this,t)}_onInstancePause(t){this.fire("pause",t),this._component.fire("pause",this,t)}_onInstanceResume(t){this.fire("resume",t),this._component.fire("resume",this,t)}_onInstanceStop(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("stop",t),this._component.fire("stop",this,t)}_onInstanceEnd(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("end",t),this._component.fire("end",this,t)}_onAssetAdd(t){this.load()}_onAssetLoad(t){this.load()}_onAssetRemoved(t){t.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+t.id,this._onAssetAdd,this),this.stop()}updatePosition(t){for(var e=this.instances,s=0,i=e.length;s<i;s++)e[s].position=t}}class LM extends AS{constructor(t,e){super(t,e),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=Bp,this._slots={},this._playingBeforeDisable={}}onEnable(){var t=this._slots,e=this._playingBeforeDisable;for(var s in t){var i=t[s];i.autoPlay&&i.isStopped?i.play():e[s]?i.resume():i.isLoaded||i.load()}}onDisable(){var t=this._slots,e={};for(var s in t)t[s].overlap||t[s].isPlaying&&(t[s].pause(),e[s]=!0);this._playingBeforeDisable=e}addSlot(t,e){var s=this._slots;if(s[t])return null;var i=new EM(this,t,e);return s[t]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(t){var e=this._slots;e[t]&&(e[t].stop(),delete e[t])}slot(t){return this._slots[t]}play(t){if(!this.enabled||!this.entity.enabled)return null;var e=this._slots[t];return e?e.play():null}pause(t){var e,s=this._slots;if(t){if(!(e=s[t]))return;e.pause()}else for(var i in s)s[i].pause()}resume(t){var e=this._slots;if(t){var s=e[t];if(!s)return;s.isPaused&&s.resume()}else for(var i in e)e[i].resume()}stop(t){var e=this._slots;if(t){var s=e[t];if(!s)return;s.stop()}else for(var i in e)e[i].stop()}}LM.properties=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];const IM=function(t,e){CS(LM.prototype,t,{set:function(s){this[e]=s;var i=this._slots;for(var n in i){var a=i[n];if(!a.overlap)for(var r=a.instances,o=0,h=r.length;o<h;o++)r[o][t]=s}}})},DM=function(t,e){CS(LM.prototype,t,{set:function(s){this[e]=s;var i=this._slots;for(var n in i){var a=i[n];if(!a.overlap)for(var r=a.instances,o=0,h=r.length;o<h;o++)r[o][t]=a[t]*s}}})};DM("pitch","_pitch"),DM("volume","_volume"),IM("refDistance","_refDistance"),IM("maxDistance","_maxDistance"),IM("rollOffFactor","_rollOffFactor"),IM("distanceModel","_distanceModel"),CS(LM.prototype,"positional",{set:function(t){this._positional=t;var e=this._slots;for(var s in e){var i=e[s];if(!i.overlap)for(var n=i.instances,a=0,r=n.length;a<r;a++){var o=n[a].isPlaying||n[a].isSuspended,h=n[a].currentTime;o&&n[a].stop(),n[a]=i._createInstance(),o&&(n[a].play(),n[a].currentTime=h)}}}}),CS(LM.prototype,"slots",{set:function(t){var e,s=this._slots;if(s)for(e in s)s[e].stop();var i={};for(e in t)t[e]instanceof EM?i[t[e].name]=t[e]:t[e].name&&(i[t[e].name]=new EM(this,t[e].name,t[e]));this._slots=i,this.enabled&&this.entity.enabled&&this.onEnable()}}),ES.regist(LM,"sound");class FM extends dM{constructor(t){super(t)}connectStore(t){t.c.sound.onEnable()}disconnectStore(t){let e=t.c.sound;e.onDisable();let s=e.slots;for(let t in s)s[t].overlap||s[t].stop()}onUpdate(t){for(let t of this.stores){let n=t.c.sound;var e=t.getPosition(),s=n.slots;for(var i in s)s[i].updatePosition(e)}}}DS.regist(FM,"sound");class OM extends LM{constructor(t,e){super(t,e),this._currSlot=null,this._animation=null,this._changeTimeout=null}_onAnimPlay(t){this._currSlot&&this.stop(),this.slots[t]&&(this.play(t),this._currSlot=t)}_onAnimStop(){this.stop(),this._currSlot=null}_onAnimResume(t){this.slots[t]&&this.resume(t)}_onAnimPause(t){this.slots[t]&&this.pause(t)}_onAnimSpeedChanged(t,e,s){this.pitch=s}_onAnimCurrentTimeChanged(t){this._currSlot&&(this._changeTimeout&&(clearTimeout(this._changeTimeout),this._changeTimeout=null),this._changeTimeout=setTimeout((()=>{if(!this._currSlot)return;let e=this.slots[this._currSlot].instances;for(let s=0;s<e.length;s++){e[s].currentTime=t}}),100))}}Object.defineProperty(OM.prototype,"animation",{get:function(){return this._animation},set:function(t){this._animation&&(this._animation.off("play",this._onAnimPlay),this._animation.off("stop",this._onAnimStop),this._animation.off("resume",this._onAnimResume),this._animation.off("pause",this._onAnimPause),this._animation.off("currentTime:changed",this._onAnimCurrentTimeChanged),this._animation.off("set_speed",this._onAnimSpeedChanged)),this._animation=t,this._animation&&(this._animation.on("play",this._onAnimPlay,this),this._animation.on("stop",this._onAnimStop,this),this._animation.on("resume",this._onAnimResume,this),this._animation.on("pause",this._onAnimPause,this),this._animation.on("currentTime:changed",this._onAnimCurrentTimeChanged,this),this._animation.on("set_speed",this._onAnimSpeedChanged,this))}}),ES.regist(OM,"animationAudio");class kM extends dM{constructor(t){super(t),this._timeout=null}}DS.regist(kM,"animationAudio","animation");class BM extends AS{constructor(t,e){super(t,e),this._variants=[],this._curtVariant=null,this._model=null,this._cacheRelations=[]}_setCacheRelations(t){this._cacheRelations=[];for(let e=0;e<t.meshInstances.length;e++)this._cacheRelations.push(t.meshInstances[e].material)}_setModelMaterials(t){if(this._model)for(let e=0;e<this._model.meshInstances.length;e++){this._model.meshInstances[e].material=t[e]}}get model(){return this._model}set model(t){this._model&&this._setCacheRelations(null),this._model=t,this._model&&this._setCacheRelations(this._model)}get variants(){return this._variants}set variants(t){this._variants=t}get curtVariant(){return this._curtVariant}set curtVariant(t){if(this._model&&(this.curtVariant&&this._setModelMaterials(this._cacheRelations),this._curtVariant=t,this.curtVariant>=0)){let t=this.variants[this.curtVariant];t&&this._setModelMaterials(t.relations)}}}ES.buildAccessors(BM.prototype,["variants","curtVariant","model"]),ES.regist(BM,"materialsVariants");class zM extends dM{}DS.regist(zM,"materialsVariants");class UM extends Rh{constructor(t){super(t),this.needsDepthBuffer=!0,this.ssaoShader=new sr(t,{attributes:{aPosition:ln},vshader:[t.webgl2?"#version 300 es\n\n"+ir.gles3VS:"","attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","\t\tgl_Position = vec4(aPosition, 0.0, 1.0);","\t\tvUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:[t.webgl2?"#version 300 es\n\n"+ir.gles3PS:"","precision "+t.precision+" float;",ir.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","#define saturate(x) clamp(x,0.0,1.0)","","// Largely based on 'Dominant Light Shadowing'","// 'Lighting Technology of The Last of Us Part II' by Hawar Doghramachi, Naughty Dog, LLC","","const float kSSCTLog2LodRate = 3.0;","","struct ConeTraceSetup {","\t // fragment info","\t\thighp vec2 ssStartPos;","\t\thighp vec3 vsStartPos;","\t\tvec3 vsNormal;","","\t // light (cone) info","\t\tvec3 vsConeDirection;","\t\tfloat shadowDistance;","\t\tfloat coneAngleTangeant;","\t\tfloat contactDistanceMaxInv;","\t\tvec2 jitterOffset;\t\t\t\t\t// (x = direction offset, y = step offset)","","\t // scene infos","\t\thighp mat4 screenFromViewMatrix;","\t\tfloat projectionScale;","\t\tvec4 resolution;","\t\tfloat maxLevel;","","\t // artistic/quality parameters","\t\tfloat intensity;","\t\tfloat depthBias;","\t\tfloat slopeScaledDepthBias;","\t\tint sampleCount;","};","","highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {","\t\t// this essentially returns (p * vec4(v, 1.0)).w, but we make some assumptions","\t\t// this assumes a perspective projection","\t\treturn -v.z;","\t\t// this assumes a perspective or ortho projection","\t\t// return p[2][3] * v.z + p[3][3];","}","","highp float getViewSpaceZFromW(const mat4 p, const float w) {","\t\t// this assumes a perspective projection","\t\treturn -w;","\t\t// this assumes a perspective or ortho projection","\t // return (w - p[3][3]) / p[2][3];","}","","float coneTraceOcclusion(in ConeTraceSetup setup) {","// skip fragments that are back-facing trace direction","// (avoid overshadowing of translucent surfaces)","\t\tfloat NoL = dot(setup.vsNormal, setup.vsConeDirection);","\t\tif (NoL < 0.0) {","\t\t\t\treturn 0.0;","\t\t}","","// start position of cone trace","\t\thighp vec2 ssStartPos = setup.ssStartPos;","\t\thighp vec3 vsStartPos = setup.vsStartPos;","\t\thighp float ssStartPosW = getWFromProjectionMatrix(setup.screenFromViewMatrix, vsStartPos);","\t\thighp float ssStartPosWInv = 1.0 / ssStartPosW;","","// end position of cone trace","\t\thighp vec3 vsEndPos = setup.vsConeDirection * setup.shadowDistance + vsStartPos;","\t\thighp float ssEndPosW = getWFromProjectionMatrix(setup.screenFromViewMatrix, vsEndPos);","\t\thighp float ssEndPosWInv = 1.0 / ssEndPosW;","\t\thighp vec2 ssEndPos = (setup.screenFromViewMatrix * vec4(vsEndPos, 1.0)).xy * ssEndPosWInv;","","// cone trace direction in screen-space","\t\tfloat ssConeLength = length(ssEndPos - ssStartPos);","\t\tvec2 ssConeVector = ssEndPos - ssStartPos;","","// direction perpendicular to cone trace direction","\t\tvec2 peremwoneDir = normalize(vec2(ssConeVector.y, -ssConeVector.x));","\t\tfloat vsEndRadius = setup.coneAngleTangeant * setup.shadowDistance;","","// normalized step","\t\thighp float dt = 1.0 / float(setup.sampleCount);","","// normalized (0 to 1) screen-space postion on the ray","\t\thighp float t = dt * setup.jitterOffset.y;","","// calculate depth bias","\t\tfloat vsDepthBias = saturate(1.0 - NoL) * setup.slopeScaledDepthBias + setup.depthBias;","","\t\tfloat occlusion = 0.0;","\t\tfor (int i = 0; i < 16; i++) {","\t\t\t\tfloat ssTracedDistance = ssConeLength * t;","\t\t\t\tfloat ssSliceRadius = setup.jitterOffset.x * (setup.coneAngleTangeant * ssTracedDistance);","\t\t\t\thighp vec2 ssSamplePos = peremwoneDir * ssSliceRadius + ssConeVector * t + ssStartPos;","","\t\t\t\tfloat level = clamp(floor(log2(ssSliceRadius)) - kSSCTLog2LodRate, 0.0, float(setup.maxLevel));","\t\t\t\tfloat vsSampleDepthLinear = -getLinearScreenDepth(ssSamplePos * setup.resolution.zw);","","\t\t\t // calculate depth range of cone slice","\t\t\t\tfloat vsSliceRadius = vsEndRadius * t;","","\t\t\t // calculate depth of cone center","\t\t\t\tfloat vsConeAxisDepth = -getViewSpaceZFromW(setup.screenFromViewMatrix, 1.0 / mix(ssStartPosWInv, ssEndPosWInv, t));","\t\t\t\tfloat vsJitteredSampleRadius = vsSliceRadius * setup.jitterOffset.x;","\t\t\t\tfloat vsSliceHalfRange = sqrt(vsSliceRadius * vsSliceRadius - vsJitteredSampleRadius * vsJitteredSampleRadius);","\t\t\t\tfloat vsSampleDepthMax = vsConeAxisDepth + vsSliceHalfRange;","","\t\t\t // calculate overlap of depth buffer height-field with trace cone","\t\t\t\tfloat vsDepthDifference = vsSampleDepthMax - vsSampleDepthLinear;","\t\t\t\tfloat overlap = saturate((vsDepthDifference - vsDepthBias) / (vsSliceHalfRange * 2.0));","","\t\t\t\t// attenuate by distance to avoid false occlusion","\t\t\t\tfloat attenuation = saturate(1.0 - (vsDepthDifference * setup.contactDistanceMaxInv));","\t\t\t\tocclusion = max(occlusion, overlap * attenuation);","\t\t\t\tif (occlusion >= 1.0) {\t// note: this can't get > 1.0 by construction","\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// fully occluded, early exit","\t\t\t\t\t\tbreak;","\t\t\t\t}","\t\t\t\tt += dt;","\t\t}","\t\treturn occlusion * setup.intensity;","}","","const float kLog2LodRate = 3.0;","","vec2 sq(const vec2 a) {","\t\treturn a * a;","}","","uniform float uInvFarPlane;","","vec2 pack(highp float depth) {","// we need 16-bits of precision","\t\thighp float z = clamp(depth * uInvFarPlane, 0.0, 1.0);","\t\thighp float t = floor(256.0 * z);","\t\tmediump float hi = t * (1.0 / 256.0);\t // we only need 8-bits of precision","\t\tmediump float lo = (256.0 * z) - t;\t\t // we only need 8-bits of precision","\t\treturn vec2(hi, lo);","}","","// random number between 0 and 1, using interleaved gradient noise","float random(const highp vec2 w) {","\t\tconst vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","\t\treturn fract(m.z * fract(dot(w, m.xy)));","}","","// returns the frag coord in the GL convention with (0, 0) at the bottom-left","highp vec2 getFragCoord() {","\t\treturn gl_FragCoord.xy;","}","","highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {","\t\treturn vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);","}","","highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {","\t\treturn normalize(cross(dpdx, dpdy));","}","","// Compute normals using derivatives, which essentially results in half-resolution normals","// this creates arifacts around geometry edges.","// Note: when using the spirv optimizer, this results in much slower execution time because","//\t\t\t this whole expression is inlined in the AO loop below.","","// Compute normals directly from the depth texture, resulting in full resolution normals","// Note: This is actually as cheap as using derivatives because the texture fetches","//\t\t\t are essentially equivalent to textureGather (which we don't have on ES3.0),","//\t\t\t and this is executed just once.","highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {","\t\thighp vec2 uvdx = uv + vec2(uResolution.z, 0.0);","\t\thighp vec2 uvdy = uv + vec2(0.0, uResolution.w);","\t\thighp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));","\t\thighp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));","\t\thighp vec3 dpdx = px - position;","\t\thighp vec3 dpdy = py - position;","\t\treturn faceNormal(dpdx, dpdy);","}","","// Ambient Occlusion, largely inspired from:","// 'The Alchemy Screen-Space Ambient Obscurance Algorithm' by Morgan McGuire","// 'Scalable Ambient Obscurance' by Morgan McGuire, Michael Mara and David Luebke","","uniform vec2 uSampleCount;","uniform float uSpiralTurns;","","#define PI (3.14159)","","vec3 tapLocation(float i, const float noise) {","\t\tfloat offset = ((2.0 * PI) * 2.4) * noise;","\t\tfloat angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;","\t\tfloat radius = (i + noise + 0.5) * uSampleCount.y;","\t\treturn vec3(cos(angle), sin(angle), radius * radius);","}","","highp vec2 startPosition(const float noise) {","\t\tfloat angle = ((2.0 * PI) * 2.4) * noise;","\t\treturn vec2(cos(angle), sin(angle));","}","","uniform vec2 uAngleIncCosSin;","","highp mat2 tapAngleStep() {","\t\thighp vec2 t = uAngleIncCosSin;","\t\treturn mat2(t.x, t.y, -t.y, t.x);","}","","vec3 tapLocationFast(float i, vec2 p, const float noise) {","\t\tfloat radius = (i + noise + 0.5) * uSampleCount.y;","\t\treturn vec3(p, radius * radius);","}","","uniform float uMaxLevel;","uniform float uInvRadiusSquared;","uniform float uMinHorizonAngleSineSquared;","uniform float uBias;","uniform float uPeak2;","","void computeAmbientOcclusionSAO(inout float occlusion, float i, float ssDiskRadius,","\t\t\t\tconst highp vec2 uv,\tconst highp vec3 origin, const vec3 normal,","\t\t\t\tconst vec2 tapPosition, const float noise) {","","\t\tvec3 tap = tapLocationFast(i, tapPosition, noise);","","\t\tfloat ssRadius = max(1.0, tap.z * ssDiskRadius);","","\t\tvec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uResolution.zw;","","\t\tfloat level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));","\t\thighp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);","\t\thighp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);","","\t\t// now we have the sample, compute AO","\t\tvec3 v = p - origin;\t\t\t\t// sample vector","\t\tfloat vv = dot(v, v);\t\t\t // squared distance","\t\tfloat vn = dot(v, normal);\t// distance * cos(v, normal)","","\t\t// discard samples that are outside of the radius, preventing distant geometry to","\t\t// cast shadows -- there are many functions that work and choosing one is an artistic","\t\t// decision.","\t\tfloat w = max(0.0, 1.0 - vv * uInvRadiusSquared);","\t\tw = w*w;","","\t\t// discard samples that are too close to the horizon to reduce shadows cast by geometry","\t\t// not sufficently tessellated. The goal is to discard samples that form an angle 'beta'","\t\t// smaller than 'epsilon' with the horizon. We already have dot(v,n) which is equal to the","\t\t// sin(beta) * |v|. So the test simplifies to vn^2 < vv * sin(epsilon)^2.","\t\tw *= step(vv * uMinHorizonAngleSineSquared, vn * vn);","","\t\tocclusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);","}","","uniform float uProjectionScaleRadius;","uniform float uIntensity;","","float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {","\t\tfloat noise = random(getFragCoord());","\t\thighp vec2 tapPosition = startPosition(noise);","\t\thighp mat2 angleStep = tapAngleStep();","","\t\t// Choose the screen-space sample radius","\t\t// proportional to the projected area of the sphere","\t\tfloat ssDiskRadius = -(uProjectionScaleRadius / origin.z);","","\t\tfloat occlusion = 0.0;","\t\tfor (float i = 0.0; i < 16.0; i += 1.0) {","\t\t\t\tcomputeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);","\t\t\t\ttapPosition = angleStep * tapPosition;","\t\t}","\t\treturn sqrt(occlusion * uIntensity);","}","","uniform float uPower;","","void main() {","\t\thighp vec2 uv = vUv0; //variable_vertex.xy; // interpolated to pixel center","","\t\thighp float depth = -getLinearScreenDepth(vUv0);","\t\thighp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);","\t\tvec3 normal = computeViewSpaceNormal(origin, uv);","","\t\tfloat occlusion = 0.0;","","\t\tif (uIntensity > 0.0) {","\t\t\t\tocclusion = scalableAmbientObscurance(uv, origin, normal);","\t\t}","","\t\t// occlusion to visibility","\t\tfloat aoVisibility = pow(saturate(1.0 - occlusion), uPower);","","\t\tvec4 inCol = vec4(1.0, 1.0, 1.0, 1.0); //texture2D( uColorBuffer,\tuv );","","\t\tgl_FragColor.rgb = inCol.rgb * vec3(aoVisibility); //postProcess.color.rgb = vec3(aoVisibility, pack(origin.z));","\t\tgl_FragColor.a = 1.0;","}","","void main_old()","{","\t\tvec2 aspectCorrect = vec2( 1.0, uAspect );","","\t\tfloat depth = getLinearScreenDepth(vUv0);","\t\tgl_FragColor.rgb = vec3(fract(floor(depth*256.0*256.0)),fract(floor(depth*256.0)),fract(depth));","\t\tgl_FragColor.a = 1.0;","}"].join("\n")}),this.blurShader=new sr(t,{attributes:{aPosition:ln},vshader:[t.webgl2?"#version 300 es\n\n"+ir.gles3VS:"","attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","\t\tgl_Position = vec4(aPosition, 0.0, 1.0);","\t\tvUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),fshader:[t.webgl2?"#version 300 es\n\n"+ir.gles3PS:"","precision "+t.precision+" float;",ir.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","uniform sampler2D uSSAOBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","uniform int uBilatSampleCount;","uniform float uFarPlaneOverEdgeDistance;","","float random(const highp vec2 w) {","\t\tconst vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","\t\treturn fract(m.z * fract(dot(w, m.xy)));","}","","float bilateralWeight(in float depth, in float sampleDepth) {","\t\tfloat diff = (sampleDepth - depth) * uFarPlaneOverEdgeDistance;","\t\treturn max(0.0, 1.0 - diff * diff);","}","","void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {","\t\t// ambient occlusion sample","\t\tfloat ssao = texture2D( uSSAOBuffer, position ).r;","\t\tfloat tdepth = -getLinearScreenDepth( position );","","\t\t// bilateral sample","\t\tfloat bilateral = bilateralWeight(depth, tdepth);","\t\tbilateral *= weight;","\t\tsum += ssao * bilateral;","\t\ttotalWeight += bilateral;","}","","void main() {","\t\thighp vec2 uv = vUv0; // variable_vertex.xy; // interpolated at pixel's center","","\t\t// we handle the center pixel separately because it doesn't participate in","\t\t// bilateral filtering","\t\tfloat depth = -getLinearScreenDepth(vUv0); // unpack(data.gb);","\t\tfloat totalWeight = 0.0; // float(4*2+1)*float(4*2+1);","\t\tfloat ssao = texture2D( uSSAOBuffer, vUv0 ).r;","\t\tfloat sum = ssao * totalWeight;","","\t\tfor (int x = -4; x <= 4; x++) {","\t\t\t for (int y = -4; y < 4; y++) {","\t\t\t\t\t float weight = 1.0;","\t\t\t\t\t vec2 offset = vec2(x,y)*uResolution.zw;","\t\t\t\t\t tap(sum, totalWeight, weight, depth, uv + offset);","\t\t\t }","\t\t}","","\t\tfloat ao = sum * (1.0 / totalWeight);","","\t\t// simple dithering helps a lot (assumes 8 bits target)","\t\t// this is most useful with high quality/large blurs","\t\t// ao += ((random(gl_FragCoord.xy) - 0.5) / 255.0);","","\t\tvec4 inCol = texture2D( uColorBuffer,\tvUv0 );","","\t\tgl_FragColor.rgb = inCol.rgb * ao;","\t\tgl_FragColor.a = 1.0;","}"].join("\n")});var e=t.width,s=t.height;this.targets=[];for(var i=0;i<1;i++){var n=new Mr(t,{format:Li,width:e,height:s,mipmaps:!1});n.minFilter=ui,n.magFilter=ui,n.addressU=Ws,n.addressV=Ws,n.name="ssao_"+i;var a=new uh(t,n,{depth:!1});this.targets.push(a)}this.maxBlur=.02}render(t,e,s){var i=this.device,n=i.scope,a=1/15.5*10*2*3.141,r=.5*i.height;n.resolve("uMaxBlur").setValue(this.maxBlur),n.resolve("uAspect").setValue(i.width/i.height),n.resolve("uResolution").setValue([i.width,i.height,1/i.width,1/i.height]),n.resolve("uColorBuffer").setValue(t.colorBuffer),n.resolve("uInvFarPlane").setValue(.02),n.resolve("uSampleCount").setValue([16,1/16]),n.resolve("uSpiralTurns").setValue(10),n.resolve("uAngleIncCosSin").setValue([Math.cos(a),Math.sin(a)]),n.resolve("uMaxLevel").setValue(0),n.resolve("uInvRadiusSquared").setValue(1/16),n.resolve("uMinHorizonAngleSineSquared").setValue(0),n.resolve("uBias").setValue(.001),n.resolve("uPeak2").setValue(.4*.4),n.resolve("uIntensity").setValue(.31410000000000005),n.resolve("uPower").setValue(1),n.resolve("uProjectionScaleRadius").setValue(4*r),Lh(i,this.targets[0],this.vertexBuffer,this.ssaoShader,s),n.resolve("uSSAOBuffer").setValue(this.targets[0].colorBuffer),n.resolve("uFarPlaneOverEdgeDistance").setValue(50/.7),n.resolve("uBilatSampleCount").setValue(4),Lh(i,e,this.vertexBuffer,this.blurShader,s)}}class VM extends AS{constructor(t,e){super(t,e),this.effect=new UM(this.app.graphicsDevice),this._maxBlur=.02}get maxBlur(){return this._maxBlur}set maxBlur(t){this._maxBlur=t,this.effect.maxBlur=t}}VM.properties=["maxBlur"],ES.buildAccessors(VM.prototype,VM.properties),ES.regist(VM,"cameraEffectSSAO");class NM extends dM{constructor(t){super(t)}connectStore(t){let e=t.c.camera,s=t.c.cameraEffectSSAO;e.postEffects.addEffect(s.effect)}disconnectStore(t){let e=t.c.camera,s=t.c.cameraEffectSSAO;e.postEffects.removeEffect(s.effect)}}DS.regist(NM,"camera","cameraEffectSSAO");class WM extends Rh{constructor(t){super(t),this.SAMPLE_COUNT=15;var e={aPosition:ln},s=["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","\t\tgl_Position = vec4(aPosition, 0.0, 1.0);","\t\tvUv0 = (aPosition + 1.0) * 0.5;","}"].join("\n"),i=["precision "+t.precision+" float;","","varying vec2 vUv0;","","uniform sampler2D uBaseTexture;","uniform float uBloomThreshold;","","void main(void)","{","\t\tvec4 color = texture2D(uBaseTexture, vUv0);","","\t\tgl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);","}"].join("\n"),n=["precision "+t.precision+" float;","","#define SAMPLE_COUNT "+this.SAMPLE_COUNT,"","varying vec2 vUv0;","","uniform sampler2D uBloomTexture;","uniform vec2 uBlurOffsets[SAMPLE_COUNT];","uniform float uBlurWeights[SAMPLE_COUNT];","","void main(void)","{","\t\tvec4 color = vec4(0.0);","\t\tfor (int i = 0; i < SAMPLE_COUNT; i++)","\t\t{","\t\t\t\tcolor += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];","\t\t}","","\t\tgl_FragColor = color;","}"].join("\n"),a=["precision "+t.precision+" float;","","varying vec2 vUv0;","","uniform float uBloomEffectIntensity;","uniform sampler2D uBaseTexture;","uniform sampler2D uBloomTexture;","","void main(void)","{","\t\tvec4 bloom = texture2D(uBloomTexture, vUv0) * uBloomEffectIntensity;","\t\tvec4 base = texture2D(uBaseTexture, vUv0);","","\t\tbase *= (1.0 - clamp(bloom, 0.0, 1.0));","","\t\tgl_FragColor = base + bloom;","}"].join("\n");this.extractShader=new sr(t,{attributes:e,vshader:s,fshader:i}),this.blurShader=new sr(t,{attributes:e,vshader:s,fshader:n}),this.combineShader=new sr(t,{attributes:e,vshader:s,fshader:a});var r=t.width,o=t.height;this.targets=[];for(var h=0;h<2;h++){var l=new Mr(t,{format:Li,width:r>>1,height:o>>1});l.minFilter=ui,l.magFilter=ui,l.addressU=Ws,l.addressV=Ws,l.name="pe-bloom";var c=new uh(t,l,{depth:!1});this.targets.push(c)}this.bloomThreshold=.25,this.blurAmount=4,this.bloomIntensity=1.25,this.sampleWeights=new Float32Array(this.SAMPLE_COUNT),this.sampleOffsets=new Float32Array(2*this.SAMPLE_COUNT)}computeGaussian(t,e){return 1/Math.sqrt(2*Math.PI*e)*Math.exp(-t*t/(2*e*e))}calculateBlurValues(t,e,s,i,n){t[0]=this.computeGaussian(0,n),e[0]=0,e[1]=0;var a,r,o=t[0];for(a=0,r=Math.floor(this.SAMPLE_COUNT/2);a<r;a++){var h=this.computeGaussian(a+1,n);t[2*a]=h,t[2*a+1]=h,o+=2*h;var l=2*a+1.5;e[4*a]=s*l,e[4*a+1]=i*l,e[4*a+2]=-s*l,e[4*a+3]=-i*l}for(a=0,r=t.length;a<r;a++)t[a]/=o}render(t,e,s){var i=this.device,n=i.scope;n.resolve("uBloomThreshold").setValue(this.bloomThreshold),n.resolve("uBaseTexture").setValue(t.colorBuffer),Lh(i,this.targets[0],this.vertexBuffer,this.extractShader),this.calculateBlurValues(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount),n.resolve("uBlurWeights[0]").setValue(this.sampleWeights),n.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),n.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),Lh(i,this.targets[1],this.vertexBuffer,this.blurShader),this.calculateBlurValues(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount),n.resolve("uBlurWeights[0]").setValue(this.sampleWeights),n.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),n.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer),Lh(i,this.targets[0],this.vertexBuffer,this.blurShader),n.resolve("uBloomEffectIntensity").setValue(this.bloomIntensity),n.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),n.resolve("uBaseTexture").setValue(t.colorBuffer),Lh(i,e,this.vertexBuffer,this.combineShader,s)}}class GM extends AS{constructor(t,e){super(t,e),this.effect=new WM(this.app.graphicsDevice),this._threshold=.25,this._blurAmount=4,this._intensity=1.25}get threshold(){return this._threshold}set threshold(t){this._threshold=t,this.effect.bloomThreshold=t}get blurAmount(){return this._blurAmount}set blurAmount(t){this._blurAmount=t,this.effect.blurAmount=t}get intensity(){return this._intensity}set intensity(t){this._intensity=t,this.effect.bloomIntensity=t}}GM.properties=["threshold","blurAmount","intensity"],ES.buildAccessors(GM.prototype,GM.properties),ES.regist(GM,"cameraEffectBloom");class HM extends dM{constructor(t){super(t)}connectStore(t){let e=t.c.camera,s=t.c.cameraEffectBloom;e.postEffects.addEffect(s.effect)}disconnectStore(t){let e=t.c.camera,s=t.c.cameraEffectBloom;e.postEffects.removeEffect(s.effect)}}DS.regist(HM,"camera","cameraEffectBloom");class jM extends AS{constructor(t,e){super(t,e),this._variants=void 0,this._cacheMaterialAssets=void 0}changeVariant(t){const e=this._variants[t],s=this.container.getComponent("render");e&&s?(this._cacheMaterialAssets||(this._cacheMaterialAssets=Array.from(s.meshInstances.map((t=>t.material)))),s.materialAssets=e.materialAssets,this.container.fire("mat:variants:changed",this.container,e.materialAssets)):this._cacheMaterialAssets&&(this._cacheMaterialAssets.forEach(((t,e)=>{s.meshInstances[e].material=t})),this.container.fire("mat:variants:changed",this.container,this._cacheMaterialAssets))}get variants(){return this._variants}set variants(t){this._variants=t}onRemove(){this._variants=null,this._cacheEnabled=null}}jM.properties=["variants"],ES.buildAccessors(jM.prototype,jM.properties),ES.regist(jM,"materialVariants");class qM extends dM{constructor(t){super(t)}onDestroy(t){t.c.materialVariants.onRemove()}}DS.regist(qM,"materialVariants");class XM extends AS{constructor(t,e){super(t,e),this._variants=void 0,this._cacheEnabled=void 0}changeVariant(t){let e=this._variants[t];e?(null==this._cacheEnabled&&(this._cacheEnabled=this.container.enabled),this.container.enabled=e.enabled):void 0!==this._cacheEnabled&&(this.container.enabled=this._cacheEnabled)}get variants(){return this._variants}set variants(t){this._variants=t}onRemove(){this._variants=null,this._cacheEnabled=null}}XM.properties=["variants"],ES.buildAccessors(XM.prototype,XM.properties),ES.regist(XM,"nodeVariants");class YM extends dM{constructor(t){super(t)}onDestroy(t){t.c.nodeVariants.onRemove()}}DS.regist(YM,"nodeVariants");class KM extends AS{constructor(t,e){super(t,e),this._schemes=void 0,this._currentSchemes={}}changeVariant(t,e){const s=this._schemes.find((e=>e.id==t));if(!s)return;this.container.findComponents("materialVariants").forEach((t=>{s.variants.every((e=>!!t.variants[e.id]))&&t.changeVariant(e)})),this._currentSchemes[t]=e}get currentSchemes(){return this._currentSchemes}get schemes(){return this._schemes}set schemes(t){this._schemes=t}onRemove(){this._schemes=null}}KM.properties=["schemes"],ES.buildAccessors(KM.prototype,KM.properties),ES.regist(KM,"materialSchemes");class $M extends dM{onDestroy(t){t.c.materialSchemes.onRemove()}}DS.regist($M,"materialSchemes");class ZM extends AS{constructor(t,e){super(t,e),this._schemes=void 0}changeVariant(t,e){this._schemes.find((e=>e.id==t))&&this.container.findComponents("nodeVariants").forEach((t=>{t.changeVariant(e)}))}get schemes(){return this._schemes}set schemes(t){this._schemes=t}onRemove(){this._schemes=null}}ZM.properties=["schemes"],ES.buildAccessors(ZM.prototype,ZM.properties),ES.regist(ZM,"nodeSchemes");class JM extends dM{constructor(t){super(t)}onDestroy(t){t.c.nodeSchemes.onRemove()}}DS.regist(JM,"nodeSchemes");L.endsWith=function(t,e){return t.endsWith(e)},L.startsWith=function(t,e){return t.startsWith(e)};Object.defineProperty(J.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(J.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),V.INV_LOG2=Math.LOG2E,V.intToBytes=V.intToBytes32,V.bytesToInt=V.bytesToInt32,Object.defineProperty(st.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),st.prototype.scale=st.prototype.mulScalar,Object.defineProperty(it.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),it.prototype.scale=it.prototype.mulScalar,Object.defineProperty(nt.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),nt.prototype.scale=nt.prototype.mulScalar;Mt.prototype.intersectRay=Mt.prototype.intersectsRay,Os.prototype.update=function(t,e){const s=new dt;s.mul2(t,e),this.setFromMat4(s)};function QM(t){this.name="UnsupportedBrowserError",this.message=t||""}function tT(t){this.name="ContextCreationError",this.message=t||""}QM.prototype=Error.prototype,tT.prototype=Error.prototype;Object.defineProperty(ir,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+ir.transformVS}});const eT={"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"};Object.keys(eT).forEach((t=>{Object.defineProperty(ir,t,{get:function(){return null},set:function(){}})})),Object.defineProperties(Mr.prototype,{rgbm:{get:function(){return this.type===Yn},set:function(t){this.type=t?Yn:Xn}},swizzleGGGR:{get:function(){return this.type===$n},set:function(t){this.type=t?$n:Xn}}});Object.defineProperty(Cu.prototype,"defaultMaterial",{get:function(){return Eo.get(Fh().graphicsDevice)}}),["128","64","32","16","8","4"].forEach(((t,e)=>{Object.defineProperty(Cu.prototype,`skyboxPrefiltered${t}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})})),Object.defineProperty(Qh.prototype,"model",{get:function(){return null}}),dl.prototype.syncAabb=function(){},gd.prototype.getTarget=function(t){return this.targets[t]},jr.prototype._dirtify=function(t){t?this._dirtifyLocal():this._dirtifyWorld()},jr.prototype.addLabel=function(t){this._labels[t]=!0},jr.prototype.getLabels=function(){return Object.keys(this._labels)},jr.prototype.hasLabel=function(t){return!!this._labels[t]},jr.prototype.removeLabel=function(t){delete this._labels[t]},jr.prototype.findByLabel=function(t,e=[]){this.hasLabel(t)&&e.push(this);for(let s=0;s<this._children.length;++s)e=this._children[s].findByLabel(t,e);return e},jr.prototype.getChildren=function(){return this.children},jr.prototype.getName=function(){return this.name},jr.prototype.getPath=function(){return this.path},jr.prototype.getRoot=function(){return this.root},jr.prototype.getParent=function(){return this.parent},jr.prototype.setName=function(t){this.name=t},Io.prototype.getName=function(){return this.name},Io.prototype.setName=function(t){this.name=t},Io.prototype.getShader=function(){return this.shader},Io.prototype.setShader=function(t){this.shader=t};ku.prototype.getDuration=function(){return this.duration},ku.prototype.getName=function(){return this.name},ku.prototype.getNodes=function(){return this.nodes},ku.prototype.setDuration=function(t){this.duration=t},ku.prototype.setName=function(t){this.name=t},zu.prototype.getAnimation=function(){return this.animation},zu.prototype.getCurrentTime=function(){return this.currentTime},zu.prototype.getLooping=function(){return this.looping},zu.prototype.getNumNodes=function(){return this.numNodes},zu.prototype.setAnimation=function(t){this.animation=t},zu.prototype.setCurrentTime=function(t){this.currentTime=t},zu.prototype.setLooping=function(t){this.looping=t};Hp.prototype.getListener=function(){return this.listener},Hp.prototype.getVolume=function(){return this.volume},Hp.prototype.setVolume=function(t){this.volume=t};C_.prototype.getAssetById=function(t){return this.get(t)},Object.defineProperty(_g.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(_g.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(_g.prototype,"rotation",{get:function(){return this._localRotation}});Object.defineProperty(aM.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Object.defineProperty(Mw.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});pw.prototype.isFullscreen=function(){return!!e.polyfill.document.fullscreenElement},pw.prototype.enableFullscreen=function(t,s,i){t=t||this.graphicsDevice.canvas;const n=function t(){s(),e.polyfill.document.removeEventListener("fullscreenchange",t)},a=function t(){i(),e.polyfill.document.removeEventListener("fullscreenerror",t)};s&&e.polyfill.document.addEventListener("fullscreenchange",n,!1),i&&e.polyfill.document.addEventListener("fullscreenerror",a,!1),t.requestFullscreen?t.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},pw.prototype.disableFullscreen=function(t){const s=function s(){t(),e.polyfill.document.removeEventListener("fullscreenchange",s)};t&&e.polyfill.document.addEventListener("fullscreenchange",s,!1),e.polyfill.document.exitFullscreen()},pw.prototype.getSceneUrl=function(t){const e=this.scenes.find(t);return e?e.url:null},pw.prototype.loadScene=function(t,e){this.scenes.loadScene(t,e)},pw.prototype.loadSceneHierarchy=function(t,e){this.scenes.loadSceneHierarchy(t,e)},pw.prototype.loadSceneSettings=function(t,e){this.scenes.loadSceneSettings(t,e)},pw.prototype.renderMeshInstance=function(t,e){const s=null!=e&&e.layer?e.layer:this._getDefaultDrawLayer();this._immediate.drawMesh(null,null,null,t,s)},pw.prototype.renderMesh=function(t,e,s,i){const n=null!=i&&i.layer?i.layer:this._getDefaultDrawLayer();this._immediate.drawMesh(e,s,t,null,n)},pw.prototype._addLines=function(t,e,s){const i=s&&s.layer?s.layer:this.scene.layers.getLayerById(jt),n=!s||void 0===s.depthTest||s.depthTest;this._immediate.getBatch(i,n).addLines(t,e)},pw.prototype.renderLine=function(t,e,s){let i,n=s;const a=arguments[3],r=arguments[4];a instanceof J?(n=a,i="number"==typeof r?r===Qe?{layer:this.scene.layers.getLayerById(jt),depthTest:!1}:{layer:this.scene.layers.getLayerById(jt),depthTest:!0}:r):"number"==typeof a?(n=s,i=a===Qe?{layer:this.scene.layers.getLayerById(jt),depthTest:!1}:{layer:this.scene.layers.getLayerById(jt),depthTest:!0}):a&&(i=a),this._addLines([t,e],[s,n],i)},pw.prototype.renderLines=function(t,e,s){s?"number"==typeof s&&(s=s===Qe?{layer:this.scene.layers.getLayerById(jt),depthTest:!1}:{layer:this.scene.layers.getLayerById(jt),depthTest:!0}):s={layer:this.scene.layers.getLayerById(jt),depthTest:!0};!e.length||t.length===e.length?t.length%2==0?this._addLines(t,e,s):console.error("renderLines: array length is not divisible by 2"):console.error("renderLines: position/color arrays have different lengths")},Object.defineProperty(Ty.prototype,"node",{get:function(){return this.entity}}),Object.defineProperty(Tx.prototype,"enable",{get:function(){return this.enabled},set:function(t){this.enabled=t}}),Ex.prototype.setVisible=function(t){this.enabled=t},Object.defineProperty(Ex.prototype,"aabb",{get:function(){return null},set:function(t){}}),Object.defineProperty(Fx.prototype,"aabb",{get:function(){return null},set:function(t){}}),Object.defineProperty(sb.prototype,"bodyType",{get:function(){return this.type},set:function(t){this.type=t}}),sb.prototype.syncBodyToEntity=function(){this._updateDynamic()},lb.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])},Object.defineProperty(Lg.prototype,"container",{get:function(){return this.entity}});exports.Application=pw,exports.Asset=wm,exports.BoundingBox=bt,exports.Color=J,exports.Component=Lg,exports.ComponentSystem=Ig,exports.EMWContainerResource=xf,exports.Entity=ld,exports.FILLMODE_FILL_WINDOW=R_,exports.GlbParser=af,exports.Mat4=dt,exports.Mouse=Tw,exports.Picker=_u,exports.PlatformManager=e,exports.Quat=ft,exports.RESOLUTION_AUTO=L_,exports.Raycast=Xa,exports.Sound=jp,exports.TouchDevice=lM,exports.URI=z,exports.Vec2=st,exports.Vec3=it,exports.events=p,exports.extend=c,exports.http=j,exports.math=V,exports.now=k,exports.path=f;
